globalThis.CESIUM_WORKERS = atob("dmFyIENlc2l1bVdvcmtlcnMgPSAoKCkgPT4gewogIHZhciBfX2NyZWF0ZSA9IE9iamVjdC5jcmVhdGU7CiAgdmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKICB2YXIgX19nZXRPd25Qcm9wRGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3I7CiAgdmFyIF9fZ2V0T3duUHJvcE5hbWVzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXM7CiAgdmFyIF9fZ2V0UHJvdG9PZiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZjsKICB2YXIgX19oYXNPd25Qcm9wID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICB2YXIgX19yZXF1aXJlID0gLyogQF9fUFVSRV9fICovICgoeCkgPT4gdHlwZW9mIHJlcXVpcmUgIT09ICJ1bmRlZmluZWQiID8gcmVxdWlyZSA6IHR5cGVvZiBQcm94eSAhPT0gInVuZGVmaW5lZCIgPyBuZXcgUHJveHkoeCwgewogICAgZ2V0OiAoYTMsIGIpID0+ICh0eXBlb2YgcmVxdWlyZSAhPT0gInVuZGVmaW5lZCIgPyByZXF1aXJlIDogYTMpW2JdCiAgfSkgOiB4KShmdW5jdGlvbih4KSB7CiAgICBpZiAodHlwZW9mIHJlcXVpcmUgIT09ICJ1bmRlZmluZWQiKQogICAgICByZXR1cm4gcmVxdWlyZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhyb3cgRXJyb3IoJ0R5bmFtaWMgcmVxdWlyZSBvZiAiJyArIHggKyAnIiBpcyBub3Qgc3VwcG9ydGVkJyk7CiAgfSk7CiAgdmFyIF9fZ2xvYiA9IChtYXApID0+IChwYXRoKSA9PiB7CiAgICB2YXIgZm4gPSBtYXBbcGF0aF07CiAgICBpZiAoZm4pCiAgICAgIHJldHVybiBmbigpOwogICAgdGhyb3cgbmV3IEVycm9yKCJNb2R1bGUgbm90IGZvdW5kIGluIGJ1bmRsZTogIiArIHBhdGgpOwogIH07CiAgdmFyIF9fZXNtID0gKGZuLCByZXMpID0+IGZ1bmN0aW9uIF9faW5pdCgpIHsKICAgIHJldHVybiBmbiAmJiAocmVzID0gKDAsIGZuW19fZ2V0T3duUHJvcE5hbWVzKGZuKVswXV0pKGZuID0gMCkpLCByZXM7CiAgfTsKICB2YXIgX19jb21tb25KUyA9IChjYiwgbW9kKSA9PiBmdW5jdGlvbiBfX3JlcXVpcmUyKCkgewogICAgcmV0dXJuIG1vZCB8fCAoMCwgY2JbX19nZXRPd25Qcm9wTmFtZXMoY2IpWzBdXSkoKG1vZCA9IHsgZXhwb3J0czoge30gfSkuZXhwb3J0cywgbW9kKSwgbW9kLmV4cG9ydHM7CiAgfTsKICB2YXIgX19leHBvcnQgPSAodGFyZ2V0LCBhbGwpID0+IHsKICAgIGZvciAodmFyIG5hbWUgaW4gYWxsKQogICAgICBfX2RlZlByb3AodGFyZ2V0LCBuYW1lLCB7IGdldDogYWxsW25hbWVdLCBlbnVtZXJhYmxlOiB0cnVlIH0pOwogIH07CiAgdmFyIF9fY29weVByb3BzID0gKHRvLCBmcm9tLCBleGNlcHQsIGRlc2MpID0+IHsKICAgIGlmIChmcm9tICYmIHR5cGVvZiBmcm9tID09PSAib2JqZWN0IiB8fCB0eXBlb2YgZnJvbSA9PT0gImZ1bmN0aW9uIikgewogICAgICBmb3IgKGxldCBrZXkgb2YgX19nZXRPd25Qcm9wTmFtZXMoZnJvbSkpCiAgICAgICAgaWYgKCFfX2hhc093blByb3AuY2FsbCh0bywga2V5KSAmJiBrZXkgIT09IGV4Y2VwdCkKICAgICAgICAgIF9fZGVmUHJvcCh0bywga2V5LCB7IGdldDogKCkgPT4gZnJvbVtrZXldLCBlbnVtZXJhYmxlOiAhKGRlc2MgPSBfX2dldE93blByb3BEZXNjKGZyb20sIGtleSkpIHx8IGRlc2MuZW51bWVyYWJsZSB9KTsKICAgIH0KICAgIHJldHVybiB0bzsKICB9OwogIHZhciBfX3RvRVNNID0gKG1vZCwgaXNOb2RlTW9kZSwgdGFyZ2V0KSA9PiAodGFyZ2V0ID0gbW9kICE9IG51bGwgPyBfX2NyZWF0ZShfX2dldFByb3RvT2YobW9kKSkgOiB7fSwgX19jb3B5UHJvcHMoCiAgICAvLyBJZiB0aGUgaW1wb3J0ZXIgaXMgaW4gbm9kZSBjb21wYXRpYmlsaXR5IG1vZGUgb3IgdGhpcyBpcyBub3QgYW4gRVNNCiAgICAvLyBmaWxlIHRoYXQgaGFzIGJlZW4gY29udmVydGVkIHRvIGEgQ29tbW9uSlMgZmlsZSB1c2luZyBhIEJhYmVsLQogICAgLy8gY29tcGF0aWJsZSB0cmFuc2Zvcm0gKGkuZS4gIl9fZXNNb2R1bGUiIGhhcyBub3QgYmVlbiBzZXQpLCB0aGVuIHNldAogICAgLy8gImRlZmF1bHQiIHRvIHRoZSBDb21tb25KUyAibW9kdWxlLmV4cG9ydHMiIGZvciBub2RlIGNvbXBhdGliaWxpdHkuCiAgICBpc05vZGVNb2RlIHx8ICFtb2QgfHwgIW1vZC5fX2VzTW9kdWxlID8gX19kZWZQcm9wKHRhcmdldCwgImRlZmF1bHQiLCB7IHZhbHVlOiBtb2QsIGVudW1lcmFibGU6IHRydWUgfSkgOiB0YXJnZXQsCiAgICBtb2QKICApKTsKICB2YXIgX190b0NvbW1vbkpTID0gKG1vZCkgPT4gX19jb3B5UHJvcHMoX19kZWZQcm9wKHt9LCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSksIG1vZCk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9kZWZpbmVkLmpzCiAgZnVuY3Rpb24gZGVmaW5lZCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlICE9PSB2b2lkIDAgJiYgdmFsdWUgIT09IG51bGw7CiAgfQogIHZhciBkZWZpbmVkX2RlZmF1bHQ7CiAgdmFyIGluaXRfZGVmaW5lZCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvZGVmaW5lZC5qcyIoKSB7CiAgICAgIGRlZmluZWRfZGVmYXVsdCA9IGRlZmluZWQ7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9EZXZlbG9wZXJFcnJvci5qcwogIGZ1bmN0aW9uIERldmVsb3BlckVycm9yKG1lc3NhZ2UpIHsKICAgIHRoaXMubmFtZSA9ICJEZXZlbG9wZXJFcnJvciI7CiAgICB0aGlzLm1lc3NhZ2UgPSBtZXNzYWdlOwogICAgbGV0IHN0YWNrOwogICAgdHJ5IHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHN0YWNrID0gZS5zdGFjazsKICAgIH0KICAgIHRoaXMuc3RhY2sgPSBzdGFjazsKICB9CiAgdmFyIERldmVsb3BlckVycm9yX2RlZmF1bHQ7CiAgdmFyIGluaXRfRGV2ZWxvcGVyRXJyb3IgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0RldmVsb3BlckVycm9yLmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoT2JqZWN0LmNyZWF0ZSkpIHsKICAgICAgICBEZXZlbG9wZXJFcnJvci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEVycm9yLnByb3RvdHlwZSk7CiAgICAgICAgRGV2ZWxvcGVyRXJyb3IucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRGV2ZWxvcGVyRXJyb3I7CiAgICAgIH0KICAgICAgRGV2ZWxvcGVyRXJyb3IucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbGV0IHN0ciA9IGAke3RoaXMubmFtZX06ICR7dGhpcy5tZXNzYWdlfWA7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0aGlzLnN0YWNrKSkgewogICAgICAgICAgc3RyICs9IGAKJHt0aGlzLnN0YWNrLnRvU3RyaW5nKCl9YDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgfTsKICAgICAgRGV2ZWxvcGVyRXJyb3IudGhyb3dJbnN0YW50aWF0aW9uRXJyb3IgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoCiAgICAgICAgICAiVGhpcyBmdW5jdGlvbiBkZWZpbmVzIGFuIGludGVyZmFjZSBhbmQgc2hvdWxkIG5vdCBiZSBjYWxsZWQgZGlyZWN0bHkuIgogICAgICAgICk7CiAgICAgIH07CiAgICAgIERldmVsb3BlckVycm9yX2RlZmF1bHQgPSBEZXZlbG9wZXJFcnJvcjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NoZWNrLmpzCiAgZnVuY3Rpb24gZ2V0VW5kZWZpbmVkRXJyb3JNZXNzYWdlKG5hbWUpIHsKICAgIHJldHVybiBgJHtuYW1lfSBpcyByZXF1aXJlZCwgYWN0dWFsIHZhbHVlIHdhcyB1bmRlZmluZWRgOwogIH0KICBmdW5jdGlvbiBnZXRGYWlsZWRUeXBlRXJyb3JNZXNzYWdlKGFjdHVhbCwgZXhwZWN0ZWQsIG5hbWUpIHsKICAgIHJldHVybiBgRXhwZWN0ZWQgJHtuYW1lfSB0byBiZSB0eXBlb2YgJHtleHBlY3RlZH0sIGFjdHVhbCB0eXBlb2Ygd2FzICR7YWN0dWFsfWA7CiAgfQogIHZhciBDaGVjaywgQ2hlY2tfZGVmYXVsdDsKICB2YXIgaW5pdF9DaGVjayA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2hlY2suanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBDaGVjayA9IHt9OwogICAgICBDaGVjay50eXBlT2YgPSB7fTsKICAgICAgQ2hlY2suZGVmaW5lZCA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0ZXN0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoZ2V0VW5kZWZpbmVkRXJyb3JNZXNzYWdlKG5hbWUpKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIENoZWNrLnR5cGVPZi5mdW5jID0gZnVuY3Rpb24obmFtZSwgdGVzdCkgewogICAgICAgIGlmICh0eXBlb2YgdGVzdCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgIGdldEZhaWxlZFR5cGVFcnJvck1lc3NhZ2UodHlwZW9mIHRlc3QsICJmdW5jdGlvbiIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLnN0cmluZyA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QpIHsKICAgICAgICBpZiAodHlwZW9mIHRlc3QgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgZ2V0RmFpbGVkVHlwZUVycm9yTWVzc2FnZSh0eXBlb2YgdGVzdCwgInN0cmluZyIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLm51bWJlciA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QpIHsKICAgICAgICBpZiAodHlwZW9mIHRlc3QgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgZ2V0RmFpbGVkVHlwZUVycm9yTWVzc2FnZSh0eXBlb2YgdGVzdCwgIm51bWJlciIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLm51bWJlci5sZXNzVGhhbiA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QsIGxpbWl0KSB7CiAgICAgICAgQ2hlY2sudHlwZU9mLm51bWJlcihuYW1lLCB0ZXN0KTsKICAgICAgICBpZiAodGVzdCA+PSBsaW1pdCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgIGBFeHBlY3RlZCAke25hbWV9IHRvIGJlIGxlc3MgdGhhbiAke2xpbWl0fSwgYWN0dWFsIHZhbHVlIHdhcyAke3Rlc3R9YAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIENoZWNrLnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscyA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QsIGxpbWl0KSB7CiAgICAgICAgQ2hlY2sudHlwZU9mLm51bWJlcihuYW1lLCB0ZXN0KTsKICAgICAgICBpZiAodGVzdCA+IGxpbWl0KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgYEV4cGVjdGVkICR7bmFtZX0gdG8gYmUgbGVzcyB0aGFuIG9yIGVxdWFsIHRvICR7bGltaXR9LCBhY3R1YWwgdmFsdWUgd2FzICR7dGVzdH1gCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbiA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QsIGxpbWl0KSB7CiAgICAgICAgQ2hlY2sudHlwZU9mLm51bWJlcihuYW1lLCB0ZXN0KTsKICAgICAgICBpZiAodGVzdCA8PSBsaW1pdCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgIGBFeHBlY3RlZCAke25hbWV9IHRvIGJlIGdyZWF0ZXIgdGhhbiAke2xpbWl0fSwgYWN0dWFsIHZhbHVlIHdhcyAke3Rlc3R9YAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIENoZWNrLnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscyA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QsIGxpbWl0KSB7CiAgICAgICAgQ2hlY2sudHlwZU9mLm51bWJlcihuYW1lLCB0ZXN0KTsKICAgICAgICBpZiAodGVzdCA8IGxpbWl0KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgYEV4cGVjdGVkICR7bmFtZX0gdG8gYmUgZ3JlYXRlciB0aGFuIG9yIGVxdWFsIHRvICR7bGltaXR9LCBhY3R1YWwgdmFsdWUgd2FzICR7dGVzdH1gCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLm9iamVjdCA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QpIHsKICAgICAgICBpZiAodHlwZW9mIHRlc3QgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgZ2V0RmFpbGVkVHlwZUVycm9yTWVzc2FnZSh0eXBlb2YgdGVzdCwgIm9iamVjdCIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLmJvb2wgPSBmdW5jdGlvbihuYW1lLCB0ZXN0KSB7CiAgICAgICAgaWYgKHR5cGVvZiB0ZXN0ICE9PSAiYm9vbGVhbiIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICBnZXRGYWlsZWRUeXBlRXJyb3JNZXNzYWdlKHR5cGVvZiB0ZXN0LCAiYm9vbGVhbiIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLmJpZ2ludCA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QpIHsKICAgICAgICBpZiAodHlwZW9mIHRlc3QgIT09ICJiaWdpbnQiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgZ2V0RmFpbGVkVHlwZUVycm9yTWVzc2FnZSh0eXBlb2YgdGVzdCwgImJpZ2ludCIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLm51bWJlci5lcXVhbHMgPSBmdW5jdGlvbihuYW1lMSwgbmFtZTIsIHRlc3QxLCB0ZXN0MikgewogICAgICAgIENoZWNrLnR5cGVPZi5udW1iZXIobmFtZTEsIHRlc3QxKTsKICAgICAgICBDaGVjay50eXBlT2YubnVtYmVyKG5hbWUyLCB0ZXN0Mik7CiAgICAgICAgaWYgKHRlc3QxICE9PSB0ZXN0MikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgIGAke25hbWUxfSBtdXN0IGJlIGVxdWFsIHRvICR7bmFtZTJ9LCB0aGUgYWN0dWFsIHZhbHVlcyBhcmUgJHt0ZXN0MX0gYW5kICR7dGVzdDJ9YAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIENoZWNrX2RlZmF1bHQgPSBDaGVjazsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2RlZmF1bHRWYWx1ZS5qcwogIGZ1bmN0aW9uIGRlZmF1bHRWYWx1ZShhMywgYikgewogICAgaWYgKGEzICE9PSB2b2lkIDAgJiYgYTMgIT09IG51bGwpIHsKICAgICAgcmV0dXJuIGEzOwogICAgfQogICAgcmV0dXJuIGI7CiAgfQogIHZhciBkZWZhdWx0VmFsdWVfZGVmYXVsdDsKICB2YXIgaW5pdF9kZWZhdWx0VmFsdWUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2RlZmF1bHRWYWx1ZS5qcyIoKSB7CiAgICAgIGRlZmF1bHRWYWx1ZS5FTVBUWV9PQkpFQ1QgPSBPYmplY3QuZnJlZXplKHt9KTsKICAgICAgZGVmYXVsdFZhbHVlX2RlZmF1bHQgPSBkZWZhdWx0VmFsdWU7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9tZXJzZW5uZS10d2lzdGVyL3NyYy9tZXJzZW5uZS10d2lzdGVyLmpzCiAgdmFyIHJlcXVpcmVfbWVyc2VubmVfdHdpc3RlciA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy9tZXJzZW5uZS10d2lzdGVyL3NyYy9tZXJzZW5uZS10d2lzdGVyLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgIHZhciBNZXJzZW5uZVR3aXN0ZXIyID0gZnVuY3Rpb24oc2VlZCkgewogICAgICAgIGlmIChzZWVkID09IHZvaWQgMCkgewogICAgICAgICAgc2VlZCA9ICgvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKSkuZ2V0VGltZSgpOwogICAgICAgIH0KICAgICAgICB0aGlzLk4gPSA2MjQ7CiAgICAgICAgdGhpcy5NID0gMzk3OwogICAgICAgIHRoaXMuTUFUUklYX0EgPSAyNTY3NDgzNjE1OwogICAgICAgIHRoaXMuVVBQRVJfTUFTSyA9IDIxNDc0ODM2NDg7CiAgICAgICAgdGhpcy5MT1dFUl9NQVNLID0gMjE0NzQ4MzY0NzsKICAgICAgICB0aGlzLm10ID0gbmV3IEFycmF5KHRoaXMuTik7CiAgICAgICAgdGhpcy5tdGkgPSB0aGlzLk4gKyAxOwogICAgICAgIGlmIChzZWVkLmNvbnN0cnVjdG9yID09IEFycmF5KSB7CiAgICAgICAgICB0aGlzLmluaXRfYnlfYXJyYXkoc2VlZCwgc2VlZC5sZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmluaXRfc2VlZChzZWVkKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIE1lcnNlbm5lVHdpc3RlcjIucHJvdG90eXBlLmluaXRfc2VlZCA9IGZ1bmN0aW9uKHMpIHsKICAgICAgICB0aGlzLm10WzBdID0gcyA+Pj4gMDsKICAgICAgICBmb3IgKHRoaXMubXRpID0gMTsgdGhpcy5tdGkgPCB0aGlzLk47IHRoaXMubXRpKyspIHsKICAgICAgICAgIHZhciBzID0gdGhpcy5tdFt0aGlzLm10aSAtIDFdIF4gdGhpcy5tdFt0aGlzLm10aSAtIDFdID4+PiAzMDsKICAgICAgICAgIHRoaXMubXRbdGhpcy5tdGldID0gKCgocyAmIDQyOTQ5MDE3NjApID4+PiAxNikgKiAxODEyNDMzMjUzIDw8IDE2KSArIChzICYgNjU1MzUpICogMTgxMjQzMzI1MyArIHRoaXMubXRpOwogICAgICAgICAgdGhpcy5tdFt0aGlzLm10aV0gPj4+PSAwOwogICAgICAgIH0KICAgICAgfTsKICAgICAgTWVyc2VubmVUd2lzdGVyMi5wcm90b3R5cGUuaW5pdF9ieV9hcnJheSA9IGZ1bmN0aW9uKGluaXRfa2V5LCBrZXlfbGVuZ3RoKSB7CiAgICAgICAgdmFyIGksIGosIGs7CiAgICAgICAgdGhpcy5pbml0X3NlZWQoMTk2NTAyMTgpOwogICAgICAgIGkgPSAxOwogICAgICAgIGogPSAwOwogICAgICAgIGsgPSB0aGlzLk4gPiBrZXlfbGVuZ3RoID8gdGhpcy5OIDoga2V5X2xlbmd0aDsKICAgICAgICBmb3IgKDsgazsgay0tKSB7CiAgICAgICAgICB2YXIgcyA9IHRoaXMubXRbaSAtIDFdIF4gdGhpcy5tdFtpIC0gMV0gPj4+IDMwOwogICAgICAgICAgdGhpcy5tdFtpXSA9ICh0aGlzLm10W2ldIF4gKCgocyAmIDQyOTQ5MDE3NjApID4+PiAxNikgKiAxNjY0NTI1IDw8IDE2KSArIChzICYgNjU1MzUpICogMTY2NDUyNSkgKyBpbml0X2tleVtqXSArIGo7CiAgICAgICAgICB0aGlzLm10W2ldID4+Pj0gMDsKICAgICAgICAgIGkrKzsKICAgICAgICAgIGorKzsKICAgICAgICAgIGlmIChpID49IHRoaXMuTikgewogICAgICAgICAgICB0aGlzLm10WzBdID0gdGhpcy5tdFt0aGlzLk4gLSAxXTsKICAgICAgICAgICAgaSA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaiA+PSBrZXlfbGVuZ3RoKQogICAgICAgICAgICBqID0gMDsKICAgICAgICB9CiAgICAgICAgZm9yIChrID0gdGhpcy5OIC0gMTsgazsgay0tKSB7CiAgICAgICAgICB2YXIgcyA9IHRoaXMubXRbaSAtIDFdIF4gdGhpcy5tdFtpIC0gMV0gPj4+IDMwOwogICAgICAgICAgdGhpcy5tdFtpXSA9ICh0aGlzLm10W2ldIF4gKCgocyAmIDQyOTQ5MDE3NjApID4+PiAxNikgKiAxNTY2MDgzOTQxIDw8IDE2KSArIChzICYgNjU1MzUpICogMTU2NjA4Mzk0MSkgLSBpOwogICAgICAgICAgdGhpcy5tdFtpXSA+Pj49IDA7CiAgICAgICAgICBpKys7CiAgICAgICAgICBpZiAoaSA+PSB0aGlzLk4pIHsKICAgICAgICAgICAgdGhpcy5tdFswXSA9IHRoaXMubXRbdGhpcy5OIC0gMV07CiAgICAgICAgICAgIGkgPSAxOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLm10WzBdID0gMjE0NzQ4MzY0ODsKICAgICAgfTsKICAgICAgTWVyc2VubmVUd2lzdGVyMi5wcm90b3R5cGUucmFuZG9tX2ludCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB5OwogICAgICAgIHZhciBtYWcwMSA9IG5ldyBBcnJheSgwLCB0aGlzLk1BVFJJWF9BKTsKICAgICAgICBpZiAodGhpcy5tdGkgPj0gdGhpcy5OKSB7CiAgICAgICAgICB2YXIga2s7CiAgICAgICAgICBpZiAodGhpcy5tdGkgPT0gdGhpcy5OICsgMSkKICAgICAgICAgICAgdGhpcy5pbml0X3NlZWQoNTQ4OSk7CiAgICAgICAgICBmb3IgKGtrID0gMDsga2sgPCB0aGlzLk4gLSB0aGlzLk07IGtrKyspIHsKICAgICAgICAgICAgeSA9IHRoaXMubXRba2tdICYgdGhpcy5VUFBFUl9NQVNLIHwgdGhpcy5tdFtrayArIDFdICYgdGhpcy5MT1dFUl9NQVNLOwogICAgICAgICAgICB0aGlzLm10W2trXSA9IHRoaXMubXRba2sgKyB0aGlzLk1dIF4geSA+Pj4gMSBeIG1hZzAxW3kgJiAxXTsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAoOyBrayA8IHRoaXMuTiAtIDE7IGtrKyspIHsKICAgICAgICAgICAgeSA9IHRoaXMubXRba2tdICYgdGhpcy5VUFBFUl9NQVNLIHwgdGhpcy5tdFtrayArIDFdICYgdGhpcy5MT1dFUl9NQVNLOwogICAgICAgICAgICB0aGlzLm10W2trXSA9IHRoaXMubXRba2sgKyAodGhpcy5NIC0gdGhpcy5OKV0gXiB5ID4+PiAxIF4gbWFnMDFbeSAmIDFdOwogICAgICAgICAgfQogICAgICAgICAgeSA9IHRoaXMubXRbdGhpcy5OIC0gMV0gJiB0aGlzLlVQUEVSX01BU0sgfCB0aGlzLm10WzBdICYgdGhpcy5MT1dFUl9NQVNLOwogICAgICAgICAgdGhpcy5tdFt0aGlzLk4gLSAxXSA9IHRoaXMubXRbdGhpcy5NIC0gMV0gXiB5ID4+PiAxIF4gbWFnMDFbeSAmIDFdOwogICAgICAgICAgdGhpcy5tdGkgPSAwOwogICAgICAgIH0KICAgICAgICB5ID0gdGhpcy5tdFt0aGlzLm10aSsrXTsKICAgICAgICB5IF49IHkgPj4+IDExOwogICAgICAgIHkgXj0geSA8PCA3ICYgMjYzNjkyODY0MDsKICAgICAgICB5IF49IHkgPDwgMTUgJiA0MDIyNzMwNzUyOwogICAgICAgIHkgXj0geSA+Pj4gMTg7CiAgICAgICAgcmV0dXJuIHkgPj4+IDA7CiAgICAgIH07CiAgICAgIE1lcnNlbm5lVHdpc3RlcjIucHJvdG90eXBlLnJhbmRvbV9pbnQzMSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnJhbmRvbV9pbnQoKSA+Pj4gMTsKICAgICAgfTsKICAgICAgTWVyc2VubmVUd2lzdGVyMi5wcm90b3R5cGUucmFuZG9tX2luY2wgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5yYW5kb21faW50KCkgKiAoMSAvIDQyOTQ5NjcyOTUpOwogICAgICB9OwogICAgICBNZXJzZW5uZVR3aXN0ZXIyLnByb3RvdHlwZS5yYW5kb20gPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5yYW5kb21faW50KCkgKiAoMSAvIDQyOTQ5NjcyOTYpOwogICAgICB9OwogICAgICBNZXJzZW5uZVR3aXN0ZXIyLnByb3RvdHlwZS5yYW5kb21fZXhjbCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiAodGhpcy5yYW5kb21faW50KCkgKyAwLjUpICogKDEgLyA0Mjk0OTY3Mjk2KTsKICAgICAgfTsKICAgICAgTWVyc2VubmVUd2lzdGVyMi5wcm90b3R5cGUucmFuZG9tX2xvbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYTMgPSB0aGlzLnJhbmRvbV9pbnQoKSA+Pj4gNSwgYiA9IHRoaXMucmFuZG9tX2ludCgpID4+PiA2OwogICAgICAgIHJldHVybiAoYTMgKiA2NzEwODg2NCArIGIpICogKDEgLyA5MDA3MTk5MjU0NzQwOTkyKTsKICAgICAgfTsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBNZXJzZW5uZVR3aXN0ZXIyOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvTWF0aC5qcwogIHZhciBpbXBvcnRfbWVyc2VubmVfdHdpc3RlciwgQ2VzaXVtTWF0aCwgZmFjdG9yaWFscywgcmFuZG9tTnVtYmVyR2VuZXJhdG9yLCBNYXRoX2RlZmF1bHQ7CiAgdmFyIGluaXRfTWF0aCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvTWF0aC5qcyIoKSB7CiAgICAgIGltcG9ydF9tZXJzZW5uZV90d2lzdGVyID0gX190b0VTTShyZXF1aXJlX21lcnNlbm5lX3R3aXN0ZXIoKSwgMSk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgQ2VzaXVtTWF0aCA9IHt9OwogICAgICBDZXNpdW1NYXRoLkVQU0lMT04xID0gMC4xOwogICAgICBDZXNpdW1NYXRoLkVQU0lMT04yID0gMC4wMTsKICAgICAgQ2VzaXVtTWF0aC5FUFNJTE9OMyA9IDFlLTM7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjQgPSAxZS00OwogICAgICBDZXNpdW1NYXRoLkVQU0lMT041ID0gMWUtNTsKICAgICAgQ2VzaXVtTWF0aC5FUFNJTE9ONiA9IDFlLTY7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjcgPSAxZS03OwogICAgICBDZXNpdW1NYXRoLkVQU0lMT044ID0gMWUtODsKICAgICAgQ2VzaXVtTWF0aC5FUFNJTE9OOSA9IDFlLTk7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjEwID0gMWUtMTA7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjExID0gMWUtMTE7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjEyID0gMWUtMTI7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjEzID0gMWUtMTM7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE0ID0gMWUtMTQ7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE1ID0gMWUtMTU7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE2ID0gMWUtMTY7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE3ID0gMWUtMTc7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE4ID0gMWUtMTg7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE5ID0gMWUtMTk7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjIwID0gMWUtMjA7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjIxID0gMWUtMjE7CiAgICAgIENlc2l1bU1hdGguR1JBVklUQVRJT05BTFBBUkFNRVRFUiA9IDM5ODYwMDQ0MThlNTsKICAgICAgQ2VzaXVtTWF0aC5TT0xBUl9SQURJVVMgPSA2OTU1ZTU7CiAgICAgIENlc2l1bU1hdGguTFVOQVJfUkFESVVTID0gMTczNzQwMDsKICAgICAgQ2VzaXVtTWF0aC5TSVhUWV9GT1VSX0tJTE9CWVRFUyA9IDY0ICogMTAyNDsKICAgICAgQ2VzaXVtTWF0aC5GT1VSX0dJR0FCWVRFUyA9IDQgKiAxMDI0ICogMTAyNCAqIDEwMjQ7CiAgICAgIENlc2l1bU1hdGguc2lnbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KE1hdGguc2lnbiwgZnVuY3Rpb24gc2lnbih2YWx1ZSkgewogICAgICAgIHZhbHVlID0gK3ZhbHVlOwogICAgICAgIGlmICh2YWx1ZSA9PT0gMCB8fCB2YWx1ZSAhPT0gdmFsdWUpIHsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlID4gMCA/IDEgOiAtMTsKICAgICAgfSk7CiAgICAgIENlc2l1bU1hdGguc2lnbk5vdFplcm8gPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiB2YWx1ZSA8IDAgPyAtMSA6IDE7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgudG9TTm9ybSA9IGZ1bmN0aW9uKHZhbHVlLCByYW5nZU1heGltdW0pIHsKICAgICAgICByYW5nZU1heGltdW0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChyYW5nZU1heGltdW0sIDI1NSk7CiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQoCiAgICAgICAgICAoQ2VzaXVtTWF0aC5jbGFtcCh2YWx1ZSwgLTEsIDEpICogMC41ICsgMC41KSAqIHJhbmdlTWF4aW11bQogICAgICAgICk7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguZnJvbVNOb3JtID0gZnVuY3Rpb24odmFsdWUsIHJhbmdlTWF4aW11bSkgewogICAgICAgIHJhbmdlTWF4aW11bSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHJhbmdlTWF4aW11bSwgMjU1KTsKICAgICAgICByZXR1cm4gQ2VzaXVtTWF0aC5jbGFtcCh2YWx1ZSwgMCwgcmFuZ2VNYXhpbXVtKSAvIHJhbmdlTWF4aW11bSAqIDIgLSAxOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLm5vcm1hbGl6ZSA9IGZ1bmN0aW9uKHZhbHVlLCByYW5nZU1pbmltdW0sIHJhbmdlTWF4aW11bSkgewogICAgICAgIHJhbmdlTWF4aW11bSA9IE1hdGgubWF4KHJhbmdlTWF4aW11bSAtIHJhbmdlTWluaW11bSwgMCk7CiAgICAgICAgcmV0dXJuIHJhbmdlTWF4aW11bSA9PT0gMCA/IDAgOiBDZXNpdW1NYXRoLmNsYW1wKCh2YWx1ZSAtIHJhbmdlTWluaW11bSkgLyByYW5nZU1heGltdW0sIDAsIDEpOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLnNpbmggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChNYXRoLnNpbmgsIGZ1bmN0aW9uIHNpbmgodmFsdWUpIHsKICAgICAgICByZXR1cm4gKE1hdGguZXhwKHZhbHVlKSAtIE1hdGguZXhwKC12YWx1ZSkpIC8gMjsKICAgICAgfSk7CiAgICAgIENlc2l1bU1hdGguY29zaCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KE1hdGguY29zaCwgZnVuY3Rpb24gY29zaCh2YWx1ZSkgewogICAgICAgIHJldHVybiAoTWF0aC5leHAodmFsdWUpICsgTWF0aC5leHAoLXZhbHVlKSkgLyAyOwogICAgICB9KTsKICAgICAgQ2VzaXVtTWF0aC5sZXJwID0gZnVuY3Rpb24ocCwgcSwgdGltZSkgewogICAgICAgIHJldHVybiAoMSAtIHRpbWUpICogcCArIHRpbWUgKiBxOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLlBJID0gTWF0aC5QSTsKICAgICAgQ2VzaXVtTWF0aC5PTkVfT1ZFUl9QSSA9IDEgLyBNYXRoLlBJOwogICAgICBDZXNpdW1NYXRoLlBJX09WRVJfVFdPID0gTWF0aC5QSSAvIDI7CiAgICAgIENlc2l1bU1hdGguUElfT1ZFUl9USFJFRSA9IE1hdGguUEkgLyAzOwogICAgICBDZXNpdW1NYXRoLlBJX09WRVJfRk9VUiA9IE1hdGguUEkgLyA0OwogICAgICBDZXNpdW1NYXRoLlBJX09WRVJfU0lYID0gTWF0aC5QSSAvIDY7CiAgICAgIENlc2l1bU1hdGguVEhSRUVfUElfT1ZFUl9UV08gPSAzICogTWF0aC5QSSAvIDI7CiAgICAgIENlc2l1bU1hdGguVFdPX1BJID0gMiAqIE1hdGguUEk7CiAgICAgIENlc2l1bU1hdGguT05FX09WRVJfVFdPX1BJID0gMSAvICgyICogTWF0aC5QSSk7CiAgICAgIENlc2l1bU1hdGguUkFESUFOU19QRVJfREVHUkVFID0gTWF0aC5QSSAvIDE4MDsKICAgICAgQ2VzaXVtTWF0aC5ERUdSRUVTX1BFUl9SQURJQU4gPSAxODAgLyBNYXRoLlBJOwogICAgICBDZXNpdW1NYXRoLlJBRElBTlNfUEVSX0FSQ1NFQ09ORCA9IENlc2l1bU1hdGguUkFESUFOU19QRVJfREVHUkVFIC8gMzYwMDsKICAgICAgQ2VzaXVtTWF0aC50b1JhZGlhbnMgPSBmdW5jdGlvbihkZWdyZWVzKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZGVncmVlcykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkZWdyZWVzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVncmVlcyAqIENlc2l1bU1hdGguUkFESUFOU19QRVJfREVHUkVFOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLnRvRGVncmVlcyA9IGZ1bmN0aW9uKHJhZGlhbnMpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyYWRpYW5zKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJhZGlhbnMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiByYWRpYW5zICogQ2VzaXVtTWF0aC5ERUdSRUVTX1BFUl9SQURJQU47CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguY29udmVydExvbmdpdHVkZVJhbmdlID0gZnVuY3Rpb24oYW5nbGUpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhbmdsZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhbmdsZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdHdvUGkgPSBDZXNpdW1NYXRoLlRXT19QSTsKICAgICAgICBjb25zdCBzaW1wbGlmaWVkID0gYW5nbGUgLSBNYXRoLmZsb29yKGFuZ2xlIC8gdHdvUGkpICogdHdvUGk7CiAgICAgICAgaWYgKHNpbXBsaWZpZWQgPCAtTWF0aC5QSSkgewogICAgICAgICAgcmV0dXJuIHNpbXBsaWZpZWQgKyB0d29QaTsKICAgICAgICB9CiAgICAgICAgaWYgKHNpbXBsaWZpZWQgPj0gTWF0aC5QSSkgewogICAgICAgICAgcmV0dXJuIHNpbXBsaWZpZWQgLSB0d29QaTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNpbXBsaWZpZWQ7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguY2xhbXBUb0xhdGl0dWRlUmFuZ2UgPSBmdW5jdGlvbihhbmdsZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFuZ2xlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFuZ2xlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gQ2VzaXVtTWF0aC5jbGFtcCgKICAgICAgICAgIGFuZ2xlLAogICAgICAgICAgLTEgKiBDZXNpdW1NYXRoLlBJX09WRVJfVFdPLAogICAgICAgICAgQ2VzaXVtTWF0aC5QSV9PVkVSX1RXTwogICAgICAgICk7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgubmVnYXRpdmVQaVRvUGkgPSBmdW5jdGlvbihhbmdsZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFuZ2xlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFuZ2xlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoYW5nbGUgPj0gLUNlc2l1bU1hdGguUEkgJiYgYW5nbGUgPD0gQ2VzaXVtTWF0aC5QSSkgewogICAgICAgICAgcmV0dXJuIGFuZ2xlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gQ2VzaXVtTWF0aC56ZXJvVG9Ud29QaShhbmdsZSArIENlc2l1bU1hdGguUEkpIC0gQ2VzaXVtTWF0aC5QSTsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC56ZXJvVG9Ud29QaSA9IGZ1bmN0aW9uKGFuZ2xlKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYW5nbGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYW5nbGUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmIChhbmdsZSA+PSAwICYmIGFuZ2xlIDw9IENlc2l1bU1hdGguVFdPX1BJKSB7CiAgICAgICAgICByZXR1cm4gYW5nbGU7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG1vZCA9IENlc2l1bU1hdGgubW9kKGFuZ2xlLCBDZXNpdW1NYXRoLlRXT19QSSk7CiAgICAgICAgaWYgKE1hdGguYWJzKG1vZCkgPCBDZXNpdW1NYXRoLkVQU0lMT04xNCAmJiBNYXRoLmFicyhhbmdsZSkgPiBDZXNpdW1NYXRoLkVQU0lMT04xNCkgewogICAgICAgICAgcmV0dXJuIENlc2l1bU1hdGguVFdPX1BJOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbW9kOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLm1vZCA9IGZ1bmN0aW9uKG0sIG4pIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChtKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm0gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG4pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKG4gPT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkaXZpc29yIGNhbm5vdCBiZSAwLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoQ2VzaXVtTWF0aC5zaWduKG0pID09PSBDZXNpdW1NYXRoLnNpZ24obikgJiYgTWF0aC5hYnMobSkgPCBNYXRoLmFicyhuKSkgewogICAgICAgICAgcmV0dXJuIG07CiAgICAgICAgfQogICAgICAgIHJldHVybiAobSAlIG4gKyBuKSAlIG47CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGxlZnQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibGVmdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmlnaHQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJlbGF0aXZlRXBzaWxvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHJlbGF0aXZlRXBzaWxvbiwgMCk7CiAgICAgICAgYWJzb2x1dGVFcHNpbG9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoYWJzb2x1dGVFcHNpbG9uLCByZWxhdGl2ZUVwc2lsb24pOwogICAgICAgIGNvbnN0IGFic0RpZmYgPSBNYXRoLmFicyhsZWZ0IC0gcmlnaHQpOwogICAgICAgIHJldHVybiBhYnNEaWZmIDw9IGFic29sdXRlRXBzaWxvbiB8fCBhYnNEaWZmIDw9IHJlbGF0aXZlRXBzaWxvbiAqIE1hdGgubWF4KE1hdGguYWJzKGxlZnQpLCBNYXRoLmFicyhyaWdodCkpOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLmxlc3NUaGFuID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGxlZnQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZmlyc3QgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInNlY29uZCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYWJzb2x1dGVFcHNpbG9uKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFic29sdXRlRXBzaWxvbiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGxlZnQgLSByaWdodCA8IC1hYnNvbHV0ZUVwc2lsb247CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgubGVzc1RoYW5PckVxdWFscyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChsZWZ0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImZpcnN0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyaWdodCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJzZWNvbmQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFic29sdXRlRXBzaWxvbikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhYnNvbHV0ZUVwc2lsb24gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBsZWZ0IC0gcmlnaHQgPCBhYnNvbHV0ZUVwc2lsb247CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguZ3JlYXRlclRoYW4gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgYWJzb2x1dGVFcHNpbG9uKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobGVmdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJmaXJzdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgic2Vjb25kIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhYnNvbHV0ZUVwc2lsb24pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYWJzb2x1dGVFcHNpbG9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbGVmdCAtIHJpZ2h0ID4gYWJzb2x1dGVFcHNpbG9uOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLmdyZWF0ZXJUaGFuT3JFcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgYWJzb2x1dGVFcHNpbG9uKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobGVmdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJmaXJzdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgic2Vjb25kIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhYnNvbHV0ZUVwc2lsb24pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYWJzb2x1dGVFcHNpbG9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbGVmdCAtIHJpZ2h0ID4gLWFic29sdXRlRXBzaWxvbjsKICAgICAgfTsKICAgICAgZmFjdG9yaWFscyA9IFsxXTsKICAgICAgQ2VzaXVtTWF0aC5mYWN0b3JpYWwgPSBmdW5jdGlvbihuKSB7CiAgICAgICAgaWYgKHR5cGVvZiBuICE9PSAibnVtYmVyIiB8fCBuIDwgMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJBIG51bWJlciBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8gMCBpcyByZXF1aXJlZC4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBmYWN0b3JpYWxzLmxlbmd0aDsKICAgICAgICBpZiAobiA+PSBsZW5ndGgpIHsKICAgICAgICAgIGxldCBzdW0gPSBmYWN0b3JpYWxzW2xlbmd0aCAtIDFdOwogICAgICAgICAgZm9yIChsZXQgaSA9IGxlbmd0aDsgaSA8PSBuOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgbmV4dCA9IHN1bSAqIGk7CiAgICAgICAgICAgIGZhY3RvcmlhbHMucHVzaChuZXh0KTsKICAgICAgICAgICAgc3VtID0gbmV4dDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhY3RvcmlhbHNbbl07CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguaW5jcmVtZW50V3JhcCA9IGZ1bmN0aW9uKG4sIG1heGltdW1WYWx1ZSwgbWluaW11bVZhbHVlKSB7CiAgICAgICAgbWluaW11bVZhbHVlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQobWluaW11bVZhbHVlLCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChuKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm4gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmIChtYXhpbXVtVmFsdWUgPD0gbWluaW11bVZhbHVlKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibWF4aW11bVZhbHVlIG11c3QgYmUgZ3JlYXRlciB0aGFuIG1pbmltdW1WYWx1ZS4iKTsKICAgICAgICB9CiAgICAgICAgKytuOwogICAgICAgIGlmIChuID4gbWF4aW11bVZhbHVlKSB7CiAgICAgICAgICBuID0gbWluaW11bVZhbHVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbjsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC5pc1Bvd2VyT2ZUd28gPSBmdW5jdGlvbihuKSB7CiAgICAgICAgaWYgKHR5cGVvZiBuICE9PSAibnVtYmVyIiB8fCBuIDwgMCB8fCBuID4gNDI5NDk2NzI5NSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIkEgbnVtYmVyIGJldHdlZW4gMCBhbmQgKDJeMzIpLTEgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuICE9PSAwICYmIChuICYgbiAtIDEpID09PSAwOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLm5leHRQb3dlck9mVHdvID0gZnVuY3Rpb24obikgewogICAgICAgIGlmICh0eXBlb2YgbiAhPT0gIm51bWJlciIgfHwgbiA8IDAgfHwgbiA+IDIxNDc0ODM2NDgpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJBIG51bWJlciBiZXR3ZWVuIDAgYW5kIDJeMzEgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIC0tbjsKICAgICAgICBuIHw9IG4gPj4gMTsKICAgICAgICBuIHw9IG4gPj4gMjsKICAgICAgICBuIHw9IG4gPj4gNDsKICAgICAgICBuIHw9IG4gPj4gODsKICAgICAgICBuIHw9IG4gPj4gMTY7CiAgICAgICAgKytuOwogICAgICAgIHJldHVybiBuOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLnByZXZpb3VzUG93ZXJPZlR3byA9IGZ1bmN0aW9uKG4pIHsKICAgICAgICBpZiAodHlwZW9mIG4gIT09ICJudW1iZXIiIHx8IG4gPCAwIHx8IG4gPiA0Mjk0OTY3Mjk1KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiQSBudW1iZXIgYmV0d2VlbiAwIGFuZCAoMl4zMiktMSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgbiB8PSBuID4+IDE7CiAgICAgICAgbiB8PSBuID4+IDI7CiAgICAgICAgbiB8PSBuID4+IDQ7CiAgICAgICAgbiB8PSBuID4+IDg7CiAgICAgICAgbiB8PSBuID4+IDE2OwogICAgICAgIG4gfD0gbiA+PiAzMjsKICAgICAgICBuID0gKG4gPj4+IDApIC0gKG4gPj4+IDEpOwogICAgICAgIHJldHVybiBuOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLmNsYW1wID0gZnVuY3Rpb24odmFsdWUsIG1pbjMsIG1heDMpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibWluIiwgbWluMyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJtYXgiLCBtYXgzKTsKICAgICAgICByZXR1cm4gdmFsdWUgPCBtaW4zID8gbWluMyA6IHZhbHVlID4gbWF4MyA/IG1heDMgOiB2YWx1ZTsKICAgICAgfTsKICAgICAgcmFuZG9tTnVtYmVyR2VuZXJhdG9yID0gbmV3IGltcG9ydF9tZXJzZW5uZV90d2lzdGVyLmRlZmF1bHQoKTsKICAgICAgQ2VzaXVtTWF0aC5zZXRSYW5kb21OdW1iZXJTZWVkID0gZnVuY3Rpb24oc2VlZCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHNlZWQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgic2VlZCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgcmFuZG9tTnVtYmVyR2VuZXJhdG9yID0gbmV3IGltcG9ydF9tZXJzZW5uZV90d2lzdGVyLmRlZmF1bHQoc2VlZCk7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgubmV4dFJhbmRvbU51bWJlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiByYW5kb21OdW1iZXJHZW5lcmF0b3IucmFuZG9tKCk7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgucmFuZG9tQmV0d2VlbiA9IGZ1bmN0aW9uKG1pbjMsIG1heDMpIHsKICAgICAgICByZXR1cm4gQ2VzaXVtTWF0aC5uZXh0UmFuZG9tTnVtYmVyKCkgKiAobWF4MyAtIG1pbjMpICsgbWluMzsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC5hY29zQ2xhbXBlZCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBNYXRoLmFjb3MoQ2VzaXVtTWF0aC5jbGFtcCh2YWx1ZSwgLTEsIDEpKTsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC5hc2luQ2xhbXBlZCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBNYXRoLmFzaW4oQ2VzaXVtTWF0aC5jbGFtcCh2YWx1ZSwgLTEsIDEpKTsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC5jaG9yZExlbmd0aCA9IGZ1bmN0aW9uKGFuZ2xlLCByYWRpdXMpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhbmdsZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhbmdsZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmFkaXVzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJhZGl1cyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDIgKiByYWRpdXMgKiBNYXRoLnNpbihhbmdsZSAqIDAuNSk7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgubG9nQmFzZSA9IGZ1bmN0aW9uKG51bWJlciwgYmFzZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG51bWJlcikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJudW1iZXIgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJhc2UpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYmFzZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIE1hdGgubG9nKG51bWJlcikgLyBNYXRoLmxvZyhiYXNlKTsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC5jYnJ0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoTWF0aC5jYnJ0LCBmdW5jdGlvbiBjYnJ0KG51bWJlcikgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IE1hdGgucG93KE1hdGguYWJzKG51bWJlciksIDEgLyAzKTsKICAgICAgICByZXR1cm4gbnVtYmVyIDwgMCA/IC1yZXN1bHQgOiByZXN1bHQ7CiAgICAgIH0pOwogICAgICBDZXNpdW1NYXRoLmxvZzIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChNYXRoLmxvZzIsIGZ1bmN0aW9uIGxvZzIobnVtYmVyKSB7CiAgICAgICAgcmV0dXJuIE1hdGgubG9nKG51bWJlcikgKiBNYXRoLkxPRzJFOwogICAgICB9KTsKICAgICAgQ2VzaXVtTWF0aC5mb2cgPSBmdW5jdGlvbihkaXN0YW5jZVRvQ2FtZXJhLCBkZW5zaXR5KSB7CiAgICAgICAgY29uc3Qgc2NhbGFyID0gZGlzdGFuY2VUb0NhbWVyYSAqIGRlbnNpdHk7CiAgICAgICAgcmV0dXJuIDEgLSBNYXRoLmV4cCgtKHNjYWxhciAqIHNjYWxhcikpOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLmZhc3RBcHByb3hpbWF0ZUF0YW4gPSBmdW5jdGlvbih4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ4IiwgeCk7CiAgICAgICAgcmV0dXJuIHggKiAoLTAuMTc4NCAqIE1hdGguYWJzKHgpIC0gMC4wNjYzICogeCAqIHggKyAxLjAzMDEpOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLmZhc3RBcHByb3hpbWF0ZUF0YW4yID0gZnVuY3Rpb24oeCwgeSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigieCIsIHgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigieSIsIHkpOwogICAgICAgIGxldCBvcHBvc2l0ZTsKICAgICAgICBsZXQgdCA9IE1hdGguYWJzKHgpOwogICAgICAgIG9wcG9zaXRlID0gTWF0aC5hYnMoeSk7CiAgICAgICAgY29uc3QgYWRqYWNlbnQgPSBNYXRoLm1heCh0LCBvcHBvc2l0ZSk7CiAgICAgICAgb3Bwb3NpdGUgPSBNYXRoLm1pbih0LCBvcHBvc2l0ZSk7CiAgICAgICAgY29uc3Qgb3Bwb3NpdGVPdmVyQWRqYWNlbnQgPSBvcHBvc2l0ZSAvIGFkamFjZW50OwogICAgICAgIGlmIChpc05hTihvcHBvc2l0ZU92ZXJBZGphY2VudCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJlaXRoZXIgeCBvciB5IG11c3QgYmUgbm9uemVybyIpOwogICAgICAgIH0KICAgICAgICB0ID0gQ2VzaXVtTWF0aC5mYXN0QXBwcm94aW1hdGVBdGFuKG9wcG9zaXRlT3ZlckFkamFjZW50KTsKICAgICAgICB0ID0gTWF0aC5hYnMoeSkgPiBNYXRoLmFicyh4KSA/IENlc2l1bU1hdGguUElfT1ZFUl9UV08gLSB0IDogdDsKICAgICAgICB0ID0geCA8IDAgPyBDZXNpdW1NYXRoLlBJIC0gdCA6IHQ7CiAgICAgICAgdCA9IHkgPCAwID8gLXQgOiB0OwogICAgICAgIHJldHVybiB0OwogICAgICB9OwogICAgICBNYXRoX2RlZmF1bHQgPSBDZXNpdW1NYXRoOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2FydGVzaWFuMy5qcwogIGZ1bmN0aW9uIENhcnRlc2lhbjMoeCwgeSwgeikgewogICAgdGhpcy54ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeCwgMCk7CiAgICB0aGlzLnkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh5LCAwKTsKICAgIHRoaXMueiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHosIDApOwogIH0KICB2YXIgZGlzdGFuY2VTY3JhdGNoLCBsZXJwU2NyYXRjaCwgYW5nbGVCZXR3ZWVuU2NyYXRjaCwgYW5nbGVCZXR3ZWVuU2NyYXRjaDIsIG1vc3RPcnRob2dvbmFsQXhpc1NjcmF0Y2gsIHNjcmF0Y2hOLCBzY3JhdGNoSywgd2dzODRSYWRpaVNxdWFyZWQsIENhcnRlc2lhbjNfZGVmYXVsdDsKICB2YXIgaW5pdF9DYXJ0ZXNpYW4zID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DYXJ0ZXNpYW4zLmpzIigpIHsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgQ2FydGVzaWFuMy5mcm9tU3BoZXJpY2FsID0gZnVuY3Rpb24oc3BoZXJpY2FsLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNwaGVyaWNhbCIsIHNwaGVyaWNhbCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjMoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY2xvY2sgPSBzcGhlcmljYWwuY2xvY2s7CiAgICAgICAgY29uc3QgY29uZSA9IHNwaGVyaWNhbC5jb25lOwogICAgICAgIGNvbnN0IG1hZ25pdHVkZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHNwaGVyaWNhbC5tYWduaXR1ZGUsIDEpOwogICAgICAgIGNvbnN0IHJhZGlhbCA9IG1hZ25pdHVkZSAqIE1hdGguc2luKGNvbmUpOwogICAgICAgIHJlc3VsdC54ID0gcmFkaWFsICogTWF0aC5jb3MoY2xvY2spOwogICAgICAgIHJlc3VsdC55ID0gcmFkaWFsICogTWF0aC5zaW4oY2xvY2spOwogICAgICAgIHJlc3VsdC56ID0gbWFnbml0dWRlICogTWF0aC5jb3MoY29uZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5mcm9tRWxlbWVudHMgPSBmdW5jdGlvbih4LCB5LCB6LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IENhcnRlc2lhbjMoeCwgeSwgeik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuY2xvbmUgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY2FydGVzaWFuMTEpKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IENhcnRlc2lhbjMoY2FydGVzaWFuMTEueCwgY2FydGVzaWFuMTEueSwgY2FydGVzaWFuMTEueik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0gY2FydGVzaWFuMTEueDsKICAgICAgICByZXN1bHQueSA9IGNhcnRlc2lhbjExLnk7CiAgICAgICAgcmVzdWx0LnogPSBjYXJ0ZXNpYW4xMS56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuZnJvbUNhcnRlc2lhbjQgPSBDYXJ0ZXNpYW4zLmNsb25lOwogICAgICBDYXJ0ZXNpYW4zLnBhY2tlZExlbmd0aCA9IDM7CiAgICAgIENhcnRlc2lhbjMucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLng7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLnk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS56OwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjMoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC55ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQueiA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMucGFja0FycmF5ID0gZnVuY3Rpb24oYXJyYXksIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwogICAgICAgIGNvbnN0IHJlc3VsdExlbmd0aCA9IGxlbmd0aCAqIDM7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEFycmF5KHJlc3VsdExlbmd0aCk7CiAgICAgICAgfSBlbHNlIGlmICghQXJyYXkuaXNBcnJheShyZXN1bHQpICYmIHJlc3VsdC5sZW5ndGggIT09IHJlc3VsdExlbmd0aCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJJZiByZXN1bHQgaXMgYSB0eXBlZCBhcnJheSwgaXQgbXVzdCBoYXZlIGV4YWN0bHkgYXJyYXkubGVuZ3RoICogMyBlbGVtZW50cyIKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIGlmIChyZXN1bHQubGVuZ3RoICE9PSByZXN1bHRMZW5ndGgpIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSByZXN1bHRMZW5ndGg7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIENhcnRlc2lhbjMucGFjayhhcnJheVtpXSwgcmVzdWx0LCBpICogMyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMudW5wYWNrQXJyYXkgPSBmdW5jdGlvbihhcnJheSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiYXJyYXkubGVuZ3RoIiwgYXJyYXkubGVuZ3RoLCAzKTsKICAgICAgICBpZiAoYXJyYXkubGVuZ3RoICUgMyAhPT0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGxlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMy4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShsZW5ndGggLyAzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IGxlbmd0aCAvIDM7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgIGNvbnN0IGluZGV4ID0gaSAvIDM7CiAgICAgICAgICByZXN1bHRbaW5kZXhdID0gQ2FydGVzaWFuMy51bnBhY2soYXJyYXksIGksIHJlc3VsdFtpbmRleF0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLmZyb21BcnJheSA9IENhcnRlc2lhbjMudW5wYWNrOwogICAgICBDYXJ0ZXNpYW4zLm1heGltdW1Db21wb25lbnQgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIHJldHVybiBNYXRoLm1heChjYXJ0ZXNpYW4xMS54LCBjYXJ0ZXNpYW4xMS55LCBjYXJ0ZXNpYW4xMS56KTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5taW5pbXVtQ29tcG9uZW50ID0gZnVuY3Rpb24oY2FydGVzaWFuMTEpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICByZXR1cm4gTWF0aC5taW4oY2FydGVzaWFuMTEueCwgY2FydGVzaWFuMTEueSwgY2FydGVzaWFuMTEueik7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMubWluaW11bUJ5Q29tcG9uZW50ID0gZnVuY3Rpb24oZmlyc3QsIHNlY29uZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJmaXJzdCIsIGZpcnN0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNlY29uZCIsIHNlY29uZCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gTWF0aC5taW4oZmlyc3QueCwgc2Vjb25kLngpOwogICAgICAgIHJlc3VsdC55ID0gTWF0aC5taW4oZmlyc3QueSwgc2Vjb25kLnkpOwogICAgICAgIHJlc3VsdC56ID0gTWF0aC5taW4oZmlyc3Queiwgc2Vjb25kLnopOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMubWF4aW11bUJ5Q29tcG9uZW50ID0gZnVuY3Rpb24oZmlyc3QsIHNlY29uZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJmaXJzdCIsIGZpcnN0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNlY29uZCIsIHNlY29uZCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gTWF0aC5tYXgoZmlyc3QueCwgc2Vjb25kLngpOwogICAgICAgIHJlc3VsdC55ID0gTWF0aC5tYXgoZmlyc3QueSwgc2Vjb25kLnkpOwogICAgICAgIHJlc3VsdC56ID0gTWF0aC5tYXgoZmlyc3Queiwgc2Vjb25kLnopOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuY2xhbXAgPSBmdW5jdGlvbih2YWx1ZSwgbWluMywgbWF4MywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1pbiIsIG1pbjMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF4IiwgbWF4Myk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHggPSBNYXRoX2RlZmF1bHQuY2xhbXAodmFsdWUueCwgbWluMy54LCBtYXgzLngpOwogICAgICAgIGNvbnN0IHkgPSBNYXRoX2RlZmF1bHQuY2xhbXAodmFsdWUueSwgbWluMy55LCBtYXgzLnkpOwogICAgICAgIGNvbnN0IHogPSBNYXRoX2RlZmF1bHQuY2xhbXAodmFsdWUueiwgbWluMy56LCBtYXgzLnopOwogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMubWFnbml0dWRlU3F1YXJlZCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmV0dXJuIGNhcnRlc2lhbjExLnggKiBjYXJ0ZXNpYW4xMS54ICsgY2FydGVzaWFuMTEueSAqIGNhcnRlc2lhbjExLnkgKyBjYXJ0ZXNpYW4xMS56ICogY2FydGVzaWFuMTEuejsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5tYWduaXR1ZGUgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSkgewogICAgICAgIHJldHVybiBNYXRoLnNxcnQoQ2FydGVzaWFuMy5tYWduaXR1ZGVTcXVhcmVkKGNhcnRlc2lhbjExKSk7CiAgICAgIH07CiAgICAgIGRpc3RhbmNlU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zKCk7CiAgICAgIENhcnRlc2lhbjMuZGlzdGFuY2UgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2FydGVzaWFuMy5zdWJ0cmFjdChsZWZ0LCByaWdodCwgZGlzdGFuY2VTY3JhdGNoKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMy5tYWduaXR1ZGUoZGlzdGFuY2VTY3JhdGNoKTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5kaXN0YW5jZVNxdWFyZWQgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2FydGVzaWFuMy5zdWJ0cmFjdChsZWZ0LCByaWdodCwgZGlzdGFuY2VTY3JhdGNoKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMy5tYWduaXR1ZGVTcXVhcmVkKGRpc3RhbmNlU2NyYXRjaCk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMubm9ybWFsaXplID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBtYWduaXR1ZGUgPSBDYXJ0ZXNpYW4zLm1hZ25pdHVkZShjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54IC8gbWFnbml0dWRlOwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueSAvIG1hZ25pdHVkZTsKICAgICAgICByZXN1bHQueiA9IGNhcnRlc2lhbjExLnogLyBtYWduaXR1ZGU7CiAgICAgICAgaWYgKGlzTmFOKHJlc3VsdC54KSB8fCBpc05hTihyZXN1bHQueSkgfHwgaXNOYU4ocmVzdWx0LnopKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibm9ybWFsaXplZCByZXN1bHQgaXMgbm90IGEgbnVtYmVyIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuZG90ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIHJldHVybiBsZWZ0LnggKiByaWdodC54ICsgbGVmdC55ICogcmlnaHQueSArIGxlZnQueiAqIHJpZ2h0Lno7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMubXVsdGlwbHlDb21wb25lbnRzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbGVmdC54ICogcmlnaHQueDsKICAgICAgICByZXN1bHQueSA9IGxlZnQueSAqIHJpZ2h0Lnk7CiAgICAgICAgcmVzdWx0LnogPSBsZWZ0LnogKiByaWdodC56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuZGl2aWRlQ29tcG9uZW50cyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCAvIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgLyByaWdodC55OwogICAgICAgIHJlc3VsdC56ID0gbGVmdC56IC8gcmlnaHQuejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLmFkZCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCArIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgKyByaWdodC55OwogICAgICAgIHJlc3VsdC56ID0gbGVmdC56ICsgcmlnaHQuejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLnN1YnRyYWN0ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbGVmdC54IC0gcmlnaHQueDsKICAgICAgICByZXN1bHQueSA9IGxlZnQueSAtIHJpZ2h0Lnk7CiAgICAgICAgcmVzdWx0LnogPSBsZWZ0LnogLSByaWdodC56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMubXVsdGlwbHlCeVNjYWxhciA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCBzY2FsYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGFyIiwgc2NhbGFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54ICogc2NhbGFyOwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueSAqIHNjYWxhcjsKICAgICAgICByZXN1bHQueiA9IGNhcnRlc2lhbjExLnogKiBzY2FsYXI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5kaXZpZGVCeVNjYWxhciA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCBzY2FsYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGFyIiwgc2NhbGFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54IC8gc2NhbGFyOwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueSAvIHNjYWxhcjsKICAgICAgICByZXN1bHQueiA9IGNhcnRlc2lhbjExLnogLyBzY2FsYXI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5uZWdhdGUgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gLWNhcnRlc2lhbjExLng7CiAgICAgICAgcmVzdWx0LnkgPSAtY2FydGVzaWFuMTEueTsKICAgICAgICByZXN1bHQueiA9IC1jYXJ0ZXNpYW4xMS56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuYWJzID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IE1hdGguYWJzKGNhcnRlc2lhbjExLngpOwogICAgICAgIHJlc3VsdC55ID0gTWF0aC5hYnMoY2FydGVzaWFuMTEueSk7CiAgICAgICAgcmVzdWx0LnogPSBNYXRoLmFicyhjYXJ0ZXNpYW4xMS56KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBsZXJwU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zKCk7CiAgICAgIENhcnRlc2lhbjMubGVycCA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQsIHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3RhcnQiLCBzdGFydCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJlbmQiLCBlbmQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigidCIsIHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBDYXJ0ZXNpYW4zLm11bHRpcGx5QnlTY2FsYXIoZW5kLCB0LCBsZXJwU2NyYXRjaCk7CiAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuMy5tdWx0aXBseUJ5U2NhbGFyKHN0YXJ0LCAxIC0gdCwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMy5hZGQobGVycFNjcmF0Y2gsIHJlc3VsdCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgYW5nbGVCZXR3ZWVuU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zKCk7CiAgICAgIGFuZ2xlQmV0d2VlblNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjMoKTsKICAgICAgQ2FydGVzaWFuMy5hbmdsZUJldHdlZW4gPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2FydGVzaWFuMy5ub3JtYWxpemUobGVmdCwgYW5nbGVCZXR3ZWVuU2NyYXRjaCk7CiAgICAgICAgQ2FydGVzaWFuMy5ub3JtYWxpemUocmlnaHQsIGFuZ2xlQmV0d2VlblNjcmF0Y2gyKTsKICAgICAgICBjb25zdCBjb3NpbmUgPSBDYXJ0ZXNpYW4zLmRvdChhbmdsZUJldHdlZW5TY3JhdGNoLCBhbmdsZUJldHdlZW5TY3JhdGNoMik7CiAgICAgICAgY29uc3Qgc2luZSA9IENhcnRlc2lhbjMubWFnbml0dWRlKAogICAgICAgICAgQ2FydGVzaWFuMy5jcm9zcygKICAgICAgICAgICAgYW5nbGVCZXR3ZWVuU2NyYXRjaCwKICAgICAgICAgICAgYW5nbGVCZXR3ZWVuU2NyYXRjaDIsCiAgICAgICAgICAgIGFuZ2xlQmV0d2VlblNjcmF0Y2gKICAgICAgICAgICkKICAgICAgICApOwogICAgICAgIHJldHVybiBNYXRoLmF0YW4yKHNpbmUsIGNvc2luZSk7CiAgICAgIH07CiAgICAgIG1vc3RPcnRob2dvbmFsQXhpc1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuMygpOwogICAgICBDYXJ0ZXNpYW4zLm1vc3RPcnRob2dvbmFsQXhpcyA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgZiA9IENhcnRlc2lhbjMubm9ybWFsaXplKGNhcnRlc2lhbjExLCBtb3N0T3J0aG9nb25hbEF4aXNTY3JhdGNoKTsKICAgICAgICBDYXJ0ZXNpYW4zLmFicyhmLCBmKTsKICAgICAgICBpZiAoZi54IDw9IGYueSkgewogICAgICAgICAgaWYgKGYueCA8PSBmLnopIHsKICAgICAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuMy5jbG9uZShDYXJ0ZXNpYW4zLlVOSVRfWCwgcmVzdWx0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjMuY2xvbmUoQ2FydGVzaWFuMy5VTklUX1osIHJlc3VsdCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChmLnkgPD0gZi56KSB7CiAgICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zLmNsb25lKENhcnRlc2lhbjMuVU5JVF9ZLCByZXN1bHQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zLmNsb25lKENhcnRlc2lhbjMuVU5JVF9aLCByZXN1bHQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLnByb2plY3RWZWN0b3IgPSBmdW5jdGlvbihhMywgYiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhIiwgYTMpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYiIsIGIpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBzY2FsYXIgPSBDYXJ0ZXNpYW4zLmRvdChhMywgYikgLyBDYXJ0ZXNpYW4zLmRvdChiLCBiKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMy5tdWx0aXBseUJ5U2NhbGFyKGIsIHNjYWxhciwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBsZWZ0LnggPT09IHJpZ2h0LnggJiYgbGVmdC55ID09PSByaWdodC55ICYmIGxlZnQueiA9PT0gcmlnaHQuejsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5lcXVhbHNBcnJheSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCBhcnJheSwgb2Zmc2V0KSB7CiAgICAgICAgcmV0dXJuIGNhcnRlc2lhbjExLnggPT09IGFycmF5W29mZnNldF0gJiYgY2FydGVzaWFuMTEueSA9PT0gYXJyYXlbb2Zmc2V0ICsgMV0gJiYgY2FydGVzaWFuMTEueiA9PT0gYXJyYXlbb2Zmc2V0ICsgMl07CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGxlZnQueCwKICAgICAgICAgIHJpZ2h0LngsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgbGVmdC55LAogICAgICAgICAgcmlnaHQueSwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBsZWZ0LnosCiAgICAgICAgICByaWdodC56LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5jcm9zcyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBsZWZ0WCA9IGxlZnQueDsKICAgICAgICBjb25zdCBsZWZ0WSA9IGxlZnQueTsKICAgICAgICBjb25zdCBsZWZ0WiA9IGxlZnQuejsKICAgICAgICBjb25zdCByaWdodFggPSByaWdodC54OwogICAgICAgIGNvbnN0IHJpZ2h0WSA9IHJpZ2h0Lnk7CiAgICAgICAgY29uc3QgcmlnaHRaID0gcmlnaHQuejsKICAgICAgICBjb25zdCB4ID0gbGVmdFkgKiByaWdodFogLSBsZWZ0WiAqIHJpZ2h0WTsKICAgICAgICBjb25zdCB5ID0gbGVmdFogKiByaWdodFggLSBsZWZ0WCAqIHJpZ2h0WjsKICAgICAgICBjb25zdCB6ID0gbGVmdFggKiByaWdodFkgLSBsZWZ0WSAqIHJpZ2h0WDsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLm1pZHBvaW50ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gKGxlZnQueCArIHJpZ2h0LngpICogMC41OwogICAgICAgIHJlc3VsdC55ID0gKGxlZnQueSArIHJpZ2h0LnkpICogMC41OwogICAgICAgIHJlc3VsdC56ID0gKGxlZnQueiArIHJpZ2h0LnopICogMC41OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuZnJvbURlZ3JlZXMgPSBmdW5jdGlvbihsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQsIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJsb25naXR1ZGUiLCBsb25naXR1ZGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibGF0aXR1ZGUiLCBsYXRpdHVkZSk7CiAgICAgICAgbG9uZ2l0dWRlID0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhsb25naXR1ZGUpOwogICAgICAgIGxhdGl0dWRlID0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhsYXRpdHVkZSk7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjMuZnJvbVJhZGlhbnMobG9uZ2l0dWRlLCBsYXRpdHVkZSwgaGVpZ2h0LCBlbGxpcHNvaWQsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hOID0gbmV3IENhcnRlc2lhbjMoKTsKICAgICAgc2NyYXRjaEsgPSBuZXcgQ2FydGVzaWFuMygpOwogICAgICB3Z3M4NFJhZGlpU3F1YXJlZCA9IG5ldyBDYXJ0ZXNpYW4zKAogICAgICAgIDYzNzgxMzcgKiA2Mzc4MTM3LAogICAgICAgIDYzNzgxMzcgKiA2Mzc4MTM3LAogICAgICAgIDYzNTY3NTIzMTQyNDUxNzllLTkgKiA2MzU2NzUyMzE0MjQ1MTc5ZS05CiAgICAgICk7CiAgICAgIENhcnRlc2lhbjMuZnJvbVJhZGlhbnMgPSBmdW5jdGlvbihsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQsIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJsb25naXR1ZGUiLCBsb25naXR1ZGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibGF0aXR1ZGUiLCBsYXRpdHVkZSk7CiAgICAgICAgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoaGVpZ2h0LCAwKTsKICAgICAgICBjb25zdCByYWRpaVNxdWFyZWQgPSBkZWZpbmVkX2RlZmF1bHQoZWxsaXBzb2lkKSA/IGVsbGlwc29pZC5yYWRpaVNxdWFyZWQgOiB3Z3M4NFJhZGlpU3F1YXJlZDsKICAgICAgICBjb25zdCBjb3NMYXRpdHVkZSA9IE1hdGguY29zKGxhdGl0dWRlKTsKICAgICAgICBzY3JhdGNoTi54ID0gY29zTGF0aXR1ZGUgKiBNYXRoLmNvcyhsb25naXR1ZGUpOwogICAgICAgIHNjcmF0Y2hOLnkgPSBjb3NMYXRpdHVkZSAqIE1hdGguc2luKGxvbmdpdHVkZSk7CiAgICAgICAgc2NyYXRjaE4ueiA9IE1hdGguc2luKGxhdGl0dWRlKTsKICAgICAgICBzY3JhdGNoTiA9IENhcnRlc2lhbjMubm9ybWFsaXplKHNjcmF0Y2hOLCBzY3JhdGNoTik7CiAgICAgICAgQ2FydGVzaWFuMy5tdWx0aXBseUNvbXBvbmVudHMocmFkaWlTcXVhcmVkLCBzY3JhdGNoTiwgc2NyYXRjaEspOwogICAgICAgIGNvbnN0IGdhbW1hID0gTWF0aC5zcXJ0KENhcnRlc2lhbjMuZG90KHNjcmF0Y2hOLCBzY3JhdGNoSykpOwogICAgICAgIHNjcmF0Y2hLID0gQ2FydGVzaWFuMy5kaXZpZGVCeVNjYWxhcihzY3JhdGNoSywgZ2FtbWEsIHNjcmF0Y2hLKTsKICAgICAgICBzY3JhdGNoTiA9IENhcnRlc2lhbjMubXVsdGlwbHlCeVNjYWxhcihzY3JhdGNoTiwgaGVpZ2h0LCBzY3JhdGNoTik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjMoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjMuYWRkKHNjcmF0Y2hLLCBzY3JhdGNoTiwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5mcm9tRGVncmVlc0FycmF5ID0gZnVuY3Rpb24oY29vcmRpbmF0ZXMsIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjb29yZGluYXRlcyIsIGNvb3JkaW5hdGVzKTsKICAgICAgICBpZiAoY29vcmRpbmF0ZXMubGVuZ3RoIDwgMiB8fCBjb29yZGluYXRlcy5sZW5ndGggJSAyICE9PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgInRoZSBudW1iZXIgb2YgY29vcmRpbmF0ZXMgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDIgYW5kIGF0IGxlYXN0IDIiCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBjb29yZGluYXRlcy5sZW5ndGg7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEFycmF5KGxlbmd0aCAvIDIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoIC8gMjsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMikgewogICAgICAgICAgY29uc3QgbG9uZ2l0dWRlID0gY29vcmRpbmF0ZXNbaV07CiAgICAgICAgICBjb25zdCBsYXRpdHVkZSA9IGNvb3JkaW5hdGVzW2kgKyAxXTsKICAgICAgICAgIGNvbnN0IGluZGV4ID0gaSAvIDI7CiAgICAgICAgICByZXN1bHRbaW5kZXhdID0gQ2FydGVzaWFuMy5mcm9tRGVncmVlcygKICAgICAgICAgICAgbG9uZ2l0dWRlLAogICAgICAgICAgICBsYXRpdHVkZSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICByZXN1bHRbaW5kZXhdCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLmZyb21SYWRpYW5zQXJyYXkgPSBmdW5jdGlvbihjb29yZGluYXRlcywgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNvb3JkaW5hdGVzIiwgY29vcmRpbmF0ZXMpOwogICAgICAgIGlmIChjb29yZGluYXRlcy5sZW5ndGggPCAyIHx8IGNvb3JkaW5hdGVzLmxlbmd0aCAlIDIgIT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAidGhlIG51bWJlciBvZiBjb29yZGluYXRlcyBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMiBhbmQgYXQgbGVhc3QgMiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNvb3JkaW5hdGVzLmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoIC8gMik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSBsZW5ndGggLyAyOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgICBjb25zdCBsb25naXR1ZGUgPSBjb29yZGluYXRlc1tpXTsKICAgICAgICAgIGNvbnN0IGxhdGl0dWRlID0gY29vcmRpbmF0ZXNbaSArIDFdOwogICAgICAgICAgY29uc3QgaW5kZXggPSBpIC8gMjsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBDYXJ0ZXNpYW4zLmZyb21SYWRpYW5zKAogICAgICAgICAgICBsb25naXR1ZGUsCiAgICAgICAgICAgIGxhdGl0dWRlLAogICAgICAgICAgICAwLAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIHJlc3VsdFtpbmRleF0KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuZnJvbURlZ3JlZXNBcnJheUhlaWdodHMgPSBmdW5jdGlvbihjb29yZGluYXRlcywgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNvb3JkaW5hdGVzIiwgY29vcmRpbmF0ZXMpOwogICAgICAgIGlmIChjb29yZGluYXRlcy5sZW5ndGggPCAzIHx8IGNvb3JkaW5hdGVzLmxlbmd0aCAlIDMgIT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAidGhlIG51bWJlciBvZiBjb29yZGluYXRlcyBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMyBhbmQgYXQgbGVhc3QgMyIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNvb3JkaW5hdGVzLmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoIC8gMyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSBsZW5ndGggLyAzOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAzKSB7CiAgICAgICAgICBjb25zdCBsb25naXR1ZGUgPSBjb29yZGluYXRlc1tpXTsKICAgICAgICAgIGNvbnN0IGxhdGl0dWRlID0gY29vcmRpbmF0ZXNbaSArIDFdOwogICAgICAgICAgY29uc3QgaGVpZ2h0ID0gY29vcmRpbmF0ZXNbaSArIDJdOwogICAgICAgICAgY29uc3QgaW5kZXggPSBpIC8gMzsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBDYXJ0ZXNpYW4zLmZyb21EZWdyZWVzKAogICAgICAgICAgICBsb25naXR1ZGUsCiAgICAgICAgICAgIGxhdGl0dWRlLAogICAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgcmVzdWx0W2luZGV4XQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5mcm9tUmFkaWFuc0FycmF5SGVpZ2h0cyA9IGZ1bmN0aW9uKGNvb3JkaW5hdGVzLCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY29vcmRpbmF0ZXMiLCBjb29yZGluYXRlcyk7CiAgICAgICAgaWYgKGNvb3JkaW5hdGVzLmxlbmd0aCA8IDMgfHwgY29vcmRpbmF0ZXMubGVuZ3RoICUgMyAhPT0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJ0aGUgbnVtYmVyIG9mIGNvb3JkaW5hdGVzIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAzIGFuZCBhdCBsZWFzdCAzIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoID0gY29vcmRpbmF0ZXMubGVuZ3RoOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShsZW5ndGggLyAzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IGxlbmd0aCAvIDM7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgIGNvbnN0IGxvbmdpdHVkZSA9IGNvb3JkaW5hdGVzW2ldOwogICAgICAgICAgY29uc3QgbGF0aXR1ZGUgPSBjb29yZGluYXRlc1tpICsgMV07CiAgICAgICAgICBjb25zdCBoZWlnaHQgPSBjb29yZGluYXRlc1tpICsgMl07CiAgICAgICAgICBjb25zdCBpbmRleCA9IGkgLyAzOwogICAgICAgICAgcmVzdWx0W2luZGV4XSA9IENhcnRlc2lhbjMuZnJvbVJhZGlhbnMoCiAgICAgICAgICAgIGxvbmdpdHVkZSwKICAgICAgICAgICAgbGF0aXR1ZGUsCiAgICAgICAgICAgIGhlaWdodCwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICByZXN1bHRbaW5kZXhdCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLlpFUk8gPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW4zKDAsIDAsIDApKTsKICAgICAgQ2FydGVzaWFuMy5PTkUgPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW4zKDEsIDEsIDEpKTsKICAgICAgQ2FydGVzaWFuMy5VTklUX1ggPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW4zKDEsIDAsIDApKTsKICAgICAgQ2FydGVzaWFuMy5VTklUX1kgPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW4zKDAsIDEsIDApKTsKICAgICAgQ2FydGVzaWFuMy5VTklUX1ogPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW4zKDAsIDAsIDEpKTsKICAgICAgQ2FydGVzaWFuMy5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMy5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zLmVxdWFscyh0aGlzLCByaWdodCk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMucHJvdG90eXBlLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihyaWdodCwgcmVsYXRpdmVFcHNpbG9uLCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMy5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcywKICAgICAgICAgIHJpZ2h0LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYCgke3RoaXMueH0sICR7dGhpcy55fSwgJHt0aGlzLnp9KWA7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdCA9IENhcnRlc2lhbjM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9zY2FsZVRvR2VvZGV0aWNTdXJmYWNlLmpzCiAgZnVuY3Rpb24gc2NhbGVUb0dlb2RldGljU3VyZmFjZShjYXJ0ZXNpYW4xMSwgb25lT3ZlclJhZGlpLCBvbmVPdmVyUmFkaWlTcXVhcmVkLCBjZW50ZXJUb2xlcmFuY2VTcXVhcmVkLCByZXN1bHQpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNhcnRlc2lhbjExKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiY2FydGVzaWFuIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob25lT3ZlclJhZGlpKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib25lT3ZlclJhZGlpIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob25lT3ZlclJhZGlpU3F1YXJlZCkpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9uZU92ZXJSYWRpaVNxdWFyZWQgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjZW50ZXJUb2xlcmFuY2VTcXVhcmVkKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiY2VudGVyVG9sZXJhbmNlU3F1YXJlZCBpcyByZXF1aXJlZC4iKTsKICAgIH0KICAgIGNvbnN0IHBvc2l0aW9uWCA9IGNhcnRlc2lhbjExLng7CiAgICBjb25zdCBwb3NpdGlvblkgPSBjYXJ0ZXNpYW4xMS55OwogICAgY29uc3QgcG9zaXRpb25aID0gY2FydGVzaWFuMTEuejsKICAgIGNvbnN0IG9uZU92ZXJSYWRpaVggPSBvbmVPdmVyUmFkaWkueDsKICAgIGNvbnN0IG9uZU92ZXJSYWRpaVkgPSBvbmVPdmVyUmFkaWkueTsKICAgIGNvbnN0IG9uZU92ZXJSYWRpaVogPSBvbmVPdmVyUmFkaWkuejsKICAgIGNvbnN0IHgyID0gcG9zaXRpb25YICogcG9zaXRpb25YICogb25lT3ZlclJhZGlpWCAqIG9uZU92ZXJSYWRpaVg7CiAgICBjb25zdCB5MiA9IHBvc2l0aW9uWSAqIHBvc2l0aW9uWSAqIG9uZU92ZXJSYWRpaVkgKiBvbmVPdmVyUmFkaWlZOwogICAgY29uc3QgejIgPSBwb3NpdGlvblogKiBwb3NpdGlvblogKiBvbmVPdmVyUmFkaWlaICogb25lT3ZlclJhZGlpWjsKICAgIGNvbnN0IHNxdWFyZWROb3JtID0geDIgKyB5MiArIHoyOwogICAgY29uc3QgcmF0aW8gPSBNYXRoLnNxcnQoMSAvIHNxdWFyZWROb3JtKTsKICAgIGNvbnN0IGludGVyc2VjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICBjYXJ0ZXNpYW4xMSwKICAgICAgcmF0aW8sCiAgICAgIHNjYWxlVG9HZW9kZXRpY1N1cmZhY2VJbnRlcnNlY3Rpb24KICAgICk7CiAgICBpZiAoc3F1YXJlZE5vcm0gPCBjZW50ZXJUb2xlcmFuY2VTcXVhcmVkKSB7CiAgICAgIHJldHVybiAhaXNGaW5pdGUocmF0aW8pID8gdm9pZCAwIDogQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGludGVyc2VjdGlvbiwgcmVzdWx0KTsKICAgIH0KICAgIGNvbnN0IG9uZU92ZXJSYWRpaVNxdWFyZWRYID0gb25lT3ZlclJhZGlpU3F1YXJlZC54OwogICAgY29uc3Qgb25lT3ZlclJhZGlpU3F1YXJlZFkgPSBvbmVPdmVyUmFkaWlTcXVhcmVkLnk7CiAgICBjb25zdCBvbmVPdmVyUmFkaWlTcXVhcmVkWiA9IG9uZU92ZXJSYWRpaVNxdWFyZWQuejsKICAgIGNvbnN0IGdyYWRpZW50ID0gc2NhbGVUb0dlb2RldGljU3VyZmFjZUdyYWRpZW50OwogICAgZ3JhZGllbnQueCA9IGludGVyc2VjdGlvbi54ICogb25lT3ZlclJhZGlpU3F1YXJlZFggKiAyOwogICAgZ3JhZGllbnQueSA9IGludGVyc2VjdGlvbi55ICogb25lT3ZlclJhZGlpU3F1YXJlZFkgKiAyOwogICAgZ3JhZGllbnQueiA9IGludGVyc2VjdGlvbi56ICogb25lT3ZlclJhZGlpU3F1YXJlZFogKiAyOwogICAgbGV0IGxhbWJkYSA9ICgxIC0gcmF0aW8pICogQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZShjYXJ0ZXNpYW4xMSkgLyAoMC41ICogQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZShncmFkaWVudCkpOwogICAgbGV0IGNvcnJlY3Rpb24gPSAwOwogICAgbGV0IGZ1bmM7CiAgICBsZXQgZGVub21pbmF0b3I7CiAgICBsZXQgeE11bHRpcGxpZXI7CiAgICBsZXQgeU11bHRpcGxpZXI7CiAgICBsZXQgek11bHRpcGxpZXI7CiAgICBsZXQgeE11bHRpcGxpZXIyOwogICAgbGV0IHlNdWx0aXBsaWVyMjsKICAgIGxldCB6TXVsdGlwbGllcjI7CiAgICBsZXQgeE11bHRpcGxpZXIzOwogICAgbGV0IHlNdWx0aXBsaWVyMzsKICAgIGxldCB6TXVsdGlwbGllcjM7CiAgICBkbyB7CiAgICAgIGxhbWJkYSAtPSBjb3JyZWN0aW9uOwogICAgICB4TXVsdGlwbGllciA9IDEgLyAoMSArIGxhbWJkYSAqIG9uZU92ZXJSYWRpaVNxdWFyZWRYKTsKICAgICAgeU11bHRpcGxpZXIgPSAxIC8gKDEgKyBsYW1iZGEgKiBvbmVPdmVyUmFkaWlTcXVhcmVkWSk7CiAgICAgIHpNdWx0aXBsaWVyID0gMSAvICgxICsgbGFtYmRhICogb25lT3ZlclJhZGlpU3F1YXJlZFopOwogICAgICB4TXVsdGlwbGllcjIgPSB4TXVsdGlwbGllciAqIHhNdWx0aXBsaWVyOwogICAgICB5TXVsdGlwbGllcjIgPSB5TXVsdGlwbGllciAqIHlNdWx0aXBsaWVyOwogICAgICB6TXVsdGlwbGllcjIgPSB6TXVsdGlwbGllciAqIHpNdWx0aXBsaWVyOwogICAgICB4TXVsdGlwbGllcjMgPSB4TXVsdGlwbGllcjIgKiB4TXVsdGlwbGllcjsKICAgICAgeU11bHRpcGxpZXIzID0geU11bHRpcGxpZXIyICogeU11bHRpcGxpZXI7CiAgICAgIHpNdWx0aXBsaWVyMyA9IHpNdWx0aXBsaWVyMiAqIHpNdWx0aXBsaWVyOwogICAgICBmdW5jID0geDIgKiB4TXVsdGlwbGllcjIgKyB5MiAqIHlNdWx0aXBsaWVyMiArIHoyICogek11bHRpcGxpZXIyIC0gMTsKICAgICAgZGVub21pbmF0b3IgPSB4MiAqIHhNdWx0aXBsaWVyMyAqIG9uZU92ZXJSYWRpaVNxdWFyZWRYICsgeTIgKiB5TXVsdGlwbGllcjMgKiBvbmVPdmVyUmFkaWlTcXVhcmVkWSArIHoyICogek11bHRpcGxpZXIzICogb25lT3ZlclJhZGlpU3F1YXJlZFo7CiAgICAgIGNvbnN0IGRlcml2YXRpdmUgPSAtMiAqIGRlbm9taW5hdG9yOwogICAgICBjb3JyZWN0aW9uID0gZnVuYyAvIGRlcml2YXRpdmU7CiAgICB9IHdoaWxlIChNYXRoLmFicyhmdW5jKSA+IE1hdGhfZGVmYXVsdC5FUFNJTE9OMTIpOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICByZXR1cm4gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgKICAgICAgICBwb3NpdGlvblggKiB4TXVsdGlwbGllciwKICAgICAgICBwb3NpdGlvblkgKiB5TXVsdGlwbGllciwKICAgICAgICBwb3NpdGlvblogKiB6TXVsdGlwbGllcgogICAgICApOwogICAgfQogICAgcmVzdWx0LnggPSBwb3NpdGlvblggKiB4TXVsdGlwbGllcjsKICAgIHJlc3VsdC55ID0gcG9zaXRpb25ZICogeU11bHRpcGxpZXI7CiAgICByZXN1bHQueiA9IHBvc2l0aW9uWiAqIHpNdWx0aXBsaWVyOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdmFyIHNjYWxlVG9HZW9kZXRpY1N1cmZhY2VJbnRlcnNlY3Rpb24sIHNjYWxlVG9HZW9kZXRpY1N1cmZhY2VHcmFkaWVudCwgc2NhbGVUb0dlb2RldGljU3VyZmFjZV9kZWZhdWx0OwogIHZhciBpbml0X3NjYWxlVG9HZW9kZXRpY1N1cmZhY2UgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL3NjYWxlVG9HZW9kZXRpY1N1cmZhY2UuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIHNjYWxlVG9HZW9kZXRpY1N1cmZhY2VJbnRlcnNlY3Rpb24gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjYWxlVG9HZW9kZXRpY1N1cmZhY2VHcmFkaWVudCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NhbGVUb0dlb2RldGljU3VyZmFjZV9kZWZhdWx0ID0gc2NhbGVUb0dlb2RldGljU3VyZmFjZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NhcnRvZ3JhcGhpYy5qcwogIGZ1bmN0aW9uIENhcnRvZ3JhcGhpYyhsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQpIHsKICAgIHRoaXMubG9uZ2l0dWRlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQobG9uZ2l0dWRlLCAwKTsKICAgIHRoaXMubGF0aXR1ZGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChsYXRpdHVkZSwgMCk7CiAgICB0aGlzLmhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGhlaWdodCwgMCk7CiAgfQogIHZhciBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpY04sIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljUCwgY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWNILCB3Z3M4NE9uZU92ZXJSYWRpaSwgd2dzODRPbmVPdmVyUmFkaWlTcXVhcmVkLCB3Z3M4NENlbnRlclRvbGVyYW5jZVNxdWFyZWQsIENhcnRvZ3JhcGhpY19kZWZhdWx0OwogIHZhciBpbml0X0NhcnRvZ3JhcGhpYyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2FydG9ncmFwaGljLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X3NjYWxlVG9HZW9kZXRpY1N1cmZhY2UoKTsKICAgICAgQ2FydG9ncmFwaGljLmZyb21SYWRpYW5zID0gZnVuY3Rpb24obG9uZ2l0dWRlLCBsYXRpdHVkZSwgaGVpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImxvbmdpdHVkZSIsIGxvbmdpdHVkZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJsYXRpdHVkZSIsIGxhdGl0dWRlKTsKICAgICAgICBoZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChoZWlnaHQsIDApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljKGxvbmdpdHVkZSwgbGF0aXR1ZGUsIGhlaWdodCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSBsb25naXR1ZGU7CiAgICAgICAgcmVzdWx0LmxhdGl0dWRlID0gbGF0aXR1ZGU7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IGhlaWdodDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0b2dyYXBoaWMuZnJvbURlZ3JlZXMgPSBmdW5jdGlvbihsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibG9uZ2l0dWRlIiwgbG9uZ2l0dWRlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImxhdGl0dWRlIiwgbGF0aXR1ZGUpOwogICAgICAgIGxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMobG9uZ2l0dWRlKTsKICAgICAgICBsYXRpdHVkZSA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMobGF0aXR1ZGUpOwogICAgICAgIHJldHVybiBDYXJ0b2dyYXBoaWMuZnJvbVJhZGlhbnMobG9uZ2l0dWRlLCBsYXRpdHVkZSwgaGVpZ2h0LCByZXN1bHQpOwogICAgICB9OwogICAgICBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpY04gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljUCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWNIID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB3Z3M4NE9uZU92ZXJSYWRpaSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoCiAgICAgICAgMSAvIDYzNzgxMzcsCiAgICAgICAgMSAvIDYzNzgxMzcsCiAgICAgICAgMSAvIDYzNTY3NTIzMTQyNDUxNzllLTkKICAgICAgKTsKICAgICAgd2dzODRPbmVPdmVyUmFkaWlTcXVhcmVkID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgKICAgICAgICAxIC8gKDYzNzgxMzcgKiA2Mzc4MTM3KSwKICAgICAgICAxIC8gKDYzNzgxMzcgKiA2Mzc4MTM3KSwKICAgICAgICAxIC8gKDYzNTY3NTIzMTQyNDUxNzllLTkgKiA2MzU2NzUyMzE0MjQ1MTc5ZS05KQogICAgICApOwogICAgICB3Z3M4NENlbnRlclRvbGVyYW5jZVNxdWFyZWQgPSBNYXRoX2RlZmF1bHQuRVBTSUxPTjE7CiAgICAgIENhcnRvZ3JhcGhpYy5mcm9tQ2FydGVzaWFuID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3Qgb25lT3ZlclJhZGlpID0gZGVmaW5lZF9kZWZhdWx0KGVsbGlwc29pZCkgPyBlbGxpcHNvaWQub25lT3ZlclJhZGlpIDogd2dzODRPbmVPdmVyUmFkaWk7CiAgICAgICAgY29uc3Qgb25lT3ZlclJhZGlpU3F1YXJlZCA9IGRlZmluZWRfZGVmYXVsdChlbGxpcHNvaWQpID8gZWxsaXBzb2lkLm9uZU92ZXJSYWRpaVNxdWFyZWQgOiB3Z3M4NE9uZU92ZXJSYWRpaVNxdWFyZWQ7CiAgICAgICAgY29uc3QgY2VudGVyVG9sZXJhbmNlU3F1YXJlZCA9IGRlZmluZWRfZGVmYXVsdChlbGxpcHNvaWQpID8gZWxsaXBzb2lkLl9jZW50ZXJUb2xlcmFuY2VTcXVhcmVkIDogd2dzODRDZW50ZXJUb2xlcmFuY2VTcXVhcmVkOwogICAgICAgIGNvbnN0IHAgPSBzY2FsZVRvR2VvZGV0aWNTdXJmYWNlX2RlZmF1bHQoCiAgICAgICAgICBjYXJ0ZXNpYW4xMSwKICAgICAgICAgIG9uZU92ZXJSYWRpaSwKICAgICAgICAgIG9uZU92ZXJSYWRpaVNxdWFyZWQsCiAgICAgICAgICBjZW50ZXJUb2xlcmFuY2VTcXVhcmVkLAogICAgICAgICAgY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWNQCiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgbGV0IG4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlDb21wb25lbnRzKAogICAgICAgICAgcCwKICAgICAgICAgIG9uZU92ZXJSYWRpaVNxdWFyZWQsCiAgICAgICAgICBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpY04KICAgICAgICApOwogICAgICAgIG4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKG4sIG4pOwogICAgICAgIGNvbnN0IGggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY2FydGVzaWFuMTEsIHAsIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljSCk7CiAgICAgICAgY29uc3QgbG9uZ2l0dWRlID0gTWF0aC5hdGFuMihuLnksIG4ueCk7CiAgICAgICAgY29uc3QgbGF0aXR1ZGUgPSBNYXRoLmFzaW4obi56KTsKICAgICAgICBjb25zdCBoZWlnaHQgPSBNYXRoX2RlZmF1bHQuc2lnbihDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGgsIGNhcnRlc2lhbjExKSkgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKGgpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljKGxvbmdpdHVkZSwgbGF0aXR1ZGUsIGhlaWdodCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSBsb25naXR1ZGU7CiAgICAgICAgcmVzdWx0LmxhdGl0dWRlID0gbGF0aXR1ZGU7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IGhlaWdodDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0b2dyYXBoaWMudG9DYXJ0ZXNpYW4gPSBmdW5jdGlvbihjYXJ0b2dyYXBoaWMyLCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2FydG9ncmFwaGljIiwgY2FydG9ncmFwaGljMik7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgIGNhcnRvZ3JhcGhpYzIubG9uZ2l0dWRlLAogICAgICAgICAgY2FydG9ncmFwaGljMi5sYXRpdHVkZSwKICAgICAgICAgIGNhcnRvZ3JhcGhpYzIuaGVpZ2h0LAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQ2FydG9ncmFwaGljLmNsb25lID0gZnVuY3Rpb24oY2FydG9ncmFwaGljMiwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY2FydG9ncmFwaGljMikpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljKAogICAgICAgICAgICBjYXJ0b2dyYXBoaWMyLmxvbmdpdHVkZSwKICAgICAgICAgICAgY2FydG9ncmFwaGljMi5sYXRpdHVkZSwKICAgICAgICAgICAgY2FydG9ncmFwaGljMi5oZWlnaHQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSBjYXJ0b2dyYXBoaWMyLmxvbmdpdHVkZTsKICAgICAgICByZXN1bHQubGF0aXR1ZGUgPSBjYXJ0b2dyYXBoaWMyLmxhdGl0dWRlOwogICAgICAgIHJlc3VsdC5oZWlnaHQgPSBjYXJ0b2dyYXBoaWMyLmhlaWdodDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0b2dyYXBoaWMuZXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgbGVmdC5sb25naXR1ZGUgPT09IHJpZ2h0LmxvbmdpdHVkZSAmJiBsZWZ0LmxhdGl0dWRlID09PSByaWdodC5sYXRpdHVkZSAmJiBsZWZ0LmhlaWdodCA9PT0gcmlnaHQuaGVpZ2h0OwogICAgICB9OwogICAgICBDYXJ0b2dyYXBoaWMuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCBlcHNpbG9uKSB7CiAgICAgICAgZXBzaWxvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVwc2lsb24sIDApOwogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBNYXRoLmFicyhsZWZ0LmxvbmdpdHVkZSAtIHJpZ2h0LmxvbmdpdHVkZSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0LmxhdGl0dWRlIC0gcmlnaHQubGF0aXR1ZGUpIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdC5oZWlnaHQgLSByaWdodC5oZWlnaHQpIDw9IGVwc2lsb247CiAgICAgIH07CiAgICAgIENhcnRvZ3JhcGhpYy5aRVJPID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydG9ncmFwaGljKDAsIDAsIDApKTsKICAgICAgQ2FydG9ncmFwaGljLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJldHVybiBDYXJ0b2dyYXBoaWMuY2xvbmUodGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgQ2FydG9ncmFwaGljLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiBDYXJ0b2dyYXBoaWMuZXF1YWxzKHRoaXMsIHJpZ2h0KTsKICAgICAgfTsKICAgICAgQ2FydG9ncmFwaGljLnByb3RvdHlwZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24ocmlnaHQsIGVwc2lsb24pIHsKICAgICAgICByZXR1cm4gQ2FydG9ncmFwaGljLmVxdWFsc0Vwc2lsb24odGhpcywgcmlnaHQsIGVwc2lsb24pOwogICAgICB9OwogICAgICBDYXJ0b2dyYXBoaWMucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGAoJHt0aGlzLmxvbmdpdHVkZX0sICR7dGhpcy5sYXRpdHVkZX0sICR7dGhpcy5oZWlnaHR9KWA7CiAgICAgIH07CiAgICAgIENhcnRvZ3JhcGhpY19kZWZhdWx0ID0gQ2FydG9ncmFwaGljOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2FydGVzaWFuMi5qcwogIGZ1bmN0aW9uIENhcnRlc2lhbjIoeCwgeSkgewogICAgdGhpcy54ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeCwgMCk7CiAgICB0aGlzLnkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh5LCAwKTsKICB9CiAgdmFyIGRpc3RhbmNlU2NyYXRjaDIsIGxlcnBTY3JhdGNoMiwgYW5nbGVCZXR3ZWVuU2NyYXRjaDMsIGFuZ2xlQmV0d2VlblNjcmF0Y2gyMiwgbW9zdE9ydGhvZ29uYWxBeGlzU2NyYXRjaDIsIENhcnRlc2lhbjJfZGVmYXVsdDsKICB2YXIgaW5pdF9DYXJ0ZXNpYW4yID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DYXJ0ZXNpYW4yLmpzIigpIHsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgQ2FydGVzaWFuMi5mcm9tRWxlbWVudHMgPSBmdW5jdGlvbih4LCB5LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IENhcnRlc2lhbjIoeCwgeSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5jbG9uZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjYXJ0ZXNpYW4xMSkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydGVzaWFuMihjYXJ0ZXNpYW4xMS54LCBjYXJ0ZXNpYW4xMS55KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLmZyb21DYXJ0ZXNpYW4zID0gQ2FydGVzaWFuMi5jbG9uZTsKICAgICAgQ2FydGVzaWFuMi5mcm9tQ2FydGVzaWFuNCA9IENhcnRlc2lhbjIuY2xvbmU7CiAgICAgIENhcnRlc2lhbjIucGFja2VkTGVuZ3RoID0gMjsKICAgICAgQ2FydGVzaWFuMi5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUueDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLnk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuMigpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LnkgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLnBhY2tBcnJheSA9IGZ1bmN0aW9uKGFycmF5LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICBjb25zdCByZXN1bHRMZW5ndGggPSBsZW5ndGggKiAyOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShyZXN1bHRMZW5ndGgpOwogICAgICAgIH0gZWxzZSBpZiAoIUFycmF5LmlzQXJyYXkocmVzdWx0KSAmJiByZXN1bHQubGVuZ3RoICE9PSByZXN1bHRMZW5ndGgpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiSWYgcmVzdWx0IGlzIGEgdHlwZWQgYXJyYXksIGl0IG11c3QgaGF2ZSBleGFjdGx5IGFycmF5Lmxlbmd0aCAqIDIgZWxlbWVudHMiCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSBpZiAocmVzdWx0Lmxlbmd0aCAhPT0gcmVzdWx0TGVuZ3RoKSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gcmVzdWx0TGVuZ3RoOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4yLnBhY2soYXJyYXlbaV0sIHJlc3VsdCwgaSAqIDIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLnVucGFja0FycmF5ID0gZnVuY3Rpb24oYXJyYXksIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImFycmF5Lmxlbmd0aCIsIGFycmF5Lmxlbmd0aCwgMik7CiAgICAgICAgaWYgKGFycmF5Lmxlbmd0aCAlIDIgIT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBsZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDIuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoIC8gMik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSBsZW5ndGggLyAyOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgICBjb25zdCBpbmRleCA9IGkgLyAyOwogICAgICAgICAgcmVzdWx0W2luZGV4XSA9IENhcnRlc2lhbjIudW5wYWNrKGFycmF5LCBpLCByZXN1bHRbaW5kZXhdKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5mcm9tQXJyYXkgPSBDYXJ0ZXNpYW4yLnVucGFjazsKICAgICAgQ2FydGVzaWFuMi5tYXhpbXVtQ29tcG9uZW50ID0gZnVuY3Rpb24oY2FydGVzaWFuMTEpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICByZXR1cm4gTWF0aC5tYXgoY2FydGVzaWFuMTEueCwgY2FydGVzaWFuMTEueSk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubWluaW11bUNvbXBvbmVudCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmV0dXJuIE1hdGgubWluKGNhcnRlc2lhbjExLngsIGNhcnRlc2lhbjExLnkpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLm1pbmltdW1CeUNvbXBvbmVudCA9IGZ1bmN0aW9uKGZpcnN0LCBzZWNvbmQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZmlyc3QiLCBmaXJzdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzZWNvbmQiLCBzZWNvbmQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IE1hdGgubWluKGZpcnN0LngsIHNlY29uZC54KTsKICAgICAgICByZXN1bHQueSA9IE1hdGgubWluKGZpcnN0LnksIHNlY29uZC55KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLm1heGltdW1CeUNvbXBvbmVudCA9IGZ1bmN0aW9uKGZpcnN0LCBzZWNvbmQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZmlyc3QiLCBmaXJzdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzZWNvbmQiLCBzZWNvbmQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IE1hdGgubWF4KGZpcnN0LngsIHNlY29uZC54KTsKICAgICAgICByZXN1bHQueSA9IE1hdGgubWF4KGZpcnN0LnksIHNlY29uZC55KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLmNsYW1wID0gZnVuY3Rpb24odmFsdWUsIG1pbjMsIG1heDMsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtaW4iLCBtaW4zKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1heCIsIG1heDMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCB4ID0gTWF0aF9kZWZhdWx0LmNsYW1wKHZhbHVlLngsIG1pbjMueCwgbWF4My54KTsKICAgICAgICBjb25zdCB5ID0gTWF0aF9kZWZhdWx0LmNsYW1wKHZhbHVlLnksIG1pbjMueSwgbWF4My55KTsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubWFnbml0dWRlU3F1YXJlZCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmV0dXJuIGNhcnRlc2lhbjExLnggKiBjYXJ0ZXNpYW4xMS54ICsgY2FydGVzaWFuMTEueSAqIGNhcnRlc2lhbjExLnk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubWFnbml0dWRlID0gZnVuY3Rpb24oY2FydGVzaWFuMTEpIHsKICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KENhcnRlc2lhbjIubWFnbml0dWRlU3F1YXJlZChjYXJ0ZXNpYW4xMSkpOwogICAgICB9OwogICAgICBkaXN0YW5jZVNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjIoKTsKICAgICAgQ2FydGVzaWFuMi5kaXN0YW5jZSA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDYXJ0ZXNpYW4yLnN1YnRyYWN0KGxlZnQsIHJpZ2h0LCBkaXN0YW5jZVNjcmF0Y2gyKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMi5tYWduaXR1ZGUoZGlzdGFuY2VTY3JhdGNoMik7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuZGlzdGFuY2VTcXVhcmVkID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENhcnRlc2lhbjIuc3VidHJhY3QobGVmdCwgcmlnaHQsIGRpc3RhbmNlU2NyYXRjaDIpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yLm1hZ25pdHVkZVNxdWFyZWQoZGlzdGFuY2VTY3JhdGNoMik7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubm9ybWFsaXplID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBtYWduaXR1ZGUgPSBDYXJ0ZXNpYW4yLm1hZ25pdHVkZShjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54IC8gbWFnbml0dWRlOwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueSAvIG1hZ25pdHVkZTsKICAgICAgICBpZiAoaXNOYU4ocmVzdWx0LngpIHx8IGlzTmFOKHJlc3VsdC55KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm5vcm1hbGl6ZWQgcmVzdWx0IGlzIG5vdCBhIG51bWJlciIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLmRvdCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICByZXR1cm4gbGVmdC54ICogcmlnaHQueCArIGxlZnQueSAqIHJpZ2h0Lnk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuY3Jvc3MgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgcmV0dXJuIGxlZnQueCAqIHJpZ2h0LnkgLSBsZWZ0LnkgKiByaWdodC54OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLm11bHRpcGx5Q29tcG9uZW50cyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCAqIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgKiByaWdodC55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuZGl2aWRlQ29tcG9uZW50cyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCAvIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgLyByaWdodC55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuYWRkID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbGVmdC54ICsgcmlnaHQueDsKICAgICAgICByZXN1bHQueSA9IGxlZnQueSArIHJpZ2h0Lnk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5zdWJ0cmFjdCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCAtIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgLSByaWdodC55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubXVsdGlwbHlCeVNjYWxhciA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCBzY2FsYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGFyIiwgc2NhbGFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54ICogc2NhbGFyOwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueSAqIHNjYWxhcjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLmRpdmlkZUJ5U2NhbGFyID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHNjYWxhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsYXIiLCBzY2FsYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGNhcnRlc2lhbjExLnggLyBzY2FsYXI7CiAgICAgICAgcmVzdWx0LnkgPSBjYXJ0ZXNpYW4xMS55IC8gc2NhbGFyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubmVnYXRlID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IC1jYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdC55ID0gLWNhcnRlc2lhbjExLnk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5hYnMgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gTWF0aC5hYnMoY2FydGVzaWFuMTEueCk7CiAgICAgICAgcmVzdWx0LnkgPSBNYXRoLmFicyhjYXJ0ZXNpYW4xMS55KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBsZXJwU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuMigpOwogICAgICBDYXJ0ZXNpYW4yLmxlcnAgPSBmdW5jdGlvbihzdGFydCwgZW5kLCB0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInN0YXJ0Iiwgc3RhcnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZW5kIiwgZW5kKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInQiLCB0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgQ2FydGVzaWFuMi5tdWx0aXBseUJ5U2NhbGFyKGVuZCwgdCwgbGVycFNjcmF0Y2gyKTsKICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4yLm11bHRpcGx5QnlTY2FsYXIoc3RhcnQsIDEgLSB0LCByZXN1bHQpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yLmFkZChsZXJwU2NyYXRjaDIsIHJlc3VsdCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgYW5nbGVCZXR3ZWVuU2NyYXRjaDMgPSBuZXcgQ2FydGVzaWFuMigpOwogICAgICBhbmdsZUJldHdlZW5TY3JhdGNoMjIgPSBuZXcgQ2FydGVzaWFuMigpOwogICAgICBDYXJ0ZXNpYW4yLmFuZ2xlQmV0d2VlbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDYXJ0ZXNpYW4yLm5vcm1hbGl6ZShsZWZ0LCBhbmdsZUJldHdlZW5TY3JhdGNoMyk7CiAgICAgICAgQ2FydGVzaWFuMi5ub3JtYWxpemUocmlnaHQsIGFuZ2xlQmV0d2VlblNjcmF0Y2gyMik7CiAgICAgICAgcmV0dXJuIE1hdGhfZGVmYXVsdC5hY29zQ2xhbXBlZCgKICAgICAgICAgIENhcnRlc2lhbjIuZG90KGFuZ2xlQmV0d2VlblNjcmF0Y2gzLCBhbmdsZUJldHdlZW5TY3JhdGNoMjIpCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgbW9zdE9ydGhvZ29uYWxBeGlzU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuMigpOwogICAgICBDYXJ0ZXNpYW4yLm1vc3RPcnRob2dvbmFsQXhpcyA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgZiA9IENhcnRlc2lhbjIubm9ybWFsaXplKGNhcnRlc2lhbjExLCBtb3N0T3J0aG9nb25hbEF4aXNTY3JhdGNoMik7CiAgICAgICAgQ2FydGVzaWFuMi5hYnMoZiwgZik7CiAgICAgICAgaWYgKGYueCA8PSBmLnkpIHsKICAgICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjIuY2xvbmUoQ2FydGVzaWFuMi5VTklUX1gsIHJlc3VsdCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjIuY2xvbmUoQ2FydGVzaWFuMi5VTklUX1ksIHJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuZXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgbGVmdC54ID09PSByaWdodC54ICYmIGxlZnQueSA9PT0gcmlnaHQueTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5lcXVhbHNBcnJheSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCBhcnJheSwgb2Zmc2V0KSB7CiAgICAgICAgcmV0dXJuIGNhcnRlc2lhbjExLnggPT09IGFycmF5W29mZnNldF0gJiYgY2FydGVzaWFuMTEueSA9PT0gYXJyYXlbb2Zmc2V0ICsgMV07CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGxlZnQueCwKICAgICAgICAgIHJpZ2h0LngsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgbGVmdC55LAogICAgICAgICAgcmlnaHQueSwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuWkVSTyA9IE9iamVjdC5mcmVlemUobmV3IENhcnRlc2lhbjIoMCwgMCkpOwogICAgICBDYXJ0ZXNpYW4yLk9ORSA9IE9iamVjdC5mcmVlemUobmV3IENhcnRlc2lhbjIoMSwgMSkpOwogICAgICBDYXJ0ZXNpYW4yLlVOSVRfWCA9IE9iamVjdC5mcmVlemUobmV3IENhcnRlc2lhbjIoMSwgMCkpOwogICAgICBDYXJ0ZXNpYW4yLlVOSVRfWSA9IE9iamVjdC5mcmVlemUobmV3IENhcnRlc2lhbjIoMCwgMSkpOwogICAgICBDYXJ0ZXNpYW4yLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yLmNsb25lKHRoaXMsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjIuZXF1YWxzKHRoaXMsIHJpZ2h0KTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5wcm90b3R5cGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKHJpZ2h0LCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yLmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLAogICAgICAgICAgcmlnaHQsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBgKCR7dGhpcy54fSwgJHt0aGlzLnl9KWA7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjJfZGVmYXVsdCA9IENhcnRlc2lhbjI7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNvaWQuanMKICBmdW5jdGlvbiBpbml0aWFsaXplKGVsbGlwc29pZCwgeCwgeSwgeikgewogICAgeCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHgsIDApOwogICAgeSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHksIDApOwogICAgeiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHosIDApOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoIngiLCB4LCAwKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJ5IiwgeSwgMCk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygieiIsIHosIDApOwogICAgZWxsaXBzb2lkLl9yYWRpaSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCwgeSwgeik7CiAgICBlbGxpcHNvaWQuX3JhZGlpU3F1YXJlZCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCAqIHgsIHkgKiB5LCB6ICogeik7CiAgICBlbGxpcHNvaWQuX3JhZGlpVG9UaGVGb3VydGggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KAogICAgICB4ICogeCAqIHggKiB4LAogICAgICB5ICogeSAqIHkgKiB5LAogICAgICB6ICogeiAqIHogKiB6CiAgICApOwogICAgZWxsaXBzb2lkLl9vbmVPdmVyUmFkaWkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KAogICAgICB4ID09PSAwID8gMCA6IDEgLyB4LAogICAgICB5ID09PSAwID8gMCA6IDEgLyB5LAogICAgICB6ID09PSAwID8gMCA6IDEgLyB6CiAgICApOwogICAgZWxsaXBzb2lkLl9vbmVPdmVyUmFkaWlTcXVhcmVkID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgKICAgICAgeCA9PT0gMCA/IDAgOiAxIC8gKHggKiB4KSwKICAgICAgeSA9PT0gMCA/IDAgOiAxIC8gKHkgKiB5KSwKICAgICAgeiA9PT0gMCA/IDAgOiAxIC8gKHogKiB6KQogICAgKTsKICAgIGVsbGlwc29pZC5fbWluaW11bVJhZGl1cyA9IE1hdGgubWluKHgsIHksIHopOwogICAgZWxsaXBzb2lkLl9tYXhpbXVtUmFkaXVzID0gTWF0aC5tYXgoeCwgeSwgeik7CiAgICBlbGxpcHNvaWQuX2NlbnRlclRvbGVyYW5jZVNxdWFyZWQgPSBNYXRoX2RlZmF1bHQuRVBTSUxPTjE7CiAgICBpZiAoZWxsaXBzb2lkLl9yYWRpaVNxdWFyZWQueiAhPT0gMCkgewogICAgICBlbGxpcHNvaWQuX3NxdWFyZWRYT3ZlclNxdWFyZWRaID0gZWxsaXBzb2lkLl9yYWRpaVNxdWFyZWQueCAvIGVsbGlwc29pZC5fcmFkaWlTcXVhcmVkLno7CiAgICB9CiAgfQogIGZ1bmN0aW9uIEVsbGlwc29pZCh4LCB5LCB6KSB7CiAgICB0aGlzLl9yYWRpaSA9IHZvaWQgMDsKICAgIHRoaXMuX3JhZGlpU3F1YXJlZCA9IHZvaWQgMDsKICAgIHRoaXMuX3JhZGlpVG9UaGVGb3VydGggPSB2b2lkIDA7CiAgICB0aGlzLl9vbmVPdmVyUmFkaWkgPSB2b2lkIDA7CiAgICB0aGlzLl9vbmVPdmVyUmFkaWlTcXVhcmVkID0gdm9pZCAwOwogICAgdGhpcy5fbWluaW11bVJhZGl1cyA9IHZvaWQgMDsKICAgIHRoaXMuX21heGltdW1SYWRpdXMgPSB2b2lkIDA7CiAgICB0aGlzLl9jZW50ZXJUb2xlcmFuY2VTcXVhcmVkID0gdm9pZCAwOwogICAgdGhpcy5fc3F1YXJlZFhPdmVyU3F1YXJlZFogPSB2b2lkIDA7CiAgICBpbml0aWFsaXplKHRoaXMsIHgsIHksIHopOwogIH0KICBmdW5jdGlvbiBnYXVzc0xlZ2VuZHJlUXVhZHJhdHVyZShhMywgYiwgZnVuYykgewogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJhIiwgYTMpOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJiIiwgYik7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5mdW5jKCJmdW5jIiwgZnVuYyk7CiAgICBjb25zdCB4TWVhbiA9IDAuNSAqIChiICsgYTMpOwogICAgY29uc3QgeFJhbmdlID0gMC41ICogKGIgLSBhMyk7CiAgICBsZXQgc3VtID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNTsgaSsrKSB7CiAgICAgIGNvbnN0IGR4ID0geFJhbmdlICogYWJzY2lzc2FzW2ldOwogICAgICBzdW0gKz0gd2VpZ2h0c1tpXSAqIChmdW5jKHhNZWFuICsgZHgpICsgZnVuYyh4TWVhbiAtIGR4KSk7CiAgICB9CiAgICBzdW0gKj0geFJhbmdlOwogICAgcmV0dXJuIHN1bTsKICB9CiAgdmFyIGNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuTm9ybWFsLCBjYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbkssIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljTjIsIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljUDIsIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljSDIsIHNjcmF0Y2hFbmRwb2ludCwgYWJzY2lzc2FzLCB3ZWlnaHRzLCBFbGxpcHNvaWRfZGVmYXVsdDsKICB2YXIgaW5pdF9FbGxpcHNvaWQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc29pZC5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEVsbGlwc29pZC5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSByYWRpaSBvZiB0aGUgZWxsaXBzb2lkLgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWQucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0NhcnRlc2lhbjN9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgcmFkaWk6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9yYWRpaTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHNxdWFyZWQgcmFkaWkgb2YgdGhlIGVsbGlwc29pZC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDYXJ0ZXNpYW4zfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIHJhZGlpU3F1YXJlZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JhZGlpU3F1YXJlZDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHJhZGlpIG9mIHRoZSBlbGxpcHNvaWQgcmFpc2UgdG8gdGhlIGZvdXJ0aCBwb3dlci4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDYXJ0ZXNpYW4zfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIHJhZGlpVG9UaGVGb3VydGg6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9yYWRpaVRvVGhlRm91cnRoOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyBvbmUgb3ZlciB0aGUgcmFkaWkgb2YgdGhlIGVsbGlwc29pZC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDYXJ0ZXNpYW4zfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIG9uZU92ZXJSYWRpaTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX29uZU92ZXJSYWRpaTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgb25lIG92ZXIgdGhlIHNxdWFyZWQgcmFkaWkgb2YgdGhlIGVsbGlwc29pZC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDYXJ0ZXNpYW4zfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIG9uZU92ZXJSYWRpaVNxdWFyZWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9vbmVPdmVyUmFkaWlTcXVhcmVkOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgbWluaW11bSByYWRpdXMgb2YgdGhlIGVsbGlwc29pZC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgbWluaW11bVJhZGl1czogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX21pbmltdW1SYWRpdXM7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBtYXhpbXVtIHJhZGl1cyBvZiB0aGUgZWxsaXBzb2lkLgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWQucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBtYXhpbXVtUmFkaXVzOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbWF4aW11bVJhZGl1czsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBFbGxpcHNvaWQuY2xvbmUgPSBmdW5jdGlvbihlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGVsbGlwc29pZCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJhZGlpID0gZWxsaXBzb2lkLl9yYWRpaTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEVsbGlwc29pZChyYWRpaS54LCByYWRpaS55LCByYWRpaS56KTsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHJhZGlpLCByZXN1bHQuX3JhZGlpKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkLl9yYWRpaVNxdWFyZWQsIHJlc3VsdC5fcmFkaWlTcXVhcmVkKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkLl9yYWRpaVRvVGhlRm91cnRoLCByZXN1bHQuX3JhZGlpVG9UaGVGb3VydGgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQuX29uZU92ZXJSYWRpaSwgcmVzdWx0Ll9vbmVPdmVyUmFkaWkpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQuX29uZU92ZXJSYWRpaVNxdWFyZWQsIHJlc3VsdC5fb25lT3ZlclJhZGlpU3F1YXJlZCk7CiAgICAgICAgcmVzdWx0Ll9taW5pbXVtUmFkaXVzID0gZWxsaXBzb2lkLl9taW5pbXVtUmFkaXVzOwogICAgICAgIHJlc3VsdC5fbWF4aW11bVJhZGl1cyA9IGVsbGlwc29pZC5fbWF4aW11bVJhZGl1czsKICAgICAgICByZXN1bHQuX2NlbnRlclRvbGVyYW5jZVNxdWFyZWQgPSBlbGxpcHNvaWQuX2NlbnRlclRvbGVyYW5jZVNxdWFyZWQ7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLmZyb21DYXJ0ZXNpYW4zID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBFbGxpcHNvaWQoKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY2FydGVzaWFuMTEpKSB7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBpbml0aWFsaXplKHJlc3VsdCwgY2FydGVzaWFuMTEueCwgY2FydGVzaWFuMTEueSwgY2FydGVzaWFuMTEueik7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLldHUzg0ID0gT2JqZWN0LmZyZWV6ZSgKICAgICAgICBuZXcgRWxsaXBzb2lkKDYzNzgxMzcsIDYzNzgxMzcsIDYzNTY3NTIzMTQyNDUxNzllLTkpCiAgICAgICk7CiAgICAgIEVsbGlwc29pZC5VTklUX1NQSEVSRSA9IE9iamVjdC5mcmVlemUobmV3IEVsbGlwc29pZCgxLCAxLCAxKSk7CiAgICAgIEVsbGlwc29pZC5NT09OID0gT2JqZWN0LmZyZWV6ZSgKICAgICAgICBuZXcgRWxsaXBzb2lkKAogICAgICAgICAgTWF0aF9kZWZhdWx0LkxVTkFSX1JBRElVUywKICAgICAgICAgIE1hdGhfZGVmYXVsdC5MVU5BUl9SQURJVVMsCiAgICAgICAgICBNYXRoX2RlZmF1bHQuTFVOQVJfUkFESVVTCiAgICAgICAgKQogICAgICApOwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIEVsbGlwc29pZC5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBFbGxpcHNvaWQucGFja2VkTGVuZ3RoID0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgRWxsaXBzb2lkLnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZhbHVlLl9yYWRpaSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCByYWRpaSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHJldHVybiBFbGxpcHNvaWQuZnJvbUNhcnRlc2lhbjMocmFkaWksIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUuZ2VvY2VudHJpY1N1cmZhY2VOb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplOwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLmdlb2RldGljU3VyZmFjZU5vcm1hbENhcnRvZ3JhcGhpYyA9IGZ1bmN0aW9uKGNhcnRvZ3JhcGhpYzIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydG9ncmFwaGljIiwgY2FydG9ncmFwaGljMik7CiAgICAgICAgY29uc3QgbG9uZ2l0dWRlID0gY2FydG9ncmFwaGljMi5sb25naXR1ZGU7CiAgICAgICAgY29uc3QgbGF0aXR1ZGUgPSBjYXJ0b2dyYXBoaWMyLmxhdGl0dWRlOwogICAgICAgIGNvbnN0IGNvc0xhdGl0dWRlID0gTWF0aC5jb3MobGF0aXR1ZGUpOwogICAgICAgIGNvbnN0IHggPSBjb3NMYXRpdHVkZSAqIE1hdGguY29zKGxvbmdpdHVkZSk7CiAgICAgICAgY29uc3QgeSA9IGNvc0xhdGl0dWRlICogTWF0aC5zaW4obG9uZ2l0dWRlKTsKICAgICAgICBjb25zdCB6ID0gTWF0aC5zaW4obGF0aXR1ZGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmVzdWx0LCByZXN1bHQpOwogICAgICB9OwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLmdlb2RldGljU3VyZmFjZU5vcm1hbCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBpZiAoaXNOYU4oY2FydGVzaWFuMTEueCkgfHwgaXNOYU4oY2FydGVzaWFuMTEueSkgfHwgaXNOYU4oY2FydGVzaWFuMTEueikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjYXJ0ZXNpYW4gaGFzIGEgTmFOIGNvbXBvbmVudCIpOwogICAgICAgIH0KICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24oY2FydGVzaWFuMTEsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE0KSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlDb21wb25lbnRzKAogICAgICAgICAgY2FydGVzaWFuMTEsCiAgICAgICAgICB0aGlzLl9vbmVPdmVyUmFkaWlTcXVhcmVkLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShyZXN1bHQsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIGNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbksgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4gPSBmdW5jdGlvbihjYXJ0b2dyYXBoaWMyLCByZXN1bHQpIHsKICAgICAgICBjb25zdCBuID0gY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW5Ob3JtYWw7CiAgICAgICAgY29uc3QgayA9IGNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuSzsKICAgICAgICB0aGlzLmdlb2RldGljU3VyZmFjZU5vcm1hbENhcnRvZ3JhcGhpYyhjYXJ0b2dyYXBoaWMyLCBuKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlDb21wb25lbnRzKHRoaXMuX3JhZGlpU3F1YXJlZCwgbiwgayk7CiAgICAgICAgY29uc3QgZ2FtbWEgPSBNYXRoLnNxcnQoQ2FydGVzaWFuM19kZWZhdWx0LmRvdChuLCBrKSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmRpdmlkZUJ5U2NhbGFyKGssIGdhbW1hLCBrKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihuLCBjYXJ0b2dyYXBoaWMyLmhlaWdodCwgbik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChrLCBuLCByZXN1bHQpOwogICAgICB9OwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLmNhcnRvZ3JhcGhpY0FycmF5VG9DYXJ0ZXNpYW5BcnJheSA9IGZ1bmN0aW9uKGNhcnRvZ3JhcGhpY3MsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2FydG9ncmFwaGljcyIsIGNhcnRvZ3JhcGhpY3MpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNhcnRvZ3JhcGhpY3MubGVuZ3RoOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICByZXN1bHRbaV0gPSB0aGlzLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKGNhcnRvZ3JhcGhpY3NbaV0sIHJlc3VsdFtpXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljTjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljUDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljSDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgcCA9IHRoaXMuc2NhbGVUb0dlb2RldGljU3VyZmFjZShjYXJ0ZXNpYW4xMSwgY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWNQMik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG4gPSB0aGlzLmdlb2RldGljU3VyZmFjZU5vcm1hbChwLCBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpY04yKTsKICAgICAgICBjb25zdCBoID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNhcnRlc2lhbjExLCBwLCBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpY0gyKTsKICAgICAgICBjb25zdCBsb25naXR1ZGUgPSBNYXRoLmF0YW4yKG4ueSwgbi54KTsKICAgICAgICBjb25zdCBsYXRpdHVkZSA9IE1hdGguYXNpbihuLnopOwogICAgICAgIGNvbnN0IGhlaWdodCA9IE1hdGhfZGVmYXVsdC5zaWduKENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoaCwgY2FydGVzaWFuMTEpKSAqIENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoaCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdChsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQpOwogICAgICAgIH0KICAgICAgICByZXN1bHQubG9uZ2l0dWRlID0gbG9uZ2l0dWRlOwogICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IGxhdGl0dWRlOwogICAgICAgIHJlc3VsdC5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLnByb3RvdHlwZS5jYXJ0ZXNpYW5BcnJheVRvQ2FydG9ncmFwaGljQXJyYXkgPSBmdW5jdGlvbihjYXJ0ZXNpYW5zLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNhcnRlc2lhbnMiLCBjYXJ0ZXNpYW5zKTsKICAgICAgICBjb25zdCBsZW5ndGggPSBjYXJ0ZXNpYW5zLmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IGxlbmd0aDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgcmVzdWx0W2ldID0gdGhpcy5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhjYXJ0ZXNpYW5zW2ldLCByZXN1bHRbaV0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIHNjYWxlVG9HZW9kZXRpY1N1cmZhY2VfZGVmYXVsdCgKICAgICAgICAgIGNhcnRlc2lhbjExLAogICAgICAgICAgdGhpcy5fb25lT3ZlclJhZGlpLAogICAgICAgICAgdGhpcy5fb25lT3ZlclJhZGlpU3F1YXJlZCwKICAgICAgICAgIHRoaXMuX2NlbnRlclRvbGVyYW5jZVNxdWFyZWQsCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLnNjYWxlVG9HZW9jZW50cmljU3VyZmFjZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBvc2l0aW9uWCA9IGNhcnRlc2lhbjExLng7CiAgICAgICAgY29uc3QgcG9zaXRpb25ZID0gY2FydGVzaWFuMTEueTsKICAgICAgICBjb25zdCBwb3NpdGlvblogPSBjYXJ0ZXNpYW4xMS56OwogICAgICAgIGNvbnN0IG9uZU92ZXJSYWRpaVNxdWFyZWQgPSB0aGlzLl9vbmVPdmVyUmFkaWlTcXVhcmVkOwogICAgICAgIGNvbnN0IGJldGEgPSAxIC8gTWF0aC5zcXJ0KAogICAgICAgICAgcG9zaXRpb25YICogcG9zaXRpb25YICogb25lT3ZlclJhZGlpU3F1YXJlZC54ICsgcG9zaXRpb25ZICogcG9zaXRpb25ZICogb25lT3ZlclJhZGlpU3F1YXJlZC55ICsgcG9zaXRpb25aICogcG9zaXRpb25aICogb25lT3ZlclJhZGlpU3F1YXJlZC56CiAgICAgICAgKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoY2FydGVzaWFuMTEsIGJldGEsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUudHJhbnNmb3JtUG9zaXRpb25Ub1NjYWxlZFNwYWNlID0gZnVuY3Rpb24ocG9zaXRpb24sIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUNvbXBvbmVudHMocG9zaXRpb24sIHRoaXMuX29uZU92ZXJSYWRpaSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLnByb3RvdHlwZS50cmFuc2Zvcm1Qb3NpdGlvbkZyb21TY2FsZWRTcGFjZSA9IGZ1bmN0aW9uKHBvc2l0aW9uLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlDb21wb25lbnRzKHBvc2l0aW9uLCB0aGlzLl9yYWRpaSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiB0aGlzID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQocmlnaHQpICYmIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHModGhpcy5fcmFkaWksIHJpZ2h0Ll9yYWRpaSk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmFkaWkudG9TdHJpbmcoKTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLnByb3RvdHlwZS5nZXRTdXJmYWNlTm9ybWFsSW50ZXJzZWN0aW9uV2l0aFpBeGlzID0gZnVuY3Rpb24ocG9zaXRpb24sIGJ1ZmZlciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJwb3NpdGlvbiIsIHBvc2l0aW9uKTsKICAgICAgICBpZiAoIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy5fcmFkaWkueCwKICAgICAgICAgIHRoaXMuX3JhZGlpLnksCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjE1CiAgICAgICAgKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJFbGxpcHNvaWQgbXVzdCBiZSBhbiBlbGxpcHNvaWQgb2YgcmV2b2x1dGlvbiAocmFkaWkueCA9PSByYWRpaS55KSIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbigiRWxsaXBzb2lkLnJhZGlpLnoiLCB0aGlzLl9yYWRpaS56LCAwKTsKICAgICAgICBidWZmZXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChidWZmZXIsIDApOwogICAgICAgIGNvbnN0IHNxdWFyZWRYT3ZlclNxdWFyZWRaID0gdGhpcy5fc3F1YXJlZFhPdmVyU3F1YXJlZFo7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IDA7CiAgICAgICAgcmVzdWx0LnkgPSAwOwogICAgICAgIHJlc3VsdC56ID0gcG9zaXRpb24ueiAqICgxIC0gc3F1YXJlZFhPdmVyU3F1YXJlZFopOwogICAgICAgIGlmIChNYXRoLmFicyhyZXN1bHQueikgPj0gdGhpcy5fcmFkaWkueiAtIGJ1ZmZlcikgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaEVuZHBvaW50ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLmdldExvY2FsQ3VydmF0dXJlID0gZnVuY3Rpb24oc3VyZmFjZVBvc2l0aW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInN1cmZhY2VQb3NpdGlvbiIsIHN1cmZhY2VQb3NpdGlvbik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBwcmltZVZlcnRpY2FsRW5kcG9pbnQgPSB0aGlzLmdldFN1cmZhY2VOb3JtYWxJbnRlcnNlY3Rpb25XaXRoWkF4aXMoCiAgICAgICAgICBzdXJmYWNlUG9zaXRpb24sCiAgICAgICAgICAwLAogICAgICAgICAgc2NyYXRjaEVuZHBvaW50CiAgICAgICAgKTsKICAgICAgICBjb25zdCBwcmltZVZlcnRpY2FsUmFkaXVzID0gQ2FydGVzaWFuM19kZWZhdWx0LmRpc3RhbmNlKAogICAgICAgICAgc3VyZmFjZVBvc2l0aW9uLAogICAgICAgICAgcHJpbWVWZXJ0aWNhbEVuZHBvaW50CiAgICAgICAgKTsKICAgICAgICBjb25zdCByYWRpdXNSYXRpbyA9IHRoaXMubWluaW11bVJhZGl1cyAqIHByaW1lVmVydGljYWxSYWRpdXMgLyB0aGlzLm1heGltdW1SYWRpdXMgKiogMjsKICAgICAgICBjb25zdCBtZXJpZGlvbmFsUmFkaXVzID0gcHJpbWVWZXJ0aWNhbFJhZGl1cyAqIHJhZGl1c1JhdGlvICoqIDI7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tRWxlbWVudHMoCiAgICAgICAgICAxIC8gcHJpbWVWZXJ0aWNhbFJhZGl1cywKICAgICAgICAgIDEgLyBtZXJpZGlvbmFsUmFkaXVzLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgYWJzY2lzc2FzID0gWwogICAgICAgIDAuMTQ4ODc0MzM4OTgxNjMsCiAgICAgICAgMC40MzMzOTUzOTQxMjkyNSwKICAgICAgICAwLjY3OTQwOTU2ODI5OTAyLAogICAgICAgIDAuODY1MDYzMzY2Njg4OTgsCiAgICAgICAgMC45NzM5MDY1Mjg1MTcxNywKICAgICAgICAwCiAgICAgIF07CiAgICAgIHdlaWdodHMgPSBbCiAgICAgICAgMC4yOTU1MjQyMjQ3MTQ3NSwKICAgICAgICAwLjI2OTI2NjcxOTMwOTk5LAogICAgICAgIDAuMjE5MDg2MzYyNTE1OTgsCiAgICAgICAgMC4xNDk0NTEzNDkxNTA1OCwKICAgICAgICAwLjA2NjY3MTM0NDMwODY4NCwKICAgICAgICAwCiAgICAgIF07CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUuc3VyZmFjZUFyZWEgPSBmdW5jdGlvbihyZWN0YW5nbGUpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgY29uc3QgbWluTG9uZ2l0dWRlID0gcmVjdGFuZ2xlLndlc3Q7CiAgICAgICAgbGV0IG1heExvbmdpdHVkZSA9IHJlY3RhbmdsZS5lYXN0OwogICAgICAgIGNvbnN0IG1pbkxhdGl0dWRlID0gcmVjdGFuZ2xlLnNvdXRoOwogICAgICAgIGNvbnN0IG1heExhdGl0dWRlID0gcmVjdGFuZ2xlLm5vcnRoOwogICAgICAgIHdoaWxlIChtYXhMb25naXR1ZGUgPCBtaW5Mb25naXR1ZGUpIHsKICAgICAgICAgIG1heExvbmdpdHVkZSArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIH0KICAgICAgICBjb25zdCByYWRpaVNxdWFyZWQgPSB0aGlzLl9yYWRpaVNxdWFyZWQ7CiAgICAgICAgY29uc3QgYTIyID0gcmFkaWlTcXVhcmVkLng7CiAgICAgICAgY29uc3QgYjIgPSByYWRpaVNxdWFyZWQueTsKICAgICAgICBjb25zdCBjMiA9IHJhZGlpU3F1YXJlZC56OwogICAgICAgIGNvbnN0IGEyYjIgPSBhMjIgKiBiMjsKICAgICAgICByZXR1cm4gZ2F1c3NMZWdlbmRyZVF1YWRyYXR1cmUobWluTGF0aXR1ZGUsIG1heExhdGl0dWRlLCBmdW5jdGlvbihsYXQpIHsKICAgICAgICAgIGNvbnN0IHNpblBoaSA9IE1hdGguY29zKGxhdCk7CiAgICAgICAgICBjb25zdCBjb3NQaGkgPSBNYXRoLnNpbihsYXQpOwogICAgICAgICAgcmV0dXJuIE1hdGguY29zKGxhdCkgKiBnYXVzc0xlZ2VuZHJlUXVhZHJhdHVyZShtaW5Mb25naXR1ZGUsIG1heExvbmdpdHVkZSwgZnVuY3Rpb24obG9uKSB7CiAgICAgICAgICAgIGNvbnN0IGNvc1RoZXRhID0gTWF0aC5jb3MobG9uKTsKICAgICAgICAgICAgY29uc3Qgc2luVGhldGEgPSBNYXRoLnNpbihsb24pOwogICAgICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KAogICAgICAgICAgICAgIGEyYjIgKiBjb3NQaGkgKiBjb3NQaGkgKyBjMiAqIChiMiAqIGNvc1RoZXRhICogY29zVGhldGEgKyBhMjIgKiBzaW5UaGV0YSAqIHNpblRoZXRhKSAqIHNpblBoaSAqIHNpblBoaQogICAgICAgICAgICApOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZF9kZWZhdWx0ID0gRWxsaXBzb2lkOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvZ3JhcGhpY1Byb2plY3Rpb24uanMKICBmdW5jdGlvbiBHZW9ncmFwaGljUHJvamVjdGlvbihlbGxpcHNvaWQpIHsKICAgIHRoaXMuX2VsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgdGhpcy5fc2VtaW1ham9yQXhpcyA9IHRoaXMuX2VsbGlwc29pZC5tYXhpbXVtUmFkaXVzOwogICAgdGhpcy5fb25lT3ZlclNlbWltYWpvckF4aXMgPSAxIC8gdGhpcy5fc2VtaW1ham9yQXhpczsKICB9CiAgdmFyIEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQ7CiAgdmFyIGluaXRfR2VvZ3JhcGhpY1Byb2plY3Rpb24gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dlb2dyYXBoaWNQcm9qZWN0aW9uLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEdlb2dyYXBoaWNQcm9qZWN0aW9uLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHtAbGluayBFbGxpcHNvaWR9LgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIEdlb2dyYXBoaWNQcm9qZWN0aW9uLnByb3RvdHlwZQogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge0VsbGlwc29pZH0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBlbGxpcHNvaWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbGxpcHNvaWQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgR2VvZ3JhcGhpY1Byb2plY3Rpb24ucHJvdG90eXBlLnByb2plY3QgPSBmdW5jdGlvbihjYXJ0b2dyYXBoaWMyLCByZXN1bHQpIHsKICAgICAgICBjb25zdCBzZW1pbWFqb3JBeGlzID0gdGhpcy5fc2VtaW1ham9yQXhpczsKICAgICAgICBjb25zdCB4ID0gY2FydG9ncmFwaGljMi5sb25naXR1ZGUgKiBzZW1pbWFqb3JBeGlzOwogICAgICAgIGNvbnN0IHkgPSBjYXJ0b2dyYXBoaWMyLmxhdGl0dWRlICogc2VtaW1ham9yQXhpczsKICAgICAgICBjb25zdCB6ID0gY2FydG9ncmFwaGljMi5oZWlnaHQ7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCwgeSwgeik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEdlb2dyYXBoaWNQcm9qZWN0aW9uLnByb3RvdHlwZS51bnByb2plY3QgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY2FydGVzaWFuMTEpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiY2FydGVzaWFuIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG9uZU92ZXJFYXJ0aFNlbWltYWpvckF4aXMgPSB0aGlzLl9vbmVPdmVyU2VtaW1ham9yQXhpczsKICAgICAgICBjb25zdCBsb25naXR1ZGUgPSBjYXJ0ZXNpYW4xMS54ICogb25lT3ZlckVhcnRoU2VtaW1ham9yQXhpczsKICAgICAgICBjb25zdCBsYXRpdHVkZSA9IGNhcnRlc2lhbjExLnkgKiBvbmVPdmVyRWFydGhTZW1pbWFqb3JBeGlzOwogICAgICAgIGNvbnN0IGhlaWdodCA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdChsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQpOwogICAgICAgIH0KICAgICAgICByZXN1bHQubG9uZ2l0dWRlID0gbG9uZ2l0dWRlOwogICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IGxhdGl0dWRlOwogICAgICAgIHJlc3VsdC5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgR2VvZ3JhcGhpY1Byb2plY3Rpb25fZGVmYXVsdCA9IEdlb2dyYXBoaWNQcm9qZWN0aW9uOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSW50ZXJzZWN0LmpzCiAgdmFyIEludGVyc2VjdCwgSW50ZXJzZWN0X2RlZmF1bHQ7CiAgdmFyIGluaXRfSW50ZXJzZWN0ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9JbnRlcnNlY3QuanMiKCkgewogICAgICBJbnRlcnNlY3QgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogUmVwcmVzZW50cyB0aGF0IGFuIG9iamVjdCBpcyBub3QgY29udGFpbmVkIHdpdGhpbiB0aGUgZnJ1c3R1bS4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgT1VUU0lERTogLTEsCiAgICAgICAgLyoqCiAgICAgICAgICogUmVwcmVzZW50cyB0aGF0IGFuIG9iamVjdCBpbnRlcnNlY3RzIG9uZSBvZiB0aGUgZnJ1c3R1bSdzIHBsYW5lcy4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgSU5URVJTRUNUSU5HOiAwLAogICAgICAgIC8qKgogICAgICAgICAqIFJlcHJlc2VudHMgdGhhdCBhbiBvYmplY3QgaXMgZnVsbHkgd2l0aGluIHRoZSBmcnVzdHVtLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBJTlNJREU6IDEKICAgICAgfTsKICAgICAgSW50ZXJzZWN0X2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKEludGVyc2VjdCk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9JbnRlcnZhbC5qcwogIGZ1bmN0aW9uIEludGVydmFsKHN0YXJ0LCBzdG9wKSB7CiAgICB0aGlzLnN0YXJ0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnQsIDApOwogICAgdGhpcy5zdG9wID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RvcCwgMCk7CiAgfQogIHZhciBJbnRlcnZhbF9kZWZhdWx0OwogIHZhciBpbml0X0ludGVydmFsID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9JbnRlcnZhbC5qcyIoKSB7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIEludGVydmFsX2RlZmF1bHQgPSBJbnRlcnZhbDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL01hdHJpeDMuanMKICBmdW5jdGlvbiBNYXRyaXgzKGNvbHVtbjBSb3cwLCBjb2x1bW4xUm93MCwgY29sdW1uMlJvdzAsIGNvbHVtbjBSb3cxLCBjb2x1bW4xUm93MSwgY29sdW1uMlJvdzEsIGNvbHVtbjBSb3cyLCBjb2x1bW4xUm93MiwgY29sdW1uMlJvdzIpIHsKICAgIHRoaXNbMF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4wUm93MCwgMCk7CiAgICB0aGlzWzFdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMFJvdzEsIDApOwogICAgdGhpc1syXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjBSb3cyLCAwKTsKICAgIHRoaXNbM10gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4xUm93MCwgMCk7CiAgICB0aGlzWzRdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMVJvdzEsIDApOwogICAgdGhpc1s1XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjFSb3cyLCAwKTsKICAgIHRoaXNbNl0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4yUm93MCwgMCk7CiAgICB0aGlzWzddID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMlJvdzEsIDApOwogICAgdGhpc1s4XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjJSb3cyLCAwKTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZUZyb2Jlbml1c05vcm0obWF0cml4KSB7CiAgICBsZXQgbm9ybSA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDk7ICsraSkgewogICAgICBjb25zdCB0ZW1wID0gbWF0cml4W2ldOwogICAgICBub3JtICs9IHRlbXAgKiB0ZW1wOwogICAgfQogICAgcmV0dXJuIE1hdGguc3FydChub3JtKTsKICB9CiAgZnVuY3Rpb24gb2ZmRGlhZ29uYWxGcm9iZW5pdXNOb3JtKG1hdHJpeCkgewogICAgbGV0IG5vcm0gPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCAzOyArK2kpIHsKICAgICAgY29uc3QgdGVtcCA9IG1hdHJpeFtNYXRyaXgzLmdldEVsZW1lbnRJbmRleChjb2xWYWxbaV0sIHJvd1ZhbFtpXSldOwogICAgICBub3JtICs9IDIgKiB0ZW1wICogdGVtcDsKICAgIH0KICAgIHJldHVybiBNYXRoLnNxcnQobm9ybSk7CiAgfQogIGZ1bmN0aW9uIHNodXJEZWNvbXBvc2l0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICBjb25zdCB0b2xlcmFuY2UgPSBNYXRoX2RlZmF1bHQuRVBTSUxPTjE1OwogICAgbGV0IG1heERpYWdvbmFsID0gMDsKICAgIGxldCByb3RBeGlzMiA9IDE7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDM7ICsraSkgewogICAgICBjb25zdCB0ZW1wID0gTWF0aC5hYnMoCiAgICAgICAgbWF0cml4W01hdHJpeDMuZ2V0RWxlbWVudEluZGV4KGNvbFZhbFtpXSwgcm93VmFsW2ldKV0KICAgICAgKTsKICAgICAgaWYgKHRlbXAgPiBtYXhEaWFnb25hbCkgewogICAgICAgIHJvdEF4aXMyID0gaTsKICAgICAgICBtYXhEaWFnb25hbCA9IHRlbXA7CiAgICAgIH0KICAgIH0KICAgIGxldCBjID0gMTsKICAgIGxldCBzID0gMDsKICAgIGNvbnN0IHAgPSByb3dWYWxbcm90QXhpczJdOwogICAgY29uc3QgcSA9IGNvbFZhbFtyb3RBeGlzMl07CiAgICBpZiAoTWF0aC5hYnMobWF0cml4W01hdHJpeDMuZ2V0RWxlbWVudEluZGV4KHEsIHApXSkgPiB0b2xlcmFuY2UpIHsKICAgICAgY29uc3QgcXEgPSBtYXRyaXhbTWF0cml4My5nZXRFbGVtZW50SW5kZXgocSwgcSldOwogICAgICBjb25zdCBwcCA9IG1hdHJpeFtNYXRyaXgzLmdldEVsZW1lbnRJbmRleChwLCBwKV07CiAgICAgIGNvbnN0IHFwID0gbWF0cml4W01hdHJpeDMuZ2V0RWxlbWVudEluZGV4KHEsIHApXTsKICAgICAgY29uc3QgdGF1ID0gKHFxIC0gcHApIC8gMiAvIHFwOwogICAgICBsZXQgdDsKICAgICAgaWYgKHRhdSA8IDApIHsKICAgICAgICB0ID0gLTEgLyAoLXRhdSArIE1hdGguc3FydCgxICsgdGF1ICogdGF1KSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdCA9IDEgLyAodGF1ICsgTWF0aC5zcXJ0KDEgKyB0YXUgKiB0YXUpKTsKICAgICAgfQogICAgICBjID0gMSAvIE1hdGguc3FydCgxICsgdCAqIHQpOwogICAgICBzID0gdCAqIGM7CiAgICB9CiAgICByZXN1bHQgPSBNYXRyaXgzLmNsb25lKE1hdHJpeDMuSURFTlRJVFksIHJlc3VsdCk7CiAgICByZXN1bHRbTWF0cml4My5nZXRFbGVtZW50SW5kZXgocCwgcCldID0gcmVzdWx0W01hdHJpeDMuZ2V0RWxlbWVudEluZGV4KHEsIHEpXSA9IGM7CiAgICByZXN1bHRbTWF0cml4My5nZXRFbGVtZW50SW5kZXgocSwgcCldID0gczsKICAgIHJlc3VsdFtNYXRyaXgzLmdldEVsZW1lbnRJbmRleChwLCBxKV0gPSAtczsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHZhciBzY2FsZVNjcmF0Y2gxLCBzY2FsZVNjcmF0Y2gyLCBzY3JhdGNoQ29sdW1uLCBzY2FsZVNjcmF0Y2gzLCBzY2FsZVNjcmF0Y2g0LCBzY2FsZVNjcmF0Y2g1LCByb3dWYWwsIGNvbFZhbCwgak1hdHJpeCwgak1hdHJpeFRyYW5zcG9zZSwgc2NyYXRjaFRyYW5zcG9zZU1hdHJpeCwgTWF0cml4M19kZWZhdWx0OwogIHZhciBpbml0X01hdHJpeDMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL01hdHJpeDMuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgTWF0cml4My5wYWNrZWRMZW5ndGggPSA5OwogICAgICBNYXRyaXgzLnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVswXTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbMV07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzJdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVszXTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbNF07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzVdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVs2XTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbN107CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzhdOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgTWF0cml4My51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IE1hdHJpeDMoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbMV0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsyXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzNdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbNF0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFs1XSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzZdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbN10gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFs4XSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5wYWNrQXJyYXkgPSBmdW5jdGlvbihhcnJheSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgICAgY29uc3QgcmVzdWx0TGVuZ3RoID0gbGVuZ3RoICogOTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkocmVzdWx0TGVuZ3RoKTsKICAgICAgICB9IGVsc2UgaWYgKCFBcnJheS5pc0FycmF5KHJlc3VsdCkgJiYgcmVzdWx0Lmxlbmd0aCAhPT0gcmVzdWx0TGVuZ3RoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIklmIHJlc3VsdCBpcyBhIHR5cGVkIGFycmF5LCBpdCBtdXN0IGhhdmUgZXhhY3RseSBhcnJheS5sZW5ndGggKiA5IGVsZW1lbnRzIgogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKHJlc3VsdC5sZW5ndGggIT09IHJlc3VsdExlbmd0aCkgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IHJlc3VsdExlbmd0aDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgTWF0cml4My5wYWNrKGFycmF5W2ldLCByZXN1bHQsIGkgKiA5KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My51bnBhY2tBcnJheSA9IGZ1bmN0aW9uKGFycmF5LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJhcnJheS5sZW5ndGgiLCBhcnJheS5sZW5ndGgsIDkpOwogICAgICAgIGlmIChhcnJheS5sZW5ndGggJSA5ICE9PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA5LiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEFycmF5KGxlbmd0aCAvIDkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoIC8gOTsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gOSkgewogICAgICAgICAgY29uc3QgaW5kZXggPSBpIC8gOTsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBNYXRyaXgzLnVucGFjayhhcnJheSwgaSwgcmVzdWx0W2luZGV4XSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuY2xvbmUgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG1hdHJpeCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4MygKICAgICAgICAgICAgbWF0cml4WzBdLAogICAgICAgICAgICBtYXRyaXhbM10sCiAgICAgICAgICAgIG1hdHJpeFs2XSwKICAgICAgICAgICAgbWF0cml4WzFdLAogICAgICAgICAgICBtYXRyaXhbNF0sCiAgICAgICAgICAgIG1hdHJpeFs3XSwKICAgICAgICAgICAgbWF0cml4WzJdLAogICAgICAgICAgICBtYXRyaXhbNV0sCiAgICAgICAgICAgIG1hdHJpeFs4XQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXTsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl07CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeFs0XTsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNV07CiAgICAgICAgcmVzdWx0WzZdID0gbWF0cml4WzZdOwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XTsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5mcm9tQXJyYXkgPSBNYXRyaXgzLnVucGFjazsKICAgICAgTWF0cml4My5mcm9tQ29sdW1uTWFqb3JBcnJheSA9IGZ1bmN0aW9uKHZhbHVlcywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2YWx1ZXMiLCB2YWx1ZXMpOwogICAgICAgIHJldHVybiBNYXRyaXgzLmNsb25lKHZhbHVlcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgTWF0cml4My5mcm9tUm93TWFqb3JBcnJheSA9IGZ1bmN0aW9uKHZhbHVlcywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2YWx1ZXMiLCB2YWx1ZXMpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4MygKICAgICAgICAgICAgdmFsdWVzWzBdLAogICAgICAgICAgICB2YWx1ZXNbMV0sCiAgICAgICAgICAgIHZhbHVlc1syXSwKICAgICAgICAgICAgdmFsdWVzWzNdLAogICAgICAgICAgICB2YWx1ZXNbNF0sCiAgICAgICAgICAgIHZhbHVlc1s1XSwKICAgICAgICAgICAgdmFsdWVzWzZdLAogICAgICAgICAgICB2YWx1ZXNbN10sCiAgICAgICAgICAgIHZhbHVlc1s4XQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gdmFsdWVzWzBdOwogICAgICAgIHJlc3VsdFsxXSA9IHZhbHVlc1szXTsKICAgICAgICByZXN1bHRbMl0gPSB2YWx1ZXNbNl07CiAgICAgICAgcmVzdWx0WzNdID0gdmFsdWVzWzFdOwogICAgICAgIHJlc3VsdFs0XSA9IHZhbHVlc1s0XTsKICAgICAgICByZXN1bHRbNV0gPSB2YWx1ZXNbN107CiAgICAgICAgcmVzdWx0WzZdID0gdmFsdWVzWzJdOwogICAgICAgIHJlc3VsdFs3XSA9IHZhbHVlc1s1XTsKICAgICAgICByZXN1bHRbOF0gPSB2YWx1ZXNbOF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5mcm9tUXVhdGVybmlvbiA9IGZ1bmN0aW9uKHF1YXRlcm5pb24sIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicXVhdGVybmlvbiIsIHF1YXRlcm5pb24pOwogICAgICAgIGNvbnN0IHgyID0gcXVhdGVybmlvbi54ICogcXVhdGVybmlvbi54OwogICAgICAgIGNvbnN0IHh5ID0gcXVhdGVybmlvbi54ICogcXVhdGVybmlvbi55OwogICAgICAgIGNvbnN0IHh6ID0gcXVhdGVybmlvbi54ICogcXVhdGVybmlvbi56OwogICAgICAgIGNvbnN0IHh3ID0gcXVhdGVybmlvbi54ICogcXVhdGVybmlvbi53OwogICAgICAgIGNvbnN0IHkyID0gcXVhdGVybmlvbi55ICogcXVhdGVybmlvbi55OwogICAgICAgIGNvbnN0IHl6ID0gcXVhdGVybmlvbi55ICogcXVhdGVybmlvbi56OwogICAgICAgIGNvbnN0IHl3ID0gcXVhdGVybmlvbi55ICogcXVhdGVybmlvbi53OwogICAgICAgIGNvbnN0IHoyID0gcXVhdGVybmlvbi56ICogcXVhdGVybmlvbi56OwogICAgICAgIGNvbnN0IHp3ID0gcXVhdGVybmlvbi56ICogcXVhdGVybmlvbi53OwogICAgICAgIGNvbnN0IHcyID0gcXVhdGVybmlvbi53ICogcXVhdGVybmlvbi53OwogICAgICAgIGNvbnN0IG0wMCA9IHgyIC0geTIgLSB6MiArIHcyOwogICAgICAgIGNvbnN0IG0wMSA9IDIgKiAoeHkgLSB6dyk7CiAgICAgICAgY29uc3QgbTAyID0gMiAqICh4eiArIHl3KTsKICAgICAgICBjb25zdCBtMTAgPSAyICogKHh5ICsgencpOwogICAgICAgIGNvbnN0IG0xMSA9IC14MiArIHkyIC0gejIgKyB3MjsKICAgICAgICBjb25zdCBtMTIgPSAyICogKHl6IC0geHcpOwogICAgICAgIGNvbnN0IG0yMCA9IDIgKiAoeHogLSB5dyk7CiAgICAgICAgY29uc3QgbTIxID0gMiAqICh5eiArIHh3KTsKICAgICAgICBjb25zdCBtMjIgPSAteDIgLSB5MiArIHoyICsgdzI7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBNYXRyaXgzKG0wMCwgbTAxLCBtMDIsIG0xMCwgbTExLCBtMTIsIG0yMCwgbTIxLCBtMjIpOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBtMDA7CiAgICAgICAgcmVzdWx0WzFdID0gbTEwOwogICAgICAgIHJlc3VsdFsyXSA9IG0yMDsKICAgICAgICByZXN1bHRbM10gPSBtMDE7CiAgICAgICAgcmVzdWx0WzRdID0gbTExOwogICAgICAgIHJlc3VsdFs1XSA9IG0yMTsKICAgICAgICByZXN1bHRbNl0gPSBtMDI7CiAgICAgICAgcmVzdWx0WzddID0gbTEyOwogICAgICAgIHJlc3VsdFs4XSA9IG0yMjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLmZyb21IZWFkaW5nUGl0Y2hSb2xsID0gZnVuY3Rpb24oaGVhZGluZ1BpdGNoUm9sbCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJoZWFkaW5nUGl0Y2hSb2xsIiwgaGVhZGluZ1BpdGNoUm9sbCk7CiAgICAgICAgY29uc3QgY29zVGhldGEgPSBNYXRoLmNvcygtaGVhZGluZ1BpdGNoUm9sbC5waXRjaCk7CiAgICAgICAgY29uc3QgY29zUHNpID0gTWF0aC5jb3MoLWhlYWRpbmdQaXRjaFJvbGwuaGVhZGluZyk7CiAgICAgICAgY29uc3QgY29zUGhpID0gTWF0aC5jb3MoaGVhZGluZ1BpdGNoUm9sbC5yb2xsKTsKICAgICAgICBjb25zdCBzaW5UaGV0YSA9IE1hdGguc2luKC1oZWFkaW5nUGl0Y2hSb2xsLnBpdGNoKTsKICAgICAgICBjb25zdCBzaW5Qc2kgPSBNYXRoLnNpbigtaGVhZGluZ1BpdGNoUm9sbC5oZWFkaW5nKTsKICAgICAgICBjb25zdCBzaW5QaGkgPSBNYXRoLnNpbihoZWFkaW5nUGl0Y2hSb2xsLnJvbGwpOwogICAgICAgIGNvbnN0IG0wMCA9IGNvc1RoZXRhICogY29zUHNpOwogICAgICAgIGNvbnN0IG0wMSA9IC1jb3NQaGkgKiBzaW5Qc2kgKyBzaW5QaGkgKiBzaW5UaGV0YSAqIGNvc1BzaTsKICAgICAgICBjb25zdCBtMDIgPSBzaW5QaGkgKiBzaW5Qc2kgKyBjb3NQaGkgKiBzaW5UaGV0YSAqIGNvc1BzaTsKICAgICAgICBjb25zdCBtMTAgPSBjb3NUaGV0YSAqIHNpblBzaTsKICAgICAgICBjb25zdCBtMTEgPSBjb3NQaGkgKiBjb3NQc2kgKyBzaW5QaGkgKiBzaW5UaGV0YSAqIHNpblBzaTsKICAgICAgICBjb25zdCBtMTIgPSAtc2luUGhpICogY29zUHNpICsgY29zUGhpICogc2luVGhldGEgKiBzaW5Qc2k7CiAgICAgICAgY29uc3QgbTIwID0gLXNpblRoZXRhOwogICAgICAgIGNvbnN0IG0yMSA9IHNpblBoaSAqIGNvc1RoZXRhOwogICAgICAgIGNvbnN0IG0yMiA9IGNvc1BoaSAqIGNvc1RoZXRhOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4MyhtMDAsIG0wMSwgbTAyLCBtMTAsIG0xMSwgbTEyLCBtMjAsIG0yMSwgbTIyKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gbTAwOwogICAgICAgIHJlc3VsdFsxXSA9IG0xMDsKICAgICAgICByZXN1bHRbMl0gPSBtMjA7CiAgICAgICAgcmVzdWx0WzNdID0gbTAxOwogICAgICAgIHJlc3VsdFs0XSA9IG0xMTsKICAgICAgICByZXN1bHRbNV0gPSBtMjE7CiAgICAgICAgcmVzdWx0WzZdID0gbTAyOwogICAgICAgIHJlc3VsdFs3XSA9IG0xMjsKICAgICAgICByZXN1bHRbOF0gPSBtMjI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5mcm9tU2NhbGUgPSBmdW5jdGlvbihzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDMoc2NhbGUueCwgMCwgMCwgMCwgc2NhbGUueSwgMCwgMCwgMCwgc2NhbGUueik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICByZXN1bHRbMl0gPSAwOwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gc2NhbGUueTsKICAgICAgICByZXN1bHRbNV0gPSAwOwogICAgICAgIHJlc3VsdFs2XSA9IDA7CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSBzY2FsZS56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuZnJvbVVuaWZvcm1TY2FsZSA9IGZ1bmN0aW9uKHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxlIiwgc2NhbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4MyhzY2FsZSwgMCwgMCwgMCwgc2NhbGUsIDAsIDAsIDAsIHNjYWxlKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gc2NhbGU7CiAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICByZXN1bHRbMl0gPSAwOwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gc2NhbGU7CiAgICAgICAgcmVzdWx0WzVdID0gMDsKICAgICAgICByZXN1bHRbNl0gPSAwOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gc2NhbGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5mcm9tQ3Jvc3NQcm9kdWN0ID0gZnVuY3Rpb24odmVjdG9yLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZlY3RvciIsIHZlY3Rvcik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBNYXRyaXgzKAogICAgICAgICAgICAwLAogICAgICAgICAgICAtdmVjdG9yLnosCiAgICAgICAgICAgIHZlY3Rvci55LAogICAgICAgICAgICB2ZWN0b3IueiwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgLXZlY3Rvci54LAogICAgICAgICAgICAtdmVjdG9yLnksCiAgICAgICAgICAgIHZlY3Rvci54LAogICAgICAgICAgICAwCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSAwOwogICAgICAgIHJlc3VsdFsxXSA9IHZlY3Rvci56OwogICAgICAgIHJlc3VsdFsyXSA9IC12ZWN0b3IueTsKICAgICAgICByZXN1bHRbM10gPSAtdmVjdG9yLno7CiAgICAgICAgcmVzdWx0WzRdID0gMDsKICAgICAgICByZXN1bHRbNV0gPSB2ZWN0b3IueDsKICAgICAgICByZXN1bHRbNl0gPSB2ZWN0b3IueTsKICAgICAgICByZXN1bHRbN10gPSAtdmVjdG9yLng7CiAgICAgICAgcmVzdWx0WzhdID0gMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLmZyb21Sb3RhdGlvblggPSBmdW5jdGlvbihhbmdsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJhbmdsZSIsIGFuZ2xlKTsKICAgICAgICBjb25zdCBjb3NBbmdsZSA9IE1hdGguY29zKGFuZ2xlKTsKICAgICAgICBjb25zdCBzaW5BbmdsZSA9IE1hdGguc2luKGFuZ2xlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDMoCiAgICAgICAgICAgIDEsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIGNvc0FuZ2xlLAogICAgICAgICAgICAtc2luQW5nbGUsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIHNpbkFuZ2xlLAogICAgICAgICAgICBjb3NBbmdsZQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gMTsKICAgICAgICByZXN1bHRbMV0gPSAwOwogICAgICAgIHJlc3VsdFsyXSA9IDA7CiAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICByZXN1bHRbNF0gPSBjb3NBbmdsZTsKICAgICAgICByZXN1bHRbNV0gPSBzaW5BbmdsZTsKICAgICAgICByZXN1bHRbNl0gPSAwOwogICAgICAgIHJlc3VsdFs3XSA9IC1zaW5BbmdsZTsKICAgICAgICByZXN1bHRbOF0gPSBjb3NBbmdsZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLmZyb21Sb3RhdGlvblkgPSBmdW5jdGlvbihhbmdsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJhbmdsZSIsIGFuZ2xlKTsKICAgICAgICBjb25zdCBjb3NBbmdsZSA9IE1hdGguY29zKGFuZ2xlKTsKICAgICAgICBjb25zdCBzaW5BbmdsZSA9IE1hdGguc2luKGFuZ2xlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDMoCiAgICAgICAgICAgIGNvc0FuZ2xlLAogICAgICAgICAgICAwLAogICAgICAgICAgICBzaW5BbmdsZSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgLXNpbkFuZ2xlLAogICAgICAgICAgICAwLAogICAgICAgICAgICBjb3NBbmdsZQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gY29zQW5nbGU7CiAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICByZXN1bHRbMl0gPSAtc2luQW5nbGU7CiAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICByZXN1bHRbNF0gPSAxOwogICAgICAgIHJlc3VsdFs1XSA9IDA7CiAgICAgICAgcmVzdWx0WzZdID0gc2luQW5nbGU7CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSBjb3NBbmdsZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLmZyb21Sb3RhdGlvblogPSBmdW5jdGlvbihhbmdsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJhbmdsZSIsIGFuZ2xlKTsKICAgICAgICBjb25zdCBjb3NBbmdsZSA9IE1hdGguY29zKGFuZ2xlKTsKICAgICAgICBjb25zdCBzaW5BbmdsZSA9IE1hdGguc2luKGFuZ2xlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDMoCiAgICAgICAgICAgIGNvc0FuZ2xlLAogICAgICAgICAgICAtc2luQW5nbGUsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIHNpbkFuZ2xlLAogICAgICAgICAgICBjb3NBbmdsZSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gY29zQW5nbGU7CiAgICAgICAgcmVzdWx0WzFdID0gc2luQW5nbGU7CiAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICByZXN1bHRbM10gPSAtc2luQW5nbGU7CiAgICAgICAgcmVzdWx0WzRdID0gY29zQW5nbGU7CiAgICAgICAgcmVzdWx0WzVdID0gMDsKICAgICAgICByZXN1bHRbNl0gPSAwOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gMTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLnRvQXJyYXkgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICBtYXRyaXhbMF0sCiAgICAgICAgICAgIG1hdHJpeFsxXSwKICAgICAgICAgICAgbWF0cml4WzJdLAogICAgICAgICAgICBtYXRyaXhbM10sCiAgICAgICAgICAgIG1hdHJpeFs0XSwKICAgICAgICAgICAgbWF0cml4WzVdLAogICAgICAgICAgICBtYXRyaXhbNl0sCiAgICAgICAgICAgIG1hdHJpeFs3XSwKICAgICAgICAgICAgbWF0cml4WzhdCiAgICAgICAgICBdOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM107CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzRdOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbNl07CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzddOwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFs4XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLmdldEVsZW1lbnRJbmRleCA9IGZ1bmN0aW9uKGNvbHVtbiwgcm93KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoInJvdyIsIHJvdywgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoInJvdyIsIHJvdywgMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImNvbHVtbiIsIGNvbHVtbiwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoImNvbHVtbiIsIGNvbHVtbiwgMik7CiAgICAgICAgcmV0dXJuIGNvbHVtbiAqIDMgKyByb3c7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuZ2V0Q29sdW1uID0gZnVuY3Rpb24obWF0cml4LCBpbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHN0YXJ0SW5kZXggPSBpbmRleCAqIDM7CiAgICAgICAgY29uc3QgeCA9IG1hdHJpeFtzdGFydEluZGV4XTsKICAgICAgICBjb25zdCB5ID0gbWF0cml4W3N0YXJ0SW5kZXggKyAxXTsKICAgICAgICBjb25zdCB6ID0gbWF0cml4W3N0YXJ0SW5kZXggKyAyXTsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLnNldENvbHVtbiA9IGZ1bmN0aW9uKG1hdHJpeCwgaW5kZXgsIGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0ID0gTWF0cml4My5jbG9uZShtYXRyaXgsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc3RhcnRJbmRleCA9IGluZGV4ICogMzsKICAgICAgICByZXN1bHRbc3RhcnRJbmRleF0gPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdFtzdGFydEluZGV4ICsgMV0gPSBjYXJ0ZXNpYW4xMS55OwogICAgICAgIHJlc3VsdFtzdGFydEluZGV4ICsgMl0gPSBjYXJ0ZXNpYW4xMS56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuZ2V0Um93ID0gZnVuY3Rpb24obWF0cml4LCBpbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHggPSBtYXRyaXhbaW5kZXhdOwogICAgICAgIGNvbnN0IHkgPSBtYXRyaXhbaW5kZXggKyAzXTsKICAgICAgICBjb25zdCB6ID0gbWF0cml4W2luZGV4ICsgNl07CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5zZXRSb3cgPSBmdW5jdGlvbihtYXRyaXgsIGluZGV4LCBjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdCA9IE1hdHJpeDMuY2xvbmUobWF0cml4LCByZXN1bHQpOwogICAgICAgIHJlc3VsdFtpbmRleF0gPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdFtpbmRleCArIDNdID0gY2FydGVzaWFuMTEueTsKICAgICAgICByZXN1bHRbaW5kZXggKyA2XSA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NhbGVTY3JhdGNoMSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgTWF0cml4My5zZXRTY2FsZSA9IGZ1bmN0aW9uKG1hdHJpeCwgc2NhbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNjYWxlIiwgc2NhbGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBleGlzdGluZ1NjYWxlID0gTWF0cml4My5nZXRTY2FsZShtYXRyaXgsIHNjYWxlU2NyYXRjaDEpOwogICAgICAgIGNvbnN0IHNjYWxlUmF0aW9YID0gc2NhbGUueCAvIGV4aXN0aW5nU2NhbGUueDsKICAgICAgICBjb25zdCBzY2FsZVJhdGlvWSA9IHNjYWxlLnkgLyBleGlzdGluZ1NjYWxlLnk7CiAgICAgICAgY29uc3Qgc2NhbGVSYXRpb1ogPSBzY2FsZS56IC8gZXhpc3RpbmdTY2FsZS56OwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeFs0XSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs2XSAqIHNjYWxlUmF0aW9aOwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XSAqIHNjYWxlUmF0aW9aOwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFs4XSAqIHNjYWxlUmF0aW9aOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDMuc2V0VW5pZm9ybVNjYWxlID0gZnVuY3Rpb24obWF0cml4LCBzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGUiLCBzY2FsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IGV4aXN0aW5nU2NhbGUgPSBNYXRyaXgzLmdldFNjYWxlKG1hdHJpeCwgc2NhbGVTY3JhdGNoMik7CiAgICAgICAgY29uc3Qgc2NhbGVSYXRpb1ggPSBzY2FsZSAvIGV4aXN0aW5nU2NhbGUueDsKICAgICAgICBjb25zdCBzY2FsZVJhdGlvWSA9IHNjYWxlIC8gZXhpc3RpbmdTY2FsZS55OwogICAgICAgIGNvbnN0IHNjYWxlUmF0aW9aID0gc2NhbGUgLyBleGlzdGluZ1NjYWxlLno7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdICogc2NhbGVSYXRpb1k7CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzRdICogc2NhbGVSYXRpb1k7CiAgICAgICAgcmVzdWx0WzVdID0gbWF0cml4WzVdICogc2NhbGVSYXRpb1k7CiAgICAgICAgcmVzdWx0WzZdID0gbWF0cml4WzZdICogc2NhbGVSYXRpb1o7CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzddICogc2NhbGVSYXRpb1o7CiAgICAgICAgcmVzdWx0WzhdID0gbWF0cml4WzhdICogc2NhbGVSYXRpb1o7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaENvbHVtbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgTWF0cml4My5nZXRTY2FsZSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUVsZW1lbnRzKG1hdHJpeFswXSwgbWF0cml4WzFdLCBtYXRyaXhbMl0sIHNjcmF0Y2hDb2x1bW4pCiAgICAgICAgKTsKICAgICAgICByZXN1bHQueSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUVsZW1lbnRzKG1hdHJpeFszXSwgbWF0cml4WzRdLCBtYXRyaXhbNV0sIHNjcmF0Y2hDb2x1bW4pCiAgICAgICAgKTsKICAgICAgICByZXN1bHQueiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUVsZW1lbnRzKG1hdHJpeFs2XSwgbWF0cml4WzddLCBtYXRyaXhbOF0sIHNjcmF0Y2hDb2x1bW4pCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY2FsZVNjcmF0Y2gzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBNYXRyaXgzLmdldE1heGltdW1TY2FsZSA9IGZ1bmN0aW9uKG1hdHJpeCkgewogICAgICAgIE1hdHJpeDMuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2gzKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0Lm1heGltdW1Db21wb25lbnQoc2NhbGVTY3JhdGNoMyk7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDMuc2V0Um90YXRpb24gPSBmdW5jdGlvbihtYXRyaXgsIHJvdGF0aW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHNjYWxlID0gTWF0cml4My5nZXRTY2FsZShtYXRyaXgsIHNjYWxlU2NyYXRjaDQpOwogICAgICAgIHJlc3VsdFswXSA9IHJvdGF0aW9uWzBdICogc2NhbGUueDsKICAgICAgICByZXN1bHRbMV0gPSByb3RhdGlvblsxXSAqIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzJdID0gcm90YXRpb25bMl0gKiBzY2FsZS54OwogICAgICAgIHJlc3VsdFszXSA9IHJvdGF0aW9uWzNdICogc2NhbGUueTsKICAgICAgICByZXN1bHRbNF0gPSByb3RhdGlvbls0XSAqIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzVdID0gcm90YXRpb25bNV0gKiBzY2FsZS55OwogICAgICAgIHJlc3VsdFs2XSA9IHJvdGF0aW9uWzZdICogc2NhbGUuejsKICAgICAgICByZXN1bHRbN10gPSByb3RhdGlvbls3XSAqIHNjYWxlLno7CiAgICAgICAgcmVzdWx0WzhdID0gcm90YXRpb25bOF0gKiBzY2FsZS56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDMuZ2V0Um90YXRpb24gPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc2NhbGUgPSBNYXRyaXgzLmdldFNjYWxlKG1hdHJpeCwgc2NhbGVTY3JhdGNoNSk7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdIC8gc2NhbGUueDsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gLyBzY2FsZS54OwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXSAvIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdIC8gc2NhbGUueTsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXhbNF0gLyBzY2FsZS55OwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XSAvIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzZdID0gbWF0cml4WzZdIC8gc2NhbGUuejsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbN10gLyBzY2FsZS56OwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFs4XSAvIHNjYWxlLno7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5tdWx0aXBseSA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MCA9IGxlZnRbMF0gKiByaWdodFswXSArIGxlZnRbM10gKiByaWdodFsxXSArIGxlZnRbNl0gKiByaWdodFsyXTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MSA9IGxlZnRbMV0gKiByaWdodFswXSArIGxlZnRbNF0gKiByaWdodFsxXSArIGxlZnRbN10gKiByaWdodFsyXTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MiA9IGxlZnRbMl0gKiByaWdodFswXSArIGxlZnRbNV0gKiByaWdodFsxXSArIGxlZnRbOF0gKiByaWdodFsyXTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MCA9IGxlZnRbMF0gKiByaWdodFszXSArIGxlZnRbM10gKiByaWdodFs0XSArIGxlZnRbNl0gKiByaWdodFs1XTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MSA9IGxlZnRbMV0gKiByaWdodFszXSArIGxlZnRbNF0gKiByaWdodFs0XSArIGxlZnRbN10gKiByaWdodFs1XTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MiA9IGxlZnRbMl0gKiByaWdodFszXSArIGxlZnRbNV0gKiByaWdodFs0XSArIGxlZnRbOF0gKiByaWdodFs1XTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MCA9IGxlZnRbMF0gKiByaWdodFs2XSArIGxlZnRbM10gKiByaWdodFs3XSArIGxlZnRbNl0gKiByaWdodFs4XTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MSA9IGxlZnRbMV0gKiByaWdodFs2XSArIGxlZnRbNF0gKiByaWdodFs3XSArIGxlZnRbN10gKiByaWdodFs4XTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MiA9IGxlZnRbMl0gKiByaWdodFs2XSArIGxlZnRbNV0gKiByaWdodFs3XSArIGxlZnRbOF0gKiByaWdodFs4XTsKICAgICAgICByZXN1bHRbMF0gPSBjb2x1bW4wUm93MDsKICAgICAgICByZXN1bHRbMV0gPSBjb2x1bW4wUm93MTsKICAgICAgICByZXN1bHRbMl0gPSBjb2x1bW4wUm93MjsKICAgICAgICByZXN1bHRbM10gPSBjb2x1bW4xUm93MDsKICAgICAgICByZXN1bHRbNF0gPSBjb2x1bW4xUm93MTsKICAgICAgICByZXN1bHRbNV0gPSBjb2x1bW4xUm93MjsKICAgICAgICByZXN1bHRbNl0gPSBjb2x1bW4yUm93MDsKICAgICAgICByZXN1bHRbN10gPSBjb2x1bW4yUm93MTsKICAgICAgICByZXN1bHRbOF0gPSBjb2x1bW4yUm93MjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLmFkZCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbMF0gPSBsZWZ0WzBdICsgcmlnaHRbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbGVmdFsxXSArIHJpZ2h0WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IGxlZnRbMl0gKyByaWdodFsyXTsKICAgICAgICByZXN1bHRbM10gPSBsZWZ0WzNdICsgcmlnaHRbM107CiAgICAgICAgcmVzdWx0WzRdID0gbGVmdFs0XSArIHJpZ2h0WzRdOwogICAgICAgIHJlc3VsdFs1XSA9IGxlZnRbNV0gKyByaWdodFs1XTsKICAgICAgICByZXN1bHRbNl0gPSBsZWZ0WzZdICsgcmlnaHRbNl07CiAgICAgICAgcmVzdWx0WzddID0gbGVmdFs3XSArIHJpZ2h0WzddOwogICAgICAgIHJlc3VsdFs4XSA9IGxlZnRbOF0gKyByaWdodFs4XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLnN1YnRyYWN0ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IGxlZnRbMF0gLSByaWdodFswXTsKICAgICAgICByZXN1bHRbMV0gPSBsZWZ0WzFdIC0gcmlnaHRbMV07CiAgICAgICAgcmVzdWx0WzJdID0gbGVmdFsyXSAtIHJpZ2h0WzJdOwogICAgICAgIHJlc3VsdFszXSA9IGxlZnRbM10gLSByaWdodFszXTsKICAgICAgICByZXN1bHRbNF0gPSBsZWZ0WzRdIC0gcmlnaHRbNF07CiAgICAgICAgcmVzdWx0WzVdID0gbGVmdFs1XSAtIHJpZ2h0WzVdOwogICAgICAgIHJlc3VsdFs2XSA9IGxlZnRbNl0gLSByaWdodFs2XTsKICAgICAgICByZXN1bHRbN10gPSBsZWZ0WzddIC0gcmlnaHRbN107CiAgICAgICAgcmVzdWx0WzhdID0gbGVmdFs4XSAtIHJpZ2h0WzhdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMubXVsdGlwbHlCeVZlY3RvciA9IGZ1bmN0aW9uKG1hdHJpeCwgY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgdlggPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIGNvbnN0IHZZID0gY2FydGVzaWFuMTEueTsKICAgICAgICBjb25zdCB2WiA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgY29uc3QgeCA9IG1hdHJpeFswXSAqIHZYICsgbWF0cml4WzNdICogdlkgKyBtYXRyaXhbNl0gKiB2WjsKICAgICAgICBjb25zdCB5ID0gbWF0cml4WzFdICogdlggKyBtYXRyaXhbNF0gKiB2WSArIG1hdHJpeFs3XSAqIHZaOwogICAgICAgIGNvbnN0IHogPSBtYXRyaXhbMl0gKiB2WCArIG1hdHJpeFs1XSAqIHZZICsgbWF0cml4WzhdICogdlo7CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5tdWx0aXBseUJ5U2NhbGFyID0gZnVuY3Rpb24obWF0cml4LCBzY2FsYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxhciIsIHNjYWxhcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXhbNF0gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzVdID0gbWF0cml4WzVdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs2XSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbN10gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzhdID0gbWF0cml4WzhdICogc2NhbGFyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMubXVsdGlwbHlCeVNjYWxlID0gZnVuY3Rpb24obWF0cml4LCBzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic2NhbGUiLCBzY2FsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAqIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdICogc2NhbGUueDsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl0gKiBzY2FsZS54OwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXSAqIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzRdICogc2NhbGUueTsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNV0gKiBzY2FsZS55OwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs2XSAqIHNjYWxlLno7CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzddICogc2NhbGUuejsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF0gKiBzY2FsZS56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMubXVsdGlwbHlCeVVuaWZvcm1TY2FsZSA9IGZ1bmN0aW9uKG1hdHJpeCwgc2NhbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxlIiwgc2NhbGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM10gKiBzY2FsZTsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXhbNF0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNV0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbNl0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbN10gKiBzY2FsZTsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF0gKiBzY2FsZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLm5lZ2F0ZSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbMF0gPSAtbWF0cml4WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IC1tYXRyaXhbMV07CiAgICAgICAgcmVzdWx0WzJdID0gLW1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSAtbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IC1tYXRyaXhbNF07CiAgICAgICAgcmVzdWx0WzVdID0gLW1hdHJpeFs1XTsKICAgICAgICByZXN1bHRbNl0gPSAtbWF0cml4WzZdOwogICAgICAgIHJlc3VsdFs3XSA9IC1tYXRyaXhbN107CiAgICAgICAgcmVzdWx0WzhdID0gLW1hdHJpeFs4XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLnRyYW5zcG9zZSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MCA9IG1hdHJpeFswXTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MSA9IG1hdHJpeFszXTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MiA9IG1hdHJpeFs2XTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MCA9IG1hdHJpeFsxXTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MSA9IG1hdHJpeFs0XTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MiA9IG1hdHJpeFs3XTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MCA9IG1hdHJpeFsyXTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MSA9IG1hdHJpeFs1XTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MiA9IG1hdHJpeFs4XTsKICAgICAgICByZXN1bHRbMF0gPSBjb2x1bW4wUm93MDsKICAgICAgICByZXN1bHRbMV0gPSBjb2x1bW4wUm93MTsKICAgICAgICByZXN1bHRbMl0gPSBjb2x1bW4wUm93MjsKICAgICAgICByZXN1bHRbM10gPSBjb2x1bW4xUm93MDsKICAgICAgICByZXN1bHRbNF0gPSBjb2x1bW4xUm93MTsKICAgICAgICByZXN1bHRbNV0gPSBjb2x1bW4xUm93MjsKICAgICAgICByZXN1bHRbNl0gPSBjb2x1bW4yUm93MDsKICAgICAgICByZXN1bHRbN10gPSBjb2x1bW4yUm93MTsKICAgICAgICByZXN1bHRbOF0gPSBjb2x1bW4yUm93MjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICByb3dWYWwgPSBbMSwgMCwgMF07CiAgICAgIGNvbFZhbCA9IFsyLCAyLCAxXTsKICAgICAgak1hdHJpeCA9IG5ldyBNYXRyaXgzKCk7CiAgICAgIGpNYXRyaXhUcmFuc3Bvc2UgPSBuZXcgTWF0cml4MygpOwogICAgICBNYXRyaXgzLmNvbXB1dGVFaWdlbkRlY29tcG9zaXRpb24gPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBjb25zdCB0b2xlcmFuY2UgPSBNYXRoX2RlZmF1bHQuRVBTSUxPTjIwOwogICAgICAgIGNvbnN0IG1heFN3ZWVwcyA9IDEwOwogICAgICAgIGxldCBjb3VudCA9IDA7CiAgICAgICAgbGV0IHN3ZWVwID0gMDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSB7fTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdW5pdGFyeU1hdHJpeCA9IHJlc3VsdC51bml0YXJ5ID0gTWF0cml4My5jbG9uZSgKICAgICAgICAgIE1hdHJpeDMuSURFTlRJVFksCiAgICAgICAgICByZXN1bHQudW5pdGFyeQogICAgICAgICk7CiAgICAgICAgY29uc3QgZGlhZ01hdHJpeCA9IHJlc3VsdC5kaWFnb25hbCA9IE1hdHJpeDMuY2xvbmUobWF0cml4LCByZXN1bHQuZGlhZ29uYWwpOwogICAgICAgIGNvbnN0IGVwc2lsb24gPSB0b2xlcmFuY2UgKiBjb21wdXRlRnJvYmVuaXVzTm9ybShkaWFnTWF0cml4KTsKICAgICAgICB3aGlsZSAoc3dlZXAgPCBtYXhTd2VlcHMgJiYgb2ZmRGlhZ29uYWxGcm9iZW5pdXNOb3JtKGRpYWdNYXRyaXgpID4gZXBzaWxvbikgewogICAgICAgICAgc2h1ckRlY29tcG9zaXRpb24oZGlhZ01hdHJpeCwgak1hdHJpeCk7CiAgICAgICAgICBNYXRyaXgzLnRyYW5zcG9zZShqTWF0cml4LCBqTWF0cml4VHJhbnNwb3NlKTsKICAgICAgICAgIE1hdHJpeDMubXVsdGlwbHkoZGlhZ01hdHJpeCwgak1hdHJpeCwgZGlhZ01hdHJpeCk7CiAgICAgICAgICBNYXRyaXgzLm11bHRpcGx5KGpNYXRyaXhUcmFuc3Bvc2UsIGRpYWdNYXRyaXgsIGRpYWdNYXRyaXgpOwogICAgICAgICAgTWF0cml4My5tdWx0aXBseSh1bml0YXJ5TWF0cml4LCBqTWF0cml4LCB1bml0YXJ5TWF0cml4KTsKICAgICAgICAgIGlmICgrK2NvdW50ID4gMikgewogICAgICAgICAgICArK3N3ZWVwOwogICAgICAgICAgICBjb3VudCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuYWJzID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IE1hdGguYWJzKG1hdHJpeFswXSk7CiAgICAgICAgcmVzdWx0WzFdID0gTWF0aC5hYnMobWF0cml4WzFdKTsKICAgICAgICByZXN1bHRbMl0gPSBNYXRoLmFicyhtYXRyaXhbMl0pOwogICAgICAgIHJlc3VsdFszXSA9IE1hdGguYWJzKG1hdHJpeFszXSk7CiAgICAgICAgcmVzdWx0WzRdID0gTWF0aC5hYnMobWF0cml4WzRdKTsKICAgICAgICByZXN1bHRbNV0gPSBNYXRoLmFicyhtYXRyaXhbNV0pOwogICAgICAgIHJlc3VsdFs2XSA9IE1hdGguYWJzKG1hdHJpeFs2XSk7CiAgICAgICAgcmVzdWx0WzddID0gTWF0aC5hYnMobWF0cml4WzddKTsKICAgICAgICByZXN1bHRbOF0gPSBNYXRoLmFicyhtYXRyaXhbOF0pOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuZGV0ZXJtaW5hbnQgPSBmdW5jdGlvbihtYXRyaXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgY29uc3QgbTExID0gbWF0cml4WzBdOwogICAgICAgIGNvbnN0IG0yMSA9IG1hdHJpeFszXTsKICAgICAgICBjb25zdCBtMzEgPSBtYXRyaXhbNl07CiAgICAgICAgY29uc3QgbTEyID0gbWF0cml4WzFdOwogICAgICAgIGNvbnN0IG0yMiA9IG1hdHJpeFs0XTsKICAgICAgICBjb25zdCBtMzIgPSBtYXRyaXhbN107CiAgICAgICAgY29uc3QgbTEzID0gbWF0cml4WzJdOwogICAgICAgIGNvbnN0IG0yMyA9IG1hdHJpeFs1XTsKICAgICAgICBjb25zdCBtMzMgPSBtYXRyaXhbOF07CiAgICAgICAgcmV0dXJuIG0xMSAqIChtMjIgKiBtMzMgLSBtMjMgKiBtMzIpICsgbTEyICogKG0yMyAqIG0zMSAtIG0yMSAqIG0zMykgKyBtMTMgKiAobTIxICogbTMyIC0gbTIyICogbTMxKTsKICAgICAgfTsKICAgICAgTWF0cml4My5pbnZlcnNlID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IG0xMSA9IG1hdHJpeFswXTsKICAgICAgICBjb25zdCBtMjEgPSBtYXRyaXhbMV07CiAgICAgICAgY29uc3QgbTMxID0gbWF0cml4WzJdOwogICAgICAgIGNvbnN0IG0xMiA9IG1hdHJpeFszXTsKICAgICAgICBjb25zdCBtMjIgPSBtYXRyaXhbNF07CiAgICAgICAgY29uc3QgbTMyID0gbWF0cml4WzVdOwogICAgICAgIGNvbnN0IG0xMyA9IG1hdHJpeFs2XTsKICAgICAgICBjb25zdCBtMjMgPSBtYXRyaXhbN107CiAgICAgICAgY29uc3QgbTMzID0gbWF0cml4WzhdOwogICAgICAgIGNvbnN0IGRldGVybWluYW50ID0gTWF0cml4My5kZXRlcm1pbmFudChtYXRyaXgpOwogICAgICAgIGlmIChNYXRoLmFicyhkZXRlcm1pbmFudCkgPD0gTWF0aF9kZWZhdWx0LkVQU0lMT04xNSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm1hdHJpeCBpcyBub3QgaW52ZXJ0aWJsZSIpOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBtMjIgKiBtMzMgLSBtMjMgKiBtMzI7CiAgICAgICAgcmVzdWx0WzFdID0gbTIzICogbTMxIC0gbTIxICogbTMzOwogICAgICAgIHJlc3VsdFsyXSA9IG0yMSAqIG0zMiAtIG0yMiAqIG0zMTsKICAgICAgICByZXN1bHRbM10gPSBtMTMgKiBtMzIgLSBtMTIgKiBtMzM7CiAgICAgICAgcmVzdWx0WzRdID0gbTExICogbTMzIC0gbTEzICogbTMxOwogICAgICAgIHJlc3VsdFs1XSA9IG0xMiAqIG0zMSAtIG0xMSAqIG0zMjsKICAgICAgICByZXN1bHRbNl0gPSBtMTIgKiBtMjMgLSBtMTMgKiBtMjI7CiAgICAgICAgcmVzdWx0WzddID0gbTEzICogbTIxIC0gbTExICogbTIzOwogICAgICAgIHJlc3VsdFs4XSA9IG0xMSAqIG0yMiAtIG0xMiAqIG0yMTsKICAgICAgICBjb25zdCBzY2FsZSA9IDEgLyBkZXRlcm1pbmFudDsKICAgICAgICByZXR1cm4gTWF0cml4My5tdWx0aXBseUJ5U2NhbGFyKHJlc3VsdCwgc2NhbGUsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hUcmFuc3Bvc2VNYXRyaXggPSBuZXcgTWF0cml4MygpOwogICAgICBNYXRyaXgzLmludmVyc2VUcmFuc3Bvc2UgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIE1hdHJpeDMuaW52ZXJzZSgKICAgICAgICAgIE1hdHJpeDMudHJhbnNwb3NlKG1hdHJpeCwgc2NyYXRjaFRyYW5zcG9zZU1hdHJpeCksCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBNYXRyaXgzLmVxdWFscyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIGxlZnQgPT09IHJpZ2h0IHx8IGRlZmluZWRfZGVmYXVsdChsZWZ0KSAmJiBkZWZpbmVkX2RlZmF1bHQocmlnaHQpICYmIGxlZnRbMF0gPT09IHJpZ2h0WzBdICYmIGxlZnRbMV0gPT09IHJpZ2h0WzFdICYmIGxlZnRbMl0gPT09IHJpZ2h0WzJdICYmIGxlZnRbM10gPT09IHJpZ2h0WzNdICYmIGxlZnRbNF0gPT09IHJpZ2h0WzRdICYmIGxlZnRbNV0gPT09IHJpZ2h0WzVdICYmIGxlZnRbNl0gPT09IHJpZ2h0WzZdICYmIGxlZnRbN10gPT09IHJpZ2h0WzddICYmIGxlZnRbOF0gPT09IHJpZ2h0WzhdOwogICAgICB9OwogICAgICBNYXRyaXgzLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgZXBzaWxvbikgewogICAgICAgIGVwc2lsb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlcHNpbG9uLCAwKTsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgTWF0aC5hYnMobGVmdFswXSAtIHJpZ2h0WzBdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMV0gLSByaWdodFsxXSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzJdIC0gcmlnaHRbMl0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFszXSAtIHJpZ2h0WzNdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbNF0gLSByaWdodFs0XSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzVdIC0gcmlnaHRbNV0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFs2XSAtIHJpZ2h0WzZdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbN10gLSByaWdodFs3XSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzhdIC0gcmlnaHRbOF0pIDw9IGVwc2lsb247CiAgICAgIH07CiAgICAgIE1hdHJpeDMuSURFTlRJVFkgPSBPYmplY3QuZnJlZXplKAogICAgICAgIG5ldyBNYXRyaXgzKDEsIDAsIDAsIDAsIDEsIDAsIDAsIDAsIDEpCiAgICAgICk7CiAgICAgIE1hdHJpeDMuWkVSTyA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IE1hdHJpeDMoMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCkKICAgICAgKTsKICAgICAgTWF0cml4My5DT0xVTU4wUk9XMCA9IDA7CiAgICAgIE1hdHJpeDMuQ09MVU1OMFJPVzEgPSAxOwogICAgICBNYXRyaXgzLkNPTFVNTjBST1cyID0gMjsKICAgICAgTWF0cml4My5DT0xVTU4xUk9XMCA9IDM7CiAgICAgIE1hdHJpeDMuQ09MVU1OMVJPVzEgPSA0OwogICAgICBNYXRyaXgzLkNPTFVNTjFST1cyID0gNTsKICAgICAgTWF0cml4My5DT0xVTU4yUk9XMCA9IDY7CiAgICAgIE1hdHJpeDMuQ09MVU1OMlJPVzEgPSA3OwogICAgICBNYXRyaXgzLkNPTFVNTjJST1cyID0gODsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoTWF0cml4My5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBudW1iZXIgb2YgaXRlbXMgaW4gdGhlIGNvbGxlY3Rpb24uCiAgICAgICAgICogQG1lbWJlcm9mIE1hdHJpeDMucHJvdG90eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGxlbmd0aDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdHJpeDMucGFja2VkTGVuZ3RoOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIE1hdHJpeDMucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIE1hdHJpeDMuY2xvbmUodGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgTWF0cml4My5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ocmlnaHQpIHsKICAgICAgICByZXR1cm4gTWF0cml4My5lcXVhbHModGhpcywgcmlnaHQpOwogICAgICB9OwogICAgICBNYXRyaXgzLmVxdWFsc0FycmF5ID0gZnVuY3Rpb24obWF0cml4LCBhcnJheSwgb2Zmc2V0KSB7CiAgICAgICAgcmV0dXJuIG1hdHJpeFswXSA9PT0gYXJyYXlbb2Zmc2V0XSAmJiBtYXRyaXhbMV0gPT09IGFycmF5W29mZnNldCArIDFdICYmIG1hdHJpeFsyXSA9PT0gYXJyYXlbb2Zmc2V0ICsgMl0gJiYgbWF0cml4WzNdID09PSBhcnJheVtvZmZzZXQgKyAzXSAmJiBtYXRyaXhbNF0gPT09IGFycmF5W29mZnNldCArIDRdICYmIG1hdHJpeFs1XSA9PT0gYXJyYXlbb2Zmc2V0ICsgNV0gJiYgbWF0cml4WzZdID09PSBhcnJheVtvZmZzZXQgKyA2XSAmJiBtYXRyaXhbN10gPT09IGFycmF5W29mZnNldCArIDddICYmIG1hdHJpeFs4XSA9PT0gYXJyYXlbb2Zmc2V0ICsgOF07CiAgICAgIH07CiAgICAgIE1hdHJpeDMucHJvdG90eXBlLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihyaWdodCwgZXBzaWxvbikgewogICAgICAgIHJldHVybiBNYXRyaXgzLmVxdWFsc0Vwc2lsb24odGhpcywgcmlnaHQsIGVwc2lsb24pOwogICAgICB9OwogICAgICBNYXRyaXgzLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBgKCR7dGhpc1swXX0sICR7dGhpc1szXX0sICR7dGhpc1s2XX0pCigke3RoaXNbMV19LCAke3RoaXNbNF19LCAke3RoaXNbN119KQooJHt0aGlzWzJdfSwgJHt0aGlzWzVdfSwgJHt0aGlzWzhdfSlgOwogICAgICB9OwogICAgICBNYXRyaXgzX2RlZmF1bHQgPSBNYXRyaXgzOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2FydGVzaWFuNC5qcwogIGZ1bmN0aW9uIENhcnRlc2lhbjQoeCwgeSwgeiwgdykgewogICAgdGhpcy54ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeCwgMCk7CiAgICB0aGlzLnkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh5LCAwKTsKICAgIHRoaXMueiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHosIDApOwogICAgdGhpcy53ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodywgMCk7CiAgfQogIHZhciBkaXN0YW5jZVNjcmF0Y2gzLCBsZXJwU2NyYXRjaDMsIG1vc3RPcnRob2dvbmFsQXhpc1NjcmF0Y2gzLCBzY3JhdGNoRjMyQXJyYXksIHNjcmF0Y2hVOEFycmF5LCB0ZXN0VTMyLCB0ZXN0VTgsIGxpdHRsZUVuZGlhbiwgQ2FydGVzaWFuNF9kZWZhdWx0OwogIHZhciBpbml0X0NhcnRlc2lhbjQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NhcnRlc2lhbjQuanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBDYXJ0ZXNpYW40LmZyb21FbGVtZW50cyA9IGZ1bmN0aW9uKHgsIHksIHosIHcsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydGVzaWFuNCh4LCB5LCB6LCB3KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmVzdWx0LncgPSB3OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQuZnJvbUNvbG9yID0gZnVuY3Rpb24oY29sb3IsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY29sb3IiLCBjb2xvcik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0ZXNpYW40KGNvbG9yLnJlZCwgY29sb3IuZ3JlZW4sIGNvbG9yLmJsdWUsIGNvbG9yLmFscGhhKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBjb2xvci5yZWQ7CiAgICAgICAgcmVzdWx0LnkgPSBjb2xvci5ncmVlbjsKICAgICAgICByZXN1bHQueiA9IGNvbG9yLmJsdWU7CiAgICAgICAgcmVzdWx0LncgPSBjb2xvci5hbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LmNsb25lID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNhcnRlc2lhbjExKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0ZXNpYW40KGNhcnRlc2lhbjExLngsIGNhcnRlc2lhbjExLnksIGNhcnRlc2lhbjExLnosIGNhcnRlc2lhbjExLncpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IGNhcnRlc2lhbjExLng7CiAgICAgICAgcmVzdWx0LnkgPSBjYXJ0ZXNpYW4xMS55OwogICAgICAgIHJlc3VsdC56ID0gY2FydGVzaWFuMTEuejsKICAgICAgICByZXN1bHQudyA9IGNhcnRlc2lhbjExLnc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5wYWNrZWRMZW5ndGggPSA0OwogICAgICBDYXJ0ZXNpYW40LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS54OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS55OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS56OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gdmFsdWUudzsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW40KCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQueSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LnogPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC53ID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5wYWNrQXJyYXkgPSBmdW5jdGlvbihhcnJheSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgICAgY29uc3QgcmVzdWx0TGVuZ3RoID0gbGVuZ3RoICogNDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkocmVzdWx0TGVuZ3RoKTsKICAgICAgICB9IGVsc2UgaWYgKCFBcnJheS5pc0FycmF5KHJlc3VsdCkgJiYgcmVzdWx0Lmxlbmd0aCAhPT0gcmVzdWx0TGVuZ3RoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIklmIHJlc3VsdCBpcyBhIHR5cGVkIGFycmF5LCBpdCBtdXN0IGhhdmUgZXhhY3RseSBhcnJheS5sZW5ndGggKiA0IGVsZW1lbnRzIgogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKHJlc3VsdC5sZW5ndGggIT09IHJlc3VsdExlbmd0aCkgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IHJlc3VsdExlbmd0aDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgQ2FydGVzaWFuNC5wYWNrKGFycmF5W2ldLCByZXN1bHQsIGkgKiA0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC51bnBhY2tBcnJheSA9IGZ1bmN0aW9uKGFycmF5LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJhcnJheS5sZW5ndGgiLCBhcnJheS5sZW5ndGgsIDQpOwogICAgICAgIGlmIChhcnJheS5sZW5ndGggJSA0ICE9PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA0LiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEFycmF5KGxlbmd0aCAvIDQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoIC8gNDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gNCkgewogICAgICAgICAgY29uc3QgaW5kZXggPSBpIC8gNDsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBDYXJ0ZXNpYW40LnVucGFjayhhcnJheSwgaSwgcmVzdWx0W2luZGV4XSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQuZnJvbUFycmF5ID0gQ2FydGVzaWFuNC51bnBhY2s7CiAgICAgIENhcnRlc2lhbjQubWF4aW11bUNvbXBvbmVudCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmV0dXJuIE1hdGgubWF4KGNhcnRlc2lhbjExLngsIGNhcnRlc2lhbjExLnksIGNhcnRlc2lhbjExLnosIGNhcnRlc2lhbjExLncpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40Lm1pbmltdW1Db21wb25lbnQgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIHJldHVybiBNYXRoLm1pbihjYXJ0ZXNpYW4xMS54LCBjYXJ0ZXNpYW4xMS55LCBjYXJ0ZXNpYW4xMS56LCBjYXJ0ZXNpYW4xMS53KTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5taW5pbXVtQnlDb21wb25lbnQgPSBmdW5jdGlvbihmaXJzdCwgc2Vjb25kLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImZpcnN0IiwgZmlyc3QpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic2Vjb25kIiwgc2Vjb25kKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBNYXRoLm1pbihmaXJzdC54LCBzZWNvbmQueCk7CiAgICAgICAgcmVzdWx0LnkgPSBNYXRoLm1pbihmaXJzdC55LCBzZWNvbmQueSk7CiAgICAgICAgcmVzdWx0LnogPSBNYXRoLm1pbihmaXJzdC56LCBzZWNvbmQueik7CiAgICAgICAgcmVzdWx0LncgPSBNYXRoLm1pbihmaXJzdC53LCBzZWNvbmQudyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5tYXhpbXVtQnlDb21wb25lbnQgPSBmdW5jdGlvbihmaXJzdCwgc2Vjb25kLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImZpcnN0IiwgZmlyc3QpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic2Vjb25kIiwgc2Vjb25kKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBNYXRoLm1heChmaXJzdC54LCBzZWNvbmQueCk7CiAgICAgICAgcmVzdWx0LnkgPSBNYXRoLm1heChmaXJzdC55LCBzZWNvbmQueSk7CiAgICAgICAgcmVzdWx0LnogPSBNYXRoLm1heChmaXJzdC56LCBzZWNvbmQueik7CiAgICAgICAgcmVzdWx0LncgPSBNYXRoLm1heChmaXJzdC53LCBzZWNvbmQudyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5jbGFtcCA9IGZ1bmN0aW9uKHZhbHVlLCBtaW4zLCBtYXgzLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWluIiwgbWluMyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXgiLCBtYXgzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgeCA9IE1hdGhfZGVmYXVsdC5jbGFtcCh2YWx1ZS54LCBtaW4zLngsIG1heDMueCk7CiAgICAgICAgY29uc3QgeSA9IE1hdGhfZGVmYXVsdC5jbGFtcCh2YWx1ZS55LCBtaW4zLnksIG1heDMueSk7CiAgICAgICAgY29uc3QgeiA9IE1hdGhfZGVmYXVsdC5jbGFtcCh2YWx1ZS56LCBtaW4zLnosIG1heDMueik7CiAgICAgICAgY29uc3QgdyA9IE1hdGhfZGVmYXVsdC5jbGFtcCh2YWx1ZS53LCBtaW4zLncsIG1heDMudyk7CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmVzdWx0LncgPSB3OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQubWFnbml0dWRlU3F1YXJlZCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmV0dXJuIGNhcnRlc2lhbjExLnggKiBjYXJ0ZXNpYW4xMS54ICsgY2FydGVzaWFuMTEueSAqIGNhcnRlc2lhbjExLnkgKyBjYXJ0ZXNpYW4xMS56ICogY2FydGVzaWFuMTEueiArIGNhcnRlc2lhbjExLncgKiBjYXJ0ZXNpYW4xMS53OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40Lm1hZ25pdHVkZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgcmV0dXJuIE1hdGguc3FydChDYXJ0ZXNpYW40Lm1hZ25pdHVkZVNxdWFyZWQoY2FydGVzaWFuMTEpKTsKICAgICAgfTsKICAgICAgZGlzdGFuY2VTY3JhdGNoMyA9IG5ldyBDYXJ0ZXNpYW40KCk7CiAgICAgIENhcnRlc2lhbjQuZGlzdGFuY2UgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2FydGVzaWFuNC5zdWJ0cmFjdChsZWZ0LCByaWdodCwgZGlzdGFuY2VTY3JhdGNoMyk7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjQubWFnbml0dWRlKGRpc3RhbmNlU2NyYXRjaDMpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LmRpc3RhbmNlU3F1YXJlZCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDYXJ0ZXNpYW40LnN1YnRyYWN0KGxlZnQsIHJpZ2h0LCBkaXN0YW5jZVNjcmF0Y2gzKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuNC5tYWduaXR1ZGVTcXVhcmVkKGRpc3RhbmNlU2NyYXRjaDMpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40Lm5vcm1hbGl6ZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgbWFnbml0dWRlID0gQ2FydGVzaWFuNC5tYWduaXR1ZGUoY2FydGVzaWFuMTEpOwogICAgICAgIHJlc3VsdC54ID0gY2FydGVzaWFuMTEueCAvIG1hZ25pdHVkZTsKICAgICAgICByZXN1bHQueSA9IGNhcnRlc2lhbjExLnkgLyBtYWduaXR1ZGU7CiAgICAgICAgcmVzdWx0LnogPSBjYXJ0ZXNpYW4xMS56IC8gbWFnbml0dWRlOwogICAgICAgIHJlc3VsdC53ID0gY2FydGVzaWFuMTEudyAvIG1hZ25pdHVkZTsKICAgICAgICBpZiAoaXNOYU4ocmVzdWx0LngpIHx8IGlzTmFOKHJlc3VsdC55KSB8fCBpc05hTihyZXN1bHQueikgfHwgaXNOYU4ocmVzdWx0LncpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibm9ybWFsaXplZCByZXN1bHQgaXMgbm90IGEgbnVtYmVyIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQuZG90ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIHJldHVybiBsZWZ0LnggKiByaWdodC54ICsgbGVmdC55ICogcmlnaHQueSArIGxlZnQueiAqIHJpZ2h0LnogKyBsZWZ0LncgKiByaWdodC53OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40Lm11bHRpcGx5Q29tcG9uZW50cyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCAqIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgKiByaWdodC55OwogICAgICAgIHJlc3VsdC56ID0gbGVmdC56ICogcmlnaHQuejsKICAgICAgICByZXN1bHQudyA9IGxlZnQudyAqIHJpZ2h0Lnc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5kaXZpZGVDb21wb25lbnRzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbGVmdC54IC8gcmlnaHQueDsKICAgICAgICByZXN1bHQueSA9IGxlZnQueSAvIHJpZ2h0Lnk7CiAgICAgICAgcmVzdWx0LnogPSBsZWZ0LnogLyByaWdodC56OwogICAgICAgIHJlc3VsdC53ID0gbGVmdC53IC8gcmlnaHQudzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LmFkZCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCArIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgKyByaWdodC55OwogICAgICAgIHJlc3VsdC56ID0gbGVmdC56ICsgcmlnaHQuejsKICAgICAgICByZXN1bHQudyA9IGxlZnQudyArIHJpZ2h0Lnc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5zdWJ0cmFjdCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCAtIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgLSByaWdodC55OwogICAgICAgIHJlc3VsdC56ID0gbGVmdC56IC0gcmlnaHQuejsKICAgICAgICByZXN1bHQudyA9IGxlZnQudyAtIHJpZ2h0Lnc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5tdWx0aXBseUJ5U2NhbGFyID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHNjYWxhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsYXIiLCBzY2FsYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGNhcnRlc2lhbjExLnggKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0LnkgPSBjYXJ0ZXNpYW4xMS55ICogc2NhbGFyOwogICAgICAgIHJlc3VsdC56ID0gY2FydGVzaWFuMTEueiAqIHNjYWxhcjsKICAgICAgICByZXN1bHQudyA9IGNhcnRlc2lhbjExLncgKiBzY2FsYXI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5kaXZpZGVCeVNjYWxhciA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCBzY2FsYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGFyIiwgc2NhbGFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54IC8gc2NhbGFyOwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueSAvIHNjYWxhcjsKICAgICAgICByZXN1bHQueiA9IGNhcnRlc2lhbjExLnogLyBzY2FsYXI7CiAgICAgICAgcmVzdWx0LncgPSBjYXJ0ZXNpYW4xMS53IC8gc2NhbGFyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQubmVnYXRlID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IC1jYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdC55ID0gLWNhcnRlc2lhbjExLnk7CiAgICAgICAgcmVzdWx0LnogPSAtY2FydGVzaWFuMTEuejsKICAgICAgICByZXN1bHQudyA9IC1jYXJ0ZXNpYW4xMS53OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQuYWJzID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IE1hdGguYWJzKGNhcnRlc2lhbjExLngpOwogICAgICAgIHJlc3VsdC55ID0gTWF0aC5hYnMoY2FydGVzaWFuMTEueSk7CiAgICAgICAgcmVzdWx0LnogPSBNYXRoLmFicyhjYXJ0ZXNpYW4xMS56KTsKICAgICAgICByZXN1bHQudyA9IE1hdGguYWJzKGNhcnRlc2lhbjExLncpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGxlcnBTY3JhdGNoMyA9IG5ldyBDYXJ0ZXNpYW40KCk7CiAgICAgIENhcnRlc2lhbjQubGVycCA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQsIHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3RhcnQiLCBzdGFydCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJlbmQiLCBlbmQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigidCIsIHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBDYXJ0ZXNpYW40Lm11bHRpcGx5QnlTY2FsYXIoZW5kLCB0LCBsZXJwU2NyYXRjaDMpOwogICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjQubXVsdGlwbHlCeVNjYWxhcihzdGFydCwgMSAtIHQsIHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjQuYWRkKGxlcnBTY3JhdGNoMywgcmVzdWx0LCByZXN1bHQpOwogICAgICB9OwogICAgICBtb3N0T3J0aG9nb25hbEF4aXNTY3JhdGNoMyA9IG5ldyBDYXJ0ZXNpYW40KCk7CiAgICAgIENhcnRlc2lhbjQubW9zdE9ydGhvZ29uYWxBeGlzID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBmID0gQ2FydGVzaWFuNC5ub3JtYWxpemUoY2FydGVzaWFuMTEsIG1vc3RPcnRob2dvbmFsQXhpc1NjcmF0Y2gzKTsKICAgICAgICBDYXJ0ZXNpYW40LmFicyhmLCBmKTsKICAgICAgICBpZiAoZi54IDw9IGYueSkgewogICAgICAgICAgaWYgKGYueCA8PSBmLnopIHsKICAgICAgICAgICAgaWYgKGYueCA8PSBmLncpIHsKICAgICAgICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW40LmNsb25lKENhcnRlc2lhbjQuVU5JVF9YLCByZXN1bHQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjQuY2xvbmUoQ2FydGVzaWFuNC5VTklUX1csIHJlc3VsdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoZi56IDw9IGYudykgewogICAgICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW40LmNsb25lKENhcnRlc2lhbjQuVU5JVF9aLCByZXN1bHQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuNC5jbG9uZShDYXJ0ZXNpYW40LlVOSVRfVywgcmVzdWx0KTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGYueSA8PSBmLnopIHsKICAgICAgICAgIGlmIChmLnkgPD0gZi53KSB7CiAgICAgICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjQuY2xvbmUoQ2FydGVzaWFuNC5VTklUX1ksIHJlc3VsdCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW40LmNsb25lKENhcnRlc2lhbjQuVU5JVF9XLCByZXN1bHQpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoZi56IDw9IGYudykgewogICAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuNC5jbG9uZShDYXJ0ZXNpYW40LlVOSVRfWiwgcmVzdWx0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuNC5jbG9uZShDYXJ0ZXNpYW40LlVOSVRfVywgcmVzdWx0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBsZWZ0LnggPT09IHJpZ2h0LnggJiYgbGVmdC55ID09PSByaWdodC55ICYmIGxlZnQueiA9PT0gcmlnaHQueiAmJiBsZWZ0LncgPT09IHJpZ2h0Lnc7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQuZXF1YWxzQXJyYXkgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgYXJyYXksIG9mZnNldCkgewogICAgICAgIHJldHVybiBjYXJ0ZXNpYW4xMS54ID09PSBhcnJheVtvZmZzZXRdICYmIGNhcnRlc2lhbjExLnkgPT09IGFycmF5W29mZnNldCArIDFdICYmIGNhcnRlc2lhbjExLnogPT09IGFycmF5W29mZnNldCArIDJdICYmIGNhcnRlc2lhbjExLncgPT09IGFycmF5W29mZnNldCArIDNdOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVsYXRpdmVFcHNpbG9uLCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBsZWZ0LngsCiAgICAgICAgICByaWdodC54LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGxlZnQueSwKICAgICAgICAgIHJpZ2h0LnksCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgbGVmdC56LAogICAgICAgICAgcmlnaHQueiwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBsZWZ0LncsCiAgICAgICAgICByaWdodC53LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5aRVJPID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydGVzaWFuNCgwLCAwLCAwLCAwKSk7CiAgICAgIENhcnRlc2lhbjQuT05FID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydGVzaWFuNCgxLCAxLCAxLCAxKSk7CiAgICAgIENhcnRlc2lhbjQuVU5JVF9YID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydGVzaWFuNCgxLCAwLCAwLCAwKSk7CiAgICAgIENhcnRlc2lhbjQuVU5JVF9ZID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydGVzaWFuNCgwLCAxLCAwLCAwKSk7CiAgICAgIENhcnRlc2lhbjQuVU5JVF9aID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydGVzaWFuNCgwLCAwLCAxLCAwKSk7CiAgICAgIENhcnRlc2lhbjQuVU5JVF9XID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydGVzaWFuNCgwLCAwLCAwLCAxKSk7CiAgICAgIENhcnRlc2lhbjQucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjQuY2xvbmUodGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ocmlnaHQpIHsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuNC5lcXVhbHModGhpcywgcmlnaHQpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LnByb3RvdHlwZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24ocmlnaHQsIHJlbGF0aXZlRXBzaWxvbiwgYWJzb2x1dGVFcHNpbG9uKSB7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMsCiAgICAgICAgICByaWdodCwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGAoJHt0aGlzLnh9LCAke3RoaXMueX0sICR7dGhpcy56fSwgJHt0aGlzLnd9KWA7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hGMzJBcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkoMSk7CiAgICAgIHNjcmF0Y2hVOEFycmF5ID0gbmV3IFVpbnQ4QXJyYXkoc2NyYXRjaEYzMkFycmF5LmJ1ZmZlcik7CiAgICAgIHRlc3RVMzIgPSBuZXcgVWludDMyQXJyYXkoWzI4NzQ1NDAyMF0pOwogICAgICB0ZXN0VTggPSBuZXcgVWludDhBcnJheSh0ZXN0VTMyLmJ1ZmZlcik7CiAgICAgIGxpdHRsZUVuZGlhbiA9IHRlc3RVOFswXSA9PT0gNjg7CiAgICAgIENhcnRlc2lhbjQucGFja0Zsb2F0ID0gZnVuY3Rpb24odmFsdWUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjQoKTsKICAgICAgICB9CiAgICAgICAgc2NyYXRjaEYzMkFycmF5WzBdID0gdmFsdWU7CiAgICAgICAgaWYgKGxpdHRsZUVuZGlhbikgewogICAgICAgICAgcmVzdWx0LnggPSBzY3JhdGNoVThBcnJheVswXTsKICAgICAgICAgIHJlc3VsdC55ID0gc2NyYXRjaFU4QXJyYXlbMV07CiAgICAgICAgICByZXN1bHQueiA9IHNjcmF0Y2hVOEFycmF5WzJdOwogICAgICAgICAgcmVzdWx0LncgPSBzY3JhdGNoVThBcnJheVszXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0LnggPSBzY3JhdGNoVThBcnJheVszXTsKICAgICAgICAgIHJlc3VsdC55ID0gc2NyYXRjaFU4QXJyYXlbMl07CiAgICAgICAgICByZXN1bHQueiA9IHNjcmF0Y2hVOEFycmF5WzFdOwogICAgICAgICAgcmVzdWx0LncgPSBzY3JhdGNoVThBcnJheVswXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC51bnBhY2tGbG9hdCA9IGZ1bmN0aW9uKHBhY2tlZEZsb2F0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJwYWNrZWRGbG9hdCIsIHBhY2tlZEZsb2F0KTsKICAgICAgICBpZiAobGl0dGxlRW5kaWFuKSB7CiAgICAgICAgICBzY3JhdGNoVThBcnJheVswXSA9IHBhY2tlZEZsb2F0Lng7CiAgICAgICAgICBzY3JhdGNoVThBcnJheVsxXSA9IHBhY2tlZEZsb2F0Lnk7CiAgICAgICAgICBzY3JhdGNoVThBcnJheVsyXSA9IHBhY2tlZEZsb2F0Lno7CiAgICAgICAgICBzY3JhdGNoVThBcnJheVszXSA9IHBhY2tlZEZsb2F0Lnc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNjcmF0Y2hVOEFycmF5WzBdID0gcGFja2VkRmxvYXQudzsKICAgICAgICAgIHNjcmF0Y2hVOEFycmF5WzFdID0gcGFja2VkRmxvYXQuejsKICAgICAgICAgIHNjcmF0Y2hVOEFycmF5WzJdID0gcGFja2VkRmxvYXQueTsKICAgICAgICAgIHNjcmF0Y2hVOEFycmF5WzNdID0gcGFja2VkRmxvYXQueDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNjcmF0Y2hGMzJBcnJheVswXTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNF9kZWZhdWx0ID0gQ2FydGVzaWFuNDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1J1bnRpbWVFcnJvci5qcwogIGZ1bmN0aW9uIFJ1bnRpbWVFcnJvcihtZXNzYWdlKSB7CiAgICB0aGlzLm5hbWUgPSAiUnVudGltZUVycm9yIjsKICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2U7CiAgICBsZXQgc3RhY2s7CiAgICB0cnkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgc3RhY2sgPSBlLnN0YWNrOwogICAgfQogICAgdGhpcy5zdGFjayA9IHN0YWNrOwogIH0KICB2YXIgUnVudGltZUVycm9yX2RlZmF1bHQ7CiAgdmFyIGluaXRfUnVudGltZUVycm9yID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SdW50aW1lRXJyb3IuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChPYmplY3QuY3JlYXRlKSkgewogICAgICAgIFJ1bnRpbWVFcnJvci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEVycm9yLnByb3RvdHlwZSk7CiAgICAgICAgUnVudGltZUVycm9yLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFJ1bnRpbWVFcnJvcjsKICAgICAgfQogICAgICBSdW50aW1lRXJyb3IucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbGV0IHN0ciA9IGAke3RoaXMubmFtZX06ICR7dGhpcy5tZXNzYWdlfWA7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0aGlzLnN0YWNrKSkgewogICAgICAgICAgc3RyICs9IGAKJHt0aGlzLnN0YWNrLnRvU3RyaW5nKCl9YDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgfTsKICAgICAgUnVudGltZUVycm9yX2RlZmF1bHQgPSBSdW50aW1lRXJyb3I7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9NYXRyaXg0LmpzCiAgZnVuY3Rpb24gTWF0cml4NChjb2x1bW4wUm93MCwgY29sdW1uMVJvdzAsIGNvbHVtbjJSb3cwLCBjb2x1bW4zUm93MCwgY29sdW1uMFJvdzEsIGNvbHVtbjFSb3cxLCBjb2x1bW4yUm93MSwgY29sdW1uM1JvdzEsIGNvbHVtbjBSb3cyLCBjb2x1bW4xUm93MiwgY29sdW1uMlJvdzIsIGNvbHVtbjNSb3cyLCBjb2x1bW4wUm93MywgY29sdW1uMVJvdzMsIGNvbHVtbjJSb3czLCBjb2x1bW4zUm93MykgewogICAgdGhpc1swXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjBSb3cwLCAwKTsKICAgIHRoaXNbMV0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4wUm93MSwgMCk7CiAgICB0aGlzWzJdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMFJvdzIsIDApOwogICAgdGhpc1szXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjBSb3czLCAwKTsKICAgIHRoaXNbNF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4xUm93MCwgMCk7CiAgICB0aGlzWzVdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMVJvdzEsIDApOwogICAgdGhpc1s2XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjFSb3cyLCAwKTsKICAgIHRoaXNbN10gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4xUm93MywgMCk7CiAgICB0aGlzWzhdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMlJvdzAsIDApOwogICAgdGhpc1s5XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjJSb3cxLCAwKTsKICAgIHRoaXNbMTBdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMlJvdzIsIDApOwogICAgdGhpc1sxMV0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4yUm93MywgMCk7CiAgICB0aGlzWzEyXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjNSb3cwLCAwKTsKICAgIHRoaXNbMTNdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uM1JvdzEsIDApOwogICAgdGhpc1sxNF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4zUm93MiwgMCk7CiAgICB0aGlzWzE1XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjNSb3czLCAwKTsKICB9CiAgdmFyIGZyb21DYW1lcmFGLCBmcm9tQ2FtZXJhUiwgZnJvbUNhbWVyYVUsIHNjYWxlU2NyYXRjaDEyLCBzY2FsZVNjcmF0Y2gyMiwgc2NyYXRjaENvbHVtbjIsIHNjYWxlU2NyYXRjaDMyLCBzY2FsZVNjcmF0Y2g0Miwgc2NhbGVTY3JhdGNoNTIsIHNjcmF0Y2hJbnZlcnNlUm90YXRpb24sIHNjcmF0Y2hNYXRyaXgzWmVybywgc2NyYXRjaEJvdHRvbVJvdywgc2NyYXRjaEV4cGVjdGVkQm90dG9tUm93LCBzY3JhdGNoVHJhbnNwb3NlTWF0cml4MiwgTWF0cml4NF9kZWZhdWx0OwogIHZhciBpbml0X01hdHJpeDQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL01hdHJpeDQuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW40KCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X1J1bnRpbWVFcnJvcigpOwogICAgICBNYXRyaXg0LnBhY2tlZExlbmd0aCA9IDE2OwogICAgICBNYXRyaXg0LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVswXTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbMV07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzJdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVszXTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbNF07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzVdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVs2XTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbN107CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzhdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVs5XTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbMTBdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVsxMV07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzEyXTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbMTNdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVsxNF07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZVsxNV07CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBNYXRyaXg0LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgTWF0cml4NCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsxXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzJdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbM10gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFs0XSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzVdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbNl0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFs3XSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzhdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbOV0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsxMF0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsxMV0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsxMl0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsxM10gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsxNF0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsxNV0gPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LnBhY2tBcnJheSA9IGZ1bmN0aW9uKGFycmF5LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICBjb25zdCByZXN1bHRMZW5ndGggPSBsZW5ndGggKiAxNjsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkocmVzdWx0TGVuZ3RoKTsKICAgICAgICB9IGVsc2UgaWYgKCFBcnJheS5pc0FycmF5KHJlc3VsdCkgJiYgcmVzdWx0Lmxlbmd0aCAhPT0gcmVzdWx0TGVuZ3RoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIklmIHJlc3VsdCBpcyBhIHR5cGVkIGFycmF5LCBpdCBtdXN0IGhhdmUgZXhhY3RseSBhcnJheS5sZW5ndGggKiAxNiBlbGVtZW50cyIKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIGlmIChyZXN1bHQubGVuZ3RoICE9PSByZXN1bHRMZW5ndGgpIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSByZXN1bHRMZW5ndGg7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIE1hdHJpeDQucGFjayhhcnJheVtpXSwgcmVzdWx0LCBpICogMTYpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LnVucGFja0FycmF5ID0gZnVuY3Rpb24oYXJyYXksIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImFycmF5Lmxlbmd0aCIsIGFycmF5Lmxlbmd0aCwgMTYpOwogICAgICAgIGlmIChhcnJheS5sZW5ndGggJSAxNiAhPT0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGxlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMTYuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoIC8gMTYpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoIC8gMTY7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDE2KSB7CiAgICAgICAgICBjb25zdCBpbmRleCA9IGkgLyAxNjsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBNYXRyaXg0LnVucGFjayhhcnJheSwgaSwgcmVzdWx0W2luZGV4XSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuY2xvbmUgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG1hdHJpeCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4NCgKICAgICAgICAgICAgbWF0cml4WzBdLAogICAgICAgICAgICBtYXRyaXhbNF0sCiAgICAgICAgICAgIG1hdHJpeFs4XSwKICAgICAgICAgICAgbWF0cml4WzEyXSwKICAgICAgICAgICAgbWF0cml4WzFdLAogICAgICAgICAgICBtYXRyaXhbNV0sCiAgICAgICAgICAgIG1hdHJpeFs5XSwKICAgICAgICAgICAgbWF0cml4WzEzXSwKICAgICAgICAgICAgbWF0cml4WzJdLAogICAgICAgICAgICBtYXRyaXhbNl0sCiAgICAgICAgICAgIG1hdHJpeFsxMF0sCiAgICAgICAgICAgIG1hdHJpeFsxNF0sCiAgICAgICAgICAgIG1hdHJpeFszXSwKICAgICAgICAgICAgbWF0cml4WzddLAogICAgICAgICAgICBtYXRyaXhbMTFdLAogICAgICAgICAgICBtYXRyaXhbMTVdCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM107CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzRdOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbNl07CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzddOwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFs4XTsKICAgICAgICByZXN1bHRbOV0gPSBtYXRyaXhbOV07CiAgICAgICAgcmVzdWx0WzEwXSA9IG1hdHJpeFsxMF07CiAgICAgICAgcmVzdWx0WzExXSA9IG1hdHJpeFsxMV07CiAgICAgICAgcmVzdWx0WzEyXSA9IG1hdHJpeFsxMl07CiAgICAgICAgcmVzdWx0WzEzXSA9IG1hdHJpeFsxM107CiAgICAgICAgcmVzdWx0WzE0XSA9IG1hdHJpeFsxNF07CiAgICAgICAgcmVzdWx0WzE1XSA9IG1hdHJpeFsxNV07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5mcm9tQXJyYXkgPSBNYXRyaXg0LnVucGFjazsKICAgICAgTWF0cml4NC5mcm9tQ29sdW1uTWFqb3JBcnJheSA9IGZ1bmN0aW9uKHZhbHVlcywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2YWx1ZXMiLCB2YWx1ZXMpOwogICAgICAgIHJldHVybiBNYXRyaXg0LmNsb25lKHZhbHVlcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgTWF0cml4NC5mcm9tUm93TWFqb3JBcnJheSA9IGZ1bmN0aW9uKHZhbHVlcywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2YWx1ZXMiLCB2YWx1ZXMpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4NCgKICAgICAgICAgICAgdmFsdWVzWzBdLAogICAgICAgICAgICB2YWx1ZXNbMV0sCiAgICAgICAgICAgIHZhbHVlc1syXSwKICAgICAgICAgICAgdmFsdWVzWzNdLAogICAgICAgICAgICB2YWx1ZXNbNF0sCiAgICAgICAgICAgIHZhbHVlc1s1XSwKICAgICAgICAgICAgdmFsdWVzWzZdLAogICAgICAgICAgICB2YWx1ZXNbN10sCiAgICAgICAgICAgIHZhbHVlc1s4XSwKICAgICAgICAgICAgdmFsdWVzWzldLAogICAgICAgICAgICB2YWx1ZXNbMTBdLAogICAgICAgICAgICB2YWx1ZXNbMTFdLAogICAgICAgICAgICB2YWx1ZXNbMTJdLAogICAgICAgICAgICB2YWx1ZXNbMTNdLAogICAgICAgICAgICB2YWx1ZXNbMTRdLAogICAgICAgICAgICB2YWx1ZXNbMTVdCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSB2YWx1ZXNbMF07CiAgICAgICAgcmVzdWx0WzFdID0gdmFsdWVzWzRdOwogICAgICAgIHJlc3VsdFsyXSA9IHZhbHVlc1s4XTsKICAgICAgICByZXN1bHRbM10gPSB2YWx1ZXNbMTJdOwogICAgICAgIHJlc3VsdFs0XSA9IHZhbHVlc1sxXTsKICAgICAgICByZXN1bHRbNV0gPSB2YWx1ZXNbNV07CiAgICAgICAgcmVzdWx0WzZdID0gdmFsdWVzWzldOwogICAgICAgIHJlc3VsdFs3XSA9IHZhbHVlc1sxM107CiAgICAgICAgcmVzdWx0WzhdID0gdmFsdWVzWzJdOwogICAgICAgIHJlc3VsdFs5XSA9IHZhbHVlc1s2XTsKICAgICAgICByZXN1bHRbMTBdID0gdmFsdWVzWzEwXTsKICAgICAgICByZXN1bHRbMTFdID0gdmFsdWVzWzE0XTsKICAgICAgICByZXN1bHRbMTJdID0gdmFsdWVzWzNdOwogICAgICAgIHJlc3VsdFsxM10gPSB2YWx1ZXNbN107CiAgICAgICAgcmVzdWx0WzE0XSA9IHZhbHVlc1sxMV07CiAgICAgICAgcmVzdWx0WzE1XSA9IHZhbHVlc1sxNV07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5mcm9tUm90YXRpb25UcmFuc2xhdGlvbiA9IGZ1bmN0aW9uKHJvdGF0aW9uLCB0cmFuc2xhdGlvbjIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicm90YXRpb24iLCByb3RhdGlvbik7CiAgICAgICAgdHJhbnNsYXRpb24yID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodHJhbnNsYXRpb24yLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTyk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBNYXRyaXg0KAogICAgICAgICAgICByb3RhdGlvblswXSwKICAgICAgICAgICAgcm90YXRpb25bM10sCiAgICAgICAgICAgIHJvdGF0aW9uWzZdLAogICAgICAgICAgICB0cmFuc2xhdGlvbjIueCwKICAgICAgICAgICAgcm90YXRpb25bMV0sCiAgICAgICAgICAgIHJvdGF0aW9uWzRdLAogICAgICAgICAgICByb3RhdGlvbls3XSwKICAgICAgICAgICAgdHJhbnNsYXRpb24yLnksCiAgICAgICAgICAgIHJvdGF0aW9uWzJdLAogICAgICAgICAgICByb3RhdGlvbls1XSwKICAgICAgICAgICAgcm90YXRpb25bOF0sCiAgICAgICAgICAgIHRyYW5zbGF0aW9uMi56LAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAxCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSByb3RhdGlvblswXTsKICAgICAgICByZXN1bHRbMV0gPSByb3RhdGlvblsxXTsKICAgICAgICByZXN1bHRbMl0gPSByb3RhdGlvblsyXTsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IHJvdGF0aW9uWzNdOwogICAgICAgIHJlc3VsdFs1XSA9IHJvdGF0aW9uWzRdOwogICAgICAgIHJlc3VsdFs2XSA9IHJvdGF0aW9uWzVdOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gcm90YXRpb25bNl07CiAgICAgICAgcmVzdWx0WzldID0gcm90YXRpb25bN107CiAgICAgICAgcmVzdWx0WzEwXSA9IHJvdGF0aW9uWzhdOwogICAgICAgIHJlc3VsdFsxMV0gPSAwOwogICAgICAgIHJlc3VsdFsxMl0gPSB0cmFuc2xhdGlvbjIueDsKICAgICAgICByZXN1bHRbMTNdID0gdHJhbnNsYXRpb24yLnk7CiAgICAgICAgcmVzdWx0WzE0XSA9IHRyYW5zbGF0aW9uMi56OwogICAgICAgIHJlc3VsdFsxNV0gPSAxOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuZnJvbVRyYW5zbGF0aW9uUXVhdGVybmlvblJvdGF0aW9uU2NhbGUgPSBmdW5jdGlvbih0cmFuc2xhdGlvbjIsIHJvdGF0aW9uLCBzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ0cmFuc2xhdGlvbiIsIHRyYW5zbGF0aW9uMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyb3RhdGlvbiIsIHJvdGF0aW9uKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNjYWxlIiwgc2NhbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBNYXRyaXg0KCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNjYWxlWCA9IHNjYWxlLng7CiAgICAgICAgY29uc3Qgc2NhbGVZID0gc2NhbGUueTsKICAgICAgICBjb25zdCBzY2FsZVogPSBzY2FsZS56OwogICAgICAgIGNvbnN0IHgyID0gcm90YXRpb24ueCAqIHJvdGF0aW9uLng7CiAgICAgICAgY29uc3QgeHkgPSByb3RhdGlvbi54ICogcm90YXRpb24ueTsKICAgICAgICBjb25zdCB4eiA9IHJvdGF0aW9uLnggKiByb3RhdGlvbi56OwogICAgICAgIGNvbnN0IHh3ID0gcm90YXRpb24ueCAqIHJvdGF0aW9uLnc7CiAgICAgICAgY29uc3QgeTIgPSByb3RhdGlvbi55ICogcm90YXRpb24ueTsKICAgICAgICBjb25zdCB5eiA9IHJvdGF0aW9uLnkgKiByb3RhdGlvbi56OwogICAgICAgIGNvbnN0IHl3ID0gcm90YXRpb24ueSAqIHJvdGF0aW9uLnc7CiAgICAgICAgY29uc3QgejIgPSByb3RhdGlvbi56ICogcm90YXRpb24uejsKICAgICAgICBjb25zdCB6dyA9IHJvdGF0aW9uLnogKiByb3RhdGlvbi53OwogICAgICAgIGNvbnN0IHcyID0gcm90YXRpb24udyAqIHJvdGF0aW9uLnc7CiAgICAgICAgY29uc3QgbTAwID0geDIgLSB5MiAtIHoyICsgdzI7CiAgICAgICAgY29uc3QgbTAxID0gMiAqICh4eSAtIHp3KTsKICAgICAgICBjb25zdCBtMDIgPSAyICogKHh6ICsgeXcpOwogICAgICAgIGNvbnN0IG0xMCA9IDIgKiAoeHkgKyB6dyk7CiAgICAgICAgY29uc3QgbTExID0gLXgyICsgeTIgLSB6MiArIHcyOwogICAgICAgIGNvbnN0IG0xMiA9IDIgKiAoeXogLSB4dyk7CiAgICAgICAgY29uc3QgbTIwID0gMiAqICh4eiAtIHl3KTsKICAgICAgICBjb25zdCBtMjEgPSAyICogKHl6ICsgeHcpOwogICAgICAgIGNvbnN0IG0yMiA9IC14MiAtIHkyICsgejIgKyB3MjsKICAgICAgICByZXN1bHRbMF0gPSBtMDAgKiBzY2FsZVg7CiAgICAgICAgcmVzdWx0WzFdID0gbTEwICogc2NhbGVYOwogICAgICAgIHJlc3VsdFsyXSA9IG0yMCAqIHNjYWxlWDsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IG0wMSAqIHNjYWxlWTsKICAgICAgICByZXN1bHRbNV0gPSBtMTEgKiBzY2FsZVk7CiAgICAgICAgcmVzdWx0WzZdID0gbTIxICogc2NhbGVZOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gbTAyICogc2NhbGVaOwogICAgICAgIHJlc3VsdFs5XSA9IG0xMiAqIHNjYWxlWjsKICAgICAgICByZXN1bHRbMTBdID0gbTIyICogc2NhbGVaOwogICAgICAgIHJlc3VsdFsxMV0gPSAwOwogICAgICAgIHJlc3VsdFsxMl0gPSB0cmFuc2xhdGlvbjIueDsKICAgICAgICByZXN1bHRbMTNdID0gdHJhbnNsYXRpb24yLnk7CiAgICAgICAgcmVzdWx0WzE0XSA9IHRyYW5zbGF0aW9uMi56OwogICAgICAgIHJlc3VsdFsxNV0gPSAxOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuZnJvbVRyYW5zbGF0aW9uUm90YXRpb25TY2FsZSA9IGZ1bmN0aW9uKHRyYW5zbGF0aW9uUm90YXRpb25TY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ0cmFuc2xhdGlvblJvdGF0aW9uU2NhbGUiLCB0cmFuc2xhdGlvblJvdGF0aW9uU2NhbGUpOwogICAgICAgIHJldHVybiBNYXRyaXg0LmZyb21UcmFuc2xhdGlvblF1YXRlcm5pb25Sb3RhdGlvblNjYWxlKAogICAgICAgICAgdHJhbnNsYXRpb25Sb3RhdGlvblNjYWxlLnRyYW5zbGF0aW9uLAogICAgICAgICAgdHJhbnNsYXRpb25Sb3RhdGlvblNjYWxlLnJvdGF0aW9uLAogICAgICAgICAgdHJhbnNsYXRpb25Sb3RhdGlvblNjYWxlLnNjYWxlLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgTWF0cml4NC5mcm9tVHJhbnNsYXRpb24gPSBmdW5jdGlvbih0cmFuc2xhdGlvbjIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidHJhbnNsYXRpb24iLCB0cmFuc2xhdGlvbjIpOwogICAgICAgIHJldHVybiBNYXRyaXg0LmZyb21Sb3RhdGlvblRyYW5zbGF0aW9uKE1hdHJpeDNfZGVmYXVsdC5JREVOVElUWSwgdHJhbnNsYXRpb24yLCByZXN1bHQpOwogICAgICB9OwogICAgICBNYXRyaXg0LmZyb21TY2FsZSA9IGZ1bmN0aW9uKHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNjYWxlIiwgc2NhbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4NCgKICAgICAgICAgICAgc2NhbGUueCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgc2NhbGUueSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgc2NhbGUueiwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gc2NhbGUueDsKICAgICAgICByZXN1bHRbMV0gPSAwOwogICAgICAgIHJlc3VsdFsyXSA9IDA7CiAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICByZXN1bHRbNF0gPSAwOwogICAgICAgIHJlc3VsdFs1XSA9IHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzZdID0gMDsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IDA7CiAgICAgICAgcmVzdWx0WzldID0gMDsKICAgICAgICByZXN1bHRbMTBdID0gc2NhbGUuejsKICAgICAgICByZXN1bHRbMTFdID0gMDsKICAgICAgICByZXN1bHRbMTJdID0gMDsKICAgICAgICByZXN1bHRbMTNdID0gMDsKICAgICAgICByZXN1bHRbMTRdID0gMDsKICAgICAgICByZXN1bHRbMTVdID0gMTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LmZyb21Vbmlmb3JtU2NhbGUgPSBmdW5jdGlvbihzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDQoCiAgICAgICAgICAgIHNjYWxlLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICBzY2FsZSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgc2NhbGUsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDEKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHNjYWxlOwogICAgICAgIHJlc3VsdFsxXSA9IDA7CiAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IDA7CiAgICAgICAgcmVzdWx0WzVdID0gc2NhbGU7CiAgICAgICAgcmVzdWx0WzZdID0gMDsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IDA7CiAgICAgICAgcmVzdWx0WzldID0gMDsKICAgICAgICByZXN1bHRbMTBdID0gc2NhbGU7CiAgICAgICAgcmVzdWx0WzExXSA9IDA7CiAgICAgICAgcmVzdWx0WzEyXSA9IDA7CiAgICAgICAgcmVzdWx0WzEzXSA9IDA7CiAgICAgICAgcmVzdWx0WzE0XSA9IDA7CiAgICAgICAgcmVzdWx0WzE1XSA9IDE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5mcm9tUm90YXRpb24gPSBmdW5jdGlvbihyb3RhdGlvbiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyb3RhdGlvbiIsIHJvdGF0aW9uKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgTWF0cml4NCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSByb3RhdGlvblswXTsKICAgICAgICByZXN1bHRbMV0gPSByb3RhdGlvblsxXTsKICAgICAgICByZXN1bHRbMl0gPSByb3RhdGlvblsyXTsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IHJvdGF0aW9uWzNdOwogICAgICAgIHJlc3VsdFs1XSA9IHJvdGF0aW9uWzRdOwogICAgICAgIHJlc3VsdFs2XSA9IHJvdGF0aW9uWzVdOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gcm90YXRpb25bNl07CiAgICAgICAgcmVzdWx0WzldID0gcm90YXRpb25bN107CiAgICAgICAgcmVzdWx0WzEwXSA9IHJvdGF0aW9uWzhdOwogICAgICAgIHJlc3VsdFsxMV0gPSAwOwogICAgICAgIHJlc3VsdFsxMl0gPSAwOwogICAgICAgIHJlc3VsdFsxM10gPSAwOwogICAgICAgIHJlc3VsdFsxNF0gPSAwOwogICAgICAgIHJlc3VsdFsxNV0gPSAxOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGZyb21DYW1lcmFGID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tQ2FtZXJhUiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZnJvbUNhbWVyYVUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDQuZnJvbUNhbWVyYSA9IGZ1bmN0aW9uKGNhbWVyYSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYW1lcmEiLCBjYW1lcmEpOwogICAgICAgIGNvbnN0IHBvc2l0aW9uID0gY2FtZXJhLnBvc2l0aW9uOwogICAgICAgIGNvbnN0IGRpcmVjdGlvbjIgPSBjYW1lcmEuZGlyZWN0aW9uOwogICAgICAgIGNvbnN0IHVwID0gY2FtZXJhLnVwOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FtZXJhLnBvc2l0aW9uIiwgcG9zaXRpb24pOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FtZXJhLmRpcmVjdGlvbiIsIGRpcmVjdGlvbjIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FtZXJhLnVwIiwgdXApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZGlyZWN0aW9uMiwgZnJvbUNhbWVyYUYpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoZnJvbUNhbWVyYUYsIHVwLCBmcm9tQ2FtZXJhUiksCiAgICAgICAgICBmcm9tQ2FtZXJhUgogICAgICAgICk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhmcm9tQ2FtZXJhUiwgZnJvbUNhbWVyYUYsIGZyb21DYW1lcmFVKSwKICAgICAgICAgIGZyb21DYW1lcmFVCiAgICAgICAgKTsKICAgICAgICBjb25zdCBzWCA9IGZyb21DYW1lcmFSLng7CiAgICAgICAgY29uc3Qgc1kgPSBmcm9tQ2FtZXJhUi55OwogICAgICAgIGNvbnN0IHNaID0gZnJvbUNhbWVyYVIuejsKICAgICAgICBjb25zdCBmWCA9IGZyb21DYW1lcmFGLng7CiAgICAgICAgY29uc3QgZlkgPSBmcm9tQ2FtZXJhRi55OwogICAgICAgIGNvbnN0IGZaID0gZnJvbUNhbWVyYUYuejsKICAgICAgICBjb25zdCB1WCA9IGZyb21DYW1lcmFVLng7CiAgICAgICAgY29uc3QgdVkgPSBmcm9tQ2FtZXJhVS55OwogICAgICAgIGNvbnN0IHVaID0gZnJvbUNhbWVyYVUuejsKICAgICAgICBjb25zdCBwb3NpdGlvblggPSBwb3NpdGlvbi54OwogICAgICAgIGNvbnN0IHBvc2l0aW9uWSA9IHBvc2l0aW9uLnk7CiAgICAgICAgY29uc3QgcG9zaXRpb25aID0gcG9zaXRpb24uejsKICAgICAgICBjb25zdCB0MCA9IHNYICogLXBvc2l0aW9uWCArIHNZICogLXBvc2l0aW9uWSArIHNaICogLXBvc2l0aW9uWjsKICAgICAgICBjb25zdCB0MSA9IHVYICogLXBvc2l0aW9uWCArIHVZICogLXBvc2l0aW9uWSArIHVaICogLXBvc2l0aW9uWjsKICAgICAgICBjb25zdCB0MiA9IGZYICogcG9zaXRpb25YICsgZlkgKiBwb3NpdGlvblkgKyBmWiAqIHBvc2l0aW9uWjsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDQoCiAgICAgICAgICAgIHNYLAogICAgICAgICAgICBzWSwKICAgICAgICAgICAgc1osCiAgICAgICAgICAgIHQwLAogICAgICAgICAgICB1WCwKICAgICAgICAgICAgdVksCiAgICAgICAgICAgIHVaLAogICAgICAgICAgICB0MSwKICAgICAgICAgICAgLWZYLAogICAgICAgICAgICAtZlksCiAgICAgICAgICAgIC1mWiwKICAgICAgICAgICAgdDIsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDEKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHNYOwogICAgICAgIHJlc3VsdFsxXSA9IHVYOwogICAgICAgIHJlc3VsdFsyXSA9IC1mWDsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IHNZOwogICAgICAgIHJlc3VsdFs1XSA9IHVZOwogICAgICAgIHJlc3VsdFs2XSA9IC1mWTsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IHNaOwogICAgICAgIHJlc3VsdFs5XSA9IHVaOwogICAgICAgIHJlc3VsdFsxMF0gPSAtZlo7CiAgICAgICAgcmVzdWx0WzExXSA9IDA7CiAgICAgICAgcmVzdWx0WzEyXSA9IHQwOwogICAgICAgIHJlc3VsdFsxM10gPSB0MTsKICAgICAgICByZXN1bHRbMTRdID0gdDI7CiAgICAgICAgcmVzdWx0WzE1XSA9IDE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5jb21wdXRlUGVyc3BlY3RpdmVGaWVsZE9mVmlldyA9IGZ1bmN0aW9uKGZvdlksIGFzcGVjdFJhdGlvLCBuZWFyLCBmYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbigiZm92WSIsIGZvdlksIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbigiZm92WSIsIGZvdlksIE1hdGguUEkpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbigibmVhciIsIG5lYXIsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbigiZmFyIiwgZmFyLCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgYm90dG9tID0gTWF0aC50YW4oZm92WSAqIDAuNSk7CiAgICAgICAgY29uc3QgY29sdW1uMVJvdzEgPSAxIC8gYm90dG9tOwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cwID0gY29sdW1uMVJvdzEgLyBhc3BlY3RSYXRpbzsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MiA9IChmYXIgKyBuZWFyKSAvIChuZWFyIC0gZmFyKTsKICAgICAgICBjb25zdCBjb2x1bW4zUm93MiA9IDIgKiBmYXIgKiBuZWFyIC8gKG5lYXIgLSBmYXIpOwogICAgICAgIHJlc3VsdFswXSA9IGNvbHVtbjBSb3cwOwogICAgICAgIHJlc3VsdFsxXSA9IDA7CiAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IDA7CiAgICAgICAgcmVzdWx0WzVdID0gY29sdW1uMVJvdzE7CiAgICAgICAgcmVzdWx0WzZdID0gMDsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IDA7CiAgICAgICAgcmVzdWx0WzldID0gMDsKICAgICAgICByZXN1bHRbMTBdID0gY29sdW1uMlJvdzI7CiAgICAgICAgcmVzdWx0WzExXSA9IC0xOwogICAgICAgIHJlc3VsdFsxMl0gPSAwOwogICAgICAgIHJlc3VsdFsxM10gPSAwOwogICAgICAgIHJlc3VsdFsxNF0gPSBjb2x1bW4zUm93MjsKICAgICAgICByZXN1bHRbMTVdID0gMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LmNvbXB1dGVPcnRob2dyYXBoaWNPZmZDZW50ZXIgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgYm90dG9tLCB0b3AsIG5lYXIsIGZhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImJvdHRvbSIsIGJvdHRvbSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ0b3AiLCB0b3ApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibmVhciIsIG5lYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigiZmFyIiwgZmFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgbGV0IGEzID0gMSAvIChyaWdodCAtIGxlZnQpOwogICAgICAgIGxldCBiID0gMSAvICh0b3AgLSBib3R0b20pOwogICAgICAgIGxldCBjID0gMSAvIChmYXIgLSBuZWFyKTsKICAgICAgICBjb25zdCB0eCA9IC0ocmlnaHQgKyBsZWZ0KSAqIGEzOwogICAgICAgIGNvbnN0IHR5ID0gLSh0b3AgKyBib3R0b20pICogYjsKICAgICAgICBjb25zdCB0eiA9IC0oZmFyICsgbmVhcikgKiBjOwogICAgICAgIGEzICo9IDI7CiAgICAgICAgYiAqPSAyOwogICAgICAgIGMgKj0gLTI7CiAgICAgICAgcmVzdWx0WzBdID0gYTM7CiAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICByZXN1bHRbMl0gPSAwOwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gMDsKICAgICAgICByZXN1bHRbNV0gPSBiOwogICAgICAgIHJlc3VsdFs2XSA9IDA7CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSAwOwogICAgICAgIHJlc3VsdFs5XSA9IDA7CiAgICAgICAgcmVzdWx0WzEwXSA9IGM7CiAgICAgICAgcmVzdWx0WzExXSA9IDA7CiAgICAgICAgcmVzdWx0WzEyXSA9IHR4OwogICAgICAgIHJlc3VsdFsxM10gPSB0eTsKICAgICAgICByZXN1bHRbMTRdID0gdHo7CiAgICAgICAgcmVzdWx0WzE1XSA9IDE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5jb21wdXRlUGVyc3BlY3RpdmVPZmZDZW50ZXIgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgYm90dG9tLCB0b3AsIG5lYXIsIGZhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImJvdHRvbSIsIGJvdHRvbSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ0b3AiLCB0b3ApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibmVhciIsIG5lYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigiZmFyIiwgZmFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzAgPSAyICogbmVhciAvIChyaWdodCAtIGxlZnQpOwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cxID0gMiAqIG5lYXIgLyAodG9wIC0gYm90dG9tKTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MCA9IChyaWdodCArIGxlZnQpIC8gKHJpZ2h0IC0gbGVmdCk7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzEgPSAodG9wICsgYm90dG9tKSAvICh0b3AgLSBib3R0b20pOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cyID0gLShmYXIgKyBuZWFyKSAvIChmYXIgLSBuZWFyKTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MyA9IC0xOwogICAgICAgIGNvbnN0IGNvbHVtbjNSb3cyID0gLTIgKiBmYXIgKiBuZWFyIC8gKGZhciAtIG5lYXIpOwogICAgICAgIHJlc3VsdFswXSA9IGNvbHVtbjBSb3cwOwogICAgICAgIHJlc3VsdFsxXSA9IDA7CiAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IDA7CiAgICAgICAgcmVzdWx0WzVdID0gY29sdW1uMVJvdzE7CiAgICAgICAgcmVzdWx0WzZdID0gMDsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IGNvbHVtbjJSb3cwOwogICAgICAgIHJlc3VsdFs5XSA9IGNvbHVtbjJSb3cxOwogICAgICAgIHJlc3VsdFsxMF0gPSBjb2x1bW4yUm93MjsKICAgICAgICByZXN1bHRbMTFdID0gY29sdW1uMlJvdzM7CiAgICAgICAgcmVzdWx0WzEyXSA9IDA7CiAgICAgICAgcmVzdWx0WzEzXSA9IDA7CiAgICAgICAgcmVzdWx0WzE0XSA9IGNvbHVtbjNSb3cyOwogICAgICAgIHJlc3VsdFsxNV0gPSAwOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuY29tcHV0ZUluZmluaXRlUGVyc3BlY3RpdmVPZmZDZW50ZXIgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgYm90dG9tLCB0b3AsIG5lYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJib3R0b20iLCBib3R0b20pOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigidG9wIiwgdG9wKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIm5lYXIiLCBuZWFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzAgPSAyICogbmVhciAvIChyaWdodCAtIGxlZnQpOwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cxID0gMiAqIG5lYXIgLyAodG9wIC0gYm90dG9tKTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MCA9IChyaWdodCArIGxlZnQpIC8gKHJpZ2h0IC0gbGVmdCk7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzEgPSAodG9wICsgYm90dG9tKSAvICh0b3AgLSBib3R0b20pOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cyID0gLTE7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzMgPSAtMTsKICAgICAgICBjb25zdCBjb2x1bW4zUm93MiA9IC0yICogbmVhcjsKICAgICAgICByZXN1bHRbMF0gPSBjb2x1bW4wUm93MDsKICAgICAgICByZXN1bHRbMV0gPSAwOwogICAgICAgIHJlc3VsdFsyXSA9IDA7CiAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICByZXN1bHRbNF0gPSAwOwogICAgICAgIHJlc3VsdFs1XSA9IGNvbHVtbjFSb3cxOwogICAgICAgIHJlc3VsdFs2XSA9IDA7CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSBjb2x1bW4yUm93MDsKICAgICAgICByZXN1bHRbOV0gPSBjb2x1bW4yUm93MTsKICAgICAgICByZXN1bHRbMTBdID0gY29sdW1uMlJvdzI7CiAgICAgICAgcmVzdWx0WzExXSA9IGNvbHVtbjJSb3czOwogICAgICAgIHJlc3VsdFsxMl0gPSAwOwogICAgICAgIHJlc3VsdFsxM10gPSAwOwogICAgICAgIHJlc3VsdFsxNF0gPSBjb2x1bW4zUm93MjsKICAgICAgICByZXN1bHRbMTVdID0gMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LmNvbXB1dGVWaWV3cG9ydFRyYW5zZm9ybWF0aW9uID0gZnVuY3Rpb24odmlld3BvcnQsIG5lYXJEZXB0aFJhbmdlLCBmYXJEZXB0aFJhbmdlLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgTWF0cml4NCgpOwogICAgICAgIH0KICAgICAgICB2aWV3cG9ydCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHZpZXdwb3J0LCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGNvbnN0IHggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh2aWV3cG9ydC54LCAwKTsKICAgICAgICBjb25zdCB5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmlld3BvcnQueSwgMCk7CiAgICAgICAgY29uc3Qgd2lkdGggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh2aWV3cG9ydC53aWR0aCwgMCk7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmlld3BvcnQuaGVpZ2h0LCAwKTsKICAgICAgICBuZWFyRGVwdGhSYW5nZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG5lYXJEZXB0aFJhbmdlLCAwKTsKICAgICAgICBmYXJEZXB0aFJhbmdlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZmFyRGVwdGhSYW5nZSwgMSk7CiAgICAgICAgY29uc3QgaGFsZldpZHRoID0gd2lkdGggKiAwLjU7CiAgICAgICAgY29uc3QgaGFsZkhlaWdodCA9IGhlaWdodCAqIDAuNTsKICAgICAgICBjb25zdCBoYWxmRGVwdGggPSAoZmFyRGVwdGhSYW5nZSAtIG5lYXJEZXB0aFJhbmdlKSAqIDAuNTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MCA9IGhhbGZXaWR0aDsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MSA9IGhhbGZIZWlnaHQ7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzIgPSBoYWxmRGVwdGg7CiAgICAgICAgY29uc3QgY29sdW1uM1JvdzAgPSB4ICsgaGFsZldpZHRoOwogICAgICAgIGNvbnN0IGNvbHVtbjNSb3cxID0geSArIGhhbGZIZWlnaHQ7CiAgICAgICAgY29uc3QgY29sdW1uM1JvdzIgPSBuZWFyRGVwdGhSYW5nZSArIGhhbGZEZXB0aDsKICAgICAgICBjb25zdCBjb2x1bW4zUm93MyA9IDE7CiAgICAgICAgcmVzdWx0WzBdID0gY29sdW1uMFJvdzA7CiAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICByZXN1bHRbMl0gPSAwOwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gMDsKICAgICAgICByZXN1bHRbNV0gPSBjb2x1bW4xUm93MTsKICAgICAgICByZXN1bHRbNl0gPSAwOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gMDsKICAgICAgICByZXN1bHRbOV0gPSAwOwogICAgICAgIHJlc3VsdFsxMF0gPSBjb2x1bW4yUm93MjsKICAgICAgICByZXN1bHRbMTFdID0gMDsKICAgICAgICByZXN1bHRbMTJdID0gY29sdW1uM1JvdzA7CiAgICAgICAgcmVzdWx0WzEzXSA9IGNvbHVtbjNSb3cxOwogICAgICAgIHJlc3VsdFsxNF0gPSBjb2x1bW4zUm93MjsKICAgICAgICByZXN1bHRbMTVdID0gY29sdW1uM1JvdzM7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5jb21wdXRlVmlldyA9IGZ1bmN0aW9uKHBvc2l0aW9uLCBkaXJlY3Rpb24yLCB1cCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicG9zaXRpb24iLCBwb3NpdGlvbik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJkaXJlY3Rpb24iLCBkaXJlY3Rpb24yKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInVwIiwgdXApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0WzFdID0gdXAueDsKICAgICAgICByZXN1bHRbMl0gPSAtZGlyZWN0aW9uMi54OwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gcmlnaHQueTsKICAgICAgICByZXN1bHRbNV0gPSB1cC55OwogICAgICAgIHJlc3VsdFs2XSA9IC1kaXJlY3Rpb24yLnk7CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSByaWdodC56OwogICAgICAgIHJlc3VsdFs5XSA9IHVwLno7CiAgICAgICAgcmVzdWx0WzEwXSA9IC1kaXJlY3Rpb24yLno7CiAgICAgICAgcmVzdWx0WzExXSA9IDA7CiAgICAgICAgcmVzdWx0WzEyXSA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHJpZ2h0LCBwb3NpdGlvbik7CiAgICAgICAgcmVzdWx0WzEzXSA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHVwLCBwb3NpdGlvbik7CiAgICAgICAgcmVzdWx0WzE0XSA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgcG9zaXRpb24pOwogICAgICAgIHJlc3VsdFsxNV0gPSAxOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQudG9BcnJheSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgIG1hdHJpeFswXSwKICAgICAgICAgICAgbWF0cml4WzFdLAogICAgICAgICAgICBtYXRyaXhbMl0sCiAgICAgICAgICAgIG1hdHJpeFszXSwKICAgICAgICAgICAgbWF0cml4WzRdLAogICAgICAgICAgICBtYXRyaXhbNV0sCiAgICAgICAgICAgIG1hdHJpeFs2XSwKICAgICAgICAgICAgbWF0cml4WzddLAogICAgICAgICAgICBtYXRyaXhbOF0sCiAgICAgICAgICAgIG1hdHJpeFs5XSwKICAgICAgICAgICAgbWF0cml4WzEwXSwKICAgICAgICAgICAgbWF0cml4WzExXSwKICAgICAgICAgICAgbWF0cml4WzEyXSwKICAgICAgICAgICAgbWF0cml4WzEzXSwKICAgICAgICAgICAgbWF0cml4WzE0XSwKICAgICAgICAgICAgbWF0cml4WzE1XQogICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXTsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl07CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeFs0XTsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNV07CiAgICAgICAgcmVzdWx0WzZdID0gbWF0cml4WzZdOwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XTsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF07CiAgICAgICAgcmVzdWx0WzldID0gbWF0cml4WzldOwogICAgICAgIHJlc3VsdFsxMF0gPSBtYXRyaXhbMTBdOwogICAgICAgIHJlc3VsdFsxMV0gPSBtYXRyaXhbMTFdOwogICAgICAgIHJlc3VsdFsxMl0gPSBtYXRyaXhbMTJdOwogICAgICAgIHJlc3VsdFsxM10gPSBtYXRyaXhbMTNdOwogICAgICAgIHJlc3VsdFsxNF0gPSBtYXRyaXhbMTRdOwogICAgICAgIHJlc3VsdFsxNV0gPSBtYXRyaXhbMTVdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuZ2V0RWxlbWVudEluZGV4ID0gZnVuY3Rpb24oY29sdW1uLCByb3cpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygicm93Iiwgcm93LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygicm93Iiwgcm93LCAzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiY29sdW1uIiwgY29sdW1uLCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiY29sdW1uIiwgY29sdW1uLCAzKTsKICAgICAgICByZXR1cm4gY29sdW1uICogNCArIHJvdzsKICAgICAgfTsKICAgICAgTWF0cml4NC5nZXRDb2x1bW4gPSBmdW5jdGlvbihtYXRyaXgsIGluZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc3RhcnRJbmRleCA9IGluZGV4ICogNDsKICAgICAgICBjb25zdCB4ID0gbWF0cml4W3N0YXJ0SW5kZXhdOwogICAgICAgIGNvbnN0IHkgPSBtYXRyaXhbc3RhcnRJbmRleCArIDFdOwogICAgICAgIGNvbnN0IHogPSBtYXRyaXhbc3RhcnRJbmRleCArIDJdOwogICAgICAgIGNvbnN0IHcgPSBtYXRyaXhbc3RhcnRJbmRleCArIDNdOwogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJlc3VsdC53ID0gdzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LnNldENvbHVtbiA9IGZ1bmN0aW9uKG1hdHJpeCwgaW5kZXgsIGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0ID0gTWF0cml4NC5jbG9uZShtYXRyaXgsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc3RhcnRJbmRleCA9IGluZGV4ICogNDsKICAgICAgICByZXN1bHRbc3RhcnRJbmRleF0gPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdFtzdGFydEluZGV4ICsgMV0gPSBjYXJ0ZXNpYW4xMS55OwogICAgICAgIHJlc3VsdFtzdGFydEluZGV4ICsgMl0gPSBjYXJ0ZXNpYW4xMS56OwogICAgICAgIHJlc3VsdFtzdGFydEluZGV4ICsgM10gPSBjYXJ0ZXNpYW4xMS53OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuZ2V0Um93ID0gZnVuY3Rpb24obWF0cml4LCBpbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHggPSBtYXRyaXhbaW5kZXhdOwogICAgICAgIGNvbnN0IHkgPSBtYXRyaXhbaW5kZXggKyA0XTsKICAgICAgICBjb25zdCB6ID0gbWF0cml4W2luZGV4ICsgOF07CiAgICAgICAgY29uc3QgdyA9IG1hdHJpeFtpbmRleCArIDEyXTsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXN1bHQudyA9IHc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5zZXRSb3cgPSBmdW5jdGlvbihtYXRyaXgsIGluZGV4LCBjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdCA9IE1hdHJpeDQuY2xvbmUobWF0cml4LCByZXN1bHQpOwogICAgICAgIHJlc3VsdFtpbmRleF0gPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdFtpbmRleCArIDRdID0gY2FydGVzaWFuMTEueTsKICAgICAgICByZXN1bHRbaW5kZXggKyA4XSA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgcmVzdWx0W2luZGV4ICsgMTJdID0gY2FydGVzaWFuMTEudzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LnNldFRyYW5zbGF0aW9uID0gZnVuY3Rpb24obWF0cml4LCB0cmFuc2xhdGlvbjIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInRyYW5zbGF0aW9uIiwgdHJhbnNsYXRpb24yKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXTsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl07CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeFs0XTsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNV07CiAgICAgICAgcmVzdWx0WzZdID0gbWF0cml4WzZdOwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XTsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF07CiAgICAgICAgcmVzdWx0WzldID0gbWF0cml4WzldOwogICAgICAgIHJlc3VsdFsxMF0gPSBtYXRyaXhbMTBdOwogICAgICAgIHJlc3VsdFsxMV0gPSBtYXRyaXhbMTFdOwogICAgICAgIHJlc3VsdFsxMl0gPSB0cmFuc2xhdGlvbjIueDsKICAgICAgICByZXN1bHRbMTNdID0gdHJhbnNsYXRpb24yLnk7CiAgICAgICAgcmVzdWx0WzE0XSA9IHRyYW5zbGF0aW9uMi56OwogICAgICAgIHJlc3VsdFsxNV0gPSBtYXRyaXhbMTVdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDEyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBNYXRyaXg0LnNldFNjYWxlID0gZnVuY3Rpb24obWF0cml4LCBzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic2NhbGUiLCBzY2FsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IGV4aXN0aW5nU2NhbGUgPSBNYXRyaXg0LmdldFNjYWxlKG1hdHJpeCwgc2NhbGVTY3JhdGNoMTIpOwogICAgICAgIGNvbnN0IHNjYWxlUmF0aW9YID0gc2NhbGUueCAvIGV4aXN0aW5nU2NhbGUueDsKICAgICAgICBjb25zdCBzY2FsZVJhdGlvWSA9IHNjYWxlLnkgLyBleGlzdGluZ1NjYWxlLnk7CiAgICAgICAgY29uc3Qgc2NhbGVSYXRpb1ogPSBzY2FsZS56IC8gZXhpc3RpbmdTY2FsZS56OwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXTsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXhbNF0gKiBzY2FsZVJhdGlvWTsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNV0gKiBzY2FsZVJhdGlvWTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbNl0gKiBzY2FsZVJhdGlvWTsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbN107CiAgICAgICAgcmVzdWx0WzhdID0gbWF0cml4WzhdICogc2NhbGVSYXRpb1o7CiAgICAgICAgcmVzdWx0WzldID0gbWF0cml4WzldICogc2NhbGVSYXRpb1o7CiAgICAgICAgcmVzdWx0WzEwXSA9IG1hdHJpeFsxMF0gKiBzY2FsZVJhdGlvWjsKICAgICAgICByZXN1bHRbMTFdID0gbWF0cml4WzExXTsKICAgICAgICByZXN1bHRbMTJdID0gbWF0cml4WzEyXTsKICAgICAgICByZXN1bHRbMTNdID0gbWF0cml4WzEzXTsKICAgICAgICByZXN1bHRbMTRdID0gbWF0cml4WzE0XTsKICAgICAgICByZXN1bHRbMTVdID0gbWF0cml4WzE1XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY2FsZVNjcmF0Y2gyMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgTWF0cml4NC5zZXRVbmlmb3JtU2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgZXhpc3RpbmdTY2FsZSA9IE1hdHJpeDQuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2gyMik7CiAgICAgICAgY29uc3Qgc2NhbGVSYXRpb1ggPSBzY2FsZSAvIGV4aXN0aW5nU2NhbGUueDsKICAgICAgICBjb25zdCBzY2FsZVJhdGlvWSA9IHNjYWxlIC8gZXhpc3RpbmdTY2FsZS55OwogICAgICAgIGNvbnN0IHNjYWxlUmF0aW9aID0gc2NhbGUgLyBleGlzdGluZ1NjYWxlLno7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeFs0XSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs2XSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XTsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF0gKiBzY2FsZVJhdGlvWjsKICAgICAgICByZXN1bHRbOV0gPSBtYXRyaXhbOV0gKiBzY2FsZVJhdGlvWjsKICAgICAgICByZXN1bHRbMTBdID0gbWF0cml4WzEwXSAqIHNjYWxlUmF0aW9aOwogICAgICAgIHJlc3VsdFsxMV0gPSBtYXRyaXhbMTFdOwogICAgICAgIHJlc3VsdFsxMl0gPSBtYXRyaXhbMTJdOwogICAgICAgIHJlc3VsdFsxM10gPSBtYXRyaXhbMTNdOwogICAgICAgIHJlc3VsdFsxNF0gPSBtYXRyaXhbMTRdOwogICAgICAgIHJlc3VsdFsxNV0gPSBtYXRyaXhbMTVdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDb2x1bW4yID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBNYXRyaXg0LmdldFNjYWxlID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tRWxlbWVudHMobWF0cml4WzBdLCBtYXRyaXhbMV0sIG1hdHJpeFsyXSwgc2NyYXRjaENvbHVtbjIpCiAgICAgICAgKTsKICAgICAgICByZXN1bHQueSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUVsZW1lbnRzKG1hdHJpeFs0XSwgbWF0cml4WzVdLCBtYXRyaXhbNl0sIHNjcmF0Y2hDb2x1bW4yKQogICAgICAgICk7CiAgICAgICAgcmVzdWx0LnogPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21FbGVtZW50cyhtYXRyaXhbOF0sIG1hdHJpeFs5XSwgbWF0cml4WzEwXSwgc2NyYXRjaENvbHVtbjIpCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY2FsZVNjcmF0Y2gzMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgTWF0cml4NC5nZXRNYXhpbXVtU2NhbGUgPSBmdW5jdGlvbihtYXRyaXgpIHsKICAgICAgICBNYXRyaXg0LmdldFNjYWxlKG1hdHJpeCwgc2NhbGVTY3JhdGNoMzIpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQubWF4aW11bUNvbXBvbmVudChzY2FsZVNjcmF0Y2gzMik7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDQyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBNYXRyaXg0LnNldFJvdGF0aW9uID0gZnVuY3Rpb24obWF0cml4LCByb3RhdGlvbiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBzY2FsZSA9IE1hdHJpeDQuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2g0Mik7CiAgICAgICAgcmVzdWx0WzBdID0gcm90YXRpb25bMF0gKiBzY2FsZS54OwogICAgICAgIHJlc3VsdFsxXSA9IHJvdGF0aW9uWzFdICogc2NhbGUueDsKICAgICAgICByZXN1bHRbMl0gPSByb3RhdGlvblsyXSAqIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IHJvdGF0aW9uWzNdICogc2NhbGUueTsKICAgICAgICByZXN1bHRbNV0gPSByb3RhdGlvbls0XSAqIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzZdID0gcm90YXRpb25bNV0gKiBzY2FsZS55OwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XTsKICAgICAgICByZXN1bHRbOF0gPSByb3RhdGlvbls2XSAqIHNjYWxlLno7CiAgICAgICAgcmVzdWx0WzldID0gcm90YXRpb25bN10gKiBzY2FsZS56OwogICAgICAgIHJlc3VsdFsxMF0gPSByb3RhdGlvbls4XSAqIHNjYWxlLno7CiAgICAgICAgcmVzdWx0WzExXSA9IG1hdHJpeFsxMV07CiAgICAgICAgcmVzdWx0WzEyXSA9IG1hdHJpeFsxMl07CiAgICAgICAgcmVzdWx0WzEzXSA9IG1hdHJpeFsxM107CiAgICAgICAgcmVzdWx0WzE0XSA9IG1hdHJpeFsxNF07CiAgICAgICAgcmVzdWx0WzE1XSA9IG1hdHJpeFsxNV07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NhbGVTY3JhdGNoNTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDQuZ2V0Um90YXRpb24gPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc2NhbGUgPSBNYXRyaXg0LmdldFNjYWxlKG1hdHJpeCwgc2NhbGVTY3JhdGNoNTIpOwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAvIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdIC8gc2NhbGUueDsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl0gLyBzY2FsZS54OwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFs0XSAvIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzVdIC8gc2NhbGUueTsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNl0gLyBzY2FsZS55OwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs4XSAvIHNjYWxlLno7CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzldIC8gc2NhbGUuejsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbMTBdIC8gc2NhbGUuejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0Lm11bHRpcGx5ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IGxlZnQwID0gbGVmdFswXTsKICAgICAgICBjb25zdCBsZWZ0MSA9IGxlZnRbMV07CiAgICAgICAgY29uc3QgbGVmdDIgPSBsZWZ0WzJdOwogICAgICAgIGNvbnN0IGxlZnQzID0gbGVmdFszXTsKICAgICAgICBjb25zdCBsZWZ0NCA9IGxlZnRbNF07CiAgICAgICAgY29uc3QgbGVmdDUgPSBsZWZ0WzVdOwogICAgICAgIGNvbnN0IGxlZnQ2ID0gbGVmdFs2XTsKICAgICAgICBjb25zdCBsZWZ0NyA9IGxlZnRbN107CiAgICAgICAgY29uc3QgbGVmdDggPSBsZWZ0WzhdOwogICAgICAgIGNvbnN0IGxlZnQ5ID0gbGVmdFs5XTsKICAgICAgICBjb25zdCBsZWZ0MTAgPSBsZWZ0WzEwXTsKICAgICAgICBjb25zdCBsZWZ0MTEgPSBsZWZ0WzExXTsKICAgICAgICBjb25zdCBsZWZ0MTIgPSBsZWZ0WzEyXTsKICAgICAgICBjb25zdCBsZWZ0MTMgPSBsZWZ0WzEzXTsKICAgICAgICBjb25zdCBsZWZ0MTQgPSBsZWZ0WzE0XTsKICAgICAgICBjb25zdCBsZWZ0MTUgPSBsZWZ0WzE1XTsKICAgICAgICBjb25zdCByaWdodDAgPSByaWdodFswXTsKICAgICAgICBjb25zdCByaWdodDEgPSByaWdodFsxXTsKICAgICAgICBjb25zdCByaWdodDIgPSByaWdodFsyXTsKICAgICAgICBjb25zdCByaWdodDMgPSByaWdodFszXTsKICAgICAgICBjb25zdCByaWdodDQgPSByaWdodFs0XTsKICAgICAgICBjb25zdCByaWdodDUgPSByaWdodFs1XTsKICAgICAgICBjb25zdCByaWdodDYgPSByaWdodFs2XTsKICAgICAgICBjb25zdCByaWdodDcgPSByaWdodFs3XTsKICAgICAgICBjb25zdCByaWdodDggPSByaWdodFs4XTsKICAgICAgICBjb25zdCByaWdodDkgPSByaWdodFs5XTsKICAgICAgICBjb25zdCByaWdodDEwID0gcmlnaHRbMTBdOwogICAgICAgIGNvbnN0IHJpZ2h0MTEgPSByaWdodFsxMV07CiAgICAgICAgY29uc3QgcmlnaHQxMiA9IHJpZ2h0WzEyXTsKICAgICAgICBjb25zdCByaWdodDEzID0gcmlnaHRbMTNdOwogICAgICAgIGNvbnN0IHJpZ2h0MTQgPSByaWdodFsxNF07CiAgICAgICAgY29uc3QgcmlnaHQxNSA9IHJpZ2h0WzE1XTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MCA9IGxlZnQwICogcmlnaHQwICsgbGVmdDQgKiByaWdodDEgKyBsZWZ0OCAqIHJpZ2h0MiArIGxlZnQxMiAqIHJpZ2h0MzsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MSA9IGxlZnQxICogcmlnaHQwICsgbGVmdDUgKiByaWdodDEgKyBsZWZ0OSAqIHJpZ2h0MiArIGxlZnQxMyAqIHJpZ2h0MzsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MiA9IGxlZnQyICogcmlnaHQwICsgbGVmdDYgKiByaWdodDEgKyBsZWZ0MTAgKiByaWdodDIgKyBsZWZ0MTQgKiByaWdodDM7CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzMgPSBsZWZ0MyAqIHJpZ2h0MCArIGxlZnQ3ICogcmlnaHQxICsgbGVmdDExICogcmlnaHQyICsgbGVmdDE1ICogcmlnaHQzOwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cwID0gbGVmdDAgKiByaWdodDQgKyBsZWZ0NCAqIHJpZ2h0NSArIGxlZnQ4ICogcmlnaHQ2ICsgbGVmdDEyICogcmlnaHQ3OwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cxID0gbGVmdDEgKiByaWdodDQgKyBsZWZ0NSAqIHJpZ2h0NSArIGxlZnQ5ICogcmlnaHQ2ICsgbGVmdDEzICogcmlnaHQ3OwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cyID0gbGVmdDIgKiByaWdodDQgKyBsZWZ0NiAqIHJpZ2h0NSArIGxlZnQxMCAqIHJpZ2h0NiArIGxlZnQxNCAqIHJpZ2h0NzsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MyA9IGxlZnQzICogcmlnaHQ0ICsgbGVmdDcgKiByaWdodDUgKyBsZWZ0MTEgKiByaWdodDYgKyBsZWZ0MTUgKiByaWdodDc7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzAgPSBsZWZ0MCAqIHJpZ2h0OCArIGxlZnQ0ICogcmlnaHQ5ICsgbGVmdDggKiByaWdodDEwICsgbGVmdDEyICogcmlnaHQxMTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MSA9IGxlZnQxICogcmlnaHQ4ICsgbGVmdDUgKiByaWdodDkgKyBsZWZ0OSAqIHJpZ2h0MTAgKyBsZWZ0MTMgKiByaWdodDExOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cyID0gbGVmdDIgKiByaWdodDggKyBsZWZ0NiAqIHJpZ2h0OSArIGxlZnQxMCAqIHJpZ2h0MTAgKyBsZWZ0MTQgKiByaWdodDExOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3czID0gbGVmdDMgKiByaWdodDggKyBsZWZ0NyAqIHJpZ2h0OSArIGxlZnQxMSAqIHJpZ2h0MTAgKyBsZWZ0MTUgKiByaWdodDExOwogICAgICAgIGNvbnN0IGNvbHVtbjNSb3cwID0gbGVmdDAgKiByaWdodDEyICsgbGVmdDQgKiByaWdodDEzICsgbGVmdDggKiByaWdodDE0ICsgbGVmdDEyICogcmlnaHQxNTsKICAgICAgICBjb25zdCBjb2x1bW4zUm93MSA9IGxlZnQxICogcmlnaHQxMiArIGxlZnQ1ICogcmlnaHQxMyArIGxlZnQ5ICogcmlnaHQxNCArIGxlZnQxMyAqIHJpZ2h0MTU7CiAgICAgICAgY29uc3QgY29sdW1uM1JvdzIgPSBsZWZ0MiAqIHJpZ2h0MTIgKyBsZWZ0NiAqIHJpZ2h0MTMgKyBsZWZ0MTAgKiByaWdodDE0ICsgbGVmdDE0ICogcmlnaHQxNTsKICAgICAgICBjb25zdCBjb2x1bW4zUm93MyA9IGxlZnQzICogcmlnaHQxMiArIGxlZnQ3ICogcmlnaHQxMyArIGxlZnQxMSAqIHJpZ2h0MTQgKyBsZWZ0MTUgKiByaWdodDE1OwogICAgICAgIHJlc3VsdFswXSA9IGNvbHVtbjBSb3cwOwogICAgICAgIHJlc3VsdFsxXSA9IGNvbHVtbjBSb3cxOwogICAgICAgIHJlc3VsdFsyXSA9IGNvbHVtbjBSb3cyOwogICAgICAgIHJlc3VsdFszXSA9IGNvbHVtbjBSb3czOwogICAgICAgIHJlc3VsdFs0XSA9IGNvbHVtbjFSb3cwOwogICAgICAgIHJlc3VsdFs1XSA9IGNvbHVtbjFSb3cxOwogICAgICAgIHJlc3VsdFs2XSA9IGNvbHVtbjFSb3cyOwogICAgICAgIHJlc3VsdFs3XSA9IGNvbHVtbjFSb3czOwogICAgICAgIHJlc3VsdFs4XSA9IGNvbHVtbjJSb3cwOwogICAgICAgIHJlc3VsdFs5XSA9IGNvbHVtbjJSb3cxOwogICAgICAgIHJlc3VsdFsxMF0gPSBjb2x1bW4yUm93MjsKICAgICAgICByZXN1bHRbMTFdID0gY29sdW1uMlJvdzM7CiAgICAgICAgcmVzdWx0WzEyXSA9IGNvbHVtbjNSb3cwOwogICAgICAgIHJlc3VsdFsxM10gPSBjb2x1bW4zUm93MTsKICAgICAgICByZXN1bHRbMTRdID0gY29sdW1uM1JvdzI7CiAgICAgICAgcmVzdWx0WzE1XSA9IGNvbHVtbjNSb3czOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuYWRkID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IGxlZnRbMF0gKyByaWdodFswXTsKICAgICAgICByZXN1bHRbMV0gPSBsZWZ0WzFdICsgcmlnaHRbMV07CiAgICAgICAgcmVzdWx0WzJdID0gbGVmdFsyXSArIHJpZ2h0WzJdOwogICAgICAgIHJlc3VsdFszXSA9IGxlZnRbM10gKyByaWdodFszXTsKICAgICAgICByZXN1bHRbNF0gPSBsZWZ0WzRdICsgcmlnaHRbNF07CiAgICAgICAgcmVzdWx0WzVdID0gbGVmdFs1XSArIHJpZ2h0WzVdOwogICAgICAgIHJlc3VsdFs2XSA9IGxlZnRbNl0gKyByaWdodFs2XTsKICAgICAgICByZXN1bHRbN10gPSBsZWZ0WzddICsgcmlnaHRbN107CiAgICAgICAgcmVzdWx0WzhdID0gbGVmdFs4XSArIHJpZ2h0WzhdOwogICAgICAgIHJlc3VsdFs5XSA9IGxlZnRbOV0gKyByaWdodFs5XTsKICAgICAgICByZXN1bHRbMTBdID0gbGVmdFsxMF0gKyByaWdodFsxMF07CiAgICAgICAgcmVzdWx0WzExXSA9IGxlZnRbMTFdICsgcmlnaHRbMTFdOwogICAgICAgIHJlc3VsdFsxMl0gPSBsZWZ0WzEyXSArIHJpZ2h0WzEyXTsKICAgICAgICByZXN1bHRbMTNdID0gbGVmdFsxM10gKyByaWdodFsxM107CiAgICAgICAgcmVzdWx0WzE0XSA9IGxlZnRbMTRdICsgcmlnaHRbMTRdOwogICAgICAgIHJlc3VsdFsxNV0gPSBsZWZ0WzE1XSArIHJpZ2h0WzE1XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LnN1YnRyYWN0ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IGxlZnRbMF0gLSByaWdodFswXTsKICAgICAgICByZXN1bHRbMV0gPSBsZWZ0WzFdIC0gcmlnaHRbMV07CiAgICAgICAgcmVzdWx0WzJdID0gbGVmdFsyXSAtIHJpZ2h0WzJdOwogICAgICAgIHJlc3VsdFszXSA9IGxlZnRbM10gLSByaWdodFszXTsKICAgICAgICByZXN1bHRbNF0gPSBsZWZ0WzRdIC0gcmlnaHRbNF07CiAgICAgICAgcmVzdWx0WzVdID0gbGVmdFs1XSAtIHJpZ2h0WzVdOwogICAgICAgIHJlc3VsdFs2XSA9IGxlZnRbNl0gLSByaWdodFs2XTsKICAgICAgICByZXN1bHRbN10gPSBsZWZ0WzddIC0gcmlnaHRbN107CiAgICAgICAgcmVzdWx0WzhdID0gbGVmdFs4XSAtIHJpZ2h0WzhdOwogICAgICAgIHJlc3VsdFs5XSA9IGxlZnRbOV0gLSByaWdodFs5XTsKICAgICAgICByZXN1bHRbMTBdID0gbGVmdFsxMF0gLSByaWdodFsxMF07CiAgICAgICAgcmVzdWx0WzExXSA9IGxlZnRbMTFdIC0gcmlnaHRbMTFdOwogICAgICAgIHJlc3VsdFsxMl0gPSBsZWZ0WzEyXSAtIHJpZ2h0WzEyXTsKICAgICAgICByZXN1bHRbMTNdID0gbGVmdFsxM10gLSByaWdodFsxM107CiAgICAgICAgcmVzdWx0WzE0XSA9IGxlZnRbMTRdIC0gcmlnaHRbMTRdOwogICAgICAgIHJlc3VsdFsxNV0gPSBsZWZ0WzE1XSAtIHJpZ2h0WzE1XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0Lm11bHRpcGx5VHJhbnNmb3JtYXRpb24gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgbGVmdDAgPSBsZWZ0WzBdOwogICAgICAgIGNvbnN0IGxlZnQxID0gbGVmdFsxXTsKICAgICAgICBjb25zdCBsZWZ0MiA9IGxlZnRbMl07CiAgICAgICAgY29uc3QgbGVmdDQgPSBsZWZ0WzRdOwogICAgICAgIGNvbnN0IGxlZnQ1ID0gbGVmdFs1XTsKICAgICAgICBjb25zdCBsZWZ0NiA9IGxlZnRbNl07CiAgICAgICAgY29uc3QgbGVmdDggPSBsZWZ0WzhdOwogICAgICAgIGNvbnN0IGxlZnQ5ID0gbGVmdFs5XTsKICAgICAgICBjb25zdCBsZWZ0MTAgPSBsZWZ0WzEwXTsKICAgICAgICBjb25zdCBsZWZ0MTIgPSBsZWZ0WzEyXTsKICAgICAgICBjb25zdCBsZWZ0MTMgPSBsZWZ0WzEzXTsKICAgICAgICBjb25zdCBsZWZ0MTQgPSBsZWZ0WzE0XTsKICAgICAgICBjb25zdCByaWdodDAgPSByaWdodFswXTsKICAgICAgICBjb25zdCByaWdodDEgPSByaWdodFsxXTsKICAgICAgICBjb25zdCByaWdodDIgPSByaWdodFsyXTsKICAgICAgICBjb25zdCByaWdodDQgPSByaWdodFs0XTsKICAgICAgICBjb25zdCByaWdodDUgPSByaWdodFs1XTsKICAgICAgICBjb25zdCByaWdodDYgPSByaWdodFs2XTsKICAgICAgICBjb25zdCByaWdodDggPSByaWdodFs4XTsKICAgICAgICBjb25zdCByaWdodDkgPSByaWdodFs5XTsKICAgICAgICBjb25zdCByaWdodDEwID0gcmlnaHRbMTBdOwogICAgICAgIGNvbnN0IHJpZ2h0MTIgPSByaWdodFsxMl07CiAgICAgICAgY29uc3QgcmlnaHQxMyA9IHJpZ2h0WzEzXTsKICAgICAgICBjb25zdCByaWdodDE0ID0gcmlnaHRbMTRdOwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cwID0gbGVmdDAgKiByaWdodDAgKyBsZWZ0NCAqIHJpZ2h0MSArIGxlZnQ4ICogcmlnaHQyOwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cxID0gbGVmdDEgKiByaWdodDAgKyBsZWZ0NSAqIHJpZ2h0MSArIGxlZnQ5ICogcmlnaHQyOwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cyID0gbGVmdDIgKiByaWdodDAgKyBsZWZ0NiAqIHJpZ2h0MSArIGxlZnQxMCAqIHJpZ2h0MjsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MCA9IGxlZnQwICogcmlnaHQ0ICsgbGVmdDQgKiByaWdodDUgKyBsZWZ0OCAqIHJpZ2h0NjsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MSA9IGxlZnQxICogcmlnaHQ0ICsgbGVmdDUgKiByaWdodDUgKyBsZWZ0OSAqIHJpZ2h0NjsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MiA9IGxlZnQyICogcmlnaHQ0ICsgbGVmdDYgKiByaWdodDUgKyBsZWZ0MTAgKiByaWdodDY7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzAgPSBsZWZ0MCAqIHJpZ2h0OCArIGxlZnQ0ICogcmlnaHQ5ICsgbGVmdDggKiByaWdodDEwOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cxID0gbGVmdDEgKiByaWdodDggKyBsZWZ0NSAqIHJpZ2h0OSArIGxlZnQ5ICogcmlnaHQxMDsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MiA9IGxlZnQyICogcmlnaHQ4ICsgbGVmdDYgKiByaWdodDkgKyBsZWZ0MTAgKiByaWdodDEwOwogICAgICAgIGNvbnN0IGNvbHVtbjNSb3cwID0gbGVmdDAgKiByaWdodDEyICsgbGVmdDQgKiByaWdodDEzICsgbGVmdDggKiByaWdodDE0ICsgbGVmdDEyOwogICAgICAgIGNvbnN0IGNvbHVtbjNSb3cxID0gbGVmdDEgKiByaWdodDEyICsgbGVmdDUgKiByaWdodDEzICsgbGVmdDkgKiByaWdodDE0ICsgbGVmdDEzOwogICAgICAgIGNvbnN0IGNvbHVtbjNSb3cyID0gbGVmdDIgKiByaWdodDEyICsgbGVmdDYgKiByaWdodDEzICsgbGVmdDEwICogcmlnaHQxNCArIGxlZnQxNDsKICAgICAgICByZXN1bHRbMF0gPSBjb2x1bW4wUm93MDsKICAgICAgICByZXN1bHRbMV0gPSBjb2x1bW4wUm93MTsKICAgICAgICByZXN1bHRbMl0gPSBjb2x1bW4wUm93MjsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IGNvbHVtbjFSb3cwOwogICAgICAgIHJlc3VsdFs1XSA9IGNvbHVtbjFSb3cxOwogICAgICAgIHJlc3VsdFs2XSA9IGNvbHVtbjFSb3cyOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gY29sdW1uMlJvdzA7CiAgICAgICAgcmVzdWx0WzldID0gY29sdW1uMlJvdzE7CiAgICAgICAgcmVzdWx0WzEwXSA9IGNvbHVtbjJSb3cyOwogICAgICAgIHJlc3VsdFsxMV0gPSAwOwogICAgICAgIHJlc3VsdFsxMl0gPSBjb2x1bW4zUm93MDsKICAgICAgICByZXN1bHRbMTNdID0gY29sdW1uM1JvdzE7CiAgICAgICAgcmVzdWx0WzE0XSA9IGNvbHVtbjNSb3cyOwogICAgICAgIHJlc3VsdFsxNV0gPSAxOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQubXVsdGlwbHlCeU1hdHJpeDMgPSBmdW5jdGlvbihtYXRyaXgsIHJvdGF0aW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyb3RhdGlvbiIsIHJvdGF0aW9uKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgbGVmdDAgPSBtYXRyaXhbMF07CiAgICAgICAgY29uc3QgbGVmdDEgPSBtYXRyaXhbMV07CiAgICAgICAgY29uc3QgbGVmdDIgPSBtYXRyaXhbMl07CiAgICAgICAgY29uc3QgbGVmdDQgPSBtYXRyaXhbNF07CiAgICAgICAgY29uc3QgbGVmdDUgPSBtYXRyaXhbNV07CiAgICAgICAgY29uc3QgbGVmdDYgPSBtYXRyaXhbNl07CiAgICAgICAgY29uc3QgbGVmdDggPSBtYXRyaXhbOF07CiAgICAgICAgY29uc3QgbGVmdDkgPSBtYXRyaXhbOV07CiAgICAgICAgY29uc3QgbGVmdDEwID0gbWF0cml4WzEwXTsKICAgICAgICBjb25zdCByaWdodDAgPSByb3RhdGlvblswXTsKICAgICAgICBjb25zdCByaWdodDEgPSByb3RhdGlvblsxXTsKICAgICAgICBjb25zdCByaWdodDIgPSByb3RhdGlvblsyXTsKICAgICAgICBjb25zdCByaWdodDQgPSByb3RhdGlvblszXTsKICAgICAgICBjb25zdCByaWdodDUgPSByb3RhdGlvbls0XTsKICAgICAgICBjb25zdCByaWdodDYgPSByb3RhdGlvbls1XTsKICAgICAgICBjb25zdCByaWdodDggPSByb3RhdGlvbls2XTsKICAgICAgICBjb25zdCByaWdodDkgPSByb3RhdGlvbls3XTsKICAgICAgICBjb25zdCByaWdodDEwID0gcm90YXRpb25bOF07CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzAgPSBsZWZ0MCAqIHJpZ2h0MCArIGxlZnQ0ICogcmlnaHQxICsgbGVmdDggKiByaWdodDI7CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzEgPSBsZWZ0MSAqIHJpZ2h0MCArIGxlZnQ1ICogcmlnaHQxICsgbGVmdDkgKiByaWdodDI7CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzIgPSBsZWZ0MiAqIHJpZ2h0MCArIGxlZnQ2ICogcmlnaHQxICsgbGVmdDEwICogcmlnaHQyOwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cwID0gbGVmdDAgKiByaWdodDQgKyBsZWZ0NCAqIHJpZ2h0NSArIGxlZnQ4ICogcmlnaHQ2OwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cxID0gbGVmdDEgKiByaWdodDQgKyBsZWZ0NSAqIHJpZ2h0NSArIGxlZnQ5ICogcmlnaHQ2OwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cyID0gbGVmdDIgKiByaWdodDQgKyBsZWZ0NiAqIHJpZ2h0NSArIGxlZnQxMCAqIHJpZ2h0NjsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MCA9IGxlZnQwICogcmlnaHQ4ICsgbGVmdDQgKiByaWdodDkgKyBsZWZ0OCAqIHJpZ2h0MTA7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzEgPSBsZWZ0MSAqIHJpZ2h0OCArIGxlZnQ1ICogcmlnaHQ5ICsgbGVmdDkgKiByaWdodDEwOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cyID0gbGVmdDIgKiByaWdodDggKyBsZWZ0NiAqIHJpZ2h0OSArIGxlZnQxMCAqIHJpZ2h0MTA7CiAgICAgICAgcmVzdWx0WzBdID0gY29sdW1uMFJvdzA7CiAgICAgICAgcmVzdWx0WzFdID0gY29sdW1uMFJvdzE7CiAgICAgICAgcmVzdWx0WzJdID0gY29sdW1uMFJvdzI7CiAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICByZXN1bHRbNF0gPSBjb2x1bW4xUm93MDsKICAgICAgICByZXN1bHRbNV0gPSBjb2x1bW4xUm93MTsKICAgICAgICByZXN1bHRbNl0gPSBjb2x1bW4xUm93MjsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IGNvbHVtbjJSb3cwOwogICAgICAgIHJlc3VsdFs5XSA9IGNvbHVtbjJSb3cxOwogICAgICAgIHJlc3VsdFsxMF0gPSBjb2x1bW4yUm93MjsKICAgICAgICByZXN1bHRbMTFdID0gMDsKICAgICAgICByZXN1bHRbMTJdID0gbWF0cml4WzEyXTsKICAgICAgICByZXN1bHRbMTNdID0gbWF0cml4WzEzXTsKICAgICAgICByZXN1bHRbMTRdID0gbWF0cml4WzE0XTsKICAgICAgICByZXN1bHRbMTVdID0gbWF0cml4WzE1XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0Lm11bHRpcGx5QnlUcmFuc2xhdGlvbiA9IGZ1bmN0aW9uKG1hdHJpeCwgdHJhbnNsYXRpb24yLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ0cmFuc2xhdGlvbiIsIHRyYW5zbGF0aW9uMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHggPSB0cmFuc2xhdGlvbjIueDsKICAgICAgICBjb25zdCB5ID0gdHJhbnNsYXRpb24yLnk7CiAgICAgICAgY29uc3QgeiA9IHRyYW5zbGF0aW9uMi56OwogICAgICAgIGNvbnN0IHR4ID0geCAqIG1hdHJpeFswXSArIHkgKiBtYXRyaXhbNF0gKyB6ICogbWF0cml4WzhdICsgbWF0cml4WzEyXTsKICAgICAgICBjb25zdCB0eSA9IHggKiBtYXRyaXhbMV0gKyB5ICogbWF0cml4WzVdICsgeiAqIG1hdHJpeFs5XSArIG1hdHJpeFsxM107CiAgICAgICAgY29uc3QgdHogPSB4ICogbWF0cml4WzJdICsgeSAqIG1hdHJpeFs2XSArIHogKiBtYXRyaXhbMTBdICsgbWF0cml4WzE0XTsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM107CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzRdOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbNl07CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzddOwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFs4XTsKICAgICAgICByZXN1bHRbOV0gPSBtYXRyaXhbOV07CiAgICAgICAgcmVzdWx0WzEwXSA9IG1hdHJpeFsxMF07CiAgICAgICAgcmVzdWx0WzExXSA9IG1hdHJpeFsxMV07CiAgICAgICAgcmVzdWx0WzEyXSA9IHR4OwogICAgICAgIHJlc3VsdFsxM10gPSB0eTsKICAgICAgICByZXN1bHRbMTRdID0gdHo7CiAgICAgICAgcmVzdWx0WzE1XSA9IG1hdHJpeFsxNV07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5tdWx0aXBseUJ5U2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc2NhbGVYID0gc2NhbGUueDsKICAgICAgICBjb25zdCBzY2FsZVkgPSBzY2FsZS55OwogICAgICAgIGNvbnN0IHNjYWxlWiA9IHNjYWxlLno7CiAgICAgICAgaWYgKHNjYWxlWCA9PT0gMSAmJiBzY2FsZVkgPT09IDEgJiYgc2NhbGVaID09PSAxKSB7CiAgICAgICAgICByZXR1cm4gTWF0cml4NC5jbG9uZShtYXRyaXgsIHJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHNjYWxlWCAqIG1hdHJpeFswXTsKICAgICAgICByZXN1bHRbMV0gPSBzY2FsZVggKiBtYXRyaXhbMV07CiAgICAgICAgcmVzdWx0WzJdID0gc2NhbGVYICogbWF0cml4WzJdOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXTsKICAgICAgICByZXN1bHRbNF0gPSBzY2FsZVkgKiBtYXRyaXhbNF07CiAgICAgICAgcmVzdWx0WzVdID0gc2NhbGVZICogbWF0cml4WzVdOwogICAgICAgIHJlc3VsdFs2XSA9IHNjYWxlWSAqIG1hdHJpeFs2XTsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbN107CiAgICAgICAgcmVzdWx0WzhdID0gc2NhbGVaICogbWF0cml4WzhdOwogICAgICAgIHJlc3VsdFs5XSA9IHNjYWxlWiAqIG1hdHJpeFs5XTsKICAgICAgICByZXN1bHRbMTBdID0gc2NhbGVaICogbWF0cml4WzEwXTsKICAgICAgICByZXN1bHRbMTFdID0gbWF0cml4WzExXTsKICAgICAgICByZXN1bHRbMTJdID0gbWF0cml4WzEyXTsKICAgICAgICByZXN1bHRbMTNdID0gbWF0cml4WzEzXTsKICAgICAgICByZXN1bHRbMTRdID0gbWF0cml4WzE0XTsKICAgICAgICByZXN1bHRbMTVdID0gbWF0cml4WzE1XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0Lm11bHRpcGx5QnlVbmlmb3JtU2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdICogc2NhbGU7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdICogc2NhbGU7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdICogc2NhbGU7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeFs0XSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs2XSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XTsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbOV0gPSBtYXRyaXhbOV0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbMTBdID0gbWF0cml4WzEwXSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFsxMV0gPSBtYXRyaXhbMTFdOwogICAgICAgIHJlc3VsdFsxMl0gPSBtYXRyaXhbMTJdOwogICAgICAgIHJlc3VsdFsxM10gPSBtYXRyaXhbMTNdOwogICAgICAgIHJlc3VsdFsxNF0gPSBtYXRyaXhbMTRdOwogICAgICAgIHJlc3VsdFsxNV0gPSBtYXRyaXhbMTVdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQubXVsdGlwbHlCeVZlY3RvciA9IGZ1bmN0aW9uKG1hdHJpeCwgY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgdlggPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIGNvbnN0IHZZID0gY2FydGVzaWFuMTEueTsKICAgICAgICBjb25zdCB2WiA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgY29uc3QgdlcgPSBjYXJ0ZXNpYW4xMS53OwogICAgICAgIGNvbnN0IHggPSBtYXRyaXhbMF0gKiB2WCArIG1hdHJpeFs0XSAqIHZZICsgbWF0cml4WzhdICogdlogKyBtYXRyaXhbMTJdICogdlc7CiAgICAgICAgY29uc3QgeSA9IG1hdHJpeFsxXSAqIHZYICsgbWF0cml4WzVdICogdlkgKyBtYXRyaXhbOV0gKiB2WiArIG1hdHJpeFsxM10gKiB2VzsKICAgICAgICBjb25zdCB6ID0gbWF0cml4WzJdICogdlggKyBtYXRyaXhbNl0gKiB2WSArIG1hdHJpeFsxMF0gKiB2WiArIG1hdHJpeFsxNF0gKiB2VzsKICAgICAgICBjb25zdCB3ID0gbWF0cml4WzNdICogdlggKyBtYXRyaXhbN10gKiB2WSArIG1hdHJpeFsxMV0gKiB2WiArIG1hdHJpeFsxNV0gKiB2VzsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXN1bHQudyA9IHc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5tdWx0aXBseUJ5UG9pbnRBc1ZlY3RvciA9IGZ1bmN0aW9uKG1hdHJpeCwgY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgdlggPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIGNvbnN0IHZZID0gY2FydGVzaWFuMTEueTsKICAgICAgICBjb25zdCB2WiA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgY29uc3QgeCA9IG1hdHJpeFswXSAqIHZYICsgbWF0cml4WzRdICogdlkgKyBtYXRyaXhbOF0gKiB2WjsKICAgICAgICBjb25zdCB5ID0gbWF0cml4WzFdICogdlggKyBtYXRyaXhbNV0gKiB2WSArIG1hdHJpeFs5XSAqIHZaOwogICAgICAgIGNvbnN0IHogPSBtYXRyaXhbMl0gKiB2WCArIG1hdHJpeFs2XSAqIHZZICsgbWF0cml4WzEwXSAqIHZaOwogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQubXVsdGlwbHlCeVBvaW50ID0gZnVuY3Rpb24obWF0cml4LCBjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCB2WCA9IGNhcnRlc2lhbjExLng7CiAgICAgICAgY29uc3QgdlkgPSBjYXJ0ZXNpYW4xMS55OwogICAgICAgIGNvbnN0IHZaID0gY2FydGVzaWFuMTEuejsKICAgICAgICBjb25zdCB4ID0gbWF0cml4WzBdICogdlggKyBtYXRyaXhbNF0gKiB2WSArIG1hdHJpeFs4XSAqIHZaICsgbWF0cml4WzEyXTsKICAgICAgICBjb25zdCB5ID0gbWF0cml4WzFdICogdlggKyBtYXRyaXhbNV0gKiB2WSArIG1hdHJpeFs5XSAqIHZaICsgbWF0cml4WzEzXTsKICAgICAgICBjb25zdCB6ID0gbWF0cml4WzJdICogdlggKyBtYXRyaXhbNl0gKiB2WSArIG1hdHJpeFsxMF0gKiB2WiArIG1hdHJpeFsxNF07CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5tdWx0aXBseUJ5U2NhbGFyID0gZnVuY3Rpb24obWF0cml4LCBzY2FsYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxhciIsIHNjYWxhcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXhbNF0gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzVdID0gbWF0cml4WzVdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs2XSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbN10gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzhdID0gbWF0cml4WzhdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFs5XSA9IG1hdHJpeFs5XSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMTBdID0gbWF0cml4WzEwXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMTFdID0gbWF0cml4WzExXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMTJdID0gbWF0cml4WzEyXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMTNdID0gbWF0cml4WzEzXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMTRdID0gbWF0cml4WzE0XSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMTVdID0gbWF0cml4WzE1XSAqIHNjYWxhcjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0Lm5lZ2F0ZSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbMF0gPSAtbWF0cml4WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IC1tYXRyaXhbMV07CiAgICAgICAgcmVzdWx0WzJdID0gLW1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSAtbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IC1tYXRyaXhbNF07CiAgICAgICAgcmVzdWx0WzVdID0gLW1hdHJpeFs1XTsKICAgICAgICByZXN1bHRbNl0gPSAtbWF0cml4WzZdOwogICAgICAgIHJlc3VsdFs3XSA9IC1tYXRyaXhbN107CiAgICAgICAgcmVzdWx0WzhdID0gLW1hdHJpeFs4XTsKICAgICAgICByZXN1bHRbOV0gPSAtbWF0cml4WzldOwogICAgICAgIHJlc3VsdFsxMF0gPSAtbWF0cml4WzEwXTsKICAgICAgICByZXN1bHRbMTFdID0gLW1hdHJpeFsxMV07CiAgICAgICAgcmVzdWx0WzEyXSA9IC1tYXRyaXhbMTJdOwogICAgICAgIHJlc3VsdFsxM10gPSAtbWF0cml4WzEzXTsKICAgICAgICByZXN1bHRbMTRdID0gLW1hdHJpeFsxNF07CiAgICAgICAgcmVzdWx0WzE1XSA9IC1tYXRyaXhbMTVdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQudHJhbnNwb3NlID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IG1hdHJpeDEgPSBtYXRyaXhbMV07CiAgICAgICAgY29uc3QgbWF0cml4MiA9IG1hdHJpeFsyXTsKICAgICAgICBjb25zdCBtYXRyaXgzID0gbWF0cml4WzNdOwogICAgICAgIGNvbnN0IG1hdHJpeDYgPSBtYXRyaXhbNl07CiAgICAgICAgY29uc3QgbWF0cml4NyA9IG1hdHJpeFs3XTsKICAgICAgICBjb25zdCBtYXRyaXgxMSA9IG1hdHJpeFsxMV07CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFs0XTsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbOF07CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzEyXTsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXgxOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbOV07CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzEzXTsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXgyOwogICAgICAgIHJlc3VsdFs5XSA9IG1hdHJpeDY7CiAgICAgICAgcmVzdWx0WzEwXSA9IG1hdHJpeFsxMF07CiAgICAgICAgcmVzdWx0WzExXSA9IG1hdHJpeFsxNF07CiAgICAgICAgcmVzdWx0WzEyXSA9IG1hdHJpeDM7CiAgICAgICAgcmVzdWx0WzEzXSA9IG1hdHJpeDc7CiAgICAgICAgcmVzdWx0WzE0XSA9IG1hdHJpeDExOwogICAgICAgIHJlc3VsdFsxNV0gPSBtYXRyaXhbMTVdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuYWJzID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IE1hdGguYWJzKG1hdHJpeFswXSk7CiAgICAgICAgcmVzdWx0WzFdID0gTWF0aC5hYnMobWF0cml4WzFdKTsKICAgICAgICByZXN1bHRbMl0gPSBNYXRoLmFicyhtYXRyaXhbMl0pOwogICAgICAgIHJlc3VsdFszXSA9IE1hdGguYWJzKG1hdHJpeFszXSk7CiAgICAgICAgcmVzdWx0WzRdID0gTWF0aC5hYnMobWF0cml4WzRdKTsKICAgICAgICByZXN1bHRbNV0gPSBNYXRoLmFicyhtYXRyaXhbNV0pOwogICAgICAgIHJlc3VsdFs2XSA9IE1hdGguYWJzKG1hdHJpeFs2XSk7CiAgICAgICAgcmVzdWx0WzddID0gTWF0aC5hYnMobWF0cml4WzddKTsKICAgICAgICByZXN1bHRbOF0gPSBNYXRoLmFicyhtYXRyaXhbOF0pOwogICAgICAgIHJlc3VsdFs5XSA9IE1hdGguYWJzKG1hdHJpeFs5XSk7CiAgICAgICAgcmVzdWx0WzEwXSA9IE1hdGguYWJzKG1hdHJpeFsxMF0pOwogICAgICAgIHJlc3VsdFsxMV0gPSBNYXRoLmFicyhtYXRyaXhbMTFdKTsKICAgICAgICByZXN1bHRbMTJdID0gTWF0aC5hYnMobWF0cml4WzEyXSk7CiAgICAgICAgcmVzdWx0WzEzXSA9IE1hdGguYWJzKG1hdHJpeFsxM10pOwogICAgICAgIHJlc3VsdFsxNF0gPSBNYXRoLmFicyhtYXRyaXhbMTRdKTsKICAgICAgICByZXN1bHRbMTVdID0gTWF0aC5hYnMobWF0cml4WzE1XSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiAvLyBUcmFuc2xhdGlvbgogICAgICAgIGxlZnRbMTJdID09PSByaWdodFsxMl0gJiYgbGVmdFsxM10gPT09IHJpZ2h0WzEzXSAmJiBsZWZ0WzE0XSA9PT0gcmlnaHRbMTRdICYmIC8vIFJvdGF0aW9uL3NjYWxlCiAgICAgICAgbGVmdFswXSA9PT0gcmlnaHRbMF0gJiYgbGVmdFsxXSA9PT0gcmlnaHRbMV0gJiYgbGVmdFsyXSA9PT0gcmlnaHRbMl0gJiYgbGVmdFs0XSA9PT0gcmlnaHRbNF0gJiYgbGVmdFs1XSA9PT0gcmlnaHRbNV0gJiYgbGVmdFs2XSA9PT0gcmlnaHRbNl0gJiYgbGVmdFs4XSA9PT0gcmlnaHRbOF0gJiYgbGVmdFs5XSA9PT0gcmlnaHRbOV0gJiYgbGVmdFsxMF0gPT09IHJpZ2h0WzEwXSAmJiAvLyBCb3R0b20gcm93CiAgICAgICAgbGVmdFszXSA9PT0gcmlnaHRbM10gJiYgbGVmdFs3XSA9PT0gcmlnaHRbN10gJiYgbGVmdFsxMV0gPT09IHJpZ2h0WzExXSAmJiBsZWZ0WzE1XSA9PT0gcmlnaHRbMTVdOwogICAgICB9OwogICAgICBNYXRyaXg0LmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgZXBzaWxvbikgewogICAgICAgIGVwc2lsb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlcHNpbG9uLCAwKTsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgTWF0aC5hYnMobGVmdFswXSAtIHJpZ2h0WzBdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMV0gLSByaWdodFsxXSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzJdIC0gcmlnaHRbMl0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFszXSAtIHJpZ2h0WzNdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbNF0gLSByaWdodFs0XSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzVdIC0gcmlnaHRbNV0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFs2XSAtIHJpZ2h0WzZdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbN10gLSByaWdodFs3XSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzhdIC0gcmlnaHRbOF0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFs5XSAtIHJpZ2h0WzldKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMTBdIC0gcmlnaHRbMTBdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMTFdIC0gcmlnaHRbMTFdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMTJdIC0gcmlnaHRbMTJdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMTNdIC0gcmlnaHRbMTNdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMTRdIC0gcmlnaHRbMTRdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMTVdIC0gcmlnaHRbMTVdKSA8PSBlcHNpbG9uOwogICAgICB9OwogICAgICBNYXRyaXg0LmdldFRyYW5zbGF0aW9uID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbWF0cml4WzEyXTsKICAgICAgICByZXN1bHQueSA9IG1hdHJpeFsxM107CiAgICAgICAgcmVzdWx0LnogPSBtYXRyaXhbMTRdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuZ2V0TWF0cml4MyA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbNF07CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzVdOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs2XTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbOF07CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzldOwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFsxMF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaEludmVyc2VSb3RhdGlvbiA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE1hdHJpeDNaZXJvID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQm90dG9tUm93ID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRXhwZWN0ZWRCb3R0b21Sb3cgPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KDAsIDAsIDAsIDEpOwogICAgICBNYXRyaXg0LmludmVyc2UgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc3JjMCA9IG1hdHJpeFswXTsKICAgICAgICBjb25zdCBzcmMxID0gbWF0cml4WzRdOwogICAgICAgIGNvbnN0IHNyYzIgPSBtYXRyaXhbOF07CiAgICAgICAgY29uc3Qgc3JjMyA9IG1hdHJpeFsxMl07CiAgICAgICAgY29uc3Qgc3JjNCA9IG1hdHJpeFsxXTsKICAgICAgICBjb25zdCBzcmM1ID0gbWF0cml4WzVdOwogICAgICAgIGNvbnN0IHNyYzYgPSBtYXRyaXhbOV07CiAgICAgICAgY29uc3Qgc3JjNyA9IG1hdHJpeFsxM107CiAgICAgICAgY29uc3Qgc3JjOCA9IG1hdHJpeFsyXTsKICAgICAgICBjb25zdCBzcmM5ID0gbWF0cml4WzZdOwogICAgICAgIGNvbnN0IHNyYzEwID0gbWF0cml4WzEwXTsKICAgICAgICBjb25zdCBzcmMxMSA9IG1hdHJpeFsxNF07CiAgICAgICAgY29uc3Qgc3JjMTIgPSBtYXRyaXhbM107CiAgICAgICAgY29uc3Qgc3JjMTMgPSBtYXRyaXhbN107CiAgICAgICAgY29uc3Qgc3JjMTQgPSBtYXRyaXhbMTFdOwogICAgICAgIGNvbnN0IHNyYzE1ID0gbWF0cml4WzE1XTsKICAgICAgICBsZXQgdG1wMCA9IHNyYzEwICogc3JjMTU7CiAgICAgICAgbGV0IHRtcDEgPSBzcmMxMSAqIHNyYzE0OwogICAgICAgIGxldCB0bXAyID0gc3JjOSAqIHNyYzE1OwogICAgICAgIGxldCB0bXAzID0gc3JjMTEgKiBzcmMxMzsKICAgICAgICBsZXQgdG1wNCA9IHNyYzkgKiBzcmMxNDsKICAgICAgICBsZXQgdG1wNSA9IHNyYzEwICogc3JjMTM7CiAgICAgICAgbGV0IHRtcDYgPSBzcmM4ICogc3JjMTU7CiAgICAgICAgbGV0IHRtcDcgPSBzcmMxMSAqIHNyYzEyOwogICAgICAgIGxldCB0bXA4ID0gc3JjOCAqIHNyYzE0OwogICAgICAgIGxldCB0bXA5ID0gc3JjMTAgKiBzcmMxMjsKICAgICAgICBsZXQgdG1wMTAgPSBzcmM4ICogc3JjMTM7CiAgICAgICAgbGV0IHRtcDExID0gc3JjOSAqIHNyYzEyOwogICAgICAgIGNvbnN0IGRzdDAgPSB0bXAwICogc3JjNSArIHRtcDMgKiBzcmM2ICsgdG1wNCAqIHNyYzcgLSAodG1wMSAqIHNyYzUgKyB0bXAyICogc3JjNiArIHRtcDUgKiBzcmM3KTsKICAgICAgICBjb25zdCBkc3QxID0gdG1wMSAqIHNyYzQgKyB0bXA2ICogc3JjNiArIHRtcDkgKiBzcmM3IC0gKHRtcDAgKiBzcmM0ICsgdG1wNyAqIHNyYzYgKyB0bXA4ICogc3JjNyk7CiAgICAgICAgY29uc3QgZHN0MiA9IHRtcDIgKiBzcmM0ICsgdG1wNyAqIHNyYzUgKyB0bXAxMCAqIHNyYzcgLSAodG1wMyAqIHNyYzQgKyB0bXA2ICogc3JjNSArIHRtcDExICogc3JjNyk7CiAgICAgICAgY29uc3QgZHN0MyA9IHRtcDUgKiBzcmM0ICsgdG1wOCAqIHNyYzUgKyB0bXAxMSAqIHNyYzYgLSAodG1wNCAqIHNyYzQgKyB0bXA5ICogc3JjNSArIHRtcDEwICogc3JjNik7CiAgICAgICAgY29uc3QgZHN0NCA9IHRtcDEgKiBzcmMxICsgdG1wMiAqIHNyYzIgKyB0bXA1ICogc3JjMyAtICh0bXAwICogc3JjMSArIHRtcDMgKiBzcmMyICsgdG1wNCAqIHNyYzMpOwogICAgICAgIGNvbnN0IGRzdDUgPSB0bXAwICogc3JjMCArIHRtcDcgKiBzcmMyICsgdG1wOCAqIHNyYzMgLSAodG1wMSAqIHNyYzAgKyB0bXA2ICogc3JjMiArIHRtcDkgKiBzcmMzKTsKICAgICAgICBjb25zdCBkc3Q2ID0gdG1wMyAqIHNyYzAgKyB0bXA2ICogc3JjMSArIHRtcDExICogc3JjMyAtICh0bXAyICogc3JjMCArIHRtcDcgKiBzcmMxICsgdG1wMTAgKiBzcmMzKTsKICAgICAgICBjb25zdCBkc3Q3ID0gdG1wNCAqIHNyYzAgKyB0bXA5ICogc3JjMSArIHRtcDEwICogc3JjMiAtICh0bXA1ICogc3JjMCArIHRtcDggKiBzcmMxICsgdG1wMTEgKiBzcmMyKTsKICAgICAgICB0bXAwID0gc3JjMiAqIHNyYzc7CiAgICAgICAgdG1wMSA9IHNyYzMgKiBzcmM2OwogICAgICAgIHRtcDIgPSBzcmMxICogc3JjNzsKICAgICAgICB0bXAzID0gc3JjMyAqIHNyYzU7CiAgICAgICAgdG1wNCA9IHNyYzEgKiBzcmM2OwogICAgICAgIHRtcDUgPSBzcmMyICogc3JjNTsKICAgICAgICB0bXA2ID0gc3JjMCAqIHNyYzc7CiAgICAgICAgdG1wNyA9IHNyYzMgKiBzcmM0OwogICAgICAgIHRtcDggPSBzcmMwICogc3JjNjsKICAgICAgICB0bXA5ID0gc3JjMiAqIHNyYzQ7CiAgICAgICAgdG1wMTAgPSBzcmMwICogc3JjNTsKICAgICAgICB0bXAxMSA9IHNyYzEgKiBzcmM0OwogICAgICAgIGNvbnN0IGRzdDggPSB0bXAwICogc3JjMTMgKyB0bXAzICogc3JjMTQgKyB0bXA0ICogc3JjMTUgLSAodG1wMSAqIHNyYzEzICsgdG1wMiAqIHNyYzE0ICsgdG1wNSAqIHNyYzE1KTsKICAgICAgICBjb25zdCBkc3Q5ID0gdG1wMSAqIHNyYzEyICsgdG1wNiAqIHNyYzE0ICsgdG1wOSAqIHNyYzE1IC0gKHRtcDAgKiBzcmMxMiArIHRtcDcgKiBzcmMxNCArIHRtcDggKiBzcmMxNSk7CiAgICAgICAgY29uc3QgZHN0MTAgPSB0bXAyICogc3JjMTIgKyB0bXA3ICogc3JjMTMgKyB0bXAxMCAqIHNyYzE1IC0gKHRtcDMgKiBzcmMxMiArIHRtcDYgKiBzcmMxMyArIHRtcDExICogc3JjMTUpOwogICAgICAgIGNvbnN0IGRzdDExID0gdG1wNSAqIHNyYzEyICsgdG1wOCAqIHNyYzEzICsgdG1wMTEgKiBzcmMxNCAtICh0bXA0ICogc3JjMTIgKyB0bXA5ICogc3JjMTMgKyB0bXAxMCAqIHNyYzE0KTsKICAgICAgICBjb25zdCBkc3QxMiA9IHRtcDIgKiBzcmMxMCArIHRtcDUgKiBzcmMxMSArIHRtcDEgKiBzcmM5IC0gKHRtcDQgKiBzcmMxMSArIHRtcDAgKiBzcmM5ICsgdG1wMyAqIHNyYzEwKTsKICAgICAgICBjb25zdCBkc3QxMyA9IHRtcDggKiBzcmMxMSArIHRtcDAgKiBzcmM4ICsgdG1wNyAqIHNyYzEwIC0gKHRtcDYgKiBzcmMxMCArIHRtcDkgKiBzcmMxMSArIHRtcDEgKiBzcmM4KTsKICAgICAgICBjb25zdCBkc3QxNCA9IHRtcDYgKiBzcmM5ICsgdG1wMTEgKiBzcmMxMSArIHRtcDMgKiBzcmM4IC0gKHRtcDEwICogc3JjMTEgKyB0bXAyICogc3JjOCArIHRtcDcgKiBzcmM5KTsKICAgICAgICBjb25zdCBkc3QxNSA9IHRtcDEwICogc3JjMTAgKyB0bXA0ICogc3JjOCArIHRtcDkgKiBzcmM5IC0gKHRtcDggKiBzcmM5ICsgdG1wMTEgKiBzcmMxMCArIHRtcDUgKiBzcmM4KTsKICAgICAgICBsZXQgZGV0ID0gc3JjMCAqIGRzdDAgKyBzcmMxICogZHN0MSArIHNyYzIgKiBkc3QyICsgc3JjMyAqIGRzdDM7CiAgICAgICAgaWYgKE1hdGguYWJzKGRldCkgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjIxKSB7CiAgICAgICAgICBpZiAoTWF0cml4M19kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICAgIE1hdHJpeDQuZ2V0TWF0cml4MyhtYXRyaXgsIHNjcmF0Y2hJbnZlcnNlUm90YXRpb24pLAogICAgICAgICAgICBzY3JhdGNoTWF0cml4M1plcm8sCiAgICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9ONwogICAgICAgICAgKSAmJiBDYXJ0ZXNpYW40X2RlZmF1bHQuZXF1YWxzKAogICAgICAgICAgICBNYXRyaXg0LmdldFJvdyhtYXRyaXgsIDMsIHNjcmF0Y2hCb3R0b21Sb3cpLAogICAgICAgICAgICBzY3JhdGNoRXhwZWN0ZWRCb3R0b21Sb3cKICAgICAgICAgICkpIHsKICAgICAgICAgICAgcmVzdWx0WzBdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzRdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzVdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzZdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICAgICAgcmVzdWx0WzhdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzldID0gMDsKICAgICAgICAgICAgcmVzdWx0WzEwXSA9IDA7CiAgICAgICAgICAgIHJlc3VsdFsxMV0gPSAwOwogICAgICAgICAgICByZXN1bHRbMTJdID0gLW1hdHJpeFsxMl07CiAgICAgICAgICAgIHJlc3VsdFsxM10gPSAtbWF0cml4WzEzXTsKICAgICAgICAgICAgcmVzdWx0WzE0XSA9IC1tYXRyaXhbMTRdOwogICAgICAgICAgICByZXN1bHRbMTVdID0gMTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIm1hdHJpeCBpcyBub3QgaW52ZXJ0aWJsZSBiZWNhdXNlIGl0cyBkZXRlcm1pbmF0ZSBpcyB6ZXJvLiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGRldCA9IDEgLyBkZXQ7CiAgICAgICAgcmVzdWx0WzBdID0gZHN0MCAqIGRldDsKICAgICAgICByZXN1bHRbMV0gPSBkc3QxICogZGV0OwogICAgICAgIHJlc3VsdFsyXSA9IGRzdDIgKiBkZXQ7CiAgICAgICAgcmVzdWx0WzNdID0gZHN0MyAqIGRldDsKICAgICAgICByZXN1bHRbNF0gPSBkc3Q0ICogZGV0OwogICAgICAgIHJlc3VsdFs1XSA9IGRzdDUgKiBkZXQ7CiAgICAgICAgcmVzdWx0WzZdID0gZHN0NiAqIGRldDsKICAgICAgICByZXN1bHRbN10gPSBkc3Q3ICogZGV0OwogICAgICAgIHJlc3VsdFs4XSA9IGRzdDggKiBkZXQ7CiAgICAgICAgcmVzdWx0WzldID0gZHN0OSAqIGRldDsKICAgICAgICByZXN1bHRbMTBdID0gZHN0MTAgKiBkZXQ7CiAgICAgICAgcmVzdWx0WzExXSA9IGRzdDExICogZGV0OwogICAgICAgIHJlc3VsdFsxMl0gPSBkc3QxMiAqIGRldDsKICAgICAgICByZXN1bHRbMTNdID0gZHN0MTMgKiBkZXQ7CiAgICAgICAgcmVzdWx0WzE0XSA9IGRzdDE0ICogZGV0OwogICAgICAgIHJlc3VsdFsxNV0gPSBkc3QxNSAqIGRldDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LmludmVyc2VUcmFuc2Zvcm1hdGlvbiA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBtYXRyaXgwID0gbWF0cml4WzBdOwogICAgICAgIGNvbnN0IG1hdHJpeDEgPSBtYXRyaXhbMV07CiAgICAgICAgY29uc3QgbWF0cml4MiA9IG1hdHJpeFsyXTsKICAgICAgICBjb25zdCBtYXRyaXg0ID0gbWF0cml4WzRdOwogICAgICAgIGNvbnN0IG1hdHJpeDUgPSBtYXRyaXhbNV07CiAgICAgICAgY29uc3QgbWF0cml4NiA9IG1hdHJpeFs2XTsKICAgICAgICBjb25zdCBtYXRyaXg4ID0gbWF0cml4WzhdOwogICAgICAgIGNvbnN0IG1hdHJpeDkgPSBtYXRyaXhbOV07CiAgICAgICAgY29uc3QgbWF0cml4MTAgPSBtYXRyaXhbMTBdOwogICAgICAgIGNvbnN0IHZYID0gbWF0cml4WzEyXTsKICAgICAgICBjb25zdCB2WSA9IG1hdHJpeFsxM107CiAgICAgICAgY29uc3QgdlogPSBtYXRyaXhbMTRdOwogICAgICAgIGNvbnN0IHggPSAtbWF0cml4MCAqIHZYIC0gbWF0cml4MSAqIHZZIC0gbWF0cml4MiAqIHZaOwogICAgICAgIGNvbnN0IHkgPSAtbWF0cml4NCAqIHZYIC0gbWF0cml4NSAqIHZZIC0gbWF0cml4NiAqIHZaOwogICAgICAgIGNvbnN0IHogPSAtbWF0cml4OCAqIHZYIC0gbWF0cml4OSAqIHZZIC0gbWF0cml4MTAgKiB2WjsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXgwOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeDQ7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4ODsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeDE7CiAgICAgICAgcmVzdWx0WzVdID0gbWF0cml4NTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXg5OwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gbWF0cml4MjsKICAgICAgICByZXN1bHRbOV0gPSBtYXRyaXg2OwogICAgICAgIHJlc3VsdFsxMF0gPSBtYXRyaXgxMDsKICAgICAgICByZXN1bHRbMTFdID0gMDsKICAgICAgICByZXN1bHRbMTJdID0geDsKICAgICAgICByZXN1bHRbMTNdID0geTsKICAgICAgICByZXN1bHRbMTRdID0gejsKICAgICAgICByZXN1bHRbMTVdID0gMTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoVHJhbnNwb3NlTWF0cml4MiA9IG5ldyBNYXRyaXg0KCk7CiAgICAgIE1hdHJpeDQuaW52ZXJzZVRyYW5zcG9zZSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gTWF0cml4NC5pbnZlcnNlKAogICAgICAgICAgTWF0cml4NC50cmFuc3Bvc2UobWF0cml4LCBzY3JhdGNoVHJhbnNwb3NlTWF0cml4MiksCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBNYXRyaXg0LklERU5USVRZID0gT2JqZWN0LmZyZWV6ZSgKICAgICAgICBuZXcgTWF0cml4NCgKICAgICAgICAgIDEsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMSwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAxLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDEKICAgICAgICApCiAgICAgICk7CiAgICAgIE1hdHJpeDQuWkVSTyA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IE1hdHJpeDQoCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwCiAgICAgICAgKQogICAgICApOwogICAgICBNYXRyaXg0LkNPTFVNTjBST1cwID0gMDsKICAgICAgTWF0cml4NC5DT0xVTU4wUk9XMSA9IDE7CiAgICAgIE1hdHJpeDQuQ09MVU1OMFJPVzIgPSAyOwogICAgICBNYXRyaXg0LkNPTFVNTjBST1czID0gMzsKICAgICAgTWF0cml4NC5DT0xVTU4xUk9XMCA9IDQ7CiAgICAgIE1hdHJpeDQuQ09MVU1OMVJPVzEgPSA1OwogICAgICBNYXRyaXg0LkNPTFVNTjFST1cyID0gNjsKICAgICAgTWF0cml4NC5DT0xVTU4xUk9XMyA9IDc7CiAgICAgIE1hdHJpeDQuQ09MVU1OMlJPVzAgPSA4OwogICAgICBNYXRyaXg0LkNPTFVNTjJST1cxID0gOTsKICAgICAgTWF0cml4NC5DT0xVTU4yUk9XMiA9IDEwOwogICAgICBNYXRyaXg0LkNPTFVNTjJST1czID0gMTE7CiAgICAgIE1hdHJpeDQuQ09MVU1OM1JPVzAgPSAxMjsKICAgICAgTWF0cml4NC5DT0xVTU4zUk9XMSA9IDEzOwogICAgICBNYXRyaXg0LkNPTFVNTjNST1cyID0gMTQ7CiAgICAgIE1hdHJpeDQuQ09MVU1OM1JPVzMgPSAxNTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoTWF0cml4NC5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBudW1iZXIgb2YgaXRlbXMgaW4gdGhlIGNvbGxlY3Rpb24uCiAgICAgICAgICogQG1lbWJlcm9mIE1hdHJpeDQucHJvdG90eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGxlbmd0aDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdHJpeDQucGFja2VkTGVuZ3RoOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIE1hdHJpeDQucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIE1hdHJpeDQuY2xvbmUodGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgTWF0cml4NC5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ocmlnaHQpIHsKICAgICAgICByZXR1cm4gTWF0cml4NC5lcXVhbHModGhpcywgcmlnaHQpOwogICAgICB9OwogICAgICBNYXRyaXg0LmVxdWFsc0FycmF5ID0gZnVuY3Rpb24obWF0cml4LCBhcnJheSwgb2Zmc2V0KSB7CiAgICAgICAgcmV0dXJuIG1hdHJpeFswXSA9PT0gYXJyYXlbb2Zmc2V0XSAmJiBtYXRyaXhbMV0gPT09IGFycmF5W29mZnNldCArIDFdICYmIG1hdHJpeFsyXSA9PT0gYXJyYXlbb2Zmc2V0ICsgMl0gJiYgbWF0cml4WzNdID09PSBhcnJheVtvZmZzZXQgKyAzXSAmJiBtYXRyaXhbNF0gPT09IGFycmF5W29mZnNldCArIDRdICYmIG1hdHJpeFs1XSA9PT0gYXJyYXlbb2Zmc2V0ICsgNV0gJiYgbWF0cml4WzZdID09PSBhcnJheVtvZmZzZXQgKyA2XSAmJiBtYXRyaXhbN10gPT09IGFycmF5W29mZnNldCArIDddICYmIG1hdHJpeFs4XSA9PT0gYXJyYXlbb2Zmc2V0ICsgOF0gJiYgbWF0cml4WzldID09PSBhcnJheVtvZmZzZXQgKyA5XSAmJiBtYXRyaXhbMTBdID09PSBhcnJheVtvZmZzZXQgKyAxMF0gJiYgbWF0cml4WzExXSA9PT0gYXJyYXlbb2Zmc2V0ICsgMTFdICYmIG1hdHJpeFsxMl0gPT09IGFycmF5W29mZnNldCArIDEyXSAmJiBtYXRyaXhbMTNdID09PSBhcnJheVtvZmZzZXQgKyAxM10gJiYgbWF0cml4WzE0XSA9PT0gYXJyYXlbb2Zmc2V0ICsgMTRdICYmIG1hdHJpeFsxNV0gPT09IGFycmF5W29mZnNldCArIDE1XTsKICAgICAgfTsKICAgICAgTWF0cml4NC5wcm90b3R5cGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKHJpZ2h0LCBlcHNpbG9uKSB7CiAgICAgICAgcmV0dXJuIE1hdHJpeDQuZXF1YWxzRXBzaWxvbih0aGlzLCByaWdodCwgZXBzaWxvbik7CiAgICAgIH07CiAgICAgIE1hdHJpeDQucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGAoJHt0aGlzWzBdfSwgJHt0aGlzWzRdfSwgJHt0aGlzWzhdfSwgJHt0aGlzWzEyXX0pCigke3RoaXNbMV19LCAke3RoaXNbNV19LCAke3RoaXNbOV19LCAke3RoaXNbMTNdfSkKKCR7dGhpc1syXX0sICR7dGhpc1s2XX0sICR7dGhpc1sxMF19LCAke3RoaXNbMTRdfSkKKCR7dGhpc1szXX0sICR7dGhpc1s3XX0sICR7dGhpc1sxMV19LCAke3RoaXNbMTVdfSlgOwogICAgICB9OwogICAgICBNYXRyaXg0X2RlZmF1bHQgPSBNYXRyaXg0OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVjdGFuZ2xlLmpzCiAgZnVuY3Rpb24gUmVjdGFuZ2xlKHdlc3QsIHNvdXRoLCBlYXN0LCBub3J0aCkgewogICAgdGhpcy53ZXN0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQod2VzdCwgMCk7CiAgICB0aGlzLnNvdXRoID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc291dGgsIDApOwogICAgdGhpcy5lYXN0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWFzdCwgMCk7CiAgICB0aGlzLm5vcnRoID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQobm9ydGgsIDApOwogIH0KICB2YXIgc3Vic2FtcGxlTGxhU2NyYXRjaCwgUmVjdGFuZ2xlX2RlZmF1bHQ7CiAgdmFyIGluaXRfUmVjdGFuZ2xlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZWN0YW5nbGUuanMiKCkgewogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoUmVjdGFuZ2xlLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHdpZHRoIG9mIHRoZSByZWN0YW5nbGUgaW4gcmFkaWFucy4KICAgICAgICAgKiBAbWVtYmVyb2YgUmVjdGFuZ2xlLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgd2lkdGg6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBSZWN0YW5nbGUuY29tcHV0ZVdpZHRoKHRoaXMpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgaGVpZ2h0IG9mIHRoZSByZWN0YW5nbGUgaW4gcmFkaWFucy4KICAgICAgICAgKiBAbWVtYmVyb2YgUmVjdGFuZ2xlLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgaGVpZ2h0OiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gUmVjdGFuZ2xlLmNvbXB1dGVIZWlnaHQodGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgUmVjdGFuZ2xlLnBhY2tlZExlbmd0aCA9IDQ7CiAgICAgIFJlY3RhbmdsZS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUud2VzdDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuc291dGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLmVhc3Q7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5ub3J0aDsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFJlY3RhbmdsZSgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQud2VzdCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LnNvdXRoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQuZWFzdCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0Lm5vcnRoID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLmNvbXB1dGVXaWR0aCA9IGZ1bmN0aW9uKHJlY3RhbmdsZSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVjdGFuZ2xlIiwgcmVjdGFuZ2xlKTsKICAgICAgICBsZXQgZWFzdCA9IHJlY3RhbmdsZS5lYXN0OwogICAgICAgIGNvbnN0IHdlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgICAgICBpZiAoZWFzdCA8IHdlc3QpIHsKICAgICAgICAgIGVhc3QgKz0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGVhc3QgLSB3ZXN0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUuY29tcHV0ZUhlaWdodCA9IGZ1bmN0aW9uKHJlY3RhbmdsZSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVjdGFuZ2xlIiwgcmVjdGFuZ2xlKTsKICAgICAgICByZXR1cm4gcmVjdGFuZ2xlLm5vcnRoIC0gcmVjdGFuZ2xlLnNvdXRoOwogICAgICB9OwogICAgICBSZWN0YW5nbGUuZnJvbURlZ3JlZXMgPSBmdW5jdGlvbih3ZXN0LCBzb3V0aCwgZWFzdCwgbm9ydGgsIHJlc3VsdCkgewogICAgICAgIHdlc3QgPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHdlc3QsIDApKTsKICAgICAgICBzb3V0aCA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoZGVmYXVsdFZhbHVlX2RlZmF1bHQoc291dGgsIDApKTsKICAgICAgICBlYXN0ID0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhkZWZhdWx0VmFsdWVfZGVmYXVsdChlYXN0LCAwKSk7CiAgICAgICAgbm9ydGggPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG5vcnRoLCAwKSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBSZWN0YW5nbGUod2VzdCwgc291dGgsIGVhc3QsIG5vcnRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Lndlc3QgPSB3ZXN0OwogICAgICAgIHJlc3VsdC5zb3V0aCA9IHNvdXRoOwogICAgICAgIHJlc3VsdC5lYXN0ID0gZWFzdDsKICAgICAgICByZXN1bHQubm9ydGggPSBub3J0aDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUuZnJvbVJhZGlhbnMgPSBmdW5jdGlvbih3ZXN0LCBzb3V0aCwgZWFzdCwgbm9ydGgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUmVjdGFuZ2xlKHdlc3QsIHNvdXRoLCBlYXN0LCBub3J0aCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC53ZXN0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQod2VzdCwgMCk7CiAgICAgICAgcmVzdWx0LnNvdXRoID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc291dGgsIDApOwogICAgICAgIHJlc3VsdC5lYXN0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWFzdCwgMCk7CiAgICAgICAgcmVzdWx0Lm5vcnRoID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQobm9ydGgsIDApOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZS5mcm9tQ2FydG9ncmFwaGljQXJyYXkgPSBmdW5jdGlvbihjYXJ0b2dyYXBoaWNzLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNhcnRvZ3JhcGhpY3MiLCBjYXJ0b2dyYXBoaWNzKTsKICAgICAgICBsZXQgd2VzdCA9IE51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgbGV0IGVhc3QgPSAtTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBsZXQgd2VzdE92ZXJJREwgPSBOdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGxldCBlYXN0T3ZlcklETCA9IC1OdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGxldCBzb3V0aCA9IE51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgbGV0IG5vcnRoID0gLU51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IGNhcnRvZ3JhcGhpY3MubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHBvc2l0aW9uID0gY2FydG9ncmFwaGljc1tpXTsKICAgICAgICAgIHdlc3QgPSBNYXRoLm1pbih3ZXN0LCBwb3NpdGlvbi5sb25naXR1ZGUpOwogICAgICAgICAgZWFzdCA9IE1hdGgubWF4KGVhc3QsIHBvc2l0aW9uLmxvbmdpdHVkZSk7CiAgICAgICAgICBzb3V0aCA9IE1hdGgubWluKHNvdXRoLCBwb3NpdGlvbi5sYXRpdHVkZSk7CiAgICAgICAgICBub3J0aCA9IE1hdGgubWF4KG5vcnRoLCBwb3NpdGlvbi5sYXRpdHVkZSk7CiAgICAgICAgICBjb25zdCBsb25BZGp1c3RlZCA9IHBvc2l0aW9uLmxvbmdpdHVkZSA+PSAwID8gcG9zaXRpb24ubG9uZ2l0dWRlIDogcG9zaXRpb24ubG9uZ2l0dWRlICsgTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICAgIHdlc3RPdmVySURMID0gTWF0aC5taW4od2VzdE92ZXJJREwsIGxvbkFkanVzdGVkKTsKICAgICAgICAgIGVhc3RPdmVySURMID0gTWF0aC5tYXgoZWFzdE92ZXJJREwsIGxvbkFkanVzdGVkKTsKICAgICAgICB9CiAgICAgICAgaWYgKGVhc3QgLSB3ZXN0ID4gZWFzdE92ZXJJREwgLSB3ZXN0T3ZlcklETCkgewogICAgICAgICAgd2VzdCA9IHdlc3RPdmVySURMOwogICAgICAgICAgZWFzdCA9IGVhc3RPdmVySURMOwogICAgICAgICAgaWYgKGVhc3QgPiBNYXRoX2RlZmF1bHQuUEkpIHsKICAgICAgICAgICAgZWFzdCA9IGVhc3QgLSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHdlc3QgPiBNYXRoX2RlZmF1bHQuUEkpIHsKICAgICAgICAgICAgd2VzdCA9IHdlc3QgLSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFJlY3RhbmdsZSh3ZXN0LCBzb3V0aCwgZWFzdCwgbm9ydGgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQud2VzdCA9IHdlc3Q7CiAgICAgICAgcmVzdWx0LnNvdXRoID0gc291dGg7CiAgICAgICAgcmVzdWx0LmVhc3QgPSBlYXN0OwogICAgICAgIHJlc3VsdC5ub3J0aCA9IG5vcnRoOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZS5mcm9tQ2FydGVzaWFuQXJyYXkgPSBmdW5jdGlvbihjYXJ0ZXNpYW5zLCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2FydGVzaWFucyIsIGNhcnRlc2lhbnMpOwogICAgICAgIGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgICAgIGxldCB3ZXN0ID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBsZXQgZWFzdCA9IC1OdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGxldCB3ZXN0T3ZlcklETCA9IE51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgbGV0IGVhc3RPdmVySURMID0gLU51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgbGV0IHNvdXRoID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBsZXQgbm9ydGggPSAtTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gY2FydGVzaWFucy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgY29uc3QgcG9zaXRpb24gPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoY2FydGVzaWFuc1tpXSk7CiAgICAgICAgICB3ZXN0ID0gTWF0aC5taW4od2VzdCwgcG9zaXRpb24ubG9uZ2l0dWRlKTsKICAgICAgICAgIGVhc3QgPSBNYXRoLm1heChlYXN0LCBwb3NpdGlvbi5sb25naXR1ZGUpOwogICAgICAgICAgc291dGggPSBNYXRoLm1pbihzb3V0aCwgcG9zaXRpb24ubGF0aXR1ZGUpOwogICAgICAgICAgbm9ydGggPSBNYXRoLm1heChub3J0aCwgcG9zaXRpb24ubGF0aXR1ZGUpOwogICAgICAgICAgY29uc3QgbG9uQWRqdXN0ZWQgPSBwb3NpdGlvbi5sb25naXR1ZGUgPj0gMCA/IHBvc2l0aW9uLmxvbmdpdHVkZSA6IHBvc2l0aW9uLmxvbmdpdHVkZSArIE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgICB3ZXN0T3ZlcklETCA9IE1hdGgubWluKHdlc3RPdmVySURMLCBsb25BZGp1c3RlZCk7CiAgICAgICAgICBlYXN0T3ZlcklETCA9IE1hdGgubWF4KGVhc3RPdmVySURMLCBsb25BZGp1c3RlZCk7CiAgICAgICAgfQogICAgICAgIGlmIChlYXN0IC0gd2VzdCA+IGVhc3RPdmVySURMIC0gd2VzdE92ZXJJREwpIHsKICAgICAgICAgIHdlc3QgPSB3ZXN0T3ZlcklETDsKICAgICAgICAgIGVhc3QgPSBlYXN0T3ZlcklETDsKICAgICAgICAgIGlmIChlYXN0ID4gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgICAgICAgIGVhc3QgPSBlYXN0IC0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3ZXN0ID4gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgICAgICAgIHdlc3QgPSB3ZXN0IC0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBSZWN0YW5nbGUod2VzdCwgc291dGgsIGVhc3QsIG5vcnRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Lndlc3QgPSB3ZXN0OwogICAgICAgIHJlc3VsdC5zb3V0aCA9IHNvdXRoOwogICAgICAgIHJlc3VsdC5lYXN0ID0gZWFzdDsKICAgICAgICByZXN1bHQubm9ydGggPSBub3J0aDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUuY2xvbmUgPSBmdW5jdGlvbihyZWN0YW5nbGUsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlY3RhbmdsZSkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUmVjdGFuZ2xlKAogICAgICAgICAgICByZWN0YW5nbGUud2VzdCwKICAgICAgICAgICAgcmVjdGFuZ2xlLnNvdXRoLAogICAgICAgICAgICByZWN0YW5nbGUuZWFzdCwKICAgICAgICAgICAgcmVjdGFuZ2xlLm5vcnRoCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHQud2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogICAgICAgIHJlc3VsdC5zb3V0aCA9IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgICByZXN1bHQuZWFzdCA9IHJlY3RhbmdsZS5lYXN0OwogICAgICAgIHJlc3VsdC5ub3J0aCA9IHJlY3RhbmdsZS5ub3J0aDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICBhYnNvbHV0ZUVwc2lsb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChhYnNvbHV0ZUVwc2lsb24sIDApOwogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBNYXRoLmFicyhsZWZ0Lndlc3QgLSByaWdodC53ZXN0KSA8PSBhYnNvbHV0ZUVwc2lsb24gJiYgTWF0aC5hYnMobGVmdC5zb3V0aCAtIHJpZ2h0LnNvdXRoKSA8PSBhYnNvbHV0ZUVwc2lsb24gJiYgTWF0aC5hYnMobGVmdC5lYXN0IC0gcmlnaHQuZWFzdCkgPD0gYWJzb2x1dGVFcHNpbG9uICYmIE1hdGguYWJzKGxlZnQubm9ydGggLSByaWdodC5ub3J0aCkgPD0gYWJzb2x1dGVFcHNpbG9uOwogICAgICB9OwogICAgICBSZWN0YW5nbGUucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIFJlY3RhbmdsZS5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBSZWN0YW5nbGUucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKG90aGVyKSB7CiAgICAgICAgcmV0dXJuIFJlY3RhbmdsZS5lcXVhbHModGhpcywgb3RoZXIpOwogICAgICB9OwogICAgICBSZWN0YW5nbGUuZXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgbGVmdC53ZXN0ID09PSByaWdodC53ZXN0ICYmIGxlZnQuc291dGggPT09IHJpZ2h0LnNvdXRoICYmIGxlZnQuZWFzdCA9PT0gcmlnaHQuZWFzdCAmJiBsZWZ0Lm5vcnRoID09PSByaWdodC5ub3J0aDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLnByb3RvdHlwZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24ob3RoZXIsIGVwc2lsb24pIHsKICAgICAgICByZXR1cm4gUmVjdGFuZ2xlLmVxdWFsc0Vwc2lsb24odGhpcywgb3RoZXIsIGVwc2lsb24pOwogICAgICB9OwogICAgICBSZWN0YW5nbGUudmFsaWRhdGUgPSBmdW5jdGlvbihyZWN0YW5nbGUpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgY29uc3Qgbm9ydGggPSByZWN0YW5nbGUubm9ydGg7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoCiAgICAgICAgICAibm9ydGgiLAogICAgICAgICAgbm9ydGgsCiAgICAgICAgICAtTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPCiAgICAgICAgKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygibm9ydGgiLCBub3J0aCwgTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPKTsKICAgICAgICBjb25zdCBzb3V0aCA9IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygKICAgICAgICAgICJzb3V0aCIsCiAgICAgICAgICBzb3V0aCwKICAgICAgICAgIC1NYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08KICAgICAgICApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJzb3V0aCIsIHNvdXRoLCBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08pOwogICAgICAgIGNvbnN0IHdlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygid2VzdCIsIHdlc3QsIC1NYXRoLlBJKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygid2VzdCIsIHdlc3QsIE1hdGguUEkpOwogICAgICAgIGNvbnN0IGVhc3QgPSByZWN0YW5nbGUuZWFzdDsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiZWFzdCIsIGVhc3QsIC1NYXRoLlBJKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiZWFzdCIsIGVhc3QsIE1hdGguUEkpOwogICAgICB9OwogICAgICBSZWN0YW5nbGUuc291dGh3ZXN0ID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdChyZWN0YW5nbGUud2VzdCwgcmVjdGFuZ2xlLnNvdXRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IHJlY3RhbmdsZS53ZXN0OwogICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUubm9ydGh3ZXN0ID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdChyZWN0YW5nbGUud2VzdCwgcmVjdGFuZ2xlLm5vcnRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IHJlY3RhbmdsZS53ZXN0OwogICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IHJlY3RhbmdsZS5ub3J0aDsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUubm9ydGhlYXN0ID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdChyZWN0YW5nbGUuZWFzdCwgcmVjdGFuZ2xlLm5vcnRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IHJlY3RhbmdsZS5lYXN0OwogICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IHJlY3RhbmdsZS5ub3J0aDsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUuc291dGhlYXN0ID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdChyZWN0YW5nbGUuZWFzdCwgcmVjdGFuZ2xlLnNvdXRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IHJlY3RhbmdsZS5lYXN0OwogICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUuY2VudGVyID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgbGV0IGVhc3QgPSByZWN0YW5nbGUuZWFzdDsKICAgICAgICBjb25zdCB3ZXN0ID0gcmVjdGFuZ2xlLndlc3Q7CiAgICAgICAgaWYgKGVhc3QgPCB3ZXN0KSB7CiAgICAgICAgICBlYXN0ICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaSgod2VzdCArIGVhc3QpICogMC41KTsKICAgICAgICBjb25zdCBsYXRpdHVkZSA9IChyZWN0YW5nbGUuc291dGggKyByZWN0YW5nbGUubm9ydGgpICogMC41OwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQobG9uZ2l0dWRlLCBsYXRpdHVkZSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSBsb25naXR1ZGU7CiAgICAgICAgcmVzdWx0LmxhdGl0dWRlID0gbGF0aXR1ZGU7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IDA7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLmludGVyc2VjdGlvbiA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgb3RoZXJSZWN0YW5nbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVjdGFuZ2xlIiwgcmVjdGFuZ2xlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm90aGVyUmVjdGFuZ2xlIiwgb3RoZXJSZWN0YW5nbGUpOwogICAgICAgIGxldCByZWN0YW5nbGVFYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgbGV0IHJlY3RhbmdsZVdlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgICAgICBsZXQgb3RoZXJSZWN0YW5nbGVFYXN0ID0gb3RoZXJSZWN0YW5nbGUuZWFzdDsKICAgICAgICBsZXQgb3RoZXJSZWN0YW5nbGVXZXN0ID0gb3RoZXJSZWN0YW5nbGUud2VzdDsKICAgICAgICBpZiAocmVjdGFuZ2xlRWFzdCA8IHJlY3RhbmdsZVdlc3QgJiYgb3RoZXJSZWN0YW5nbGVFYXN0ID4gMCkgewogICAgICAgICAgcmVjdGFuZ2xlRWFzdCArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIH0gZWxzZSBpZiAob3RoZXJSZWN0YW5nbGVFYXN0IDwgb3RoZXJSZWN0YW5nbGVXZXN0ICYmIHJlY3RhbmdsZUVhc3QgPiAwKSB7CiAgICAgICAgICBvdGhlclJlY3RhbmdsZUVhc3QgKz0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICB9CiAgICAgICAgaWYgKHJlY3RhbmdsZUVhc3QgPCByZWN0YW5nbGVXZXN0ICYmIG90aGVyUmVjdGFuZ2xlV2VzdCA8IDApIHsKICAgICAgICAgIG90aGVyUmVjdGFuZ2xlV2VzdCArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIH0gZWxzZSBpZiAob3RoZXJSZWN0YW5nbGVFYXN0IDwgb3RoZXJSZWN0YW5nbGVXZXN0ICYmIHJlY3RhbmdsZVdlc3QgPCAwKSB7CiAgICAgICAgICByZWN0YW5nbGVXZXN0ICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHdlc3QgPSBNYXRoX2RlZmF1bHQubmVnYXRpdmVQaVRvUGkoCiAgICAgICAgICBNYXRoLm1heChyZWN0YW5nbGVXZXN0LCBvdGhlclJlY3RhbmdsZVdlc3QpCiAgICAgICAgKTsKICAgICAgICBjb25zdCBlYXN0ID0gTWF0aF9kZWZhdWx0Lm5lZ2F0aXZlUGlUb1BpKAogICAgICAgICAgTWF0aC5taW4ocmVjdGFuZ2xlRWFzdCwgb3RoZXJSZWN0YW5nbGVFYXN0KQogICAgICAgICk7CiAgICAgICAgaWYgKChyZWN0YW5nbGUud2VzdCA8IHJlY3RhbmdsZS5lYXN0IHx8IG90aGVyUmVjdGFuZ2xlLndlc3QgPCBvdGhlclJlY3RhbmdsZS5lYXN0KSAmJiBlYXN0IDw9IHdlc3QpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNvdXRoID0gTWF0aC5tYXgocmVjdGFuZ2xlLnNvdXRoLCBvdGhlclJlY3RhbmdsZS5zb3V0aCk7CiAgICAgICAgY29uc3Qgbm9ydGggPSBNYXRoLm1pbihyZWN0YW5nbGUubm9ydGgsIG90aGVyUmVjdGFuZ2xlLm5vcnRoKTsKICAgICAgICBpZiAoc291dGggPj0gbm9ydGgpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUmVjdGFuZ2xlKHdlc3QsIHNvdXRoLCBlYXN0LCBub3J0aCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC53ZXN0ID0gd2VzdDsKICAgICAgICByZXN1bHQuc291dGggPSBzb3V0aDsKICAgICAgICByZXN1bHQuZWFzdCA9IGVhc3Q7CiAgICAgICAgcmVzdWx0Lm5vcnRoID0gbm9ydGg7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLnNpbXBsZUludGVyc2VjdGlvbiA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgb3RoZXJSZWN0YW5nbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVjdGFuZ2xlIiwgcmVjdGFuZ2xlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm90aGVyUmVjdGFuZ2xlIiwgb3RoZXJSZWN0YW5nbGUpOwogICAgICAgIGNvbnN0IHdlc3QgPSBNYXRoLm1heChyZWN0YW5nbGUud2VzdCwgb3RoZXJSZWN0YW5nbGUud2VzdCk7CiAgICAgICAgY29uc3Qgc291dGggPSBNYXRoLm1heChyZWN0YW5nbGUuc291dGgsIG90aGVyUmVjdGFuZ2xlLnNvdXRoKTsKICAgICAgICBjb25zdCBlYXN0ID0gTWF0aC5taW4ocmVjdGFuZ2xlLmVhc3QsIG90aGVyUmVjdGFuZ2xlLmVhc3QpOwogICAgICAgIGNvbnN0IG5vcnRoID0gTWF0aC5taW4ocmVjdGFuZ2xlLm5vcnRoLCBvdGhlclJlY3RhbmdsZS5ub3J0aCk7CiAgICAgICAgaWYgKHNvdXRoID49IG5vcnRoIHx8IHdlc3QgPj0gZWFzdCkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBSZWN0YW5nbGUod2VzdCwgc291dGgsIGVhc3QsIG5vcnRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Lndlc3QgPSB3ZXN0OwogICAgICAgIHJlc3VsdC5zb3V0aCA9IHNvdXRoOwogICAgICAgIHJlc3VsdC5lYXN0ID0gZWFzdDsKICAgICAgICByZXN1bHQubm9ydGggPSBub3J0aDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUudW5pb24gPSBmdW5jdGlvbihyZWN0YW5nbGUsIG90aGVyUmVjdGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvdGhlclJlY3RhbmdsZSIsIG90aGVyUmVjdGFuZ2xlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgUmVjdGFuZ2xlKCk7CiAgICAgICAgfQogICAgICAgIGxldCByZWN0YW5nbGVFYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgbGV0IHJlY3RhbmdsZVdlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgICAgICBsZXQgb3RoZXJSZWN0YW5nbGVFYXN0ID0gb3RoZXJSZWN0YW5nbGUuZWFzdDsKICAgICAgICBsZXQgb3RoZXJSZWN0YW5nbGVXZXN0ID0gb3RoZXJSZWN0YW5nbGUud2VzdDsKICAgICAgICBpZiAocmVjdGFuZ2xlRWFzdCA8IHJlY3RhbmdsZVdlc3QgJiYgb3RoZXJSZWN0YW5nbGVFYXN0ID4gMCkgewogICAgICAgICAgcmVjdGFuZ2xlRWFzdCArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIH0gZWxzZSBpZiAob3RoZXJSZWN0YW5nbGVFYXN0IDwgb3RoZXJSZWN0YW5nbGVXZXN0ICYmIHJlY3RhbmdsZUVhc3QgPiAwKSB7CiAgICAgICAgICBvdGhlclJlY3RhbmdsZUVhc3QgKz0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICB9CiAgICAgICAgaWYgKHJlY3RhbmdsZUVhc3QgPCByZWN0YW5nbGVXZXN0ICYmIG90aGVyUmVjdGFuZ2xlV2VzdCA8IDApIHsKICAgICAgICAgIG90aGVyUmVjdGFuZ2xlV2VzdCArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIH0gZWxzZSBpZiAob3RoZXJSZWN0YW5nbGVFYXN0IDwgb3RoZXJSZWN0YW5nbGVXZXN0ICYmIHJlY3RhbmdsZVdlc3QgPCAwKSB7CiAgICAgICAgICByZWN0YW5nbGVXZXN0ICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHdlc3QgPSBNYXRoX2RlZmF1bHQubmVnYXRpdmVQaVRvUGkoCiAgICAgICAgICBNYXRoLm1pbihyZWN0YW5nbGVXZXN0LCBvdGhlclJlY3RhbmdsZVdlc3QpCiAgICAgICAgKTsKICAgICAgICBjb25zdCBlYXN0ID0gTWF0aF9kZWZhdWx0Lm5lZ2F0aXZlUGlUb1BpKAogICAgICAgICAgTWF0aC5tYXgocmVjdGFuZ2xlRWFzdCwgb3RoZXJSZWN0YW5nbGVFYXN0KQogICAgICAgICk7CiAgICAgICAgcmVzdWx0Lndlc3QgPSB3ZXN0OwogICAgICAgIHJlc3VsdC5zb3V0aCA9IE1hdGgubWluKHJlY3RhbmdsZS5zb3V0aCwgb3RoZXJSZWN0YW5nbGUuc291dGgpOwogICAgICAgIHJlc3VsdC5lYXN0ID0gZWFzdDsKICAgICAgICByZXN1bHQubm9ydGggPSBNYXRoLm1heChyZWN0YW5nbGUubm9ydGgsIG90aGVyUmVjdGFuZ2xlLm5vcnRoKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUuZXhwYW5kID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCBjYXJ0b2dyYXBoaWMyLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0b2dyYXBoaWMiLCBjYXJ0b2dyYXBoaWMyKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgUmVjdGFuZ2xlKCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC53ZXN0ID0gTWF0aC5taW4ocmVjdGFuZ2xlLndlc3QsIGNhcnRvZ3JhcGhpYzIubG9uZ2l0dWRlKTsKICAgICAgICByZXN1bHQuc291dGggPSBNYXRoLm1pbihyZWN0YW5nbGUuc291dGgsIGNhcnRvZ3JhcGhpYzIubGF0aXR1ZGUpOwogICAgICAgIHJlc3VsdC5lYXN0ID0gTWF0aC5tYXgocmVjdGFuZ2xlLmVhc3QsIGNhcnRvZ3JhcGhpYzIubG9uZ2l0dWRlKTsKICAgICAgICByZXN1bHQubm9ydGggPSBNYXRoLm1heChyZWN0YW5nbGUubm9ydGgsIGNhcnRvZ3JhcGhpYzIubGF0aXR1ZGUpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZS5jb250YWlucyA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgY2FydG9ncmFwaGljMikgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVjdGFuZ2xlIiwgcmVjdGFuZ2xlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRvZ3JhcGhpYyIsIGNhcnRvZ3JhcGhpYzIpOwogICAgICAgIGxldCBsb25naXR1ZGUgPSBjYXJ0b2dyYXBoaWMyLmxvbmdpdHVkZTsKICAgICAgICBjb25zdCBsYXRpdHVkZSA9IGNhcnRvZ3JhcGhpYzIubGF0aXR1ZGU7CiAgICAgICAgY29uc3Qgd2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogICAgICAgIGxldCBlYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgaWYgKGVhc3QgPCB3ZXN0KSB7CiAgICAgICAgICBlYXN0ICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgICBpZiAobG9uZ2l0dWRlIDwgMCkgewogICAgICAgICAgICBsb25naXR1ZGUgKz0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIChsb25naXR1ZGUgPiB3ZXN0IHx8IE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGxvbmdpdHVkZSwgd2VzdCwgTWF0aF9kZWZhdWx0LkVQU0lMT04xNCkpICYmIChsb25naXR1ZGUgPCBlYXN0IHx8IE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGxvbmdpdHVkZSwgZWFzdCwgTWF0aF9kZWZhdWx0LkVQU0lMT04xNCkpICYmIGxhdGl0dWRlID49IHJlY3RhbmdsZS5zb3V0aCAmJiBsYXRpdHVkZSA8PSByZWN0YW5nbGUubm9ydGg7CiAgICAgIH07CiAgICAgIHN1YnNhbXBsZUxsYVNjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgUmVjdGFuZ2xlLnN1YnNhbXBsZSA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgZWxsaXBzb2lkLCBzdXJmYWNlSGVpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICAgICAgc3VyZmFjZUhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN1cmZhY2VIZWlnaHQsIDApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IFtdOwogICAgICAgIH0KICAgICAgICBsZXQgbGVuZ3RoID0gMDsKICAgICAgICBjb25zdCBub3J0aCA9IHJlY3RhbmdsZS5ub3J0aDsKICAgICAgICBjb25zdCBzb3V0aCA9IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgICBjb25zdCBlYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgY29uc3Qgd2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogICAgICAgIGNvbnN0IGxsYSA9IHN1YnNhbXBsZUxsYVNjcmF0Y2g7CiAgICAgICAgbGxhLmhlaWdodCA9IHN1cmZhY2VIZWlnaHQ7CiAgICAgICAgbGxhLmxvbmdpdHVkZSA9IHdlc3Q7CiAgICAgICAgbGxhLmxhdGl0dWRlID0gbm9ydGg7CiAgICAgICAgcmVzdWx0W2xlbmd0aF0gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4obGxhLCByZXN1bHRbbGVuZ3RoXSk7CiAgICAgICAgbGVuZ3RoKys7CiAgICAgICAgbGxhLmxvbmdpdHVkZSA9IGVhc3Q7CiAgICAgICAgcmVzdWx0W2xlbmd0aF0gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4obGxhLCByZXN1bHRbbGVuZ3RoXSk7CiAgICAgICAgbGVuZ3RoKys7CiAgICAgICAgbGxhLmxhdGl0dWRlID0gc291dGg7CiAgICAgICAgcmVzdWx0W2xlbmd0aF0gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4obGxhLCByZXN1bHRbbGVuZ3RoXSk7CiAgICAgICAgbGVuZ3RoKys7CiAgICAgICAgbGxhLmxvbmdpdHVkZSA9IHdlc3Q7CiAgICAgICAgcmVzdWx0W2xlbmd0aF0gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4obGxhLCByZXN1bHRbbGVuZ3RoXSk7CiAgICAgICAgbGVuZ3RoKys7CiAgICAgICAgaWYgKG5vcnRoIDwgMCkgewogICAgICAgICAgbGxhLmxhdGl0dWRlID0gbm9ydGg7CiAgICAgICAgfSBlbHNlIGlmIChzb3V0aCA+IDApIHsKICAgICAgICAgIGxsYS5sYXRpdHVkZSA9IHNvdXRoOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBsbGEubGF0aXR1ZGUgPSAwOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IDg7ICsraSkgewogICAgICAgICAgbGxhLmxvbmdpdHVkZSA9IC1NYXRoLlBJICsgaSAqIE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTzsKICAgICAgICAgIGlmIChSZWN0YW5nbGUuY29udGFpbnMocmVjdGFuZ2xlLCBsbGEpKSB7CiAgICAgICAgICAgIHJlc3VsdFtsZW5ndGhdID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKGxsYSwgcmVzdWx0W2xlbmd0aF0pOwogICAgICAgICAgICBsZW5ndGgrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGxsYS5sYXRpdHVkZSA9PT0gMCkgewogICAgICAgICAgbGxhLmxvbmdpdHVkZSA9IHdlc3Q7CiAgICAgICAgICByZXN1bHRbbGVuZ3RoXSA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihsbGEsIHJlc3VsdFtsZW5ndGhdKTsKICAgICAgICAgIGxlbmd0aCsrOwogICAgICAgICAgbGxhLmxvbmdpdHVkZSA9IGVhc3Q7CiAgICAgICAgICByZXN1bHRbbGVuZ3RoXSA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihsbGEsIHJlc3VsdFtsZW5ndGhdKTsKICAgICAgICAgIGxlbmd0aCsrOwogICAgICAgIH0KICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZS5zdWJzZWN0aW9uID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCB3ZXN0TGVycCwgc291dGhMZXJwLCBlYXN0TGVycCwgbm9ydGhMZXJwLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoIndlc3RMZXJwIiwgd2VzdExlcnAsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJ3ZXN0TGVycCIsIHdlc3RMZXJwLCAxKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygic291dGhMZXJwIiwgc291dGhMZXJwLCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygic291dGhMZXJwIiwgc291dGhMZXJwLCAxKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiZWFzdExlcnAiLCBlYXN0TGVycCwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoImVhc3RMZXJwIiwgZWFzdExlcnAsIDEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJub3J0aExlcnAiLCBub3J0aExlcnAsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJub3J0aExlcnAiLCBub3J0aExlcnAsIDEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJ3ZXN0TGVycCIsIHdlc3RMZXJwLCBlYXN0TGVycCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoInNvdXRoTGVycCIsIHNvdXRoTGVycCwgbm9ydGhMZXJwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgUmVjdGFuZ2xlKCk7CiAgICAgICAgfQogICAgICAgIGlmIChyZWN0YW5nbGUud2VzdCA8PSByZWN0YW5nbGUuZWFzdCkgewogICAgICAgICAgY29uc3Qgd2lkdGggPSByZWN0YW5nbGUuZWFzdCAtIHJlY3RhbmdsZS53ZXN0OwogICAgICAgICAgcmVzdWx0Lndlc3QgPSByZWN0YW5nbGUud2VzdCArIHdlc3RMZXJwICogd2lkdGg7CiAgICAgICAgICByZXN1bHQuZWFzdCA9IHJlY3RhbmdsZS53ZXN0ICsgZWFzdExlcnAgKiB3aWR0aDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3Qgd2lkdGggPSBNYXRoX2RlZmF1bHQuVFdPX1BJICsgcmVjdGFuZ2xlLmVhc3QgLSByZWN0YW5nbGUud2VzdDsKICAgICAgICAgIHJlc3VsdC53ZXN0ID0gTWF0aF9kZWZhdWx0Lm5lZ2F0aXZlUGlUb1BpKHJlY3RhbmdsZS53ZXN0ICsgd2VzdExlcnAgKiB3aWR0aCk7CiAgICAgICAgICByZXN1bHQuZWFzdCA9IE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaShyZWN0YW5nbGUud2VzdCArIGVhc3RMZXJwICogd2lkdGgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBoZWlnaHQgPSByZWN0YW5nbGUubm9ydGggLSByZWN0YW5nbGUuc291dGg7CiAgICAgICAgcmVzdWx0LnNvdXRoID0gcmVjdGFuZ2xlLnNvdXRoICsgc291dGhMZXJwICogaGVpZ2h0OwogICAgICAgIHJlc3VsdC5ub3J0aCA9IHJlY3RhbmdsZS5zb3V0aCArIG5vcnRoTGVycCAqIGhlaWdodDsKICAgICAgICBpZiAod2VzdExlcnAgPT09IDEpIHsKICAgICAgICAgIHJlc3VsdC53ZXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgfQogICAgICAgIGlmIChlYXN0TGVycCA9PT0gMSkgewogICAgICAgICAgcmVzdWx0LmVhc3QgPSByZWN0YW5nbGUuZWFzdDsKICAgICAgICB9CiAgICAgICAgaWYgKHNvdXRoTGVycCA9PT0gMSkgewogICAgICAgICAgcmVzdWx0LnNvdXRoID0gcmVjdGFuZ2xlLm5vcnRoOwogICAgICAgIH0KICAgICAgICBpZiAobm9ydGhMZXJwID09PSAxKSB7CiAgICAgICAgICByZXN1bHQubm9ydGggPSByZWN0YW5nbGUubm9ydGg7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZS5NQVhfVkFMVUUgPSBPYmplY3QuZnJlZXplKAogICAgICAgIG5ldyBSZWN0YW5nbGUoCiAgICAgICAgICAtTWF0aC5QSSwKICAgICAgICAgIC1NYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08sCiAgICAgICAgICBNYXRoLlBJLAogICAgICAgICAgTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPCiAgICAgICAgKQogICAgICApOwogICAgICBSZWN0YW5nbGVfZGVmYXVsdCA9IFJlY3RhbmdsZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0JvdW5kaW5nU3BoZXJlLmpzCiAgZnVuY3Rpb24gQm91bmRpbmdTcGhlcmUoY2VudGVyLCByYWRpdXMpIHsKICAgIHRoaXMuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNlbnRlciwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pKTsKICAgIHRoaXMucmFkaXVzID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQocmFkaXVzLCAwKTsKICB9CiAgdmFyIGZyb21Qb2ludHNYTWluLCBmcm9tUG9pbnRzWU1pbiwgZnJvbVBvaW50c1pNaW4sIGZyb21Qb2ludHNYTWF4LCBmcm9tUG9pbnRzWU1heCwgZnJvbVBvaW50c1pNYXgsIGZyb21Qb2ludHNDdXJyZW50UG9zLCBmcm9tUG9pbnRzU2NyYXRjaCwgZnJvbVBvaW50c1JpdHRlckNlbnRlciwgZnJvbVBvaW50c01pbkJveFB0LCBmcm9tUG9pbnRzTWF4Qm94UHQsIGZyb21Qb2ludHNOYWl2ZUNlbnRlclNjcmF0Y2gsIHZvbHVtZUNvbnN0YW50LCBkZWZhdWx0UHJvamVjdGlvbiwgZnJvbVJlY3RhbmdsZTJETG93ZXJMZWZ0LCBmcm9tUmVjdGFuZ2xlMkRVcHBlclJpZ2h0LCBmcm9tUmVjdGFuZ2xlMkRTb3V0aHdlc3QsIGZyb21SZWN0YW5nbGUyRE5vcnRoZWFzdCwgZnJvbVJlY3RhbmdsZTNEU2NyYXRjaCwgZnJvbUJvdW5kaW5nU3BoZXJlc1NjcmF0Y2gsIGZyb21PcmllbnRlZEJvdW5kaW5nQm94U2NyYXRjaFUsIGZyb21PcmllbnRlZEJvdW5kaW5nQm94U2NyYXRjaFYsIGZyb21PcmllbnRlZEJvdW5kaW5nQm94U2NyYXRjaFcsIHNjcmF0Y2hGcm9tVHJhbnNmb3JtYXRpb25DZW50ZXIsIHNjcmF0Y2hGcm9tVHJhbnNmb3JtYXRpb25TY2FsZSwgdW5pb25TY3JhdGNoLCB1bmlvblNjcmF0Y2hDZW50ZXIsIGV4cGFuZFNjcmF0Y2gsIGRpc3RhbmNlU3F1YXJlZFRvU2NyYXRjaCwgc2NyYXRjaENhcnRlc2lhbjMsIHByb2plY3RUbzJETm9ybWFsU2NyYXRjaCwgcHJvamVjdFRvMkRFYXN0U2NyYXRjaCwgcHJvamVjdFRvMkROb3J0aFNjcmF0Y2gsIHByb2plY3RUbzJEV2VzdFNjcmF0Y2gsIHByb2plY3RUbzJEU291dGhTY3JhdGNoLCBwcm9qZWN0VG8yRENhcnRvZ3JhcGhpY1NjcmF0Y2gsIHByb2plY3RUbzJEUG9zaXRpb25zU2NyYXRjaCwgcHJvamVjdFRvMkRQcm9qZWN0aW9uLCBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0OwogIHZhciBpbml0X0JvdW5kaW5nU3BoZXJlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Cb3VuZGluZ1NwaGVyZS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb2dyYXBoaWNQcm9qZWN0aW9uKCk7CiAgICAgIGluaXRfSW50ZXJzZWN0KCk7CiAgICAgIGluaXRfSW50ZXJ2YWwoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgZnJvbVBvaW50c1hNaW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZyb21Qb2ludHNZTWluID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUG9pbnRzWk1pbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZnJvbVBvaW50c1hNYXggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZyb21Qb2ludHNZTWF4ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUG9pbnRzWk1heCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZnJvbVBvaW50c0N1cnJlbnRQb3MgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZyb21Qb2ludHNTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUG9pbnRzUml0dGVyQ2VudGVyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUG9pbnRzTWluQm94UHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZyb21Qb2ludHNNYXhCb3hQdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZnJvbVBvaW50c05haXZlQ2VudGVyU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdm9sdW1lQ29uc3RhbnQgPSA0IC8gMyAqIE1hdGhfZGVmYXVsdC5QSTsKICAgICAgQm91bmRpbmdTcGhlcmUuZnJvbVBvaW50cyA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgfHwgcG9zaXRpb25zLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmVzdWx0LmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgICByZXN1bHQucmFkaXVzID0gMDsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGN1cnJlbnRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocG9zaXRpb25zWzBdLCBmcm9tUG9pbnRzQ3VycmVudFBvcyk7CiAgICAgICAgY29uc3QgeE1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWE1pbik7CiAgICAgICAgY29uc3QgeU1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWU1pbik7CiAgICAgICAgY29uc3Qgek1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWk1pbik7CiAgICAgICAgY29uc3QgeE1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWE1heCk7CiAgICAgICAgY29uc3QgeU1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWU1heCk7CiAgICAgICAgY29uc3Qgek1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWk1heCk7CiAgICAgICAgY29uc3QgbnVtUG9zaXRpb25zID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBsZXQgaTsKICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbnVtUG9zaXRpb25zOyBpKyspIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwb3NpdGlvbnNbaV0sIGN1cnJlbnRQb3MpOwogICAgICAgICAgY29uc3QgeCA9IGN1cnJlbnRQb3MueDsKICAgICAgICAgIGNvbnN0IHkgPSBjdXJyZW50UG9zLnk7CiAgICAgICAgICBjb25zdCB6ID0gY3VycmVudFBvcy56OwogICAgICAgICAgaWYgKHggPCB4TWluLngpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHhNaW4pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHggPiB4TWF4LngpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHhNYXgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHkgPCB5TWluLnkpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHlNaW4pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHkgPiB5TWF4LnkpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHlNYXgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHogPCB6TWluLnopIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHpNaW4pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHogPiB6TWF4LnopIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHpNYXgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCB4U3BhbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHhNYXgsIHhNaW4sIGZyb21Qb2ludHNTY3JhdGNoKQogICAgICAgICk7CiAgICAgICAgY29uc3QgeVNwYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCh5TWF4LCB5TWluLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICApOwogICAgICAgIGNvbnN0IHpTcGFuID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3Qoek1heCwgek1pbiwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgKTsKICAgICAgICBsZXQgZGlhbWV0ZXIxID0geE1pbjsKICAgICAgICBsZXQgZGlhbWV0ZXIyID0geE1heDsKICAgICAgICBsZXQgbWF4U3BhbiA9IHhTcGFuOwogICAgICAgIGlmICh5U3BhbiA+IG1heFNwYW4pIHsKICAgICAgICAgIG1heFNwYW4gPSB5U3BhbjsKICAgICAgICAgIGRpYW1ldGVyMSA9IHlNaW47CiAgICAgICAgICBkaWFtZXRlcjIgPSB5TWF4OwogICAgICAgIH0KICAgICAgICBpZiAoelNwYW4gPiBtYXhTcGFuKSB7CiAgICAgICAgICBtYXhTcGFuID0gelNwYW47CiAgICAgICAgICBkaWFtZXRlcjEgPSB6TWluOwogICAgICAgICAgZGlhbWV0ZXIyID0gek1heDsKICAgICAgICB9CiAgICAgICAgY29uc3Qgcml0dGVyQ2VudGVyID0gZnJvbVBvaW50c1JpdHRlckNlbnRlcjsKICAgICAgICByaXR0ZXJDZW50ZXIueCA9IChkaWFtZXRlcjEueCArIGRpYW1ldGVyMi54KSAqIDAuNTsKICAgICAgICByaXR0ZXJDZW50ZXIueSA9IChkaWFtZXRlcjEueSArIGRpYW1ldGVyMi55KSAqIDAuNTsKICAgICAgICByaXR0ZXJDZW50ZXIueiA9IChkaWFtZXRlcjEueiArIGRpYW1ldGVyMi56KSAqIDAuNTsKICAgICAgICBsZXQgcmFkaXVzU3F1YXJlZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGRpYW1ldGVyMiwgcml0dGVyQ2VudGVyLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICApOwogICAgICAgIGxldCByaXR0ZXJSYWRpdXMgPSBNYXRoLnNxcnQocmFkaXVzU3F1YXJlZCk7CiAgICAgICAgY29uc3QgbWluQm94UHQgPSBmcm9tUG9pbnRzTWluQm94UHQ7CiAgICAgICAgbWluQm94UHQueCA9IHhNaW4ueDsKICAgICAgICBtaW5Cb3hQdC55ID0geU1pbi55OwogICAgICAgIG1pbkJveFB0LnogPSB6TWluLno7CiAgICAgICAgY29uc3QgbWF4Qm94UHQgPSBmcm9tUG9pbnRzTWF4Qm94UHQ7CiAgICAgICAgbWF4Qm94UHQueCA9IHhNYXgueDsKICAgICAgICBtYXhCb3hQdC55ID0geU1heC55OwogICAgICAgIG1heEJveFB0LnogPSB6TWF4Lno7CiAgICAgICAgY29uc3QgbmFpdmVDZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWlkcG9pbnQoCiAgICAgICAgICBtaW5Cb3hQdCwKICAgICAgICAgIG1heEJveFB0LAogICAgICAgICAgZnJvbVBvaW50c05haXZlQ2VudGVyU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgbGV0IG5haXZlUmFkaXVzID0gMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtUG9zaXRpb25zOyBpKyspIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwb3NpdGlvbnNbaV0sIGN1cnJlbnRQb3MpOwogICAgICAgICAgY29uc3QgciA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjdXJyZW50UG9zLCBuYWl2ZUNlbnRlciwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgICApOwogICAgICAgICAgaWYgKHIgPiBuYWl2ZVJhZGl1cykgewogICAgICAgICAgICBuYWl2ZVJhZGl1cyA9IHI7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBvbGRDZW50ZXJUb1BvaW50U3F1YXJlZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY3VycmVudFBvcywgcml0dGVyQ2VudGVyLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICAgICk7CiAgICAgICAgICBpZiAob2xkQ2VudGVyVG9Qb2ludFNxdWFyZWQgPiByYWRpdXNTcXVhcmVkKSB7CiAgICAgICAgICAgIGNvbnN0IG9sZENlbnRlclRvUG9pbnQgPSBNYXRoLnNxcnQob2xkQ2VudGVyVG9Qb2ludFNxdWFyZWQpOwogICAgICAgICAgICByaXR0ZXJSYWRpdXMgPSAocml0dGVyUmFkaXVzICsgb2xkQ2VudGVyVG9Qb2ludCkgKiAwLjU7CiAgICAgICAgICAgIHJhZGl1c1NxdWFyZWQgPSByaXR0ZXJSYWRpdXMgKiByaXR0ZXJSYWRpdXM7CiAgICAgICAgICAgIGNvbnN0IG9sZFRvTmV3ID0gb2xkQ2VudGVyVG9Qb2ludCAtIHJpdHRlclJhZGl1czsKICAgICAgICAgICAgcml0dGVyQ2VudGVyLnggPSAocml0dGVyUmFkaXVzICogcml0dGVyQ2VudGVyLnggKyBvbGRUb05ldyAqIGN1cnJlbnRQb3MueCkgLyBvbGRDZW50ZXJUb1BvaW50OwogICAgICAgICAgICByaXR0ZXJDZW50ZXIueSA9IChyaXR0ZXJSYWRpdXMgKiByaXR0ZXJDZW50ZXIueSArIG9sZFRvTmV3ICogY3VycmVudFBvcy55KSAvIG9sZENlbnRlclRvUG9pbnQ7CiAgICAgICAgICAgIHJpdHRlckNlbnRlci56ID0gKHJpdHRlclJhZGl1cyAqIHJpdHRlckNlbnRlci56ICsgb2xkVG9OZXcgKiBjdXJyZW50UG9zLnopIC8gb2xkQ2VudGVyVG9Qb2ludDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHJpdHRlclJhZGl1cyA8IG5haXZlUmFkaXVzKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocml0dGVyQ2VudGVyLCByZXN1bHQuY2VudGVyKTsKICAgICAgICAgIHJlc3VsdC5yYWRpdXMgPSByaXR0ZXJSYWRpdXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShuYWl2ZUNlbnRlciwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgICByZXN1bHQucmFkaXVzID0gbmFpdmVSYWRpdXM7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGRlZmF1bHRQcm9qZWN0aW9uID0gbmV3IEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQoKTsKICAgICAgZnJvbVJlY3RhbmdsZTJETG93ZXJMZWZ0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUmVjdGFuZ2xlMkRVcHBlclJpZ2h0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUmVjdGFuZ2xlMkRTb3V0aHdlc3QgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgZnJvbVJlY3RhbmdsZTJETm9ydGhlYXN0ID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIEJvdW5kaW5nU3BoZXJlLmZyb21SZWN0YW5nbGUyRCA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgcHJvamVjdGlvbiwgcmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIEJvdW5kaW5nU3BoZXJlLmZyb21SZWN0YW5nbGVXaXRoSGVpZ2h0czJEKAogICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgcHJvamVjdGlvbiwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUuZnJvbVJlY3RhbmdsZVdpdGhIZWlnaHRzMkQgPSBmdW5jdGlvbihyZWN0YW5nbGUsIHByb2plY3Rpb24sIG1pbmltdW1IZWlnaHQsIG1heGltdW1IZWlnaHQsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBCb3VuZGluZ1NwaGVyZSgpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZWN0YW5nbGUpKSB7CiAgICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCByZXN1bHQuY2VudGVyKTsKICAgICAgICAgIHJlc3VsdC5yYWRpdXMgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcHJvamVjdGlvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHByb2plY3Rpb24sIGRlZmF1bHRQcm9qZWN0aW9uKTsKICAgICAgICBSZWN0YW5nbGVfZGVmYXVsdC5zb3V0aHdlc3QocmVjdGFuZ2xlLCBmcm9tUmVjdGFuZ2xlMkRTb3V0aHdlc3QpOwogICAgICAgIGZyb21SZWN0YW5nbGUyRFNvdXRod2VzdC5oZWlnaHQgPSBtaW5pbXVtSGVpZ2h0OwogICAgICAgIFJlY3RhbmdsZV9kZWZhdWx0Lm5vcnRoZWFzdChyZWN0YW5nbGUsIGZyb21SZWN0YW5nbGUyRE5vcnRoZWFzdCk7CiAgICAgICAgZnJvbVJlY3RhbmdsZTJETm9ydGhlYXN0LmhlaWdodCA9IG1heGltdW1IZWlnaHQ7CiAgICAgICAgY29uc3QgbG93ZXJMZWZ0ID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgZnJvbVJlY3RhbmdsZTJEU291dGh3ZXN0LAogICAgICAgICAgZnJvbVJlY3RhbmdsZTJETG93ZXJMZWZ0CiAgICAgICAgKTsKICAgICAgICBjb25zdCB1cHBlclJpZ2h0ID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgZnJvbVJlY3RhbmdsZTJETm9ydGhlYXN0LAogICAgICAgICAgZnJvbVJlY3RhbmdsZTJEVXBwZXJSaWdodAogICAgICAgICk7CiAgICAgICAgY29uc3Qgd2lkdGggPSB1cHBlclJpZ2h0LnggLSBsb3dlckxlZnQueDsKICAgICAgICBjb25zdCBoZWlnaHQgPSB1cHBlclJpZ2h0LnkgLSBsb3dlckxlZnQueTsKICAgICAgICBjb25zdCBlbGV2YXRpb24gPSB1cHBlclJpZ2h0LnogLSBsb3dlckxlZnQuejsKICAgICAgICByZXN1bHQucmFkaXVzID0gTWF0aC5zcXJ0KHdpZHRoICogd2lkdGggKyBoZWlnaHQgKiBoZWlnaHQgKyBlbGV2YXRpb24gKiBlbGV2YXRpb24pICogMC41OwogICAgICAgIGNvbnN0IGNlbnRlciA9IHJlc3VsdC5jZW50ZXI7CiAgICAgICAgY2VudGVyLnggPSBsb3dlckxlZnQueCArIHdpZHRoICogMC41OwogICAgICAgIGNlbnRlci55ID0gbG93ZXJMZWZ0LnkgKyBoZWlnaHQgKiAwLjU7CiAgICAgICAgY2VudGVyLnogPSBsb3dlckxlZnQueiArIGVsZXZhdGlvbiAqIDAuNTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBmcm9tUmVjdGFuZ2xlM0RTY3JhdGNoID0gW107CiAgICAgIEJvdW5kaW5nU3BoZXJlLmZyb21SZWN0YW5nbGUzRCA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgZWxsaXBzb2lkLCBzdXJmYWNlSGVpZ2h0LCByZXN1bHQpIHsKICAgICAgICBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgICAgICBzdXJmYWNlSGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3VyZmFjZUhlaWdodCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlY3RhbmdsZSkpIHsKICAgICAgICAgIHJlc3VsdC5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIHJlc3VsdC5jZW50ZXIpOwogICAgICAgICAgcmVzdWx0LnJhZGl1cyA9IDA7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBSZWN0YW5nbGVfZGVmYXVsdC5zdWJzYW1wbGUoCiAgICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBzdXJmYWNlSGVpZ2h0LAogICAgICAgICAgZnJvbVJlY3RhbmdsZTNEU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgcmV0dXJuIEJvdW5kaW5nU3BoZXJlLmZyb21Qb2ludHMocG9zaXRpb25zLCByZXN1bHQpOwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5mcm9tVmVydGljZXMgPSBmdW5jdGlvbihwb3NpdGlvbnMsIGNlbnRlciwgc3RyaWRlLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdTcGhlcmUoKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSB8fCBwb3NpdGlvbnMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCByZXN1bHQuY2VudGVyKTsKICAgICAgICAgIHJlc3VsdC5yYWRpdXMgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY2VudGVyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY2VudGVyLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTyk7CiAgICAgICAgc3RyaWRlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RyaWRlLCAzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygic3RyaWRlIiwgc3RyaWRlLCAzKTsKICAgICAgICBjb25zdCBjdXJyZW50UG9zID0gZnJvbVBvaW50c0N1cnJlbnRQb3M7CiAgICAgICAgY3VycmVudFBvcy54ID0gcG9zaXRpb25zWzBdICsgY2VudGVyLng7CiAgICAgICAgY3VycmVudFBvcy55ID0gcG9zaXRpb25zWzFdICsgY2VudGVyLnk7CiAgICAgICAgY3VycmVudFBvcy56ID0gcG9zaXRpb25zWzJdICsgY2VudGVyLno7CiAgICAgICAgY29uc3QgeE1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWE1pbik7CiAgICAgICAgY29uc3QgeU1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWU1pbik7CiAgICAgICAgY29uc3Qgek1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWk1pbik7CiAgICAgICAgY29uc3QgeE1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWE1heCk7CiAgICAgICAgY29uc3QgeU1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWU1heCk7CiAgICAgICAgY29uc3Qgek1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWk1heCk7CiAgICAgICAgY29uc3QgbnVtRWxlbWVudHMgPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGxldCBpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1FbGVtZW50czsgaSArPSBzdHJpZGUpIHsKICAgICAgICAgIGNvbnN0IHggPSBwb3NpdGlvbnNbaV0gKyBjZW50ZXIueDsKICAgICAgICAgIGNvbnN0IHkgPSBwb3NpdGlvbnNbaSArIDFdICsgY2VudGVyLnk7CiAgICAgICAgICBjb25zdCB6ID0gcG9zaXRpb25zW2kgKyAyXSArIGNlbnRlci56OwogICAgICAgICAgY3VycmVudFBvcy54ID0geDsKICAgICAgICAgIGN1cnJlbnRQb3MueSA9IHk7CiAgICAgICAgICBjdXJyZW50UG9zLnogPSB6OwogICAgICAgICAgaWYgKHggPCB4TWluLngpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHhNaW4pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHggPiB4TWF4LngpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHhNYXgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHkgPCB5TWluLnkpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHlNaW4pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHkgPiB5TWF4LnkpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHlNYXgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHogPCB6TWluLnopIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHpNaW4pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHogPiB6TWF4LnopIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHpNYXgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCB4U3BhbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHhNYXgsIHhNaW4sIGZyb21Qb2ludHNTY3JhdGNoKQogICAgICAgICk7CiAgICAgICAgY29uc3QgeVNwYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCh5TWF4LCB5TWluLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICApOwogICAgICAgIGNvbnN0IHpTcGFuID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3Qoek1heCwgek1pbiwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgKTsKICAgICAgICBsZXQgZGlhbWV0ZXIxID0geE1pbjsKICAgICAgICBsZXQgZGlhbWV0ZXIyID0geE1heDsKICAgICAgICBsZXQgbWF4U3BhbiA9IHhTcGFuOwogICAgICAgIGlmICh5U3BhbiA+IG1heFNwYW4pIHsKICAgICAgICAgIG1heFNwYW4gPSB5U3BhbjsKICAgICAgICAgIGRpYW1ldGVyMSA9IHlNaW47CiAgICAgICAgICBkaWFtZXRlcjIgPSB5TWF4OwogICAgICAgIH0KICAgICAgICBpZiAoelNwYW4gPiBtYXhTcGFuKSB7CiAgICAgICAgICBtYXhTcGFuID0gelNwYW47CiAgICAgICAgICBkaWFtZXRlcjEgPSB6TWluOwogICAgICAgICAgZGlhbWV0ZXIyID0gek1heDsKICAgICAgICB9CiAgICAgICAgY29uc3Qgcml0dGVyQ2VudGVyID0gZnJvbVBvaW50c1JpdHRlckNlbnRlcjsKICAgICAgICByaXR0ZXJDZW50ZXIueCA9IChkaWFtZXRlcjEueCArIGRpYW1ldGVyMi54KSAqIDAuNTsKICAgICAgICByaXR0ZXJDZW50ZXIueSA9IChkaWFtZXRlcjEueSArIGRpYW1ldGVyMi55KSAqIDAuNTsKICAgICAgICByaXR0ZXJDZW50ZXIueiA9IChkaWFtZXRlcjEueiArIGRpYW1ldGVyMi56KSAqIDAuNTsKICAgICAgICBsZXQgcmFkaXVzU3F1YXJlZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGRpYW1ldGVyMiwgcml0dGVyQ2VudGVyLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICApOwogICAgICAgIGxldCByaXR0ZXJSYWRpdXMgPSBNYXRoLnNxcnQocmFkaXVzU3F1YXJlZCk7CiAgICAgICAgY29uc3QgbWluQm94UHQgPSBmcm9tUG9pbnRzTWluQm94UHQ7CiAgICAgICAgbWluQm94UHQueCA9IHhNaW4ueDsKICAgICAgICBtaW5Cb3hQdC55ID0geU1pbi55OwogICAgICAgIG1pbkJveFB0LnogPSB6TWluLno7CiAgICAgICAgY29uc3QgbWF4Qm94UHQgPSBmcm9tUG9pbnRzTWF4Qm94UHQ7CiAgICAgICAgbWF4Qm94UHQueCA9IHhNYXgueDsKICAgICAgICBtYXhCb3hQdC55ID0geU1heC55OwogICAgICAgIG1heEJveFB0LnogPSB6TWF4Lno7CiAgICAgICAgY29uc3QgbmFpdmVDZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWlkcG9pbnQoCiAgICAgICAgICBtaW5Cb3hQdCwKICAgICAgICAgIG1heEJveFB0LAogICAgICAgICAgZnJvbVBvaW50c05haXZlQ2VudGVyU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgbGV0IG5haXZlUmFkaXVzID0gMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtRWxlbWVudHM7IGkgKz0gc3RyaWRlKSB7CiAgICAgICAgICBjdXJyZW50UG9zLnggPSBwb3NpdGlvbnNbaV0gKyBjZW50ZXIueDsKICAgICAgICAgIGN1cnJlbnRQb3MueSA9IHBvc2l0aW9uc1tpICsgMV0gKyBjZW50ZXIueTsKICAgICAgICAgIGN1cnJlbnRQb3MueiA9IHBvc2l0aW9uc1tpICsgMl0gKyBjZW50ZXIuejsKICAgICAgICAgIGNvbnN0IHIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY3VycmVudFBvcywgbmFpdmVDZW50ZXIsIGZyb21Qb2ludHNTY3JhdGNoKQogICAgICAgICAgKTsKICAgICAgICAgIGlmIChyID4gbmFpdmVSYWRpdXMpIHsKICAgICAgICAgICAgbmFpdmVSYWRpdXMgPSByOwogICAgICAgICAgfQogICAgICAgICAgY29uc3Qgb2xkQ2VudGVyVG9Qb2ludFNxdWFyZWQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCgKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGN1cnJlbnRQb3MsIHJpdHRlckNlbnRlciwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgICApOwogICAgICAgICAgaWYgKG9sZENlbnRlclRvUG9pbnRTcXVhcmVkID4gcmFkaXVzU3F1YXJlZCkgewogICAgICAgICAgICBjb25zdCBvbGRDZW50ZXJUb1BvaW50ID0gTWF0aC5zcXJ0KG9sZENlbnRlclRvUG9pbnRTcXVhcmVkKTsKICAgICAgICAgICAgcml0dGVyUmFkaXVzID0gKHJpdHRlclJhZGl1cyArIG9sZENlbnRlclRvUG9pbnQpICogMC41OwogICAgICAgICAgICByYWRpdXNTcXVhcmVkID0gcml0dGVyUmFkaXVzICogcml0dGVyUmFkaXVzOwogICAgICAgICAgICBjb25zdCBvbGRUb05ldyA9IG9sZENlbnRlclRvUG9pbnQgLSByaXR0ZXJSYWRpdXM7CiAgICAgICAgICAgIHJpdHRlckNlbnRlci54ID0gKHJpdHRlclJhZGl1cyAqIHJpdHRlckNlbnRlci54ICsgb2xkVG9OZXcgKiBjdXJyZW50UG9zLngpIC8gb2xkQ2VudGVyVG9Qb2ludDsKICAgICAgICAgICAgcml0dGVyQ2VudGVyLnkgPSAocml0dGVyUmFkaXVzICogcml0dGVyQ2VudGVyLnkgKyBvbGRUb05ldyAqIGN1cnJlbnRQb3MueSkgLyBvbGRDZW50ZXJUb1BvaW50OwogICAgICAgICAgICByaXR0ZXJDZW50ZXIueiA9IChyaXR0ZXJSYWRpdXMgKiByaXR0ZXJDZW50ZXIueiArIG9sZFRvTmV3ICogY3VycmVudFBvcy56KSAvIG9sZENlbnRlclRvUG9pbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChyaXR0ZXJSYWRpdXMgPCBuYWl2ZVJhZGl1cykgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHJpdHRlckNlbnRlciwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgICByZXN1bHQucmFkaXVzID0gcml0dGVyUmFkaXVzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUobmFpdmVDZW50ZXIsIHJlc3VsdC5jZW50ZXIpOwogICAgICAgICAgcmVzdWx0LnJhZGl1cyA9IG5haXZlUmFkaXVzOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5mcm9tRW5jb2RlZENhcnRlc2lhblZlcnRpY2VzID0gZnVuY3Rpb24ocG9zaXRpb25zSGlnaCwgcG9zaXRpb25zTG93LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdTcGhlcmUoKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zSGlnaCkgfHwgIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnNMb3cpIHx8IHBvc2l0aW9uc0hpZ2gubGVuZ3RoICE9PSBwb3NpdGlvbnNMb3cubGVuZ3RoIHx8IHBvc2l0aW9uc0hpZ2gubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCByZXN1bHQuY2VudGVyKTsKICAgICAgICAgIHJlc3VsdC5yYWRpdXMgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY29uc3QgY3VycmVudFBvcyA9IGZyb21Qb2ludHNDdXJyZW50UG9zOwogICAgICAgIGN1cnJlbnRQb3MueCA9IHBvc2l0aW9uc0hpZ2hbMF0gKyBwb3NpdGlvbnNMb3dbMF07CiAgICAgICAgY3VycmVudFBvcy55ID0gcG9zaXRpb25zSGlnaFsxXSArIHBvc2l0aW9uc0xvd1sxXTsKICAgICAgICBjdXJyZW50UG9zLnogPSBwb3NpdGlvbnNIaWdoWzJdICsgcG9zaXRpb25zTG93WzJdOwogICAgICAgIGNvbnN0IHhNaW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgZnJvbVBvaW50c1hNaW4pOwogICAgICAgIGNvbnN0IHlNaW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgZnJvbVBvaW50c1lNaW4pOwogICAgICAgIGNvbnN0IHpNaW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgZnJvbVBvaW50c1pNaW4pOwogICAgICAgIGNvbnN0IHhNYXggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgZnJvbVBvaW50c1hNYXgpOwogICAgICAgIGNvbnN0IHlNYXggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgZnJvbVBvaW50c1lNYXgpOwogICAgICAgIGNvbnN0IHpNYXggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgZnJvbVBvaW50c1pNYXgpOwogICAgICAgIGNvbnN0IG51bUVsZW1lbnRzID0gcG9zaXRpb25zSGlnaC5sZW5ndGg7CiAgICAgICAgbGV0IGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IG51bUVsZW1lbnRzOyBpICs9IDMpIHsKICAgICAgICAgIGNvbnN0IHggPSBwb3NpdGlvbnNIaWdoW2ldICsgcG9zaXRpb25zTG93W2ldOwogICAgICAgICAgY29uc3QgeSA9IHBvc2l0aW9uc0hpZ2hbaSArIDFdICsgcG9zaXRpb25zTG93W2kgKyAxXTsKICAgICAgICAgIGNvbnN0IHogPSBwb3NpdGlvbnNIaWdoW2kgKyAyXSArIHBvc2l0aW9uc0xvd1tpICsgMl07CiAgICAgICAgICBjdXJyZW50UG9zLnggPSB4OwogICAgICAgICAgY3VycmVudFBvcy55ID0geTsKICAgICAgICAgIGN1cnJlbnRQb3MueiA9IHo7CiAgICAgICAgICBpZiAoeCA8IHhNaW4ueCkgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgeE1pbik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoeCA+IHhNYXgueCkgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgeE1heCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoeSA8IHlNaW4ueSkgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgeU1pbik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoeSA+IHlNYXgueSkgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgeU1heCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoeiA8IHpNaW4ueikgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgek1pbik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoeiA+IHpNYXgueikgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgek1heCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IHhTcGFuID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoeE1heCwgeE1pbiwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgKTsKICAgICAgICBjb25zdCB5U3BhbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHlNYXgsIHlNaW4sIGZyb21Qb2ludHNTY3JhdGNoKQogICAgICAgICk7CiAgICAgICAgY29uc3QgelNwYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCh6TWF4LCB6TWluLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICApOwogICAgICAgIGxldCBkaWFtZXRlcjEgPSB4TWluOwogICAgICAgIGxldCBkaWFtZXRlcjIgPSB4TWF4OwogICAgICAgIGxldCBtYXhTcGFuID0geFNwYW47CiAgICAgICAgaWYgKHlTcGFuID4gbWF4U3BhbikgewogICAgICAgICAgbWF4U3BhbiA9IHlTcGFuOwogICAgICAgICAgZGlhbWV0ZXIxID0geU1pbjsKICAgICAgICAgIGRpYW1ldGVyMiA9IHlNYXg7CiAgICAgICAgfQogICAgICAgIGlmICh6U3BhbiA+IG1heFNwYW4pIHsKICAgICAgICAgIG1heFNwYW4gPSB6U3BhbjsKICAgICAgICAgIGRpYW1ldGVyMSA9IHpNaW47CiAgICAgICAgICBkaWFtZXRlcjIgPSB6TWF4OwogICAgICAgIH0KICAgICAgICBjb25zdCByaXR0ZXJDZW50ZXIgPSBmcm9tUG9pbnRzUml0dGVyQ2VudGVyOwogICAgICAgIHJpdHRlckNlbnRlci54ID0gKGRpYW1ldGVyMS54ICsgZGlhbWV0ZXIyLngpICogMC41OwogICAgICAgIHJpdHRlckNlbnRlci55ID0gKGRpYW1ldGVyMS55ICsgZGlhbWV0ZXIyLnkpICogMC41OwogICAgICAgIHJpdHRlckNlbnRlci56ID0gKGRpYW1ldGVyMS56ICsgZGlhbWV0ZXIyLnopICogMC41OwogICAgICAgIGxldCByYWRpdXNTcXVhcmVkID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoZGlhbWV0ZXIyLCByaXR0ZXJDZW50ZXIsIGZyb21Qb2ludHNTY3JhdGNoKQogICAgICAgICk7CiAgICAgICAgbGV0IHJpdHRlclJhZGl1cyA9IE1hdGguc3FydChyYWRpdXNTcXVhcmVkKTsKICAgICAgICBjb25zdCBtaW5Cb3hQdCA9IGZyb21Qb2ludHNNaW5Cb3hQdDsKICAgICAgICBtaW5Cb3hQdC54ID0geE1pbi54OwogICAgICAgIG1pbkJveFB0LnkgPSB5TWluLnk7CiAgICAgICAgbWluQm94UHQueiA9IHpNaW4uejsKICAgICAgICBjb25zdCBtYXhCb3hQdCA9IGZyb21Qb2ludHNNYXhCb3hQdDsKICAgICAgICBtYXhCb3hQdC54ID0geE1heC54OwogICAgICAgIG1heEJveFB0LnkgPSB5TWF4Lnk7CiAgICAgICAgbWF4Qm94UHQueiA9IHpNYXguejsKICAgICAgICBjb25zdCBuYWl2ZUNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5taWRwb2ludCgKICAgICAgICAgIG1pbkJveFB0LAogICAgICAgICAgbWF4Qm94UHQsCiAgICAgICAgICBmcm9tUG9pbnRzTmFpdmVDZW50ZXJTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBsZXQgbmFpdmVSYWRpdXMgPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1FbGVtZW50czsgaSArPSAzKSB7CiAgICAgICAgICBjdXJyZW50UG9zLnggPSBwb3NpdGlvbnNIaWdoW2ldICsgcG9zaXRpb25zTG93W2ldOwogICAgICAgICAgY3VycmVudFBvcy55ID0gcG9zaXRpb25zSGlnaFtpICsgMV0gKyBwb3NpdGlvbnNMb3dbaSArIDFdOwogICAgICAgICAgY3VycmVudFBvcy56ID0gcG9zaXRpb25zSGlnaFtpICsgMl0gKyBwb3NpdGlvbnNMb3dbaSArIDJdOwogICAgICAgICAgY29uc3QgciA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjdXJyZW50UG9zLCBuYWl2ZUNlbnRlciwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgICApOwogICAgICAgICAgaWYgKHIgPiBuYWl2ZVJhZGl1cykgewogICAgICAgICAgICBuYWl2ZVJhZGl1cyA9IHI7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBvbGRDZW50ZXJUb1BvaW50U3F1YXJlZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY3VycmVudFBvcywgcml0dGVyQ2VudGVyLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICAgICk7CiAgICAgICAgICBpZiAob2xkQ2VudGVyVG9Qb2ludFNxdWFyZWQgPiByYWRpdXNTcXVhcmVkKSB7CiAgICAgICAgICAgIGNvbnN0IG9sZENlbnRlclRvUG9pbnQgPSBNYXRoLnNxcnQob2xkQ2VudGVyVG9Qb2ludFNxdWFyZWQpOwogICAgICAgICAgICByaXR0ZXJSYWRpdXMgPSAocml0dGVyUmFkaXVzICsgb2xkQ2VudGVyVG9Qb2ludCkgKiAwLjU7CiAgICAgICAgICAgIHJhZGl1c1NxdWFyZWQgPSByaXR0ZXJSYWRpdXMgKiByaXR0ZXJSYWRpdXM7CiAgICAgICAgICAgIGNvbnN0IG9sZFRvTmV3ID0gb2xkQ2VudGVyVG9Qb2ludCAtIHJpdHRlclJhZGl1czsKICAgICAgICAgICAgcml0dGVyQ2VudGVyLnggPSAocml0dGVyUmFkaXVzICogcml0dGVyQ2VudGVyLnggKyBvbGRUb05ldyAqIGN1cnJlbnRQb3MueCkgLyBvbGRDZW50ZXJUb1BvaW50OwogICAgICAgICAgICByaXR0ZXJDZW50ZXIueSA9IChyaXR0ZXJSYWRpdXMgKiByaXR0ZXJDZW50ZXIueSArIG9sZFRvTmV3ICogY3VycmVudFBvcy55KSAvIG9sZENlbnRlclRvUG9pbnQ7CiAgICAgICAgICAgIHJpdHRlckNlbnRlci56ID0gKHJpdHRlclJhZGl1cyAqIHJpdHRlckNlbnRlci56ICsgb2xkVG9OZXcgKiBjdXJyZW50UG9zLnopIC8gb2xkQ2VudGVyVG9Qb2ludDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHJpdHRlclJhZGl1cyA8IG5haXZlUmFkaXVzKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocml0dGVyQ2VudGVyLCByZXN1bHQuY2VudGVyKTsKICAgICAgICAgIHJlc3VsdC5yYWRpdXMgPSByaXR0ZXJSYWRpdXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShuYWl2ZUNlbnRlciwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgICByZXN1bHQucmFkaXVzID0gbmFpdmVSYWRpdXM7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLmZyb21Db3JuZXJQb2ludHMgPSBmdW5jdGlvbihjb3JuZXIsIG9wcG9zaXRlQ29ybmVyLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNvcm5lciIsIGNvcm5lcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvcHBvc2l0ZUNvcm5lciIsIG9wcG9zaXRlQ29ybmVyKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdTcGhlcmUoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1pZHBvaW50KGNvcm5lciwgb3Bwb3NpdGVDb3JuZXIsIHJlc3VsdC5jZW50ZXIpOwogICAgICAgIHJlc3VsdC5yYWRpdXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZGlzdGFuY2UoY2VudGVyLCBvcHBvc2l0ZUNvcm5lcik7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUuZnJvbUVsbGlwc29pZCA9IGZ1bmN0aW9uKGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJlbGxpcHNvaWQiLCBlbGxpcHNvaWQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBCb3VuZGluZ1NwaGVyZSgpOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIHJlc3VsdC5jZW50ZXIpOwogICAgICAgIHJlc3VsdC5yYWRpdXMgPSBlbGxpcHNvaWQubWF4aW11bVJhZGl1czsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBmcm9tQm91bmRpbmdTcGhlcmVzU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgQm91bmRpbmdTcGhlcmUuZnJvbUJvdW5kaW5nU3BoZXJlcyA9IGZ1bmN0aW9uKGJvdW5kaW5nU3BoZXJlcywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJvdW5kaW5nU3BoZXJlcykgfHwgYm91bmRpbmdTcGhlcmVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmVzdWx0LmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgICByZXN1bHQucmFkaXVzID0gMDsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGJvdW5kaW5nU3BoZXJlcy5sZW5ndGg7CiAgICAgICAgaWYgKGxlbmd0aCA9PT0gMSkgewogICAgICAgICAgcmV0dXJuIEJvdW5kaW5nU3BoZXJlLmNsb25lKGJvdW5kaW5nU3BoZXJlc1swXSwgcmVzdWx0KTsKICAgICAgICB9CiAgICAgICAgaWYgKGxlbmd0aCA9PT0gMikgewogICAgICAgICAgcmV0dXJuIEJvdW5kaW5nU3BoZXJlLnVuaW9uKGJvdW5kaW5nU3BoZXJlc1swXSwgYm91bmRpbmdTcGhlcmVzWzFdLCByZXN1bHQpOwogICAgICAgIH0KICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBbXTsKICAgICAgICBsZXQgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHBvc2l0aW9ucy5wdXNoKGJvdW5kaW5nU3BoZXJlc1tpXS5jZW50ZXIpOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSBCb3VuZGluZ1NwaGVyZS5mcm9tUG9pbnRzKHBvc2l0aW9ucywgcmVzdWx0KTsKICAgICAgICBjb25zdCBjZW50ZXIgPSByZXN1bHQuY2VudGVyOwogICAgICAgIGxldCByYWRpdXMgPSByZXN1bHQucmFkaXVzOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgdG1wMiA9IGJvdW5kaW5nU3BoZXJlc1tpXTsKICAgICAgICAgIHJhZGl1cyA9IE1hdGgubWF4KAogICAgICAgICAgICByYWRpdXMsCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5kaXN0YW5jZShjZW50ZXIsIHRtcDIuY2VudGVyLCBmcm9tQm91bmRpbmdTcGhlcmVzU2NyYXRjaCkgKyB0bXAyLnJhZGl1cwogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnJhZGl1cyA9IHJhZGl1czsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBmcm9tT3JpZW50ZWRCb3VuZGluZ0JveFNjcmF0Y2hVID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tT3JpZW50ZWRCb3VuZGluZ0JveFNjcmF0Y2hWID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tT3JpZW50ZWRCb3VuZGluZ0JveFNjcmF0Y2hXID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBCb3VuZGluZ1NwaGVyZS5mcm9tT3JpZW50ZWRCb3VuZGluZ0JveCA9IGZ1bmN0aW9uKG9yaWVudGVkQm91bmRpbmdCb3gsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib3JpZW50ZWRCb3VuZGluZ0JveCIsIG9yaWVudGVkQm91bmRpbmdCb3gpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBCb3VuZGluZ1NwaGVyZSgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBoYWxmQXhlcyA9IG9yaWVudGVkQm91bmRpbmdCb3guaGFsZkF4ZXM7CiAgICAgICAgY29uc3QgdTMgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAwLCBmcm9tT3JpZW50ZWRCb3VuZGluZ0JveFNjcmF0Y2hVKTsKICAgICAgICBjb25zdCB2MyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDEsIGZyb21PcmllbnRlZEJvdW5kaW5nQm94U2NyYXRjaFYpOwogICAgICAgIGNvbnN0IHcgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAyLCBmcm9tT3JpZW50ZWRCb3VuZGluZ0JveFNjcmF0Y2hXKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHUzLCB2MywgdTMpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQodTMsIHcsIHUzKTsKICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG9yaWVudGVkQm91bmRpbmdCb3guY2VudGVyLCByZXN1bHQuY2VudGVyKTsKICAgICAgICByZXN1bHQucmFkaXVzID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSh1Myk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaEZyb21UcmFuc2Zvcm1hdGlvbkNlbnRlciA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEZyb21UcmFuc2Zvcm1hdGlvblNjYWxlID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBCb3VuZGluZ1NwaGVyZS5mcm9tVHJhbnNmb3JtYXRpb24gPSBmdW5jdGlvbih0cmFuc2Zvcm1hdGlvbiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ0cmFuc2Zvcm1hdGlvbiIsIHRyYW5zZm9ybWF0aW9uKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdTcGhlcmUoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY2VudGVyID0gTWF0cml4NF9kZWZhdWx0LmdldFRyYW5zbGF0aW9uKAogICAgICAgICAgdHJhbnNmb3JtYXRpb24sCiAgICAgICAgICBzY3JhdGNoRnJvbVRyYW5zZm9ybWF0aW9uQ2VudGVyCiAgICAgICAgKTsKICAgICAgICBjb25zdCBzY2FsZSA9IE1hdHJpeDRfZGVmYXVsdC5nZXRTY2FsZSgKICAgICAgICAgIHRyYW5zZm9ybWF0aW9uLAogICAgICAgICAgc2NyYXRjaEZyb21UcmFuc2Zvcm1hdGlvblNjYWxlCiAgICAgICAgKTsKICAgICAgICBjb25zdCByYWRpdXMgPSAwLjUgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKHNjYWxlKTsKICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlciwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgcmVzdWx0LnJhZGl1cyA9IHJhZGl1czsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5jbG9uZSA9IGZ1bmN0aW9uKHNwaGVyZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc3BoZXJlKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBCb3VuZGluZ1NwaGVyZShzcGhlcmUuY2VudGVyLCBzcGhlcmUucmFkaXVzKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShzcGhlcmUuY2VudGVyLCByZXN1bHQuY2VudGVyKTsKICAgICAgICByZXN1bHQucmFkaXVzID0gc3BoZXJlLnJhZGl1czsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5wYWNrZWRMZW5ndGggPSA0OwogICAgICBCb3VuZGluZ1NwaGVyZS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBjZW50ZXIgPSB2YWx1ZS5jZW50ZXI7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGNlbnRlci54OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBjZW50ZXIueTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gY2VudGVyLno7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5yYWRpdXM7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNlbnRlciA9IHJlc3VsdC5jZW50ZXI7CiAgICAgICAgY2VudGVyLnggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNlbnRlci55ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjZW50ZXIueiA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LnJhZGl1cyA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHVuaW9uU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdW5pb25TY3JhdGNoQ2VudGVyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBCb3VuZGluZ1NwaGVyZS51bmlvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBCb3VuZGluZ1NwaGVyZSgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZWZ0Q2VudGVyID0gbGVmdC5jZW50ZXI7CiAgICAgICAgY29uc3QgbGVmdFJhZGl1cyA9IGxlZnQucmFkaXVzOwogICAgICAgIGNvbnN0IHJpZ2h0Q2VudGVyID0gcmlnaHQuY2VudGVyOwogICAgICAgIGNvbnN0IHJpZ2h0UmFkaXVzID0gcmlnaHQucmFkaXVzOwogICAgICAgIGNvbnN0IHRvUmlnaHRDZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICByaWdodENlbnRlciwKICAgICAgICAgIGxlZnRDZW50ZXIsCiAgICAgICAgICB1bmlvblNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IGNlbnRlclNlcGFyYXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKHRvUmlnaHRDZW50ZXIpOwogICAgICAgIGlmIChsZWZ0UmFkaXVzID49IGNlbnRlclNlcGFyYXRpb24gKyByaWdodFJhZGl1cykgewogICAgICAgICAgbGVmdC5jbG9uZShyZXN1bHQpOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgaWYgKHJpZ2h0UmFkaXVzID49IGNlbnRlclNlcGFyYXRpb24gKyBsZWZ0UmFkaXVzKSB7CiAgICAgICAgICByaWdodC5jbG9uZShyZXN1bHQpOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY29uc3QgaGFsZkRpc3RhbmNlQmV0d2VlblRhbmdlbnRQb2ludHMgPSAobGVmdFJhZGl1cyArIGNlbnRlclNlcGFyYXRpb24gKyByaWdodFJhZGl1cykgKiAwLjU7CiAgICAgICAgY29uc3QgY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICB0b1JpZ2h0Q2VudGVyLAogICAgICAgICAgKC1sZWZ0UmFkaXVzICsgaGFsZkRpc3RhbmNlQmV0d2VlblRhbmdlbnRQb2ludHMpIC8gY2VudGVyU2VwYXJhdGlvbiwKICAgICAgICAgIHVuaW9uU2NyYXRjaENlbnRlcgogICAgICAgICk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChjZW50ZXIsIGxlZnRDZW50ZXIsIGNlbnRlcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlciwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgcmVzdWx0LnJhZGl1cyA9IGhhbGZEaXN0YW5jZUJldHdlZW5UYW5nZW50UG9pbnRzOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGV4cGFuZFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEJvdW5kaW5nU3BoZXJlLmV4cGFuZCA9IGZ1bmN0aW9uKHNwaGVyZSwgcG9pbnQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3BoZXJlIiwgc3BoZXJlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInBvaW50IiwgcG9pbnQpOwogICAgICAgIHJlc3VsdCA9IEJvdW5kaW5nU3BoZXJlLmNsb25lKHNwaGVyZSwgcmVzdWx0KTsKICAgICAgICBjb25zdCByYWRpdXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHBvaW50LCByZXN1bHQuY2VudGVyLCBleHBhbmRTY3JhdGNoKQogICAgICAgICk7CiAgICAgICAgaWYgKHJhZGl1cyA+IHJlc3VsdC5yYWRpdXMpIHsKICAgICAgICAgIHJlc3VsdC5yYWRpdXMgPSByYWRpdXM7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLmludGVyc2VjdFBsYW5lID0gZnVuY3Rpb24oc3BoZXJlLCBwbGFuZSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3BoZXJlIiwgc3BoZXJlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInBsYW5lIiwgcGxhbmUpOwogICAgICAgIGNvbnN0IGNlbnRlciA9IHNwaGVyZS5jZW50ZXI7CiAgICAgICAgY29uc3QgcmFkaXVzID0gc3BoZXJlLnJhZGl1czsKICAgICAgICBjb25zdCBub3JtYWwyID0gcGxhbmUubm9ybWFsOwogICAgICAgIGNvbnN0IGRpc3RhbmNlVG9QbGFuZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3Qobm9ybWFsMiwgY2VudGVyKSArIHBsYW5lLmRpc3RhbmNlOwogICAgICAgIGlmIChkaXN0YW5jZVRvUGxhbmUgPCAtcmFkaXVzKSB7CiAgICAgICAgICByZXR1cm4gSW50ZXJzZWN0X2RlZmF1bHQuT1VUU0lERTsKICAgICAgICB9IGVsc2UgaWYgKGRpc3RhbmNlVG9QbGFuZSA8IHJhZGl1cykgewogICAgICAgICAgcmV0dXJuIEludGVyc2VjdF9kZWZhdWx0LklOVEVSU0VDVElORzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIEludGVyc2VjdF9kZWZhdWx0LklOU0lERTsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUudHJhbnNmb3JtID0gZnVuY3Rpb24oc3BoZXJlLCB0cmFuc2Zvcm0yLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNwaGVyZSIsIHNwaGVyZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ0cmFuc2Zvcm0iLCB0cmFuc2Zvcm0yKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdTcGhlcmUoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmNlbnRlciA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnQoCiAgICAgICAgICB0cmFuc2Zvcm0yLAogICAgICAgICAgc3BoZXJlLmNlbnRlciwKICAgICAgICAgIHJlc3VsdC5jZW50ZXIKICAgICAgICApOwogICAgICAgIHJlc3VsdC5yYWRpdXMgPSBNYXRyaXg0X2RlZmF1bHQuZ2V0TWF4aW11bVNjYWxlKHRyYW5zZm9ybTIpICogc3BoZXJlLnJhZGl1czsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBkaXN0YW5jZVNxdWFyZWRUb1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEJvdW5kaW5nU3BoZXJlLmRpc3RhbmNlU3F1YXJlZFRvID0gZnVuY3Rpb24oc3BoZXJlLCBjYXJ0ZXNpYW4xMSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3BoZXJlIiwgc3BoZXJlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBjb25zdCBkaWZmID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgc3BoZXJlLmNlbnRlciwKICAgICAgICAgIGNhcnRlc2lhbjExLAogICAgICAgICAgZGlzdGFuY2VTcXVhcmVkVG9TY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBkaXN0YW5jZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoZGlmZikgLSBzcGhlcmUucmFkaXVzOwogICAgICAgIGlmIChkaXN0YW5jZSA8PSAwKSB7CiAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRpc3RhbmNlICogZGlzdGFuY2U7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLnRyYW5zZm9ybVdpdGhvdXRTY2FsZSA9IGZ1bmN0aW9uKHNwaGVyZSwgdHJhbnNmb3JtMiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzcGhlcmUiLCBzcGhlcmUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidHJhbnNmb3JtIiwgdHJhbnNmb3JtMik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5jZW50ZXIgPSBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50KAogICAgICAgICAgdHJhbnNmb3JtMiwKICAgICAgICAgIHNwaGVyZS5jZW50ZXIsCiAgICAgICAgICByZXN1bHQuY2VudGVyCiAgICAgICAgKTsKICAgICAgICByZXN1bHQucmFkaXVzID0gc3BoZXJlLnJhZGl1czsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoQ2FydGVzaWFuMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgQm91bmRpbmdTcGhlcmUuY29tcHV0ZVBsYW5lRGlzdGFuY2VzID0gZnVuY3Rpb24oc3BoZXJlLCBwb3NpdGlvbiwgZGlyZWN0aW9uMiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzcGhlcmUiLCBzcGhlcmUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicG9zaXRpb24iLCBwb3NpdGlvbik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJkaXJlY3Rpb24iLCBkaXJlY3Rpb24yKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgSW50ZXJ2YWxfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCB0b0NlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgIHNwaGVyZS5jZW50ZXIsCiAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zCiAgICAgICAgKTsKICAgICAgICBjb25zdCBtYWcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjIsIHRvQ2VudGVyKTsKICAgICAgICByZXN1bHQuc3RhcnQgPSBtYWcgLSBzcGhlcmUucmFkaXVzOwogICAgICAgIHJlc3VsdC5zdG9wID0gbWFnICsgc3BoZXJlLnJhZGl1czsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBwcm9qZWN0VG8yRE5vcm1hbFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHByb2plY3RUbzJERWFzdFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHByb2plY3RUbzJETm9ydGhTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwcm9qZWN0VG8yRFdlc3RTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwcm9qZWN0VG8yRFNvdXRoU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcHJvamVjdFRvMkRDYXJ0b2dyYXBoaWNTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHByb2plY3RUbzJEUG9zaXRpb25zU2NyYXRjaCA9IG5ldyBBcnJheSg4KTsKICAgICAgZm9yIChsZXQgbiA9IDA7IG4gPCA4OyArK24pIHsKICAgICAgICBwcm9qZWN0VG8yRFBvc2l0aW9uc1NjcmF0Y2hbbl0gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIH0KICAgICAgcHJvamVjdFRvMkRQcm9qZWN0aW9uID0gbmV3IEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQoKTsKICAgICAgQm91bmRpbmdTcGhlcmUucHJvamVjdFRvMkQgPSBmdW5jdGlvbihzcGhlcmUsIHByb2plY3Rpb24sIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3BoZXJlIiwgc3BoZXJlKTsKICAgICAgICBwcm9qZWN0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQocHJvamVjdGlvbiwgcHJvamVjdFRvMkRQcm9qZWN0aW9uKTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBwcm9qZWN0aW9uLmVsbGlwc29pZDsKICAgICAgICBsZXQgY2VudGVyID0gc3BoZXJlLmNlbnRlcjsKICAgICAgICBjb25zdCByYWRpdXMgPSBzcGhlcmUucmFkaXVzOwogICAgICAgIGxldCBub3JtYWwyOwogICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKGNlbnRlciwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pKSB7CiAgICAgICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1gsIHByb2plY3RUbzJETm9ybWFsU2NyYXRjaCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG5vcm1hbDIgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKGNlbnRlciwgcHJvamVjdFRvMkROb3JtYWxTY3JhdGNoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZWFzdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcygKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1osCiAgICAgICAgICBub3JtYWwyLAogICAgICAgICAgcHJvamVjdFRvMkRFYXN0U2NyYXRjaAogICAgICAgICk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShlYXN0LCBlYXN0KTsKICAgICAgICBjb25zdCBub3J0aCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhub3JtYWwyLCBlYXN0LCBwcm9qZWN0VG8yRE5vcnRoU2NyYXRjaCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShub3J0aCwgbm9ydGgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG5vcm1hbDIsIHJhZGl1cywgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobm9ydGgsIHJhZGl1cywgbm9ydGgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGVhc3QsIHJhZGl1cywgZWFzdCk7CiAgICAgICAgY29uc3Qgc291dGggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKG5vcnRoLCBwcm9qZWN0VG8yRFNvdXRoU2NyYXRjaCk7CiAgICAgICAgY29uc3Qgd2VzdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoZWFzdCwgcHJvamVjdFRvMkRXZXN0U2NyYXRjaCk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gcHJvamVjdFRvMkRQb3NpdGlvbnNTY3JhdGNoOwogICAgICAgIGxldCBjb3JuZXIgPSBwb3NpdGlvbnNbMF07CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChub3JtYWwyLCBub3J0aCwgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgZWFzdCwgY29ybmVyKTsKICAgICAgICBjb3JuZXIgPSBwb3NpdGlvbnNbMV07CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChub3JtYWwyLCBub3J0aCwgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgd2VzdCwgY29ybmVyKTsKICAgICAgICBjb3JuZXIgPSBwb3NpdGlvbnNbMl07CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChub3JtYWwyLCBzb3V0aCwgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgd2VzdCwgY29ybmVyKTsKICAgICAgICBjb3JuZXIgPSBwb3NpdGlvbnNbM107CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChub3JtYWwyLCBzb3V0aCwgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgZWFzdCwgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgIGNvcm5lciA9IHBvc2l0aW9uc1s0XTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5vcm1hbDIsIG5vcnRoLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCBlYXN0LCBjb3JuZXIpOwogICAgICAgIGNvcm5lciA9IHBvc2l0aW9uc1s1XTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5vcm1hbDIsIG5vcnRoLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCB3ZXN0LCBjb3JuZXIpOwogICAgICAgIGNvcm5lciA9IHBvc2l0aW9uc1s2XTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5vcm1hbDIsIHNvdXRoLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCB3ZXN0LCBjb3JuZXIpOwogICAgICAgIGNvcm5lciA9IHBvc2l0aW9uc1s3XTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5vcm1hbDIsIHNvdXRoLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCBlYXN0LCBjb3JuZXIpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgY29uc3QgcG9zaXRpb24gPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNlbnRlciwgcG9zaXRpb24sIHBvc2l0aW9uKTsKICAgICAgICAgIGNvbnN0IGNhcnRvZ3JhcGhpYzIgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICBwcm9qZWN0VG8yRENhcnRvZ3JhcGhpY1NjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBwcm9qZWN0aW9uLnByb2plY3QoY2FydG9ncmFwaGljMiwgcG9zaXRpb24pOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSBCb3VuZGluZ1NwaGVyZS5mcm9tUG9pbnRzKHBvc2l0aW9ucywgcmVzdWx0KTsKICAgICAgICBjZW50ZXIgPSByZXN1bHQuY2VudGVyOwogICAgICAgIGNvbnN0IHggPSBjZW50ZXIueDsKICAgICAgICBjb25zdCB5ID0gY2VudGVyLnk7CiAgICAgICAgY29uc3QgeiA9IGNlbnRlci56OwogICAgICAgIGNlbnRlci54ID0gejsKICAgICAgICBjZW50ZXIueSA9IHg7CiAgICAgICAgY2VudGVyLnogPSB5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLmlzT2NjbHVkZWQgPSBmdW5jdGlvbihzcGhlcmUsIG9jY2x1ZGVyKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzcGhlcmUiLCBzcGhlcmUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib2NjbHVkZXIiLCBvY2NsdWRlcik7CiAgICAgICAgcmV0dXJuICFvY2NsdWRlci5pc0JvdW5kaW5nU3BoZXJlVmlzaWJsZShzcGhlcmUpOwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKGxlZnQuY2VudGVyLCByaWdodC5jZW50ZXIpICYmIGxlZnQucmFkaXVzID09PSByaWdodC5yYWRpdXM7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLnByb3RvdHlwZS5pbnRlcnNlY3RQbGFuZSA9IGZ1bmN0aW9uKHBsYW5lKSB7CiAgICAgICAgcmV0dXJuIEJvdW5kaW5nU3BoZXJlLmludGVyc2VjdFBsYW5lKHRoaXMsIHBsYW5lKTsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUucHJvdG90eXBlLmRpc3RhbmNlU3F1YXJlZFRvID0gZnVuY3Rpb24oY2FydGVzaWFuMTEpIHsKICAgICAgICByZXR1cm4gQm91bmRpbmdTcGhlcmUuZGlzdGFuY2VTcXVhcmVkVG8odGhpcywgY2FydGVzaWFuMTEpOwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5wcm90b3R5cGUuY29tcHV0ZVBsYW5lRGlzdGFuY2VzID0gZnVuY3Rpb24ocG9zaXRpb24sIGRpcmVjdGlvbjIsIHJlc3VsdCkgewogICAgICAgIHJldHVybiBCb3VuZGluZ1NwaGVyZS5jb21wdXRlUGxhbmVEaXN0YW5jZXMoCiAgICAgICAgICB0aGlzLAogICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICBkaXJlY3Rpb24yLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUucHJvdG90eXBlLmlzT2NjbHVkZWQgPSBmdW5jdGlvbihvY2NsdWRlcikgewogICAgICAgIHJldHVybiBCb3VuZGluZ1NwaGVyZS5pc09jY2x1ZGVkKHRoaXMsIG9jY2x1ZGVyKTsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIEJvdW5kaW5nU3BoZXJlLmVxdWFscyh0aGlzLCByaWdodCk7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJldHVybiBCb3VuZGluZ1NwaGVyZS5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5wcm90b3R5cGUudm9sdW1lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY29uc3QgcmFkaXVzID0gdGhpcy5yYWRpdXM7CiAgICAgICAgcmV0dXJuIHZvbHVtZUNvbnN0YW50ICogcmFkaXVzICogcmFkaXVzICogcmFkaXVzOwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0ID0gQm91bmRpbmdTcGhlcmU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9XZWJHTENvbnN0YW50cy5qcwogIHZhciBXZWJHTENvbnN0YW50cywgV2ViR0xDb25zdGFudHNfZGVmYXVsdDsKICB2YXIgaW5pdF9XZWJHTENvbnN0YW50cyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvV2ViR0xDb25zdGFudHMuanMiKCkgewogICAgICBXZWJHTENvbnN0YW50cyA9IHsKICAgICAgICBERVBUSF9CVUZGRVJfQklUOiAyNTYsCiAgICAgICAgU1RFTkNJTF9CVUZGRVJfQklUOiAxMDI0LAogICAgICAgIENPTE9SX0JVRkZFUl9CSVQ6IDE2Mzg0LAogICAgICAgIFBPSU5UUzogMCwKICAgICAgICBMSU5FUzogMSwKICAgICAgICBMSU5FX0xPT1A6IDIsCiAgICAgICAgTElORV9TVFJJUDogMywKICAgICAgICBUUklBTkdMRVM6IDQsCiAgICAgICAgVFJJQU5HTEVfU1RSSVA6IDUsCiAgICAgICAgVFJJQU5HTEVfRkFOOiA2LAogICAgICAgIFpFUk86IDAsCiAgICAgICAgT05FOiAxLAogICAgICAgIFNSQ19DT0xPUjogNzY4LAogICAgICAgIE9ORV9NSU5VU19TUkNfQ09MT1I6IDc2OSwKICAgICAgICBTUkNfQUxQSEE6IDc3MCwKICAgICAgICBPTkVfTUlOVVNfU1JDX0FMUEhBOiA3NzEsCiAgICAgICAgRFNUX0FMUEhBOiA3NzIsCiAgICAgICAgT05FX01JTlVTX0RTVF9BTFBIQTogNzczLAogICAgICAgIERTVF9DT0xPUjogNzc0LAogICAgICAgIE9ORV9NSU5VU19EU1RfQ09MT1I6IDc3NSwKICAgICAgICBTUkNfQUxQSEFfU0FUVVJBVEU6IDc3NiwKICAgICAgICBGVU5DX0FERDogMzI3NzQsCiAgICAgICAgQkxFTkRfRVFVQVRJT046IDMyNzc3LAogICAgICAgIEJMRU5EX0VRVUFUSU9OX1JHQjogMzI3NzcsCiAgICAgICAgLy8gc2FtZSBhcyBCTEVORF9FUVVBVElPTgogICAgICAgIEJMRU5EX0VRVUFUSU9OX0FMUEhBOiAzNDg3NywKICAgICAgICBGVU5DX1NVQlRSQUNUOiAzMjc3OCwKICAgICAgICBGVU5DX1JFVkVSU0VfU1VCVFJBQ1Q6IDMyNzc5LAogICAgICAgIEJMRU5EX0RTVF9SR0I6IDMyOTY4LAogICAgICAgIEJMRU5EX1NSQ19SR0I6IDMyOTY5LAogICAgICAgIEJMRU5EX0RTVF9BTFBIQTogMzI5NzAsCiAgICAgICAgQkxFTkRfU1JDX0FMUEhBOiAzMjk3MSwKICAgICAgICBDT05TVEFOVF9DT0xPUjogMzI3NjksCiAgICAgICAgT05FX01JTlVTX0NPTlNUQU5UX0NPTE9SOiAzMjc3MCwKICAgICAgICBDT05TVEFOVF9BTFBIQTogMzI3NzEsCiAgICAgICAgT05FX01JTlVTX0NPTlNUQU5UX0FMUEhBOiAzMjc3MiwKICAgICAgICBCTEVORF9DT0xPUjogMzI3NzMsCiAgICAgICAgQVJSQVlfQlVGRkVSOiAzNDk2MiwKICAgICAgICBFTEVNRU5UX0FSUkFZX0JVRkZFUjogMzQ5NjMsCiAgICAgICAgQVJSQVlfQlVGRkVSX0JJTkRJTkc6IDM0OTY0LAogICAgICAgIEVMRU1FTlRfQVJSQVlfQlVGRkVSX0JJTkRJTkc6IDM0OTY1LAogICAgICAgIFNUUkVBTV9EUkFXOiAzNTA0MCwKICAgICAgICBTVEFUSUNfRFJBVzogMzUwNDQsCiAgICAgICAgRFlOQU1JQ19EUkFXOiAzNTA0OCwKICAgICAgICBCVUZGRVJfU0laRTogMzQ2NjAsCiAgICAgICAgQlVGRkVSX1VTQUdFOiAzNDY2MSwKICAgICAgICBDVVJSRU5UX1ZFUlRFWF9BVFRSSUI6IDM0MzQyLAogICAgICAgIEZST05UOiAxMDI4LAogICAgICAgIEJBQ0s6IDEwMjksCiAgICAgICAgRlJPTlRfQU5EX0JBQ0s6IDEwMzIsCiAgICAgICAgQ1VMTF9GQUNFOiAyODg0LAogICAgICAgIEJMRU5EOiAzMDQyLAogICAgICAgIERJVEhFUjogMzAyNCwKICAgICAgICBTVEVOQ0lMX1RFU1Q6IDI5NjAsCiAgICAgICAgREVQVEhfVEVTVDogMjkyOSwKICAgICAgICBTQ0lTU09SX1RFU1Q6IDMwODksCiAgICAgICAgUE9MWUdPTl9PRkZTRVRfRklMTDogMzI4MjMsCiAgICAgICAgU0FNUExFX0FMUEhBX1RPX0NPVkVSQUdFOiAzMjkyNiwKICAgICAgICBTQU1QTEVfQ09WRVJBR0U6IDMyOTI4LAogICAgICAgIE5PX0VSUk9SOiAwLAogICAgICAgIElOVkFMSURfRU5VTTogMTI4MCwKICAgICAgICBJTlZBTElEX1ZBTFVFOiAxMjgxLAogICAgICAgIElOVkFMSURfT1BFUkFUSU9OOiAxMjgyLAogICAgICAgIE9VVF9PRl9NRU1PUlk6IDEyODUsCiAgICAgICAgQ1c6IDIzMDQsCiAgICAgICAgQ0NXOiAyMzA1LAogICAgICAgIExJTkVfV0lEVEg6IDI4NDksCiAgICAgICAgQUxJQVNFRF9QT0lOVF9TSVpFX1JBTkdFOiAzMzkwMSwKICAgICAgICBBTElBU0VEX0xJTkVfV0lEVEhfUkFOR0U6IDMzOTAyLAogICAgICAgIENVTExfRkFDRV9NT0RFOiAyODg1LAogICAgICAgIEZST05UX0ZBQ0U6IDI4ODYsCiAgICAgICAgREVQVEhfUkFOR0U6IDI5MjgsCiAgICAgICAgREVQVEhfV1JJVEVNQVNLOiAyOTMwLAogICAgICAgIERFUFRIX0NMRUFSX1ZBTFVFOiAyOTMxLAogICAgICAgIERFUFRIX0ZVTkM6IDI5MzIsCiAgICAgICAgU1RFTkNJTF9DTEVBUl9WQUxVRTogMjk2MSwKICAgICAgICBTVEVOQ0lMX0ZVTkM6IDI5NjIsCiAgICAgICAgU1RFTkNJTF9GQUlMOiAyOTY0LAogICAgICAgIFNURU5DSUxfUEFTU19ERVBUSF9GQUlMOiAyOTY1LAogICAgICAgIFNURU5DSUxfUEFTU19ERVBUSF9QQVNTOiAyOTY2LAogICAgICAgIFNURU5DSUxfUkVGOiAyOTY3LAogICAgICAgIFNURU5DSUxfVkFMVUVfTUFTSzogMjk2MywKICAgICAgICBTVEVOQ0lMX1dSSVRFTUFTSzogMjk2OCwKICAgICAgICBTVEVOQ0lMX0JBQ0tfRlVOQzogMzQ4MTYsCiAgICAgICAgU1RFTkNJTF9CQUNLX0ZBSUw6IDM0ODE3LAogICAgICAgIFNURU5DSUxfQkFDS19QQVNTX0RFUFRIX0ZBSUw6IDM0ODE4LAogICAgICAgIFNURU5DSUxfQkFDS19QQVNTX0RFUFRIX1BBU1M6IDM0ODE5LAogICAgICAgIFNURU5DSUxfQkFDS19SRUY6IDM2MDAzLAogICAgICAgIFNURU5DSUxfQkFDS19WQUxVRV9NQVNLOiAzNjAwNCwKICAgICAgICBTVEVOQ0lMX0JBQ0tfV1JJVEVNQVNLOiAzNjAwNSwKICAgICAgICBWSUVXUE9SVDogMjk3OCwKICAgICAgICBTQ0lTU09SX0JPWDogMzA4OCwKICAgICAgICBDT0xPUl9DTEVBUl9WQUxVRTogMzEwNiwKICAgICAgICBDT0xPUl9XUklURU1BU0s6IDMxMDcsCiAgICAgICAgVU5QQUNLX0FMSUdOTUVOVDogMzMxNywKICAgICAgICBQQUNLX0FMSUdOTUVOVDogMzMzMywKICAgICAgICBNQVhfVEVYVFVSRV9TSVpFOiAzMzc5LAogICAgICAgIE1BWF9WSUVXUE9SVF9ESU1TOiAzMzg2LAogICAgICAgIFNVQlBJWEVMX0JJVFM6IDM0MDgsCiAgICAgICAgUkVEX0JJVFM6IDM0MTAsCiAgICAgICAgR1JFRU5fQklUUzogMzQxMSwKICAgICAgICBCTFVFX0JJVFM6IDM0MTIsCiAgICAgICAgQUxQSEFfQklUUzogMzQxMywKICAgICAgICBERVBUSF9CSVRTOiAzNDE0LAogICAgICAgIFNURU5DSUxfQklUUzogMzQxNSwKICAgICAgICBQT0xZR09OX09GRlNFVF9VTklUUzogMTA3NTIsCiAgICAgICAgUE9MWUdPTl9PRkZTRVRfRkFDVE9SOiAzMjgyNCwKICAgICAgICBURVhUVVJFX0JJTkRJTkdfMkQ6IDMyODczLAogICAgICAgIFNBTVBMRV9CVUZGRVJTOiAzMjkzNiwKICAgICAgICBTQU1QTEVTOiAzMjkzNywKICAgICAgICBTQU1QTEVfQ09WRVJBR0VfVkFMVUU6IDMyOTM4LAogICAgICAgIFNBTVBMRV9DT1ZFUkFHRV9JTlZFUlQ6IDMyOTM5LAogICAgICAgIENPTVBSRVNTRURfVEVYVFVSRV9GT1JNQVRTOiAzNDQ2NywKICAgICAgICBET05UX0NBUkU6IDQzNTIsCiAgICAgICAgRkFTVEVTVDogNDM1MywKICAgICAgICBOSUNFU1Q6IDQzNTQsCiAgICAgICAgR0VORVJBVEVfTUlQTUFQX0hJTlQ6IDMzMTcwLAogICAgICAgIEJZVEU6IDUxMjAsCiAgICAgICAgVU5TSUdORURfQllURTogNTEyMSwKICAgICAgICBTSE9SVDogNTEyMiwKICAgICAgICBVTlNJR05FRF9TSE9SVDogNTEyMywKICAgICAgICBJTlQ6IDUxMjQsCiAgICAgICAgVU5TSUdORURfSU5UOiA1MTI1LAogICAgICAgIEZMT0FUOiA1MTI2LAogICAgICAgIERFUFRIX0NPTVBPTkVOVDogNjQwMiwKICAgICAgICBBTFBIQTogNjQwNiwKICAgICAgICBSR0I6IDY0MDcsCiAgICAgICAgUkdCQTogNjQwOCwKICAgICAgICBMVU1JTkFOQ0U6IDY0MDksCiAgICAgICAgTFVNSU5BTkNFX0FMUEhBOiA2NDEwLAogICAgICAgIFVOU0lHTkVEX1NIT1JUXzRfNF80XzQ6IDMyODE5LAogICAgICAgIFVOU0lHTkVEX1NIT1JUXzVfNV81XzE6IDMyODIwLAogICAgICAgIFVOU0lHTkVEX1NIT1JUXzVfNl81OiAzMzYzNSwKICAgICAgICBGUkFHTUVOVF9TSEFERVI6IDM1NjMyLAogICAgICAgIFZFUlRFWF9TSEFERVI6IDM1NjMzLAogICAgICAgIE1BWF9WRVJURVhfQVRUUklCUzogMzQ5MjEsCiAgICAgICAgTUFYX1ZFUlRFWF9VTklGT1JNX1ZFQ1RPUlM6IDM2MzQ3LAogICAgICAgIE1BWF9WQVJZSU5HX1ZFQ1RPUlM6IDM2MzQ4LAogICAgICAgIE1BWF9DT01CSU5FRF9URVhUVVJFX0lNQUdFX1VOSVRTOiAzNTY2MSwKICAgICAgICBNQVhfVkVSVEVYX1RFWFRVUkVfSU1BR0VfVU5JVFM6IDM1NjYwLAogICAgICAgIE1BWF9URVhUVVJFX0lNQUdFX1VOSVRTOiAzNDkzMCwKICAgICAgICBNQVhfRlJBR01FTlRfVU5JRk9STV9WRUNUT1JTOiAzNjM0OSwKICAgICAgICBTSEFERVJfVFlQRTogMzU2NjMsCiAgICAgICAgREVMRVRFX1NUQVRVUzogMzU3MTIsCiAgICAgICAgTElOS19TVEFUVVM6IDM1NzE0LAogICAgICAgIFZBTElEQVRFX1NUQVRVUzogMzU3MTUsCiAgICAgICAgQVRUQUNIRURfU0hBREVSUzogMzU3MTcsCiAgICAgICAgQUNUSVZFX1VOSUZPUk1TOiAzNTcxOCwKICAgICAgICBBQ1RJVkVfQVRUUklCVVRFUzogMzU3MjEsCiAgICAgICAgU0hBRElOR19MQU5HVUFHRV9WRVJTSU9OOiAzNTcyNCwKICAgICAgICBDVVJSRU5UX1BST0dSQU06IDM1NzI1LAogICAgICAgIE5FVkVSOiA1MTIsCiAgICAgICAgTEVTUzogNTEzLAogICAgICAgIEVRVUFMOiA1MTQsCiAgICAgICAgTEVRVUFMOiA1MTUsCiAgICAgICAgR1JFQVRFUjogNTE2LAogICAgICAgIE5PVEVRVUFMOiA1MTcsCiAgICAgICAgR0VRVUFMOiA1MTgsCiAgICAgICAgQUxXQVlTOiA1MTksCiAgICAgICAgS0VFUDogNzY4MCwKICAgICAgICBSRVBMQUNFOiA3NjgxLAogICAgICAgIElOQ1I6IDc2ODIsCiAgICAgICAgREVDUjogNzY4MywKICAgICAgICBJTlZFUlQ6IDUzODYsCiAgICAgICAgSU5DUl9XUkFQOiAzNDA1NSwKICAgICAgICBERUNSX1dSQVA6IDM0MDU2LAogICAgICAgIFZFTkRPUjogNzkzNiwKICAgICAgICBSRU5ERVJFUjogNzkzNywKICAgICAgICBWRVJTSU9OOiA3OTM4LAogICAgICAgIE5FQVJFU1Q6IDk3MjgsCiAgICAgICAgTElORUFSOiA5NzI5LAogICAgICAgIE5FQVJFU1RfTUlQTUFQX05FQVJFU1Q6IDk5ODQsCiAgICAgICAgTElORUFSX01JUE1BUF9ORUFSRVNUOiA5OTg1LAogICAgICAgIE5FQVJFU1RfTUlQTUFQX0xJTkVBUjogOTk4NiwKICAgICAgICBMSU5FQVJfTUlQTUFQX0xJTkVBUjogOTk4NywKICAgICAgICBURVhUVVJFX01BR19GSUxURVI6IDEwMjQwLAogICAgICAgIFRFWFRVUkVfTUlOX0ZJTFRFUjogMTAyNDEsCiAgICAgICAgVEVYVFVSRV9XUkFQX1M6IDEwMjQyLAogICAgICAgIFRFWFRVUkVfV1JBUF9UOiAxMDI0MywKICAgICAgICBURVhUVVJFXzJEOiAzNTUzLAogICAgICAgIFRFWFRVUkU6IDU4OTAsCiAgICAgICAgVEVYVFVSRV9DVUJFX01BUDogMzQwNjcsCiAgICAgICAgVEVYVFVSRV9CSU5ESU5HX0NVQkVfTUFQOiAzNDA2OCwKICAgICAgICBURVhUVVJFX0NVQkVfTUFQX1BPU0lUSVZFX1g6IDM0MDY5LAogICAgICAgIFRFWFRVUkVfQ1VCRV9NQVBfTkVHQVRJVkVfWDogMzQwNzAsCiAgICAgICAgVEVYVFVSRV9DVUJFX01BUF9QT1NJVElWRV9ZOiAzNDA3MSwKICAgICAgICBURVhUVVJFX0NVQkVfTUFQX05FR0FUSVZFX1k6IDM0MDcyLAogICAgICAgIFRFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWjogMzQwNzMsCiAgICAgICAgVEVYVFVSRV9DVUJFX01BUF9ORUdBVElWRV9aOiAzNDA3NCwKICAgICAgICBNQVhfQ1VCRV9NQVBfVEVYVFVSRV9TSVpFOiAzNDA3NiwKICAgICAgICBURVhUVVJFMDogMzM5ODQsCiAgICAgICAgVEVYVFVSRTE6IDMzOTg1LAogICAgICAgIFRFWFRVUkUyOiAzMzk4NiwKICAgICAgICBURVhUVVJFMzogMzM5ODcsCiAgICAgICAgVEVYVFVSRTQ6IDMzOTg4LAogICAgICAgIFRFWFRVUkU1OiAzMzk4OSwKICAgICAgICBURVhUVVJFNjogMzM5OTAsCiAgICAgICAgVEVYVFVSRTc6IDMzOTkxLAogICAgICAgIFRFWFRVUkU4OiAzMzk5MiwKICAgICAgICBURVhUVVJFOTogMzM5OTMsCiAgICAgICAgVEVYVFVSRTEwOiAzMzk5NCwKICAgICAgICBURVhUVVJFMTE6IDMzOTk1LAogICAgICAgIFRFWFRVUkUxMjogMzM5OTYsCiAgICAgICAgVEVYVFVSRTEzOiAzMzk5NywKICAgICAgICBURVhUVVJFMTQ6IDMzOTk4LAogICAgICAgIFRFWFRVUkUxNTogMzM5OTksCiAgICAgICAgVEVYVFVSRTE2OiAzNGUzLAogICAgICAgIFRFWFRVUkUxNzogMzQwMDEsCiAgICAgICAgVEVYVFVSRTE4OiAzNDAwMiwKICAgICAgICBURVhUVVJFMTk6IDM0MDAzLAogICAgICAgIFRFWFRVUkUyMDogMzQwMDQsCiAgICAgICAgVEVYVFVSRTIxOiAzNDAwNSwKICAgICAgICBURVhUVVJFMjI6IDM0MDA2LAogICAgICAgIFRFWFRVUkUyMzogMzQwMDcsCiAgICAgICAgVEVYVFVSRTI0OiAzNDAwOCwKICAgICAgICBURVhUVVJFMjU6IDM0MDA5LAogICAgICAgIFRFWFRVUkUyNjogMzQwMTAsCiAgICAgICAgVEVYVFVSRTI3OiAzNDAxMSwKICAgICAgICBURVhUVVJFMjg6IDM0MDEyLAogICAgICAgIFRFWFRVUkUyOTogMzQwMTMsCiAgICAgICAgVEVYVFVSRTMwOiAzNDAxNCwKICAgICAgICBURVhUVVJFMzE6IDM0MDE1LAogICAgICAgIEFDVElWRV9URVhUVVJFOiAzNDAxNiwKICAgICAgICBSRVBFQVQ6IDEwNDk3LAogICAgICAgIENMQU1QX1RPX0VER0U6IDMzMDcxLAogICAgICAgIE1JUlJPUkVEX1JFUEVBVDogMzM2NDgsCiAgICAgICAgRkxPQVRfVkVDMjogMzU2NjQsCiAgICAgICAgRkxPQVRfVkVDMzogMzU2NjUsCiAgICAgICAgRkxPQVRfVkVDNDogMzU2NjYsCiAgICAgICAgSU5UX1ZFQzI6IDM1NjY3LAogICAgICAgIElOVF9WRUMzOiAzNTY2OCwKICAgICAgICBJTlRfVkVDNDogMzU2NjksCiAgICAgICAgQk9PTDogMzU2NzAsCiAgICAgICAgQk9PTF9WRUMyOiAzNTY3MSwKICAgICAgICBCT09MX1ZFQzM6IDM1NjcyLAogICAgICAgIEJPT0xfVkVDNDogMzU2NzMsCiAgICAgICAgRkxPQVRfTUFUMjogMzU2NzQsCiAgICAgICAgRkxPQVRfTUFUMzogMzU2NzUsCiAgICAgICAgRkxPQVRfTUFUNDogMzU2NzYsCiAgICAgICAgU0FNUExFUl8yRDogMzU2NzgsCiAgICAgICAgU0FNUExFUl9DVUJFOiAzNTY4MCwKICAgICAgICBWRVJURVhfQVRUUklCX0FSUkFZX0VOQUJMRUQ6IDM0MzM4LAogICAgICAgIFZFUlRFWF9BVFRSSUJfQVJSQVlfU0laRTogMzQzMzksCiAgICAgICAgVkVSVEVYX0FUVFJJQl9BUlJBWV9TVFJJREU6IDM0MzQwLAogICAgICAgIFZFUlRFWF9BVFRSSUJfQVJSQVlfVFlQRTogMzQzNDEsCiAgICAgICAgVkVSVEVYX0FUVFJJQl9BUlJBWV9OT1JNQUxJWkVEOiAzNDkyMiwKICAgICAgICBWRVJURVhfQVRUUklCX0FSUkFZX1BPSU5URVI6IDM0MzczLAogICAgICAgIFZFUlRFWF9BVFRSSUJfQVJSQVlfQlVGRkVSX0JJTkRJTkc6IDM0OTc1LAogICAgICAgIElNUExFTUVOVEFUSU9OX0NPTE9SX1JFQURfVFlQRTogMzU3MzgsCiAgICAgICAgSU1QTEVNRU5UQVRJT05fQ09MT1JfUkVBRF9GT1JNQVQ6IDM1NzM5LAogICAgICAgIENPTVBJTEVfU1RBVFVTOiAzNTcxMywKICAgICAgICBMT1dfRkxPQVQ6IDM2MzM2LAogICAgICAgIE1FRElVTV9GTE9BVDogMzYzMzcsCiAgICAgICAgSElHSF9GTE9BVDogMzYzMzgsCiAgICAgICAgTE9XX0lOVDogMzYzMzksCiAgICAgICAgTUVESVVNX0lOVDogMzYzNDAsCiAgICAgICAgSElHSF9JTlQ6IDM2MzQxLAogICAgICAgIEZSQU1FQlVGRkVSOiAzNjE2MCwKICAgICAgICBSRU5ERVJCVUZGRVI6IDM2MTYxLAogICAgICAgIFJHQkE0OiAzMjg1NCwKICAgICAgICBSR0I1X0ExOiAzMjg1NSwKICAgICAgICBSR0I1NjU6IDM2MTk0LAogICAgICAgIERFUFRIX0NPTVBPTkVOVDE2OiAzMzE4OSwKICAgICAgICBTVEVOQ0lMX0lOREVYOiA2NDAxLAogICAgICAgIFNURU5DSUxfSU5ERVg4OiAzNjE2OCwKICAgICAgICBERVBUSF9TVEVOQ0lMOiAzNDA0MSwKICAgICAgICBSRU5ERVJCVUZGRVJfV0lEVEg6IDM2MTYyLAogICAgICAgIFJFTkRFUkJVRkZFUl9IRUlHSFQ6IDM2MTYzLAogICAgICAgIFJFTkRFUkJVRkZFUl9JTlRFUk5BTF9GT1JNQVQ6IDM2MTY0LAogICAgICAgIFJFTkRFUkJVRkZFUl9SRURfU0laRTogMzYxNzYsCiAgICAgICAgUkVOREVSQlVGRkVSX0dSRUVOX1NJWkU6IDM2MTc3LAogICAgICAgIFJFTkRFUkJVRkZFUl9CTFVFX1NJWkU6IDM2MTc4LAogICAgICAgIFJFTkRFUkJVRkZFUl9BTFBIQV9TSVpFOiAzNjE3OSwKICAgICAgICBSRU5ERVJCVUZGRVJfREVQVEhfU0laRTogMzYxODAsCiAgICAgICAgUkVOREVSQlVGRkVSX1NURU5DSUxfU0laRTogMzYxODEsCiAgICAgICAgRlJBTUVCVUZGRVJfQVRUQUNITUVOVF9PQkpFQ1RfVFlQRTogMzYwNDgsCiAgICAgICAgRlJBTUVCVUZGRVJfQVRUQUNITUVOVF9PQkpFQ1RfTkFNRTogMzYwNDksCiAgICAgICAgRlJBTUVCVUZGRVJfQVRUQUNITUVOVF9URVhUVVJFX0xFVkVMOiAzNjA1MCwKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX1RFWFRVUkVfQ1VCRV9NQVBfRkFDRTogMzYwNTEsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDA6IDM2MDY0LAogICAgICAgIERFUFRIX0FUVEFDSE1FTlQ6IDM2MDk2LAogICAgICAgIFNURU5DSUxfQVRUQUNITUVOVDogMzYxMjgsCiAgICAgICAgREVQVEhfU1RFTkNJTF9BVFRBQ0hNRU5UOiAzMzMwNiwKICAgICAgICBOT05FOiAwLAogICAgICAgIEZSQU1FQlVGRkVSX0NPTVBMRVRFOiAzNjA1MywKICAgICAgICBGUkFNRUJVRkZFUl9JTkNPTVBMRVRFX0FUVEFDSE1FTlQ6IDM2MDU0LAogICAgICAgIEZSQU1FQlVGRkVSX0lOQ09NUExFVEVfTUlTU0lOR19BVFRBQ0hNRU5UOiAzNjA1NSwKICAgICAgICBGUkFNRUJVRkZFUl9JTkNPTVBMRVRFX0RJTUVOU0lPTlM6IDM2MDU3LAogICAgICAgIEZSQU1FQlVGRkVSX1VOU1VQUE9SVEVEOiAzNjA2MSwKICAgICAgICBGUkFNRUJVRkZFUl9CSU5ESU5HOiAzNjAwNiwKICAgICAgICBSRU5ERVJCVUZGRVJfQklORElORzogMzYwMDcsCiAgICAgICAgTUFYX1JFTkRFUkJVRkZFUl9TSVpFOiAzNDAyNCwKICAgICAgICBJTlZBTElEX0ZSQU1FQlVGRkVSX09QRVJBVElPTjogMTI4NiwKICAgICAgICBVTlBBQ0tfRkxJUF9ZX1dFQkdMOiAzNzQ0MCwKICAgICAgICBVTlBBQ0tfUFJFTVVMVElQTFlfQUxQSEFfV0VCR0w6IDM3NDQxLAogICAgICAgIENPTlRFWFRfTE9TVF9XRUJHTDogMzc0NDIsCiAgICAgICAgVU5QQUNLX0NPTE9SU1BBQ0VfQ09OVkVSU0lPTl9XRUJHTDogMzc0NDMsCiAgICAgICAgQlJPV1NFUl9ERUZBVUxUX1dFQkdMOiAzNzQ0NCwKICAgICAgICAvLyBXRUJHTF9jb21wcmVzc2VkX3RleHR1cmVfczN0YwogICAgICAgIENPTVBSRVNTRURfUkdCX1MzVENfRFhUMV9FWFQ6IDMzNzc2LAogICAgICAgIENPTVBSRVNTRURfUkdCQV9TM1RDX0RYVDFfRVhUOiAzMzc3NywKICAgICAgICBDT01QUkVTU0VEX1JHQkFfUzNUQ19EWFQzX0VYVDogMzM3NzgsCiAgICAgICAgQ09NUFJFU1NFRF9SR0JBX1MzVENfRFhUNV9FWFQ6IDMzNzc5LAogICAgICAgIC8vIFdFQkdMX2NvbXByZXNzZWRfdGV4dHVyZV9wdnJ0YwogICAgICAgIENPTVBSRVNTRURfUkdCX1BWUlRDXzRCUFBWMV9JTUc6IDM1ODQwLAogICAgICAgIENPTVBSRVNTRURfUkdCX1BWUlRDXzJCUFBWMV9JTUc6IDM1ODQxLAogICAgICAgIENPTVBSRVNTRURfUkdCQV9QVlJUQ180QlBQVjFfSU1HOiAzNTg0MiwKICAgICAgICBDT01QUkVTU0VEX1JHQkFfUFZSVENfMkJQUFYxX0lNRzogMzU4NDMsCiAgICAgICAgLy8gV0VCR0xfY29tcHJlc3NlZF90ZXh0dXJlX2FzdGMKICAgICAgICBDT01QUkVTU0VEX1JHQkFfQVNUQ180eDRfV0VCR0w6IDM3ODA4LAogICAgICAgIC8vIFdFQkdMX2NvbXByZXNzZWRfdGV4dHVyZV9ldGMxCiAgICAgICAgQ09NUFJFU1NFRF9SR0JfRVRDMV9XRUJHTDogMzYxOTYsCiAgICAgICAgLy8gRVhUX3RleHR1cmVfY29tcHJlc3Npb25fYnB0YwogICAgICAgIENPTVBSRVNTRURfUkdCQV9CUFRDX1VOT1JNOiAzNjQ5MiwKICAgICAgICAvLyBFWFRfY29sb3JfYnVmZmVyX2hhbGZfZmxvYXQKICAgICAgICBIQUxGX0ZMT0FUX09FUzogMzYxOTMsCiAgICAgICAgLy8gRGVza3RvcCBPcGVuR0wKICAgICAgICBET1VCTEU6IDUxMzAsCiAgICAgICAgLy8gV2ViR0wgMgogICAgICAgIFJFQURfQlVGRkVSOiAzMDc0LAogICAgICAgIFVOUEFDS19ST1dfTEVOR1RIOiAzMzE0LAogICAgICAgIFVOUEFDS19TS0lQX1JPV1M6IDMzMTUsCiAgICAgICAgVU5QQUNLX1NLSVBfUElYRUxTOiAzMzE2LAogICAgICAgIFBBQ0tfUk9XX0xFTkdUSDogMzMzMCwKICAgICAgICBQQUNLX1NLSVBfUk9XUzogMzMzMSwKICAgICAgICBQQUNLX1NLSVBfUElYRUxTOiAzMzMyLAogICAgICAgIENPTE9SOiA2MTQ0LAogICAgICAgIERFUFRIOiA2MTQ1LAogICAgICAgIFNURU5DSUw6IDYxNDYsCiAgICAgICAgUkVEOiA2NDAzLAogICAgICAgIFJHQjg6IDMyODQ5LAogICAgICAgIFJHQkE4OiAzMjg1NiwKICAgICAgICBSR0IxMF9BMjogMzI4NTcsCiAgICAgICAgVEVYVFVSRV9CSU5ESU5HXzNEOiAzMjg3NCwKICAgICAgICBVTlBBQ0tfU0tJUF9JTUFHRVM6IDMyODc3LAogICAgICAgIFVOUEFDS19JTUFHRV9IRUlHSFQ6IDMyODc4LAogICAgICAgIFRFWFRVUkVfM0Q6IDMyODc5LAogICAgICAgIFRFWFRVUkVfV1JBUF9SOiAzMjg4MiwKICAgICAgICBNQVhfM0RfVEVYVFVSRV9TSVpFOiAzMjg4MywKICAgICAgICBVTlNJR05FRF9JTlRfMl8xMF8xMF8xMF9SRVY6IDMzNjQwLAogICAgICAgIE1BWF9FTEVNRU5UU19WRVJUSUNFUzogMzNlMywKICAgICAgICBNQVhfRUxFTUVOVFNfSU5ESUNFUzogMzMwMDEsCiAgICAgICAgVEVYVFVSRV9NSU5fTE9EOiAzMzA4MiwKICAgICAgICBURVhUVVJFX01BWF9MT0Q6IDMzMDgzLAogICAgICAgIFRFWFRVUkVfQkFTRV9MRVZFTDogMzMwODQsCiAgICAgICAgVEVYVFVSRV9NQVhfTEVWRUw6IDMzMDg1LAogICAgICAgIE1JTjogMzI3NzUsCiAgICAgICAgTUFYOiAzMjc3NiwKICAgICAgICBERVBUSF9DT01QT05FTlQyNDogMzMxOTAsCiAgICAgICAgTUFYX1RFWFRVUkVfTE9EX0JJQVM6IDM0MDQ1LAogICAgICAgIFRFWFRVUkVfQ09NUEFSRV9NT0RFOiAzNDg5MiwKICAgICAgICBURVhUVVJFX0NPTVBBUkVfRlVOQzogMzQ4OTMsCiAgICAgICAgQ1VSUkVOVF9RVUVSWTogMzQ5MTcsCiAgICAgICAgUVVFUllfUkVTVUxUOiAzNDkxOCwKICAgICAgICBRVUVSWV9SRVNVTFRfQVZBSUxBQkxFOiAzNDkxOSwKICAgICAgICBTVFJFQU1fUkVBRDogMzUwNDEsCiAgICAgICAgU1RSRUFNX0NPUFk6IDM1MDQyLAogICAgICAgIFNUQVRJQ19SRUFEOiAzNTA0NSwKICAgICAgICBTVEFUSUNfQ09QWTogMzUwNDYsCiAgICAgICAgRFlOQU1JQ19SRUFEOiAzNTA0OSwKICAgICAgICBEWU5BTUlDX0NPUFk6IDM1MDUwLAogICAgICAgIE1BWF9EUkFXX0JVRkZFUlM6IDM0ODUyLAogICAgICAgIERSQVdfQlVGRkVSMDogMzQ4NTMsCiAgICAgICAgRFJBV19CVUZGRVIxOiAzNDg1NCwKICAgICAgICBEUkFXX0JVRkZFUjI6IDM0ODU1LAogICAgICAgIERSQVdfQlVGRkVSMzogMzQ4NTYsCiAgICAgICAgRFJBV19CVUZGRVI0OiAzNDg1NywKICAgICAgICBEUkFXX0JVRkZFUjU6IDM0ODU4LAogICAgICAgIERSQVdfQlVGRkVSNjogMzQ4NTksCiAgICAgICAgRFJBV19CVUZGRVI3OiAzNDg2MCwKICAgICAgICBEUkFXX0JVRkZFUjg6IDM0ODYxLAogICAgICAgIERSQVdfQlVGRkVSOTogMzQ4NjIsCiAgICAgICAgRFJBV19CVUZGRVIxMDogMzQ4NjMsCiAgICAgICAgRFJBV19CVUZGRVIxMTogMzQ4NjQsCiAgICAgICAgRFJBV19CVUZGRVIxMjogMzQ4NjUsCiAgICAgICAgRFJBV19CVUZGRVIxMzogMzQ4NjYsCiAgICAgICAgRFJBV19CVUZGRVIxNDogMzQ4NjcsCiAgICAgICAgRFJBV19CVUZGRVIxNTogMzQ4NjgsCiAgICAgICAgTUFYX0ZSQUdNRU5UX1VOSUZPUk1fQ09NUE9ORU5UUzogMzU2NTcsCiAgICAgICAgTUFYX1ZFUlRFWF9VTklGT1JNX0NPTVBPTkVOVFM6IDM1NjU4LAogICAgICAgIFNBTVBMRVJfM0Q6IDM1Njc5LAogICAgICAgIFNBTVBMRVJfMkRfU0hBRE9XOiAzNTY4MiwKICAgICAgICBGUkFHTUVOVF9TSEFERVJfREVSSVZBVElWRV9ISU5UOiAzNTcyMywKICAgICAgICBQSVhFTF9QQUNLX0JVRkZFUjogMzUwNTEsCiAgICAgICAgUElYRUxfVU5QQUNLX0JVRkZFUjogMzUwNTIsCiAgICAgICAgUElYRUxfUEFDS19CVUZGRVJfQklORElORzogMzUwNTMsCiAgICAgICAgUElYRUxfVU5QQUNLX0JVRkZFUl9CSU5ESU5HOiAzNTA1NSwKICAgICAgICBGTE9BVF9NQVQyeDM6IDM1Njg1LAogICAgICAgIEZMT0FUX01BVDJ4NDogMzU2ODYsCiAgICAgICAgRkxPQVRfTUFUM3gyOiAzNTY4NywKICAgICAgICBGTE9BVF9NQVQzeDQ6IDM1Njg4LAogICAgICAgIEZMT0FUX01BVDR4MjogMzU2ODksCiAgICAgICAgRkxPQVRfTUFUNHgzOiAzNTY5MCwKICAgICAgICBTUkdCOiAzNTkwNCwKICAgICAgICBTUkdCODogMzU5MDUsCiAgICAgICAgU1JHQjhfQUxQSEE4OiAzNTkwNywKICAgICAgICBDT01QQVJFX1JFRl9UT19URVhUVVJFOiAzNDg5NCwKICAgICAgICBSR0JBMzJGOiAzNDgzNiwKICAgICAgICBSR0IzMkY6IDM0ODM3LAogICAgICAgIFJHQkExNkY6IDM0ODQyLAogICAgICAgIFJHQjE2RjogMzQ4NDMsCiAgICAgICAgVkVSVEVYX0FUVFJJQl9BUlJBWV9JTlRFR0VSOiAzNTA2OSwKICAgICAgICBNQVhfQVJSQVlfVEVYVFVSRV9MQVlFUlM6IDM1MDcxLAogICAgICAgIE1JTl9QUk9HUkFNX1RFWEVMX09GRlNFVDogMzUwNzYsCiAgICAgICAgTUFYX1BST0dSQU1fVEVYRUxfT0ZGU0VUOiAzNTA3NywKICAgICAgICBNQVhfVkFSWUlOR19DT01QT05FTlRTOiAzNTY1OSwKICAgICAgICBURVhUVVJFXzJEX0FSUkFZOiAzNTg2NiwKICAgICAgICBURVhUVVJFX0JJTkRJTkdfMkRfQVJSQVk6IDM1ODY5LAogICAgICAgIFIxMUZfRzExRl9CMTBGOiAzNTg5OCwKICAgICAgICBVTlNJR05FRF9JTlRfMTBGXzExRl8xMUZfUkVWOiAzNTg5OSwKICAgICAgICBSR0I5X0U1OiAzNTkwMSwKICAgICAgICBVTlNJR05FRF9JTlRfNV85XzlfOV9SRVY6IDM1OTAyLAogICAgICAgIFRSQU5TRk9STV9GRUVEQkFDS19CVUZGRVJfTU9ERTogMzU5NjcsCiAgICAgICAgTUFYX1RSQU5TRk9STV9GRUVEQkFDS19TRVBBUkFURV9DT01QT05FTlRTOiAzNTk2OCwKICAgICAgICBUUkFOU0ZPUk1fRkVFREJBQ0tfVkFSWUlOR1M6IDM1OTcxLAogICAgICAgIFRSQU5TRk9STV9GRUVEQkFDS19CVUZGRVJfU1RBUlQ6IDM1OTcyLAogICAgICAgIFRSQU5TRk9STV9GRUVEQkFDS19CVUZGRVJfU0laRTogMzU5NzMsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX1BSSU1JVElWRVNfV1JJVFRFTjogMzU5NzYsCiAgICAgICAgUkFTVEVSSVpFUl9ESVNDQVJEOiAzNTk3NywKICAgICAgICBNQVhfVFJBTlNGT1JNX0ZFRURCQUNLX0lOVEVSTEVBVkVEX0NPTVBPTkVOVFM6IDM1OTc4LAogICAgICAgIE1BWF9UUkFOU0ZPUk1fRkVFREJBQ0tfU0VQQVJBVEVfQVRUUklCUzogMzU5NzksCiAgICAgICAgSU5URVJMRUFWRURfQVRUUklCUzogMzU5ODAsCiAgICAgICAgU0VQQVJBVEVfQVRUUklCUzogMzU5ODEsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX0JVRkZFUjogMzU5ODIsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX0JVRkZFUl9CSU5ESU5HOiAzNTk4MywKICAgICAgICBSR0JBMzJVSTogMzYyMDgsCiAgICAgICAgUkdCMzJVSTogMzYyMDksCiAgICAgICAgUkdCQTE2VUk6IDM2MjE0LAogICAgICAgIFJHQjE2VUk6IDM2MjE1LAogICAgICAgIFJHQkE4VUk6IDM2MjIwLAogICAgICAgIFJHQjhVSTogMzYyMjEsCiAgICAgICAgUkdCQTMySTogMzYyMjYsCiAgICAgICAgUkdCMzJJOiAzNjIyNywKICAgICAgICBSR0JBMTZJOiAzNjIzMiwKICAgICAgICBSR0IxNkk6IDM2MjMzLAogICAgICAgIFJHQkE4STogMzYyMzgsCiAgICAgICAgUkdCOEk6IDM2MjM5LAogICAgICAgIFJFRF9JTlRFR0VSOiAzNjI0NCwKICAgICAgICBSR0JfSU5URUdFUjogMzYyNDgsCiAgICAgICAgUkdCQV9JTlRFR0VSOiAzNjI0OSwKICAgICAgICBTQU1QTEVSXzJEX0FSUkFZOiAzNjI4OSwKICAgICAgICBTQU1QTEVSXzJEX0FSUkFZX1NIQURPVzogMzYyOTIsCiAgICAgICAgU0FNUExFUl9DVUJFX1NIQURPVzogMzYyOTMsCiAgICAgICAgVU5TSUdORURfSU5UX1ZFQzI6IDM2Mjk0LAogICAgICAgIFVOU0lHTkVEX0lOVF9WRUMzOiAzNjI5NSwKICAgICAgICBVTlNJR05FRF9JTlRfVkVDNDogMzYyOTYsCiAgICAgICAgSU5UX1NBTVBMRVJfMkQ6IDM2Mjk4LAogICAgICAgIElOVF9TQU1QTEVSXzNEOiAzNjI5OSwKICAgICAgICBJTlRfU0FNUExFUl9DVUJFOiAzNjMwMCwKICAgICAgICBJTlRfU0FNUExFUl8yRF9BUlJBWTogMzYzMDMsCiAgICAgICAgVU5TSUdORURfSU5UX1NBTVBMRVJfMkQ6IDM2MzA2LAogICAgICAgIFVOU0lHTkVEX0lOVF9TQU1QTEVSXzNEOiAzNjMwNywKICAgICAgICBVTlNJR05FRF9JTlRfU0FNUExFUl9DVUJFOiAzNjMwOCwKICAgICAgICBVTlNJR05FRF9JTlRfU0FNUExFUl8yRF9BUlJBWTogMzYzMTEsCiAgICAgICAgREVQVEhfQ09NUE9ORU5UMzJGOiAzNjAxMiwKICAgICAgICBERVBUSDMyRl9TVEVOQ0lMODogMzYwMTMsCiAgICAgICAgRkxPQVRfMzJfVU5TSUdORURfSU5UXzI0XzhfUkVWOiAzNjI2OSwKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX0NPTE9SX0VOQ09ESU5HOiAzMzI5NiwKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX0NPTVBPTkVOVF9UWVBFOiAzMzI5NywKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX1JFRF9TSVpFOiAzMzI5OCwKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX0dSRUVOX1NJWkU6IDMzMjk5LAogICAgICAgIEZSQU1FQlVGRkVSX0FUVEFDSE1FTlRfQkxVRV9TSVpFOiAzMzMwMCwKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX0FMUEhBX1NJWkU6IDMzMzAxLAogICAgICAgIEZSQU1FQlVGRkVSX0FUVEFDSE1FTlRfREVQVEhfU0laRTogMzMzMDIsCiAgICAgICAgRlJBTUVCVUZGRVJfQVRUQUNITUVOVF9TVEVOQ0lMX1NJWkU6IDMzMzAzLAogICAgICAgIEZSQU1FQlVGRkVSX0RFRkFVTFQ6IDMzMzA0LAogICAgICAgIFVOU0lHTkVEX0lOVF8yNF84OiAzNDA0MiwKICAgICAgICBERVBUSDI0X1NURU5DSUw4OiAzNTA1NiwKICAgICAgICBVTlNJR05FRF9OT1JNQUxJWkVEOiAzNTg2MywKICAgICAgICBEUkFXX0ZSQU1FQlVGRkVSX0JJTkRJTkc6IDM2MDA2LAogICAgICAgIC8vIFNhbWUgYXMgRlJBTUVCVUZGRVJfQklORElORwogICAgICAgIFJFQURfRlJBTUVCVUZGRVI6IDM2MDA4LAogICAgICAgIERSQVdfRlJBTUVCVUZGRVI6IDM2MDA5LAogICAgICAgIFJFQURfRlJBTUVCVUZGRVJfQklORElORzogMzYwMTAsCiAgICAgICAgUkVOREVSQlVGRkVSX1NBTVBMRVM6IDM2MDExLAogICAgICAgIEZSQU1FQlVGRkVSX0FUVEFDSE1FTlRfVEVYVFVSRV9MQVlFUjogMzYwNTIsCiAgICAgICAgTUFYX0NPTE9SX0FUVEFDSE1FTlRTOiAzNjA2MywKICAgICAgICBDT0xPUl9BVFRBQ0hNRU5UMTogMzYwNjUsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDI6IDM2MDY2LAogICAgICAgIENPTE9SX0FUVEFDSE1FTlQzOiAzNjA2NywKICAgICAgICBDT0xPUl9BVFRBQ0hNRU5UNDogMzYwNjgsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDU6IDM2MDY5LAogICAgICAgIENPTE9SX0FUVEFDSE1FTlQ2OiAzNjA3MCwKICAgICAgICBDT0xPUl9BVFRBQ0hNRU5UNzogMzYwNzEsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDg6IDM2MDcyLAogICAgICAgIENPTE9SX0FUVEFDSE1FTlQ5OiAzNjA3MywKICAgICAgICBDT0xPUl9BVFRBQ0hNRU5UMTA6IDM2MDc0LAogICAgICAgIENPTE9SX0FUVEFDSE1FTlQxMTogMzYwNzUsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDEyOiAzNjA3NiwKICAgICAgICBDT0xPUl9BVFRBQ0hNRU5UMTM6IDM2MDc3LAogICAgICAgIENPTE9SX0FUVEFDSE1FTlQxNDogMzYwNzgsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDE1OiAzNjA3OSwKICAgICAgICBGUkFNRUJVRkZFUl9JTkNPTVBMRVRFX01VTFRJU0FNUExFOiAzNjE4MiwKICAgICAgICBNQVhfU0FNUExFUzogMzYxODMsCiAgICAgICAgSEFMRl9GTE9BVDogNTEzMSwKICAgICAgICBSRzogMzMzMTksCiAgICAgICAgUkdfSU5URUdFUjogMzMzMjAsCiAgICAgICAgUjg6IDMzMzIxLAogICAgICAgIFJHODogMzMzMjMsCiAgICAgICAgUjE2RjogMzMzMjUsCiAgICAgICAgUjMyRjogMzMzMjYsCiAgICAgICAgUkcxNkY6IDMzMzI3LAogICAgICAgIFJHMzJGOiAzMzMyOCwKICAgICAgICBSOEk6IDMzMzI5LAogICAgICAgIFI4VUk6IDMzMzMwLAogICAgICAgIFIxNkk6IDMzMzMxLAogICAgICAgIFIxNlVJOiAzMzMzMiwKICAgICAgICBSMzJJOiAzMzMzMywKICAgICAgICBSMzJVSTogMzMzMzQsCiAgICAgICAgUkc4STogMzMzMzUsCiAgICAgICAgUkc4VUk6IDMzMzM2LAogICAgICAgIFJHMTZJOiAzMzMzNywKICAgICAgICBSRzE2VUk6IDMzMzM4LAogICAgICAgIFJHMzJJOiAzMzMzOSwKICAgICAgICBSRzMyVUk6IDMzMzQwLAogICAgICAgIFZFUlRFWF9BUlJBWV9CSU5ESU5HOiAzNDIyOSwKICAgICAgICBSOF9TTk9STTogMzY3NTYsCiAgICAgICAgUkc4X1NOT1JNOiAzNjc1NywKICAgICAgICBSR0I4X1NOT1JNOiAzNjc1OCwKICAgICAgICBSR0JBOF9TTk9STTogMzY3NTksCiAgICAgICAgU0lHTkVEX05PUk1BTElaRUQ6IDM2NzY0LAogICAgICAgIENPUFlfUkVBRF9CVUZGRVI6IDM2NjYyLAogICAgICAgIENPUFlfV1JJVEVfQlVGRkVSOiAzNjY2MywKICAgICAgICBDT1BZX1JFQURfQlVGRkVSX0JJTkRJTkc6IDM2NjYyLAogICAgICAgIC8vIFNhbWUgYXMgQ09QWV9SRUFEX0JVRkZFUgogICAgICAgIENPUFlfV1JJVEVfQlVGRkVSX0JJTkRJTkc6IDM2NjYzLAogICAgICAgIC8vIFNhbWUgYXMgQ09QWV9XUklURV9CVUZGRVIKICAgICAgICBVTklGT1JNX0JVRkZFUjogMzUzNDUsCiAgICAgICAgVU5JRk9STV9CVUZGRVJfQklORElORzogMzUzNjgsCiAgICAgICAgVU5JRk9STV9CVUZGRVJfU1RBUlQ6IDM1MzY5LAogICAgICAgIFVOSUZPUk1fQlVGRkVSX1NJWkU6IDM1MzcwLAogICAgICAgIE1BWF9WRVJURVhfVU5JRk9STV9CTE9DS1M6IDM1MzcxLAogICAgICAgIE1BWF9GUkFHTUVOVF9VTklGT1JNX0JMT0NLUzogMzUzNzMsCiAgICAgICAgTUFYX0NPTUJJTkVEX1VOSUZPUk1fQkxPQ0tTOiAzNTM3NCwKICAgICAgICBNQVhfVU5JRk9STV9CVUZGRVJfQklORElOR1M6IDM1Mzc1LAogICAgICAgIE1BWF9VTklGT1JNX0JMT0NLX1NJWkU6IDM1Mzc2LAogICAgICAgIE1BWF9DT01CSU5FRF9WRVJURVhfVU5JRk9STV9DT01QT05FTlRTOiAzNTM3NywKICAgICAgICBNQVhfQ09NQklORURfRlJBR01FTlRfVU5JRk9STV9DT01QT05FTlRTOiAzNTM3OSwKICAgICAgICBVTklGT1JNX0JVRkZFUl9PRkZTRVRfQUxJR05NRU5UOiAzNTM4MCwKICAgICAgICBBQ1RJVkVfVU5JRk9STV9CTE9DS1M6IDM1MzgyLAogICAgICAgIFVOSUZPUk1fVFlQRTogMzUzODMsCiAgICAgICAgVU5JRk9STV9TSVpFOiAzNTM4NCwKICAgICAgICBVTklGT1JNX0JMT0NLX0lOREVYOiAzNTM4NiwKICAgICAgICBVTklGT1JNX09GRlNFVDogMzUzODcsCiAgICAgICAgVU5JRk9STV9BUlJBWV9TVFJJREU6IDM1Mzg4LAogICAgICAgIFVOSUZPUk1fTUFUUklYX1NUUklERTogMzUzODksCiAgICAgICAgVU5JRk9STV9JU19ST1dfTUFKT1I6IDM1MzkwLAogICAgICAgIFVOSUZPUk1fQkxPQ0tfQklORElORzogMzUzOTEsCiAgICAgICAgVU5JRk9STV9CTE9DS19EQVRBX1NJWkU6IDM1MzkyLAogICAgICAgIFVOSUZPUk1fQkxPQ0tfQUNUSVZFX1VOSUZPUk1TOiAzNTM5NCwKICAgICAgICBVTklGT1JNX0JMT0NLX0FDVElWRV9VTklGT1JNX0lORElDRVM6IDM1Mzk1LAogICAgICAgIFVOSUZPUk1fQkxPQ0tfUkVGRVJFTkNFRF9CWV9WRVJURVhfU0hBREVSOiAzNTM5NiwKICAgICAgICBVTklGT1JNX0JMT0NLX1JFRkVSRU5DRURfQllfRlJBR01FTlRfU0hBREVSOiAzNTM5OCwKICAgICAgICBJTlZBTElEX0lOREVYOiA0Mjk0OTY3Mjk1LAogICAgICAgIE1BWF9WRVJURVhfT1VUUFVUX0NPTVBPTkVOVFM6IDM3MTU0LAogICAgICAgIE1BWF9GUkFHTUVOVF9JTlBVVF9DT01QT05FTlRTOiAzNzE1NywKICAgICAgICBNQVhfU0VSVkVSX1dBSVRfVElNRU9VVDogMzcxMzcsCiAgICAgICAgT0JKRUNUX1RZUEU6IDM3MTM4LAogICAgICAgIFNZTkNfQ09ORElUSU9OOiAzNzEzOSwKICAgICAgICBTWU5DX1NUQVRVUzogMzcxNDAsCiAgICAgICAgU1lOQ19GTEFHUzogMzcxNDEsCiAgICAgICAgU1lOQ19GRU5DRTogMzcxNDIsCiAgICAgICAgU1lOQ19HUFVfQ09NTUFORFNfQ09NUExFVEU6IDM3MTQzLAogICAgICAgIFVOU0lHTkFMRUQ6IDM3MTQ0LAogICAgICAgIFNJR05BTEVEOiAzNzE0NSwKICAgICAgICBBTFJFQURZX1NJR05BTEVEOiAzNzE0NiwKICAgICAgICBUSU1FT1VUX0VYUElSRUQ6IDM3MTQ3LAogICAgICAgIENPTkRJVElPTl9TQVRJU0ZJRUQ6IDM3MTQ4LAogICAgICAgIFdBSVRfRkFJTEVEOiAzNzE0OSwKICAgICAgICBTWU5DX0ZMVVNIX0NPTU1BTkRTX0JJVDogMSwKICAgICAgICBWRVJURVhfQVRUUklCX0FSUkFZX0RJVklTT1I6IDM1MDcwLAogICAgICAgIEFOWV9TQU1QTEVTX1BBU1NFRDogMzU4ODcsCiAgICAgICAgQU5ZX1NBTVBMRVNfUEFTU0VEX0NPTlNFUlZBVElWRTogMzYyMDIsCiAgICAgICAgU0FNUExFUl9CSU5ESU5HOiAzNTA5NywKICAgICAgICBSR0IxMF9BMlVJOiAzNjk3NSwKICAgICAgICBJTlRfMl8xMF8xMF8xMF9SRVY6IDM2MjU1LAogICAgICAgIFRSQU5TRk9STV9GRUVEQkFDSzogMzYzODYsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX1BBVVNFRDogMzYzODcsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX0FDVElWRTogMzYzODgsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX0JJTkRJTkc6IDM2Mzg5LAogICAgICAgIENPTVBSRVNTRURfUjExX0VBQzogMzc0ODgsCiAgICAgICAgQ09NUFJFU1NFRF9TSUdORURfUjExX0VBQzogMzc0ODksCiAgICAgICAgQ09NUFJFU1NFRF9SRzExX0VBQzogMzc0OTAsCiAgICAgICAgQ09NUFJFU1NFRF9TSUdORURfUkcxMV9FQUM6IDM3NDkxLAogICAgICAgIENPTVBSRVNTRURfUkdCOF9FVEMyOiAzNzQ5MiwKICAgICAgICBDT01QUkVTU0VEX1NSR0I4X0VUQzI6IDM3NDkzLAogICAgICAgIENPTVBSRVNTRURfUkdCOF9QVU5DSFRIUk9VR0hfQUxQSEExX0VUQzI6IDM3NDk0LAogICAgICAgIENPTVBSRVNTRURfU1JHQjhfUFVOQ0hUSFJPVUdIX0FMUEhBMV9FVEMyOiAzNzQ5NSwKICAgICAgICBDT01QUkVTU0VEX1JHQkE4X0VUQzJfRUFDOiAzNzQ5NiwKICAgICAgICBDT01QUkVTU0VEX1NSR0I4X0FMUEhBOF9FVEMyX0VBQzogMzc0OTcsCiAgICAgICAgVEVYVFVSRV9JTU1VVEFCTEVfRk9STUFUOiAzNzE2NywKICAgICAgICBNQVhfRUxFTUVOVF9JTkRFWDogMzYyMDMsCiAgICAgICAgVEVYVFVSRV9JTU1VVEFCTEVfTEVWRUxTOiAzMzUwMywKICAgICAgICAvLyBFeHRlbnNpb25zCiAgICAgICAgTUFYX1RFWFRVUkVfTUFYX0FOSVNPVFJPUFlfRVhUOiAzNDA0NwogICAgICB9OwogICAgICBXZWJHTENvbnN0YW50c19kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShXZWJHTENvbnN0YW50cyk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db21wb25lbnREYXRhdHlwZS5qcwogIHZhciBDb21wb25lbnREYXRhdHlwZSwgQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdDsKICB2YXIgaW5pdF9Db21wb25lbnREYXRhdHlwZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29tcG9uZW50RGF0YXR5cGUuanMiKCkgewogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X1dlYkdMQ29uc3RhbnRzKCk7CiAgICAgIENvbXBvbmVudERhdGF0eXBlID0gewogICAgICAgIC8qKgogICAgICAgICAqIDgtYml0IHNpZ25lZCBieXRlIGNvcnJlc3BvbmRpbmcgdG8gPGNvZGU+Z2wuQllURTwvY29kZT4gYW5kIHRoZSB0eXBlCiAgICAgICAgICogb2YgYW4gZWxlbWVudCBpbiA8Y29kZT5JbnQ4QXJyYXk8L2NvZGU+LgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBCWVRFOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkJZVEUsCiAgICAgICAgLyoqCiAgICAgICAgICogOC1iaXQgdW5zaWduZWQgYnl0ZSBjb3JyZXNwb25kaW5nIHRvIDxjb2RlPlVOU0lHTkVEX0JZVEU8L2NvZGU+IGFuZCB0aGUgdHlwZQogICAgICAgICAqIG9mIGFuIGVsZW1lbnQgaW4gPGNvZGU+VWludDhBcnJheTwvY29kZT4uCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFVOU0lHTkVEX0JZVEU6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICAvKioKICAgICAgICAgKiAxNi1iaXQgc2lnbmVkIHNob3J0IGNvcnJlc3BvbmRpbmcgdG8gPGNvZGU+U0hPUlQ8L2NvZGU+IGFuZCB0aGUgdHlwZQogICAgICAgICAqIG9mIGFuIGVsZW1lbnQgaW4gPGNvZGU+SW50MTZBcnJheTwvY29kZT4uCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFNIT1JUOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlNIT1JULAogICAgICAgIC8qKgogICAgICAgICAqIDE2LWJpdCB1bnNpZ25lZCBzaG9ydCBjb3JyZXNwb25kaW5nIHRvIDxjb2RlPlVOU0lHTkVEX1NIT1JUPC9jb2RlPiBhbmQgdGhlIHR5cGUKICAgICAgICAgKiBvZiBhbiBlbGVtZW50IGluIDxjb2RlPlVpbnQxNkFycmF5PC9jb2RlPi4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVU5TSUdORURfU0hPUlQ6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfU0hPUlQsCiAgICAgICAgLyoqCiAgICAgICAgICogMzItYml0IHNpZ25lZCBpbnQgY29ycmVzcG9uZGluZyB0byA8Y29kZT5JTlQ8L2NvZGU+IGFuZCB0aGUgdHlwZQogICAgICAgICAqIG9mIGFuIGVsZW1lbnQgaW4gPGNvZGU+SW50MzJBcnJheTwvY29kZT4uCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyT2YgQ29tcG9uZW50RGF0YXR5cGUKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgSU5UOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LklOVCwKICAgICAgICAvKioKICAgICAgICAgKiAzMi1iaXQgdW5zaWduZWQgaW50IGNvcnJlc3BvbmRpbmcgdG8gPGNvZGU+VU5TSUdORURfSU5UPC9jb2RlPiBhbmQgdGhlIHR5cGUKICAgICAgICAgKiBvZiBhbiBlbGVtZW50IGluIDxjb2RlPlVpbnQzMkFycmF5PC9jb2RlPi4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJPZiBDb21wb25lbnREYXRhdHlwZQogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBVTlNJR05FRF9JTlQ6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfSU5ULAogICAgICAgIC8qKgogICAgICAgICAqIDMyLWJpdCBmbG9hdGluZy1wb2ludCBjb3JyZXNwb25kaW5nIHRvIDxjb2RlPkZMT0FUPC9jb2RlPiBhbmQgdGhlIHR5cGUKICAgICAgICAgKiBvZiBhbiBlbGVtZW50IGluIDxjb2RlPkZsb2F0MzJBcnJheTwvY29kZT4uCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIEZMT0FUOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkZMT0FULAogICAgICAgIC8qKgogICAgICAgICAqIDY0LWJpdCBmbG9hdGluZy1wb2ludCBjb3JyZXNwb25kaW5nIHRvIDxjb2RlPmdsLkRPVUJMRTwvY29kZT4gKGluIERlc2t0b3AgT3BlbkdMOwogICAgICAgICAqIHRoaXMgaXMgbm90IHN1cHBvcnRlZCBpbiBXZWJHTCwgYW5kIGlzIGVtdWxhdGVkIGluIENlc2l1bSB2aWEge0BsaW5rIEdlb21ldHJ5UGlwZWxpbmUuZW5jb2RlQXR0cmlidXRlfSkKICAgICAgICAgKiBhbmQgdGhlIHR5cGUgb2YgYW4gZWxlbWVudCBpbiA8Y29kZT5GbG9hdDY0QXJyYXk8L2NvZGU+LgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlck9mIENvbXBvbmVudERhdGF0eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqIEBkZWZhdWx0IDB4MTQwQQogICAgICAgICAqLwogICAgICAgIERPVUJMRTogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5ET1VCTEUKICAgICAgfTsKICAgICAgQ29tcG9uZW50RGF0YXR5cGUuZ2V0U2l6ZUluQnl0ZXMgPSBmdW5jdGlvbihjb21wb25lbnREYXRhdHlwZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNvbXBvbmVudERhdGF0eXBlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInZhbHVlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBzd2l0Y2ggKGNvbXBvbmVudERhdGF0eXBlKSB7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLkJZVEU6CiAgICAgICAgICAgIHJldHVybiBJbnQ4QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX0JZVEU6CiAgICAgICAgICAgIHJldHVybiBVaW50OEFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5TSE9SVDoKICAgICAgICAgICAgcmV0dXJuIEludDE2QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUOgogICAgICAgICAgICByZXR1cm4gVWludDE2QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLklOVDoKICAgICAgICAgICAgcmV0dXJuIEludDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX0lOVDoKICAgICAgICAgICAgcmV0dXJuIFVpbnQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5GTE9BVDoKICAgICAgICAgICAgcmV0dXJuIEZsb2F0MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuRE9VQkxFOgogICAgICAgICAgICByZXR1cm4gRmxvYXQ2NEFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImNvbXBvbmVudERhdGF0eXBlIGlzIG5vdCBhIHZhbGlkIHZhbHVlLiIpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ29tcG9uZW50RGF0YXR5cGUuZnJvbVR5cGVkQXJyYXkgPSBmdW5jdGlvbihhcnJheSkgewogICAgICAgIGlmIChhcnJheSBpbnN0YW5jZW9mIEludDhBcnJheSkgewogICAgICAgICAgcmV0dXJuIENvbXBvbmVudERhdGF0eXBlLkJZVEU7CiAgICAgICAgfQogICAgICAgIGlmIChhcnJheSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpIHsKICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5VTlNJR05FRF9CWVRFOwogICAgICAgIH0KICAgICAgICBpZiAoYXJyYXkgaW5zdGFuY2VvZiBJbnQxNkFycmF5KSB7CiAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuU0hPUlQ7CiAgICAgICAgfQogICAgICAgIGlmIChhcnJheSBpbnN0YW5jZW9mIFVpbnQxNkFycmF5KSB7CiAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuVU5TSUdORURfU0hPUlQ7CiAgICAgICAgfQogICAgICAgIGlmIChhcnJheSBpbnN0YW5jZW9mIEludDMyQXJyYXkpIHsKICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5JTlQ7CiAgICAgICAgfQogICAgICAgIGlmIChhcnJheSBpbnN0YW5jZW9mIFVpbnQzMkFycmF5KSB7CiAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuVU5TSUdORURfSU5UOwogICAgICAgIH0KICAgICAgICBpZiAoYXJyYXkgaW5zdGFuY2VvZiBGbG9hdDMyQXJyYXkpIHsKICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5GTE9BVDsKICAgICAgICB9CiAgICAgICAgaWYgKGFycmF5IGluc3RhbmNlb2YgRmxvYXQ2NEFycmF5KSB7CiAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuRE9VQkxFOwogICAgICAgIH0KICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICJhcnJheSBtdXN0IGJlIGFuIEludDhBcnJheSwgVWludDhBcnJheSwgSW50MTZBcnJheSwgVWludDE2QXJyYXksIEludDMyQXJyYXksIFVpbnQzMkFycmF5LCBGbG9hdDMyQXJyYXksIG9yIEZsb2F0NjRBcnJheS4iCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQ29tcG9uZW50RGF0YXR5cGUudmFsaWRhdGUgPSBmdW5jdGlvbihjb21wb25lbnREYXRhdHlwZSkgewogICAgICAgIHJldHVybiBkZWZpbmVkX2RlZmF1bHQoY29tcG9uZW50RGF0YXR5cGUpICYmIChjb21wb25lbnREYXRhdHlwZSA9PT0gQ29tcG9uZW50RGF0YXR5cGUuQllURSB8fCBjb21wb25lbnREYXRhdHlwZSA9PT0gQ29tcG9uZW50RGF0YXR5cGUuVU5TSUdORURfQllURSB8fCBjb21wb25lbnREYXRhdHlwZSA9PT0gQ29tcG9uZW50RGF0YXR5cGUuU0hPUlQgfHwgY29tcG9uZW50RGF0YXR5cGUgPT09IENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUIHx8IGNvbXBvbmVudERhdGF0eXBlID09PSBDb21wb25lbnREYXRhdHlwZS5JTlQgfHwgY29tcG9uZW50RGF0YXR5cGUgPT09IENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX0lOVCB8fCBjb21wb25lbnREYXRhdHlwZSA9PT0gQ29tcG9uZW50RGF0YXR5cGUuRkxPQVQgfHwgY29tcG9uZW50RGF0YXR5cGUgPT09IENvbXBvbmVudERhdGF0eXBlLkRPVUJMRSk7CiAgICAgIH07CiAgICAgIENvbXBvbmVudERhdGF0eXBlLmNyZWF0ZVR5cGVkQXJyYXkgPSBmdW5jdGlvbihjb21wb25lbnREYXRhdHlwZSwgdmFsdWVzT3JMZW5ndGgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjb21wb25lbnREYXRhdHlwZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjb21wb25lbnREYXRhdHlwZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWVzT3JMZW5ndGgpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWVzT3JMZW5ndGggaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHN3aXRjaCAoY29tcG9uZW50RGF0YXR5cGUpIHsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuQllURToKICAgICAgICAgICAgcmV0dXJuIG5ldyBJbnQ4QXJyYXkodmFsdWVzT3JMZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5VTlNJR05FRF9CWVRFOgogICAgICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkodmFsdWVzT3JMZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5TSE9SVDoKICAgICAgICAgICAgcmV0dXJuIG5ldyBJbnQxNkFycmF5KHZhbHVlc09yTGVuZ3RoKTsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuVU5TSUdORURfU0hPUlQ6CiAgICAgICAgICAgIHJldHVybiBuZXcgVWludDE2QXJyYXkodmFsdWVzT3JMZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5JTlQ6CiAgICAgICAgICAgIHJldHVybiBuZXcgSW50MzJBcnJheSh2YWx1ZXNPckxlbmd0aCk7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX0lOVDoKICAgICAgICAgICAgcmV0dXJuIG5ldyBVaW50MzJBcnJheSh2YWx1ZXNPckxlbmd0aCk7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLkZMT0FUOgogICAgICAgICAgICByZXR1cm4gbmV3IEZsb2F0MzJBcnJheSh2YWx1ZXNPckxlbmd0aCk7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLkRPVUJMRToKICAgICAgICAgICAgcmV0dXJuIG5ldyBGbG9hdDY0QXJyYXkodmFsdWVzT3JMZW5ndGgpOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImNvbXBvbmVudERhdGF0eXBlIGlzIG5vdCBhIHZhbGlkIHZhbHVlLiIpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ29tcG9uZW50RGF0YXR5cGUuY3JlYXRlQXJyYXlCdWZmZXJWaWV3ID0gZnVuY3Rpb24oY29tcG9uZW50RGF0YXR5cGUsIGJ1ZmZlciwgYnl0ZU9mZnNldCwgbGVuZ3RoKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY29tcG9uZW50RGF0YXR5cGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiY29tcG9uZW50RGF0YXR5cGUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJ1ZmZlcikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJidWZmZXIgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGJ5dGVPZmZzZXQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChieXRlT2Zmc2V0LCAwKTsKICAgICAgICBsZW5ndGggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgIGxlbmd0aCwKICAgICAgICAgIChidWZmZXIuYnl0ZUxlbmd0aCAtIGJ5dGVPZmZzZXQpIC8gQ29tcG9uZW50RGF0YXR5cGUuZ2V0U2l6ZUluQnl0ZXMoY29tcG9uZW50RGF0YXR5cGUpCiAgICAgICAgKTsKICAgICAgICBzd2l0Y2ggKGNvbXBvbmVudERhdGF0eXBlKSB7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLkJZVEU6CiAgICAgICAgICAgIHJldHVybiBuZXcgSW50OEFycmF5KGJ1ZmZlciwgYnl0ZU9mZnNldCwgbGVuZ3RoKTsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuVU5TSUdORURfQllURToKICAgICAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KGJ1ZmZlciwgYnl0ZU9mZnNldCwgbGVuZ3RoKTsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuU0hPUlQ6CiAgICAgICAgICAgIHJldHVybiBuZXcgSW50MTZBcnJheShidWZmZXIsIGJ5dGVPZmZzZXQsIGxlbmd0aCk7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUOgogICAgICAgICAgICByZXR1cm4gbmV3IFVpbnQxNkFycmF5KGJ1ZmZlciwgYnl0ZU9mZnNldCwgbGVuZ3RoKTsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuSU5UOgogICAgICAgICAgICByZXR1cm4gbmV3IEludDMyQXJyYXkoYnVmZmVyLCBieXRlT2Zmc2V0LCBsZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5VTlNJR05FRF9JTlQ6CiAgICAgICAgICAgIHJldHVybiBuZXcgVWludDMyQXJyYXkoYnVmZmVyLCBieXRlT2Zmc2V0LCBsZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5GTE9BVDoKICAgICAgICAgICAgcmV0dXJuIG5ldyBGbG9hdDMyQXJyYXkoYnVmZmVyLCBieXRlT2Zmc2V0LCBsZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5ET1VCTEU6CiAgICAgICAgICAgIHJldHVybiBuZXcgRmxvYXQ2NEFycmF5KGJ1ZmZlciwgYnl0ZU9mZnNldCwgbGVuZ3RoKTsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjb21wb25lbnREYXRhdHlwZSBpcyBub3QgYSB2YWxpZCB2YWx1ZS4iKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIENvbXBvbmVudERhdGF0eXBlLmZyb21OYW1lID0gZnVuY3Rpb24obmFtZSkgewogICAgICAgIHN3aXRjaCAobmFtZSkgewogICAgICAgICAgY2FzZSAiQllURSI6CiAgICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5CWVRFOwogICAgICAgICAgY2FzZSAiVU5TSUdORURfQllURSI6CiAgICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5VTlNJR05FRF9CWVRFOwogICAgICAgICAgY2FzZSAiU0hPUlQiOgogICAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuU0hPUlQ7CiAgICAgICAgICBjYXNlICJVTlNJR05FRF9TSE9SVCI6CiAgICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5VTlNJR05FRF9TSE9SVDsKICAgICAgICAgIGNhc2UgIklOVCI6CiAgICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5JTlQ7CiAgICAgICAgICBjYXNlICJVTlNJR05FRF9JTlQiOgogICAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuVU5TSUdORURfSU5UOwogICAgICAgICAgY2FzZSAiRkxPQVQiOgogICAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuRkxPQVQ7CiAgICAgICAgICBjYXNlICJET1VCTEUiOgogICAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuRE9VQkxFOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm5hbWUgaXMgbm90IGEgdmFsaWQgdmFsdWUuIik7CiAgICAgICAgfQogICAgICB9OwogICAgICBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShDb21wb25lbnREYXRhdHlwZSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9HZW9tZXRyeVR5cGUuanMKICB2YXIgR2VvbWV0cnlUeXBlLCBHZW9tZXRyeVR5cGVfZGVmYXVsdDsKICB2YXIgaW5pdF9HZW9tZXRyeVR5cGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dlb21ldHJ5VHlwZS5qcyIoKSB7CiAgICAgIEdlb21ldHJ5VHlwZSA9IHsKICAgICAgICBOT05FOiAwLAogICAgICAgIFRSSUFOR0xFUzogMSwKICAgICAgICBMSU5FUzogMiwKICAgICAgICBQT0xZTElORVM6IDMKICAgICAgfTsKICAgICAgR2VvbWV0cnlUeXBlX2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKEdlb21ldHJ5VHlwZSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9NYXRyaXgyLmpzCiAgZnVuY3Rpb24gTWF0cml4Mihjb2x1bW4wUm93MCwgY29sdW1uMVJvdzAsIGNvbHVtbjBSb3cxLCBjb2x1bW4xUm93MSkgewogICAgdGhpc1swXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjBSb3cwLCAwKTsKICAgIHRoaXNbMV0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4wUm93MSwgMCk7CiAgICB0aGlzWzJdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMVJvdzAsIDApOwogICAgdGhpc1szXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjFSb3cxLCAwKTsKICB9CiAgdmFyIHNjYWxlU2NyYXRjaDEzLCBzY2FsZVNjcmF0Y2gyMywgc2NyYXRjaENvbHVtbjMsIHNjYWxlU2NyYXRjaDMzLCBzY2FsZVNjcmF0Y2g0Mywgc2NhbGVTY3JhdGNoNTMsIE1hdHJpeDJfZGVmYXVsdDsKICB2YXIgaW5pdF9NYXRyaXgyID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9NYXRyaXgyLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgTWF0cml4Mi5wYWNrZWRMZW5ndGggPSA0OwogICAgICBNYXRyaXgyLnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVswXTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbMV07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzJdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVszXTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIE1hdHJpeDIudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBNYXRyaXgyKCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzFdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbMl0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFszXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5wYWNrQXJyYXkgPSBmdW5jdGlvbihhcnJheSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgICAgY29uc3QgcmVzdWx0TGVuZ3RoID0gbGVuZ3RoICogNDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkocmVzdWx0TGVuZ3RoKTsKICAgICAgICB9IGVsc2UgaWYgKCFBcnJheS5pc0FycmF5KHJlc3VsdCkgJiYgcmVzdWx0Lmxlbmd0aCAhPT0gcmVzdWx0TGVuZ3RoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIklmIHJlc3VsdCBpcyBhIHR5cGVkIGFycmF5LCBpdCBtdXN0IGhhdmUgZXhhY3RseSBhcnJheS5sZW5ndGggKiA0IGVsZW1lbnRzIgogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKHJlc3VsdC5sZW5ndGggIT09IHJlc3VsdExlbmd0aCkgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IHJlc3VsdExlbmd0aDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgTWF0cml4Mi5wYWNrKGFycmF5W2ldLCByZXN1bHQsIGkgKiA0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi51bnBhY2tBcnJheSA9IGZ1bmN0aW9uKGFycmF5LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJhcnJheS5sZW5ndGgiLCBhcnJheS5sZW5ndGgsIDQpOwogICAgICAgIGlmIChhcnJheS5sZW5ndGggJSA0ICE9PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA0LiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEFycmF5KGxlbmd0aCAvIDQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoIC8gNDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gNCkgewogICAgICAgICAgY29uc3QgaW5kZXggPSBpIC8gNDsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBNYXRyaXgyLnVucGFjayhhcnJheSwgaSwgcmVzdWx0W2luZGV4XSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIuY2xvbmUgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG1hdHJpeCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4MihtYXRyaXhbMF0sIG1hdHJpeFsyXSwgbWF0cml4WzFdLCBtYXRyaXhbM10pOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM107CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5mcm9tQXJyYXkgPSBNYXRyaXgyLnVucGFjazsKICAgICAgTWF0cml4Mi5mcm9tQ29sdW1uTWFqb3JBcnJheSA9IGZ1bmN0aW9uKHZhbHVlcywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2YWx1ZXMiLCB2YWx1ZXMpOwogICAgICAgIHJldHVybiBNYXRyaXgyLmNsb25lKHZhbHVlcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgTWF0cml4Mi5mcm9tUm93TWFqb3JBcnJheSA9IGZ1bmN0aW9uKHZhbHVlcywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2YWx1ZXMiLCB2YWx1ZXMpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4Mih2YWx1ZXNbMF0sIHZhbHVlc1sxXSwgdmFsdWVzWzJdLCB2YWx1ZXNbM10pOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSB2YWx1ZXNbMF07CiAgICAgICAgcmVzdWx0WzFdID0gdmFsdWVzWzJdOwogICAgICAgIHJlc3VsdFsyXSA9IHZhbHVlc1sxXTsKICAgICAgICByZXN1bHRbM10gPSB2YWx1ZXNbM107CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5mcm9tU2NhbGUgPSBmdW5jdGlvbihzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDIoc2NhbGUueCwgMCwgMCwgc2NhbGUueSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICByZXN1bHRbMl0gPSAwOwogICAgICAgIHJlc3VsdFszXSA9IHNjYWxlLnk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5mcm9tVW5pZm9ybVNjYWxlID0gZnVuY3Rpb24oc2NhbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGUiLCBzY2FsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBNYXRyaXgyKHNjYWxlLCAwLCAwLCBzY2FsZSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHNjYWxlOwogICAgICAgIHJlc3VsdFsxXSA9IDA7CiAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICByZXN1bHRbM10gPSBzY2FsZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgyLmZyb21Sb3RhdGlvbiA9IGZ1bmN0aW9uKGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImFuZ2xlIiwgYW5nbGUpOwogICAgICAgIGNvbnN0IGNvc0FuZ2xlID0gTWF0aC5jb3MoYW5nbGUpOwogICAgICAgIGNvbnN0IHNpbkFuZ2xlID0gTWF0aC5zaW4oYW5nbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4Mihjb3NBbmdsZSwgLXNpbkFuZ2xlLCBzaW5BbmdsZSwgY29zQW5nbGUpOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBjb3NBbmdsZTsKICAgICAgICByZXN1bHRbMV0gPSBzaW5BbmdsZTsKICAgICAgICByZXN1bHRbMl0gPSAtc2luQW5nbGU7CiAgICAgICAgcmVzdWx0WzNdID0gY29zQW5nbGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi50b0FycmF5ID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIFttYXRyaXhbMF0sIG1hdHJpeFsxXSwgbWF0cml4WzJdLCBtYXRyaXhbM11dOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM107CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5nZXRFbGVtZW50SW5kZXggPSBmdW5jdGlvbihjb2x1bW4sIHJvdykgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJyb3ciLCByb3csIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJyb3ciLCByb3csIDEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJjb2x1bW4iLCBjb2x1bW4sIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJjb2x1bW4iLCBjb2x1bW4sIDEpOwogICAgICAgIHJldHVybiBjb2x1bW4gKiAyICsgcm93OwogICAgICB9OwogICAgICBNYXRyaXgyLmdldENvbHVtbiA9IGZ1bmN0aW9uKG1hdHJpeCwgaW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBzdGFydEluZGV4ID0gaW5kZXggKiAyOwogICAgICAgIGNvbnN0IHggPSBtYXRyaXhbc3RhcnRJbmRleF07CiAgICAgICAgY29uc3QgeSA9IG1hdHJpeFtzdGFydEluZGV4ICsgMV07CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgyLnNldENvbHVtbiA9IGZ1bmN0aW9uKG1hdHJpeCwgaW5kZXgsIGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAxKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0ID0gTWF0cml4Mi5jbG9uZShtYXRyaXgsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc3RhcnRJbmRleCA9IGluZGV4ICogMjsKICAgICAgICByZXN1bHRbc3RhcnRJbmRleF0gPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdFtzdGFydEluZGV4ICsgMV0gPSBjYXJ0ZXNpYW4xMS55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIuZ2V0Um93ID0gZnVuY3Rpb24obWF0cml4LCBpbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHggPSBtYXRyaXhbaW5kZXhdOwogICAgICAgIGNvbnN0IHkgPSBtYXRyaXhbaW5kZXggKyAyXTsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIuc2V0Um93ID0gZnVuY3Rpb24obWF0cml4LCBpbmRleCwgY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQgPSBNYXRyaXgyLmNsb25lKG1hdHJpeCwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbaW5kZXhdID0gY2FydGVzaWFuMTEueDsKICAgICAgICByZXN1bHRbaW5kZXggKyAyXSA9IGNhcnRlc2lhbjExLnk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NhbGVTY3JhdGNoMTMgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDIuc2V0U2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgZXhpc3RpbmdTY2FsZSA9IE1hdHJpeDIuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2gxMyk7CiAgICAgICAgY29uc3Qgc2NhbGVSYXRpb1ggPSBzY2FsZS54IC8gZXhpc3RpbmdTY2FsZS54OwogICAgICAgIGNvbnN0IHNjYWxlUmF0aW9ZID0gc2NhbGUueSAvIGV4aXN0aW5nU2NhbGUueTsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF0gKiBzY2FsZVJhdGlvWDsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gKiBzY2FsZVJhdGlvWDsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl0gKiBzY2FsZVJhdGlvWTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM10gKiBzY2FsZVJhdGlvWTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY2FsZVNjcmF0Y2gyMyA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgTWF0cml4Mi5zZXRVbmlmb3JtU2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgZXhpc3RpbmdTY2FsZSA9IE1hdHJpeDIuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2gyMyk7CiAgICAgICAgY29uc3Qgc2NhbGVSYXRpb1ggPSBzY2FsZSAvIGV4aXN0aW5nU2NhbGUueDsKICAgICAgICBjb25zdCBzY2FsZVJhdGlvWSA9IHNjYWxlIC8gZXhpc3RpbmdTY2FsZS55OwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDb2x1bW4zID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBNYXRyaXgyLmdldFNjYWxlID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gQ2FydGVzaWFuMl9kZWZhdWx0Lm1hZ25pdHVkZSgKICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tRWxlbWVudHMobWF0cml4WzBdLCBtYXRyaXhbMV0sIHNjcmF0Y2hDb2x1bW4zKQogICAgICAgICk7CiAgICAgICAgcmVzdWx0LnkgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQubWFnbml0dWRlKAogICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21FbGVtZW50cyhtYXRyaXhbMl0sIG1hdHJpeFszXSwgc2NyYXRjaENvbHVtbjMpCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY2FsZVNjcmF0Y2gzMyA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgTWF0cml4Mi5nZXRNYXhpbXVtU2NhbGUgPSBmdW5jdGlvbihtYXRyaXgpIHsKICAgICAgICBNYXRyaXgyLmdldFNjYWxlKG1hdHJpeCwgc2NhbGVTY3JhdGNoMzMpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yX2RlZmF1bHQubWF4aW11bUNvbXBvbmVudChzY2FsZVNjcmF0Y2gzMyk7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDQzID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBNYXRyaXgyLnNldFJvdGF0aW9uID0gZnVuY3Rpb24obWF0cml4LCByb3RhdGlvbiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBzY2FsZSA9IE1hdHJpeDIuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2g0Myk7CiAgICAgICAgcmVzdWx0WzBdID0gcm90YXRpb25bMF0gKiBzY2FsZS54OwogICAgICAgIHJlc3VsdFsxXSA9IHJvdGF0aW9uWzFdICogc2NhbGUueDsKICAgICAgICByZXN1bHRbMl0gPSByb3RhdGlvblsyXSAqIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzNdID0gcm90YXRpb25bM10gKiBzY2FsZS55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDUzID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBNYXRyaXgyLmdldFJvdGF0aW9uID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHNjYWxlID0gTWF0cml4Mi5nZXRTY2FsZShtYXRyaXgsIHNjYWxlU2NyYXRjaDUzKTsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF0gLyBzY2FsZS54OwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXSAvIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdIC8gc2NhbGUueTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM10gLyBzY2FsZS55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIubXVsdGlwbHkgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzAgPSBsZWZ0WzBdICogcmlnaHRbMF0gKyBsZWZ0WzJdICogcmlnaHRbMV07CiAgICAgICAgY29uc3QgY29sdW1uMVJvdzAgPSBsZWZ0WzBdICogcmlnaHRbMl0gKyBsZWZ0WzJdICogcmlnaHRbM107CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzEgPSBsZWZ0WzFdICogcmlnaHRbMF0gKyBsZWZ0WzNdICogcmlnaHRbMV07CiAgICAgICAgY29uc3QgY29sdW1uMVJvdzEgPSBsZWZ0WzFdICogcmlnaHRbMl0gKyBsZWZ0WzNdICogcmlnaHRbM107CiAgICAgICAgcmVzdWx0WzBdID0gY29sdW1uMFJvdzA7CiAgICAgICAgcmVzdWx0WzFdID0gY29sdW1uMFJvdzE7CiAgICAgICAgcmVzdWx0WzJdID0gY29sdW1uMVJvdzA7CiAgICAgICAgcmVzdWx0WzNdID0gY29sdW1uMVJvdzE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5hZGQgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbGVmdFswXSArIHJpZ2h0WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IGxlZnRbMV0gKyByaWdodFsxXTsKICAgICAgICByZXN1bHRbMl0gPSBsZWZ0WzJdICsgcmlnaHRbMl07CiAgICAgICAgcmVzdWx0WzNdID0gbGVmdFszXSArIHJpZ2h0WzNdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIuc3VidHJhY3QgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbGVmdFswXSAtIHJpZ2h0WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IGxlZnRbMV0gLSByaWdodFsxXTsKICAgICAgICByZXN1bHRbMl0gPSBsZWZ0WzJdIC0gcmlnaHRbMl07CiAgICAgICAgcmVzdWx0WzNdID0gbGVmdFszXSAtIHJpZ2h0WzNdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIubXVsdGlwbHlCeVZlY3RvciA9IGZ1bmN0aW9uKG1hdHJpeCwgY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgeCA9IG1hdHJpeFswXSAqIGNhcnRlc2lhbjExLnggKyBtYXRyaXhbMl0gKiBjYXJ0ZXNpYW4xMS55OwogICAgICAgIGNvbnN0IHkgPSBtYXRyaXhbMV0gKiBjYXJ0ZXNpYW4xMS54ICsgbWF0cml4WzNdICogY2FydGVzaWFuMTEueTsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIubXVsdGlwbHlCeVNjYWxhciA9IGZ1bmN0aW9uKG1hdHJpeCwgc2NhbGFyLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsYXIiLCBzY2FsYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF0gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM10gKiBzY2FsYXI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5tdWx0aXBseUJ5U2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdICogc2NhbGUueDsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gKiBzY2FsZS54OwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXSAqIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdICogc2NhbGUueTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgyLm11bHRpcGx5QnlVbmlmb3JtU2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdICogc2NhbGU7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdICogc2NhbGU7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdICogc2NhbGU7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdICogc2NhbGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5uZWdhdGUgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gLW1hdHJpeFswXTsKICAgICAgICByZXN1bHRbMV0gPSAtbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IC1tYXRyaXhbMl07CiAgICAgICAgcmVzdWx0WzNdID0gLW1hdHJpeFszXTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgyLnRyYW5zcG9zZSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MCA9IG1hdHJpeFswXTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MSA9IG1hdHJpeFsyXTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MCA9IG1hdHJpeFsxXTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MSA9IG1hdHJpeFszXTsKICAgICAgICByZXN1bHRbMF0gPSBjb2x1bW4wUm93MDsKICAgICAgICByZXN1bHRbMV0gPSBjb2x1bW4wUm93MTsKICAgICAgICByZXN1bHRbMl0gPSBjb2x1bW4xUm93MDsKICAgICAgICByZXN1bHRbM10gPSBjb2x1bW4xUm93MTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgyLmFicyA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbMF0gPSBNYXRoLmFicyhtYXRyaXhbMF0pOwogICAgICAgIHJlc3VsdFsxXSA9IE1hdGguYWJzKG1hdHJpeFsxXSk7CiAgICAgICAgcmVzdWx0WzJdID0gTWF0aC5hYnMobWF0cml4WzJdKTsKICAgICAgICByZXN1bHRbM10gPSBNYXRoLmFicyhtYXRyaXhbM10pOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIuZXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgbGVmdFswXSA9PT0gcmlnaHRbMF0gJiYgbGVmdFsxXSA9PT0gcmlnaHRbMV0gJiYgbGVmdFsyXSA9PT0gcmlnaHRbMl0gJiYgbGVmdFszXSA9PT0gcmlnaHRbM107CiAgICAgIH07CiAgICAgIE1hdHJpeDIuZXF1YWxzQXJyYXkgPSBmdW5jdGlvbihtYXRyaXgsIGFycmF5LCBvZmZzZXQpIHsKICAgICAgICByZXR1cm4gbWF0cml4WzBdID09PSBhcnJheVtvZmZzZXRdICYmIG1hdHJpeFsxXSA9PT0gYXJyYXlbb2Zmc2V0ICsgMV0gJiYgbWF0cml4WzJdID09PSBhcnJheVtvZmZzZXQgKyAyXSAmJiBtYXRyaXhbM10gPT09IGFycmF5W29mZnNldCArIDNdOwogICAgICB9OwogICAgICBNYXRyaXgyLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgZXBzaWxvbikgewogICAgICAgIGVwc2lsb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlcHNpbG9uLCAwKTsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgTWF0aC5hYnMobGVmdFswXSAtIHJpZ2h0WzBdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMV0gLSByaWdodFsxXSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzJdIC0gcmlnaHRbMl0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFszXSAtIHJpZ2h0WzNdKSA8PSBlcHNpbG9uOwogICAgICB9OwogICAgICBNYXRyaXgyLklERU5USVRZID0gT2JqZWN0LmZyZWV6ZShuZXcgTWF0cml4MigxLCAwLCAwLCAxKSk7CiAgICAgIE1hdHJpeDIuWkVSTyA9IE9iamVjdC5mcmVlemUobmV3IE1hdHJpeDIoMCwgMCwgMCwgMCkpOwogICAgICBNYXRyaXgyLkNPTFVNTjBST1cwID0gMDsKICAgICAgTWF0cml4Mi5DT0xVTU4wUk9XMSA9IDE7CiAgICAgIE1hdHJpeDIuQ09MVU1OMVJPVzAgPSAyOwogICAgICBNYXRyaXgyLkNPTFVNTjFST1cxID0gMzsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoTWF0cml4Mi5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBudW1iZXIgb2YgaXRlbXMgaW4gdGhlIGNvbGxlY3Rpb24uCiAgICAgICAgICogQG1lbWJlcm9mIE1hdHJpeDIucHJvdG90eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGxlbmd0aDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdHJpeDIucGFja2VkTGVuZ3RoOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIE1hdHJpeDIucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIE1hdHJpeDIuY2xvbmUodGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgTWF0cml4Mi5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ocmlnaHQpIHsKICAgICAgICByZXR1cm4gTWF0cml4Mi5lcXVhbHModGhpcywgcmlnaHQpOwogICAgICB9OwogICAgICBNYXRyaXgyLnByb3RvdHlwZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24ocmlnaHQsIGVwc2lsb24pIHsKICAgICAgICByZXR1cm4gTWF0cml4Mi5lcXVhbHNFcHNpbG9uKHRoaXMsIHJpZ2h0LCBlcHNpbG9uKTsKICAgICAgfTsKICAgICAgTWF0cml4Mi5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYCgke3RoaXNbMF19LCAke3RoaXNbMl19KQooJHt0aGlzWzFdfSwgJHt0aGlzWzNdfSlgOwogICAgICB9OwogICAgICBNYXRyaXgyX2RlZmF1bHQgPSBNYXRyaXgyOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUHJpbWl0aXZlVHlwZS5qcwogIHZhciBQcmltaXRpdmVUeXBlLCBQcmltaXRpdmVUeXBlX2RlZmF1bHQ7CiAgdmFyIGluaXRfUHJpbWl0aXZlVHlwZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUHJpbWl0aXZlVHlwZS5qcyIoKSB7CiAgICAgIGluaXRfV2ViR0xDb25zdGFudHMoKTsKICAgICAgUHJpbWl0aXZlVHlwZSA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBQb2ludHMgcHJpbWl0aXZlIHdoZXJlIGVhY2ggdmVydGV4IChvciBpbmRleCkgaXMgYSBzZXBhcmF0ZSBwb2ludC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUE9JTlRTOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlBPSU5UUywKICAgICAgICAvKioKICAgICAgICAgKiBMaW5lcyBwcmltaXRpdmUgd2hlcmUgZWFjaCB0d28gdmVydGljZXMgKG9yIGluZGljZXMpIGlzIGEgbGluZSBzZWdtZW50LiAgTGluZSBzZWdtZW50cyBhcmUgbm90IG5lY2Vzc2FyaWx5IGNvbm5lY3RlZC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgTElORVM6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuTElORVMsCiAgICAgICAgLyoqCiAgICAgICAgICogTGluZSBsb29wIHByaW1pdGl2ZSB3aGVyZSBlYWNoIHZlcnRleCAob3IgaW5kZXgpIGFmdGVyIHRoZSBmaXJzdCBjb25uZWN0cyBhIGxpbmUgdG8KICAgICAgICAgKiB0aGUgcHJldmlvdXMgdmVydGV4LCBhbmQgdGhlIGxhc3QgdmVydGV4IGltcGxpY2l0bHkgY29ubmVjdHMgdG8gdGhlIGZpcnN0LgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBMSU5FX0xPT1A6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuTElORV9MT09QLAogICAgICAgIC8qKgogICAgICAgICAqIExpbmUgc3RyaXAgcHJpbWl0aXZlIHdoZXJlIGVhY2ggdmVydGV4IChvciBpbmRleCkgYWZ0ZXIgdGhlIGZpcnN0IGNvbm5lY3RzIGEgbGluZSB0byB0aGUgcHJldmlvdXMgdmVydGV4LgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBMSU5FX1NUUklQOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkxJTkVfU1RSSVAsCiAgICAgICAgLyoqCiAgICAgICAgICogVHJpYW5nbGVzIHByaW1pdGl2ZSB3aGVyZSBlYWNoIHRocmVlIHZlcnRpY2VzIChvciBpbmRpY2VzKSBpcyBhIHRyaWFuZ2xlLiAgVHJpYW5nbGVzIGRvIG5vdCBuZWNlc3NhcmlseSBzaGFyZSBlZGdlcy4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVFJJQU5HTEVTOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlRSSUFOR0xFUywKICAgICAgICAvKioKICAgICAgICAgKiBUcmlhbmdsZSBzdHJpcCBwcmltaXRpdmUgd2hlcmUgZWFjaCB2ZXJ0ZXggKG9yIGluZGV4KSBhZnRlciB0aGUgZmlyc3QgdHdvIGNvbm5lY3QgdG8KICAgICAgICAgKiB0aGUgcHJldmlvdXMgdHdvIHZlcnRpY2VzIGZvcm1pbmcgYSB0cmlhbmdsZS4gIEZvciBleGFtcGxlLCB0aGlzIGNhbiBiZSB1c2VkIHRvIG1vZGVsIGEgd2FsbC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVFJJQU5HTEVfU1RSSVA6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVFJJQU5HTEVfU1RSSVAsCiAgICAgICAgLyoqCiAgICAgICAgICogVHJpYW5nbGUgZmFuIHByaW1pdGl2ZSB3aGVyZSBlYWNoIHZlcnRleCAob3IgaW5kZXgpIGFmdGVyIHRoZSBmaXJzdCB0d28gY29ubmVjdCB0bwogICAgICAgICAqIHRoZSBwcmV2aW91cyB2ZXJ0ZXggYW5kIHRoZSBmaXJzdCB2ZXJ0ZXggZm9ybWluZyBhIHRyaWFuZ2xlLiAgRm9yIGV4YW1wbGUsIHRoaXMgY2FuIGJlIHVzZWQKICAgICAgICAgKiB0byBtb2RlbCBhIGNvbmUgb3IgY2lyY2xlLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBUUklBTkdMRV9GQU46IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVFJJQU5HTEVfRkFOCiAgICAgIH07CiAgICAgIFByaW1pdGl2ZVR5cGUuaXNMaW5lcyA9IGZ1bmN0aW9uKHByaW1pdGl2ZVR5cGUpIHsKICAgICAgICByZXR1cm4gcHJpbWl0aXZlVHlwZSA9PT0gUHJpbWl0aXZlVHlwZS5MSU5FUyB8fCBwcmltaXRpdmVUeXBlID09PSBQcmltaXRpdmVUeXBlLkxJTkVfTE9PUCB8fCBwcmltaXRpdmVUeXBlID09PSBQcmltaXRpdmVUeXBlLkxJTkVfU1RSSVA7CiAgICAgIH07CiAgICAgIFByaW1pdGl2ZVR5cGUuaXNUcmlhbmdsZXMgPSBmdW5jdGlvbihwcmltaXRpdmVUeXBlKSB7CiAgICAgICAgcmV0dXJuIHByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGUuVFJJQU5HTEVTIHx8IHByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGUuVFJJQU5HTEVfU1RSSVAgfHwgcHJpbWl0aXZlVHlwZSA9PT0gUHJpbWl0aXZlVHlwZS5UUklBTkdMRV9GQU47CiAgICAgIH07CiAgICAgIFByaW1pdGl2ZVR5cGUudmFsaWRhdGUgPSBmdW5jdGlvbihwcmltaXRpdmVUeXBlKSB7CiAgICAgICAgcmV0dXJuIHByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGUuUE9JTlRTIHx8IHByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGUuTElORVMgfHwgcHJpbWl0aXZlVHlwZSA9PT0gUHJpbWl0aXZlVHlwZS5MSU5FX0xPT1AgfHwgcHJpbWl0aXZlVHlwZSA9PT0gUHJpbWl0aXZlVHlwZS5MSU5FX1NUUklQIHx8IHByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGUuVFJJQU5HTEVTIHx8IHByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGUuVFJJQU5HTEVfU1RSSVAgfHwgcHJpbWl0aXZlVHlwZSA9PT0gUHJpbWl0aXZlVHlwZS5UUklBTkdMRV9GQU47CiAgICAgIH07CiAgICAgIFByaW1pdGl2ZVR5cGVfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoUHJpbWl0aXZlVHlwZSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9GdWxsc2NyZWVuLmpzCiAgdmFyIF9zdXBwb3J0c0Z1bGxzY3JlZW4sIF9uYW1lcywgRnVsbHNjcmVlbiwgRnVsbHNjcmVlbl9kZWZhdWx0OwogIHZhciBpbml0X0Z1bGxzY3JlZW4gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0Z1bGxzY3JlZW4uanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgX25hbWVzID0gewogICAgICAgIHJlcXVlc3RGdWxsc2NyZWVuOiB2b2lkIDAsCiAgICAgICAgZXhpdEZ1bGxzY3JlZW46IHZvaWQgMCwKICAgICAgICBmdWxsc2NyZWVuRW5hYmxlZDogdm9pZCAwLAogICAgICAgIGZ1bGxzY3JlZW5FbGVtZW50OiB2b2lkIDAsCiAgICAgICAgZnVsbHNjcmVlbmNoYW5nZTogdm9pZCAwLAogICAgICAgIGZ1bGxzY3JlZW5lcnJvcjogdm9pZCAwCiAgICAgIH07CiAgICAgIEZ1bGxzY3JlZW4gPSB7fTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoRnVsbHNjcmVlbiwgewogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBlbGVtZW50IHRoYXQgaXMgY3VycmVudGx5IGZ1bGxzY3JlZW4sIGlmIGFueS4gIFRvIHNpbXBseSBjaGVjayBpZiB0aGUKICAgICAgICAgKiBicm93c2VyIGlzIGluIGZ1bGxzY3JlZW4gbW9kZSBvciBub3QsIHVzZSB7QGxpbmsgRnVsbHNjcmVlbiNmdWxsc2NyZWVufS4KICAgICAgICAgKiBAbWVtYmVyb2YgRnVsbHNjcmVlbgogICAgICAgICAqIEB0eXBlIHtvYmplY3R9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgZWxlbWVudDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFGdWxsc2NyZWVuLnN1cHBvcnRzRnVsbHNjcmVlbigpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZG9jdW1lbnRbX25hbWVzLmZ1bGxzY3JlZW5FbGVtZW50XTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBuYW1lIG9mIHRoZSBldmVudCBvbiB0aGUgZG9jdW1lbnQgdGhhdCBpcyBmaXJlZCB3aGVuIGZ1bGxzY3JlZW4gaXMKICAgICAgICAgKiBlbnRlcmVkIG9yIGV4aXRlZC4gIFRoaXMgZXZlbnQgbmFtZSBpcyBpbnRlbmRlZCBmb3IgdXNlIHdpdGggYWRkRXZlbnRMaXN0ZW5lci4KICAgICAgICAgKiBJbiB5b3VyIGV2ZW50IGhhbmRsZXIsIHRvIGRldGVybWluZSBpZiB0aGUgYnJvd3NlciBpcyBpbiBmdWxsc2NyZWVuIG1vZGUgb3Igbm90LAogICAgICAgICAqIHVzZSB7QGxpbmsgRnVsbHNjcmVlbiNmdWxsc2NyZWVufS4KICAgICAgICAgKiBAbWVtYmVyb2YgRnVsbHNjcmVlbgogICAgICAgICAqIEB0eXBlIHtzdHJpbmd9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgY2hhbmdlRXZlbnROYW1lOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIUZ1bGxzY3JlZW4uc3VwcG9ydHNGdWxsc2NyZWVuKCkpIHsKICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBfbmFtZXMuZnVsbHNjcmVlbmNoYW5nZTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBuYW1lIG9mIHRoZSBldmVudCB0aGF0IGlzIGZpcmVkIHdoZW4gYSBmdWxsc2NyZWVuIGVycm9yCiAgICAgICAgICogb2NjdXJzLiAgVGhpcyBldmVudCBuYW1lIGlzIGludGVuZGVkIGZvciB1c2Ugd2l0aCBhZGRFdmVudExpc3RlbmVyLgogICAgICAgICAqIEBtZW1iZXJvZiBGdWxsc2NyZWVuCiAgICAgICAgICogQHR5cGUge3N0cmluZ30KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBlcnJvckV2ZW50TmFtZTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFGdWxsc2NyZWVuLnN1cHBvcnRzRnVsbHNjcmVlbigpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gX25hbWVzLmZ1bGxzY3JlZW5lcnJvcjsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIERldGVybWluZSB3aGV0aGVyIHRoZSBicm93c2VyIHdpbGwgYWxsb3cgYW4gZWxlbWVudCB0byBiZSBtYWRlIGZ1bGxzY3JlZW4sIG9yIG5vdC4KICAgICAgICAgKiBGb3IgZXhhbXBsZSwgYnkgZGVmYXVsdCwgaWZyYW1lcyBjYW5ub3QgZ28gZnVsbHNjcmVlbiB1bmxlc3MgdGhlIGNvbnRhaW5pbmcgcGFnZQogICAgICAgICAqIGFkZHMgYW4gImFsbG93ZnVsbHNjcmVlbiIgYXR0cmlidXRlIChvciBwcmVmaXhlZCBlcXVpdmFsZW50KS4KICAgICAgICAgKiBAbWVtYmVyb2YgRnVsbHNjcmVlbgogICAgICAgICAqIEB0eXBlIHtib29sZWFufQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGVuYWJsZWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghRnVsbHNjcmVlbi5zdXBwb3J0c0Z1bGxzY3JlZW4oKSkgewogICAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50W19uYW1lcy5mdWxsc2NyZWVuRW5hYmxlZF07CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBEZXRlcm1pbmVzIGlmIHRoZSBicm93c2VyIGlzIGN1cnJlbnRseSBpbiBmdWxsc2NyZWVuIG1vZGUuCiAgICAgICAgICogQG1lbWJlcm9mIEZ1bGxzY3JlZW4KICAgICAgICAgKiBAdHlwZSB7Ym9vbGVhbn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBmdWxsc2NyZWVuOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIUZ1bGxzY3JlZW4uc3VwcG9ydHNGdWxsc2NyZWVuKCkpIHsKICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBGdWxsc2NyZWVuLmVsZW1lbnQgIT09IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgRnVsbHNjcmVlbi5zdXBwb3J0c0Z1bGxzY3JlZW4gPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KF9zdXBwb3J0c0Z1bGxzY3JlZW4pKSB7CiAgICAgICAgICByZXR1cm4gX3N1cHBvcnRzRnVsbHNjcmVlbjsKICAgICAgICB9CiAgICAgICAgX3N1cHBvcnRzRnVsbHNjcmVlbiA9IGZhbHNlOwogICAgICAgIGNvbnN0IGJvZHkgPSBkb2N1bWVudC5ib2R5OwogICAgICAgIGlmICh0eXBlb2YgYm9keS5yZXF1ZXN0RnVsbHNjcmVlbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX25hbWVzLnJlcXVlc3RGdWxsc2NyZWVuID0gInJlcXVlc3RGdWxsc2NyZWVuIjsKICAgICAgICAgIF9uYW1lcy5leGl0RnVsbHNjcmVlbiA9ICJleGl0RnVsbHNjcmVlbiI7CiAgICAgICAgICBfbmFtZXMuZnVsbHNjcmVlbkVuYWJsZWQgPSAiZnVsbHNjcmVlbkVuYWJsZWQiOwogICAgICAgICAgX25hbWVzLmZ1bGxzY3JlZW5FbGVtZW50ID0gImZ1bGxzY3JlZW5FbGVtZW50IjsKICAgICAgICAgIF9uYW1lcy5mdWxsc2NyZWVuY2hhbmdlID0gImZ1bGxzY3JlZW5jaGFuZ2UiOwogICAgICAgICAgX25hbWVzLmZ1bGxzY3JlZW5lcnJvciA9ICJmdWxsc2NyZWVuZXJyb3IiOwogICAgICAgICAgX3N1cHBvcnRzRnVsbHNjcmVlbiA9IHRydWU7CiAgICAgICAgICByZXR1cm4gX3N1cHBvcnRzRnVsbHNjcmVlbjsKICAgICAgICB9CiAgICAgICAgY29uc3QgcHJlZml4ZXMgPSBbIndlYmtpdCIsICJtb3oiLCAibyIsICJtcyIsICJraHRtbCJdOwogICAgICAgIGxldCBuYW1lOwogICAgICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBwcmVmaXhlcy5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICAgICAgY29uc3QgcHJlZml4ID0gcHJlZml4ZXNbaV07CiAgICAgICAgICBuYW1lID0gYCR7cHJlZml4fVJlcXVlc3RGdWxsc2NyZWVuYDsKICAgICAgICAgIGlmICh0eXBlb2YgYm9keVtuYW1lXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBfbmFtZXMucmVxdWVzdEZ1bGxzY3JlZW4gPSBuYW1lOwogICAgICAgICAgICBfc3VwcG9ydHNGdWxsc2NyZWVuID0gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5hbWUgPSBgJHtwcmVmaXh9UmVxdWVzdEZ1bGxTY3JlZW5gOwogICAgICAgICAgICBpZiAodHlwZW9mIGJvZHlbbmFtZV0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBfbmFtZXMucmVxdWVzdEZ1bGxzY3JlZW4gPSBuYW1lOwogICAgICAgICAgICAgIF9zdXBwb3J0c0Z1bGxzY3JlZW4gPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBuYW1lID0gYCR7cHJlZml4fUV4aXRGdWxsc2NyZWVuYDsKICAgICAgICAgIGlmICh0eXBlb2YgZG9jdW1lbnRbbmFtZV0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgX25hbWVzLmV4aXRGdWxsc2NyZWVuID0gbmFtZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5hbWUgPSBgJHtwcmVmaXh9Q2FuY2VsRnVsbFNjcmVlbmA7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZG9jdW1lbnRbbmFtZV0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBfbmFtZXMuZXhpdEZ1bGxzY3JlZW4gPSBuYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBuYW1lID0gYCR7cHJlZml4fUZ1bGxzY3JlZW5FbmFibGVkYDsKICAgICAgICAgIGlmIChkb2N1bWVudFtuYW1lXSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIF9uYW1lcy5mdWxsc2NyZWVuRW5hYmxlZCA9IG5hbWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuYW1lID0gYCR7cHJlZml4fUZ1bGxTY3JlZW5FbmFibGVkYDsKICAgICAgICAgICAgaWYgKGRvY3VtZW50W25hbWVdICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBfbmFtZXMuZnVsbHNjcmVlbkVuYWJsZWQgPSBuYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBuYW1lID0gYCR7cHJlZml4fUZ1bGxzY3JlZW5FbGVtZW50YDsKICAgICAgICAgIGlmIChkb2N1bWVudFtuYW1lXSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIF9uYW1lcy5mdWxsc2NyZWVuRWxlbWVudCA9IG5hbWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuYW1lID0gYCR7cHJlZml4fUZ1bGxTY3JlZW5FbGVtZW50YDsKICAgICAgICAgICAgaWYgKGRvY3VtZW50W25hbWVdICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBfbmFtZXMuZnVsbHNjcmVlbkVsZW1lbnQgPSBuYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBuYW1lID0gYCR7cHJlZml4fWZ1bGxzY3JlZW5jaGFuZ2VgOwogICAgICAgICAgaWYgKGRvY3VtZW50W2BvbiR7bmFtZX1gXSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmIChwcmVmaXggPT09ICJtcyIpIHsKICAgICAgICAgICAgICBuYW1lID0gIk1TRnVsbHNjcmVlbkNoYW5nZSI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgX25hbWVzLmZ1bGxzY3JlZW5jaGFuZ2UgPSBuYW1lOwogICAgICAgICAgfQogICAgICAgICAgbmFtZSA9IGAke3ByZWZpeH1mdWxsc2NyZWVuZXJyb3JgOwogICAgICAgICAgaWYgKGRvY3VtZW50W2BvbiR7bmFtZX1gXSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmIChwcmVmaXggPT09ICJtcyIpIHsKICAgICAgICAgICAgICBuYW1lID0gIk1TRnVsbHNjcmVlbkVycm9yIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBfbmFtZXMuZnVsbHNjcmVlbmVycm9yID0gbmFtZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIF9zdXBwb3J0c0Z1bGxzY3JlZW47CiAgICAgIH07CiAgICAgIEZ1bGxzY3JlZW4ucmVxdWVzdEZ1bGxzY3JlZW4gPSBmdW5jdGlvbihlbGVtZW50LCB2ckRldmljZSkgewogICAgICAgIGlmICghRnVsbHNjcmVlbi5zdXBwb3J0c0Z1bGxzY3JlZW4oKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBlbGVtZW50W19uYW1lcy5yZXF1ZXN0RnVsbHNjcmVlbl0oeyB2ckRpc3BsYXk6IHZyRGV2aWNlIH0pOwogICAgICB9OwogICAgICBGdWxsc2NyZWVuLmV4aXRGdWxsc2NyZWVuID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCFGdWxsc2NyZWVuLnN1cHBvcnRzRnVsbHNjcmVlbigpKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGRvY3VtZW50W19uYW1lcy5leGl0RnVsbHNjcmVlbl0oKTsKICAgICAgfTsKICAgICAgRnVsbHNjcmVlbi5fbmFtZXMgPSBfbmFtZXM7CiAgICAgIEZ1bGxzY3JlZW5fZGVmYXVsdCA9IEZ1bGxzY3JlZW47CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9GZWF0dXJlRGV0ZWN0aW9uLmpzCiAgZnVuY3Rpb24gZXh0cmFjdFZlcnNpb24odmVyc2lvblN0cmluZykgewogICAgY29uc3QgcGFydHMgPSB2ZXJzaW9uU3RyaW5nLnNwbGl0KCIuIik7CiAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gcGFydHMubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgICAgcGFydHNbaV0gPSBwYXJzZUludChwYXJ0c1tpXSwgMTApOwogICAgfQogICAgcmV0dXJuIHBhcnRzOwogIH0KICBmdW5jdGlvbiBpc0Nocm9tZSgpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGlzQ2hyb21lUmVzdWx0KSkgewogICAgICBpc0Nocm9tZVJlc3VsdCA9IGZhbHNlOwogICAgICBpZiAoIWlzRWRnZSgpKSB7CiAgICAgICAgY29uc3QgZmllbGRzID0gLyBDaHJvbWVcLyhbXC4wLTldKykvLmV4ZWModGhlTmF2aWdhdG9yLnVzZXJBZ2VudCk7CiAgICAgICAgaWYgKGZpZWxkcyAhPT0gbnVsbCkgewogICAgICAgICAgaXNDaHJvbWVSZXN1bHQgPSB0cnVlOwogICAgICAgICAgY2hyb21lVmVyc2lvblJlc3VsdCA9IGV4dHJhY3RWZXJzaW9uKGZpZWxkc1sxXSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gaXNDaHJvbWVSZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGNocm9tZVZlcnNpb24oKSB7CiAgICByZXR1cm4gaXNDaHJvbWUoKSAmJiBjaHJvbWVWZXJzaW9uUmVzdWx0OwogIH0KICBmdW5jdGlvbiBpc1NhZmFyaSgpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGlzU2FmYXJpUmVzdWx0KSkgewogICAgICBpc1NhZmFyaVJlc3VsdCA9IGZhbHNlOwogICAgICBpZiAoIWlzQ2hyb21lKCkgJiYgIWlzRWRnZSgpICYmIC8gU2FmYXJpXC9bXC4wLTldKy8udGVzdCh0aGVOYXZpZ2F0b3IudXNlckFnZW50KSkgewogICAgICAgIGNvbnN0IGZpZWxkcyA9IC8gVmVyc2lvblwvKFtcLjAtOV0rKS8uZXhlYyh0aGVOYXZpZ2F0b3IudXNlckFnZW50KTsKICAgICAgICBpZiAoZmllbGRzICE9PSBudWxsKSB7CiAgICAgICAgICBpc1NhZmFyaVJlc3VsdCA9IHRydWU7CiAgICAgICAgICBzYWZhcmlWZXJzaW9uUmVzdWx0ID0gZXh0cmFjdFZlcnNpb24oZmllbGRzWzFdKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBpc1NhZmFyaVJlc3VsdDsKICB9CiAgZnVuY3Rpb24gc2FmYXJpVmVyc2lvbigpIHsKICAgIHJldHVybiBpc1NhZmFyaSgpICYmIHNhZmFyaVZlcnNpb25SZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGlzV2Via2l0KCkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaXNXZWJraXRSZXN1bHQpKSB7CiAgICAgIGlzV2Via2l0UmVzdWx0ID0gZmFsc2U7CiAgICAgIGNvbnN0IGZpZWxkcyA9IC8gQXBwbGVXZWJLaXRcLyhbXC4wLTldKykoXCs/KS8uZXhlYyh0aGVOYXZpZ2F0b3IudXNlckFnZW50KTsKICAgICAgaWYgKGZpZWxkcyAhPT0gbnVsbCkgewogICAgICAgIGlzV2Via2l0UmVzdWx0ID0gdHJ1ZTsKICAgICAgICB3ZWJraXRWZXJzaW9uUmVzdWx0ID0gZXh0cmFjdFZlcnNpb24oZmllbGRzWzFdKTsKICAgICAgICB3ZWJraXRWZXJzaW9uUmVzdWx0LmlzTmlnaHRseSA9ICEhZmllbGRzWzJdOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gaXNXZWJraXRSZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIHdlYmtpdFZlcnNpb24oKSB7CiAgICByZXR1cm4gaXNXZWJraXQoKSAmJiB3ZWJraXRWZXJzaW9uUmVzdWx0OwogIH0KICBmdW5jdGlvbiBpc0ludGVybmV0RXhwbG9yZXIoKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpc0ludGVybmV0RXhwbG9yZXJSZXN1bHQpKSB7CiAgICAgIGlzSW50ZXJuZXRFeHBsb3JlclJlc3VsdCA9IGZhbHNlOwogICAgICBsZXQgZmllbGRzOwogICAgICBpZiAodGhlTmF2aWdhdG9yLmFwcE5hbWUgPT09ICJNaWNyb3NvZnQgSW50ZXJuZXQgRXhwbG9yZXIiKSB7CiAgICAgICAgZmllbGRzID0gL01TSUUgKFswLTldezEsfVtcLjAtOV17MCx9KS8uZXhlYyh0aGVOYXZpZ2F0b3IudXNlckFnZW50KTsKICAgICAgICBpZiAoZmllbGRzICE9PSBudWxsKSB7CiAgICAgICAgICBpc0ludGVybmV0RXhwbG9yZXJSZXN1bHQgPSB0cnVlOwogICAgICAgICAgaW50ZXJuZXRFeHBsb3JlclZlcnNpb25SZXN1bHQgPSBleHRyYWN0VmVyc2lvbihmaWVsZHNbMV0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh0aGVOYXZpZ2F0b3IuYXBwTmFtZSA9PT0gIk5ldHNjYXBlIikgewogICAgICAgIGZpZWxkcyA9IC9UcmlkZW50XC8uKnJ2OihbMC05XXsxLH1bXC4wLTldezAsfSkvLmV4ZWMoCiAgICAgICAgICB0aGVOYXZpZ2F0b3IudXNlckFnZW50CiAgICAgICAgKTsKICAgICAgICBpZiAoZmllbGRzICE9PSBudWxsKSB7CiAgICAgICAgICBpc0ludGVybmV0RXhwbG9yZXJSZXN1bHQgPSB0cnVlOwogICAgICAgICAgaW50ZXJuZXRFeHBsb3JlclZlcnNpb25SZXN1bHQgPSBleHRyYWN0VmVyc2lvbihmaWVsZHNbMV0pOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGlzSW50ZXJuZXRFeHBsb3JlclJlc3VsdDsKICB9CiAgZnVuY3Rpb24gaW50ZXJuZXRFeHBsb3JlclZlcnNpb24oKSB7CiAgICByZXR1cm4gaXNJbnRlcm5ldEV4cGxvcmVyKCkgJiYgaW50ZXJuZXRFeHBsb3JlclZlcnNpb25SZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGlzRWRnZSgpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGlzRWRnZVJlc3VsdCkpIHsKICAgICAgaXNFZGdlUmVzdWx0ID0gZmFsc2U7CiAgICAgIGNvbnN0IGZpZWxkcyA9IC8gRWRnXC8oW1wuMC05XSspLy5leGVjKHRoZU5hdmlnYXRvci51c2VyQWdlbnQpOwogICAgICBpZiAoZmllbGRzICE9PSBudWxsKSB7CiAgICAgICAgaXNFZGdlUmVzdWx0ID0gdHJ1ZTsKICAgICAgICBlZGdlVmVyc2lvblJlc3VsdCA9IGV4dHJhY3RWZXJzaW9uKGZpZWxkc1sxXSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBpc0VkZ2VSZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGVkZ2VWZXJzaW9uKCkgewogICAgcmV0dXJuIGlzRWRnZSgpICYmIGVkZ2VWZXJzaW9uUmVzdWx0OwogIH0KICBmdW5jdGlvbiBpc0ZpcmVmb3goKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpc0ZpcmVmb3hSZXN1bHQpKSB7CiAgICAgIGlzRmlyZWZveFJlc3VsdCA9IGZhbHNlOwogICAgICBjb25zdCBmaWVsZHMgPSAvRmlyZWZveFwvKFtcLjAtOV0rKS8uZXhlYyh0aGVOYXZpZ2F0b3IudXNlckFnZW50KTsKICAgICAgaWYgKGZpZWxkcyAhPT0gbnVsbCkgewogICAgICAgIGlzRmlyZWZveFJlc3VsdCA9IHRydWU7CiAgICAgICAgZmlyZWZveFZlcnNpb25SZXN1bHQgPSBleHRyYWN0VmVyc2lvbihmaWVsZHNbMV0pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gaXNGaXJlZm94UmVzdWx0OwogIH0KICBmdW5jdGlvbiBpc1dpbmRvd3MoKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpc1dpbmRvd3NSZXN1bHQpKSB7CiAgICAgIGlzV2luZG93c1Jlc3VsdCA9IC9XaW5kb3dzL2kudGVzdCh0aGVOYXZpZ2F0b3IuYXBwVmVyc2lvbik7CiAgICB9CiAgICByZXR1cm4gaXNXaW5kb3dzUmVzdWx0OwogIH0KICBmdW5jdGlvbiBpc0lQYWRPcklPUygpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGlzSVBhZE9ySU9TUmVzdWx0KSkgewogICAgICBpc0lQYWRPcklPU1Jlc3VsdCA9IG5hdmlnYXRvci5wbGF0Zm9ybSA9PT0gImlQaG9uZSIgfHwgbmF2aWdhdG9yLnBsYXRmb3JtID09PSAiaVBvZCIgfHwgbmF2aWdhdG9yLnBsYXRmb3JtID09PSAiaVBhZCI7CiAgICB9CiAgICByZXR1cm4gaXNJUGFkT3JJT1NSZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGZpcmVmb3hWZXJzaW9uKCkgewogICAgcmV0dXJuIGlzRmlyZWZveCgpICYmIGZpcmVmb3hWZXJzaW9uUmVzdWx0OwogIH0KICBmdW5jdGlvbiBzdXBwb3J0c1BvaW50ZXJFdmVudHMoKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChoYXNQb2ludGVyRXZlbnRzKSkgewogICAgICBoYXNQb2ludGVyRXZlbnRzID0gIWlzRmlyZWZveCgpICYmIHR5cGVvZiBQb2ludGVyRXZlbnQgIT09ICJ1bmRlZmluZWQiICYmICghZGVmaW5lZF9kZWZhdWx0KHRoZU5hdmlnYXRvci5wb2ludGVyRW5hYmxlZCkgfHwgdGhlTmF2aWdhdG9yLnBvaW50ZXJFbmFibGVkKTsKICAgIH0KICAgIHJldHVybiBoYXNQb2ludGVyRXZlbnRzOwogIH0KICBmdW5jdGlvbiBzdXBwb3J0c0ltYWdlUmVuZGVyaW5nUGl4ZWxhdGVkKCkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc3VwcG9ydHNJbWFnZVJlbmRlcmluZ1BpeGVsYXRlZFJlc3VsdCkpIHsKICAgICAgY29uc3QgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiY2FudmFzIik7CiAgICAgIGNhbnZhcy5zZXRBdHRyaWJ1dGUoCiAgICAgICAgInN0eWxlIiwKICAgICAgICAiaW1hZ2UtcmVuZGVyaW5nOiAtbW96LWNyaXNwLWVkZ2VzO2ltYWdlLXJlbmRlcmluZzogcGl4ZWxhdGVkOyIKICAgICAgKTsKICAgICAgY29uc3QgdG1wMiA9IGNhbnZhcy5zdHlsZS5pbWFnZVJlbmRlcmluZzsKICAgICAgc3VwcG9ydHNJbWFnZVJlbmRlcmluZ1BpeGVsYXRlZFJlc3VsdCA9IGRlZmluZWRfZGVmYXVsdCh0bXAyKSAmJiB0bXAyICE9PSAiIjsKICAgICAgaWYgKHN1cHBvcnRzSW1hZ2VSZW5kZXJpbmdQaXhlbGF0ZWRSZXN1bHQpIHsKICAgICAgICBpbWFnZVJlbmRlcmluZ1ZhbHVlUmVzdWx0ID0gdG1wMjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHN1cHBvcnRzSW1hZ2VSZW5kZXJpbmdQaXhlbGF0ZWRSZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGltYWdlUmVuZGVyaW5nVmFsdWUoKSB7CiAgICByZXR1cm4gc3VwcG9ydHNJbWFnZVJlbmRlcmluZ1BpeGVsYXRlZCgpID8gaW1hZ2VSZW5kZXJpbmdWYWx1ZVJlc3VsdCA6IHZvaWQgMDsKICB9CiAgZnVuY3Rpb24gc3VwcG9ydHNXZWJQKCkgewogICAgaWYgKCFzdXBwb3J0c1dlYlAuaW5pdGlhbGl6ZWQpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIllvdSBtdXN0IGNhbGwgRmVhdHVyZURldGVjdGlvbi5zdXBwb3J0c1dlYlAuaW5pdGlhbGl6ZSBhbmQgd2FpdCBmb3IgdGhlIHByb21pc2UgdG8gcmVzb2x2ZSBiZWZvcmUgY2FsbGluZyBGZWF0dXJlRGV0ZWN0aW9uLnN1cHBvcnRzV2ViUCIKICAgICAgKTsKICAgIH0KICAgIHJldHVybiBzdXBwb3J0c1dlYlAuX3Jlc3VsdDsKICB9CiAgdmFyIHRoZU5hdmlnYXRvciwgaXNDaHJvbWVSZXN1bHQsIGNocm9tZVZlcnNpb25SZXN1bHQsIGlzU2FmYXJpUmVzdWx0LCBzYWZhcmlWZXJzaW9uUmVzdWx0LCBpc1dlYmtpdFJlc3VsdCwgd2Via2l0VmVyc2lvblJlc3VsdCwgaXNJbnRlcm5ldEV4cGxvcmVyUmVzdWx0LCBpbnRlcm5ldEV4cGxvcmVyVmVyc2lvblJlc3VsdCwgaXNFZGdlUmVzdWx0LCBlZGdlVmVyc2lvblJlc3VsdCwgaXNGaXJlZm94UmVzdWx0LCBmaXJlZm94VmVyc2lvblJlc3VsdCwgaXNXaW5kb3dzUmVzdWx0LCBpc0lQYWRPcklPU1Jlc3VsdCwgaGFzUG9pbnRlckV2ZW50cywgaW1hZ2VSZW5kZXJpbmdWYWx1ZVJlc3VsdCwgc3VwcG9ydHNJbWFnZVJlbmRlcmluZ1BpeGVsYXRlZFJlc3VsdCwgdHlwZWRBcnJheVR5cGVzLCBGZWF0dXJlRGV0ZWN0aW9uLCBGZWF0dXJlRGV0ZWN0aW9uX2RlZmF1bHQ7CiAgdmFyIGluaXRfRmVhdHVyZURldGVjdGlvbiA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRmVhdHVyZURldGVjdGlvbi5qcyIoKSB7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9GdWxsc2NyZWVuKCk7CiAgICAgIGlmICh0eXBlb2YgbmF2aWdhdG9yICE9PSAidW5kZWZpbmVkIikgewogICAgICAgIHRoZU5hdmlnYXRvciA9IG5hdmlnYXRvcjsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGVOYXZpZ2F0b3IgPSB7fTsKICAgICAgfQogICAgICBzdXBwb3J0c1dlYlAuX3Byb21pc2UgPSB2b2lkIDA7CiAgICAgIHN1cHBvcnRzV2ViUC5fcmVzdWx0ID0gdm9pZCAwOwogICAgICBzdXBwb3J0c1dlYlAuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoc3VwcG9ydHNXZWJQLl9wcm9taXNlKSkgewogICAgICAgICAgcmV0dXJuIHN1cHBvcnRzV2ViUC5fcHJvbWlzZTsKICAgICAgICB9CiAgICAgICAgc3VwcG9ydHNXZWJQLl9wcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgIGNvbnN0IGltYWdlID0gbmV3IEltYWdlKCk7CiAgICAgICAgICBpbWFnZS5vbmxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc3VwcG9ydHNXZWJQLl9yZXN1bHQgPSBpbWFnZS53aWR0aCA+IDAgJiYgaW1hZ2UuaGVpZ2h0ID4gMDsKICAgICAgICAgICAgcmVzb2x2ZShzdXBwb3J0c1dlYlAuX3Jlc3VsdCk7CiAgICAgICAgICB9OwogICAgICAgICAgaW1hZ2Uub25lcnJvciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzdXBwb3J0c1dlYlAuX3Jlc3VsdCA9IGZhbHNlOwogICAgICAgICAgICByZXNvbHZlKHN1cHBvcnRzV2ViUC5fcmVzdWx0KTsKICAgICAgICAgIH07CiAgICAgICAgICBpbWFnZS5zcmMgPSAiZGF0YTppbWFnZS93ZWJwO2Jhc2U2NCxVa2xHUmlJQUFBQlhSVUpRVmxBNElCWUFBQUF3QVFDZEFTb0JBQUVBRHNEK0phUUFBM0FBQUFBQSI7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHN1cHBvcnRzV2ViUC5fcHJvbWlzZTsKICAgICAgfTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoc3VwcG9ydHNXZWJQLCB7CiAgICAgICAgaW5pdGlhbGl6ZWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBkZWZpbmVkX2RlZmF1bHQoc3VwcG9ydHNXZWJQLl9yZXN1bHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHR5cGVkQXJyYXlUeXBlcyA9IFtdOwogICAgICBpZiAodHlwZW9mIEFycmF5QnVmZmVyICE9PSAidW5kZWZpbmVkIikgewogICAgICAgIHR5cGVkQXJyYXlUeXBlcy5wdXNoKAogICAgICAgICAgSW50OEFycmF5LAogICAgICAgICAgVWludDhBcnJheSwKICAgICAgICAgIEludDE2QXJyYXksCiAgICAgICAgICBVaW50MTZBcnJheSwKICAgICAgICAgIEludDMyQXJyYXksCiAgICAgICAgICBVaW50MzJBcnJheSwKICAgICAgICAgIEZsb2F0MzJBcnJheSwKICAgICAgICAgIEZsb2F0NjRBcnJheQogICAgICAgICk7CiAgICAgICAgaWYgKHR5cGVvZiBVaW50OENsYW1wZWRBcnJheSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIHR5cGVkQXJyYXlUeXBlcy5wdXNoKFVpbnQ4Q2xhbXBlZEFycmF5KTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBVaW50OENsYW1wZWRBcnJheSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIHR5cGVkQXJyYXlUeXBlcy5wdXNoKFVpbnQ4Q2xhbXBlZEFycmF5KTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBCaWdJbnQ2NEFycmF5ICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgdHlwZWRBcnJheVR5cGVzLnB1c2goQmlnSW50NjRBcnJheSk7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgQmlnVWludDY0QXJyYXkgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICB0eXBlZEFycmF5VHlwZXMucHVzaChCaWdVaW50NjRBcnJheSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIEZlYXR1cmVEZXRlY3Rpb24gPSB7CiAgICAgICAgaXNDaHJvbWUsCiAgICAgICAgY2hyb21lVmVyc2lvbiwKICAgICAgICBpc1NhZmFyaSwKICAgICAgICBzYWZhcmlWZXJzaW9uLAogICAgICAgIGlzV2Via2l0LAogICAgICAgIHdlYmtpdFZlcnNpb24sCiAgICAgICAgaXNJbnRlcm5ldEV4cGxvcmVyLAogICAgICAgIGludGVybmV0RXhwbG9yZXJWZXJzaW9uLAogICAgICAgIGlzRWRnZSwKICAgICAgICBlZGdlVmVyc2lvbiwKICAgICAgICBpc0ZpcmVmb3gsCiAgICAgICAgZmlyZWZveFZlcnNpb24sCiAgICAgICAgaXNXaW5kb3dzLAogICAgICAgIGlzSVBhZE9ySU9TLAogICAgICAgIGhhcmR3YXJlQ29uY3VycmVuY3k6IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHRoZU5hdmlnYXRvci5oYXJkd2FyZUNvbmN1cnJlbmN5LCAzKSwKICAgICAgICBzdXBwb3J0c1BvaW50ZXJFdmVudHMsCiAgICAgICAgc3VwcG9ydHNJbWFnZVJlbmRlcmluZ1BpeGVsYXRlZCwKICAgICAgICBzdXBwb3J0c1dlYlAsCiAgICAgICAgaW1hZ2VSZW5kZXJpbmdWYWx1ZSwKICAgICAgICB0eXBlZEFycmF5VHlwZXMKICAgICAgfTsKICAgICAgRmVhdHVyZURldGVjdGlvbi5zdXBwb3J0c0Jhc2lzID0gZnVuY3Rpb24oc2NlbmUpIHsKICAgICAgICByZXR1cm4gRmVhdHVyZURldGVjdGlvbi5zdXBwb3J0c1dlYkFzc2VtYmx5KCkgJiYgc2NlbmUuY29udGV4dC5zdXBwb3J0c0Jhc2lzOwogICAgICB9OwogICAgICBGZWF0dXJlRGV0ZWN0aW9uLnN1cHBvcnRzRnVsbHNjcmVlbiA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBGdWxsc2NyZWVuX2RlZmF1bHQuc3VwcG9ydHNGdWxsc2NyZWVuKCk7CiAgICAgIH07CiAgICAgIEZlYXR1cmVEZXRlY3Rpb24uc3VwcG9ydHNUeXBlZEFycmF5cyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICJ1bmRlZmluZWQiOwogICAgICB9OwogICAgICBGZWF0dXJlRGV0ZWN0aW9uLnN1cHBvcnRzQmlnSW50NjRBcnJheSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0eXBlb2YgQmlnSW50NjRBcnJheSAhPT0gInVuZGVmaW5lZCI7CiAgICAgIH07CiAgICAgIEZlYXR1cmVEZXRlY3Rpb24uc3VwcG9ydHNCaWdVaW50NjRBcnJheSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0eXBlb2YgQmlnVWludDY0QXJyYXkgIT09ICJ1bmRlZmluZWQiOwogICAgICB9OwogICAgICBGZWF0dXJlRGV0ZWN0aW9uLnN1cHBvcnRzQmlnSW50ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBCaWdJbnQgIT09ICJ1bmRlZmluZWQiOwogICAgICB9OwogICAgICBGZWF0dXJlRGV0ZWN0aW9uLnN1cHBvcnRzV2ViV29ya2VycyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0eXBlb2YgV29ya2VyICE9PSAidW5kZWZpbmVkIjsKICAgICAgfTsKICAgICAgRmVhdHVyZURldGVjdGlvbi5zdXBwb3J0c1dlYkFzc2VtYmx5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBXZWJBc3NlbWJseSAhPT0gInVuZGVmaW5lZCI7CiAgICAgIH07CiAgICAgIEZlYXR1cmVEZXRlY3Rpb24uc3VwcG9ydHNXZWJnbDIgPSBmdW5jdGlvbihzY2VuZSkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgic2NlbmUiLCBzY2VuZSk7CiAgICAgICAgcmV0dXJuIHNjZW5lLmNvbnRleHQud2ViZ2wyOwogICAgICB9OwogICAgICBGZWF0dXJlRGV0ZWN0aW9uLnN1cHBvcnRzRXNtV2ViV29ya2VycyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiAhaXNGaXJlZm94KCkgfHwgcGFyc2VJbnQoZmlyZWZveFZlcnNpb25SZXN1bHQpID49IDExNDsKICAgICAgfTsKICAgICAgRmVhdHVyZURldGVjdGlvbl9kZWZhdWx0ID0gRmVhdHVyZURldGVjdGlvbjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1F1YXRlcm5pb24uanMKICBmdW5jdGlvbiBRdWF0ZXJuaW9uKHgsIHksIHosIHcpIHsKICAgIHRoaXMueCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHgsIDApOwogICAgdGhpcy55ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeSwgMCk7CiAgICB0aGlzLnogPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh6LCAwKTsKICAgIHRoaXMudyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHcsIDApOwogIH0KICB2YXIgZnJvbUF4aXNBbmdsZVNjcmF0Y2gsIGZyb21Sb3RhdGlvbk1hdHJpeE5leHQsIGZyb21Sb3RhdGlvbk1hdHJpeFF1YXQsIHNjcmF0Y2hIUFJRdWF0ZXJuaW9uLCBzY3JhdGNoSGVhZGluZ1F1YXRlcm5pb24sIHNjcmF0Y2hQaXRjaFF1YXRlcm5pb24sIHNjcmF0Y2hSb2xsUXVhdGVybmlvbiwgc2FtcGxlZFF1YXRlcm5pb25BeGlzLCBzYW1wbGVkUXVhdGVybmlvblJvdGF0aW9uLCBzYW1wbGVkUXVhdGVybmlvblRlbXBRdWF0ZXJuaW9uLCBzYW1wbGVkUXVhdGVybmlvblF1YXRlcm5pb24wLCBzYW1wbGVkUXVhdGVybmlvblF1YXRlcm5pb24wQ29uanVnYXRlLCBsZXJwU2NyYXRjaDQsIHNsZXJwRW5kTmVnYXRlZCwgc2xlcnBTY2FsZWRQLCBzbGVycFNjYWxlZFIsIHNxdWFkU2NyYXRjaENhcnRlc2lhbjAsIHNxdWFkU2NyYXRjaENhcnRlc2lhbjEsIHNxdWFkU2NyYXRjaFF1YXRlcm5pb24wLCBzcXVhZFNjcmF0Y2hRdWF0ZXJuaW9uMSwgZmFzdFNsZXJwU2NyYXRjaFF1YXRlcm5pb24sIG9wbXUsIHUsIHYsIGJULCBiRCwgUXVhdGVybmlvbl9kZWZhdWx0OwogIHZhciBpbml0X1F1YXRlcm5pb24gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1F1YXRlcm5pb24uanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9GZWF0dXJlRGV0ZWN0aW9uKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgZnJvbUF4aXNBbmdsZVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFF1YXRlcm5pb24uZnJvbUF4aXNBbmdsZSA9IGZ1bmN0aW9uKGF4aXMsIGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImF4aXMiLCBheGlzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImFuZ2xlIiwgYW5nbGUpOwogICAgICAgIGNvbnN0IGhhbGZBbmdsZSA9IGFuZ2xlIC8gMjsKICAgICAgICBjb25zdCBzID0gTWF0aC5zaW4oaGFsZkFuZ2xlKTsKICAgICAgICBmcm9tQXhpc0FuZ2xlU2NyYXRjaCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoYXhpcywgZnJvbUF4aXNBbmdsZVNjcmF0Y2gpOwogICAgICAgIGNvbnN0IHggPSBmcm9tQXhpc0FuZ2xlU2NyYXRjaC54ICogczsKICAgICAgICBjb25zdCB5ID0gZnJvbUF4aXNBbmdsZVNjcmF0Y2gueSAqIHM7CiAgICAgICAgY29uc3QgeiA9IGZyb21BeGlzQW5nbGVTY3JhdGNoLnogKiBzOwogICAgICAgIGNvbnN0IHcgPSBNYXRoLmNvcyhoYWxmQW5nbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUXVhdGVybmlvbih4LCB5LCB6LCB3KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmVzdWx0LncgPSB3OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGZyb21Sb3RhdGlvbk1hdHJpeE5leHQgPSBbMSwgMiwgMF07CiAgICAgIGZyb21Sb3RhdGlvbk1hdHJpeFF1YXQgPSBuZXcgQXJyYXkoMyk7CiAgICAgIFF1YXRlcm5pb24uZnJvbVJvdGF0aW9uTWF0cml4ID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgbGV0IHJvb3Q7CiAgICAgICAgbGV0IHg7CiAgICAgICAgbGV0IHk7CiAgICAgICAgbGV0IHo7CiAgICAgICAgbGV0IHc7CiAgICAgICAgY29uc3QgbTAwID0gbWF0cml4W01hdHJpeDNfZGVmYXVsdC5DT0xVTU4wUk9XMF07CiAgICAgICAgY29uc3QgbTExID0gbWF0cml4W01hdHJpeDNfZGVmYXVsdC5DT0xVTU4xUk9XMV07CiAgICAgICAgY29uc3QgbTIyID0gbWF0cml4W01hdHJpeDNfZGVmYXVsdC5DT0xVTU4yUk9XMl07CiAgICAgICAgY29uc3QgdHJhY2UgPSBtMDAgKyBtMTEgKyBtMjI7CiAgICAgICAgaWYgKHRyYWNlID4gMCkgewogICAgICAgICAgcm9vdCA9IE1hdGguc3FydCh0cmFjZSArIDEpOwogICAgICAgICAgdyA9IDAuNSAqIHJvb3Q7CiAgICAgICAgICByb290ID0gMC41IC8gcm9vdDsKICAgICAgICAgIHggPSAobWF0cml4W01hdHJpeDNfZGVmYXVsdC5DT0xVTU4xUk9XMl0gLSBtYXRyaXhbTWF0cml4M19kZWZhdWx0LkNPTFVNTjJST1cxXSkgKiByb290OwogICAgICAgICAgeSA9IChtYXRyaXhbTWF0cml4M19kZWZhdWx0LkNPTFVNTjJST1cwXSAtIG1hdHJpeFtNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMFJPVzJdKSAqIHJvb3Q7CiAgICAgICAgICB6ID0gKG1hdHJpeFtNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMFJPVzFdIC0gbWF0cml4W01hdHJpeDNfZGVmYXVsdC5DT0xVTU4xUk9XMF0pICogcm9vdDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3QgbmV4dCA9IGZyb21Sb3RhdGlvbk1hdHJpeE5leHQ7CiAgICAgICAgICBsZXQgaSA9IDA7CiAgICAgICAgICBpZiAobTExID4gbTAwKSB7CiAgICAgICAgICAgIGkgPSAxOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG0yMiA+IG0wMCAmJiBtMjIgPiBtMTEpIHsKICAgICAgICAgICAgaSA9IDI7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBqID0gbmV4dFtpXTsKICAgICAgICAgIGNvbnN0IGsgPSBuZXh0W2pdOwogICAgICAgICAgcm9vdCA9IE1hdGguc3FydCgKICAgICAgICAgICAgbWF0cml4W01hdHJpeDNfZGVmYXVsdC5nZXRFbGVtZW50SW5kZXgoaSwgaSldIC0gbWF0cml4W01hdHJpeDNfZGVmYXVsdC5nZXRFbGVtZW50SW5kZXgoaiwgaildIC0gbWF0cml4W01hdHJpeDNfZGVmYXVsdC5nZXRFbGVtZW50SW5kZXgoaywgayldICsgMQogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHF1YXQgPSBmcm9tUm90YXRpb25NYXRyaXhRdWF0OwogICAgICAgICAgcXVhdFtpXSA9IDAuNSAqIHJvb3Q7CiAgICAgICAgICByb290ID0gMC41IC8gcm9vdDsKICAgICAgICAgIHcgPSAobWF0cml4W01hdHJpeDNfZGVmYXVsdC5nZXRFbGVtZW50SW5kZXgoaywgaildIC0gbWF0cml4W01hdHJpeDNfZGVmYXVsdC5nZXRFbGVtZW50SW5kZXgoaiwgayldKSAqIHJvb3Q7CiAgICAgICAgICBxdWF0W2pdID0gKG1hdHJpeFtNYXRyaXgzX2RlZmF1bHQuZ2V0RWxlbWVudEluZGV4KGosIGkpXSArIG1hdHJpeFtNYXRyaXgzX2RlZmF1bHQuZ2V0RWxlbWVudEluZGV4KGksIGopXSkgKiByb290OwogICAgICAgICAgcXVhdFtrXSA9IChtYXRyaXhbTWF0cml4M19kZWZhdWx0LmdldEVsZW1lbnRJbmRleChrLCBpKV0gKyBtYXRyaXhbTWF0cml4M19kZWZhdWx0LmdldEVsZW1lbnRJbmRleChpLCBrKV0pICogcm9vdDsKICAgICAgICAgIHggPSAtcXVhdFswXTsKICAgICAgICAgIHkgPSAtcXVhdFsxXTsKICAgICAgICAgIHogPSAtcXVhdFsyXTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBRdWF0ZXJuaW9uKHgsIHksIHosIHcpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXN1bHQudyA9IHc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaEhQUlF1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbigpOwogICAgICBzY3JhdGNoSGVhZGluZ1F1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbigpOwogICAgICBzY3JhdGNoUGl0Y2hRdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgc2NyYXRjaFJvbGxRdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgUXVhdGVybmlvbi5mcm9tSGVhZGluZ1BpdGNoUm9sbCA9IGZ1bmN0aW9uKGhlYWRpbmdQaXRjaFJvbGwsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiaGVhZGluZ1BpdGNoUm9sbCIsIGhlYWRpbmdQaXRjaFJvbGwpOwogICAgICAgIHNjcmF0Y2hSb2xsUXVhdGVybmlvbiA9IFF1YXRlcm5pb24uZnJvbUF4aXNBbmdsZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1gsCiAgICAgICAgICBoZWFkaW5nUGl0Y2hSb2xsLnJvbGwsCiAgICAgICAgICBzY3JhdGNoSFBSUXVhdGVybmlvbgogICAgICAgICk7CiAgICAgICAgc2NyYXRjaFBpdGNoUXVhdGVybmlvbiA9IFF1YXRlcm5pb24uZnJvbUF4aXNBbmdsZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1ksCiAgICAgICAgICAtaGVhZGluZ1BpdGNoUm9sbC5waXRjaCwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgICAgcmVzdWx0ID0gUXVhdGVybmlvbi5tdWx0aXBseSgKICAgICAgICAgIHNjcmF0Y2hQaXRjaFF1YXRlcm5pb24sCiAgICAgICAgICBzY3JhdGNoUm9sbFF1YXRlcm5pb24sCiAgICAgICAgICBzY3JhdGNoUGl0Y2hRdWF0ZXJuaW9uCiAgICAgICAgKTsKICAgICAgICBzY3JhdGNoSGVhZGluZ1F1YXRlcm5pb24gPSBRdWF0ZXJuaW9uLmZyb21BeGlzQW5nbGUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9aLAogICAgICAgICAgLWhlYWRpbmdQaXRjaFJvbGwuaGVhZGluZywKICAgICAgICAgIHNjcmF0Y2hIUFJRdWF0ZXJuaW9uCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gUXVhdGVybmlvbi5tdWx0aXBseShzY3JhdGNoSGVhZGluZ1F1YXRlcm5pb24sIHJlc3VsdCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgc2FtcGxlZFF1YXRlcm5pb25BeGlzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzYW1wbGVkUXVhdGVybmlvblJvdGF0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzYW1wbGVkUXVhdGVybmlvblRlbXBRdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgc2FtcGxlZFF1YXRlcm5pb25RdWF0ZXJuaW9uMCA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uUXVhdGVybmlvbjBDb25qdWdhdGUgPSBuZXcgUXVhdGVybmlvbigpOwogICAgICBRdWF0ZXJuaW9uLnBhY2tlZExlbmd0aCA9IDQ7CiAgICAgIFF1YXRlcm5pb24ucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLng7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLnk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLno7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS53OwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICByZXN1bHQueSA9IGFycmF5W3N0YXJ0aW5nSW5kZXggKyAxXTsKICAgICAgICByZXN1bHQueiA9IGFycmF5W3N0YXJ0aW5nSW5kZXggKyAyXTsKICAgICAgICByZXN1bHQudyA9IGFycmF5W3N0YXJ0aW5nSW5kZXggKyAzXTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLnBhY2tlZEludGVycG9sYXRpb25MZW5ndGggPSAzOwogICAgICBRdWF0ZXJuaW9uLmNvbnZlcnRQYWNrZWRBcnJheUZvckludGVycG9sYXRpb24gPSBmdW5jdGlvbihwYWNrZWRBcnJheSwgc3RhcnRpbmdJbmRleCwgbGFzdEluZGV4LCByZXN1bHQpIHsKICAgICAgICBRdWF0ZXJuaW9uLnVucGFjaygKICAgICAgICAgIHBhY2tlZEFycmF5LAogICAgICAgICAgbGFzdEluZGV4ICogNCwKICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uUXVhdGVybmlvbjBDb25qdWdhdGUKICAgICAgICApOwogICAgICAgIFF1YXRlcm5pb24uY29uanVnYXRlKAogICAgICAgICAgc2FtcGxlZFF1YXRlcm5pb25RdWF0ZXJuaW9uMENvbmp1Z2F0ZSwKICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uUXVhdGVybmlvbjBDb25qdWdhdGUKICAgICAgICApOwogICAgICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBsYXN0SW5kZXggLSBzdGFydGluZ0luZGV4ICsgMTsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICBjb25zdCBvZmZzZXQgPSBpICogMzsKICAgICAgICAgIFF1YXRlcm5pb24udW5wYWNrKAogICAgICAgICAgICBwYWNrZWRBcnJheSwKICAgICAgICAgICAgKHN0YXJ0aW5nSW5kZXggKyBpKSAqIDQsCiAgICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uVGVtcFF1YXRlcm5pb24KICAgICAgICAgICk7CiAgICAgICAgICBRdWF0ZXJuaW9uLm11bHRpcGx5KAogICAgICAgICAgICBzYW1wbGVkUXVhdGVybmlvblRlbXBRdWF0ZXJuaW9uLAogICAgICAgICAgICBzYW1wbGVkUXVhdGVybmlvblF1YXRlcm5pb24wQ29uanVnYXRlLAogICAgICAgICAgICBzYW1wbGVkUXVhdGVybmlvblRlbXBRdWF0ZXJuaW9uCiAgICAgICAgICApOwogICAgICAgICAgaWYgKHNhbXBsZWRRdWF0ZXJuaW9uVGVtcFF1YXRlcm5pb24udyA8IDApIHsKICAgICAgICAgICAgUXVhdGVybmlvbi5uZWdhdGUoCiAgICAgICAgICAgICAgc2FtcGxlZFF1YXRlcm5pb25UZW1wUXVhdGVybmlvbiwKICAgICAgICAgICAgICBzYW1wbGVkUXVhdGVybmlvblRlbXBRdWF0ZXJuaW9uCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICBRdWF0ZXJuaW9uLmNvbXB1dGVBeGlzKAogICAgICAgICAgICBzYW1wbGVkUXVhdGVybmlvblRlbXBRdWF0ZXJuaW9uLAogICAgICAgICAgICBzYW1wbGVkUXVhdGVybmlvbkF4aXMKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBhbmdsZSA9IFF1YXRlcm5pb24uY29tcHV0ZUFuZ2xlKHNhbXBsZWRRdWF0ZXJuaW9uVGVtcFF1YXRlcm5pb24pOwogICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgICByZXN1bHQgPSBbXTsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdFtvZmZzZXRdID0gc2FtcGxlZFF1YXRlcm5pb25BeGlzLnggKiBhbmdsZTsKICAgICAgICAgIHJlc3VsdFtvZmZzZXQgKyAxXSA9IHNhbXBsZWRRdWF0ZXJuaW9uQXhpcy55ICogYW5nbGU7CiAgICAgICAgICByZXN1bHRbb2Zmc2V0ICsgMl0gPSBzYW1wbGVkUXVhdGVybmlvbkF4aXMueiAqIGFuZ2xlOwogICAgICAgIH0KICAgICAgfTsKICAgICAgUXVhdGVybmlvbi51bnBhY2tJbnRlcnBvbGF0aW9uUmVzdWx0ID0gZnVuY3Rpb24oYXJyYXksIHNvdXJjZUFycmF5LCBmaXJzdEluZGV4LCBsYXN0SW5kZXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoYXJyYXksIDAsIHNhbXBsZWRRdWF0ZXJuaW9uUm90YXRpb24pOwogICAgICAgIGNvbnN0IG1hZ25pdHVkZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoc2FtcGxlZFF1YXRlcm5pb25Sb3RhdGlvbik7CiAgICAgICAgUXVhdGVybmlvbi51bnBhY2soc291cmNlQXJyYXksIGxhc3RJbmRleCAqIDQsIHNhbXBsZWRRdWF0ZXJuaW9uUXVhdGVybmlvbjApOwogICAgICAgIGlmIChtYWduaXR1ZGUgPT09IDApIHsKICAgICAgICAgIFF1YXRlcm5pb24uY2xvbmUoUXVhdGVybmlvbi5JREVOVElUWSwgc2FtcGxlZFF1YXRlcm5pb25UZW1wUXVhdGVybmlvbik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIFF1YXRlcm5pb24uZnJvbUF4aXNBbmdsZSgKICAgICAgICAgICAgc2FtcGxlZFF1YXRlcm5pb25Sb3RhdGlvbiwKICAgICAgICAgICAgbWFnbml0dWRlLAogICAgICAgICAgICBzYW1wbGVkUXVhdGVybmlvblRlbXBRdWF0ZXJuaW9uCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gUXVhdGVybmlvbi5tdWx0aXBseSgKICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uVGVtcFF1YXRlcm5pb24sCiAgICAgICAgICBzYW1wbGVkUXVhdGVybmlvblF1YXRlcm5pb24wLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5jbG9uZSA9IGZ1bmN0aW9uKHF1YXRlcm5pb24sIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHF1YXRlcm5pb24pKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFF1YXRlcm5pb24oCiAgICAgICAgICAgIHF1YXRlcm5pb24ueCwKICAgICAgICAgICAgcXVhdGVybmlvbi55LAogICAgICAgICAgICBxdWF0ZXJuaW9uLnosCiAgICAgICAgICAgIHF1YXRlcm5pb24udwogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBxdWF0ZXJuaW9uLng7CiAgICAgICAgcmVzdWx0LnkgPSBxdWF0ZXJuaW9uLnk7CiAgICAgICAgcmVzdWx0LnogPSBxdWF0ZXJuaW9uLno7CiAgICAgICAgcmVzdWx0LncgPSBxdWF0ZXJuaW9uLnc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5jb25qdWdhdGUgPSBmdW5jdGlvbihxdWF0ZXJuaW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInF1YXRlcm5pb24iLCBxdWF0ZXJuaW9uKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSAtcXVhdGVybmlvbi54OwogICAgICAgIHJlc3VsdC55ID0gLXF1YXRlcm5pb24ueTsKICAgICAgICByZXN1bHQueiA9IC1xdWF0ZXJuaW9uLno7CiAgICAgICAgcmVzdWx0LncgPSBxdWF0ZXJuaW9uLnc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5tYWduaXR1ZGVTcXVhcmVkID0gZnVuY3Rpb24ocXVhdGVybmlvbikgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicXVhdGVybmlvbiIsIHF1YXRlcm5pb24pOwogICAgICAgIHJldHVybiBxdWF0ZXJuaW9uLnggKiBxdWF0ZXJuaW9uLnggKyBxdWF0ZXJuaW9uLnkgKiBxdWF0ZXJuaW9uLnkgKyBxdWF0ZXJuaW9uLnogKiBxdWF0ZXJuaW9uLnogKyBxdWF0ZXJuaW9uLncgKiBxdWF0ZXJuaW9uLnc7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24ubWFnbml0dWRlID0gZnVuY3Rpb24ocXVhdGVybmlvbikgewogICAgICAgIHJldHVybiBNYXRoLnNxcnQoUXVhdGVybmlvbi5tYWduaXR1ZGVTcXVhcmVkKHF1YXRlcm5pb24pKTsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5ub3JtYWxpemUgPSBmdW5jdGlvbihxdWF0ZXJuaW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgaW52ZXJzZU1hZ25pdHVkZSA9IDEgLyBRdWF0ZXJuaW9uLm1hZ25pdHVkZShxdWF0ZXJuaW9uKTsKICAgICAgICBjb25zdCB4ID0gcXVhdGVybmlvbi54ICogaW52ZXJzZU1hZ25pdHVkZTsKICAgICAgICBjb25zdCB5ID0gcXVhdGVybmlvbi55ICogaW52ZXJzZU1hZ25pdHVkZTsKICAgICAgICBjb25zdCB6ID0gcXVhdGVybmlvbi56ICogaW52ZXJzZU1hZ25pdHVkZTsKICAgICAgICBjb25zdCB3ID0gcXVhdGVybmlvbi53ICogaW52ZXJzZU1hZ25pdHVkZTsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXN1bHQudyA9IHc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5pbnZlcnNlID0gZnVuY3Rpb24ocXVhdGVybmlvbiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IG1hZ25pdHVkZVNxdWFyZWQgPSBRdWF0ZXJuaW9uLm1hZ25pdHVkZVNxdWFyZWQocXVhdGVybmlvbik7CiAgICAgICAgcmVzdWx0ID0gUXVhdGVybmlvbi5jb25qdWdhdGUocXVhdGVybmlvbiwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gUXVhdGVybmlvbi5tdWx0aXBseUJ5U2NhbGFyKHJlc3VsdCwgMSAvIG1hZ25pdHVkZVNxdWFyZWQsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24uYWRkID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbGVmdC54ICsgcmlnaHQueDsKICAgICAgICByZXN1bHQueSA9IGxlZnQueSArIHJpZ2h0Lnk7CiAgICAgICAgcmVzdWx0LnogPSBsZWZ0LnogKyByaWdodC56OwogICAgICAgIHJlc3VsdC53ID0gbGVmdC53ICsgcmlnaHQudzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLnN1YnRyYWN0ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbGVmdC54IC0gcmlnaHQueDsKICAgICAgICByZXN1bHQueSA9IGxlZnQueSAtIHJpZ2h0Lnk7CiAgICAgICAgcmVzdWx0LnogPSBsZWZ0LnogLSByaWdodC56OwogICAgICAgIHJlc3VsdC53ID0gbGVmdC53IC0gcmlnaHQudzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLm5lZ2F0ZSA9IGZ1bmN0aW9uKHF1YXRlcm5pb24sIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicXVhdGVybmlvbiIsIHF1YXRlcm5pb24pOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IC1xdWF0ZXJuaW9uLng7CiAgICAgICAgcmVzdWx0LnkgPSAtcXVhdGVybmlvbi55OwogICAgICAgIHJlc3VsdC56ID0gLXF1YXRlcm5pb24uejsKICAgICAgICByZXN1bHQudyA9IC1xdWF0ZXJuaW9uLnc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5kb3QgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgcmV0dXJuIGxlZnQueCAqIHJpZ2h0LnggKyBsZWZ0LnkgKiByaWdodC55ICsgbGVmdC56ICogcmlnaHQueiArIGxlZnQudyAqIHJpZ2h0Lnc7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24ubXVsdGlwbHkgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgbGVmdFggPSBsZWZ0Lng7CiAgICAgICAgY29uc3QgbGVmdFkgPSBsZWZ0Lnk7CiAgICAgICAgY29uc3QgbGVmdFogPSBsZWZ0Lno7CiAgICAgICAgY29uc3QgbGVmdFcgPSBsZWZ0Lnc7CiAgICAgICAgY29uc3QgcmlnaHRYID0gcmlnaHQueDsKICAgICAgICBjb25zdCByaWdodFkgPSByaWdodC55OwogICAgICAgIGNvbnN0IHJpZ2h0WiA9IHJpZ2h0Lno7CiAgICAgICAgY29uc3QgcmlnaHRXID0gcmlnaHQudzsKICAgICAgICBjb25zdCB4ID0gbGVmdFcgKiByaWdodFggKyBsZWZ0WCAqIHJpZ2h0VyArIGxlZnRZICogcmlnaHRaIC0gbGVmdFogKiByaWdodFk7CiAgICAgICAgY29uc3QgeSA9IGxlZnRXICogcmlnaHRZIC0gbGVmdFggKiByaWdodFogKyBsZWZ0WSAqIHJpZ2h0VyArIGxlZnRaICogcmlnaHRYOwogICAgICAgIGNvbnN0IHogPSBsZWZ0VyAqIHJpZ2h0WiArIGxlZnRYICogcmlnaHRZIC0gbGVmdFkgKiByaWdodFggKyBsZWZ0WiAqIHJpZ2h0VzsKICAgICAgICBjb25zdCB3ID0gbGVmdFcgKiByaWdodFcgLSBsZWZ0WCAqIHJpZ2h0WCAtIGxlZnRZICogcmlnaHRZIC0gbGVmdFogKiByaWdodFo7CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmVzdWx0LncgPSB3OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24ubXVsdGlwbHlCeVNjYWxhciA9IGZ1bmN0aW9uKHF1YXRlcm5pb24sIHNjYWxhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJxdWF0ZXJuaW9uIiwgcXVhdGVybmlvbik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsYXIiLCBzY2FsYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IHF1YXRlcm5pb24ueCAqIHNjYWxhcjsKICAgICAgICByZXN1bHQueSA9IHF1YXRlcm5pb24ueSAqIHNjYWxhcjsKICAgICAgICByZXN1bHQueiA9IHF1YXRlcm5pb24ueiAqIHNjYWxhcjsKICAgICAgICByZXN1bHQudyA9IHF1YXRlcm5pb24udyAqIHNjYWxhcjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLmRpdmlkZUJ5U2NhbGFyID0gZnVuY3Rpb24ocXVhdGVybmlvbiwgc2NhbGFyLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInF1YXRlcm5pb24iLCBxdWF0ZXJuaW9uKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxhciIsIHNjYWxhcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gcXVhdGVybmlvbi54IC8gc2NhbGFyOwogICAgICAgIHJlc3VsdC55ID0gcXVhdGVybmlvbi55IC8gc2NhbGFyOwogICAgICAgIHJlc3VsdC56ID0gcXVhdGVybmlvbi56IC8gc2NhbGFyOwogICAgICAgIHJlc3VsdC53ID0gcXVhdGVybmlvbi53IC8gc2NhbGFyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24uY29tcHV0ZUF4aXMgPSBmdW5jdGlvbihxdWF0ZXJuaW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInF1YXRlcm5pb24iLCBxdWF0ZXJuaW9uKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgdyA9IHF1YXRlcm5pb24udzsKICAgICAgICBpZiAoTWF0aC5hYnModyAtIDEpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT042IHx8IE1hdGguYWJzKHcgKyAxKSA8IE1hdGhfZGVmYXVsdC5FUFNJTE9ONikgewogICAgICAgICAgcmVzdWx0LnggPSAxOwogICAgICAgICAgcmVzdWx0LnkgPSByZXN1bHQueiA9IDA7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBjb25zdCBzY2FsYXIgPSAxIC8gTWF0aC5zcXJ0KDEgLSB3ICogdyk7CiAgICAgICAgcmVzdWx0LnggPSBxdWF0ZXJuaW9uLnggKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0LnkgPSBxdWF0ZXJuaW9uLnkgKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0LnogPSBxdWF0ZXJuaW9uLnogKiBzY2FsYXI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5jb21wdXRlQW5nbGUgPSBmdW5jdGlvbihxdWF0ZXJuaW9uKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJxdWF0ZXJuaW9uIiwgcXVhdGVybmlvbik7CiAgICAgICAgaWYgKE1hdGguYWJzKHF1YXRlcm5pb24udyAtIDEpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT042KSB7CiAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDIgKiBNYXRoLmFjb3MocXVhdGVybmlvbi53KTsKICAgICAgfTsKICAgICAgbGVycFNjcmF0Y2g0ID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgUXVhdGVybmlvbi5sZXJwID0gZnVuY3Rpb24oc3RhcnQsIGVuZCwgdCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzdGFydCIsIHN0YXJ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImVuZCIsIGVuZCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ0IiwgdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGxlcnBTY3JhdGNoNCA9IFF1YXRlcm5pb24ubXVsdGlwbHlCeVNjYWxhcihlbmQsIHQsIGxlcnBTY3JhdGNoNCk7CiAgICAgICAgcmVzdWx0ID0gUXVhdGVybmlvbi5tdWx0aXBseUJ5U2NhbGFyKHN0YXJ0LCAxIC0gdCwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gUXVhdGVybmlvbi5hZGQobGVycFNjcmF0Y2g0LCByZXN1bHQsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHNsZXJwRW5kTmVnYXRlZCA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIHNsZXJwU2NhbGVkUCA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIHNsZXJwU2NhbGVkUiA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIFF1YXRlcm5pb24uc2xlcnAgPSBmdW5jdGlvbihzdGFydCwgZW5kLCB0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInN0YXJ0Iiwgc3RhcnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZW5kIiwgZW5kKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInQiLCB0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgbGV0IGRvdCA9IFF1YXRlcm5pb24uZG90KHN0YXJ0LCBlbmQpOwogICAgICAgIGxldCByID0gZW5kOwogICAgICAgIGlmIChkb3QgPCAwKSB7CiAgICAgICAgICBkb3QgPSAtZG90OwogICAgICAgICAgciA9IHNsZXJwRW5kTmVnYXRlZCA9IFF1YXRlcm5pb24ubmVnYXRlKGVuZCwgc2xlcnBFbmROZWdhdGVkKTsKICAgICAgICB9CiAgICAgICAgaWYgKDEgLSBkb3QgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjYpIHsKICAgICAgICAgIHJldHVybiBRdWF0ZXJuaW9uLmxlcnAoc3RhcnQsIHIsIHQsIHJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHRoZXRhID0gTWF0aC5hY29zKGRvdCk7CiAgICAgICAgc2xlcnBTY2FsZWRQID0gUXVhdGVybmlvbi5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgc3RhcnQsCiAgICAgICAgICBNYXRoLnNpbigoMSAtIHQpICogdGhldGEpLAogICAgICAgICAgc2xlcnBTY2FsZWRQCiAgICAgICAgKTsKICAgICAgICBzbGVycFNjYWxlZFIgPSBRdWF0ZXJuaW9uLm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICByLAogICAgICAgICAgTWF0aC5zaW4odCAqIHRoZXRhKSwKICAgICAgICAgIHNsZXJwU2NhbGVkUgogICAgICAgICk7CiAgICAgICAgcmVzdWx0ID0gUXVhdGVybmlvbi5hZGQoc2xlcnBTY2FsZWRQLCBzbGVycFNjYWxlZFIsIHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIFF1YXRlcm5pb24ubXVsdGlwbHlCeVNjYWxhcihyZXN1bHQsIDEgLyBNYXRoLnNpbih0aGV0YSksIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24ubG9nID0gZnVuY3Rpb24ocXVhdGVybmlvbiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJxdWF0ZXJuaW9uIiwgcXVhdGVybmlvbik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHRoZXRhID0gTWF0aF9kZWZhdWx0LmFjb3NDbGFtcGVkKHF1YXRlcm5pb24udyk7CiAgICAgICAgbGV0IHRoZXRhT3ZlclNpblRoZXRhID0gMDsKICAgICAgICBpZiAodGhldGEgIT09IDApIHsKICAgICAgICAgIHRoZXRhT3ZlclNpblRoZXRhID0gdGhldGEgLyBNYXRoLnNpbih0aGV0YSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihxdWF0ZXJuaW9uLCB0aGV0YU92ZXJTaW5UaGV0YSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5leHAgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHRoZXRhID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZShjYXJ0ZXNpYW4xMSk7CiAgICAgICAgbGV0IHNpblRoZXRhT3ZlclRoZXRhID0gMDsKICAgICAgICBpZiAodGhldGEgIT09IDApIHsKICAgICAgICAgIHNpblRoZXRhT3ZlclRoZXRhID0gTWF0aC5zaW4odGhldGEpIC8gdGhldGE7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0gY2FydGVzaWFuMTEueCAqIHNpblRoZXRhT3ZlclRoZXRhOwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueSAqIHNpblRoZXRhT3ZlclRoZXRhOwogICAgICAgIHJlc3VsdC56ID0gY2FydGVzaWFuMTEueiAqIHNpblRoZXRhT3ZlclRoZXRhOwogICAgICAgIHJlc3VsdC53ID0gTWF0aC5jb3ModGhldGEpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNxdWFkU2NyYXRjaENhcnRlc2lhbjAgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNxdWFkU2NyYXRjaENhcnRlc2lhbjEgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNxdWFkU2NyYXRjaFF1YXRlcm5pb24wID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgc3F1YWRTY3JhdGNoUXVhdGVybmlvbjEgPSBuZXcgUXVhdGVybmlvbigpOwogICAgICBRdWF0ZXJuaW9uLmNvbXB1dGVJbm5lclF1YWRyYW5nbGUgPSBmdW5jdGlvbihxMCwgcTEyLCBxMjIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicTAiLCBxMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJxMSIsIHExMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJxMiIsIHEyMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHFJbnYgPSBRdWF0ZXJuaW9uLmNvbmp1Z2F0ZShxMTIsIHNxdWFkU2NyYXRjaFF1YXRlcm5pb24wKTsKICAgICAgICBRdWF0ZXJuaW9uLm11bHRpcGx5KHFJbnYsIHEyMiwgc3F1YWRTY3JhdGNoUXVhdGVybmlvbjEpOwogICAgICAgIGNvbnN0IGNhcnQwID0gUXVhdGVybmlvbi5sb2coc3F1YWRTY3JhdGNoUXVhdGVybmlvbjEsIHNxdWFkU2NyYXRjaENhcnRlc2lhbjApOwogICAgICAgIFF1YXRlcm5pb24ubXVsdGlwbHkocUludiwgcTAsIHNxdWFkU2NyYXRjaFF1YXRlcm5pb24xKTsKICAgICAgICBjb25zdCBjYXJ0MSA9IFF1YXRlcm5pb24ubG9nKHNxdWFkU2NyYXRjaFF1YXRlcm5pb24xLCBzcXVhZFNjcmF0Y2hDYXJ0ZXNpYW4xKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNhcnQwLCBjYXJ0MSwgY2FydDApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGNhcnQwLCAwLjI1LCBjYXJ0MCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShjYXJ0MCwgY2FydDApOwogICAgICAgIFF1YXRlcm5pb24uZXhwKGNhcnQwLCBzcXVhZFNjcmF0Y2hRdWF0ZXJuaW9uMCk7CiAgICAgICAgcmV0dXJuIFF1YXRlcm5pb24ubXVsdGlwbHkocTEyLCBzcXVhZFNjcmF0Y2hRdWF0ZXJuaW9uMCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5zcXVhZCA9IGZ1bmN0aW9uKHEwLCBxMTIsIHMwLCBzMSwgdCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJxMCIsIHEwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInExIiwgcTEyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInMwIiwgczApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiczEiLCBzMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ0IiwgdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHNsZXJwMCA9IFF1YXRlcm5pb24uc2xlcnAocTAsIHExMiwgdCwgc3F1YWRTY3JhdGNoUXVhdGVybmlvbjApOwogICAgICAgIGNvbnN0IHNsZXJwMSA9IFF1YXRlcm5pb24uc2xlcnAoczAsIHMxLCB0LCBzcXVhZFNjcmF0Y2hRdWF0ZXJuaW9uMSk7CiAgICAgICAgcmV0dXJuIFF1YXRlcm5pb24uc2xlcnAoc2xlcnAwLCBzbGVycDEsIDIgKiB0ICogKDEgLSB0KSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgZmFzdFNsZXJwU2NyYXRjaFF1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbigpOwogICAgICBvcG11ID0gMS45MDExMDc0NTM1MTczMDAzOwogICAgICB1ID0gRmVhdHVyZURldGVjdGlvbl9kZWZhdWx0LnN1cHBvcnRzVHlwZWRBcnJheXMoKSA/IG5ldyBGbG9hdDMyQXJyYXkoOCkgOiBbXTsKICAgICAgdiA9IEZlYXR1cmVEZXRlY3Rpb25fZGVmYXVsdC5zdXBwb3J0c1R5cGVkQXJyYXlzKCkgPyBuZXcgRmxvYXQzMkFycmF5KDgpIDogW107CiAgICAgIGJUID0gRmVhdHVyZURldGVjdGlvbl9kZWZhdWx0LnN1cHBvcnRzVHlwZWRBcnJheXMoKSA/IG5ldyBGbG9hdDMyQXJyYXkoOCkgOiBbXTsKICAgICAgYkQgPSBGZWF0dXJlRGV0ZWN0aW9uX2RlZmF1bHQuc3VwcG9ydHNUeXBlZEFycmF5cygpID8gbmV3IEZsb2F0MzJBcnJheSg4KSA6IFtdOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDc7ICsraSkgewogICAgICAgIGNvbnN0IHMgPSBpICsgMTsKICAgICAgICBjb25zdCB0ID0gMiAqIHMgKyAxOwogICAgICAgIHVbaV0gPSAxIC8gKHMgKiB0KTsKICAgICAgICB2W2ldID0gcyAvIHQ7CiAgICAgIH0KICAgICAgdVs3XSA9IG9wbXUgLyAoOCAqIDE3KTsKICAgICAgdls3XSA9IG9wbXUgKiA4IC8gMTc7CiAgICAgIFF1YXRlcm5pb24uZmFzdFNsZXJwID0gZnVuY3Rpb24oc3RhcnQsIGVuZCwgdCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzdGFydCIsIHN0YXJ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImVuZCIsIGVuZCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ0IiwgdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGxldCB4ID0gUXVhdGVybmlvbi5kb3Qoc3RhcnQsIGVuZCk7CiAgICAgICAgbGV0IHNpZ24yOwogICAgICAgIGlmICh4ID49IDApIHsKICAgICAgICAgIHNpZ24yID0gMTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2lnbjIgPSAtMTsKICAgICAgICAgIHggPSAteDsKICAgICAgICB9CiAgICAgICAgY29uc3QgeG0xID0geCAtIDE7CiAgICAgICAgY29uc3QgZCA9IDEgLSB0OwogICAgICAgIGNvbnN0IHNxclQgPSB0ICogdDsKICAgICAgICBjb25zdCBzcXJEID0gZCAqIGQ7CiAgICAgICAgZm9yIChsZXQgaSA9IDc7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgICBiVFtpXSA9ICh1W2ldICogc3FyVCAtIHZbaV0pICogeG0xOwogICAgICAgICAgYkRbaV0gPSAodVtpXSAqIHNxckQgLSB2W2ldKSAqIHhtMTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY1QgPSBzaWduMiAqIHQgKiAoMSArIGJUWzBdICogKDEgKyBiVFsxXSAqICgxICsgYlRbMl0gKiAoMSArIGJUWzNdICogKDEgKyBiVFs0XSAqICgxICsgYlRbNV0gKiAoMSArIGJUWzZdICogKDEgKyBiVFs3XSkpKSkpKSkpOwogICAgICAgIGNvbnN0IGNEID0gZCAqICgxICsgYkRbMF0gKiAoMSArIGJEWzFdICogKDEgKyBiRFsyXSAqICgxICsgYkRbM10gKiAoMSArIGJEWzRdICogKDEgKyBiRFs1XSAqICgxICsgYkRbNl0gKiAoMSArIGJEWzddKSkpKSkpKSk7CiAgICAgICAgY29uc3QgdGVtcCA9IFF1YXRlcm5pb24ubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgIHN0YXJ0LAogICAgICAgICAgY0QsCiAgICAgICAgICBmYXN0U2xlcnBTY3JhdGNoUXVhdGVybmlvbgogICAgICAgICk7CiAgICAgICAgUXVhdGVybmlvbi5tdWx0aXBseUJ5U2NhbGFyKGVuZCwgY1QsIHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIFF1YXRlcm5pb24uYWRkKHRlbXAsIHJlc3VsdCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5mYXN0U3F1YWQgPSBmdW5jdGlvbihxMCwgcTEyLCBzMCwgczEsIHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicTAiLCBxMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJxMSIsIHExMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzMCIsIHMwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInMxIiwgczEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigidCIsIHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBzbGVycDAgPSBRdWF0ZXJuaW9uLmZhc3RTbGVycChxMCwgcTEyLCB0LCBzcXVhZFNjcmF0Y2hRdWF0ZXJuaW9uMCk7CiAgICAgICAgY29uc3Qgc2xlcnAxID0gUXVhdGVybmlvbi5mYXN0U2xlcnAoczAsIHMxLCB0LCBzcXVhZFNjcmF0Y2hRdWF0ZXJuaW9uMSk7CiAgICAgICAgcmV0dXJuIFF1YXRlcm5pb24uZmFzdFNsZXJwKHNsZXJwMCwgc2xlcnAxLCAyICogdCAqICgxIC0gdCksIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24uZXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgbGVmdC54ID09PSByaWdodC54ICYmIGxlZnQueSA9PT0gcmlnaHQueSAmJiBsZWZ0LnogPT09IHJpZ2h0LnogJiYgbGVmdC53ID09PSByaWdodC53OwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgZXBzaWxvbikgewogICAgICAgIGVwc2lsb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlcHNpbG9uLCAwKTsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgTWF0aC5hYnMobGVmdC54IC0gcmlnaHQueCkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0LnkgLSByaWdodC55KSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnQueiAtIHJpZ2h0LnopIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdC53IC0gcmlnaHQudykgPD0gZXBzaWxvbjsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5aRVJPID0gT2JqZWN0LmZyZWV6ZShuZXcgUXVhdGVybmlvbigwLCAwLCAwLCAwKSk7CiAgICAgIFF1YXRlcm5pb24uSURFTlRJVFkgPSBPYmplY3QuZnJlZXplKG5ldyBRdWF0ZXJuaW9uKDAsIDAsIDAsIDEpKTsKICAgICAgUXVhdGVybmlvbi5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICByZXR1cm4gUXVhdGVybmlvbi5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiBRdWF0ZXJuaW9uLmVxdWFscyh0aGlzLCByaWdodCk7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24ucHJvdG90eXBlLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihyaWdodCwgZXBzaWxvbikgewogICAgICAgIHJldHVybiBRdWF0ZXJuaW9uLmVxdWFsc0Vwc2lsb24odGhpcywgcmlnaHQsIGVwc2lsb24pOwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBgKCR7dGhpcy54fSwgJHt0aGlzLnl9LCAke3RoaXMuen0sICR7dGhpcy53fSlgOwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uX2RlZmF1bHQgPSBRdWF0ZXJuaW9uOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvYmluYXJ5U2VhcmNoLmpzCiAgZnVuY3Rpb24gYmluYXJ5U2VhcmNoKGFycmF5LCBpdGVtVG9GaW5kLCBjb21wYXJhdG9yKSB7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJpdGVtVG9GaW5kIiwgaXRlbVRvRmluZCk7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNvbXBhcmF0b3IiLCBjb21wYXJhdG9yKTsKICAgIGxldCBsb3cgPSAwOwogICAgbGV0IGhpZ2ggPSBhcnJheS5sZW5ndGggLSAxOwogICAgbGV0IGk7CiAgICBsZXQgY29tcGFyaXNvbjsKICAgIHdoaWxlIChsb3cgPD0gaGlnaCkgewogICAgICBpID0gfn4oKGxvdyArIGhpZ2gpIC8gMik7CiAgICAgIGNvbXBhcmlzb24gPSBjb21wYXJhdG9yKGFycmF5W2ldLCBpdGVtVG9GaW5kKTsKICAgICAgaWYgKGNvbXBhcmlzb24gPCAwKSB7CiAgICAgICAgbG93ID0gaSArIDE7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKGNvbXBhcmlzb24gPiAwKSB7CiAgICAgICAgaGlnaCA9IGkgLSAxOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIHJldHVybiBpOwogICAgfQogICAgcmV0dXJuIH4oaGlnaCArIDEpOwogIH0KICB2YXIgYmluYXJ5U2VhcmNoX2RlZmF1bHQ7CiAgdmFyIGluaXRfYmluYXJ5U2VhcmNoID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9iaW5hcnlTZWFyY2guanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGJpbmFyeVNlYXJjaF9kZWZhdWx0ID0gYmluYXJ5U2VhcmNoOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnNTYW1wbGUuanMKICBmdW5jdGlvbiBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVyc1NhbXBsZSh4UG9sZVdhbmRlciwgeVBvbGVXYW5kZXIsIHhQb2xlT2Zmc2V0LCB5UG9sZU9mZnNldCwgdXQxTWludXNVdGMpIHsKICAgIHRoaXMueFBvbGVXYW5kZXIgPSB4UG9sZVdhbmRlcjsKICAgIHRoaXMueVBvbGVXYW5kZXIgPSB5UG9sZVdhbmRlcjsKICAgIHRoaXMueFBvbGVPZmZzZXQgPSB4UG9sZU9mZnNldDsKICAgIHRoaXMueVBvbGVPZmZzZXQgPSB5UG9sZU9mZnNldDsKICAgIHRoaXMudXQxTWludXNVdGMgPSB1dDFNaW51c1V0YzsKICB9CiAgdmFyIEVhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzU2FtcGxlX2RlZmF1bHQ7CiAgdmFyIGluaXRfRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnNTYW1wbGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzU2FtcGxlLmpzIigpIHsKICAgICAgRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnNTYW1wbGVfZGVmYXVsdCA9IEVhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzU2FtcGxlOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvaXNMZWFwWWVhci5qcwogIGZ1bmN0aW9uIGlzTGVhcFllYXIoeWVhcikgewogICAgaWYgKHllYXIgPT09IG51bGwgfHwgaXNOYU4oeWVhcikpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInllYXIgaXMgcmVxdWlyZWQgYW5kIG11c3QgYmUgYSBudW1iZXIuIik7CiAgICB9CiAgICByZXR1cm4geWVhciAlIDQgPT09IDAgJiYgeWVhciAlIDEwMCAhPT0gMCB8fCB5ZWFyICUgNDAwID09PSAwOwogIH0KICB2YXIgaXNMZWFwWWVhcl9kZWZhdWx0OwogIHZhciBpbml0X2lzTGVhcFllYXIgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2lzTGVhcFllYXIuanMiKCkgewogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGlzTGVhcFllYXJfZGVmYXVsdCA9IGlzTGVhcFllYXI7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9HcmVnb3JpYW5EYXRlLmpzCiAgZnVuY3Rpb24gR3JlZ29yaWFuRGF0ZSh5ZWFyLCBtb250aCwgZGF5LCBob3VyLCBtaW51dGUsIHNlY29uZCwgbWlsbGlzZWNvbmQsIGlzTGVhcFNlY29uZCkgewogICAgY29uc3QgbWluaW11bVllYXIgPSAxOwogICAgY29uc3QgbWluaW11bU1vbnRoID0gMTsKICAgIGNvbnN0IG1pbmltdW1EYXkgPSAxOwogICAgY29uc3QgbWluaW11bUhvdXIgPSAwOwogICAgY29uc3QgbWluaW11bU1pbnV0ZSA9IDA7CiAgICBjb25zdCBtaW5pbXVtU2Vjb25kID0gMDsKICAgIGNvbnN0IG1pbmltdW1NaWxsaXNlY29uZCA9IDA7CiAgICB5ZWFyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeWVhciwgbWluaW11bVllYXIpOwogICAgbW9udGggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChtb250aCwgbWluaW11bU1vbnRoKTsKICAgIGRheSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGRheSwgbWluaW11bURheSk7CiAgICBob3VyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoaG91ciwgbWluaW11bUhvdXIpOwogICAgbWludXRlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQobWludXRlLCBtaW5pbXVtTWludXRlKTsKICAgIHNlY29uZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHNlY29uZCwgbWluaW11bVNlY29uZCk7CiAgICBtaWxsaXNlY29uZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG1pbGxpc2Vjb25kLCBtaW5pbXVtTWlsbGlzZWNvbmQpOwogICAgaXNMZWFwU2Vjb25kID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoaXNMZWFwU2Vjb25kLCBmYWxzZSk7CiAgICB2YWxpZGF0ZVJhbmdlKCk7CiAgICB2YWxpZGF0ZURhdGUoKTsKICAgIHRoaXMueWVhciA9IHllYXI7CiAgICB0aGlzLm1vbnRoID0gbW9udGg7CiAgICB0aGlzLmRheSA9IGRheTsKICAgIHRoaXMuaG91ciA9IGhvdXI7CiAgICB0aGlzLm1pbnV0ZSA9IG1pbnV0ZTsKICAgIHRoaXMuc2Vjb25kID0gc2Vjb25kOwogICAgdGhpcy5taWxsaXNlY29uZCA9IG1pbGxpc2Vjb25kOwogICAgdGhpcy5pc0xlYXBTZWNvbmQgPSBpc0xlYXBTZWNvbmQ7CiAgICBmdW5jdGlvbiB2YWxpZGF0ZVJhbmdlKCkgewogICAgICBjb25zdCBtYXhpbXVtWWVhciA9IDk5OTk7CiAgICAgIGNvbnN0IG1heGltdW1Nb250aCA9IDEyOwogICAgICBjb25zdCBtYXhpbXVtRGF5ID0gMzE7CiAgICAgIGNvbnN0IG1heGltdW1Ib3VyID0gMjM7CiAgICAgIGNvbnN0IG1heGltdW1NaW51dGUgPSA1OTsKICAgICAgY29uc3QgbWF4aW11bVNlY29uZCA9IDU5OwogICAgICBjb25zdCBleGNsdWRlZE1heGltdW1NaWxpc2Vjb25kID0gMWUzOwogICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiWWVhciIsIHllYXIsIG1pbmltdW1ZZWFyKTsKICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoIlllYXIiLCB5ZWFyLCBtYXhpbXVtWWVhcik7CiAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJNb250aCIsIG1vbnRoLCBtaW5pbXVtTW9udGgpOwogICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiTW9udGgiLCBtb250aCwgbWF4aW11bU1vbnRoKTsKICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoIkRheSIsIGRheSwgbWluaW11bURheSk7CiAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJEYXkiLCBkYXksIG1heGltdW1EYXkpOwogICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiSG91ciIsIGhvdXIsIG1pbmltdW1Ib3VyKTsKICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoIkhvdXIiLCBob3VyLCBtYXhpbXVtSG91cik7CiAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJNaW51dGUiLCBtaW51dGUsIG1pbmltdW1NaW51dGUpOwogICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiTWludXRlIiwgbWludXRlLCBtYXhpbXVtTWludXRlKTsKICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YuYm9vbCgiSXNMZWFwU2Vjb25kIiwgaXNMZWFwU2Vjb25kKTsKICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoIlNlY29uZCIsIHNlY29uZCwgbWluaW11bVNlY29uZCk7CiAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKAogICAgICAgICJTZWNvbmQiLAogICAgICAgIHNlY29uZCwKICAgICAgICBpc0xlYXBTZWNvbmQgPyBtYXhpbXVtU2Vjb25kICsgMSA6IG1heGltdW1TZWNvbmQKICAgICAgKTsKICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoCiAgICAgICAgIk1pbGxpc2Vjb25kIiwKICAgICAgICBtaWxsaXNlY29uZCwKICAgICAgICBtaW5pbXVtTWlsbGlzZWNvbmQKICAgICAgKTsKICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuKAogICAgICAgICJNaWxsaXNlY29uZCIsCiAgICAgICAgbWlsbGlzZWNvbmQsCiAgICAgICAgZXhjbHVkZWRNYXhpbXVtTWlsaXNlY29uZAogICAgICApOwogICAgfQogICAgZnVuY3Rpb24gdmFsaWRhdGVEYXRlKCkgewogICAgICBjb25zdCBkYXlzSW5Nb250aDIgPSBtb250aCA9PT0gMiAmJiBpc0xlYXBZZWFyX2RlZmF1bHQoeWVhcikgPyBkYXlzSW5ZZWFyW21vbnRoIC0gMV0gKyAxIDogZGF5c0luWWVhclttb250aCAtIDFdOwogICAgICBpZiAoZGF5ID4gZGF5c0luTW9udGgyKSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIk1vbnRoIGFuZCBEYXkgcmVwcmVzZW50cyBpbnZhbGlkIGRhdGUiKTsKICAgICAgfQogICAgfQogIH0KICB2YXIgZGF5c0luWWVhciwgR3JlZ29yaWFuRGF0ZV9kZWZhdWx0OwogIHZhciBpbml0X0dyZWdvcmlhbkRhdGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dyZWdvcmlhbkRhdGUuanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9pc0xlYXBZZWFyKCk7CiAgICAgIGRheXNJblllYXIgPSBbMzEsIDI4LCAzMSwgMzAsIDMxLCAzMCwgMzEsIDMxLCAzMCwgMzEsIDMwLCAzMV07CiAgICAgIEdyZWdvcmlhbkRhdGVfZGVmYXVsdCA9IEdyZWdvcmlhbkRhdGU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9MZWFwU2Vjb25kLmpzCiAgZnVuY3Rpb24gTGVhcFNlY29uZChkYXRlLCBvZmZzZXQpIHsKICAgIHRoaXMuanVsaWFuRGF0ZSA9IGRhdGU7CiAgICB0aGlzLm9mZnNldCA9IG9mZnNldDsKICB9CiAgdmFyIExlYXBTZWNvbmRfZGVmYXVsdDsKICB2YXIgaW5pdF9MZWFwU2Vjb25kID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9MZWFwU2Vjb25kLmpzIigpIHsKICAgICAgTGVhcFNlY29uZF9kZWZhdWx0ID0gTGVhcFNlY29uZDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RpbWVDb25zdGFudHMuanMKICB2YXIgVGltZUNvbnN0YW50cywgVGltZUNvbnN0YW50c19kZWZhdWx0OwogIHZhciBpbml0X1RpbWVDb25zdGFudHMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RpbWVDb25zdGFudHMuanMiKCkgewogICAgICBUaW1lQ29uc3RhbnRzID0gewogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBudW1iZXIgb2Ygc2Vjb25kcyBpbiBvbmUgbWlsbGlzZWNvbmQ6IDxjb2RlPjAuMDAxPC9jb2RlPgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgU0VDT05EU19QRVJfTUlMTElTRUNPTkQ6IDFlLTMsCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG51bWJlciBvZiBzZWNvbmRzIGluIG9uZSBtaW51dGU6IDxjb2RlPjYwPC9jb2RlPi4KICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFNFQ09ORFNfUEVSX01JTlVURTogNjAsCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG51bWJlciBvZiBtaW51dGVzIGluIG9uZSBob3VyOiA8Y29kZT42MDwvY29kZT4uCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBNSU5VVEVTX1BFUl9IT1VSOiA2MCwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgbnVtYmVyIG9mIGhvdXJzIGluIG9uZSBkYXk6IDxjb2RlPjI0PC9jb2RlPi4KICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIEhPVVJTX1BFUl9EQVk6IDI0LAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBudW1iZXIgb2Ygc2Vjb25kcyBpbiBvbmUgaG91cjogPGNvZGU+MzYwMDwvY29kZT4uCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBTRUNPTkRTX1BFUl9IT1VSOiAzNjAwLAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBudW1iZXIgb2YgbWludXRlcyBpbiBvbmUgZGF5OiA8Y29kZT4xNDQwPC9jb2RlPi4KICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIE1JTlVURVNfUEVSX0RBWTogMTQ0MCwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgbnVtYmVyIG9mIHNlY29uZHMgaW4gb25lIGRheSwgaWdub3JpbmcgbGVhcCBzZWNvbmRzOiA8Y29kZT44NjQwMDwvY29kZT4uCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBTRUNPTkRTX1BFUl9EQVk6IDg2NDAwLAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBudW1iZXIgb2YgZGF5cyBpbiBvbmUgSnVsaWFuIGNlbnR1cnk6IDxjb2RlPjM2NTI1PC9jb2RlPi4KICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIERBWVNfUEVSX0pVTElBTl9DRU5UVVJZOiAzNjUyNSwKICAgICAgICAvKioKICAgICAgICAgKiBPbmUgdHJpbGxpb250aCBvZiBhIHNlY29uZC4KICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFBJQ09TRUNPTkQ6IDFlLTksCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG51bWJlciBvZiBkYXlzIHRvIHN1YnRyYWN0IGZyb20gYSBKdWxpYW4gZGF0ZSB0byBkZXRlcm1pbmUgdGhlCiAgICAgICAgICogbW9kaWZpZWQgSnVsaWFuIGRhdGUsIHdoaWNoIGdpdmVzIHRoZSBudW1iZXIgb2YgZGF5cyBzaW5jZSBtaWRuaWdodAogICAgICAgICAqIG9uIE5vdmVtYmVyIDE3LCAxODU4LgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgTU9ESUZJRURfSlVMSUFOX0RBVEVfRElGRkVSRU5DRTogMjQwMDAwMDVlLTEKICAgICAgfTsKICAgICAgVGltZUNvbnN0YW50c19kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShUaW1lQ29uc3RhbnRzKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RpbWVTdGFuZGFyZC5qcwogIHZhciBUaW1lU3RhbmRhcmQsIFRpbWVTdGFuZGFyZF9kZWZhdWx0OwogIHZhciBpbml0X1RpbWVTdGFuZGFyZCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVGltZVN0YW5kYXJkLmpzIigpIHsKICAgICAgVGltZVN0YW5kYXJkID0gewogICAgICAgIC8qKgogICAgICAgICAqIFJlcHJlc2VudHMgdGhlIGNvb3JkaW5hdGVkIFVuaXZlcnNhbCBUaW1lIChVVEMpIHRpbWUgc3RhbmRhcmQuCiAgICAgICAgICoKICAgICAgICAgKiBVVEMgaXMgcmVsYXRlZCB0byBUQUkgYWNjb3JkaW5nIHRvIHRoZSByZWxhdGlvbnNoaXAKICAgICAgICAgKiA8Y29kZT5VVEMgPSBUQUkgLSBkZWx0YVQ8L2NvZGU+IHdoZXJlIDxjb2RlPmRlbHRhVDwvY29kZT4gaXMgdGhlIG51bWJlciBvZiBsZWFwCiAgICAgICAgICogc2Vjb25kcyB3aGljaCBoYXZlIGJlZW4gaW50cm9kdWNlZCBhcyBvZiB0aGUgdGltZSBpbiBUQUkuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFVUQzogMCwKICAgICAgICAvKioKICAgICAgICAgKiBSZXByZXNlbnRzIHRoZSBJbnRlcm5hdGlvbmFsIEF0b21pYyBUaW1lIChUQUkpIHRpbWUgc3RhbmRhcmQuCiAgICAgICAgICogVEFJIGlzIHRoZSBwcmluY2lwYWwgdGltZSBzdGFuZGFyZCB0byB3aGljaCB0aGUgb3RoZXIgdGltZSBzdGFuZGFyZHMgYXJlIHJlbGF0ZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFRBSTogMQogICAgICB9OwogICAgICBUaW1lU3RhbmRhcmRfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoVGltZVN0YW5kYXJkKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0p1bGlhbkRhdGUuanMKICBmdW5jdGlvbiBjb21wYXJlTGVhcFNlY29uZERhdGVzKGxlYXBTZWNvbmQsIGRhdGVUb0ZpbmQpIHsKICAgIHJldHVybiBKdWxpYW5EYXRlLmNvbXBhcmUobGVhcFNlY29uZC5qdWxpYW5EYXRlLCBkYXRlVG9GaW5kLmp1bGlhbkRhdGUpOwogIH0KICBmdW5jdGlvbiBjb252ZXJ0VXRjVG9UYWkoanVsaWFuRGF0ZSkgewogICAgYmluYXJ5U2VhcmNoU2NyYXRjaExlYXBTZWNvbmQuanVsaWFuRGF0ZSA9IGp1bGlhbkRhdGU7CiAgICBjb25zdCBsZWFwU2Vjb25kcyA9IEp1bGlhbkRhdGUubGVhcFNlY29uZHM7CiAgICBsZXQgaW5kZXggPSBiaW5hcnlTZWFyY2hfZGVmYXVsdCgKICAgICAgbGVhcFNlY29uZHMsCiAgICAgIGJpbmFyeVNlYXJjaFNjcmF0Y2hMZWFwU2Vjb25kLAogICAgICBjb21wYXJlTGVhcFNlY29uZERhdGVzCiAgICApOwogICAgaWYgKGluZGV4IDwgMCkgewogICAgICBpbmRleCA9IH5pbmRleDsKICAgIH0KICAgIGlmIChpbmRleCA+PSBsZWFwU2Vjb25kcy5sZW5ndGgpIHsKICAgICAgaW5kZXggPSBsZWFwU2Vjb25kcy5sZW5ndGggLSAxOwogICAgfQogICAgbGV0IG9mZnNldCA9IGxlYXBTZWNvbmRzW2luZGV4XS5vZmZzZXQ7CiAgICBpZiAoaW5kZXggPiAwKSB7CiAgICAgIGNvbnN0IGRpZmZlcmVuY2UgPSBKdWxpYW5EYXRlLnNlY29uZHNEaWZmZXJlbmNlKAogICAgICAgIGxlYXBTZWNvbmRzW2luZGV4XS5qdWxpYW5EYXRlLAogICAgICAgIGp1bGlhbkRhdGUKICAgICAgKTsKICAgICAgaWYgKGRpZmZlcmVuY2UgPiBvZmZzZXQpIHsKICAgICAgICBpbmRleC0tOwogICAgICAgIG9mZnNldCA9IGxlYXBTZWNvbmRzW2luZGV4XS5vZmZzZXQ7CiAgICAgIH0KICAgIH0KICAgIEp1bGlhbkRhdGUuYWRkU2Vjb25kcyhqdWxpYW5EYXRlLCBvZmZzZXQsIGp1bGlhbkRhdGUpOwogIH0KICBmdW5jdGlvbiBjb252ZXJ0VGFpVG9VdGMoanVsaWFuRGF0ZSwgcmVzdWx0KSB7CiAgICBiaW5hcnlTZWFyY2hTY3JhdGNoTGVhcFNlY29uZC5qdWxpYW5EYXRlID0ganVsaWFuRGF0ZTsKICAgIGNvbnN0IGxlYXBTZWNvbmRzID0gSnVsaWFuRGF0ZS5sZWFwU2Vjb25kczsKICAgIGxldCBpbmRleCA9IGJpbmFyeVNlYXJjaF9kZWZhdWx0KAogICAgICBsZWFwU2Vjb25kcywKICAgICAgYmluYXJ5U2VhcmNoU2NyYXRjaExlYXBTZWNvbmQsCiAgICAgIGNvbXBhcmVMZWFwU2Vjb25kRGF0ZXMKICAgICk7CiAgICBpZiAoaW5kZXggPCAwKSB7CiAgICAgIGluZGV4ID0gfmluZGV4OwogICAgfQogICAgaWYgKGluZGV4ID09PSAwKSB7CiAgICAgIHJldHVybiBKdWxpYW5EYXRlLmFkZFNlY29uZHMoanVsaWFuRGF0ZSwgLWxlYXBTZWNvbmRzWzBdLm9mZnNldCwgcmVzdWx0KTsKICAgIH0KICAgIGlmIChpbmRleCA+PSBsZWFwU2Vjb25kcy5sZW5ndGgpIHsKICAgICAgcmV0dXJuIEp1bGlhbkRhdGUuYWRkU2Vjb25kcygKICAgICAgICBqdWxpYW5EYXRlLAogICAgICAgIC1sZWFwU2Vjb25kc1tpbmRleCAtIDFdLm9mZnNldCwKICAgICAgICByZXN1bHQKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGRpZmZlcmVuY2UgPSBKdWxpYW5EYXRlLnNlY29uZHNEaWZmZXJlbmNlKAogICAgICBsZWFwU2Vjb25kc1tpbmRleF0uanVsaWFuRGF0ZSwKICAgICAganVsaWFuRGF0ZQogICAgKTsKICAgIGlmIChkaWZmZXJlbmNlID09PSAwKSB7CiAgICAgIHJldHVybiBKdWxpYW5EYXRlLmFkZFNlY29uZHMoCiAgICAgICAganVsaWFuRGF0ZSwKICAgICAgICAtbGVhcFNlY29uZHNbaW5kZXhdLm9mZnNldCwKICAgICAgICByZXN1bHQKICAgICAgKTsKICAgIH0KICAgIGlmIChkaWZmZXJlbmNlIDw9IDEpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHJldHVybiBKdWxpYW5EYXRlLmFkZFNlY29uZHMoCiAgICAgIGp1bGlhbkRhdGUsCiAgICAgIC1sZWFwU2Vjb25kc1stLWluZGV4XS5vZmZzZXQsCiAgICAgIHJlc3VsdAogICAgKTsKICB9CiAgZnVuY3Rpb24gc2V0Q29tcG9uZW50cyh3aG9sZURheXMsIHNlY29uZHNPZkRheSwganVsaWFuRGF0ZSkgewogICAgY29uc3QgZXh0cmFEYXlzID0gc2Vjb25kc09mRGF5IC8gVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0RBWSB8IDA7CiAgICB3aG9sZURheXMgKz0gZXh0cmFEYXlzOwogICAgc2Vjb25kc09mRGF5IC09IFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9EQVkgKiBleHRyYURheXM7CiAgICBpZiAoc2Vjb25kc09mRGF5IDwgMCkgewogICAgICB3aG9sZURheXMtLTsKICAgICAgc2Vjb25kc09mRGF5ICs9IFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9EQVk7CiAgICB9CiAgICBqdWxpYW5EYXRlLmRheU51bWJlciA9IHdob2xlRGF5czsKICAgIGp1bGlhbkRhdGUuc2Vjb25kc09mRGF5ID0gc2Vjb25kc09mRGF5OwogICAgcmV0dXJuIGp1bGlhbkRhdGU7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVKdWxpYW5EYXRlQ29tcG9uZW50cyh5ZWFyLCBtb250aCwgZGF5LCBob3VyLCBtaW51dGUsIHNlY29uZCwgbWlsbGlzZWNvbmQpIHsKICAgIGNvbnN0IGEzID0gKG1vbnRoIC0gMTQpIC8gMTIgfCAwOwogICAgY29uc3QgYiA9IHllYXIgKyA0ODAwICsgYTM7CiAgICBsZXQgZGF5TnVtYmVyID0gKDE0NjEgKiBiIC8gNCB8IDApICsgKDM2NyAqIChtb250aCAtIDIgLSAxMiAqIGEzKSAvIDEyIHwgMCkgLSAoMyAqICgoYiArIDEwMCkgLyAxMDAgfCAwKSAvIDQgfCAwKSArIGRheSAtIDMyMDc1OwogICAgaG91ciA9IGhvdXIgLSAxMjsKICAgIGlmIChob3VyIDwgMCkgewogICAgICBob3VyICs9IDI0OwogICAgfQogICAgY29uc3Qgc2Vjb25kc09mRGF5ID0gc2Vjb25kICsgKGhvdXIgKiBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuU0VDT05EU19QRVJfSE9VUiArIG1pbnV0ZSAqIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9NSU5VVEUgKyBtaWxsaXNlY29uZCAqIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9NSUxMSVNFQ09ORCk7CiAgICBpZiAoc2Vjb25kc09mRGF5ID49IDQzMjAwKSB7CiAgICAgIGRheU51bWJlciAtPSAxOwogICAgfQogICAgcmV0dXJuIFtkYXlOdW1iZXIsIHNlY29uZHNPZkRheV07CiAgfQogIGZ1bmN0aW9uIEp1bGlhbkRhdGUoanVsaWFuRGF5TnVtYmVyLCBzZWNvbmRzT2ZEYXksIHRpbWVTdGFuZGFyZCkgewogICAgdGhpcy5kYXlOdW1iZXIgPSB2b2lkIDA7CiAgICB0aGlzLnNlY29uZHNPZkRheSA9IHZvaWQgMDsKICAgIGp1bGlhbkRheU51bWJlciA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGp1bGlhbkRheU51bWJlciwgMCk7CiAgICBzZWNvbmRzT2ZEYXkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzZWNvbmRzT2ZEYXksIDApOwogICAgdGltZVN0YW5kYXJkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodGltZVN0YW5kYXJkLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5VVEMpOwogICAgY29uc3Qgd2hvbGVEYXlzID0ganVsaWFuRGF5TnVtYmVyIHwgMDsKICAgIHNlY29uZHNPZkRheSA9IHNlY29uZHNPZkRheSArIChqdWxpYW5EYXlOdW1iZXIgLSB3aG9sZURheXMpICogVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0RBWTsKICAgIHNldENvbXBvbmVudHMod2hvbGVEYXlzLCBzZWNvbmRzT2ZEYXksIHRoaXMpOwogICAgaWYgKHRpbWVTdGFuZGFyZCA9PT0gVGltZVN0YW5kYXJkX2RlZmF1bHQuVVRDKSB7CiAgICAgIGNvbnZlcnRVdGNUb1RhaSh0aGlzKTsKICAgIH0KICB9CiAgdmFyIGdyZWdvcmlhbkRhdGVTY3JhdGNoLCBkYXlzSW5Nb250aCwgZGF5c0luTGVhcEZlYnVyYXJ5LCBiaW5hcnlTZWFyY2hTY3JhdGNoTGVhcFNlY29uZCwgbWF0Y2hDYWxlbmRhclllYXIsIG1hdGNoQ2FsZW5kYXJNb250aCwgbWF0Y2hPcmRpbmFsRGF0ZSwgbWF0Y2hXZWVrRGF0ZSwgbWF0Y2hDYWxlbmRhckRhdGUsIHV0Y09mZnNldCwgbWF0Y2hIb3VycywgbWF0Y2hIb3Vyc01pbnV0ZXMsIG1hdGNoSG91cnNNaW51dGVzU2Vjb25kcywgaXNvODYwMUVycm9yTWVzc2FnZSwgdG9HcmVnb3JpYW5EYXRlU2NyYXRjaCwgSnVsaWFuRGF0ZV9kZWZhdWx0OwogIHZhciBpbml0X0p1bGlhbkRhdGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0p1bGlhbkRhdGUuanMiKCkgewogICAgICBpbml0X2JpbmFyeVNlYXJjaCgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0dyZWdvcmlhbkRhdGUoKTsKICAgICAgaW5pdF9pc0xlYXBZZWFyKCk7CiAgICAgIGluaXRfTGVhcFNlY29uZCgpOwogICAgICBpbml0X1RpbWVDb25zdGFudHMoKTsKICAgICAgaW5pdF9UaW1lU3RhbmRhcmQoKTsKICAgICAgZ3JlZ29yaWFuRGF0ZVNjcmF0Y2ggPSBuZXcgR3JlZ29yaWFuRGF0ZV9kZWZhdWx0KCk7CiAgICAgIGRheXNJbk1vbnRoID0gWzMxLCAyOCwgMzEsIDMwLCAzMSwgMzAsIDMxLCAzMSwgMzAsIDMxLCAzMCwgMzFdOwogICAgICBkYXlzSW5MZWFwRmVidXJhcnkgPSAyOTsKICAgICAgYmluYXJ5U2VhcmNoU2NyYXRjaExlYXBTZWNvbmQgPSBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KCk7CiAgICAgIG1hdGNoQ2FsZW5kYXJZZWFyID0gL14oXGR7NH0pJC87CiAgICAgIG1hdGNoQ2FsZW5kYXJNb250aCA9IC9eKFxkezR9KS0oXGR7Mn0pJC87CiAgICAgIG1hdGNoT3JkaW5hbERhdGUgPSAvXihcZHs0fSktPyhcZHszfSkkLzsKICAgICAgbWF0Y2hXZWVrRGF0ZSA9IC9eKFxkezR9KS0/VyhcZHsyfSktPyhcZHsxfSk/JC87CiAgICAgIG1hdGNoQ2FsZW5kYXJEYXRlID0gL14oXGR7NH0pLT8oXGR7Mn0pLT8oXGR7Mn0pJC87CiAgICAgIHV0Y09mZnNldCA9IC8oW1orXC1dKT8oXGR7Mn0pPzo/KFxkezJ9KT8kLzsKICAgICAgbWF0Y2hIb3VycyA9IC9eKFxkezJ9KShcLlxkKyk/Ly5zb3VyY2UgKyB1dGNPZmZzZXQuc291cmNlOwogICAgICBtYXRjaEhvdXJzTWludXRlcyA9IC9eKFxkezJ9KTo/KFxkezJ9KShcLlxkKyk/Ly5zb3VyY2UgKyB1dGNPZmZzZXQuc291cmNlOwogICAgICBtYXRjaEhvdXJzTWludXRlc1NlY29uZHMgPSAvXihcZHsyfSk6PyhcZHsyfSk6PyhcZHsyfSkoXC5cZCspPy8uc291cmNlICsgdXRjT2Zmc2V0LnNvdXJjZTsKICAgICAgaXNvODYwMUVycm9yTWVzc2FnZSA9ICJJbnZhbGlkIElTTyA4NjAxIGRhdGUuIjsKICAgICAgSnVsaWFuRGF0ZS5mcm9tR3JlZ29yaWFuRGF0ZSA9IGZ1bmN0aW9uKGRhdGUsIHJlc3VsdCkgewogICAgICAgIGlmICghKGRhdGUgaW5zdGFuY2VvZiBHcmVnb3JpYW5EYXRlX2RlZmF1bHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZGF0ZSBtdXN0IGJlIGEgdmFsaWQgR3JlZ29yaWFuRGF0ZS4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY29tcG9uZW50cyA9IGNvbXB1dGVKdWxpYW5EYXRlQ29tcG9uZW50cygKICAgICAgICAgIGRhdGUueWVhciwKICAgICAgICAgIGRhdGUubW9udGgsCiAgICAgICAgICBkYXRlLmRheSwKICAgICAgICAgIGRhdGUuaG91ciwKICAgICAgICAgIGRhdGUubWludXRlLAogICAgICAgICAgZGF0ZS5zZWNvbmQsCiAgICAgICAgICBkYXRlLm1pbGxpc2Vjb25kCiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEp1bGlhbkRhdGUoY29tcG9uZW50c1swXSwgY29tcG9uZW50c1sxXSwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVVRDKTsKICAgICAgICB9CiAgICAgICAgc2V0Q29tcG9uZW50cyhjb21wb25lbnRzWzBdLCBjb21wb25lbnRzWzFdLCByZXN1bHQpOwogICAgICAgIGNvbnZlcnRVdGNUb1RhaShyZXN1bHQpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuZnJvbURhdGUgPSBmdW5jdGlvbihkYXRlLCByZXN1bHQpIHsKICAgICAgICBpZiAoIShkYXRlIGluc3RhbmNlb2YgRGF0ZSkgfHwgaXNOYU4oZGF0ZS5nZXRUaW1lKCkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZGF0ZSBtdXN0IGJlIGEgdmFsaWQgSmF2YVNjcmlwdCBEYXRlLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb21wb25lbnRzID0gY29tcHV0ZUp1bGlhbkRhdGVDb21wb25lbnRzKAogICAgICAgICAgZGF0ZS5nZXRVVENGdWxsWWVhcigpLAogICAgICAgICAgZGF0ZS5nZXRVVENNb250aCgpICsgMSwKICAgICAgICAgIGRhdGUuZ2V0VVRDRGF0ZSgpLAogICAgICAgICAgZGF0ZS5nZXRVVENIb3VycygpLAogICAgICAgICAgZGF0ZS5nZXRVVENNaW51dGVzKCksCiAgICAgICAgICBkYXRlLmdldFVUQ1NlY29uZHMoKSwKICAgICAgICAgIGRhdGUuZ2V0VVRDTWlsbGlzZWNvbmRzKCkKICAgICAgICApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgSnVsaWFuRGF0ZShjb21wb25lbnRzWzBdLCBjb21wb25lbnRzWzFdLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5VVEMpOwogICAgICAgIH0KICAgICAgICBzZXRDb21wb25lbnRzKGNvbXBvbmVudHNbMF0sIGNvbXBvbmVudHNbMV0sIHJlc3VsdCk7CiAgICAgICAgY29udmVydFV0Y1RvVGFpKHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5mcm9tSXNvODYwMSA9IGZ1bmN0aW9uKGlzbzg2MDFTdHJpbmcsIHJlc3VsdCkgewogICAgICAgIGlmICh0eXBlb2YgaXNvODYwMVN0cmluZyAhPT0gInN0cmluZyIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KGlzbzg2MDFFcnJvck1lc3NhZ2UpOwogICAgICAgIH0KICAgICAgICBpc284NjAxU3RyaW5nID0gaXNvODYwMVN0cmluZy5yZXBsYWNlKCIsIiwgIi4iKTsKICAgICAgICBsZXQgdG9rZW5zID0gaXNvODYwMVN0cmluZy5zcGxpdCgiVCIpOwogICAgICAgIGxldCB5ZWFyOwogICAgICAgIGxldCBtb250aCA9IDE7CiAgICAgICAgbGV0IGRheSA9IDE7CiAgICAgICAgbGV0IGhvdXIgPSAwOwogICAgICAgIGxldCBtaW51dGUgPSAwOwogICAgICAgIGxldCBzZWNvbmQgPSAwOwogICAgICAgIGxldCBtaWxsaXNlY29uZCA9IDA7CiAgICAgICAgY29uc3QgZGF0ZSA9IHRva2Vuc1swXTsKICAgICAgICBjb25zdCB0aW1lID0gdG9rZW5zWzFdOwogICAgICAgIGxldCB0bXAyOwogICAgICAgIGxldCBpbkxlYXBZZWFyOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGRhdGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdChpc284NjAxRXJyb3JNZXNzYWdlKTsKICAgICAgICB9CiAgICAgICAgbGV0IGRhc2hDb3VudDsKICAgICAgICB0b2tlbnMgPSBkYXRlLm1hdGNoKG1hdGNoQ2FsZW5kYXJEYXRlKTsKICAgICAgICBpZiAodG9rZW5zICE9PSBudWxsKSB7CiAgICAgICAgICBkYXNoQ291bnQgPSBkYXRlLnNwbGl0KCItIikubGVuZ3RoIC0gMTsKICAgICAgICAgIGlmIChkYXNoQ291bnQgPiAwICYmIGRhc2hDb3VudCAhPT0gMikgewogICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdChpc284NjAxRXJyb3JNZXNzYWdlKTsKICAgICAgICAgIH0KICAgICAgICAgIHllYXIgPSArdG9rZW5zWzFdOwogICAgICAgICAgbW9udGggPSArdG9rZW5zWzJdOwogICAgICAgICAgZGF5ID0gK3Rva2Vuc1szXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdG9rZW5zID0gZGF0ZS5tYXRjaChtYXRjaENhbGVuZGFyTW9udGgpOwogICAgICAgICAgaWYgKHRva2VucyAhPT0gbnVsbCkgewogICAgICAgICAgICB5ZWFyID0gK3Rva2Vuc1sxXTsKICAgICAgICAgICAgbW9udGggPSArdG9rZW5zWzJdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdG9rZW5zID0gZGF0ZS5tYXRjaChtYXRjaENhbGVuZGFyWWVhcik7CiAgICAgICAgICAgIGlmICh0b2tlbnMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB5ZWFyID0gK3Rva2Vuc1sxXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsZXQgZGF5T2ZZZWFyOwogICAgICAgICAgICAgIHRva2VucyA9IGRhdGUubWF0Y2gobWF0Y2hPcmRpbmFsRGF0ZSk7CiAgICAgICAgICAgICAgaWYgKHRva2VucyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgeWVhciA9ICt0b2tlbnNbMV07CiAgICAgICAgICAgICAgICBkYXlPZlllYXIgPSArdG9rZW5zWzJdOwogICAgICAgICAgICAgICAgaW5MZWFwWWVhciA9IGlzTGVhcFllYXJfZGVmYXVsdCh5ZWFyKTsKICAgICAgICAgICAgICAgIGlmIChkYXlPZlllYXIgPCAxIHx8IGluTGVhcFllYXIgJiYgZGF5T2ZZZWFyID4gMzY2IHx8ICFpbkxlYXBZZWFyICYmIGRheU9mWWVhciA+IDM2NSkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdChpc284NjAxRXJyb3JNZXNzYWdlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdG9rZW5zID0gZGF0ZS5tYXRjaChtYXRjaFdlZWtEYXRlKTsKICAgICAgICAgICAgICAgIGlmICh0b2tlbnMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgeWVhciA9ICt0b2tlbnNbMV07CiAgICAgICAgICAgICAgICAgIGNvbnN0IHdlZWtOdW1iZXIgPSArdG9rZW5zWzJdOwogICAgICAgICAgICAgICAgICBjb25zdCBkYXlPZldlZWsgPSArdG9rZW5zWzNdIHx8IDA7CiAgICAgICAgICAgICAgICAgIGRhc2hDb3VudCA9IGRhdGUuc3BsaXQoIi0iKS5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICBpZiAoZGFzaENvdW50ID4gMCAmJiAoIWRlZmluZWRfZGVmYXVsdCh0b2tlbnNbM10pICYmIGRhc2hDb3VudCAhPT0gMSB8fCBkZWZpbmVkX2RlZmF1bHQodG9rZW5zWzNdKSAmJiBkYXNoQ291bnQgIT09IDIpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoaXNvODYwMUVycm9yTWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY29uc3QgamFudWFyeTQgPSBuZXcgRGF0ZShEYXRlLlVUQyh5ZWFyLCAwLCA0KSk7CiAgICAgICAgICAgICAgICAgIGRheU9mWWVhciA9IHdlZWtOdW1iZXIgKiA3ICsgZGF5T2ZXZWVrIC0gamFudWFyeTQuZ2V0VVRDRGF5KCkgLSAzOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoaXNvODYwMUVycm9yTWVzc2FnZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRtcDIgPSBuZXcgRGF0ZShEYXRlLlVUQyh5ZWFyLCAwLCAxKSk7CiAgICAgICAgICAgICAgdG1wMi5zZXRVVENEYXRlKGRheU9mWWVhcik7CiAgICAgICAgICAgICAgbW9udGggPSB0bXAyLmdldFVUQ01vbnRoKCkgKyAxOwogICAgICAgICAgICAgIGRheSA9IHRtcDIuZ2V0VVRDRGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGluTGVhcFllYXIgPSBpc0xlYXBZZWFyX2RlZmF1bHQoeWVhcik7CiAgICAgICAgaWYgKG1vbnRoIDwgMSB8fCBtb250aCA+IDEyIHx8IGRheSA8IDEgfHwgKG1vbnRoICE9PSAyIHx8ICFpbkxlYXBZZWFyKSAmJiBkYXkgPiBkYXlzSW5Nb250aFttb250aCAtIDFdIHx8IGluTGVhcFllYXIgJiYgbW9udGggPT09IDIgJiYgZGF5ID4gZGF5c0luTGVhcEZlYnVyYXJ5KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdChpc284NjAxRXJyb3JNZXNzYWdlKTsKICAgICAgICB9CiAgICAgICAgbGV0IG9mZnNldEluZGV4OwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodGltZSkpIHsKICAgICAgICAgIHRva2VucyA9IHRpbWUubWF0Y2gobWF0Y2hIb3Vyc01pbnV0ZXNTZWNvbmRzKTsKICAgICAgICAgIGlmICh0b2tlbnMgIT09IG51bGwpIHsKICAgICAgICAgICAgZGFzaENvdW50ID0gdGltZS5zcGxpdCgiOiIpLmxlbmd0aCAtIDE7CiAgICAgICAgICAgIGlmIChkYXNoQ291bnQgPiAwICYmIGRhc2hDb3VudCAhPT0gMiAmJiBkYXNoQ291bnQgIT09IDMpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdChpc284NjAxRXJyb3JNZXNzYWdlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBob3VyID0gK3Rva2Vuc1sxXTsKICAgICAgICAgICAgbWludXRlID0gK3Rva2Vuc1syXTsKICAgICAgICAgICAgc2Vjb25kID0gK3Rva2Vuc1szXTsKICAgICAgICAgICAgbWlsbGlzZWNvbmQgPSArKHRva2Vuc1s0XSB8fCAwKSAqIDFlMzsKICAgICAgICAgICAgb2Zmc2V0SW5kZXggPSA1OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdG9rZW5zID0gdGltZS5tYXRjaChtYXRjaEhvdXJzTWludXRlcyk7CiAgICAgICAgICAgIGlmICh0b2tlbnMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBkYXNoQ291bnQgPSB0aW1lLnNwbGl0KCI6IikubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICBpZiAoZGFzaENvdW50ID4gMikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoaXNvODYwMUVycm9yTWVzc2FnZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGhvdXIgPSArdG9rZW5zWzFdOwogICAgICAgICAgICAgIG1pbnV0ZSA9ICt0b2tlbnNbMl07CiAgICAgICAgICAgICAgc2Vjb25kID0gKyh0b2tlbnNbM10gfHwgMCkgKiA2MDsKICAgICAgICAgICAgICBvZmZzZXRJbmRleCA9IDQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdG9rZW5zID0gdGltZS5tYXRjaChtYXRjaEhvdXJzKTsKICAgICAgICAgICAgICBpZiAodG9rZW5zICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBob3VyID0gK3Rva2Vuc1sxXTsKICAgICAgICAgICAgICAgIG1pbnV0ZSA9ICsodG9rZW5zWzJdIHx8IDApICogNjA7CiAgICAgICAgICAgICAgICBvZmZzZXRJbmRleCA9IDM7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KGlzbzg2MDFFcnJvck1lc3NhZ2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKG1pbnV0ZSA+PSA2MCB8fCBzZWNvbmQgPj0gNjEgfHwgaG91ciA+IDI0IHx8IGhvdXIgPT09IDI0ICYmIChtaW51dGUgPiAwIHx8IHNlY29uZCA+IDAgfHwgbWlsbGlzZWNvbmQgPiAwKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdChpc284NjAxRXJyb3JNZXNzYWdlKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IG9mZnNldCA9IHRva2Vuc1tvZmZzZXRJbmRleF07CiAgICAgICAgICBjb25zdCBvZmZzZXRIb3VycyA9ICt0b2tlbnNbb2Zmc2V0SW5kZXggKyAxXTsKICAgICAgICAgIGNvbnN0IG9mZnNldE1pbnV0ZXMgPSArKHRva2Vuc1tvZmZzZXRJbmRleCArIDJdIHx8IDApOwogICAgICAgICAgc3dpdGNoIChvZmZzZXQpIHsKICAgICAgICAgICAgY2FzZSAiKyI6CiAgICAgICAgICAgICAgaG91ciA9IGhvdXIgLSBvZmZzZXRIb3VyczsKICAgICAgICAgICAgICBtaW51dGUgPSBtaW51dGUgLSBvZmZzZXRNaW51dGVzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICItIjoKICAgICAgICAgICAgICBob3VyID0gaG91ciArIG9mZnNldEhvdXJzOwogICAgICAgICAgICAgIG1pbnV0ZSA9IG1pbnV0ZSArIG9mZnNldE1pbnV0ZXM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIloiOgogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIG1pbnV0ZSA9IG1pbnV0ZSArIG5ldyBEYXRlKAogICAgICAgICAgICAgICAgRGF0ZS5VVEMoeWVhciwgbW9udGggLSAxLCBkYXksIGhvdXIsIG1pbnV0ZSkKICAgICAgICAgICAgICApLmdldFRpbWV6b25lT2Zmc2V0KCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGlzTGVhcFNlY29uZCA9IHNlY29uZCA9PT0gNjA7CiAgICAgICAgaWYgKGlzTGVhcFNlY29uZCkgewogICAgICAgICAgc2Vjb25kLS07CiAgICAgICAgfQogICAgICAgIHdoaWxlIChtaW51dGUgPj0gNjApIHsKICAgICAgICAgIG1pbnV0ZSAtPSA2MDsKICAgICAgICAgIGhvdXIrKzsKICAgICAgICB9CiAgICAgICAgd2hpbGUgKGhvdXIgPj0gMjQpIHsKICAgICAgICAgIGhvdXIgLT0gMjQ7CiAgICAgICAgICBkYXkrKzsKICAgICAgICB9CiAgICAgICAgdG1wMiA9IGluTGVhcFllYXIgJiYgbW9udGggPT09IDIgPyBkYXlzSW5MZWFwRmVidXJhcnkgOiBkYXlzSW5Nb250aFttb250aCAtIDFdOwogICAgICAgIHdoaWxlIChkYXkgPiB0bXAyKSB7CiAgICAgICAgICBkYXkgLT0gdG1wMjsKICAgICAgICAgIG1vbnRoKys7CiAgICAgICAgICBpZiAobW9udGggPiAxMikgewogICAgICAgICAgICBtb250aCAtPSAxMjsKICAgICAgICAgICAgeWVhcisrOwogICAgICAgICAgfQogICAgICAgICAgdG1wMiA9IGluTGVhcFllYXIgJiYgbW9udGggPT09IDIgPyBkYXlzSW5MZWFwRmVidXJhcnkgOiBkYXlzSW5Nb250aFttb250aCAtIDFdOwogICAgICAgIH0KICAgICAgICB3aGlsZSAobWludXRlIDwgMCkgewogICAgICAgICAgbWludXRlICs9IDYwOwogICAgICAgICAgaG91ci0tOwogICAgICAgIH0KICAgICAgICB3aGlsZSAoaG91ciA8IDApIHsKICAgICAgICAgIGhvdXIgKz0gMjQ7CiAgICAgICAgICBkYXktLTsKICAgICAgICB9CiAgICAgICAgd2hpbGUgKGRheSA8IDEpIHsKICAgICAgICAgIG1vbnRoLS07CiAgICAgICAgICBpZiAobW9udGggPCAxKSB7CiAgICAgICAgICAgIG1vbnRoICs9IDEyOwogICAgICAgICAgICB5ZWFyLS07CiAgICAgICAgICB9CiAgICAgICAgICB0bXAyID0gaW5MZWFwWWVhciAmJiBtb250aCA9PT0gMiA/IGRheXNJbkxlYXBGZWJ1cmFyeSA6IGRheXNJbk1vbnRoW21vbnRoIC0gMV07CiAgICAgICAgICBkYXkgKz0gdG1wMjsKICAgICAgICB9CiAgICAgICAgY29uc3QgY29tcG9uZW50cyA9IGNvbXB1dGVKdWxpYW5EYXRlQ29tcG9uZW50cygKICAgICAgICAgIHllYXIsCiAgICAgICAgICBtb250aCwKICAgICAgICAgIGRheSwKICAgICAgICAgIGhvdXIsCiAgICAgICAgICBtaW51dGUsCiAgICAgICAgICBzZWNvbmQsCiAgICAgICAgICBtaWxsaXNlY29uZAogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEp1bGlhbkRhdGUoY29tcG9uZW50c1swXSwgY29tcG9uZW50c1sxXSwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVVRDKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2V0Q29tcG9uZW50cyhjb21wb25lbnRzWzBdLCBjb21wb25lbnRzWzFdLCByZXN1bHQpOwogICAgICAgICAgY29udmVydFV0Y1RvVGFpKHJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIGlmIChpc0xlYXBTZWNvbmQpIHsKICAgICAgICAgIEp1bGlhbkRhdGUuYWRkU2Vjb25kcyhyZXN1bHQsIDEsIHJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUubm93ID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIEp1bGlhbkRhdGUuZnJvbURhdGUoLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCksIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHRvR3JlZ29yaWFuRGF0ZVNjcmF0Y2ggPSBuZXcgSnVsaWFuRGF0ZSgwLCAwLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpOwogICAgICBKdWxpYW5EYXRlLnRvR3JlZ29yaWFuRGF0ZSA9IGZ1bmN0aW9uKGp1bGlhbkRhdGUsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGp1bGlhbkRhdGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgianVsaWFuRGF0ZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgbGV0IGlzTGVhcFNlY29uZCA9IGZhbHNlOwogICAgICAgIGxldCB0aGlzVXRjID0gY29udmVydFRhaVRvVXRjKGp1bGlhbkRhdGUsIHRvR3JlZ29yaWFuRGF0ZVNjcmF0Y2gpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHRoaXNVdGMpKSB7CiAgICAgICAgICBKdWxpYW5EYXRlLmFkZFNlY29uZHMoanVsaWFuRGF0ZSwgLTEsIHRvR3JlZ29yaWFuRGF0ZVNjcmF0Y2gpOwogICAgICAgICAgdGhpc1V0YyA9IGNvbnZlcnRUYWlUb1V0Yyh0b0dyZWdvcmlhbkRhdGVTY3JhdGNoLCB0b0dyZWdvcmlhbkRhdGVTY3JhdGNoKTsKICAgICAgICAgIGlzTGVhcFNlY29uZCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGxldCBqdWxpYW5EYXlOdW1iZXIgPSB0aGlzVXRjLmRheU51bWJlcjsKICAgICAgICBjb25zdCBzZWNvbmRzT2ZEYXkgPSB0aGlzVXRjLnNlY29uZHNPZkRheTsKICAgICAgICBpZiAoc2Vjb25kc09mRGF5ID49IDQzMjAwKSB7CiAgICAgICAgICBqdWxpYW5EYXlOdW1iZXIgKz0gMTsKICAgICAgICB9CiAgICAgICAgbGV0IEwgPSBqdWxpYW5EYXlOdW1iZXIgKyA2ODU2OSB8IDA7CiAgICAgICAgY29uc3QgTiA9IDQgKiBMIC8gMTQ2MDk3IHwgMDsKICAgICAgICBMID0gTCAtICgoMTQ2MDk3ICogTiArIDMpIC8gNCB8IDApIHwgMDsKICAgICAgICBjb25zdCBJID0gNGUzICogKEwgKyAxKSAvIDE0NjEwMDEgfCAwOwogICAgICAgIEwgPSBMIC0gKDE0NjEgKiBJIC8gNCB8IDApICsgMzEgfCAwOwogICAgICAgIGNvbnN0IEogPSA4MCAqIEwgLyAyNDQ3IHwgMDsKICAgICAgICBjb25zdCBkYXkgPSBMIC0gKDI0NDcgKiBKIC8gODAgfCAwKSB8IDA7CiAgICAgICAgTCA9IEogLyAxMSB8IDA7CiAgICAgICAgY29uc3QgbW9udGggPSBKICsgMiAtIDEyICogTCB8IDA7CiAgICAgICAgY29uc3QgeWVhciA9IDEwMCAqIChOIC0gNDkpICsgSSArIEwgfCAwOwogICAgICAgIGxldCBob3VyID0gc2Vjb25kc09mRGF5IC8gVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0hPVVIgfCAwOwogICAgICAgIGxldCByZW1haW5pbmdTZWNvbmRzID0gc2Vjb25kc09mRGF5IC0gaG91ciAqIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9IT1VSOwogICAgICAgIGNvbnN0IG1pbnV0ZSA9IHJlbWFpbmluZ1NlY29uZHMgLyBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuU0VDT05EU19QRVJfTUlOVVRFIHwgMDsKICAgICAgICByZW1haW5pbmdTZWNvbmRzID0gcmVtYWluaW5nU2Vjb25kcyAtIG1pbnV0ZSAqIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9NSU5VVEU7CiAgICAgICAgbGV0IHNlY29uZCA9IHJlbWFpbmluZ1NlY29uZHMgfCAwOwogICAgICAgIGNvbnN0IG1pbGxpc2Vjb25kID0gKHJlbWFpbmluZ1NlY29uZHMgLSBzZWNvbmQpIC8gVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX01JTExJU0VDT05EOwogICAgICAgIGhvdXIgKz0gMTI7CiAgICAgICAgaWYgKGhvdXIgPiAyMykgewogICAgICAgICAgaG91ciAtPSAyNDsKICAgICAgICB9CiAgICAgICAgaWYgKGlzTGVhcFNlY29uZCkgewogICAgICAgICAgc2Vjb25kICs9IDE7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgR3JlZ29yaWFuRGF0ZV9kZWZhdWx0KAogICAgICAgICAgICB5ZWFyLAogICAgICAgICAgICBtb250aCwKICAgICAgICAgICAgZGF5LAogICAgICAgICAgICBob3VyLAogICAgICAgICAgICBtaW51dGUsCiAgICAgICAgICAgIHNlY29uZCwKICAgICAgICAgICAgbWlsbGlzZWNvbmQsCiAgICAgICAgICAgIGlzTGVhcFNlY29uZAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnllYXIgPSB5ZWFyOwogICAgICAgIHJlc3VsdC5tb250aCA9IG1vbnRoOwogICAgICAgIHJlc3VsdC5kYXkgPSBkYXk7CiAgICAgICAgcmVzdWx0LmhvdXIgPSBob3VyOwogICAgICAgIHJlc3VsdC5taW51dGUgPSBtaW51dGU7CiAgICAgICAgcmVzdWx0LnNlY29uZCA9IHNlY29uZDsKICAgICAgICByZXN1bHQubWlsbGlzZWNvbmQgPSBtaWxsaXNlY29uZDsKICAgICAgICByZXN1bHQuaXNMZWFwU2Vjb25kID0gaXNMZWFwU2Vjb25kOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUudG9EYXRlID0gZnVuY3Rpb24oanVsaWFuRGF0ZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGp1bGlhbkRhdGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgianVsaWFuRGF0ZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZ0RhdGUgPSBKdWxpYW5EYXRlLnRvR3JlZ29yaWFuRGF0ZShqdWxpYW5EYXRlLCBncmVnb3JpYW5EYXRlU2NyYXRjaCk7CiAgICAgICAgbGV0IHNlY29uZCA9IGdEYXRlLnNlY29uZDsKICAgICAgICBpZiAoZ0RhdGUuaXNMZWFwU2Vjb25kKSB7CiAgICAgICAgICBzZWNvbmQgLT0gMTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKAogICAgICAgICAgRGF0ZS5VVEMoCiAgICAgICAgICAgIGdEYXRlLnllYXIsCiAgICAgICAgICAgIGdEYXRlLm1vbnRoIC0gMSwKICAgICAgICAgICAgZ0RhdGUuZGF5LAogICAgICAgICAgICBnRGF0ZS5ob3VyLAogICAgICAgICAgICBnRGF0ZS5taW51dGUsCiAgICAgICAgICAgIHNlY29uZCwKICAgICAgICAgICAgZ0RhdGUubWlsbGlzZWNvbmQKICAgICAgICAgICkKICAgICAgICApOwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLnRvSXNvODYwMSA9IGZ1bmN0aW9uKGp1bGlhbkRhdGUsIHByZWNpc2lvbikgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGp1bGlhbkRhdGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgianVsaWFuRGF0ZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZ0RhdGUgPSBKdWxpYW5EYXRlLnRvR3JlZ29yaWFuRGF0ZShqdWxpYW5EYXRlLCBncmVnb3JpYW5EYXRlU2NyYXRjaCk7CiAgICAgICAgbGV0IHllYXIgPSBnRGF0ZS55ZWFyOwogICAgICAgIGxldCBtb250aCA9IGdEYXRlLm1vbnRoOwogICAgICAgIGxldCBkYXkgPSBnRGF0ZS5kYXk7CiAgICAgICAgbGV0IGhvdXIgPSBnRGF0ZS5ob3VyOwogICAgICAgIGNvbnN0IG1pbnV0ZSA9IGdEYXRlLm1pbnV0ZTsKICAgICAgICBjb25zdCBzZWNvbmQgPSBnRGF0ZS5zZWNvbmQ7CiAgICAgICAgY29uc3QgbWlsbGlzZWNvbmQgPSBnRGF0ZS5taWxsaXNlY29uZDsKICAgICAgICBpZiAoeWVhciA9PT0gMWU0ICYmIG1vbnRoID09PSAxICYmIGRheSA9PT0gMSAmJiBob3VyID09PSAwICYmIG1pbnV0ZSA9PT0gMCAmJiBzZWNvbmQgPT09IDAgJiYgbWlsbGlzZWNvbmQgPT09IDApIHsKICAgICAgICAgIHllYXIgPSA5OTk5OwogICAgICAgICAgbW9udGggPSAxMjsKICAgICAgICAgIGRheSA9IDMxOwogICAgICAgICAgaG91ciA9IDI0OwogICAgICAgIH0KICAgICAgICBsZXQgbWlsbGlzZWNvbmRTdHI7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocHJlY2lzaW9uKSAmJiBtaWxsaXNlY29uZCAhPT0gMCkgewogICAgICAgICAgbWlsbGlzZWNvbmRTdHIgPSAobWlsbGlzZWNvbmQgKiAwLjAxKS50b1N0cmluZygpLnJlcGxhY2UoIi4iLCAiIik7CiAgICAgICAgICByZXR1cm4gYCR7eWVhci50b1N0cmluZygpLnBhZFN0YXJ0KDQsICIwIil9LSR7bW9udGgudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfS0ke2RheS50b1N0cmluZygpLnBhZFN0YXJ0KDIsICIwIil9VCR7aG91ci50b1N0cmluZygpLnBhZFN0YXJ0KDIsICIwIil9OiR7bWludXRlLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgIjAiKX06JHtzZWNvbmQudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfS4ke21pbGxpc2Vjb25kU3RyfVpgOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwcmVjaXNpb24pIHx8IHByZWNpc2lvbiA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIGAke3llYXIudG9TdHJpbmcoKS5wYWRTdGFydCg0LCAiMCIpfS0ke21vbnRoLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgIjAiKX0tJHtkYXkudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfVQke2hvdXIudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfToke21pbnV0ZS50b1N0cmluZygpLnBhZFN0YXJ0KDIsICIwIil9OiR7c2Vjb25kLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgIjAiKX1aYDsKICAgICAgICB9CiAgICAgICAgbWlsbGlzZWNvbmRTdHIgPSAobWlsbGlzZWNvbmQgKiAwLjAxKS50b0ZpeGVkKHByZWNpc2lvbikucmVwbGFjZSgiLiIsICIiKS5zbGljZSgwLCBwcmVjaXNpb24pOwogICAgICAgIHJldHVybiBgJHt5ZWFyLnRvU3RyaW5nKCkucGFkU3RhcnQoNCwgIjAiKX0tJHttb250aC50b1N0cmluZygpLnBhZFN0YXJ0KDIsICIwIil9LSR7ZGF5LnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgIjAiKX1UJHtob3VyLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgIjAiKX06JHttaW51dGUudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfToke3NlY29uZC50b1N0cmluZygpLnBhZFN0YXJ0KDIsICIwIil9LiR7bWlsbGlzZWNvbmRTdHJ9WmA7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuY2xvbmUgPSBmdW5jdGlvbihqdWxpYW5EYXRlLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChqdWxpYW5EYXRlKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBKdWxpYW5EYXRlKAogICAgICAgICAgICBqdWxpYW5EYXRlLmRheU51bWJlciwKICAgICAgICAgICAganVsaWFuRGF0ZS5zZWNvbmRzT2ZEYXksCiAgICAgICAgICAgIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmRheU51bWJlciA9IGp1bGlhbkRhdGUuZGF5TnVtYmVyOwogICAgICAgIHJlc3VsdC5zZWNvbmRzT2ZEYXkgPSBqdWxpYW5EYXRlLnNlY29uZHNPZkRheTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLmNvbXBhcmUgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGxlZnQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibGVmdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmlnaHQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGp1bGlhbkRheU51bWJlckRpZmZlcmVuY2UgPSBsZWZ0LmRheU51bWJlciAtIHJpZ2h0LmRheU51bWJlcjsKICAgICAgICBpZiAoanVsaWFuRGF5TnVtYmVyRGlmZmVyZW5jZSAhPT0gMCkgewogICAgICAgICAgcmV0dXJuIGp1bGlhbkRheU51bWJlckRpZmZlcmVuY2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiBsZWZ0LnNlY29uZHNPZkRheSAtIHJpZ2h0LnNlY29uZHNPZkRheTsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBsZWZ0LmRheU51bWJlciA9PT0gcmlnaHQuZGF5TnVtYmVyICYmIGxlZnQuc2Vjb25kc09mRGF5ID09PSByaWdodC5zZWNvbmRzT2ZEYXk7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCBlcHNpbG9uKSB7CiAgICAgICAgZXBzaWxvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVwc2lsb24sIDApOwogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBNYXRoLmFicyhKdWxpYW5EYXRlLnNlY29uZHNEaWZmZXJlbmNlKGxlZnQsIHJpZ2h0KSkgPD0gZXBzaWxvbjsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS50b3RhbERheXMgPSBmdW5jdGlvbihqdWxpYW5EYXRlKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoanVsaWFuRGF0ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJqdWxpYW5EYXRlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4ganVsaWFuRGF0ZS5kYXlOdW1iZXIgKyBqdWxpYW5EYXRlLnNlY29uZHNPZkRheSAvIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9EQVk7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuc2Vjb25kc0RpZmZlcmVuY2UgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGxlZnQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibGVmdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmlnaHQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGRheURpZmZlcmVuY2UgPSAobGVmdC5kYXlOdW1iZXIgLSByaWdodC5kYXlOdW1iZXIpICogVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0RBWTsKICAgICAgICByZXR1cm4gZGF5RGlmZmVyZW5jZSArIChsZWZ0LnNlY29uZHNPZkRheSAtIHJpZ2h0LnNlY29uZHNPZkRheSk7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuZGF5c0RpZmZlcmVuY2UgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGxlZnQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibGVmdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmlnaHQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGRheURpZmZlcmVuY2UgPSBsZWZ0LmRheU51bWJlciAtIHJpZ2h0LmRheU51bWJlcjsKICAgICAgICBjb25zdCBzZWNvbmREaWZmZXJlbmNlID0gKGxlZnQuc2Vjb25kc09mRGF5IC0gcmlnaHQuc2Vjb25kc09mRGF5KSAvIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9EQVk7CiAgICAgICAgcmV0dXJuIGRheURpZmZlcmVuY2UgKyBzZWNvbmREaWZmZXJlbmNlOwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLmNvbXB1dGVUYWlNaW51c1V0YyA9IGZ1bmN0aW9uKGp1bGlhbkRhdGUpIHsKICAgICAgICBiaW5hcnlTZWFyY2hTY3JhdGNoTGVhcFNlY29uZC5qdWxpYW5EYXRlID0ganVsaWFuRGF0ZTsKICAgICAgICBjb25zdCBsZWFwU2Vjb25kcyA9IEp1bGlhbkRhdGUubGVhcFNlY29uZHM7CiAgICAgICAgbGV0IGluZGV4ID0gYmluYXJ5U2VhcmNoX2RlZmF1bHQoCiAgICAgICAgICBsZWFwU2Vjb25kcywKICAgICAgICAgIGJpbmFyeVNlYXJjaFNjcmF0Y2hMZWFwU2Vjb25kLAogICAgICAgICAgY29tcGFyZUxlYXBTZWNvbmREYXRlcwogICAgICAgICk7CiAgICAgICAgaWYgKGluZGV4IDwgMCkgewogICAgICAgICAgaW5kZXggPSB+aW5kZXg7CiAgICAgICAgICAtLWluZGV4OwogICAgICAgICAgaWYgKGluZGV4IDwgMCkgewogICAgICAgICAgICBpbmRleCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBsZWFwU2Vjb25kc1tpbmRleF0ub2Zmc2V0OwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLmFkZFNlY29uZHMgPSBmdW5jdGlvbihqdWxpYW5EYXRlLCBzZWNvbmRzLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChqdWxpYW5EYXRlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImp1bGlhbkRhdGUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHNlY29uZHMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgic2Vjb25kcyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJlc3VsdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNldENvbXBvbmVudHMoCiAgICAgICAgICBqdWxpYW5EYXRlLmRheU51bWJlciwKICAgICAgICAgIGp1bGlhbkRhdGUuc2Vjb25kc09mRGF5ICsgc2Vjb25kcywKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuYWRkTWludXRlcyA9IGZ1bmN0aW9uKGp1bGlhbkRhdGUsIG1pbnV0ZXMsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGp1bGlhbkRhdGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgianVsaWFuRGF0ZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobWludXRlcykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJtaW51dGVzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmVzdWx0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBuZXdTZWNvbmRzT2ZEYXkgPSBqdWxpYW5EYXRlLnNlY29uZHNPZkRheSArIG1pbnV0ZXMgKiBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuU0VDT05EU19QRVJfTUlOVVRFOwogICAgICAgIHJldHVybiBzZXRDb21wb25lbnRzKGp1bGlhbkRhdGUuZGF5TnVtYmVyLCBuZXdTZWNvbmRzT2ZEYXksIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuYWRkSG91cnMgPSBmdW5jdGlvbihqdWxpYW5EYXRlLCBob3VycywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoanVsaWFuRGF0ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJqdWxpYW5EYXRlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChob3VycykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJob3VycyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJlc3VsdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbmV3U2Vjb25kc09mRGF5ID0ganVsaWFuRGF0ZS5zZWNvbmRzT2ZEYXkgKyBob3VycyAqIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9IT1VSOwogICAgICAgIHJldHVybiBzZXRDb21wb25lbnRzKGp1bGlhbkRhdGUuZGF5TnVtYmVyLCBuZXdTZWNvbmRzT2ZEYXksIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuYWRkRGF5cyA9IGZ1bmN0aW9uKGp1bGlhbkRhdGUsIGRheXMsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGp1bGlhbkRhdGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgianVsaWFuRGF0ZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZGF5cykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkYXlzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmVzdWx0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBuZXdKdWxpYW5EYXlOdW1iZXIgPSBqdWxpYW5EYXRlLmRheU51bWJlciArIGRheXM7CiAgICAgICAgcmV0dXJuIHNldENvbXBvbmVudHMobmV3SnVsaWFuRGF5TnVtYmVyLCBqdWxpYW5EYXRlLnNlY29uZHNPZkRheSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5sZXNzVGhhbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIEp1bGlhbkRhdGUuY29tcGFyZShsZWZ0LCByaWdodCkgPCAwOwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLmxlc3NUaGFuT3JFcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBKdWxpYW5EYXRlLmNvbXBhcmUobGVmdCwgcmlnaHQpIDw9IDA7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuZ3JlYXRlclRoYW4gPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBKdWxpYW5EYXRlLmNvbXBhcmUobGVmdCwgcmlnaHQpID4gMDsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5ncmVhdGVyVGhhbk9yRXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gSnVsaWFuRGF0ZS5jb21wYXJlKGxlZnQsIHJpZ2h0KSA+PSAwOwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJldHVybiBKdWxpYW5EYXRlLmNsb25lKHRoaXMsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIEp1bGlhbkRhdGUuZXF1YWxzKHRoaXMsIHJpZ2h0KTsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5wcm90b3R5cGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKHJpZ2h0LCBlcHNpbG9uKSB7CiAgICAgICAgcmV0dXJuIEp1bGlhbkRhdGUuZXF1YWxzRXBzaWxvbih0aGlzLCByaWdodCwgZXBzaWxvbik7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIEp1bGlhbkRhdGUudG9Jc284NjAxKHRoaXMpOwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLmxlYXBTZWNvbmRzID0gWwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0MTMxNywgNDMyMTAsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDEwKSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDE5NzIgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQxNDk5LCA0MzIxMSwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMTEpLAogICAgICAgIC8vIEp1bHkgMSwgMTk3MiAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDE2ODMsIDQzMjEyLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAxMiksCiAgICAgICAgLy8gSmFudWFyeSAxLCAxOTczIDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0MjA0OCwgNDMyMTMsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDEzKSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDE5NzQgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQyNDEzLCA0MzIxNCwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMTQpLAogICAgICAgIC8vIEphbnVhcnkgMSwgMTk3NSAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDI3NzgsIDQzMjE1LCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAxNSksCiAgICAgICAgLy8gSmFudWFyeSAxLCAxOTc2IDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0MzE0NCwgNDMyMTYsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDE2KSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDE5NzcgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQzNTA5LCA0MzIxNywgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMTcpLAogICAgICAgIC8vIEphbnVhcnkgMSwgMTk3OCAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDM4NzQsIDQzMjE4LCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAxOCksCiAgICAgICAgLy8gSmFudWFyeSAxLCAxOTc5IDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0NDIzOSwgNDMyMTksIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDE5KSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDE5ODAgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQ0Nzg2LCA0MzIyMCwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMjApLAogICAgICAgIC8vIEp1bHkgMSwgMTk4MSAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDUxNTEsIDQzMjIxLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAyMSksCiAgICAgICAgLy8gSnVseSAxLCAxOTgyIDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0NTUxNiwgNDMyMjIsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDIyKSwKICAgICAgICAvLyBKdWx5IDEsIDE5ODMgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQ2MjQ3LCA0MzIyMywgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMjMpLAogICAgICAgIC8vIEp1bHkgMSwgMTk4NSAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDcxNjEsIDQzMjI0LCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAyNCksCiAgICAgICAgLy8gSmFudWFyeSAxLCAxOTg4IDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0Nzg5MiwgNDMyMjUsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDI1KSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDE5OTAgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQ4MjU3LCA0MzIyNiwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMjYpLAogICAgICAgIC8vIEphbnVhcnkgMSwgMTk5MSAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDg4MDQsIDQzMjI3LCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAyNyksCiAgICAgICAgLy8gSnVseSAxLCAxOTkyIDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0OTE2OSwgNDMyMjgsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDI4KSwKICAgICAgICAvLyBKdWx5IDEsIDE5OTMgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQ5NTM0LCA0MzIyOSwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMjkpLAogICAgICAgIC8vIEp1bHkgMSwgMTk5NCAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NTAwODMsIDQzMjMwLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAzMCksCiAgICAgICAgLy8gSmFudWFyeSAxLCAxOTk2IDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ1MDYzMCwgNDMyMzEsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDMxKSwKICAgICAgICAvLyBKdWx5IDEsIDE5OTcgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDUxMTc5LCA0MzIzMiwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMzIpLAogICAgICAgIC8vIEphbnVhcnkgMSwgMTk5OSAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NTM3MzYsIDQzMjMzLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAzMyksCiAgICAgICAgLy8gSmFudWFyeSAxLCAyMDA2IDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ1NDgzMiwgNDMyMzQsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDM0KSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDIwMDkgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDU2MTA5LCA0MzIzNSwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMzUpLAogICAgICAgIC8vIEp1bHkgMSwgMjAxMiAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NTcyMDQsIDQzMjM2LCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAzNiksCiAgICAgICAgLy8gSnVseSAxLCAyMDE1IDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ1Nzc1NCwgNDMyMzcsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDM3KQogICAgICAgIC8vIEphbnVhcnkgMSwgMjAxNyAwMDowMDowMCBVVEMKICAgICAgXTsKICAgICAgSnVsaWFuRGF0ZV9kZWZhdWx0ID0gSnVsaWFuRGF0ZTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3VyaWpzL3NyYy9wdW55Y29kZS5qcwogIHZhciByZXF1aXJlX3B1bnljb2RlID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3VyaWpzL3NyYy9wdW55Y29kZS5qcyIoZXhwb3J0czIsIG1vZHVsZSkgewogICAgICAvKiEgaHR0cHM6Ly9tdGhzLmJlL3B1bnljb2RlIHYxLjQuMCBieSBAbWF0aGlhcyAqLwogICAgICAoZnVuY3Rpb24ocm9vdCkgewogICAgICAgIHZhciBmcmVlRXhwb3J0cyA9IHR5cGVvZiBleHBvcnRzMiA9PSAib2JqZWN0IiAmJiBleHBvcnRzMiAmJiAhZXhwb3J0czIubm9kZVR5cGUgJiYgZXhwb3J0czI7CiAgICAgICAgdmFyIGZyZWVNb2R1bGUgPSB0eXBlb2YgbW9kdWxlID09ICJvYmplY3QiICYmIG1vZHVsZSAmJiAhbW9kdWxlLm5vZGVUeXBlICYmIG1vZHVsZTsKICAgICAgICB2YXIgZnJlZUdsb2JhbCA9IHR5cGVvZiBnbG9iYWwgPT0gIm9iamVjdCIgJiYgZ2xvYmFsOwogICAgICAgIGlmIChmcmVlR2xvYmFsLmdsb2JhbCA9PT0gZnJlZUdsb2JhbCB8fCBmcmVlR2xvYmFsLndpbmRvdyA9PT0gZnJlZUdsb2JhbCB8fCBmcmVlR2xvYmFsLnNlbGYgPT09IGZyZWVHbG9iYWwpIHsKICAgICAgICAgIHJvb3QgPSBmcmVlR2xvYmFsOwogICAgICAgIH0KICAgICAgICB2YXIgcHVueWNvZGUsIG1heEludCA9IDIxNDc0ODM2NDcsIGJhc2UgPSAzNiwgdE1pbiA9IDEsIHRNYXggPSAyNiwgc2tldyA9IDM4LCBkYW1wID0gNzAwLCBpbml0aWFsQmlhcyA9IDcyLCBpbml0aWFsTiA9IDEyOCwgZGVsaW1pdGVyID0gIi0iLCByZWdleFB1bnljb2RlID0gL154bi0tLywgcmVnZXhOb25BU0NJSSA9IC9bXlx4MjAtXHg3RV0vLCByZWdleFNlcGFyYXRvcnMgPSAvW1x4MkVcdTMwMDJcdUZGMEVcdUZGNjFdL2csIGVycm9ycyA9IHsKICAgICAgICAgICJvdmVyZmxvdyI6ICJPdmVyZmxvdzogaW5wdXQgbmVlZHMgd2lkZXIgaW50ZWdlcnMgdG8gcHJvY2VzcyIsCiAgICAgICAgICAibm90LWJhc2ljIjogIklsbGVnYWwgaW5wdXQgPj0gMHg4MCAobm90IGEgYmFzaWMgY29kZSBwb2ludCkiLAogICAgICAgICAgImludmFsaWQtaW5wdXQiOiAiSW52YWxpZCBpbnB1dCIKICAgICAgICB9LCBiYXNlTWludXNUTWluID0gYmFzZSAtIHRNaW4sIGZsb29yID0gTWF0aC5mbG9vciwgc3RyaW5nRnJvbUNoYXJDb2RlID0gU3RyaW5nLmZyb21DaGFyQ29kZSwga2V5OwogICAgICAgIGZ1bmN0aW9uIGVycm9yKHR5cGUpIHsKICAgICAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKGVycm9yc1t0eXBlXSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcChhcnJheSwgZm4pIHsKICAgICAgICAgIHZhciBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICAgICAgcmVzdWx0W2xlbmd0aF0gPSBmbihhcnJheVtsZW5ndGhdKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcERvbWFpbihzdHJpbmcsIGZuKSB7CiAgICAgICAgICB2YXIgcGFydHMgPSBzdHJpbmcuc3BsaXQoIkAiKTsKICAgICAgICAgIHZhciByZXN1bHQgPSAiIjsKICAgICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IHBhcnRzWzBdICsgIkAiOwogICAgICAgICAgICBzdHJpbmcgPSBwYXJ0c1sxXTsKICAgICAgICAgIH0KICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5yZXBsYWNlKHJlZ2V4U2VwYXJhdG9ycywgIi4iKTsKICAgICAgICAgIHZhciBsYWJlbHMgPSBzdHJpbmcuc3BsaXQoIi4iKTsKICAgICAgICAgIHZhciBlbmNvZGVkID0gbWFwKGxhYmVscywgZm4pLmpvaW4oIi4iKTsKICAgICAgICAgIHJldHVybiByZXN1bHQgKyBlbmNvZGVkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1Y3MyZGVjb2RlKHN0cmluZykgewogICAgICAgICAgdmFyIG91dHB1dCA9IFtdLCBjb3VudGVyID0gMCwgbGVuZ3RoID0gc3RyaW5nLmxlbmd0aCwgdmFsdWUsIGV4dHJhOwogICAgICAgICAgd2hpbGUgKGNvdW50ZXIgPCBsZW5ndGgpIHsKICAgICAgICAgICAgdmFsdWUgPSBzdHJpbmcuY2hhckNvZGVBdChjb3VudGVyKyspOwogICAgICAgICAgICBpZiAodmFsdWUgPj0gNTUyOTYgJiYgdmFsdWUgPD0gNTYzMTkgJiYgY291bnRlciA8IGxlbmd0aCkgewogICAgICAgICAgICAgIGV4dHJhID0gc3RyaW5nLmNoYXJDb2RlQXQoY291bnRlcisrKTsKICAgICAgICAgICAgICBpZiAoKGV4dHJhICYgNjQ1MTIpID09IDU2MzIwKSB7CiAgICAgICAgICAgICAgICBvdXRwdXQucHVzaCgoKHZhbHVlICYgMTAyMykgPDwgMTApICsgKGV4dHJhICYgMTAyMykgKyA2NTUzNik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG91dHB1dC5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgICAgIGNvdW50ZXItLTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgb3V0cHV0LnB1c2godmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1Y3MyZW5jb2RlKGFycmF5KSB7CiAgICAgICAgICByZXR1cm4gbWFwKGFycmF5LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICB2YXIgb3V0cHV0ID0gIiI7CiAgICAgICAgICAgIGlmICh2YWx1ZSA+IDY1NTM1KSB7CiAgICAgICAgICAgICAgdmFsdWUgLT0gNjU1MzY7CiAgICAgICAgICAgICAgb3V0cHV0ICs9IHN0cmluZ0Zyb21DaGFyQ29kZSh2YWx1ZSA+Pj4gMTAgJiAxMDIzIHwgNTUyOTYpOwogICAgICAgICAgICAgIHZhbHVlID0gNTYzMjAgfCB2YWx1ZSAmIDEwMjM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3V0cHV0ICs9IHN0cmluZ0Zyb21DaGFyQ29kZSh2YWx1ZSk7CiAgICAgICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgICAgICB9KS5qb2luKCIiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmFzaWNUb0RpZ2l0KGNvZGVQb2ludCkgewogICAgICAgICAgaWYgKGNvZGVQb2ludCAtIDQ4IDwgMTApIHsKICAgICAgICAgICAgcmV0dXJuIGNvZGVQb2ludCAtIDIyOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvZGVQb2ludCAtIDY1IDwgMjYpIHsKICAgICAgICAgICAgcmV0dXJuIGNvZGVQb2ludCAtIDY1OwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvZGVQb2ludCAtIDk3IDwgMjYpIHsKICAgICAgICAgICAgcmV0dXJuIGNvZGVQb2ludCAtIDk3OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGJhc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZ2l0VG9CYXNpYyhkaWdpdCwgZmxhZykgewogICAgICAgICAgcmV0dXJuIGRpZ2l0ICsgMjIgKyA3NSAqIChkaWdpdCA8IDI2KSAtICgoZmxhZyAhPSAwKSA8PCA1KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRhcHQoZGVsdGEsIG51bVBvaW50cywgZmlyc3RUaW1lKSB7CiAgICAgICAgICB2YXIgayA9IDA7CiAgICAgICAgICBkZWx0YSA9IGZpcnN0VGltZSA/IGZsb29yKGRlbHRhIC8gZGFtcCkgOiBkZWx0YSA+PiAxOwogICAgICAgICAgZGVsdGEgKz0gZmxvb3IoZGVsdGEgLyBudW1Qb2ludHMpOwogICAgICAgICAgZm9yICg7IGRlbHRhID4gYmFzZU1pbnVzVE1pbiAqIHRNYXggPj4gMTsgayArPSBiYXNlKSB7CiAgICAgICAgICAgIGRlbHRhID0gZmxvb3IoZGVsdGEgLyBiYXNlTWludXNUTWluKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmbG9vcihrICsgKGJhc2VNaW51c1RNaW4gKyAxKSAqIGRlbHRhIC8gKGRlbHRhICsgc2tldykpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWNvZGUzKGlucHV0KSB7CiAgICAgICAgICB2YXIgb3V0cHV0ID0gW10sIGlucHV0TGVuZ3RoID0gaW5wdXQubGVuZ3RoLCBvdXQsIGkgPSAwLCBuID0gaW5pdGlhbE4sIGJpYXMgPSBpbml0aWFsQmlhcywgYmFzaWMsIGosIGluZGV4LCBvbGRpLCB3LCBrLCBkaWdpdCwgdCwgYmFzZU1pbnVzVDsKICAgICAgICAgIGJhc2ljID0gaW5wdXQubGFzdEluZGV4T2YoZGVsaW1pdGVyKTsKICAgICAgICAgIGlmIChiYXNpYyA8IDApIHsKICAgICAgICAgICAgYmFzaWMgPSAwOwogICAgICAgICAgfQogICAgICAgICAgZm9yIChqID0gMDsgaiA8IGJhc2ljOyArK2opIHsKICAgICAgICAgICAgaWYgKGlucHV0LmNoYXJDb2RlQXQoaikgPj0gMTI4KSB7CiAgICAgICAgICAgICAgZXJyb3IoIm5vdC1iYXNpYyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG91dHB1dC5wdXNoKGlucHV0LmNoYXJDb2RlQXQoaikpOwogICAgICAgICAgfQogICAgICAgICAgZm9yIChpbmRleCA9IGJhc2ljID4gMCA/IGJhc2ljICsgMSA6IDA7IGluZGV4IDwgaW5wdXRMZW5ndGg7ICkgewogICAgICAgICAgICBmb3IgKG9sZGkgPSBpLCB3ID0gMSwgayA9IGJhc2U7IDsgayArPSBiYXNlKSB7CiAgICAgICAgICAgICAgaWYgKGluZGV4ID49IGlucHV0TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiaW52YWxpZC1pbnB1dCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkaWdpdCA9IGJhc2ljVG9EaWdpdChpbnB1dC5jaGFyQ29kZUF0KGluZGV4KyspKTsKICAgICAgICAgICAgICBpZiAoZGlnaXQgPj0gYmFzZSB8fCBkaWdpdCA+IGZsb29yKChtYXhJbnQgLSBpKSAvIHcpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigib3ZlcmZsb3ciKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaSArPSBkaWdpdCAqIHc7CiAgICAgICAgICAgICAgdCA9IGsgPD0gYmlhcyA/IHRNaW4gOiBrID49IGJpYXMgKyB0TWF4ID8gdE1heCA6IGsgLSBiaWFzOwogICAgICAgICAgICAgIGlmIChkaWdpdCA8IHQpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBiYXNlTWludXNUID0gYmFzZSAtIHQ7CiAgICAgICAgICAgICAgaWYgKHcgPiBmbG9vcihtYXhJbnQgLyBiYXNlTWludXNUKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIm92ZXJmbG93Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHcgKj0gYmFzZU1pbnVzVDsKICAgICAgICAgICAgfQogICAgICAgICAgICBvdXQgPSBvdXRwdXQubGVuZ3RoICsgMTsKICAgICAgICAgICAgYmlhcyA9IGFkYXB0KGkgLSBvbGRpLCBvdXQsIG9sZGkgPT0gMCk7CiAgICAgICAgICAgIGlmIChmbG9vcihpIC8gb3V0KSA+IG1heEludCAtIG4pIHsKICAgICAgICAgICAgICBlcnJvcigib3ZlcmZsb3ciKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBuICs9IGZsb29yKGkgLyBvdXQpOwogICAgICAgICAgICBpICU9IG91dDsKICAgICAgICAgICAgb3V0cHV0LnNwbGljZShpKyssIDAsIG4pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVjczJlbmNvZGUob3V0cHV0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5jb2RlKGlucHV0KSB7CiAgICAgICAgICB2YXIgbiwgZGVsdGEsIGhhbmRsZWRDUENvdW50LCBiYXNpY0xlbmd0aCwgYmlhcywgaiwgbSwgcSwgaywgdCwgY3VycmVudFZhbHVlLCBvdXRwdXQgPSBbXSwgaW5wdXRMZW5ndGgsIGhhbmRsZWRDUENvdW50UGx1c09uZSwgYmFzZU1pbnVzVCwgcU1pbnVzVDsKICAgICAgICAgIGlucHV0ID0gdWNzMmRlY29kZShpbnB1dCk7CiAgICAgICAgICBpbnB1dExlbmd0aCA9IGlucHV0Lmxlbmd0aDsKICAgICAgICAgIG4gPSBpbml0aWFsTjsKICAgICAgICAgIGRlbHRhID0gMDsKICAgICAgICAgIGJpYXMgPSBpbml0aWFsQmlhczsKICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBpbnB1dExlbmd0aDsgKytqKSB7CiAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9IGlucHV0W2pdOwogICAgICAgICAgICBpZiAoY3VycmVudFZhbHVlIDwgMTI4KSB7CiAgICAgICAgICAgICAgb3V0cHV0LnB1c2goc3RyaW5nRnJvbUNoYXJDb2RlKGN1cnJlbnRWYWx1ZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBoYW5kbGVkQ1BDb3VudCA9IGJhc2ljTGVuZ3RoID0gb3V0cHV0Lmxlbmd0aDsKICAgICAgICAgIGlmIChiYXNpY0xlbmd0aCkgewogICAgICAgICAgICBvdXRwdXQucHVzaChkZWxpbWl0ZXIpOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGhhbmRsZWRDUENvdW50IDwgaW5wdXRMZW5ndGgpIHsKICAgICAgICAgICAgZm9yIChtID0gbWF4SW50LCBqID0gMDsgaiA8IGlucHV0TGVuZ3RoOyArK2opIHsKICAgICAgICAgICAgICBjdXJyZW50VmFsdWUgPSBpbnB1dFtqXTsKICAgICAgICAgICAgICBpZiAoY3VycmVudFZhbHVlID49IG4gJiYgY3VycmVudFZhbHVlIDwgbSkgewogICAgICAgICAgICAgICAgbSA9IGN1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaGFuZGxlZENQQ291bnRQbHVzT25lID0gaGFuZGxlZENQQ291bnQgKyAxOwogICAgICAgICAgICBpZiAobSAtIG4gPiBmbG9vcigobWF4SW50IC0gZGVsdGEpIC8gaGFuZGxlZENQQ291bnRQbHVzT25lKSkgewogICAgICAgICAgICAgIGVycm9yKCJvdmVyZmxvdyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlbHRhICs9IChtIC0gbikgKiBoYW5kbGVkQ1BDb3VudFBsdXNPbmU7CiAgICAgICAgICAgIG4gPSBtOwogICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgaW5wdXRMZW5ndGg7ICsraikgewogICAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9IGlucHV0W2pdOwogICAgICAgICAgICAgIGlmIChjdXJyZW50VmFsdWUgPCBuICYmICsrZGVsdGEgPiBtYXhJbnQpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJvdmVyZmxvdyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoY3VycmVudFZhbHVlID09IG4pIHsKICAgICAgICAgICAgICAgIGZvciAocSA9IGRlbHRhLCBrID0gYmFzZTsgOyBrICs9IGJhc2UpIHsKICAgICAgICAgICAgICAgICAgdCA9IGsgPD0gYmlhcyA/IHRNaW4gOiBrID49IGJpYXMgKyB0TWF4ID8gdE1heCA6IGsgLSBiaWFzOwogICAgICAgICAgICAgICAgICBpZiAocSA8IHQpIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBxTWludXNUID0gcSAtIHQ7CiAgICAgICAgICAgICAgICAgIGJhc2VNaW51c1QgPSBiYXNlIC0gdDsKICAgICAgICAgICAgICAgICAgb3V0cHV0LnB1c2goCiAgICAgICAgICAgICAgICAgICAgc3RyaW5nRnJvbUNoYXJDb2RlKGRpZ2l0VG9CYXNpYyh0ICsgcU1pbnVzVCAlIGJhc2VNaW51c1QsIDApKQogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBxID0gZmxvb3IocU1pbnVzVCAvIGJhc2VNaW51c1QpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgb3V0cHV0LnB1c2goc3RyaW5nRnJvbUNoYXJDb2RlKGRpZ2l0VG9CYXNpYyhxLCAwKSkpOwogICAgICAgICAgICAgICAgYmlhcyA9IGFkYXB0KGRlbHRhLCBoYW5kbGVkQ1BDb3VudFBsdXNPbmUsIGhhbmRsZWRDUENvdW50ID09IGJhc2ljTGVuZ3RoKTsKICAgICAgICAgICAgICAgIGRlbHRhID0gMDsKICAgICAgICAgICAgICAgICsraGFuZGxlZENQQ291bnQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgICsrZGVsdGE7CiAgICAgICAgICAgICsrbjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBvdXRwdXQuam9pbigiIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRvVW5pY29kZShpbnB1dCkgewogICAgICAgICAgcmV0dXJuIG1hcERvbWFpbihpbnB1dCwgZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgICAgICAgIHJldHVybiByZWdleFB1bnljb2RlLnRlc3Qoc3RyaW5nKSA/IGRlY29kZTMoc3RyaW5nLnNsaWNlKDQpLnRvTG93ZXJDYXNlKCkpIDogc3RyaW5nOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRvQVNDSUkoaW5wdXQpIHsKICAgICAgICAgIHJldHVybiBtYXBEb21haW4oaW5wdXQsIGZ1bmN0aW9uKHN0cmluZykgewogICAgICAgICAgICByZXR1cm4gcmVnZXhOb25BU0NJSS50ZXN0KHN0cmluZykgPyAieG4tLSIgKyBlbmNvZGUoc3RyaW5nKSA6IHN0cmluZzsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBwdW55Y29kZSA9IHsKICAgICAgICAgIC8qKgogICAgICAgICAgICogQSBzdHJpbmcgcmVwcmVzZW50aW5nIHRoZSBjdXJyZW50IFB1bnljb2RlLmpzIHZlcnNpb24gbnVtYmVyLgogICAgICAgICAgICogQG1lbWJlck9mIHB1bnljb2RlCiAgICAgICAgICAgKiBAdHlwZSBTdHJpbmcKICAgICAgICAgICAqLwogICAgICAgICAgInZlcnNpb24iOiAiMS4zLjIiLAogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBBbiBvYmplY3Qgb2YgbWV0aG9kcyB0byBjb252ZXJ0IGZyb20gSmF2YVNjcmlwdCdzIGludGVybmFsIGNoYXJhY3RlcgogICAgICAgICAgICogcmVwcmVzZW50YXRpb24gKFVDUy0yKSB0byBVbmljb2RlIGNvZGUgcG9pbnRzLCBhbmQgYmFjay4KICAgICAgICAgICAqIEBzZWUgPGh0dHBzOi8vbWF0aGlhc2J5bmVucy5iZS9ub3Rlcy9qYXZhc2NyaXB0LWVuY29kaW5nPgogICAgICAgICAgICogQG1lbWJlck9mIHB1bnljb2RlCiAgICAgICAgICAgKiBAdHlwZSBPYmplY3QKICAgICAgICAgICAqLwogICAgICAgICAgInVjczIiOiB7CiAgICAgICAgICAgICJkZWNvZGUiOiB1Y3MyZGVjb2RlLAogICAgICAgICAgICAiZW5jb2RlIjogdWNzMmVuY29kZQogICAgICAgICAgfSwKICAgICAgICAgICJkZWNvZGUiOiBkZWNvZGUzLAogICAgICAgICAgImVuY29kZSI6IGVuY29kZSwKICAgICAgICAgICJ0b0FTQ0lJIjogdG9BU0NJSSwKICAgICAgICAgICJ0b1VuaWNvZGUiOiB0b1VuaWNvZGUKICAgICAgICB9OwogICAgICAgIGlmICh0eXBlb2YgZGVmaW5lID09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGRlZmluZS5hbWQgPT0gIm9iamVjdCIgJiYgZGVmaW5lLmFtZCkgewogICAgICAgICAgZGVmaW5lKCJwdW55Y29kZSIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gcHVueWNvZGU7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgaWYgKGZyZWVFeHBvcnRzICYmIGZyZWVNb2R1bGUpIHsKICAgICAgICAgIGlmIChtb2R1bGUuZXhwb3J0cyA9PSBmcmVlRXhwb3J0cykgewogICAgICAgICAgICBmcmVlTW9kdWxlLmV4cG9ydHMgPSBwdW55Y29kZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZvciAoa2V5IGluIHB1bnljb2RlKSB7CiAgICAgICAgICAgICAgcHVueWNvZGUuaGFzT3duUHJvcGVydHkoa2V5KSAmJiAoZnJlZUV4cG9ydHNba2V5XSA9IHB1bnljb2RlW2tleV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJvb3QucHVueWNvZGUgPSBwdW55Y29kZTsKICAgICAgICB9CiAgICAgIH0pKGV4cG9ydHMyKTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3VyaWpzL3NyYy9JUHY2LmpzCiAgdmFyIHJlcXVpcmVfSVB2NiA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy91cmlqcy9zcmMvSVB2Ni5qcyIoZXhwb3J0czIsIG1vZHVsZSkgewogICAgICAvKiEKICAgICAgICogVVJJLmpzIC0gTXV0YXRpbmcgVVJMcwogICAgICAgKiBJUHY2IFN1cHBvcnQKICAgICAgICoKICAgICAgICogVmVyc2lvbjogMS4xOS4xMQogICAgICAgKgogICAgICAgKiBBdXRob3I6IFJvZG5leSBSZWhtCiAgICAgICAqIFdlYjogaHR0cDovL21lZGlhbGl6ZS5naXRodWIuaW8vVVJJLmpzLwogICAgICAgKgogICAgICAgKiBMaWNlbnNlZCB1bmRlcgogICAgICAgKiAgIE1JVCBMaWNlbnNlIGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UKICAgICAgICoKICAgICAgICovCiAgICAgIChmdW5jdGlvbihyb290LCBmYWN0b3J5KSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGlmICh0eXBlb2YgbW9kdWxlID09PSAib2JqZWN0IiAmJiBtb2R1bGUuZXhwb3J0cykgewogICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KCk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQpIHsKICAgICAgICAgIGRlZmluZShmYWN0b3J5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcm9vdC5JUHY2ID0gZmFjdG9yeShyb290KTsKICAgICAgICB9CiAgICAgIH0pKGV4cG9ydHMyLCBmdW5jdGlvbihyb290KSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciBfSVB2NiA9IHJvb3QgJiYgcm9vdC5JUHY2OwogICAgICAgIGZ1bmN0aW9uIGJlc3RQcmVzZW50YXRpb24oYWRkcmVzcykgewogICAgICAgICAgdmFyIF9hZGRyZXNzID0gYWRkcmVzcy50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgdmFyIHNlZ21lbnRzID0gX2FkZHJlc3Muc3BsaXQoIjoiKTsKICAgICAgICAgIHZhciBsZW5ndGggPSBzZWdtZW50cy5sZW5ndGg7CiAgICAgICAgICB2YXIgdG90YWwgPSA4OwogICAgICAgICAgaWYgKHNlZ21lbnRzWzBdID09PSAiIiAmJiBzZWdtZW50c1sxXSA9PT0gIiIgJiYgc2VnbWVudHNbMl0gPT09ICIiKSB7CiAgICAgICAgICAgIHNlZ21lbnRzLnNoaWZ0KCk7CiAgICAgICAgICAgIHNlZ21lbnRzLnNoaWZ0KCk7CiAgICAgICAgICB9IGVsc2UgaWYgKHNlZ21lbnRzWzBdID09PSAiIiAmJiBzZWdtZW50c1sxXSA9PT0gIiIpIHsKICAgICAgICAgICAgc2VnbWVudHMuc2hpZnQoKTsKICAgICAgICAgIH0gZWxzZSBpZiAoc2VnbWVudHNbbGVuZ3RoIC0gMV0gPT09ICIiICYmIHNlZ21lbnRzW2xlbmd0aCAtIDJdID09PSAiIikgewogICAgICAgICAgICBzZWdtZW50cy5wb3AoKTsKICAgICAgICAgIH0KICAgICAgICAgIGxlbmd0aCA9IHNlZ21lbnRzLmxlbmd0aDsKICAgICAgICAgIGlmIChzZWdtZW50c1tsZW5ndGggLSAxXS5pbmRleE9mKCIuIikgIT09IC0xKSB7CiAgICAgICAgICAgIHRvdGFsID0gNzsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwb3M7CiAgICAgICAgICBmb3IgKHBvcyA9IDA7IHBvcyA8IGxlbmd0aDsgcG9zKyspIHsKICAgICAgICAgICAgaWYgKHNlZ21lbnRzW3Bvc10gPT09ICIiKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChwb3MgPCB0b3RhbCkgewogICAgICAgICAgICBzZWdtZW50cy5zcGxpY2UocG9zLCAxLCAiMDAwMCIpOwogICAgICAgICAgICB3aGlsZSAoc2VnbWVudHMubGVuZ3RoIDwgdG90YWwpIHsKICAgICAgICAgICAgICBzZWdtZW50cy5zcGxpY2UocG9zLCAwLCAiMDAwMCIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgX3NlZ21lbnRzOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0b3RhbDsgaSsrKSB7CiAgICAgICAgICAgIF9zZWdtZW50cyA9IHNlZ21lbnRzW2ldLnNwbGl0KCIiKTsKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCAzOyBqKyspIHsKICAgICAgICAgICAgICBpZiAoX3NlZ21lbnRzWzBdID09PSAiMCIgJiYgX3NlZ21lbnRzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgIF9zZWdtZW50cy5zcGxpY2UoMCwgMSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBzZWdtZW50c1tpXSA9IF9zZWdtZW50cy5qb2luKCIiKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBiZXN0ID0gLTE7CiAgICAgICAgICB2YXIgX2Jlc3QgPSAwOwogICAgICAgICAgdmFyIF9jdXJyZW50ID0gMDsKICAgICAgICAgIHZhciBjdXJyZW50ID0gLTE7CiAgICAgICAgICB2YXIgaW56ZXJvZXMgPSBmYWxzZTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB0b3RhbDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChpbnplcm9lcykgewogICAgICAgICAgICAgIGlmIChzZWdtZW50c1tpXSA9PT0gIjAiKSB7CiAgICAgICAgICAgICAgICBfY3VycmVudCArPSAxOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpbnplcm9lcyA9IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKF9jdXJyZW50ID4gX2Jlc3QpIHsKICAgICAgICAgICAgICAgICAgYmVzdCA9IGN1cnJlbnQ7CiAgICAgICAgICAgICAgICAgIF9iZXN0ID0gX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChzZWdtZW50c1tpXSA9PT0gIjAiKSB7CiAgICAgICAgICAgICAgICBpbnplcm9lcyA9IHRydWU7CiAgICAgICAgICAgICAgICBjdXJyZW50ID0gaTsKICAgICAgICAgICAgICAgIF9jdXJyZW50ID0gMTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChfY3VycmVudCA+IF9iZXN0KSB7CiAgICAgICAgICAgIGJlc3QgPSBjdXJyZW50OwogICAgICAgICAgICBfYmVzdCA9IF9jdXJyZW50OwogICAgICAgICAgfQogICAgICAgICAgaWYgKF9iZXN0ID4gMSkgewogICAgICAgICAgICBzZWdtZW50cy5zcGxpY2UoYmVzdCwgX2Jlc3QsICIiKTsKICAgICAgICAgIH0KICAgICAgICAgIGxlbmd0aCA9IHNlZ21lbnRzLmxlbmd0aDsKICAgICAgICAgIHZhciByZXN1bHQgPSAiIjsKICAgICAgICAgIGlmIChzZWdtZW50c1swXSA9PT0gIiIpIHsKICAgICAgICAgICAgcmVzdWx0ID0gIjoiOwogICAgICAgICAgfQogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHJlc3VsdCArPSBzZWdtZW50c1tpXTsKICAgICAgICAgICAgaWYgKGkgPT09IGxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXN1bHQgKz0gIjoiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNlZ21lbnRzW2xlbmd0aCAtIDFdID09PSAiIikgewogICAgICAgICAgICByZXN1bHQgKz0gIjoiOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbm9Db25mbGljdCgpIHsKICAgICAgICAgIGlmIChyb290LklQdjYgPT09IHRoaXMpIHsKICAgICAgICAgICAgcm9vdC5JUHY2ID0gX0lQdjY7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGJlc3Q6IGJlc3RQcmVzZW50YXRpb24sCiAgICAgICAgICBub0NvbmZsaWN0CiAgICAgICAgfTsKICAgICAgfSk7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy91cmlqcy9zcmMvU2Vjb25kTGV2ZWxEb21haW5zLmpzCiAgdmFyIHJlcXVpcmVfU2Vjb25kTGV2ZWxEb21haW5zID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3VyaWpzL3NyYy9TZWNvbmRMZXZlbERvbWFpbnMuanMiKGV4cG9ydHMyLCBtb2R1bGUpIHsKICAgICAgLyohCiAgICAgICAqIFVSSS5qcyAtIE11dGF0aW5nIFVSTHMKICAgICAgICogU2Vjb25kIExldmVsIERvbWFpbiAoU0xEKSBTdXBwb3J0CiAgICAgICAqCiAgICAgICAqIFZlcnNpb246IDEuMTkuMTEKICAgICAgICoKICAgICAgICogQXV0aG9yOiBSb2RuZXkgUmVobQogICAgICAgKiBXZWI6IGh0dHA6Ly9tZWRpYWxpemUuZ2l0aHViLmlvL1VSSS5qcy8KICAgICAgICoKICAgICAgICogTGljZW5zZWQgdW5kZXIKICAgICAgICogICBNSVQgTGljZW5zZSBodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlCiAgICAgICAqCiAgICAgICAqLwogICAgICAoZnVuY3Rpb24ocm9vdCwgZmFjdG9yeSkgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICBpZiAodHlwZW9mIG1vZHVsZSA9PT0gIm9iamVjdCIgJiYgbW9kdWxlLmV4cG9ydHMpIHsKICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgICBkZWZpbmUoZmFjdG9yeSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJvb3QuU2Vjb25kTGV2ZWxEb21haW5zID0gZmFjdG9yeShyb290KTsKICAgICAgICB9CiAgICAgIH0pKGV4cG9ydHMyLCBmdW5jdGlvbihyb290KSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciBfU2Vjb25kTGV2ZWxEb21haW5zID0gcm9vdCAmJiByb290LlNlY29uZExldmVsRG9tYWluczsKICAgICAgICB2YXIgU0xEID0gewogICAgICAgICAgLy8gbGlzdCBvZiBrbm93biBTZWNvbmQgTGV2ZWwgRG9tYWlucwogICAgICAgICAgLy8gY29udmVydGVkIGxpc3Qgb2YgU0xEcyBmcm9tIGh0dHBzOi8vZ2l0aHViLmNvbS9nYXZpbmdtaWxsZXIvc2Vjb25kLWxldmVsLWRvbWFpbnMKICAgICAgICAgIC8vIC0tLS0KICAgICAgICAgIC8vIHB1YmxpY3N1ZmZpeC5vcmcgaXMgbW9yZSBjdXJyZW50IGFuZCBhY3R1YWxseSB1c2VkIGJ5IGEgY291cGxlIG9mIGJyb3dzZXJzIGludGVybmFsbHkuCiAgICAgICAgICAvLyBkb3duc2lkZSBpcyBpdCBhbHNvIGNvbnRhaW5zIGRvbWFpbnMgbGlrZSAiZHluZG5zLm9yZyIgLSB3aGljaCBpcyBmaW5lIGZvciB0aGUgc2VjdXJpdHkKICAgICAgICAgIC8vIGlzc3VlcyBicm93c2VyIGhhdmUgdG8gZGVhbCB3aXRoIChTT1AgZm9yIGNvb2tpZXMsIGV0YykgLSBidXQgaXMgd2F5IG92ZXJib2FyZCBmb3IgVVJJLmpzCiAgICAgICAgICAvLyAtLS0tCiAgICAgICAgICBsaXN0OiB7CiAgICAgICAgICAgICJhYyI6ICIgY29tIGdvdiBtaWwgbmV0IG9yZyAiLAogICAgICAgICAgICAiYWUiOiAiIGFjIGNvIGdvdiBtaWwgbmFtZSBuZXQgb3JnIHBybyBzY2ggIiwKICAgICAgICAgICAgImFmIjogIiBjb20gZWR1IGdvdiBuZXQgb3JnICIsCiAgICAgICAgICAgICJhbCI6ICIgY29tIGVkdSBnb3YgbWlsIG5ldCBvcmcgIiwKICAgICAgICAgICAgImFvIjogIiBjbyBlZCBndiBpdCBvZyBwYiAiLAogICAgICAgICAgICAiYXIiOiAiIGNvbSBlZHUgZ29iIGdvdiBpbnQgbWlsIG5ldCBvcmcgdHVyICIsCiAgICAgICAgICAgICJhdCI6ICIgYWMgY28gZ3Ygb3IgIiwKICAgICAgICAgICAgImF1IjogIiBhc24gY29tIGNzaXJvIGVkdSBnb3YgaWQgbmV0IG9yZyAiLAogICAgICAgICAgICAiYmEiOiAiIGNvIGNvbSBlZHUgZ292IG1pbCBuZXQgb3JnIHJzIHVuYmkgdW5tbyB1bnNhIHVudHogdW56ZSAiLAogICAgICAgICAgICAiYmIiOiAiIGJpeiBjbyBjb20gZWR1IGdvdiBpbmZvIG5ldCBvcmcgc3RvcmUgdHYgIiwKICAgICAgICAgICAgImJoIjogIiBiaXogY2MgY29tIGVkdSBnb3YgaW5mbyBuZXQgb3JnICIsCiAgICAgICAgICAgICJibiI6ICIgY29tIGVkdSBnb3YgbmV0IG9yZyAiLAogICAgICAgICAgICAiYm8iOiAiIGNvbSBlZHUgZ29iIGdvdiBpbnQgbWlsIG5ldCBvcmcgdHYgIiwKICAgICAgICAgICAgImJyIjogIiBhZG0gYWR2IGFnciBhbSBhcnEgYXJ0IGF0byBiIGJpbyBibG9nIGJtZCBjaW0gY25nIGNudCBjb20gY29vcCBlY24gZWR1IGVuZyBlc3AgZXRjIGV0aSBmYXIgZmxvZyBmbSBmbmQgZm90IGZzdCBnMTIgZ2dmIGdvdiBpbWIgaW5kIGluZiBqb3IganVzIGxlbCBtYXQgbWVkIG1pbCBtdXMgbmV0IG5vbSBub3QgbnRyIG9kbyBvcmcgcHBnIHBybyBwc2MgcHNpIHFzbCByZWMgc2xnIHNydiB0bXAgdHJkIHR1ciB0diB2ZXQgdmxvZyB3aWtpIHpsZyAiLAogICAgICAgICAgICAiYnMiOiAiIGNvbSBlZHUgZ292IG5ldCBvcmcgIiwKICAgICAgICAgICAgImJ6IjogIiBkdSBldCBvbSBvdiByZyAiLAogICAgICAgICAgICAiY2EiOiAiIGFiIGJjIG1iIG5iIG5mIG5sIG5zIG50IG51IG9uIHBlIHFjIHNrIHlrICIsCiAgICAgICAgICAgICJjayI6ICIgYml6IGNvIGVkdSBnZW4gZ292IGluZm8gbmV0IG9yZyAiLAogICAgICAgICAgICAiY24iOiAiIGFjIGFoIGJqIGNvbSBjcSBlZHUgZmogZ2QgZ292IGdzIGd4IGd6IGhhIGhiIGhlIGhpIGhsIGhuIGpsIGpzIGp4IGxuIG1pbCBuZXQgbm0gbnggb3JnIHFoIHNjIHNkIHNoIHNuIHN4IHRqIHR3IHhqIHh6IHluIHpqICIsCiAgICAgICAgICAgICJjbyI6ICIgY29tIGVkdSBnb3YgbWlsIG5ldCBub20gb3JnICIsCiAgICAgICAgICAgICJjciI6ICIgYWMgYyBjbyBlZCBmaSBnbyBvciBzYSAiLAogICAgICAgICAgICAiY3kiOiAiIGFjIGJpeiBjb20gZWtsb2dlcyBnb3YgbHRkIG5hbWUgbmV0IG9yZyBwYXJsaWFtZW50IHByZXNzIHBybyB0bSAiLAogICAgICAgICAgICAiZG8iOiAiIGFydCBjb20gZWR1IGdvYiBnb3YgbWlsIG5ldCBvcmcgc2xkIHdlYiAiLAogICAgICAgICAgICAiZHoiOiAiIGFydCBhc3NvIGNvbSBlZHUgZ292IG5ldCBvcmcgcG9sICIsCiAgICAgICAgICAgICJlYyI6ICIgY29tIGVkdSBmaW4gZ292IGluZm8gbWVkIG1pbCBuZXQgb3JnIHBybyAiLAogICAgICAgICAgICAiZWciOiAiIGNvbSBlZHUgZXVuIGdvdiBtaWwgbmFtZSBuZXQgb3JnIHNjaSAiLAogICAgICAgICAgICAiZXIiOiAiIGNvbSBlZHUgZ292IGluZCBtaWwgbmV0IG9yZyByb2NoZXN0IHcgIiwKICAgICAgICAgICAgImVzIjogIiBjb20gZWR1IGdvYiBub20gb3JnICIsCiAgICAgICAgICAgICJldCI6ICIgYml6IGNvbSBlZHUgZ292IGluZm8gbmFtZSBuZXQgb3JnICIsCiAgICAgICAgICAgICJmaiI6ICIgYWMgYml6IGNvbSBpbmZvIG1pbCBuYW1lIG5ldCBvcmcgcHJvICIsCiAgICAgICAgICAgICJmayI6ICIgYWMgY28gZ292IG5ldCBub20gb3JnICIsCiAgICAgICAgICAgICJmciI6ICIgYXNzbyBjb20gZiBnb3V2IG5vbSBwcmQgcHJlc3NlIHRtICIsCiAgICAgICAgICAgICJnZyI6ICIgY28gbmV0IG9yZyAiLAogICAgICAgICAgICAiZ2giOiAiIGNvbSBlZHUgZ292IG1pbCBvcmcgIiwKICAgICAgICAgICAgImduIjogIiBhYyBjb20gZ292IG5ldCBvcmcgIiwKICAgICAgICAgICAgImdyIjogIiBjb20gZWR1IGdvdiBtaWwgbmV0IG9yZyAiLAogICAgICAgICAgICAiZ3QiOiAiIGNvbSBlZHUgZ29iIGluZCBtaWwgbmV0IG9yZyAiLAogICAgICAgICAgICAiZ3UiOiAiIGNvbSBlZHUgZ292IG5ldCBvcmcgIiwKICAgICAgICAgICAgImhrIjogIiBjb20gZWR1IGdvdiBpZHYgbmV0IG9yZyAiLAogICAgICAgICAgICAiaHUiOiAiIDIwMDAgYWdyYXIgYm9sdCBjYXNpbm8gY2l0eSBjbyBlcm90aWNhIGVyb3Rpa2EgZmlsbSBmb3J1bSBnYW1lcyBob3RlbCBpbmZvIGluZ2F0bGFuIGpvZ2FzeiBrb255dmVsbyBsYWthcyBtZWRpYSBuZXdzIG9yZyBwcml2IHJla2xhbSBzZXggc2hvcCBzcG9ydCBzdWxpIHN6ZXggdG0gdG96c2RlIHV0YXphcyB2aWRlbyAiLAogICAgICAgICAgICAiaWQiOiAiIGFjIGNvIGdvIG1pbCBuZXQgb3Igc2NoIHdlYiAiLAogICAgICAgICAgICAiaWwiOiAiIGFjIGNvIGdvdiBpZGYgazEyIG11bmkgbmV0IG9yZyAiLAogICAgICAgICAgICAiaW4iOiAiIGFjIGNvIGVkdSBlcm5ldCBmaXJtIGdlbiBnb3YgaSBpbmQgbWlsIG5ldCBuaWMgb3JnIHJlcyAiLAogICAgICAgICAgICAiaXEiOiAiIGNvbSBlZHUgZ292IGkgbWlsIG5ldCBvcmcgIiwKICAgICAgICAgICAgImlyIjogIiBhYyBjbyBkbnNzZWMgZ292IGkgaWQgbmV0IG9yZyBzY2ggIiwKICAgICAgICAgICAgIml0IjogIiBlZHUgZ292ICIsCiAgICAgICAgICAgICJqZSI6ICIgY28gbmV0IG9yZyAiLAogICAgICAgICAgICAiam8iOiAiIGNvbSBlZHUgZ292IG1pbCBuYW1lIG5ldCBvcmcgc2NoICIsCiAgICAgICAgICAgICJqcCI6ICIgYWMgYWQgY28gZWQgZ28gZ3IgbGcgbmUgb3IgIiwKICAgICAgICAgICAgImtlIjogIiBhYyBjbyBnbyBpbmZvIG1lIG1vYmkgbmUgb3Igc2MgIiwKICAgICAgICAgICAgImtoIjogIiBjb20gZWR1IGdvdiBtaWwgbmV0IG9yZyBwZXIgIiwKICAgICAgICAgICAgImtpIjogIiBiaXogY29tIGRlIGVkdSBnb3YgaW5mbyBtb2IgbmV0IG9yZyB0ZWwgIiwKICAgICAgICAgICAgImttIjogIiBhc3NvIGNvbSBjb29wIGVkdSBnb3V2IGsgbWVkZWNpbiBtaWwgbm9tIG5vdGFpcmVzIHBoYXJtYWNpZW5zIHByZXNzZSB0bSB2ZXRlcmluYWlyZSAiLAogICAgICAgICAgICAia24iOiAiIGVkdSBnb3YgbmV0IG9yZyAiLAogICAgICAgICAgICAia3IiOiAiIGFjIGJ1c2FuIGNodW5nYnVrIGNodW5nbmFtIGNvIGRhZWd1IGRhZWplb24gZXMgZ2FuZ3dvbiBnbyBnd2FuZ2p1IGd5ZW9uZ2J1ayBneWVvbmdnaSBneWVvbmduYW0gaHMgaW5jaGVvbiBqZWp1IGplb25idWsgamVvbm5hbSBrIGtnIG1pbCBtcyBuZSBvciBwZSByZSBzYyBzZW91bCB1bHNhbiAiLAogICAgICAgICAgICAia3ciOiAiIGNvbSBlZHUgZ292IG5ldCBvcmcgIiwKICAgICAgICAgICAgImt5IjogIiBjb20gZWR1IGdvdiBuZXQgb3JnICIsCiAgICAgICAgICAgICJreiI6ICIgY29tIGVkdSBnb3YgbWlsIG5ldCBvcmcgIiwKICAgICAgICAgICAgImxiIjogIiBjb20gZWR1IGdvdiBuZXQgb3JnICIsCiAgICAgICAgICAgICJsayI6ICIgYXNzbiBjb20gZWR1IGdvdiBncnAgaG90ZWwgaW50IGx0ZCBuZXQgbmdvIG9yZyBzY2ggc29jIHdlYiAiLAogICAgICAgICAgICAibHIiOiAiIGNvbSBlZHUgZ292IG5ldCBvcmcgIiwKICAgICAgICAgICAgImx2IjogIiBhc24gY29tIGNvbmYgZWR1IGdvdiBpZCBtaWwgbmV0IG9yZyAiLAogICAgICAgICAgICAibHkiOiAiIGNvbSBlZHUgZ292IGlkIG1lZCBuZXQgb3JnIHBsYyBzY2ggIiwKICAgICAgICAgICAgIm1hIjogIiBhYyBjbyBnb3YgbSBuZXQgb3JnIHByZXNzICIsCiAgICAgICAgICAgICJtYyI6ICIgYXNzbyB0bSAiLAogICAgICAgICAgICAibWUiOiAiIGFjIGNvIGVkdSBnb3YgaXRzIG5ldCBvcmcgcHJpdiAiLAogICAgICAgICAgICAibWciOiAiIGNvbSBlZHUgZ292IG1pbCBub20gb3JnIHByZCB0bSAiLAogICAgICAgICAgICAibWsiOiAiIGNvbSBlZHUgZ292IGluZiBuYW1lIG5ldCBvcmcgcHJvICIsCiAgICAgICAgICAgICJtbCI6ICIgY29tIGVkdSBnb3YgbmV0IG9yZyBwcmVzc2UgIiwKICAgICAgICAgICAgIm1uIjogIiBlZHUgZ292IG9yZyAiLAogICAgICAgICAgICAibW8iOiAiIGNvbSBlZHUgZ292IG5ldCBvcmcgIiwKICAgICAgICAgICAgIm10IjogIiBjb20gZWR1IGdvdiBuZXQgb3JnICIsCiAgICAgICAgICAgICJtdiI6ICIgYWVybyBiaXogY29tIGNvb3AgZWR1IGdvdiBpbmZvIGludCBtaWwgbXVzZXVtIG5hbWUgbmV0IG9yZyBwcm8gIiwKICAgICAgICAgICAgIm13IjogIiBhYyBjbyBjb20gY29vcCBlZHUgZ292IGludCBtdXNldW0gbmV0IG9yZyAiLAogICAgICAgICAgICAibXgiOiAiIGNvbSBlZHUgZ29iIG5ldCBvcmcgIiwKICAgICAgICAgICAgIm15IjogIiBjb20gZWR1IGdvdiBtaWwgbmFtZSBuZXQgb3JnIHNjaCAiLAogICAgICAgICAgICAibmYiOiAiIGFydHMgY29tIGZpcm0gaW5mbyBuZXQgb3RoZXIgcGVyIHJlYyBzdG9yZSB3ZWIgIiwKICAgICAgICAgICAgIm5nIjogIiBiaXogY29tIGVkdSBnb3YgbWlsIG1vYmkgbmFtZSBuZXQgb3JnIHNjaCAiLAogICAgICAgICAgICAibmkiOiAiIGFjIGNvIGNvbSBlZHUgZ29iIG1pbCBuZXQgbm9tIG9yZyAiLAogICAgICAgICAgICAibnAiOiAiIGNvbSBlZHUgZ292IG1pbCBuZXQgb3JnICIsCiAgICAgICAgICAgICJuciI6ICIgYml6IGNvbSBlZHUgZ292IGluZm8gbmV0IG9yZyAiLAogICAgICAgICAgICAib20iOiAiIGFjIGJpeiBjbyBjb20gZWR1IGdvdiBtZWQgbWlsIG11c2V1bSBuZXQgb3JnIHBybyBzY2ggIiwKICAgICAgICAgICAgInBlIjogIiBjb20gZWR1IGdvYiBtaWwgbmV0IG5vbSBvcmcgc2xkICIsCiAgICAgICAgICAgICJwaCI6ICIgY29tIGVkdSBnb3YgaSBtaWwgbmV0IG5nbyBvcmcgIiwKICAgICAgICAgICAgInBrIjogIiBiaXogY29tIGVkdSBmYW0gZ29iIGdvayBnb24gZ29wIGdvcyBnb3YgbmV0IG9yZyB3ZWIgIiwKICAgICAgICAgICAgInBsIjogIiBhcnQgYmlhbHlzdG9rIGJpeiBjb20gZWR1IGdkYSBnZGFuc2sgZ29yem93IGdvdiBpbmZvIGthdG93aWNlIGtyYWtvdyBsb2R6IGx1YmxpbiBtaWwgbmV0IG5nbyBvbHN6dHluIG9yZyBwb3puYW4gcHdyIHJhZG9tIHNsdXBzayBzemN6ZWNpbiB0b3J1biB3YXJzemF3YSB3YXcgd3JvYyB3cm9jbGF3IHpnb3JhICIsCiAgICAgICAgICAgICJwciI6ICIgYWMgYml6IGNvbSBlZHUgZXN0IGdvdiBpbmZvIGlzbGEgbmFtZSBuZXQgb3JnIHBybyBwcm9mICIsCiAgICAgICAgICAgICJwcyI6ICIgY29tIGVkdSBnb3YgbmV0IG9yZyBwbG8gc2VjICIsCiAgICAgICAgICAgICJwdyI6ICIgYmVsYXUgY28gZWQgZ28gbmUgb3IgIiwKICAgICAgICAgICAgInJvIjogIiBhcnRzIGNvbSBmaXJtIGluZm8gbm9tIG50IG9yZyByZWMgc3RvcmUgdG0gd3d3ICIsCiAgICAgICAgICAgICJycyI6ICIgYWMgY28gZWR1IGdvdiBpbiBvcmcgIiwKICAgICAgICAgICAgInNiIjogIiBjb20gZWR1IGdvdiBuZXQgb3JnICIsCiAgICAgICAgICAgICJzYyI6ICIgY29tIGVkdSBnb3YgbmV0IG9yZyAiLAogICAgICAgICAgICAic2giOiAiIGNvIGNvbSBlZHUgZ292IG5ldCBub20gb3JnICIsCiAgICAgICAgICAgICJzbCI6ICIgY29tIGVkdSBnb3YgbmV0IG9yZyAiLAogICAgICAgICAgICAic3QiOiAiIGNvIGNvbSBjb25zdWxhZG8gZWR1IGVtYmFpeGFkYSBnb3YgbWlsIG5ldCBvcmcgcHJpbmNpcGUgc2FvdG9tZSBzdG9yZSAiLAogICAgICAgICAgICAic3YiOiAiIGNvbSBlZHUgZ29iIG9yZyByZWQgIiwKICAgICAgICAgICAgInN6IjogIiBhYyBjbyBvcmcgIiwKICAgICAgICAgICAgInRyIjogIiBhdiBiYnMgYmVsIGJpeiBjb20gZHIgZWR1IGdlbiBnb3YgaW5mbyBrMTIgbmFtZSBuZXQgb3JnIHBvbCB0ZWwgdHNrIHR2IHdlYiAiLAogICAgICAgICAgICAidHQiOiAiIGFlcm8gYml6IGNhdCBjbyBjb20gY29vcCBlZHUgZ292IGluZm8gaW50IGpvYnMgbWlsIG1vYmkgbXVzZXVtIG5hbWUgbmV0IG9yZyBwcm8gdGVsIHRyYXZlbCAiLAogICAgICAgICAgICAidHciOiAiIGNsdWIgY29tIGViaXogZWR1IGdhbWUgZ292IGlkdiBtaWwgbmV0IG9yZyAiLAogICAgICAgICAgICAibXUiOiAiIGFjIGNvIGNvbSBnb3YgbmV0IG9yIG9yZyAiLAogICAgICAgICAgICAibXoiOiAiIGFjIGNvIGVkdSBnb3Ygb3JnICIsCiAgICAgICAgICAgICJuYSI6ICIgY28gY29tICIsCiAgICAgICAgICAgICJueiI6ICIgYWMgY28gY3JpIGdlZWsgZ2VuIGdvdnQgaGVhbHRoIGl3aSBtYW9yaSBtaWwgbmV0IG9yZyBwYXJsaWFtZW50IHNjaG9vbCAiLAogICAgICAgICAgICAicGEiOiAiIGFibyBhYyBjb20gZWR1IGdvYiBpbmcgbWVkIG5ldCBub20gb3JnIHNsZCAiLAogICAgICAgICAgICAicHQiOiAiIGNvbSBlZHUgZ292IGludCBuZXQgbm9tZSBvcmcgcHVibCAiLAogICAgICAgICAgICAicHkiOiAiIGNvbSBlZHUgZ292IG1pbCBuZXQgb3JnICIsCiAgICAgICAgICAgICJxYSI6ICIgY29tIGVkdSBnb3YgbWlsIG5ldCBvcmcgIiwKICAgICAgICAgICAgInJlIjogIiBhc3NvIGNvbSBub20gIiwKICAgICAgICAgICAgInJ1IjogIiBhYyBhZHlnZXlhIGFsdGFpIGFtdXIgYXJraGFuZ2Vsc2sgYXN0cmFraGFuIGJhc2hraXJpYSBiZWxnb3JvZCBiaXIgYnJ5YW5zayBidXJ5YXRpYSBjYmcgY2hlbCBjaGVseWFiaW5zayBjaGl0YSBjaHVrb3RrYSBjaHV2YXNoaWEgY29tIGRhZ2VzdGFuIGUtYnVyZyBlZHUgZ292IGdyb3pueSBpbnQgaXJrdXRzayBpdmFub3ZvIGl6aGV2c2sgamFyIGpvc2hrYXItb2xhIGthbG15a2lhIGthbHVnYSBrYW1jaGF0a2Ega2FyZWxpYSBrYXphbiBrY2hyIGtlbWVyb3ZvIGtoYWJhcm92c2sga2hha2Fzc2lhIGtodiBraXJvdiBrb2VuaWcga29taSBrb3N0cm9tYSBrcmFub3lhcnNrIGt1YmFuIGt1cmdhbiBrdXJzayBsaXBldHNrIG1hZ2FkYW4gbWFyaSBtYXJpLWVsIG1hcmluZSBtaWwgbW9yZG92aWEgbW9zcmVnIG1zayBtdXJtYW5zayBuYWxjaGlrIG5ldCBubm92IG5vdiBub3Zvc2liaXJzayBuc2sgb21zayBvcmVuYnVyZyBvcmcgb3J5b2wgcGVuemEgcGVybSBwcCBwc2tvdiBwdHogcm5kIHJ5YXphbiBzYWtoYWxpbiBzYW1hcmEgc2FyYXRvdiBzaW1iaXJzayBzbW9sZW5zayBzcGIgc3RhdnJvcG9sIHN0diBzdXJndXQgdGFtYm92IHRhdGFyc3RhbiB0b20gdG9tc2sgdHNhcml0c3luIHRzayB0dWxhIHR1dmEgdHZlciB0eXVtZW4gdWRtIHVkbXVydGlhIHVsYW4tdWRlIHZsYWRpa2F2a2F6IHZsYWRpbWlyIHZsYWRpdm9zdG9rIHZvbGdvZ3JhZCB2b2xvZ2RhIHZvcm9uZXpoIHZybiB2eWF0a2EgeWFrdXRpYSB5YW1hbCB5ZWthdGVyaW5idXJnIHl1emhuby1zYWtoYWxpbnNrICIsCiAgICAgICAgICAgICJydyI6ICIgYWMgY28gY29tIGVkdSBnb3V2IGdvdiBpbnQgbWlsIG5ldCAiLAogICAgICAgICAgICAic2EiOiAiIGNvbSBlZHUgZ292IG1lZCBuZXQgb3JnIHB1YiBzY2ggIiwKICAgICAgICAgICAgInNkIjogIiBjb20gZWR1IGdvdiBpbmZvIG1lZCBuZXQgb3JnIHR2ICIsCiAgICAgICAgICAgICJzZSI6ICIgYSBhYyBiIGJkIGMgZCBlIGYgZyBoIGkgayBsIG0gbiBvIG9yZyBwIHBhcnRpIHBwIHByZXNzIHIgcyB0IHRtIHUgdyB4IHkgeiAiLAogICAgICAgICAgICAic2ciOiAiIGNvbSBlZHUgZ292IGlkbiBuZXQgb3JnIHBlciAiLAogICAgICAgICAgICAic24iOiAiIGFydCBjb20gZWR1IGdvdXYgb3JnIHBlcnNvIHVuaXYgIiwKICAgICAgICAgICAgInN5IjogIiBjb20gZWR1IGdvdiBtaWwgbmV0IG5ld3Mgb3JnICIsCiAgICAgICAgICAgICJ0aCI6ICIgYWMgY28gZ28gaW4gbWkgbmV0IG9yICIsCiAgICAgICAgICAgICJ0aiI6ICIgYWMgYml6IGNvIGNvbSBlZHUgZ28gZ292IGluZm8gaW50IG1pbCBuYW1lIG5ldCBuaWMgb3JnIHRlc3Qgd2ViICIsCiAgICAgICAgICAgICJ0biI6ICIgYWdyaW5ldCBjb20gZGVmZW5zZSBlZHVuZXQgZW5zIGZpbiBnb3YgaW5kIGluZm8gaW50bCBtaW5jb20gbmF0IG5ldCBvcmcgcGVyc28gcm5ydCBybnMgcm51IHRvdXJpc20gIiwKICAgICAgICAgICAgInR6IjogIiBhYyBjbyBnbyBuZSBvciAiLAogICAgICAgICAgICAidWEiOiAiIGJpeiBjaGVya2Fzc3kgY2hlcm5pZ292IGNoZXJub3Z0c3kgY2sgY24gY28gY29tIGNyaW1lYSBjdiBkbiBkbmVwcm9wZXRyb3ZzayBkb25ldHNrIGRwIGVkdSBnb3YgaWYgaW4gaXZhbm8tZnJhbmtpdnNrIGtoIGtoYXJrb3Yga2hlcnNvbiBraG1lbG5pdHNraXkga2lldiBraXJvdm9ncmFkIGttIGtyIGtzIGt2IGxnIGx1Z2Fuc2sgbHV0c2sgbHZpdiBtZSBtayBuZXQgbmlrb2xhZXYgb2Qgb2Rlc3NhIG9yZyBwbCBwb2x0YXZhIHBwIHJvdm5vIHJ2IHNlYmFzdG9wb2wgc3VteSB0ZSB0ZXJub3BpbCB1emhnb3JvZCB2aW5uaWNhIHZuIHphcG9yaXpoemhlIHpoaXRvbWlyIHpwIHp0ICIsCiAgICAgICAgICAgICJ1ZyI6ICIgYWMgY28gZ28gbmUgb3Igb3JnIHNjICIsCiAgICAgICAgICAgICJ1ayI6ICIgYWMgYmwgYnJpdGlzaC1saWJyYXJ5IGNvIGN5bSBnb3YgZ292dCBpY25ldCBqZXQgbGVhIGx0ZCBtZSBtaWwgbW9kIG5hdGlvbmFsLWxpYnJhcnktc2NvdGxhbmQgbmVsIG5ldCBuaHMgbmljIG5scyBvcmcgb3JnbiBwYXJsaWFtZW50IHBsYyBwb2xpY2Ugc2NoIHNjb3Qgc29jICIsCiAgICAgICAgICAgICJ1cyI6ICIgZG5pIGZlZCBpc2Ega2lkcyBuc24gIiwKICAgICAgICAgICAgInV5IjogIiBjb20gZWR1IGd1YiBtaWwgbmV0IG9yZyAiLAogICAgICAgICAgICAidmUiOiAiIGNvIGNvbSBlZHUgZ29iIGluZm8gbWlsIG5ldCBvcmcgd2ViICIsCiAgICAgICAgICAgICJ2aSI6ICIgY28gY29tIGsxMiBuZXQgb3JnICIsCiAgICAgICAgICAgICJ2biI6ICIgYWMgYml6IGNvbSBlZHUgZ292IGhlYWx0aCBpbmZvIGludCBuYW1lIG5ldCBvcmcgcHJvICIsCiAgICAgICAgICAgICJ5ZSI6ICIgY28gY29tIGdvdiBsdGQgbWUgbmV0IG9yZyBwbGMgIiwKICAgICAgICAgICAgInl1IjogIiBhYyBjbyBlZHUgZ292IG9yZyAiLAogICAgICAgICAgICAiemEiOiAiIGFjIGFncmljIGFsdCBib3Vyc2UgY2l0eSBjbyBjeWJlcm5ldCBkYiBlZHUgZ292IGdyb25kYXIgaWFjY2VzcyBpbXQgaW5jYSBsYW5kZXNpZ24gbGF3IG1pbCBuZXQgbmdvIG5pcyBub20gb2xpdmV0dGkgb3JnIHBpeCBzY2hvb2wgdG0gd2ViICIsCiAgICAgICAgICAgICJ6bSI6ICIgYWMgY28gY29tIGVkdSBnb3YgbmV0IG9yZyBzY2ggIiwKICAgICAgICAgICAgLy8gaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ2VudHJhbE5pYyNTZWNvbmQtbGV2ZWxfZG9tYWlucwogICAgICAgICAgICAiY29tIjogImFyIGJyIGNuIGRlIGV1IGdiIGdyIGh1IGpwbiBrciBubyBxYyBydSBzYSBzZSB1ayB1cyB1eSB6YSAiLAogICAgICAgICAgICAibmV0IjogImdiIGpwIHNlIHVrICIsCiAgICAgICAgICAgICJvcmciOiAiYWUiLAogICAgICAgICAgICAiZGUiOiAiY29tICIKICAgICAgICAgIH0sCiAgICAgICAgICAvLyBnb3JoaWxsIDIwMTMtMTAtMjU6IFVzaW5nIGluZGV4T2YoKSBpbnN0ZWFkIFJlZ2V4cCgpLiBTaWduaWZpY2FudCBib29zdAogICAgICAgICAgLy8gaW4gYm90aCBwZXJmb3JtYW5jZSBhbmQgbWVtb3J5IGZvb3RwcmludC4gTm8gaW5pdGlhbGl6YXRpb24gcmVxdWlyZWQuCiAgICAgICAgICAvLyBodHRwOi8vanNwZXJmLmNvbS91cmktanMtc2xkLXJlZ2V4LXZzLWJpbmFyeS1zZWFyY2gvNAogICAgICAgICAgLy8gRm9sbG93aW5nIG1ldGhvZHMgdXNlIGxhc3RJbmRleE9mKCkgcmF0aGVyIHRoYW4gYXJyYXkuc3BsaXQoKSBpbiBvcmRlcgogICAgICAgICAgLy8gdG8gYXZvaWQgYW55IG1lbW9yeSBhbGxvY2F0aW9ucy4KICAgICAgICAgIGhhczogZnVuY3Rpb24oZG9tYWluKSB7CiAgICAgICAgICAgIHZhciB0bGRPZmZzZXQgPSBkb21haW4ubGFzdEluZGV4T2YoIi4iKTsKICAgICAgICAgICAgaWYgKHRsZE9mZnNldCA8PSAwIHx8IHRsZE9mZnNldCA+PSBkb21haW4ubGVuZ3RoIC0gMSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2xkT2Zmc2V0ID0gZG9tYWluLmxhc3RJbmRleE9mKCIuIiwgdGxkT2Zmc2V0IC0gMSk7CiAgICAgICAgICAgIGlmIChzbGRPZmZzZXQgPD0gMCB8fCBzbGRPZmZzZXQgPj0gdGxkT2Zmc2V0IC0gMSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2xkTGlzdCA9IFNMRC5saXN0W2RvbWFpbi5zbGljZSh0bGRPZmZzZXQgKyAxKV07CiAgICAgICAgICAgIGlmICghc2xkTGlzdCkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc2xkTGlzdC5pbmRleE9mKCIgIiArIGRvbWFpbi5zbGljZShzbGRPZmZzZXQgKyAxLCB0bGRPZmZzZXQpICsgIiAiKSA+PSAwOwogICAgICAgICAgfSwKICAgICAgICAgIGlzOiBmdW5jdGlvbihkb21haW4pIHsKICAgICAgICAgICAgdmFyIHRsZE9mZnNldCA9IGRvbWFpbi5sYXN0SW5kZXhPZigiLiIpOwogICAgICAgICAgICBpZiAodGxkT2Zmc2V0IDw9IDAgfHwgdGxkT2Zmc2V0ID49IGRvbWFpbi5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzbGRPZmZzZXQgPSBkb21haW4ubGFzdEluZGV4T2YoIi4iLCB0bGRPZmZzZXQgLSAxKTsKICAgICAgICAgICAgaWYgKHNsZE9mZnNldCA+PSAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzbGRMaXN0ID0gU0xELmxpc3RbZG9tYWluLnNsaWNlKHRsZE9mZnNldCArIDEpXTsKICAgICAgICAgICAgaWYgKCFzbGRMaXN0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzbGRMaXN0LmluZGV4T2YoIiAiICsgZG9tYWluLnNsaWNlKDAsIHRsZE9mZnNldCkgKyAiICIpID49IDA7CiAgICAgICAgICB9LAogICAgICAgICAgZ2V0OiBmdW5jdGlvbihkb21haW4pIHsKICAgICAgICAgICAgdmFyIHRsZE9mZnNldCA9IGRvbWFpbi5sYXN0SW5kZXhPZigiLiIpOwogICAgICAgICAgICBpZiAodGxkT2Zmc2V0IDw9IDAgfHwgdGxkT2Zmc2V0ID49IGRvbWFpbi5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNsZE9mZnNldCA9IGRvbWFpbi5sYXN0SW5kZXhPZigiLiIsIHRsZE9mZnNldCAtIDEpOwogICAgICAgICAgICBpZiAoc2xkT2Zmc2V0IDw9IDAgfHwgc2xkT2Zmc2V0ID49IHRsZE9mZnNldCAtIDEpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2xkTGlzdCA9IFNMRC5saXN0W2RvbWFpbi5zbGljZSh0bGRPZmZzZXQgKyAxKV07CiAgICAgICAgICAgIGlmICghc2xkTGlzdCkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzbGRMaXN0LmluZGV4T2YoIiAiICsgZG9tYWluLnNsaWNlKHNsZE9mZnNldCArIDEsIHRsZE9mZnNldCkgKyAiICIpIDwgMCkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkb21haW4uc2xpY2Uoc2xkT2Zmc2V0ICsgMSk7CiAgICAgICAgICB9LAogICAgICAgICAgbm9Db25mbGljdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmIChyb290LlNlY29uZExldmVsRG9tYWlucyA9PT0gdGhpcykgewogICAgICAgICAgICAgIHJvb3QuU2Vjb25kTGV2ZWxEb21haW5zID0gX1NlY29uZExldmVsRG9tYWluczsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHJldHVybiBTTEQ7CiAgICAgIH0pOwogICAgfQogIH0pOwoKICAvLyBub2RlX21vZHVsZXMvdXJpanMvc3JjL1VSSS5qcwogIHZhciByZXF1aXJlX1VSSSA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy91cmlqcy9zcmMvVVJJLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgIC8qIQogICAgICAgKiBVUkkuanMgLSBNdXRhdGluZyBVUkxzCiAgICAgICAqCiAgICAgICAqIFZlcnNpb246IDEuMTkuMTEKICAgICAgICoKICAgICAgICogQXV0aG9yOiBSb2RuZXkgUmVobQogICAgICAgKiBXZWI6IGh0dHA6Ly9tZWRpYWxpemUuZ2l0aHViLmlvL1VSSS5qcy8KICAgICAgICoKICAgICAgICogTGljZW5zZWQgdW5kZXIKICAgICAgICogICBNSVQgTGljZW5zZSBodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlCiAgICAgICAqCiAgICAgICAqLwogICAgICAoZnVuY3Rpb24ocm9vdCwgZmFjdG9yeSkgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICBpZiAodHlwZW9mIG1vZHVsZSA9PT0gIm9iamVjdCIgJiYgbW9kdWxlLmV4cG9ydHMpIHsKICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyZXF1aXJlX3B1bnljb2RlKCksIHJlcXVpcmVfSVB2NigpLCByZXF1aXJlX1NlY29uZExldmVsRG9tYWlucygpKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgewogICAgICAgICAgZGVmaW5lKFsiLi9wdW55Y29kZSIsICIuL0lQdjYiLCAiLi9TZWNvbmRMZXZlbERvbWFpbnMiXSwgZmFjdG9yeSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJvb3QuVVJJID0gZmFjdG9yeShyb290LnB1bnljb2RlLCByb290LklQdjYsIHJvb3QuU2Vjb25kTGV2ZWxEb21haW5zLCByb290KTsKICAgICAgICB9CiAgICAgIH0pKGV4cG9ydHMyLCBmdW5jdGlvbihwdW55Y29kZSwgSVB2NiwgU0xELCByb290KSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciBfVVJJID0gcm9vdCAmJiByb290LlVSSTsKICAgICAgICBmdW5jdGlvbiBVUkkodXJsLCBiYXNlKSB7CiAgICAgICAgICB2YXIgX3VybFN1cHBsaWVkID0gYXJndW1lbnRzLmxlbmd0aCA+PSAxOwogICAgICAgICAgdmFyIF9iYXNlU3VwcGxpZWQgPSBhcmd1bWVudHMubGVuZ3RoID49IDI7CiAgICAgICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgVVJJKSkgewogICAgICAgICAgICBpZiAoX3VybFN1cHBsaWVkKSB7CiAgICAgICAgICAgICAgaWYgKF9iYXNlU3VwcGxpZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVVJJKHVybCwgYmFzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBuZXcgVVJJKHVybCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBVUkkoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh1cmwgPT09IHZvaWQgMCkgewogICAgICAgICAgICBpZiAoX3VybFN1cHBsaWVkKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigidW5kZWZpbmVkIGlzIG5vdCBhIHZhbGlkIGFyZ3VtZW50IGZvciBVUkkiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGxvY2F0aW9uICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIHVybCA9IGxvY2F0aW9uLmhyZWYgKyAiIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1cmwgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHVybCA9PT0gbnVsbCkgewogICAgICAgICAgICBpZiAoX3VybFN1cHBsaWVkKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigibnVsbCBpcyBub3QgYSB2YWxpZCBhcmd1bWVudCBmb3IgVVJJIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuaHJlZih1cmwpOwogICAgICAgICAgaWYgKGJhc2UgIT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5hYnNvbHV0ZVRvKGJhc2UpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzSW50ZWdlcih2YWx1ZSkgewogICAgICAgICAgcmV0dXJuIC9eWzAtOV0rJC8udGVzdCh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIFVSSS52ZXJzaW9uID0gIjEuMTkuMTEiOwogICAgICAgIHZhciBwID0gVVJJLnByb3RvdHlwZTsKICAgICAgICB2YXIgaGFzT3duID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICAgICAgICBmdW5jdGlvbiBlc2NhcGVSZWdFeChzdHJpbmcpIHsKICAgICAgICAgIHJldHVybiBzdHJpbmcucmVwbGFjZSgvKFsuKis/Xj0hOiR7fSgpfFtcXVwvXFxdKS9nLCAiXFwkMSIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUeXBlKHZhbHVlKSB7CiAgICAgICAgICBpZiAodmFsdWUgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gIlVuZGVmaW5lZCI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gU3RyaW5nKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSkpLnNsaWNlKDgsIC0xKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNBcnJheShvYmopIHsKICAgICAgICAgIHJldHVybiBnZXRUeXBlKG9iaikgPT09ICJBcnJheSI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbHRlckFycmF5VmFsdWVzKGRhdGEsIHZhbHVlKSB7CiAgICAgICAgICB2YXIgbG9va3VwID0ge307CiAgICAgICAgICB2YXIgaSwgbGVuZ3RoOwogICAgICAgICAgaWYgKGdldFR5cGUodmFsdWUpID09PSAiUmVnRXhwIikgewogICAgICAgICAgICBsb29rdXAgPSBudWxsOwogICAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICBmb3IgKGkgPSAwLCBsZW5ndGggPSB2YWx1ZS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGxvb2t1cFt2YWx1ZVtpXV0gPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsb29rdXBbdmFsdWVdID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9IGRhdGEubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIF9tYXRjaCA9IGxvb2t1cCAmJiBsb29rdXBbZGF0YVtpXV0gIT09IHZvaWQgMCB8fCAhbG9va3VwICYmIHZhbHVlLnRlc3QoZGF0YVtpXSk7CiAgICAgICAgICAgIGlmIChfbWF0Y2gpIHsKICAgICAgICAgICAgICBkYXRhLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICBsZW5ndGgtLTsKICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBkYXRhOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcnJheUNvbnRhaW5zKGxpc3QsIHZhbHVlKSB7CiAgICAgICAgICB2YXIgaSwgbGVuZ3RoOwogICAgICAgICAgaWYgKGlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9IHZhbHVlLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgaWYgKCFhcnJheUNvbnRhaW5zKGxpc3QsIHZhbHVlW2ldKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBfdHlwZSA9IGdldFR5cGUodmFsdWUpOwogICAgICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0gbGlzdC5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAoX3R5cGUgPT09ICJSZWdFeHAiKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBsaXN0W2ldID09PSAic3RyaW5nIiAmJiBsaXN0W2ldLm1hdGNoKHZhbHVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGxpc3RbaV0gPT09IHZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXJyYXlzRXF1YWwob25lLCB0d28pIHsKICAgICAgICAgIGlmICghaXNBcnJheShvbmUpIHx8ICFpc0FycmF5KHR3bykpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG9uZS5sZW5ndGggIT09IHR3by5sZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgb25lLnNvcnQoKTsKICAgICAgICAgIHR3by5zb3J0KCk7CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG9uZS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgaWYgKG9uZVtpXSAhPT0gdHdvW2ldKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJpbVNsYXNoZXModGV4dCkgewogICAgICAgICAgdmFyIHRyaW1fZXhwcmVzc2lvbiA9IC9eXC8rfFwvKyQvZzsKICAgICAgICAgIHJldHVybiB0ZXh0LnJlcGxhY2UodHJpbV9leHByZXNzaW9uLCAiIik7CiAgICAgICAgfQogICAgICAgIFVSSS5fcGFydHMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHByb3RvY29sOiBudWxsLAogICAgICAgICAgICB1c2VybmFtZTogbnVsbCwKICAgICAgICAgICAgcGFzc3dvcmQ6IG51bGwsCiAgICAgICAgICAgIGhvc3RuYW1lOiBudWxsLAogICAgICAgICAgICB1cm46IG51bGwsCiAgICAgICAgICAgIHBvcnQ6IG51bGwsCiAgICAgICAgICAgIHBhdGg6IG51bGwsCiAgICAgICAgICAgIHF1ZXJ5OiBudWxsLAogICAgICAgICAgICBmcmFnbWVudDogbnVsbCwKICAgICAgICAgICAgLy8gc3RhdGUKICAgICAgICAgICAgcHJldmVudEludmFsaWRIb3N0bmFtZTogVVJJLnByZXZlbnRJbnZhbGlkSG9zdG5hbWUsCiAgICAgICAgICAgIGR1cGxpY2F0ZVF1ZXJ5UGFyYW1ldGVyczogVVJJLmR1cGxpY2F0ZVF1ZXJ5UGFyYW1ldGVycywKICAgICAgICAgICAgZXNjYXBlUXVlcnlTcGFjZTogVVJJLmVzY2FwZVF1ZXJ5U3BhY2UKICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICBVUkkucHJldmVudEludmFsaWRIb3N0bmFtZSA9IGZhbHNlOwogICAgICAgIFVSSS5kdXBsaWNhdGVRdWVyeVBhcmFtZXRlcnMgPSBmYWxzZTsKICAgICAgICBVUkkuZXNjYXBlUXVlcnlTcGFjZSA9IHRydWU7CiAgICAgICAgVVJJLnByb3RvY29sX2V4cHJlc3Npb24gPSAvXlthLXpdW2EtejAtOS4rLV0qJC9pOwogICAgICAgIFVSSS5pZG5fZXhwcmVzc2lvbiA9IC9bXmEtejAtOVwuXy1dL2k7CiAgICAgICAgVVJJLnB1bnljb2RlX2V4cHJlc3Npb24gPSAvKHhuLS0pL2k7CiAgICAgICAgVVJJLmlwNF9leHByZXNzaW9uID0gL15cZHsxLDN9XC5cZHsxLDN9XC5cZHsxLDN9XC5cZHsxLDN9JC87CiAgICAgICAgVVJJLmlwNl9leHByZXNzaW9uID0gL15ccyooKChbMC05QS1GYS1mXXsxLDR9Oil7N30oWzAtOUEtRmEtZl17MSw0fXw6KSl8KChbMC05QS1GYS1mXXsxLDR9Oil7Nn0oOlswLTlBLUZhLWZdezEsNH18KCgyNVswLTVdfDJbMC00XVxkfDFcZFxkfFsxLTldP1xkKShcLigyNVswLTVdfDJbMC00XVxkfDFcZFxkfFsxLTldP1xkKSl7M30pfDopKXwoKFswLTlBLUZhLWZdezEsNH06KXs1fSgoKDpbMC05QS1GYS1mXXsxLDR9KXsxLDJ9KXw6KCgyNVswLTVdfDJbMC00XVxkfDFcZFxkfFsxLTldP1xkKShcLigyNVswLTVdfDJbMC00XVxkfDFcZFxkfFsxLTldP1xkKSl7M30pfDopKXwoKFswLTlBLUZhLWZdezEsNH06KXs0fSgoKDpbMC05QS1GYS1mXXsxLDR9KXsxLDN9KXwoKDpbMC05QS1GYS1mXXsxLDR9KT86KCgyNVswLTVdfDJbMC00XVxkfDFcZFxkfFsxLTldP1xkKShcLigyNVswLTVdfDJbMC00XVxkfDFcZFxkfFsxLTldP1xkKSl7M30pKXw6KSl8KChbMC05QS1GYS1mXXsxLDR9Oil7M30oKCg6WzAtOUEtRmEtZl17MSw0fSl7MSw0fSl8KCg6WzAtOUEtRmEtZl17MSw0fSl7MCwyfTooKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKFwuKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKXszfSkpfDopKXwoKFswLTlBLUZhLWZdezEsNH06KXsyfSgoKDpbMC05QS1GYS1mXXsxLDR9KXsxLDV9KXwoKDpbMC05QS1GYS1mXXsxLDR9KXswLDN9OigoMjVbMC01XXwyWzAtNF1cZHwxXGRcZHxbMS05XT9cZCkoXC4oMjVbMC01XXwyWzAtNF1cZHwxXGRcZHxbMS05XT9cZCkpezN9KSl8OikpfCgoWzAtOUEtRmEtZl17MSw0fTopezF9KCgoOlswLTlBLUZhLWZdezEsNH0pezEsNn0pfCgoOlswLTlBLUZhLWZdezEsNH0pezAsNH06KCgyNVswLTVdfDJbMC00XVxkfDFcZFxkfFsxLTldP1xkKShcLigyNVswLTVdfDJbMC00XVxkfDFcZFxkfFsxLTldP1xkKSl7M30pKXw6KSl8KDooKCg6WzAtOUEtRmEtZl17MSw0fSl7MSw3fSl8KCg6WzAtOUEtRmEtZl17MSw0fSl7MCw1fTooKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKFwuKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKXszfSkpfDopKSkoJS4rKT9ccyokLzsKICAgICAgICBVUkkuZmluZF91cmlfZXhwcmVzc2lvbiA9IC9cYigoPzpbYS16XVtcdy1dKzooPzpcL3sxLDN9fFthLXowLTklXSl8d3d3XGR7MCwzfVsuXXxbYS16MC05LlwtXStbLl1bYS16XXsyLDR9XC8pKD86W15ccygpPD5dK3xcKChbXlxzKCk8Pl0rfChcKFteXHMoKTw+XStcKSkpKlwpKSsoPzpcKChbXlxzKCk8Pl0rfChcKFteXHMoKTw+XStcKSkpKlwpfFteXHNgISgpXFtcXXt9OzonIi4sPD4/wqvCu+KAnOKAneKAmOKAmV0pKS9pZzsKICAgICAgICBVUkkuZmluZFVyaSA9IHsKICAgICAgICAgIC8vIHZhbGlkICJzY2hlbWU6Ly8iIG9yICJ3d3cuIgogICAgICAgICAgc3RhcnQ6IC9cYig/OihbYS16XVthLXowLTkuKy1dKjpcL1wvKXx3d3dcLikvZ2ksCiAgICAgICAgICAvLyBldmVyeXRoaW5nIHVwIHRvIHRoZSBuZXh0IHdoaXRlc3BhY2UKICAgICAgICAgIGVuZDogL1tcc1xyXG5dfCQvLAogICAgICAgICAgLy8gdHJpbSB0cmFpbGluZyBwdW5jdHVhdGlvbiBjYXB0dXJlZCBieSBlbmQgUmVnRXhwCiAgICAgICAgICB0cmltOiAvW2AhKClcW1xde307OiciLiw8Pj/Cq8K74oCc4oCd4oCe4oCY4oCZXSskLywKICAgICAgICAgIC8vIGJhbGFuY2VkIHBhcmVucyBpbmNsdXNpb24gKCksIFtdLCB7fSwgPD4KICAgICAgICAgIHBhcmVuczogLyhcKFteXCldKlwpfFxbW15cXV0qXF18XHtbXn1dKlx9fDxbXj5dKj4pL2cKICAgICAgICB9OwogICAgICAgIFVSSS5sZWFkaW5nX3doaXRlc3BhY2VfZXhwcmVzc2lvbiA9IC9eW1x4MDAtXHgyMFx1MDBhMFx1MTY4MFx1MjAwMC1cdTIwMGFcdTIwMjhcdTIwMjlcdTIwMmZcdTIwNWZcdTMwMDBcdWZlZmZdKy87CiAgICAgICAgVVJJLmFzY2lpX3RhYl93aGl0ZXNwYWNlID0gL1tcdTAwMDlcdTAwMEFcdTAwMERdKy9nOwogICAgICAgIFVSSS5kZWZhdWx0UG9ydHMgPSB7CiAgICAgICAgICBodHRwOiAiODAiLAogICAgICAgICAgaHR0cHM6ICI0NDMiLAogICAgICAgICAgZnRwOiAiMjEiLAogICAgICAgICAgZ29waGVyOiAiNzAiLAogICAgICAgICAgd3M6ICI4MCIsCiAgICAgICAgICB3c3M6ICI0NDMiCiAgICAgICAgfTsKICAgICAgICBVUkkuaG9zdFByb3RvY29scyA9IFsKICAgICAgICAgICJodHRwIiwKICAgICAgICAgICJodHRwcyIKICAgICAgICBdOwogICAgICAgIFVSSS5pbnZhbGlkX2hvc3RuYW1lX2NoYXJhY3RlcnMgPSAvW15hLXpBLVowLTlcLlwtOl9dLzsKICAgICAgICBVUkkuZG9tQXR0cmlidXRlcyA9IHsKICAgICAgICAgICJhIjogImhyZWYiLAogICAgICAgICAgImJsb2NrcXVvdGUiOiAiY2l0ZSIsCiAgICAgICAgICAibGluayI6ICJocmVmIiwKICAgICAgICAgICJiYXNlIjogImhyZWYiLAogICAgICAgICAgInNjcmlwdCI6ICJzcmMiLAogICAgICAgICAgImZvcm0iOiAiYWN0aW9uIiwKICAgICAgICAgICJpbWciOiAic3JjIiwKICAgICAgICAgICJhcmVhIjogImhyZWYiLAogICAgICAgICAgImlmcmFtZSI6ICJzcmMiLAogICAgICAgICAgImVtYmVkIjogInNyYyIsCiAgICAgICAgICAic291cmNlIjogInNyYyIsCiAgICAgICAgICAidHJhY2siOiAic3JjIiwKICAgICAgICAgICJpbnB1dCI6ICJzcmMiLAogICAgICAgICAgLy8gYnV0IG9ubHkgaWYgdHlwZT0iaW1hZ2UiCiAgICAgICAgICAiYXVkaW8iOiAic3JjIiwKICAgICAgICAgICJ2aWRlbyI6ICJzcmMiCiAgICAgICAgfTsKICAgICAgICBVUkkuZ2V0RG9tQXR0cmlidXRlID0gZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgaWYgKCFub2RlIHx8ICFub2RlLm5vZGVOYW1lKSB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICBpZiAobm9kZU5hbWUgPT09ICJpbnB1dCIgJiYgbm9kZS50eXBlICE9PSAiaW1hZ2UiKSB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gVVJJLmRvbUF0dHJpYnV0ZXNbbm9kZU5hbWVdOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gZXNjYXBlRm9yRHVtYkZpcmVmb3gzNih2YWx1ZSkgewogICAgICAgICAgcmV0dXJuIGVzY2FwZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0cmljdEVuY29kZVVSSUNvbXBvbmVudChzdHJpbmcpIHsKICAgICAgICAgIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5nKS5yZXBsYWNlKC9bIScoKSpdL2csIGVzY2FwZUZvckR1bWJGaXJlZm94MzYpLnJlcGxhY2UoL1wqL2csICIlMkEiKTsKICAgICAgICB9CiAgICAgICAgVVJJLmVuY29kZSA9IHN0cmljdEVuY29kZVVSSUNvbXBvbmVudDsKICAgICAgICBVUkkuZGVjb2RlID0gZGVjb2RlVVJJQ29tcG9uZW50OwogICAgICAgIFVSSS5pc284ODU5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBVUkkuZW5jb2RlID0gZXNjYXBlOwogICAgICAgICAgVVJJLmRlY29kZSA9IHVuZXNjYXBlOwogICAgICAgIH07CiAgICAgICAgVVJJLnVuaWNvZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIFVSSS5lbmNvZGUgPSBzdHJpY3RFbmNvZGVVUklDb21wb25lbnQ7CiAgICAgICAgICBVUkkuZGVjb2RlID0gZGVjb2RlVVJJQ29tcG9uZW50OwogICAgICAgIH07CiAgICAgICAgVVJJLmNoYXJhY3RlcnMgPSB7CiAgICAgICAgICBwYXRobmFtZTogewogICAgICAgICAgICBlbmNvZGU6IHsKICAgICAgICAgICAgICAvLyBSRkMzOTg2IDIuMTogRm9yIGNvbnNpc3RlbmN5LCBVUkkgcHJvZHVjZXJzIGFuZCBub3JtYWxpemVycyBzaG91bGQKICAgICAgICAgICAgICAvLyB1c2UgdXBwZXJjYXNlIGhleGFkZWNpbWFsIGRpZ2l0cyBmb3IgYWxsIHBlcmNlbnQtZW5jb2RpbmdzLgogICAgICAgICAgICAgIGV4cHJlc3Npb246IC8lKDI0fDI2fDJCfDJDfDNCfDNEfDNBfDQwKS9pZywKICAgICAgICAgICAgICBtYXA6IHsKICAgICAgICAgICAgICAgIC8vIC0uX34hJygpKgogICAgICAgICAgICAgICAgIiUyNCI6ICIkIiwKICAgICAgICAgICAgICAgICIlMjYiOiAiJiIsCiAgICAgICAgICAgICAgICAiJTJCIjogIisiLAogICAgICAgICAgICAgICAgIiUyQyI6ICIsIiwKICAgICAgICAgICAgICAgICIlM0IiOiAiOyIsCiAgICAgICAgICAgICAgICAiJTNEIjogIj0iLAogICAgICAgICAgICAgICAgIiUzQSI6ICI6IiwKICAgICAgICAgICAgICAgICIlNDAiOiAiQCIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRlY29kZTogewogICAgICAgICAgICAgIGV4cHJlc3Npb246IC9bXC9cPyNdL2csCiAgICAgICAgICAgICAgbWFwOiB7CiAgICAgICAgICAgICAgICAiLyI6ICIlMkYiLAogICAgICAgICAgICAgICAgIj8iOiAiJTNGIiwKICAgICAgICAgICAgICAgICIjIjogIiUyMyIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICByZXNlcnZlZDogewogICAgICAgICAgICBlbmNvZGU6IHsKICAgICAgICAgICAgICAvLyBSRkMzOTg2IDIuMTogRm9yIGNvbnNpc3RlbmN5LCBVUkkgcHJvZHVjZXJzIGFuZCBub3JtYWxpemVycyBzaG91bGQKICAgICAgICAgICAgICAvLyB1c2UgdXBwZXJjYXNlIGhleGFkZWNpbWFsIGRpZ2l0cyBmb3IgYWxsIHBlcmNlbnQtZW5jb2RpbmdzLgogICAgICAgICAgICAgIGV4cHJlc3Npb246IC8lKDIxfDIzfDI0fDI2fDI3fDI4fDI5fDJBfDJCfDJDfDJGfDNBfDNCfDNEfDNGfDQwfDVCfDVEKS9pZywKICAgICAgICAgICAgICBtYXA6IHsKICAgICAgICAgICAgICAgIC8vIGdlbi1kZWxpbXMKICAgICAgICAgICAgICAgICIlM0EiOiAiOiIsCiAgICAgICAgICAgICAgICAiJTJGIjogIi8iLAogICAgICAgICAgICAgICAgIiUzRiI6ICI/IiwKICAgICAgICAgICAgICAgICIlMjMiOiAiIyIsCiAgICAgICAgICAgICAgICAiJTVCIjogIlsiLAogICAgICAgICAgICAgICAgIiU1RCI6ICJdIiwKICAgICAgICAgICAgICAgICIlNDAiOiAiQCIsCiAgICAgICAgICAgICAgICAvLyBzdWItZGVsaW1zCiAgICAgICAgICAgICAgICAiJTIxIjogIiEiLAogICAgICAgICAgICAgICAgIiUyNCI6ICIkIiwKICAgICAgICAgICAgICAgICIlMjYiOiAiJiIsCiAgICAgICAgICAgICAgICAiJTI3IjogIiciLAogICAgICAgICAgICAgICAgIiUyOCI6ICIoIiwKICAgICAgICAgICAgICAgICIlMjkiOiAiKSIsCiAgICAgICAgICAgICAgICAiJTJBIjogIioiLAogICAgICAgICAgICAgICAgIiUyQiI6ICIrIiwKICAgICAgICAgICAgICAgICIlMkMiOiAiLCIsCiAgICAgICAgICAgICAgICAiJTNCIjogIjsiLAogICAgICAgICAgICAgICAgIiUzRCI6ICI9IgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIHVybnBhdGg6IHsKICAgICAgICAgICAgLy8gVGhlIGNoYXJhY3RlcnMgdW5kZXIgYGVuY29kZWAgYXJlIHRoZSBjaGFyYWN0ZXJzIGNhbGxlZCBvdXQgYnkgUkZDIDIxNDEgYXMgYmVpbmcgYWNjZXB0YWJsZQogICAgICAgICAgICAvLyBmb3IgdXNhZ2UgaW4gYSBVUk4uIFJGQzIxNDEgYWxzbyBjYWxscyBvdXQgIi0iLCAiLiIsIGFuZCAiXyIgYXMgYWNjZXB0YWJsZSBjaGFyYWN0ZXJzLCBidXQKICAgICAgICAgICAgLy8gdGhlc2UgYXJlbid0IGVuY29kZWQgYnkgZW5jb2RlVVJJQ29tcG9uZW50LCBzbyB3ZSBkb24ndCBoYXZlIHRvIGNhbGwgdGhlbSBvdXQgaGVyZS4gQWxzbwogICAgICAgICAgICAvLyBub3RlIHRoYXQgdGhlIGNvbG9uIGNoYXJhY3RlciBpcyBub3QgZmVhdHVyZWQgaW4gdGhlIGVuY29kaW5nIG1hcDsgdGhpcyBpcyBiZWNhdXNlIFVSSS5qcwogICAgICAgICAgICAvLyBnaXZlcyB0aGUgY29sb25zIGluIFVSTnMgc2VtYW50aWMgbWVhbmluZyBhcyB0aGUgZGVsaW1pdGVycyBvZiBwYXRoIHNlZ2VtZW50cywgYW5kIHNvIGl0CiAgICAgICAgICAgIC8vIHNob3VsZCBub3QgYXBwZWFyIHVuZW5jb2RlZCBpbiBhIHNlZ21lbnQgaXRzZWxmLgogICAgICAgICAgICAvLyBTZWUgYWxzbyB0aGUgbm90ZSBhYm92ZSBhYm91dCBSRkMzOTg2IGFuZCBjYXBpdGFsYWxpemVkIGhleCBkaWdpdHMuCiAgICAgICAgICAgIGVuY29kZTogewogICAgICAgICAgICAgIGV4cHJlc3Npb246IC8lKDIxfDI0fDI3fDI4fDI5fDJBfDJCfDJDfDNCfDNEfDQwKS9pZywKICAgICAgICAgICAgICBtYXA6IHsKICAgICAgICAgICAgICAgICIlMjEiOiAiISIsCiAgICAgICAgICAgICAgICAiJTI0IjogIiQiLAogICAgICAgICAgICAgICAgIiUyNyI6ICInIiwKICAgICAgICAgICAgICAgICIlMjgiOiAiKCIsCiAgICAgICAgICAgICAgICAiJTI5IjogIikiLAogICAgICAgICAgICAgICAgIiUyQSI6ICIqIiwKICAgICAgICAgICAgICAgICIlMkIiOiAiKyIsCiAgICAgICAgICAgICAgICAiJTJDIjogIiwiLAogICAgICAgICAgICAgICAgIiUzQiI6ICI7IiwKICAgICAgICAgICAgICAgICIlM0QiOiAiPSIsCiAgICAgICAgICAgICAgICAiJTQwIjogIkAiCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAvLyBUaGVzZSBjaGFyYWN0ZXJzIGFyZSB0aGUgY2hhcmFjdGVycyBjYWxsZWQgb3V0IGJ5IFJGQzIxNDEgYXMgInJlc2VydmVkIiBjaGFyYWN0ZXJzIHRoYXQKICAgICAgICAgICAgLy8gc2hvdWxkIG5ldmVyIGFwcGVhciBpbiBhIFVSTiwgcGx1cyB0aGUgY29sb24gY2hhcmFjdGVyIChzZWUgbm90ZSBhYm92ZSkuCiAgICAgICAgICAgIGRlY29kZTogewogICAgICAgICAgICAgIGV4cHJlc3Npb246IC9bXC9cPyM6XS9nLAogICAgICAgICAgICAgIG1hcDogewogICAgICAgICAgICAgICAgIi8iOiAiJTJGIiwKICAgICAgICAgICAgICAgICI/IjogIiUzRiIsCiAgICAgICAgICAgICAgICAiIyI6ICIlMjMiLAogICAgICAgICAgICAgICAgIjoiOiAiJTNBIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgVVJJLmVuY29kZVF1ZXJ5ID0gZnVuY3Rpb24oc3RyaW5nLCBlc2NhcGVRdWVyeVNwYWNlKSB7CiAgICAgICAgICB2YXIgZXNjYXBlZCA9IFVSSS5lbmNvZGUoc3RyaW5nICsgIiIpOwogICAgICAgICAgaWYgKGVzY2FwZVF1ZXJ5U3BhY2UgPT09IHZvaWQgMCkgewogICAgICAgICAgICBlc2NhcGVRdWVyeVNwYWNlID0gVVJJLmVzY2FwZVF1ZXJ5U3BhY2U7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZXNjYXBlUXVlcnlTcGFjZSA/IGVzY2FwZWQucmVwbGFjZSgvJTIwL2csICIrIikgOiBlc2NhcGVkOwogICAgICAgIH07CiAgICAgICAgVVJJLmRlY29kZVF1ZXJ5ID0gZnVuY3Rpb24oc3RyaW5nLCBlc2NhcGVRdWVyeVNwYWNlKSB7CiAgICAgICAgICBzdHJpbmcgKz0gIiI7CiAgICAgICAgICBpZiAoZXNjYXBlUXVlcnlTcGFjZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGVzY2FwZVF1ZXJ5U3BhY2UgPSBVUkkuZXNjYXBlUXVlcnlTcGFjZTsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBVUkkuZGVjb2RlKGVzY2FwZVF1ZXJ5U3BhY2UgPyBzdHJpbmcucmVwbGFjZSgvXCsvZywgIiUyMCIpIDogc3RyaW5nKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciBfcGFydHMgPSB7ICJlbmNvZGUiOiAiZW5jb2RlIiwgImRlY29kZSI6ICJkZWNvZGUiIH07CiAgICAgICAgdmFyIF9wYXJ0OwogICAgICAgIHZhciBnZW5lcmF0ZUFjY2Vzc29yID0gZnVuY3Rpb24oX2dyb3VwLCBfcGFydDIpIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXR1cm4gVVJJW19wYXJ0Ml0oc3RyaW5nICsgIiIpLnJlcGxhY2UoVVJJLmNoYXJhY3RlcnNbX2dyb3VwXVtfcGFydDJdLmV4cHJlc3Npb24sIGZ1bmN0aW9uKGMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBVUkkuY2hhcmFjdGVyc1tfZ3JvdXBdW19wYXJ0Ml0ubWFwW2NdOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9OwogICAgICAgIGZvciAoX3BhcnQgaW4gX3BhcnRzKSB7CiAgICAgICAgICBVUklbX3BhcnQgKyAiUGF0aFNlZ21lbnQiXSA9IGdlbmVyYXRlQWNjZXNzb3IoInBhdGhuYW1lIiwgX3BhcnRzW19wYXJ0XSk7CiAgICAgICAgICBVUklbX3BhcnQgKyAiVXJuUGF0aFNlZ21lbnQiXSA9IGdlbmVyYXRlQWNjZXNzb3IoInVybnBhdGgiLCBfcGFydHNbX3BhcnRdKTsKICAgICAgICB9CiAgICAgICAgdmFyIGdlbmVyYXRlU2VnbWVudGVkUGF0aEZ1bmN0aW9uID0gZnVuY3Rpb24oX3NlcCwgX2NvZGluZ0Z1bmNOYW1lLCBfaW5uZXJDb2RpbmdGdW5jTmFtZSkgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHN0cmluZykgewogICAgICAgICAgICB2YXIgYWN0dWFsQ29kaW5nRnVuYzsKICAgICAgICAgICAgaWYgKCFfaW5uZXJDb2RpbmdGdW5jTmFtZSkgewogICAgICAgICAgICAgIGFjdHVhbENvZGluZ0Z1bmMgPSBVUklbX2NvZGluZ0Z1bmNOYW1lXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBhY3R1YWxDb2RpbmdGdW5jID0gZnVuY3Rpb24oc3RyaW5nMikgewogICAgICAgICAgICAgICAgcmV0dXJuIFVSSVtfY29kaW5nRnVuY05hbWVdKFVSSVtfaW5uZXJDb2RpbmdGdW5jTmFtZV0oc3RyaW5nMikpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNlZ21lbnRzID0gKHN0cmluZyArICIiKS5zcGxpdChfc2VwKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IHNlZ21lbnRzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgc2VnbWVudHNbaV0gPSBhY3R1YWxDb2RpbmdGdW5jKHNlZ21lbnRzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc2VnbWVudHMuam9pbihfc2VwKTsKICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICBVUkkuZGVjb2RlUGF0aCA9IGdlbmVyYXRlU2VnbWVudGVkUGF0aEZ1bmN0aW9uKCIvIiwgImRlY29kZVBhdGhTZWdtZW50Iik7CiAgICAgICAgVVJJLmRlY29kZVVyblBhdGggPSBnZW5lcmF0ZVNlZ21lbnRlZFBhdGhGdW5jdGlvbigiOiIsICJkZWNvZGVVcm5QYXRoU2VnbWVudCIpOwogICAgICAgIFVSSS5yZWNvZGVQYXRoID0gZ2VuZXJhdGVTZWdtZW50ZWRQYXRoRnVuY3Rpb24oIi8iLCAiZW5jb2RlUGF0aFNlZ21lbnQiLCAiZGVjb2RlIik7CiAgICAgICAgVVJJLnJlY29kZVVyblBhdGggPSBnZW5lcmF0ZVNlZ21lbnRlZFBhdGhGdW5jdGlvbigiOiIsICJlbmNvZGVVcm5QYXRoU2VnbWVudCIsICJkZWNvZGUiKTsKICAgICAgICBVUkkuZW5jb2RlUmVzZXJ2ZWQgPSBnZW5lcmF0ZUFjY2Vzc29yKCJyZXNlcnZlZCIsICJlbmNvZGUiKTsKICAgICAgICBVUkkucGFyc2UgPSBmdW5jdGlvbihzdHJpbmcsIHBhcnRzKSB7CiAgICAgICAgICB2YXIgcG9zOwogICAgICAgICAgaWYgKCFwYXJ0cykgewogICAgICAgICAgICBwYXJ0cyA9IHsKICAgICAgICAgICAgICBwcmV2ZW50SW52YWxpZEhvc3RuYW1lOiBVUkkucHJldmVudEludmFsaWRIb3N0bmFtZQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnJlcGxhY2UoVVJJLmxlYWRpbmdfd2hpdGVzcGFjZV9leHByZXNzaW9uLCAiIik7CiAgICAgICAgICBzdHJpbmcgPSBzdHJpbmcucmVwbGFjZShVUkkuYXNjaWlfdGFiX3doaXRlc3BhY2UsICIiKTsKICAgICAgICAgIHBvcyA9IHN0cmluZy5pbmRleE9mKCIjIik7CiAgICAgICAgICBpZiAocG9zID4gLTEpIHsKICAgICAgICAgICAgcGFydHMuZnJhZ21lbnQgPSBzdHJpbmcuc3Vic3RyaW5nKHBvcyArIDEpIHx8IG51bGw7CiAgICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5zdWJzdHJpbmcoMCwgcG9zKTsKICAgICAgICAgIH0KICAgICAgICAgIHBvcyA9IHN0cmluZy5pbmRleE9mKCI/Iik7CiAgICAgICAgICBpZiAocG9zID4gLTEpIHsKICAgICAgICAgICAgcGFydHMucXVlcnkgPSBzdHJpbmcuc3Vic3RyaW5nKHBvcyArIDEpIHx8IG51bGw7CiAgICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5zdWJzdHJpbmcoMCwgcG9zKTsKICAgICAgICAgIH0KICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5yZXBsYWNlKC9eKGh0dHBzP3xmdHB8d3NzPyk/OitbL1xcXSovaSwgIiQxOi8vIik7CiAgICAgICAgICBzdHJpbmcgPSBzdHJpbmcucmVwbGFjZSgvXlsvXFxdezIsfS9pLCAiLy8iKTsKICAgICAgICAgIGlmIChzdHJpbmcuc3Vic3RyaW5nKDAsIDIpID09PSAiLy8iKSB7CiAgICAgICAgICAgIHBhcnRzLnByb3RvY29sID0gbnVsbDsKICAgICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnN1YnN0cmluZygyKTsKICAgICAgICAgICAgc3RyaW5nID0gVVJJLnBhcnNlQXV0aG9yaXR5KHN0cmluZywgcGFydHMpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcG9zID0gc3RyaW5nLmluZGV4T2YoIjoiKTsKICAgICAgICAgICAgaWYgKHBvcyA+IC0xKSB7CiAgICAgICAgICAgICAgcGFydHMucHJvdG9jb2wgPSBzdHJpbmcuc3Vic3RyaW5nKDAsIHBvcykgfHwgbnVsbDsKICAgICAgICAgICAgICBpZiAocGFydHMucHJvdG9jb2wgJiYgIXBhcnRzLnByb3RvY29sLm1hdGNoKFVSSS5wcm90b2NvbF9leHByZXNzaW9uKSkgewogICAgICAgICAgICAgICAgcGFydHMucHJvdG9jb2wgPSB2b2lkIDA7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJpbmcuc3Vic3RyaW5nKHBvcyArIDEsIHBvcyArIDMpLnJlcGxhY2UoL1xcL2csICIvIikgPT09ICIvLyIpIHsKICAgICAgICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5zdWJzdHJpbmcocG9zICsgMyk7CiAgICAgICAgICAgICAgICBzdHJpbmcgPSBVUkkucGFyc2VBdXRob3JpdHkoc3RyaW5nLCBwYXJ0cyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5zdWJzdHJpbmcocG9zICsgMSk7CiAgICAgICAgICAgICAgICBwYXJ0cy51cm4gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcGFydHMucGF0aCA9IHN0cmluZzsKICAgICAgICAgIHJldHVybiBwYXJ0czsKICAgICAgICB9OwogICAgICAgIFVSSS5wYXJzZUhvc3QgPSBmdW5jdGlvbihzdHJpbmcsIHBhcnRzKSB7CiAgICAgICAgICBpZiAoIXN0cmluZykgewogICAgICAgICAgICBzdHJpbmcgPSAiIjsKICAgICAgICAgIH0KICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5yZXBsYWNlKC9cXC9nLCAiLyIpOwogICAgICAgICAgdmFyIHBvcyA9IHN0cmluZy5pbmRleE9mKCIvIik7CiAgICAgICAgICB2YXIgYnJhY2tldFBvczsKICAgICAgICAgIHZhciB0OwogICAgICAgICAgaWYgKHBvcyA9PT0gLTEpIHsKICAgICAgICAgICAgcG9zID0gc3RyaW5nLmxlbmd0aDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzdHJpbmcuY2hhckF0KDApID09PSAiWyIpIHsKICAgICAgICAgICAgYnJhY2tldFBvcyA9IHN0cmluZy5pbmRleE9mKCJdIik7CiAgICAgICAgICAgIHBhcnRzLmhvc3RuYW1lID0gc3RyaW5nLnN1YnN0cmluZygxLCBicmFja2V0UG9zKSB8fCBudWxsOwogICAgICAgICAgICBwYXJ0cy5wb3J0ID0gc3RyaW5nLnN1YnN0cmluZyhicmFja2V0UG9zICsgMiwgcG9zKSB8fCBudWxsOwogICAgICAgICAgICBpZiAocGFydHMucG9ydCA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgcGFydHMucG9ydCA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBmaXJzdENvbG9uID0gc3RyaW5nLmluZGV4T2YoIjoiKTsKICAgICAgICAgICAgdmFyIGZpcnN0U2xhc2ggPSBzdHJpbmcuaW5kZXhPZigiLyIpOwogICAgICAgICAgICB2YXIgbmV4dENvbG9uID0gc3RyaW5nLmluZGV4T2YoIjoiLCBmaXJzdENvbG9uICsgMSk7CiAgICAgICAgICAgIGlmIChuZXh0Q29sb24gIT09IC0xICYmIChmaXJzdFNsYXNoID09PSAtMSB8fCBuZXh0Q29sb24gPCBmaXJzdFNsYXNoKSkgewogICAgICAgICAgICAgIHBhcnRzLmhvc3RuYW1lID0gc3RyaW5nLnN1YnN0cmluZygwLCBwb3MpIHx8IG51bGw7CiAgICAgICAgICAgICAgcGFydHMucG9ydCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdCA9IHN0cmluZy5zdWJzdHJpbmcoMCwgcG9zKS5zcGxpdCgiOiIpOwogICAgICAgICAgICAgIHBhcnRzLmhvc3RuYW1lID0gdFswXSB8fCBudWxsOwogICAgICAgICAgICAgIHBhcnRzLnBvcnQgPSB0WzFdIHx8IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChwYXJ0cy5ob3N0bmFtZSAmJiBzdHJpbmcuc3Vic3RyaW5nKHBvcykuY2hhckF0KDApICE9PSAiLyIpIHsKICAgICAgICAgICAgcG9zKys7CiAgICAgICAgICAgIHN0cmluZyA9ICIvIiArIHN0cmluZzsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChwYXJ0cy5wcmV2ZW50SW52YWxpZEhvc3RuYW1lKSB7CiAgICAgICAgICAgIFVSSS5lbnN1cmVWYWxpZEhvc3RuYW1lKHBhcnRzLmhvc3RuYW1lLCBwYXJ0cy5wcm90b2NvbCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocGFydHMucG9ydCkgewogICAgICAgICAgICBVUkkuZW5zdXJlVmFsaWRQb3J0KHBhcnRzLnBvcnQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN0cmluZy5zdWJzdHJpbmcocG9zKSB8fCAiLyI7CiAgICAgICAgfTsKICAgICAgICBVUkkucGFyc2VBdXRob3JpdHkgPSBmdW5jdGlvbihzdHJpbmcsIHBhcnRzKSB7CiAgICAgICAgICBzdHJpbmcgPSBVUkkucGFyc2VVc2VyaW5mbyhzdHJpbmcsIHBhcnRzKTsKICAgICAgICAgIHJldHVybiBVUkkucGFyc2VIb3N0KHN0cmluZywgcGFydHMpOwogICAgICAgIH07CiAgICAgICAgVVJJLnBhcnNlVXNlcmluZm8gPSBmdW5jdGlvbihzdHJpbmcsIHBhcnRzKSB7CiAgICAgICAgICB2YXIgX3N0cmluZyA9IHN0cmluZzsKICAgICAgICAgIHZhciBmaXJzdEJhY2tTbGFzaCA9IHN0cmluZy5pbmRleE9mKCJcXCIpOwogICAgICAgICAgaWYgKGZpcnN0QmFja1NsYXNoICE9PSAtMSkgewogICAgICAgICAgICBzdHJpbmcgPSBzdHJpbmcucmVwbGFjZSgvXFwvZywgIi8iKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaXJzdFNsYXNoID0gc3RyaW5nLmluZGV4T2YoIi8iKTsKICAgICAgICAgIHZhciBwb3MgPSBzdHJpbmcubGFzdEluZGV4T2YoIkAiLCBmaXJzdFNsYXNoID4gLTEgPyBmaXJzdFNsYXNoIDogc3RyaW5nLmxlbmd0aCAtIDEpOwogICAgICAgICAgdmFyIHQ7CiAgICAgICAgICBpZiAocG9zID4gLTEgJiYgKGZpcnN0U2xhc2ggPT09IC0xIHx8IHBvcyA8IGZpcnN0U2xhc2gpKSB7CiAgICAgICAgICAgIHQgPSBzdHJpbmcuc3Vic3RyaW5nKDAsIHBvcykuc3BsaXQoIjoiKTsKICAgICAgICAgICAgcGFydHMudXNlcm5hbWUgPSB0WzBdID8gVVJJLmRlY29kZSh0WzBdKSA6IG51bGw7CiAgICAgICAgICAgIHQuc2hpZnQoKTsKICAgICAgICAgICAgcGFydHMucGFzc3dvcmQgPSB0WzBdID8gVVJJLmRlY29kZSh0LmpvaW4oIjoiKSkgOiBudWxsOwogICAgICAgICAgICBzdHJpbmcgPSBfc3RyaW5nLnN1YnN0cmluZyhwb3MgKyAxKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBhcnRzLnVzZXJuYW1lID0gbnVsbDsKICAgICAgICAgICAgcGFydHMucGFzc3dvcmQgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgICB9OwogICAgICAgIFVSSS5wYXJzZVF1ZXJ5ID0gZnVuY3Rpb24oc3RyaW5nLCBlc2NhcGVRdWVyeVNwYWNlKSB7CiAgICAgICAgICBpZiAoIXN0cmluZykgewogICAgICAgICAgICByZXR1cm4ge307CiAgICAgICAgICB9CiAgICAgICAgICBzdHJpbmcgPSBzdHJpbmcucmVwbGFjZSgvJisvZywgIiYiKS5yZXBsYWNlKC9eXD8qJip8JiskL2csICIiKTsKICAgICAgICAgIGlmICghc3RyaW5nKSB7CiAgICAgICAgICAgIHJldHVybiB7fTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpdGVtcyA9IHt9OwogICAgICAgICAgdmFyIHNwbGl0cyA9IHN0cmluZy5zcGxpdCgiJiIpOwogICAgICAgICAgdmFyIGxlbmd0aCA9IHNwbGl0cy5sZW5ndGg7CiAgICAgICAgICB2YXIgdjMsIG5hbWUsIHZhbHVlOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICB2MyA9IHNwbGl0c1tpXS5zcGxpdCgiPSIpOwogICAgICAgICAgICBuYW1lID0gVVJJLmRlY29kZVF1ZXJ5KHYzLnNoaWZ0KCksIGVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgICB2YWx1ZSA9IHYzLmxlbmd0aCA/IFVSSS5kZWNvZGVRdWVyeSh2My5qb2luKCI9IiksIGVzY2FwZVF1ZXJ5U3BhY2UpIDogbnVsbDsKICAgICAgICAgICAgaWYgKG5hbWUgPT09ICJfX3Byb3RvX18iKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzT3duLmNhbGwoaXRlbXMsIG5hbWUpKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVtc1tuYW1lXSA9PT0gInN0cmluZyIgfHwgaXRlbXNbbmFtZV0gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGl0ZW1zW25hbWVdID0gW2l0ZW1zW25hbWVdXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaXRlbXNbbmFtZV0ucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaXRlbXNbbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGl0ZW1zOwogICAgICAgIH07CiAgICAgICAgVVJJLmJ1aWxkID0gZnVuY3Rpb24ocGFydHMpIHsKICAgICAgICAgIHZhciB0ID0gIiI7CiAgICAgICAgICB2YXIgcmVxdWlyZUFic29sdXRlUGF0aCA9IGZhbHNlOwogICAgICAgICAgaWYgKHBhcnRzLnByb3RvY29sKSB7CiAgICAgICAgICAgIHQgKz0gcGFydHMucHJvdG9jb2wgKyAiOiI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXBhcnRzLnVybiAmJiAodCB8fCBwYXJ0cy5ob3N0bmFtZSkpIHsKICAgICAgICAgICAgdCArPSAiLy8iOwogICAgICAgICAgICByZXF1aXJlQWJzb2x1dGVQYXRoID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHQgKz0gVVJJLmJ1aWxkQXV0aG9yaXR5KHBhcnRzKSB8fCAiIjsKICAgICAgICAgIGlmICh0eXBlb2YgcGFydHMucGF0aCA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgaWYgKHBhcnRzLnBhdGguY2hhckF0KDApICE9PSAiLyIgJiYgcmVxdWlyZUFic29sdXRlUGF0aCkgewogICAgICAgICAgICAgIHQgKz0gIi8iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHQgKz0gcGFydHMucGF0aDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgcGFydHMucXVlcnkgPT09ICJzdHJpbmciICYmIHBhcnRzLnF1ZXJ5KSB7CiAgICAgICAgICAgIHQgKz0gIj8iICsgcGFydHMucXVlcnk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHBhcnRzLmZyYWdtZW50ID09PSAic3RyaW5nIiAmJiBwYXJ0cy5mcmFnbWVudCkgewogICAgICAgICAgICB0ICs9ICIjIiArIHBhcnRzLmZyYWdtZW50OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHQ7CiAgICAgICAgfTsKICAgICAgICBVUkkuYnVpbGRIb3N0ID0gZnVuY3Rpb24ocGFydHMpIHsKICAgICAgICAgIHZhciB0ID0gIiI7CiAgICAgICAgICBpZiAoIXBhcnRzLmhvc3RuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0gZWxzZSBpZiAoVVJJLmlwNl9leHByZXNzaW9uLnRlc3QocGFydHMuaG9zdG5hbWUpKSB7CiAgICAgICAgICAgIHQgKz0gIlsiICsgcGFydHMuaG9zdG5hbWUgKyAiXSI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0ICs9IHBhcnRzLmhvc3RuYW1lOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcnRzLnBvcnQpIHsKICAgICAgICAgICAgdCArPSAiOiIgKyBwYXJ0cy5wb3J0OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHQ7CiAgICAgICAgfTsKICAgICAgICBVUkkuYnVpbGRBdXRob3JpdHkgPSBmdW5jdGlvbihwYXJ0cykgewogICAgICAgICAgcmV0dXJuIFVSSS5idWlsZFVzZXJpbmZvKHBhcnRzKSArIFVSSS5idWlsZEhvc3QocGFydHMpOwogICAgICAgIH07CiAgICAgICAgVVJJLmJ1aWxkVXNlcmluZm8gPSBmdW5jdGlvbihwYXJ0cykgewogICAgICAgICAgdmFyIHQgPSAiIjsKICAgICAgICAgIGlmIChwYXJ0cy51c2VybmFtZSkgewogICAgICAgICAgICB0ICs9IFVSSS5lbmNvZGUocGFydHMudXNlcm5hbWUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcnRzLnBhc3N3b3JkKSB7CiAgICAgICAgICAgIHQgKz0gIjoiICsgVVJJLmVuY29kZShwYXJ0cy5wYXNzd29yZCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodCkgewogICAgICAgICAgICB0ICs9ICJAIjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0OwogICAgICAgIH07CiAgICAgICAgVVJJLmJ1aWxkUXVlcnkgPSBmdW5jdGlvbihkYXRhLCBkdXBsaWNhdGVRdWVyeVBhcmFtZXRlcnMsIGVzY2FwZVF1ZXJ5U3BhY2UpIHsKICAgICAgICAgIHZhciB0ID0gIiI7CiAgICAgICAgICB2YXIgdW5pcXVlLCBrZXksIGksIGxlbmd0aDsKICAgICAgICAgIGZvciAoa2V5IGluIGRhdGEpIHsKICAgICAgICAgICAgaWYgKGtleSA9PT0gIl9fcHJvdG9fXyIpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChoYXNPd24uY2FsbChkYXRhLCBrZXkpKSB7CiAgICAgICAgICAgICAgaWYgKGlzQXJyYXkoZGF0YVtrZXldKSkgewogICAgICAgICAgICAgICAgdW5pcXVlID0ge307CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBsZW5ndGggPSBkYXRhW2tleV0ubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKGRhdGFba2V5XVtpXSAhPT0gdm9pZCAwICYmIHVuaXF1ZVtkYXRhW2tleV1baV0gKyAiIl0gPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICAgIHQgKz0gIiYiICsgVVJJLmJ1aWxkUXVlcnlQYXJhbWV0ZXIoa2V5LCBkYXRhW2tleV1baV0sIGVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgICAgICAgICAgIGlmIChkdXBsaWNhdGVRdWVyeVBhcmFtZXRlcnMgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgIHVuaXF1ZVtkYXRhW2tleV1baV0gKyAiIl0gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YVtrZXldICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHQgKz0gIiYiICsgVVJJLmJ1aWxkUXVlcnlQYXJhbWV0ZXIoa2V5LCBkYXRhW2tleV0sIGVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHQuc3Vic3RyaW5nKDEpOwogICAgICAgIH07CiAgICAgICAgVVJJLmJ1aWxkUXVlcnlQYXJhbWV0ZXIgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSwgZXNjYXBlUXVlcnlTcGFjZSkgewogICAgICAgICAgcmV0dXJuIFVSSS5lbmNvZGVRdWVyeShuYW1lLCBlc2NhcGVRdWVyeVNwYWNlKSArICh2YWx1ZSAhPT0gbnVsbCA/ICI9IiArIFVSSS5lbmNvZGVRdWVyeSh2YWx1ZSwgZXNjYXBlUXVlcnlTcGFjZSkgOiAiIik7CiAgICAgICAgfTsKICAgICAgICBVUkkuYWRkUXVlcnkgPSBmdW5jdGlvbihkYXRhLCBuYW1lLCB2YWx1ZSkgewogICAgICAgICAgaWYgKHR5cGVvZiBuYW1lID09PSAib2JqZWN0IikgewogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gbmFtZSkgewogICAgICAgICAgICAgIGlmIChoYXNPd24uY2FsbChuYW1lLCBrZXkpKSB7CiAgICAgICAgICAgICAgICBVUkkuYWRkUXVlcnkoZGF0YSwga2V5LCBuYW1lW2tleV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgaWYgKGRhdGFbbmFtZV0gPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIGRhdGFbbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGRhdGFbbmFtZV0gPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgZGF0YVtuYW1lXSA9IFtkYXRhW25hbWVdXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgdmFsdWUgPSBbdmFsdWVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRhdGFbbmFtZV0gPSAoZGF0YVtuYW1lXSB8fCBbXSkuY29uY2F0KHZhbHVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlVSSS5hZGRRdWVyeSgpIGFjY2VwdHMgYW4gb2JqZWN0LCBzdHJpbmcgYXMgdGhlIG5hbWUgcGFyYW1ldGVyIik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBVUkkuc2V0UXVlcnkgPSBmdW5jdGlvbihkYXRhLCBuYW1lLCB2YWx1ZSkgewogICAgICAgICAgaWYgKHR5cGVvZiBuYW1lID09PSAib2JqZWN0IikgewogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gbmFtZSkgewogICAgICAgICAgICAgIGlmIChoYXNPd24uY2FsbChuYW1lLCBrZXkpKSB7CiAgICAgICAgICAgICAgICBVUkkuc2V0UXVlcnkoZGF0YSwga2V5LCBuYW1lW2tleV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgZGF0YVtuYW1lXSA9IHZhbHVlID09PSB2b2lkIDAgPyBudWxsIDogdmFsdWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJVUkkuc2V0UXVlcnkoKSBhY2NlcHRzIGFuIG9iamVjdCwgc3RyaW5nIGFzIHRoZSBuYW1lIHBhcmFtZXRlciIpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgVVJJLnJlbW92ZVF1ZXJ5ID0gZnVuY3Rpb24oZGF0YSwgbmFtZSwgdmFsdWUpIHsKICAgICAgICAgIHZhciBpLCBsZW5ndGgsIGtleTsKICAgICAgICAgIGlmIChpc0FycmF5KG5hbWUpKSB7CiAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9IG5hbWUubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBkYXRhW25hbWVbaV1dID0gdm9pZCAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGdldFR5cGUobmFtZSkgPT09ICJSZWdFeHAiKSB7CiAgICAgICAgICAgIGZvciAoa2V5IGluIGRhdGEpIHsKICAgICAgICAgICAgICBpZiAobmFtZS50ZXN0KGtleSkpIHsKICAgICAgICAgICAgICAgIGRhdGFba2V5XSA9IHZvaWQgMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG5hbWUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGZvciAoa2V5IGluIG5hbWUpIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duLmNhbGwobmFtZSwga2V5KSkgewogICAgICAgICAgICAgICAgVVJJLnJlbW92ZVF1ZXJ5KGRhdGEsIGtleSwgbmFtZVtrZXldKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG5hbWUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWYgKGdldFR5cGUodmFsdWUpID09PSAiUmVnRXhwIikgewogICAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KGRhdGFbbmFtZV0pICYmIHZhbHVlLnRlc3QoZGF0YVtuYW1lXSkpIHsKICAgICAgICAgICAgICAgICAgZGF0YVtuYW1lXSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRhdGFbbmFtZV0gPSBmaWx0ZXJBcnJheVZhbHVlcyhkYXRhW25hbWVdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhW25hbWVdID09PSBTdHJpbmcodmFsdWUpICYmICghaXNBcnJheSh2YWx1ZSkgfHwgdmFsdWUubGVuZ3RoID09PSAxKSkgewogICAgICAgICAgICAgICAgZGF0YVtuYW1lXSA9IHZvaWQgMDsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkoZGF0YVtuYW1lXSkpIHsKICAgICAgICAgICAgICAgIGRhdGFbbmFtZV0gPSBmaWx0ZXJBcnJheVZhbHVlcyhkYXRhW25hbWVdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRhdGFbbmFtZV0gPSB2b2lkIDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlVSSS5yZW1vdmVRdWVyeSgpIGFjY2VwdHMgYW4gb2JqZWN0LCBzdHJpbmcsIFJlZ0V4cCBhcyB0aGUgZmlyc3QgcGFyYW1ldGVyIik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBVUkkuaGFzUXVlcnkgPSBmdW5jdGlvbihkYXRhLCBuYW1lLCB2YWx1ZSwgd2l0aGluQXJyYXkpIHsKICAgICAgICAgIHN3aXRjaCAoZ2V0VHlwZShuYW1lKSkgewogICAgICAgICAgICBjYXNlICJTdHJpbmciOgogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJSZWdFeHAiOgogICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBkYXRhKSB7CiAgICAgICAgICAgICAgICBpZiAoaGFzT3duLmNhbGwoZGF0YSwga2V5KSkgewogICAgICAgICAgICAgICAgICBpZiAobmFtZS50ZXN0KGtleSkgJiYgKHZhbHVlID09PSB2b2lkIDAgfHwgVVJJLmhhc1F1ZXJ5KGRhdGEsIGtleSwgdmFsdWUpKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgY2FzZSAiT2JqZWN0IjoKICAgICAgICAgICAgICBmb3IgKHZhciBfa2V5IGluIG5hbWUpIHsKICAgICAgICAgICAgICAgIGlmIChoYXNPd24uY2FsbChuYW1lLCBfa2V5KSkgewogICAgICAgICAgICAgICAgICBpZiAoIVVSSS5oYXNRdWVyeShkYXRhLCBfa2V5LCBuYW1lW19rZXldKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJVUkkuaGFzUXVlcnkoKSBhY2NlcHRzIGEgc3RyaW5nLCByZWd1bGFyIGV4cHJlc3Npb24gb3Igb2JqZWN0IGFzIHRoZSBuYW1lIHBhcmFtZXRlciIpOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoIChnZXRUeXBlKHZhbHVlKSkgewogICAgICAgICAgICBjYXNlICJVbmRlZmluZWQiOgogICAgICAgICAgICAgIHJldHVybiBuYW1lIGluIGRhdGE7CiAgICAgICAgICAgIGNhc2UgIkJvb2xlYW4iOgogICAgICAgICAgICAgIHZhciBfYm9vbHkgPSBCb29sZWFuKGlzQXJyYXkoZGF0YVtuYW1lXSkgPyBkYXRhW25hbWVdLmxlbmd0aCA6IGRhdGFbbmFtZV0pOwogICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gX2Jvb2x5OwogICAgICAgICAgICBjYXNlICJGdW5jdGlvbiI6CiAgICAgICAgICAgICAgcmV0dXJuICEhdmFsdWUoZGF0YVtuYW1lXSwgbmFtZSwgZGF0YSk7CiAgICAgICAgICAgIGNhc2UgIkFycmF5IjoKICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkoZGF0YVtuYW1lXSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG9wID0gd2l0aGluQXJyYXkgPyBhcnJheUNvbnRhaW5zIDogYXJyYXlzRXF1YWw7CiAgICAgICAgICAgICAgcmV0dXJuIG9wKGRhdGFbbmFtZV0sIHZhbHVlKTsKICAgICAgICAgICAgY2FzZSAiUmVnRXhwIjoKICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkoZGF0YVtuYW1lXSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBCb29sZWFuKGRhdGFbbmFtZV0gJiYgZGF0YVtuYW1lXS5tYXRjaCh2YWx1ZSkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIXdpdGhpbkFycmF5KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBhcnJheUNvbnRhaW5zKGRhdGFbbmFtZV0sIHZhbHVlKTsKICAgICAgICAgICAgY2FzZSAiTnVtYmVyIjoKICAgICAgICAgICAgICB2YWx1ZSA9IFN0cmluZyh2YWx1ZSk7CiAgICAgICAgICAgIGNhc2UgIlN0cmluZyI6CiAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KGRhdGFbbmFtZV0pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YVtuYW1lXSA9PT0gdmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghd2l0aGluQXJyYXkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGFycmF5Q29udGFpbnMoZGF0YVtuYW1lXSwgdmFsdWUpOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlVSSS5oYXNRdWVyeSgpIGFjY2VwdHMgdW5kZWZpbmVkLCBib29sZWFuLCBzdHJpbmcsIG51bWJlciwgUmVnRXhwLCBGdW5jdGlvbiBhcyB0aGUgdmFsdWUgcGFyYW1ldGVyIik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBVUkkuam9pblBhdGhzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgaW5wdXQgPSBbXTsKICAgICAgICAgIHZhciBzZWdtZW50cyA9IFtdOwogICAgICAgICAgdmFyIG5vbkVtcHR5U2VnbWVudHMgPSAwOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIHVybCA9IG5ldyBVUkkoYXJndW1lbnRzW2ldKTsKICAgICAgICAgICAgaW5wdXQucHVzaCh1cmwpOwogICAgICAgICAgICB2YXIgX3NlZ21lbnRzID0gdXJsLnNlZ21lbnQoKTsKICAgICAgICAgICAgZm9yICh2YXIgcyA9IDA7IHMgPCBfc2VnbWVudHMubGVuZ3RoOyBzKyspIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIF9zZWdtZW50c1tzXSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHNlZ21lbnRzLnB1c2goX3NlZ21lbnRzW3NdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKF9zZWdtZW50c1tzXSkgewogICAgICAgICAgICAgICAgbm9uRW1wdHlTZWdtZW50cysrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFzZWdtZW50cy5sZW5ndGggfHwgIW5vbkVtcHR5U2VnbWVudHMpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBVUkkoIiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHVyaSA9IG5ldyBVUkkoIiIpLnNlZ21lbnQoc2VnbWVudHMpOwogICAgICAgICAgaWYgKGlucHV0WzBdLnBhdGgoKSA9PT0gIiIgfHwgaW5wdXRbMF0ucGF0aCgpLnNsaWNlKDAsIDEpID09PSAiLyIpIHsKICAgICAgICAgICAgdXJpLnBhdGgoIi8iICsgdXJpLnBhdGgoKSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdXJpLm5vcm1hbGl6ZSgpOwogICAgICAgIH07CiAgICAgICAgVVJJLmNvbW1vblBhdGggPSBmdW5jdGlvbihvbmUsIHR3bykgewogICAgICAgICAgdmFyIGxlbmd0aCA9IE1hdGgubWluKG9uZS5sZW5ndGgsIHR3by5sZW5ndGgpOwogICAgICAgICAgdmFyIHBvczsKICAgICAgICAgIGZvciAocG9zID0gMDsgcG9zIDwgbGVuZ3RoOyBwb3MrKykgewogICAgICAgICAgICBpZiAob25lLmNoYXJBdChwb3MpICE9PSB0d28uY2hhckF0KHBvcykpIHsKICAgICAgICAgICAgICBwb3MtLTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHBvcyA8IDEpIHsKICAgICAgICAgICAgcmV0dXJuIG9uZS5jaGFyQXQoMCkgPT09IHR3by5jaGFyQXQoMCkgJiYgb25lLmNoYXJBdCgwKSA9PT0gIi8iID8gIi8iIDogIiI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob25lLmNoYXJBdChwb3MpICE9PSAiLyIgfHwgdHdvLmNoYXJBdChwb3MpICE9PSAiLyIpIHsKICAgICAgICAgICAgcG9zID0gb25lLnN1YnN0cmluZygwLCBwb3MpLmxhc3RJbmRleE9mKCIvIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gb25lLnN1YnN0cmluZygwLCBwb3MgKyAxKTsKICAgICAgICB9OwogICAgICAgIFVSSS53aXRoaW5TdHJpbmcgPSBmdW5jdGlvbihzdHJpbmcsIGNhbGxiYWNrLCBvcHRpb25zKSB7CiAgICAgICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICAgICAgdmFyIF9zdGFydCA9IG9wdGlvbnMuc3RhcnQgfHwgVVJJLmZpbmRVcmkuc3RhcnQ7CiAgICAgICAgICB2YXIgX2VuZCA9IG9wdGlvbnMuZW5kIHx8IFVSSS5maW5kVXJpLmVuZDsKICAgICAgICAgIHZhciBfdHJpbSA9IG9wdGlvbnMudHJpbSB8fCBVUkkuZmluZFVyaS50cmltOwogICAgICAgICAgdmFyIF9wYXJlbnMgPSBvcHRpb25zLnBhcmVucyB8fCBVUkkuZmluZFVyaS5wYXJlbnM7CiAgICAgICAgICB2YXIgX2F0dHJpYnV0ZU9wZW4gPSAvW2EtejAtOS1dPVsiJ10/JC9pOwogICAgICAgICAgX3N0YXJ0Lmxhc3RJbmRleCA9IDA7CiAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICB2YXIgbWF0Y2ggPSBfc3RhcnQuZXhlYyhzdHJpbmcpOwogICAgICAgICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHN0YXJ0ID0gbWF0Y2guaW5kZXg7CiAgICAgICAgICAgIGlmIChvcHRpb25zLmlnbm9yZUh0bWwpIHsKICAgICAgICAgICAgICB2YXIgYXR0cmlidXRlT3BlbiA9IHN0cmluZy5zbGljZShNYXRoLm1heChzdGFydCAtIDMsIDApLCBzdGFydCk7CiAgICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZU9wZW4gJiYgX2F0dHJpYnV0ZU9wZW4udGVzdChhdHRyaWJ1dGVPcGVuKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBlbmQgPSBzdGFydCArIHN0cmluZy5zbGljZShzdGFydCkuc2VhcmNoKF9lbmQpOwogICAgICAgICAgICB2YXIgc2xpY2UgPSBzdHJpbmcuc2xpY2Uoc3RhcnQsIGVuZCk7CiAgICAgICAgICAgIHZhciBwYXJlbnNFbmQgPSAtMTsKICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICB2YXIgcGFyZW5zTWF0Y2ggPSBfcGFyZW5zLmV4ZWMoc2xpY2UpOwogICAgICAgICAgICAgIGlmICghcGFyZW5zTWF0Y2gpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcGFyZW5zTWF0Y2hFbmQgPSBwYXJlbnNNYXRjaC5pbmRleCArIHBhcmVuc01hdGNoWzBdLmxlbmd0aDsKICAgICAgICAgICAgICBwYXJlbnNFbmQgPSBNYXRoLm1heChwYXJlbnNFbmQsIHBhcmVuc01hdGNoRW5kKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocGFyZW5zRW5kID4gLTEpIHsKICAgICAgICAgICAgICBzbGljZSA9IHNsaWNlLnNsaWNlKDAsIHBhcmVuc0VuZCkgKyBzbGljZS5zbGljZShwYXJlbnNFbmQpLnJlcGxhY2UoX3RyaW0sICIiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzbGljZSA9IHNsaWNlLnJlcGxhY2UoX3RyaW0sICIiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2xpY2UubGVuZ3RoIDw9IG1hdGNoWzBdLmxlbmd0aCkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zLmlnbm9yZSAmJiBvcHRpb25zLmlnbm9yZS50ZXN0KHNsaWNlKSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVuZCA9IHN0YXJ0ICsgc2xpY2UubGVuZ3RoOwogICAgICAgICAgICB2YXIgcmVzdWx0ID0gY2FsbGJhY2soc2xpY2UsIHN0YXJ0LCBlbmQsIHN0cmluZyk7CiAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIF9zdGFydC5sYXN0SW5kZXggPSBlbmQ7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzdWx0ID0gU3RyaW5nKHJlc3VsdCk7CiAgICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5zbGljZSgwLCBzdGFydCkgKyByZXN1bHQgKyBzdHJpbmcuc2xpY2UoZW5kKTsKICAgICAgICAgICAgX3N0YXJ0Lmxhc3RJbmRleCA9IHN0YXJ0ICsgcmVzdWx0Lmxlbmd0aDsKICAgICAgICAgIH0KICAgICAgICAgIF9zdGFydC5sYXN0SW5kZXggPSAwOwogICAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgICB9OwogICAgICAgIFVSSS5lbnN1cmVWYWxpZEhvc3RuYW1lID0gZnVuY3Rpb24odjMsIHByb3RvY29sKSB7CiAgICAgICAgICB2YXIgaGFzSG9zdG5hbWUgPSAhIXYzOwogICAgICAgICAgdmFyIGhhc1Byb3RvY29sID0gISFwcm90b2NvbDsKICAgICAgICAgIHZhciByZWplY3RFbXB0eUhvc3RuYW1lID0gZmFsc2U7CiAgICAgICAgICBpZiAoaGFzUHJvdG9jb2wpIHsKICAgICAgICAgICAgcmVqZWN0RW1wdHlIb3N0bmFtZSA9IGFycmF5Q29udGFpbnMoVVJJLmhvc3RQcm90b2NvbHMsIHByb3RvY29sKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZWplY3RFbXB0eUhvc3RuYW1lICYmICFoYXNIb3N0bmFtZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJIb3N0bmFtZSBjYW5ub3QgYmUgZW1wdHksIGlmIHByb3RvY29sIGlzICIgKyBwcm90b2NvbCk7CiAgICAgICAgICB9IGVsc2UgaWYgKHYzICYmIHYzLm1hdGNoKFVSSS5pbnZhbGlkX2hvc3RuYW1lX2NoYXJhY3RlcnMpKSB7CiAgICAgICAgICAgIGlmICghcHVueWNvZGUpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdIb3N0bmFtZSAiJyArIHYzICsgJyIgY29udGFpbnMgY2hhcmFjdGVycyBvdGhlciB0aGFuIFtBLVowLTkuLTpfXSBhbmQgUHVueWNvZGUuanMgaXMgbm90IGF2YWlsYWJsZScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwdW55Y29kZS50b0FTQ0lJKHYzKS5tYXRjaChVUkkuaW52YWxpZF9ob3N0bmFtZV9jaGFyYWN0ZXJzKSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0hvc3RuYW1lICInICsgdjMgKyAnIiBjb250YWlucyBjaGFyYWN0ZXJzIG90aGVyIHRoYW4gW0EtWjAtOS4tOl9dJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIFVSSS5lbnN1cmVWYWxpZFBvcnQgPSBmdW5jdGlvbih2MykgewogICAgICAgICAgaWYgKCF2MykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcG9ydCA9IE51bWJlcih2Myk7CiAgICAgICAgICBpZiAoaXNJbnRlZ2VyKHBvcnQpICYmIHBvcnQgPiAwICYmIHBvcnQgPCA2NTUzNikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdQb3J0ICInICsgdjMgKyAnIiBpcyBub3QgYSB2YWxpZCBwb3J0Jyk7CiAgICAgICAgfTsKICAgICAgICBVUkkubm9Db25mbGljdCA9IGZ1bmN0aW9uKHJlbW92ZUFsbCkgewogICAgICAgICAgaWYgKHJlbW92ZUFsbCkgewogICAgICAgICAgICB2YXIgdW5jb25mbGljdGVkID0gewogICAgICAgICAgICAgIFVSSTogdGhpcy5ub0NvbmZsaWN0KCkKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKHJvb3QuVVJJVGVtcGxhdGUgJiYgdHlwZW9mIHJvb3QuVVJJVGVtcGxhdGUubm9Db25mbGljdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHVuY29uZmxpY3RlZC5VUklUZW1wbGF0ZSA9IHJvb3QuVVJJVGVtcGxhdGUubm9Db25mbGljdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyb290LklQdjYgJiYgdHlwZW9mIHJvb3QuSVB2Ni5ub0NvbmZsaWN0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdW5jb25mbGljdGVkLklQdjYgPSByb290LklQdjYubm9Db25mbGljdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyb290LlNlY29uZExldmVsRG9tYWlucyAmJiB0eXBlb2Ygcm9vdC5TZWNvbmRMZXZlbERvbWFpbnMubm9Db25mbGljdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHVuY29uZmxpY3RlZC5TZWNvbmRMZXZlbERvbWFpbnMgPSByb290LlNlY29uZExldmVsRG9tYWlucy5ub0NvbmZsaWN0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHVuY29uZmxpY3RlZDsKICAgICAgICAgIH0gZWxzZSBpZiAocm9vdC5VUkkgPT09IHRoaXMpIHsKICAgICAgICAgICAgcm9vdC5VUkkgPSBfVVJJOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICBwLmJ1aWxkID0gZnVuY3Rpb24oZGVmZXJCdWlsZCkgewogICAgICAgICAgaWYgKGRlZmVyQnVpbGQgPT09IHRydWUpIHsKICAgICAgICAgICAgdGhpcy5fZGVmZXJyZWRfYnVpbGQgPSB0cnVlOwogICAgICAgICAgfSBlbHNlIGlmIChkZWZlckJ1aWxkID09PSB2b2lkIDAgfHwgdGhpcy5fZGVmZXJyZWRfYnVpbGQpIHsKICAgICAgICAgICAgdGhpcy5fc3RyaW5nID0gVVJJLmJ1aWxkKHRoaXMuX3BhcnRzKTsKICAgICAgICAgICAgdGhpcy5fZGVmZXJyZWRfYnVpbGQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgcC5jbG9uZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIG5ldyBVUkkodGhpcyk7CiAgICAgICAgfTsKICAgICAgICBwLnZhbHVlT2YgPSBwLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5idWlsZChmYWxzZSkuX3N0cmluZzsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGdlbmVyYXRlU2ltcGxlQWNjZXNzb3IoX3BhcnQyKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICAgIGlmICh2MyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnRzW19wYXJ0Ml0gfHwgIiI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy5fcGFydHNbX3BhcnQyXSA9IHYzIHx8IG51bGw7CiAgICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZW5lcmF0ZVByZWZpeEFjY2Vzc29yKF9wYXJ0MiwgX2tleSkgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJ0c1tfcGFydDJdIHx8ICIiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICh2MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdjMgPSB2MyArICIiOwogICAgICAgICAgICAgICAgaWYgKHYzLmNoYXJBdCgwKSA9PT0gX2tleSkgewogICAgICAgICAgICAgICAgICB2MyA9IHYzLnN1YnN0cmluZygxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5fcGFydHNbX3BhcnQyXSA9IHYzOwogICAgICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcC5wcm90b2NvbCA9IGdlbmVyYXRlU2ltcGxlQWNjZXNzb3IoInByb3RvY29sIik7CiAgICAgICAgcC51c2VybmFtZSA9IGdlbmVyYXRlU2ltcGxlQWNjZXNzb3IoInVzZXJuYW1lIik7CiAgICAgICAgcC5wYXNzd29yZCA9IGdlbmVyYXRlU2ltcGxlQWNjZXNzb3IoInBhc3N3b3JkIik7CiAgICAgICAgcC5ob3N0bmFtZSA9IGdlbmVyYXRlU2ltcGxlQWNjZXNzb3IoImhvc3RuYW1lIik7CiAgICAgICAgcC5wb3J0ID0gZ2VuZXJhdGVTaW1wbGVBY2Nlc3NvcigicG9ydCIpOwogICAgICAgIHAucXVlcnkgPSBnZW5lcmF0ZVByZWZpeEFjY2Vzc29yKCJxdWVyeSIsICI/Iik7CiAgICAgICAgcC5mcmFnbWVudCA9IGdlbmVyYXRlUHJlZml4QWNjZXNzb3IoImZyYWdtZW50IiwgIiMiKTsKICAgICAgICBwLnNlYXJjaCA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgdmFyIHQgPSB0aGlzLnF1ZXJ5KHYzLCBidWlsZCk7CiAgICAgICAgICByZXR1cm4gdHlwZW9mIHQgPT09ICJzdHJpbmciICYmIHQubGVuZ3RoID8gIj8iICsgdCA6IHQ7CiAgICAgICAgfTsKICAgICAgICBwLmhhc2ggPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIHZhciB0ID0gdGhpcy5mcmFnbWVudCh2MywgYnVpbGQpOwogICAgICAgICAgcmV0dXJuIHR5cGVvZiB0ID09PSAic3RyaW5nIiAmJiB0Lmxlbmd0aCA/ICIjIiArIHQgOiB0OwogICAgICAgIH07CiAgICAgICAgcC5wYXRobmFtZSA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgaWYgKHYzID09PSB2b2lkIDAgfHwgdjMgPT09IHRydWUpIHsKICAgICAgICAgICAgdmFyIHJlcyA9IHRoaXMuX3BhcnRzLnBhdGggfHwgKHRoaXMuX3BhcnRzLmhvc3RuYW1lID8gIi8iIDogIiIpOwogICAgICAgICAgICByZXR1cm4gdjMgPyAodGhpcy5fcGFydHMudXJuID8gVVJJLmRlY29kZVVyblBhdGggOiBVUkkuZGVjb2RlUGF0aCkocmVzKSA6IHJlczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy51cm4pIHsKICAgICAgICAgICAgICB0aGlzLl9wYXJ0cy5wYXRoID0gdjMgPyBVUkkucmVjb2RlVXJuUGF0aCh2MykgOiAiIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLl9wYXJ0cy5wYXRoID0gdjMgPyBVUkkucmVjb2RlUGF0aCh2MykgOiAiLyI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHAucGF0aCA9IHAucGF0aG5hbWU7CiAgICAgICAgcC5ocmVmID0gZnVuY3Rpb24oaHJlZiwgYnVpbGQpIHsKICAgICAgICAgIHZhciBrZXk7CiAgICAgICAgICBpZiAoaHJlZiA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnRvU3RyaW5nKCk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9zdHJpbmcgPSAiIjsKICAgICAgICAgIHRoaXMuX3BhcnRzID0gVVJJLl9wYXJ0cygpOwogICAgICAgICAgdmFyIF9VUkkyID0gaHJlZiBpbnN0YW5jZW9mIFVSSTsKICAgICAgICAgIHZhciBfb2JqZWN0ID0gdHlwZW9mIGhyZWYgPT09ICJvYmplY3QiICYmIChocmVmLmhvc3RuYW1lIHx8IGhyZWYucGF0aCB8fCBocmVmLnBhdGhuYW1lKTsKICAgICAgICAgIGlmIChocmVmLm5vZGVOYW1lKSB7CiAgICAgICAgICAgIHZhciBhdHRyaWJ1dGUgPSBVUkkuZ2V0RG9tQXR0cmlidXRlKGhyZWYpOwogICAgICAgICAgICBocmVmID0gaHJlZlthdHRyaWJ1dGVdIHx8ICIiOwogICAgICAgICAgICBfb2JqZWN0ID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIV9VUkkyICYmIF9vYmplY3QgJiYgaHJlZi5wYXRobmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGhyZWYgPSBocmVmLnRvU3RyaW5nKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGhyZWYgPT09ICJzdHJpbmciIHx8IGhyZWYgaW5zdGFuY2VvZiBTdHJpbmcpIHsKICAgICAgICAgICAgdGhpcy5fcGFydHMgPSBVUkkucGFyc2UoU3RyaW5nKGhyZWYpLCB0aGlzLl9wYXJ0cyk7CiAgICAgICAgICB9IGVsc2UgaWYgKF9VUkkyIHx8IF9vYmplY3QpIHsKICAgICAgICAgICAgdmFyIHNyYyA9IF9VUkkyID8gaHJlZi5fcGFydHMgOiBocmVmOwogICAgICAgICAgICBmb3IgKGtleSBpbiBzcmMpIHsKICAgICAgICAgICAgICBpZiAoa2V5ID09PSAicXVlcnkiKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGhhc093bi5jYWxsKHRoaXMuX3BhcnRzLCBrZXkpKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0c1trZXldID0gc3JjW2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzcmMucXVlcnkpIHsKICAgICAgICAgICAgICB0aGlzLnF1ZXJ5KHNyYy5xdWVyeSwgZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJpbnZhbGlkIGlucHV0Iik7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAuaXMgPSBmdW5jdGlvbih3aGF0KSB7CiAgICAgICAgICB2YXIgaXAgPSBmYWxzZTsKICAgICAgICAgIHZhciBpcDQgPSBmYWxzZTsKICAgICAgICAgIHZhciBpcDYgPSBmYWxzZTsKICAgICAgICAgIHZhciBuYW1lID0gZmFsc2U7CiAgICAgICAgICB2YXIgc2xkID0gZmFsc2U7CiAgICAgICAgICB2YXIgaWRuID0gZmFsc2U7CiAgICAgICAgICB2YXIgcHVueWNvZGUyID0gZmFsc2U7CiAgICAgICAgICB2YXIgcmVsYXRpdmUgPSAhdGhpcy5fcGFydHMudXJuOwogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLmhvc3RuYW1lKSB7CiAgICAgICAgICAgIHJlbGF0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIGlwNCA9IFVSSS5pcDRfZXhwcmVzc2lvbi50ZXN0KHRoaXMuX3BhcnRzLmhvc3RuYW1lKTsKICAgICAgICAgICAgaXA2ID0gVVJJLmlwNl9leHByZXNzaW9uLnRlc3QodGhpcy5fcGFydHMuaG9zdG5hbWUpOwogICAgICAgICAgICBpcCA9IGlwNCB8fCBpcDY7CiAgICAgICAgICAgIG5hbWUgPSAhaXA7CiAgICAgICAgICAgIHNsZCA9IG5hbWUgJiYgU0xEICYmIFNMRC5oYXModGhpcy5fcGFydHMuaG9zdG5hbWUpOwogICAgICAgICAgICBpZG4gPSBuYW1lICYmIFVSSS5pZG5fZXhwcmVzc2lvbi50ZXN0KHRoaXMuX3BhcnRzLmhvc3RuYW1lKTsKICAgICAgICAgICAgcHVueWNvZGUyID0gbmFtZSAmJiBVUkkucHVueWNvZGVfZXhwcmVzc2lvbi50ZXN0KHRoaXMuX3BhcnRzLmhvc3RuYW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAod2hhdC50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgICAgIGNhc2UgInJlbGF0aXZlIjoKICAgICAgICAgICAgICByZXR1cm4gcmVsYXRpdmU7CiAgICAgICAgICAgIGNhc2UgImFic29sdXRlIjoKICAgICAgICAgICAgICByZXR1cm4gIXJlbGF0aXZlOwogICAgICAgICAgICBjYXNlICJkb21haW4iOgogICAgICAgICAgICBjYXNlICJuYW1lIjoKICAgICAgICAgICAgICByZXR1cm4gbmFtZTsKICAgICAgICAgICAgY2FzZSAic2xkIjoKICAgICAgICAgICAgICByZXR1cm4gc2xkOwogICAgICAgICAgICBjYXNlICJpcCI6CiAgICAgICAgICAgICAgcmV0dXJuIGlwOwogICAgICAgICAgICBjYXNlICJpcDQiOgogICAgICAgICAgICBjYXNlICJpcHY0IjoKICAgICAgICAgICAgY2FzZSAiaW5ldDQiOgogICAgICAgICAgICAgIHJldHVybiBpcDQ7CiAgICAgICAgICAgIGNhc2UgImlwNiI6CiAgICAgICAgICAgIGNhc2UgImlwdjYiOgogICAgICAgICAgICBjYXNlICJpbmV0NiI6CiAgICAgICAgICAgICAgcmV0dXJuIGlwNjsKICAgICAgICAgICAgY2FzZSAiaWRuIjoKICAgICAgICAgICAgICByZXR1cm4gaWRuOwogICAgICAgICAgICBjYXNlICJ1cmwiOgogICAgICAgICAgICAgIHJldHVybiAhdGhpcy5fcGFydHMudXJuOwogICAgICAgICAgICBjYXNlICJ1cm4iOgogICAgICAgICAgICAgIHJldHVybiAhIXRoaXMuX3BhcnRzLnVybjsKICAgICAgICAgICAgY2FzZSAicHVueWNvZGUiOgogICAgICAgICAgICAgIHJldHVybiBwdW55Y29kZTI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIHZhciBfcHJvdG9jb2wgPSBwLnByb3RvY29sOwogICAgICAgIHZhciBfcG9ydCA9IHAucG9ydDsKICAgICAgICB2YXIgX2hvc3RuYW1lID0gcC5ob3N0bmFtZTsKICAgICAgICBwLnByb3RvY29sID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICBpZiAodjMpIHsKICAgICAgICAgICAgdjMgPSB2My5yZXBsYWNlKC86KFwvXC8pPyQvLCAiIik7CiAgICAgICAgICAgIGlmICghdjMubWF0Y2goVVJJLnByb3RvY29sX2V4cHJlc3Npb24pKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignUHJvdG9jb2wgIicgKyB2MyArIGAiIGNvbnRhaW5zIGNoYXJhY3RlcnMgb3RoZXIgdGhhbiBbQS1aMC05ListXSBvciBkb2Vzbid0IHN0YXJ0IHdpdGggW0EtWl1gKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIF9wcm90b2NvbC5jYWxsKHRoaXMsIHYzLCBidWlsZCk7CiAgICAgICAgfTsKICAgICAgICBwLnNjaGVtZSA9IHAucHJvdG9jb2w7CiAgICAgICAgcC5wb3J0ID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHJldHVybiB2MyA9PT0gdm9pZCAwID8gIiIgOiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHYzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKHYzID09PSAwKSB7CiAgICAgICAgICAgICAgdjMgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2MykgewogICAgICAgICAgICAgIHYzICs9ICIiOwogICAgICAgICAgICAgIGlmICh2My5jaGFyQXQoMCkgPT09ICI6IikgewogICAgICAgICAgICAgICAgdjMgPSB2My5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIFVSSS5lbnN1cmVWYWxpZFBvcnQodjMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gX3BvcnQuY2FsbCh0aGlzLCB2MywgYnVpbGQpOwogICAgICAgIH07CiAgICAgICAgcC5ob3N0bmFtZSA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLnVybikgewogICAgICAgICAgICByZXR1cm4gdjMgPT09IHZvaWQgMCA/ICIiIDogdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2MyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHZhciB4ID0geyBwcmV2ZW50SW52YWxpZEhvc3RuYW1lOiB0aGlzLl9wYXJ0cy5wcmV2ZW50SW52YWxpZEhvc3RuYW1lIH07CiAgICAgICAgICAgIHZhciByZXMgPSBVUkkucGFyc2VIb3N0KHYzLCB4KTsKICAgICAgICAgICAgaWYgKHJlcyAhPT0gIi8iKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignSG9zdG5hbWUgIicgKyB2MyArICciIGNvbnRhaW5zIGNoYXJhY3RlcnMgb3RoZXIgdGhhbiBbQS1aMC05Li1dJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdjMgPSB4Lmhvc3RuYW1lOwogICAgICAgICAgICBpZiAodGhpcy5fcGFydHMucHJldmVudEludmFsaWRIb3N0bmFtZSkgewogICAgICAgICAgICAgIFVSSS5lbnN1cmVWYWxpZEhvc3RuYW1lKHYzLCB0aGlzLl9wYXJ0cy5wcm90b2NvbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBfaG9zdG5hbWUuY2FsbCh0aGlzLCB2MywgYnVpbGQpOwogICAgICAgIH07CiAgICAgICAgcC5vcmlnaW4gPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy51cm4pIHsKICAgICAgICAgICAgcmV0dXJuIHYzID09PSB2b2lkIDAgPyAiIiA6IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCkgewogICAgICAgICAgICB2YXIgcHJvdG9jb2wgPSB0aGlzLnByb3RvY29sKCk7CiAgICAgICAgICAgIHZhciBhdXRob3JpdHkgPSB0aGlzLmF1dGhvcml0eSgpOwogICAgICAgICAgICBpZiAoIWF1dGhvcml0eSkgewogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gKHByb3RvY29sID8gcHJvdG9jb2wgKyAiOi8vIiA6ICIiKSArIHRoaXMuYXV0aG9yaXR5KCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgb3JpZ2luID0gVVJJKHYzKTsKICAgICAgICAgICAgdGhpcy5wcm90b2NvbChvcmlnaW4ucHJvdG9jb2woKSkuYXV0aG9yaXR5KG9yaWdpbi5hdXRob3JpdHkoKSkuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBwLmhvc3QgPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy51cm4pIHsKICAgICAgICAgICAgcmV0dXJuIHYzID09PSB2b2lkIDAgPyAiIiA6IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFydHMuaG9zdG5hbWUgPyBVUkkuYnVpbGRIb3N0KHRoaXMuX3BhcnRzKSA6ICIiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJlcyA9IFVSSS5wYXJzZUhvc3QodjMsIHRoaXMuX3BhcnRzKTsKICAgICAgICAgICAgaWYgKHJlcyAhPT0gIi8iKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignSG9zdG5hbWUgIicgKyB2MyArICciIGNvbnRhaW5zIGNoYXJhY3RlcnMgb3RoZXIgdGhhbiBbQS1aMC05Li1dJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHAuYXV0aG9yaXR5ID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHJldHVybiB2MyA9PT0gdm9pZCAwID8gIiIgOiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHYzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnRzLmhvc3RuYW1lID8gVVJJLmJ1aWxkQXV0aG9yaXR5KHRoaXMuX3BhcnRzKSA6ICIiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJlcyA9IFVSSS5wYXJzZUF1dGhvcml0eSh2MywgdGhpcy5fcGFydHMpOwogICAgICAgICAgICBpZiAocmVzICE9PSAiLyIpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdIb3N0bmFtZSAiJyArIHYzICsgJyIgY29udGFpbnMgY2hhcmFjdGVycyBvdGhlciB0aGFuIFtBLVowLTkuLV0nKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcC51c2VyaW5mbyA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLnVybikgewogICAgICAgICAgICByZXR1cm4gdjMgPT09IHZvaWQgMCA/ICIiIDogdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2MyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHZhciB0ID0gVVJJLmJ1aWxkVXNlcmluZm8odGhpcy5fcGFydHMpOwogICAgICAgICAgICByZXR1cm4gdCA/IHQuc3Vic3RyaW5nKDAsIHQubGVuZ3RoIC0gMSkgOiB0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHYzW3YzLmxlbmd0aCAtIDFdICE9PSAiQCIpIHsKICAgICAgICAgICAgICB2MyArPSAiQCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgVVJJLnBhcnNlVXNlcmluZm8odjMsIHRoaXMuX3BhcnRzKTsKICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHAucmVzb3VyY2UgPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIHZhciBwYXJ0czsKICAgICAgICAgIGlmICh2MyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhdGgoKSArIHRoaXMuc2VhcmNoKCkgKyB0aGlzLmhhc2goKTsKICAgICAgICAgIH0KICAgICAgICAgIHBhcnRzID0gVVJJLnBhcnNlKHYzKTsKICAgICAgICAgIHRoaXMuX3BhcnRzLnBhdGggPSBwYXJ0cy5wYXRoOwogICAgICAgICAgdGhpcy5fcGFydHMucXVlcnkgPSBwYXJ0cy5xdWVyeTsKICAgICAgICAgIHRoaXMuX3BhcnRzLmZyYWdtZW50ID0gcGFydHMuZnJhZ21lbnQ7CiAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAuc3ViZG9tYWluID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHJldHVybiB2MyA9PT0gdm9pZCAwID8gIiIgOiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHYzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKCF0aGlzLl9wYXJ0cy5ob3N0bmFtZSB8fCB0aGlzLmlzKCJJUCIpKSB7CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBlbmQgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5sZW5ndGggLSB0aGlzLmRvbWFpbigpLmxlbmd0aCAtIDE7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5zdWJzdHJpbmcoMCwgZW5kKSB8fCAiIjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBlID0gdGhpcy5fcGFydHMuaG9zdG5hbWUubGVuZ3RoIC0gdGhpcy5kb21haW4oKS5sZW5ndGg7CiAgICAgICAgICAgIHZhciBzdWIgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5zdWJzdHJpbmcoMCwgZSk7CiAgICAgICAgICAgIHZhciByZXBsYWNlID0gbmV3IFJlZ0V4cCgiXiIgKyBlc2NhcGVSZWdFeChzdWIpKTsKICAgICAgICAgICAgaWYgKHYzICYmIHYzLmNoYXJBdCh2My5sZW5ndGggLSAxKSAhPT0gIi4iKSB7CiAgICAgICAgICAgICAgdjMgKz0gIi4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2My5pbmRleE9mKCI6IikgIT09IC0xKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiRG9tYWlucyBjYW5ub3QgY29udGFpbiBjb2xvbnMiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodjMpIHsKICAgICAgICAgICAgICBVUkkuZW5zdXJlVmFsaWRIb3N0bmFtZSh2MywgdGhpcy5fcGFydHMucHJvdG9jb2wpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3BhcnRzLmhvc3RuYW1lID0gdGhpcy5fcGFydHMuaG9zdG5hbWUucmVwbGFjZShyZXBsYWNlLCB2Myk7CiAgICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBwLmRvbWFpbiA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLnVybikgewogICAgICAgICAgICByZXR1cm4gdjMgPT09IHZvaWQgMCA/ICIiIDogdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdjMgPT09ICJib29sZWFuIikgewogICAgICAgICAgICBidWlsZCA9IHYzOwogICAgICAgICAgICB2MyA9IHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2MyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5fcGFydHMuaG9zdG5hbWUgfHwgdGhpcy5pcygiSVAiKSkgewogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdCA9IHRoaXMuX3BhcnRzLmhvc3RuYW1lLm1hdGNoKC9cLi9nKTsKICAgICAgICAgICAgaWYgKHQgJiYgdC5sZW5ndGggPCAyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnRzLmhvc3RuYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBlbmQgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5sZW5ndGggLSB0aGlzLnRsZChidWlsZCkubGVuZ3RoIC0gMTsKICAgICAgICAgICAgZW5kID0gdGhpcy5fcGFydHMuaG9zdG5hbWUubGFzdEluZGV4T2YoIi4iLCBlbmQgLSAxKSArIDE7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5zdWJzdHJpbmcoZW5kKSB8fCAiIjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICghdjMpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJjYW5ub3Qgc2V0IGRvbWFpbiBlbXB0eSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2My5pbmRleE9mKCI6IikgIT09IC0xKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiRG9tYWlucyBjYW5ub3QgY29udGFpbiBjb2xvbnMiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBVUkkuZW5zdXJlVmFsaWRIb3N0bmFtZSh2MywgdGhpcy5fcGFydHMucHJvdG9jb2wpOwogICAgICAgICAgICBpZiAoIXRoaXMuX3BhcnRzLmhvc3RuYW1lIHx8IHRoaXMuaXMoIklQIikpIHsKICAgICAgICAgICAgICB0aGlzLl9wYXJ0cy5ob3N0bmFtZSA9IHYzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciByZXBsYWNlID0gbmV3IFJlZ0V4cChlc2NhcGVSZWdFeCh0aGlzLmRvbWFpbigpKSArICIkIik7CiAgICAgICAgICAgICAgdGhpcy5fcGFydHMuaG9zdG5hbWUgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5yZXBsYWNlKHJlcGxhY2UsIHYzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcC50bGQgPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy51cm4pIHsKICAgICAgICAgICAgcmV0dXJuIHYzID09PSB2b2lkIDAgPyAiIiA6IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHYzID09PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgYnVpbGQgPSB2MzsKICAgICAgICAgICAgdjMgPSB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCkgewogICAgICAgICAgICBpZiAoIXRoaXMuX3BhcnRzLmhvc3RuYW1lIHx8IHRoaXMuaXMoIklQIikpIHsKICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHBvcyA9IHRoaXMuX3BhcnRzLmhvc3RuYW1lLmxhc3RJbmRleE9mKCIuIik7CiAgICAgICAgICAgIHZhciB0bGQgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5zdWJzdHJpbmcocG9zICsgMSk7CiAgICAgICAgICAgIGlmIChidWlsZCAhPT0gdHJ1ZSAmJiBTTEQgJiYgU0xELmxpc3RbdGxkLnRvTG93ZXJDYXNlKCldKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFNMRC5nZXQodGhpcy5fcGFydHMuaG9zdG5hbWUpIHx8IHRsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGxkOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJlcGxhY2U7CiAgICAgICAgICAgIGlmICghdjMpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJjYW5ub3Qgc2V0IFRMRCBlbXB0eSIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHYzLm1hdGNoKC9bXmEtekEtWjAtOS1dLykpIHsKICAgICAgICAgICAgICBpZiAoU0xEICYmIFNMRC5pcyh2MykpIHsKICAgICAgICAgICAgICAgIHJlcGxhY2UgPSBuZXcgUmVnRXhwKGVzY2FwZVJlZ0V4KHRoaXMudGxkKCkpICsgIiQiKTsKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRzLmhvc3RuYW1lID0gdGhpcy5fcGFydHMuaG9zdG5hbWUucmVwbGFjZShyZXBsYWNlLCB2Myk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1RMRCAiJyArIHYzICsgJyIgY29udGFpbnMgY2hhcmFjdGVycyBvdGhlciB0aGFuIFtBLVowLTldJyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLl9wYXJ0cy5ob3N0bmFtZSB8fCB0aGlzLmlzKCJJUCIpKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFJlZmVyZW5jZUVycm9yKCJjYW5ub3Qgc2V0IFRMRCBvbiBub24tZG9tYWluIGhvc3QiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXBsYWNlID0gbmV3IFJlZ0V4cChlc2NhcGVSZWdFeCh0aGlzLnRsZCgpKSArICIkIik7CiAgICAgICAgICAgICAgdGhpcy5fcGFydHMuaG9zdG5hbWUgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5yZXBsYWNlKHJlcGxhY2UsIHYzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcC5kaXJlY3RvcnkgPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy51cm4pIHsKICAgICAgICAgICAgcmV0dXJuIHYzID09PSB2b2lkIDAgPyAiIiA6IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCB8fCB2MyA9PT0gdHJ1ZSkgewogICAgICAgICAgICBpZiAoIXRoaXMuX3BhcnRzLnBhdGggJiYgIXRoaXMuX3BhcnRzLmhvc3RuYW1lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy5wYXRoID09PSAiLyIpIHsKICAgICAgICAgICAgICByZXR1cm4gIi8iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBlbmQgPSB0aGlzLl9wYXJ0cy5wYXRoLmxlbmd0aCAtIHRoaXMuZmlsZW5hbWUoKS5sZW5ndGggLSAxOwogICAgICAgICAgICB2YXIgcmVzID0gdGhpcy5fcGFydHMucGF0aC5zdWJzdHJpbmcoMCwgZW5kKSB8fCAodGhpcy5fcGFydHMuaG9zdG5hbWUgPyAiLyIgOiAiIik7CiAgICAgICAgICAgIHJldHVybiB2MyA/IFVSSS5kZWNvZGVQYXRoKHJlcykgOiByZXM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZSA9IHRoaXMuX3BhcnRzLnBhdGgubGVuZ3RoIC0gdGhpcy5maWxlbmFtZSgpLmxlbmd0aDsKICAgICAgICAgICAgdmFyIGRpcmVjdG9yeSA9IHRoaXMuX3BhcnRzLnBhdGguc3Vic3RyaW5nKDAsIGUpOwogICAgICAgICAgICB2YXIgcmVwbGFjZSA9IG5ldyBSZWdFeHAoIl4iICsgZXNjYXBlUmVnRXgoZGlyZWN0b3J5KSk7CiAgICAgICAgICAgIGlmICghdGhpcy5pcygicmVsYXRpdmUiKSkgewogICAgICAgICAgICAgIGlmICghdjMpIHsKICAgICAgICAgICAgICAgIHYzID0gIi8iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodjMuY2hhckF0KDApICE9PSAiLyIpIHsKICAgICAgICAgICAgICAgIHYzID0gIi8iICsgdjM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2MyAmJiB2My5jaGFyQXQodjMubGVuZ3RoIC0gMSkgIT09ICIvIikgewogICAgICAgICAgICAgIHYzICs9ICIvIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2MyA9IFVSSS5yZWNvZGVQYXRoKHYzKTsKICAgICAgICAgICAgdGhpcy5fcGFydHMucGF0aCA9IHRoaXMuX3BhcnRzLnBhdGgucmVwbGFjZShyZXBsYWNlLCB2Myk7CiAgICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBwLmZpbGVuYW1lID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHJldHVybiB2MyA9PT0gdm9pZCAwID8gIiIgOiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB2MyAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLl9wYXJ0cy5wYXRoIHx8IHRoaXMuX3BhcnRzLnBhdGggPT09ICIvIikgewogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcG9zID0gdGhpcy5fcGFydHMucGF0aC5sYXN0SW5kZXhPZigiLyIpOwogICAgICAgICAgICB2YXIgcmVzID0gdGhpcy5fcGFydHMucGF0aC5zdWJzdHJpbmcocG9zICsgMSk7CiAgICAgICAgICAgIHJldHVybiB2MyA/IFVSSS5kZWNvZGVQYXRoU2VnbWVudChyZXMpIDogcmVzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIG11dGF0ZWREaXJlY3RvcnkgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHYzLmNoYXJBdCgwKSA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgdjMgPSB2My5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHYzLm1hdGNoKC9cLj9cLy8pKSB7CiAgICAgICAgICAgICAgbXV0YXRlZERpcmVjdG9yeSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJlcGxhY2UgPSBuZXcgUmVnRXhwKGVzY2FwZVJlZ0V4KHRoaXMuZmlsZW5hbWUoKSkgKyAiJCIpOwogICAgICAgICAgICB2MyA9IFVSSS5yZWNvZGVQYXRoKHYzKTsKICAgICAgICAgICAgdGhpcy5fcGFydHMucGF0aCA9IHRoaXMuX3BhcnRzLnBhdGgucmVwbGFjZShyZXBsYWNlLCB2Myk7CiAgICAgICAgICAgIGlmIChtdXRhdGVkRGlyZWN0b3J5KSB7CiAgICAgICAgICAgICAgdGhpcy5ub3JtYWxpemVQYXRoKGJ1aWxkKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBwLnN1ZmZpeCA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLnVybikgewogICAgICAgICAgICByZXR1cm4gdjMgPT09IHZvaWQgMCA/ICIiIDogdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2MyA9PT0gdm9pZCAwIHx8IHYzID09PSB0cnVlKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5fcGFydHMucGF0aCB8fCB0aGlzLl9wYXJ0cy5wYXRoID09PSAiLyIpIHsKICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZpbGVuYW1lID0gdGhpcy5maWxlbmFtZSgpOwogICAgICAgICAgICB2YXIgcG9zID0gZmlsZW5hbWUubGFzdEluZGV4T2YoIi4iKTsKICAgICAgICAgICAgdmFyIHMsIHJlczsKICAgICAgICAgICAgaWYgKHBvcyA9PT0gLTEpIHsKICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcyA9IGZpbGVuYW1lLnN1YnN0cmluZyhwb3MgKyAxKTsKICAgICAgICAgICAgcmVzID0gL15bYS16MC05JV0rJC9pLnRlc3QocykgPyBzIDogIiI7CiAgICAgICAgICAgIHJldHVybiB2MyA/IFVSSS5kZWNvZGVQYXRoU2VnbWVudChyZXMpIDogcmVzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHYzLmNoYXJBdCgwKSA9PT0gIi4iKSB7CiAgICAgICAgICAgICAgdjMgPSB2My5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHN1ZmZpeCA9IHRoaXMuc3VmZml4KCk7CiAgICAgICAgICAgIHZhciByZXBsYWNlOwogICAgICAgICAgICBpZiAoIXN1ZmZpeCkgewogICAgICAgICAgICAgIGlmICghdjMpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLl9wYXJ0cy5wYXRoICs9ICIuIiArIFVSSS5yZWNvZGVQYXRoKHYzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghdjMpIHsKICAgICAgICAgICAgICByZXBsYWNlID0gbmV3IFJlZ0V4cChlc2NhcGVSZWdFeCgiLiIgKyBzdWZmaXgpICsgIiQiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXBsYWNlID0gbmV3IFJlZ0V4cChlc2NhcGVSZWdFeChzdWZmaXgpICsgIiQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmVwbGFjZSkgewogICAgICAgICAgICAgIHYzID0gVVJJLnJlY29kZVBhdGgodjMpOwogICAgICAgICAgICAgIHRoaXMuX3BhcnRzLnBhdGggPSB0aGlzLl9wYXJ0cy5wYXRoLnJlcGxhY2UocmVwbGFjZSwgdjMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBwLnNlZ21lbnQgPSBmdW5jdGlvbihzZWdtZW50LCB2MywgYnVpbGQpIHsKICAgICAgICAgIHZhciBzZXBhcmF0b3IgPSB0aGlzLl9wYXJ0cy51cm4gPyAiOiIgOiAiLyI7CiAgICAgICAgICB2YXIgcGF0aCA9IHRoaXMucGF0aCgpOwogICAgICAgICAgdmFyIGFic29sdXRlID0gcGF0aC5zdWJzdHJpbmcoMCwgMSkgPT09ICIvIjsKICAgICAgICAgIHZhciBzZWdtZW50cyA9IHBhdGguc3BsaXQoc2VwYXJhdG9yKTsKICAgICAgICAgIGlmIChzZWdtZW50ICE9PSB2b2lkIDAgJiYgdHlwZW9mIHNlZ21lbnQgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIGJ1aWxkID0gdjM7CiAgICAgICAgICAgIHYzID0gc2VnbWVudDsKICAgICAgICAgICAgc2VnbWVudCA9IHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzZWdtZW50ICE9PSB2b2lkIDAgJiYgdHlwZW9mIHNlZ21lbnQgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQmFkIHNlZ21lbnQgIicgKyBzZWdtZW50ICsgJyIsIG11c3QgYmUgMC1iYXNlZCBpbnRlZ2VyJyk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYWJzb2x1dGUpIHsKICAgICAgICAgICAgc2VnbWVudHMuc2hpZnQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzZWdtZW50IDwgMCkgewogICAgICAgICAgICBzZWdtZW50ID0gTWF0aC5tYXgoc2VnbWVudHMubGVuZ3RoICsgc2VnbWVudCwgMCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gc2VnbWVudCA9PT0gdm9pZCAwID8gc2VnbWVudHMgOiBzZWdtZW50c1tzZWdtZW50XTsKICAgICAgICAgIH0gZWxzZSBpZiAoc2VnbWVudCA9PT0gbnVsbCB8fCBzZWdtZW50c1tzZWdtZW50XSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmIChpc0FycmF5KHYzKSkgewogICAgICAgICAgICAgIHNlZ21lbnRzID0gW107CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB2My5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICghdjNbaV0ubGVuZ3RoICYmICghc2VnbWVudHMubGVuZ3RoIHx8ICFzZWdtZW50c1tzZWdtZW50cy5sZW5ndGggLSAxXS5sZW5ndGgpKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHNlZ21lbnRzLmxlbmd0aCAmJiAhc2VnbWVudHNbc2VnbWVudHMubGVuZ3RoIC0gMV0ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIHNlZ21lbnRzLnBvcCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2VnbWVudHMucHVzaCh0cmltU2xhc2hlcyh2M1tpXSkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh2MyB8fCB0eXBlb2YgdjMgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgdjMgPSB0cmltU2xhc2hlcyh2Myk7CiAgICAgICAgICAgICAgaWYgKHNlZ21lbnRzW3NlZ21lbnRzLmxlbmd0aCAtIDFdID09PSAiIikgewogICAgICAgICAgICAgICAgc2VnbWVudHNbc2VnbWVudHMubGVuZ3RoIC0gMV0gPSB2MzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2VnbWVudHMucHVzaCh2Myk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodjMpIHsKICAgICAgICAgICAgICBzZWdtZW50c1tzZWdtZW50XSA9IHRyaW1TbGFzaGVzKHYzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzZWdtZW50cy5zcGxpY2Uoc2VnbWVudCwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChhYnNvbHV0ZSkgewogICAgICAgICAgICBzZWdtZW50cy51bnNoaWZ0KCIiKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzLnBhdGgoc2VnbWVudHMuam9pbihzZXBhcmF0b3IpLCBidWlsZCk7CiAgICAgICAgfTsKICAgICAgICBwLnNlZ21lbnRDb2RlZCA9IGZ1bmN0aW9uKHNlZ21lbnQsIHYzLCBidWlsZCkgewogICAgICAgICAgdmFyIHNlZ21lbnRzLCBpLCBsOwogICAgICAgICAgaWYgKHR5cGVvZiBzZWdtZW50ICE9PSAibnVtYmVyIikgewogICAgICAgICAgICBidWlsZCA9IHYzOwogICAgICAgICAgICB2MyA9IHNlZ21lbnQ7CiAgICAgICAgICAgIHNlZ21lbnQgPSB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCkgewogICAgICAgICAgICBzZWdtZW50cyA9IHRoaXMuc2VnbWVudChzZWdtZW50LCB2MywgYnVpbGQpOwogICAgICAgICAgICBpZiAoIWlzQXJyYXkoc2VnbWVudHMpKSB7CiAgICAgICAgICAgICAgc2VnbWVudHMgPSBzZWdtZW50cyAhPT0gdm9pZCAwID8gVVJJLmRlY29kZShzZWdtZW50cykgOiB2b2lkIDA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IHNlZ21lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgc2VnbWVudHNbaV0gPSBVUkkuZGVjb2RlKHNlZ21lbnRzW2ldKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNlZ21lbnRzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0FycmF5KHYzKSkgewogICAgICAgICAgICB2MyA9IHR5cGVvZiB2MyA9PT0gInN0cmluZyIgfHwgdjMgaW5zdGFuY2VvZiBTdHJpbmcgPyBVUkkuZW5jb2RlKHYzKSA6IHYzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IHYzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgIHYzW2ldID0gVVJJLmVuY29kZSh2M1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzLnNlZ21lbnQoc2VnbWVudCwgdjMsIGJ1aWxkKTsKICAgICAgICB9OwogICAgICAgIHZhciBxID0gcC5xdWVyeTsKICAgICAgICBwLnF1ZXJ5ID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICBpZiAodjMgPT09IHRydWUpIHsKICAgICAgICAgICAgcmV0dXJuIFVSSS5wYXJzZVF1ZXJ5KHRoaXMuX3BhcnRzLnF1ZXJ5LCB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlKTsKICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHYzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciBkYXRhID0gVVJJLnBhcnNlUXVlcnkodGhpcy5fcGFydHMucXVlcnksIHRoaXMuX3BhcnRzLmVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgICB2YXIgcmVzdWx0ID0gdjMuY2FsbCh0aGlzLCBkYXRhKTsKICAgICAgICAgICAgdGhpcy5fcGFydHMucXVlcnkgPSBVUkkuYnVpbGRRdWVyeShyZXN1bHQgfHwgZGF0YSwgdGhpcy5fcGFydHMuZHVwbGljYXRlUXVlcnlQYXJhbWV0ZXJzLCB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlKTsKICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0gZWxzZSBpZiAodjMgIT09IHZvaWQgMCAmJiB0eXBlb2YgdjMgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHRoaXMuX3BhcnRzLnF1ZXJ5ID0gVVJJLmJ1aWxkUXVlcnkodjMsIHRoaXMuX3BhcnRzLmR1cGxpY2F0ZVF1ZXJ5UGFyYW1ldGVycywgdGhpcy5fcGFydHMuZXNjYXBlUXVlcnlTcGFjZSk7CiAgICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gcS5jYWxsKHRoaXMsIHYzLCBidWlsZCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBwLnNldFF1ZXJ5ID0gZnVuY3Rpb24obmFtZSwgdmFsdWUsIGJ1aWxkKSB7CiAgICAgICAgICB2YXIgZGF0YSA9IFVSSS5wYXJzZVF1ZXJ5KHRoaXMuX3BhcnRzLnF1ZXJ5LCB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlKTsKICAgICAgICAgIGlmICh0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIgfHwgbmFtZSBpbnN0YW5jZW9mIFN0cmluZykgewogICAgICAgICAgICBkYXRhW25hbWVdID0gdmFsdWUgIT09IHZvaWQgMCA/IHZhbHVlIDogbnVsbDsKICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG5hbWUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBuYW1lKSB7CiAgICAgICAgICAgICAgaWYgKGhhc093bi5jYWxsKG5hbWUsIGtleSkpIHsKICAgICAgICAgICAgICAgIGRhdGFba2V5XSA9IG5hbWVba2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlVSSS5hZGRRdWVyeSgpIGFjY2VwdHMgYW4gb2JqZWN0LCBzdHJpbmcgYXMgdGhlIG5hbWUgcGFyYW1ldGVyIik7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9wYXJ0cy5xdWVyeSA9IFVSSS5idWlsZFF1ZXJ5KGRhdGEsIHRoaXMuX3BhcnRzLmR1cGxpY2F0ZVF1ZXJ5UGFyYW1ldGVycywgdGhpcy5fcGFydHMuZXNjYXBlUXVlcnlTcGFjZSk7CiAgICAgICAgICBpZiAodHlwZW9mIG5hbWUgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGJ1aWxkID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAuYWRkUXVlcnkgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSwgYnVpbGQpIHsKICAgICAgICAgIHZhciBkYXRhID0gVVJJLnBhcnNlUXVlcnkodGhpcy5fcGFydHMucXVlcnksIHRoaXMuX3BhcnRzLmVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgVVJJLmFkZFF1ZXJ5KGRhdGEsIG5hbWUsIHZhbHVlID09PSB2b2lkIDAgPyBudWxsIDogdmFsdWUpOwogICAgICAgICAgdGhpcy5fcGFydHMucXVlcnkgPSBVUkkuYnVpbGRRdWVyeShkYXRhLCB0aGlzLl9wYXJ0cy5kdXBsaWNhdGVRdWVyeVBhcmFtZXRlcnMsIHRoaXMuX3BhcnRzLmVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgaWYgKHR5cGVvZiBuYW1lICE9PSAic3RyaW5nIikgewogICAgICAgICAgICBidWlsZCA9IHZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICBwLnJlbW92ZVF1ZXJ5ID0gZnVuY3Rpb24obmFtZSwgdmFsdWUsIGJ1aWxkKSB7CiAgICAgICAgICB2YXIgZGF0YSA9IFVSSS5wYXJzZVF1ZXJ5KHRoaXMuX3BhcnRzLnF1ZXJ5LCB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlKTsKICAgICAgICAgIFVSSS5yZW1vdmVRdWVyeShkYXRhLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgICB0aGlzLl9wYXJ0cy5xdWVyeSA9IFVSSS5idWlsZFF1ZXJ5KGRhdGEsIHRoaXMuX3BhcnRzLmR1cGxpY2F0ZVF1ZXJ5UGFyYW1ldGVycywgdGhpcy5fcGFydHMuZXNjYXBlUXVlcnlTcGFjZSk7CiAgICAgICAgICBpZiAodHlwZW9mIG5hbWUgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGJ1aWxkID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAuaGFzUXVlcnkgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSwgd2l0aGluQXJyYXkpIHsKICAgICAgICAgIHZhciBkYXRhID0gVVJJLnBhcnNlUXVlcnkodGhpcy5fcGFydHMucXVlcnksIHRoaXMuX3BhcnRzLmVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgcmV0dXJuIFVSSS5oYXNRdWVyeShkYXRhLCBuYW1lLCB2YWx1ZSwgd2l0aGluQXJyYXkpOwogICAgICAgIH07CiAgICAgICAgcC5zZXRTZWFyY2ggPSBwLnNldFF1ZXJ5OwogICAgICAgIHAuYWRkU2VhcmNoID0gcC5hZGRRdWVyeTsKICAgICAgICBwLnJlbW92ZVNlYXJjaCA9IHAucmVtb3ZlUXVlcnk7CiAgICAgICAgcC5oYXNTZWFyY2ggPSBwLmhhc1F1ZXJ5OwogICAgICAgIHAubm9ybWFsaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZVByb3RvY29sKGZhbHNlKS5ub3JtYWxpemVQYXRoKGZhbHNlKS5ub3JtYWxpemVRdWVyeShmYWxzZSkubm9ybWFsaXplRnJhZ21lbnQoZmFsc2UpLmJ1aWxkKCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVQcm90b2NvbChmYWxzZSkubm9ybWFsaXplSG9zdG5hbWUoZmFsc2UpLm5vcm1hbGl6ZVBvcnQoZmFsc2UpLm5vcm1hbGl6ZVBhdGgoZmFsc2UpLm5vcm1hbGl6ZVF1ZXJ5KGZhbHNlKS5ub3JtYWxpemVGcmFnbWVudChmYWxzZSkuYnVpbGQoKTsKICAgICAgICB9OwogICAgICAgIHAubm9ybWFsaXplUHJvdG9jb2wgPSBmdW5jdGlvbihidWlsZCkgewogICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLl9wYXJ0cy5wcm90b2NvbCA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgdGhpcy5fcGFydHMucHJvdG9jb2wgPSB0aGlzLl9wYXJ0cy5wcm90b2NvbC50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAubm9ybWFsaXplSG9zdG5hbWUgPSBmdW5jdGlvbihidWlsZCkgewogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLmhvc3RuYW1lKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzKCJJRE4iKSAmJiBwdW55Y29kZSkgewogICAgICAgICAgICAgIHRoaXMuX3BhcnRzLmhvc3RuYW1lID0gcHVueWNvZGUudG9BU0NJSSh0aGlzLl9wYXJ0cy5ob3N0bmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pcygiSVB2NiIpICYmIElQdjYpIHsKICAgICAgICAgICAgICB0aGlzLl9wYXJ0cy5ob3N0bmFtZSA9IElQdjYuYmVzdCh0aGlzLl9wYXJ0cy5ob3N0bmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fcGFydHMuaG9zdG5hbWUgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAubm9ybWFsaXplUG9ydCA9IGZ1bmN0aW9uKGJ1aWxkKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuX3BhcnRzLnByb3RvY29sID09PSAic3RyaW5nIiAmJiB0aGlzLl9wYXJ0cy5wb3J0ID09PSBVUkkuZGVmYXVsdFBvcnRzW3RoaXMuX3BhcnRzLnByb3RvY29sXSkgewogICAgICAgICAgICB0aGlzLl9wYXJ0cy5wb3J0ID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICBwLm5vcm1hbGl6ZVBhdGggPSBmdW5jdGlvbihidWlsZCkgewogICAgICAgICAgdmFyIF9wYXRoID0gdGhpcy5fcGFydHMucGF0aDsKICAgICAgICAgIGlmICghX3BhdGgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHRoaXMuX3BhcnRzLnBhdGggPSBVUkkucmVjb2RlVXJuUGF0aCh0aGlzLl9wYXJ0cy5wYXRoKTsKICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy5wYXRoID09PSAiLyIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBfcGF0aCA9IFVSSS5yZWNvZGVQYXRoKF9wYXRoKTsKICAgICAgICAgIHZhciBfd2FzX3JlbGF0aXZlOwogICAgICAgICAgdmFyIF9sZWFkaW5nUGFyZW50cyA9ICIiOwogICAgICAgICAgdmFyIF9wYXJlbnQsIF9wb3M7CiAgICAgICAgICBpZiAoX3BhdGguY2hhckF0KDApICE9PSAiLyIpIHsKICAgICAgICAgICAgX3dhc19yZWxhdGl2ZSA9IHRydWU7CiAgICAgICAgICAgIF9wYXRoID0gIi8iICsgX3BhdGg7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoX3BhdGguc2xpY2UoLTMpID09PSAiLy4uIiB8fCBfcGF0aC5zbGljZSgtMikgPT09ICIvLiIpIHsKICAgICAgICAgICAgX3BhdGggKz0gIi8iOwogICAgICAgICAgfQogICAgICAgICAgX3BhdGggPSBfcGF0aC5yZXBsYWNlKC8oXC8oXC5cLykrKXwoXC9cLiQpL2csICIvIikucmVwbGFjZSgvXC97Mix9L2csICIvIik7CiAgICAgICAgICBpZiAoX3dhc19yZWxhdGl2ZSkgewogICAgICAgICAgICBfbGVhZGluZ1BhcmVudHMgPSBfcGF0aC5zdWJzdHJpbmcoMSkubWF0Y2goL14oXC5cLlwvKSsvKSB8fCAiIjsKICAgICAgICAgICAgaWYgKF9sZWFkaW5nUGFyZW50cykgewogICAgICAgICAgICAgIF9sZWFkaW5nUGFyZW50cyA9IF9sZWFkaW5nUGFyZW50c1swXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgX3BhcmVudCA9IF9wYXRoLnNlYXJjaCgvXC9cLlwuKFwvfCQpLyk7CiAgICAgICAgICAgIGlmIChfcGFyZW50ID09PSAtMSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9IGVsc2UgaWYgKF9wYXJlbnQgPT09IDApIHsKICAgICAgICAgICAgICBfcGF0aCA9IF9wYXRoLnN1YnN0cmluZygzKTsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfcG9zID0gX3BhdGguc3Vic3RyaW5nKDAsIF9wYXJlbnQpLmxhc3RJbmRleE9mKCIvIik7CiAgICAgICAgICAgIGlmIChfcG9zID09PSAtMSkgewogICAgICAgICAgICAgIF9wb3MgPSBfcGFyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIF9wYXRoID0gX3BhdGguc3Vic3RyaW5nKDAsIF9wb3MpICsgX3BhdGguc3Vic3RyaW5nKF9wYXJlbnQgKyAzKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChfd2FzX3JlbGF0aXZlICYmIHRoaXMuaXMoInJlbGF0aXZlIikpIHsKICAgICAgICAgICAgX3BhdGggPSBfbGVhZGluZ1BhcmVudHMgKyBfcGF0aC5zdWJzdHJpbmcoMSk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9wYXJ0cy5wYXRoID0gX3BhdGg7CiAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAubm9ybWFsaXplUGF0aG5hbWUgPSBwLm5vcm1hbGl6ZVBhdGg7CiAgICAgICAgcC5ub3JtYWxpemVRdWVyeSA9IGZ1bmN0aW9uKGJ1aWxkKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuX3BhcnRzLnF1ZXJ5ID09PSAic3RyaW5nIikgewogICAgICAgICAgICBpZiAoIXRoaXMuX3BhcnRzLnF1ZXJ5Lmxlbmd0aCkgewogICAgICAgICAgICAgIHRoaXMuX3BhcnRzLnF1ZXJ5ID0gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLnF1ZXJ5KFVSSS5wYXJzZVF1ZXJ5KHRoaXMuX3BhcnRzLnF1ZXJ5LCB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICBwLm5vcm1hbGl6ZUZyYWdtZW50ID0gZnVuY3Rpb24oYnVpbGQpIHsKICAgICAgICAgIGlmICghdGhpcy5fcGFydHMuZnJhZ21lbnQpIHsKICAgICAgICAgICAgdGhpcy5fcGFydHMuZnJhZ21lbnQgPSBudWxsOwogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAubm9ybWFsaXplU2VhcmNoID0gcC5ub3JtYWxpemVRdWVyeTsKICAgICAgICBwLm5vcm1hbGl6ZUhhc2ggPSBwLm5vcm1hbGl6ZUZyYWdtZW50OwogICAgICAgIHAuaXNvODg1OSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGUgPSBVUkkuZW5jb2RlOwogICAgICAgICAgdmFyIGQgPSBVUkkuZGVjb2RlOwogICAgICAgICAgVVJJLmVuY29kZSA9IGVzY2FwZTsKICAgICAgICAgIFVSSS5kZWNvZGUgPSBkZWNvZGVVUklDb21wb25lbnQ7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB0aGlzLm5vcm1hbGl6ZSgpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgVVJJLmVuY29kZSA9IGU7CiAgICAgICAgICAgIFVSSS5kZWNvZGUgPSBkOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICBwLnVuaWNvZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBlID0gVVJJLmVuY29kZTsKICAgICAgICAgIHZhciBkID0gVVJJLmRlY29kZTsKICAgICAgICAgIFVSSS5lbmNvZGUgPSBzdHJpY3RFbmNvZGVVUklDb21wb25lbnQ7CiAgICAgICAgICBVUkkuZGVjb2RlID0gdW5lc2NhcGU7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB0aGlzLm5vcm1hbGl6ZSgpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgVVJJLmVuY29kZSA9IGU7CiAgICAgICAgICAgIFVSSS5kZWNvZGUgPSBkOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICBwLnJlYWRhYmxlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgdXJpID0gdGhpcy5jbG9uZSgpOwogICAgICAgICAgdXJpLnVzZXJuYW1lKCIiKS5wYXNzd29yZCgiIikubm9ybWFsaXplKCk7CiAgICAgICAgICB2YXIgdCA9ICIiOwogICAgICAgICAgaWYgKHVyaS5fcGFydHMucHJvdG9jb2wpIHsKICAgICAgICAgICAgdCArPSB1cmkuX3BhcnRzLnByb3RvY29sICsgIjovLyI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodXJpLl9wYXJ0cy5ob3N0bmFtZSkgewogICAgICAgICAgICBpZiAodXJpLmlzKCJwdW55Y29kZSIpICYmIHB1bnljb2RlKSB7CiAgICAgICAgICAgICAgdCArPSBwdW55Y29kZS50b1VuaWNvZGUodXJpLl9wYXJ0cy5ob3N0bmFtZSk7CiAgICAgICAgICAgICAgaWYgKHVyaS5fcGFydHMucG9ydCkgewogICAgICAgICAgICAgICAgdCArPSAiOiIgKyB1cmkuX3BhcnRzLnBvcnQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHQgKz0gdXJpLmhvc3QoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHVyaS5fcGFydHMuaG9zdG5hbWUgJiYgdXJpLl9wYXJ0cy5wYXRoICYmIHVyaS5fcGFydHMucGF0aC5jaGFyQXQoMCkgIT09ICIvIikgewogICAgICAgICAgICB0ICs9ICIvIjsKICAgICAgICAgIH0KICAgICAgICAgIHQgKz0gdXJpLnBhdGgodHJ1ZSk7CiAgICAgICAgICBpZiAodXJpLl9wYXJ0cy5xdWVyeSkgewogICAgICAgICAgICB2YXIgcTMgPSAiIjsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIHFwID0gdXJpLl9wYXJ0cy5xdWVyeS5zcGxpdCgiJiIpLCBsID0gcXAubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGt2ID0gKHFwW2ldIHx8ICIiKS5zcGxpdCgiPSIpOwogICAgICAgICAgICAgIHEzICs9ICImIiArIFVSSS5kZWNvZGVRdWVyeShrdlswXSwgdGhpcy5fcGFydHMuZXNjYXBlUXVlcnlTcGFjZSkucmVwbGFjZSgvJi9nLCAiJTI2Iik7CiAgICAgICAgICAgICAgaWYgKGt2WzFdICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHEzICs9ICI9IiArIFVSSS5kZWNvZGVRdWVyeShrdlsxXSwgdGhpcy5fcGFydHMuZXNjYXBlUXVlcnlTcGFjZSkucmVwbGFjZSgvJi9nLCAiJTI2Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHQgKz0gIj8iICsgcTMuc3Vic3RyaW5nKDEpOwogICAgICAgICAgfQogICAgICAgICAgdCArPSBVUkkuZGVjb2RlUXVlcnkodXJpLmhhc2goKSwgdHJ1ZSk7CiAgICAgICAgICByZXR1cm4gdDsKICAgICAgICB9OwogICAgICAgIHAuYWJzb2x1dGVUbyA9IGZ1bmN0aW9uKGJhc2UpIHsKICAgICAgICAgIHZhciByZXNvbHZlZCA9IHRoaXMuY2xvbmUoKTsKICAgICAgICAgIHZhciBwcm9wZXJ0aWVzID0gWyJwcm90b2NvbCIsICJ1c2VybmFtZSIsICJwYXNzd29yZCIsICJob3N0bmFtZSIsICJwb3J0Il07CiAgICAgICAgICB2YXIgYmFzZWRpciwgaSwgcDI7CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVVJOcyBkbyBub3QgaGF2ZSBhbnkgZ2VuZXJhbGx5IGRlZmluZWQgaGllcmFyY2hpY2FsIGNvbXBvbmVudHMiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghKGJhc2UgaW5zdGFuY2VvZiBVUkkpKSB7CiAgICAgICAgICAgIGJhc2UgPSBuZXcgVVJJKGJhc2UpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlc29sdmVkLl9wYXJ0cy5wcm90b2NvbCkgewogICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXNvbHZlZC5fcGFydHMucHJvdG9jb2wgPSBiYXNlLl9wYXJ0cy5wcm90b2NvbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy5ob3N0bmFtZSkgewogICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGkgPSAwOyBwMiA9IHByb3BlcnRpZXNbaV07IGkrKykgewogICAgICAgICAgICByZXNvbHZlZC5fcGFydHNbcDJdID0gYmFzZS5fcGFydHNbcDJdOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFyZXNvbHZlZC5fcGFydHMucGF0aCkgewogICAgICAgICAgICByZXNvbHZlZC5fcGFydHMucGF0aCA9IGJhc2UuX3BhcnRzLnBhdGg7CiAgICAgICAgICAgIGlmICghcmVzb2x2ZWQuX3BhcnRzLnF1ZXJ5KSB7CiAgICAgICAgICAgICAgcmVzb2x2ZWQuX3BhcnRzLnF1ZXJ5ID0gYmFzZS5fcGFydHMucXVlcnk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChyZXNvbHZlZC5fcGFydHMucGF0aC5zdWJzdHJpbmcoLTIpID09PSAiLi4iKSB7CiAgICAgICAgICAgICAgcmVzb2x2ZWQuX3BhcnRzLnBhdGggKz0gIi8iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZXNvbHZlZC5wYXRoKCkuY2hhckF0KDApICE9PSAiLyIpIHsKICAgICAgICAgICAgICBiYXNlZGlyID0gYmFzZS5kaXJlY3RvcnkoKTsKICAgICAgICAgICAgICBiYXNlZGlyID0gYmFzZWRpciA/IGJhc2VkaXIgOiBiYXNlLnBhdGgoKS5pbmRleE9mKCIvIikgPT09IDAgPyAiLyIgOiAiIjsKICAgICAgICAgICAgICByZXNvbHZlZC5fcGFydHMucGF0aCA9IChiYXNlZGlyID8gYmFzZWRpciArICIvIiA6ICIiKSArIHJlc29sdmVkLl9wYXJ0cy5wYXRoOwogICAgICAgICAgICAgIHJlc29sdmVkLm5vcm1hbGl6ZVBhdGgoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmVzb2x2ZWQuYnVpbGQoKTsKICAgICAgICAgIHJldHVybiByZXNvbHZlZDsKICAgICAgICB9OwogICAgICAgIHAucmVsYXRpdmVUbyA9IGZ1bmN0aW9uKGJhc2UpIHsKICAgICAgICAgIHZhciByZWxhdGl2ZSA9IHRoaXMuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgIHZhciByZWxhdGl2ZVBhcnRzLCBiYXNlUGFydHMsIGNvbW1vbiwgcmVsYXRpdmVQYXRoLCBiYXNlUGF0aDsKICAgICAgICAgIGlmIChyZWxhdGl2ZS5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVVJOcyBkbyBub3QgaGF2ZSBhbnkgZ2VuZXJhbGx5IGRlZmluZWQgaGllcmFyY2hpY2FsIGNvbXBvbmVudHMiKTsKICAgICAgICAgIH0KICAgICAgICAgIGJhc2UgPSBuZXcgVVJJKGJhc2UpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgcmVsYXRpdmVQYXJ0cyA9IHJlbGF0aXZlLl9wYXJ0czsKICAgICAgICAgIGJhc2VQYXJ0cyA9IGJhc2UuX3BhcnRzOwogICAgICAgICAgcmVsYXRpdmVQYXRoID0gcmVsYXRpdmUucGF0aCgpOwogICAgICAgICAgYmFzZVBhdGggPSBiYXNlLnBhdGgoKTsKICAgICAgICAgIGlmIChyZWxhdGl2ZVBhdGguY2hhckF0KDApICE9PSAiLyIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVUkkgaXMgYWxyZWFkeSByZWxhdGl2ZSIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJhc2VQYXRoLmNoYXJBdCgwKSAhPT0gIi8iKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGNhbGN1bGF0ZSBhIFVSSSByZWxhdGl2ZSB0byBhbm90aGVyIHJlbGF0aXZlIFVSSSIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlbGF0aXZlUGFydHMucHJvdG9jb2wgPT09IGJhc2VQYXJ0cy5wcm90b2NvbCkgewogICAgICAgICAgICByZWxhdGl2ZVBhcnRzLnByb3RvY29sID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZWxhdGl2ZVBhcnRzLnVzZXJuYW1lICE9PSBiYXNlUGFydHMudXNlcm5hbWUgfHwgcmVsYXRpdmVQYXJ0cy5wYXNzd29yZCAhPT0gYmFzZVBhcnRzLnBhc3N3b3JkKSB7CiAgICAgICAgICAgIHJldHVybiByZWxhdGl2ZS5idWlsZCgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlbGF0aXZlUGFydHMucHJvdG9jb2wgIT09IG51bGwgfHwgcmVsYXRpdmVQYXJ0cy51c2VybmFtZSAhPT0gbnVsbCB8fCByZWxhdGl2ZVBhcnRzLnBhc3N3b3JkICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiByZWxhdGl2ZS5idWlsZCgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlbGF0aXZlUGFydHMuaG9zdG5hbWUgPT09IGJhc2VQYXJ0cy5ob3N0bmFtZSAmJiByZWxhdGl2ZVBhcnRzLnBvcnQgPT09IGJhc2VQYXJ0cy5wb3J0KSB7CiAgICAgICAgICAgIHJlbGF0aXZlUGFydHMuaG9zdG5hbWUgPSBudWxsOwogICAgICAgICAgICByZWxhdGl2ZVBhcnRzLnBvcnQgPSBudWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHJlbGF0aXZlLmJ1aWxkKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmVsYXRpdmVQYXRoID09PSBiYXNlUGF0aCkgewogICAgICAgICAgICByZWxhdGl2ZVBhcnRzLnBhdGggPSAiIjsKICAgICAgICAgICAgcmV0dXJuIHJlbGF0aXZlLmJ1aWxkKCk7CiAgICAgICAgICB9CiAgICAgICAgICBjb21tb24gPSBVUkkuY29tbW9uUGF0aChyZWxhdGl2ZVBhdGgsIGJhc2VQYXRoKTsKICAgICAgICAgIGlmICghY29tbW9uKSB7CiAgICAgICAgICAgIHJldHVybiByZWxhdGl2ZS5idWlsZCgpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHBhcmVudHMgPSBiYXNlUGFydHMucGF0aC5zdWJzdHJpbmcoY29tbW9uLmxlbmd0aCkucmVwbGFjZSgvW15cL10qJC8sICIiKS5yZXBsYWNlKC8uKj9cLy9nLCAiLi4vIik7CiAgICAgICAgICByZWxhdGl2ZVBhcnRzLnBhdGggPSBwYXJlbnRzICsgcmVsYXRpdmVQYXJ0cy5wYXRoLnN1YnN0cmluZyhjb21tb24ubGVuZ3RoKSB8fCAiLi8iOwogICAgICAgICAgcmV0dXJuIHJlbGF0aXZlLmJ1aWxkKCk7CiAgICAgICAgfTsKICAgICAgICBwLmVxdWFscyA9IGZ1bmN0aW9uKHVyaSkgewogICAgICAgICAgdmFyIG9uZSA9IHRoaXMuY2xvbmUoKTsKICAgICAgICAgIHZhciB0d28gPSBuZXcgVVJJKHVyaSk7CiAgICAgICAgICB2YXIgb25lX21hcCA9IHt9OwogICAgICAgICAgdmFyIHR3b19tYXAgPSB7fTsKICAgICAgICAgIHZhciBjaGVja2VkID0ge307CiAgICAgICAgICB2YXIgb25lX3F1ZXJ5LCB0d29fcXVlcnksIGtleTsKICAgICAgICAgIG9uZS5ub3JtYWxpemUoKTsKICAgICAgICAgIHR3by5ub3JtYWxpemUoKTsKICAgICAgICAgIGlmIChvbmUudG9TdHJpbmcoKSA9PT0gdHdvLnRvU3RyaW5nKCkpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBvbmVfcXVlcnkgPSBvbmUucXVlcnkoKTsKICAgICAgICAgIHR3b19xdWVyeSA9IHR3by5xdWVyeSgpOwogICAgICAgICAgb25lLnF1ZXJ5KCIiKTsKICAgICAgICAgIHR3by5xdWVyeSgiIik7CiAgICAgICAgICBpZiAob25lLnRvU3RyaW5nKCkgIT09IHR3by50b1N0cmluZygpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChvbmVfcXVlcnkubGVuZ3RoICE9PSB0d29fcXVlcnkubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIG9uZV9tYXAgPSBVUkkucGFyc2VRdWVyeShvbmVfcXVlcnksIHRoaXMuX3BhcnRzLmVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgdHdvX21hcCA9IFVSSS5wYXJzZVF1ZXJ5KHR3b19xdWVyeSwgdGhpcy5fcGFydHMuZXNjYXBlUXVlcnlTcGFjZSk7CiAgICAgICAgICBmb3IgKGtleSBpbiBvbmVfbWFwKSB7CiAgICAgICAgICAgIGlmIChoYXNPd24uY2FsbChvbmVfbWFwLCBrZXkpKSB7CiAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KG9uZV9tYXBba2V5XSkpIHsKICAgICAgICAgICAgICAgIGlmIChvbmVfbWFwW2tleV0gIT09IHR3b19tYXBba2V5XSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghYXJyYXlzRXF1YWwob25lX21hcFtrZXldLCB0d29fbWFwW2tleV0pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoZWNrZWRba2V5XSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZvciAoa2V5IGluIHR3b19tYXApIHsKICAgICAgICAgICAgaWYgKGhhc093bi5jYWxsKHR3b19tYXAsIGtleSkpIHsKICAgICAgICAgICAgICBpZiAoIWNoZWNrZWRba2V5XSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfTsKICAgICAgICBwLnByZXZlbnRJbnZhbGlkSG9zdG5hbWUgPSBmdW5jdGlvbih2MykgewogICAgICAgICAgdGhpcy5fcGFydHMucHJldmVudEludmFsaWRIb3N0bmFtZSA9ICEhdjM7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAuZHVwbGljYXRlUXVlcnlQYXJhbWV0ZXJzID0gZnVuY3Rpb24odjMpIHsKICAgICAgICAgIHRoaXMuX3BhcnRzLmR1cGxpY2F0ZVF1ZXJ5UGFyYW1ldGVycyA9ICEhdjM7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAuZXNjYXBlUXVlcnlTcGFjZSA9IGZ1bmN0aW9uKHYzKSB7CiAgICAgICAgICB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlID0gISF2MzsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIFVSSTsKICAgICAgfSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9hcHBlbmRGb3J3YXJkU2xhc2guanMKICBmdW5jdGlvbiBhcHBlbmRGb3J3YXJkU2xhc2godXJsKSB7CiAgICBpZiAodXJsLmxlbmd0aCA9PT0gMCB8fCB1cmxbdXJsLmxlbmd0aCAtIDFdICE9PSAiLyIpIHsKICAgICAgdXJsID0gYCR7dXJsfS9gOwogICAgfQogICAgcmV0dXJuIHVybDsKICB9CiAgdmFyIGFwcGVuZEZvcndhcmRTbGFzaF9kZWZhdWx0OwogIHZhciBpbml0X2FwcGVuZEZvcndhcmRTbGFzaCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvYXBwZW5kRm9yd2FyZFNsYXNoLmpzIigpIHsKICAgICAgYXBwZW5kRm9yd2FyZFNsYXNoX2RlZmF1bHQgPSBhcHBlbmRGb3J3YXJkU2xhc2g7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9jbG9uZS5qcwogIGZ1bmN0aW9uIGNsb25lKG9iamVjdCwgZGVlcCkgewogICAgaWYgKG9iamVjdCA9PT0gbnVsbCB8fCB0eXBlb2Ygb2JqZWN0ICE9PSAib2JqZWN0IikgewogICAgICByZXR1cm4gb2JqZWN0OwogICAgfQogICAgZGVlcCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGRlZXAsIGZhbHNlKTsKICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBvYmplY3QuY29uc3RydWN0b3IoKTsKICAgIGZvciAoY29uc3QgcHJvcGVydHlOYW1lIGluIG9iamVjdCkgewogICAgICBpZiAob2JqZWN0Lmhhc093blByb3BlcnR5KHByb3BlcnR5TmFtZSkpIHsKICAgICAgICBsZXQgdmFsdWUgPSBvYmplY3RbcHJvcGVydHlOYW1lXTsKICAgICAgICBpZiAoZGVlcCkgewogICAgICAgICAgdmFsdWUgPSBjbG9uZSh2YWx1ZSwgZGVlcCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFtwcm9wZXJ0eU5hbWVdID0gdmFsdWU7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHZhciBjbG9uZV9kZWZhdWx0OwogIHZhciBpbml0X2Nsb25lID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9jbG9uZS5qcyIoKSB7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGNsb25lX2RlZmF1bHQgPSBjbG9uZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2NvbWJpbmUuanMKICBmdW5jdGlvbiBjb21iaW5lKG9iamVjdDEsIG9iamVjdDIsIGRlZXApIHsKICAgIGRlZXAgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChkZWVwLCBmYWxzZSk7CiAgICBjb25zdCByZXN1bHQgPSB7fTsKICAgIGNvbnN0IG9iamVjdDFEZWZpbmVkID0gZGVmaW5lZF9kZWZhdWx0KG9iamVjdDEpOwogICAgY29uc3Qgb2JqZWN0MkRlZmluZWQgPSBkZWZpbmVkX2RlZmF1bHQob2JqZWN0Mik7CiAgICBsZXQgcHJvcGVydHk7CiAgICBsZXQgb2JqZWN0MVZhbHVlOwogICAgbGV0IG9iamVjdDJWYWx1ZTsKICAgIGlmIChvYmplY3QxRGVmaW5lZCkgewogICAgICBmb3IgKHByb3BlcnR5IGluIG9iamVjdDEpIHsKICAgICAgICBpZiAob2JqZWN0MS5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eSkpIHsKICAgICAgICAgIG9iamVjdDFWYWx1ZSA9IG9iamVjdDFbcHJvcGVydHldOwogICAgICAgICAgaWYgKG9iamVjdDJEZWZpbmVkICYmIGRlZXAgJiYgdHlwZW9mIG9iamVjdDFWYWx1ZSA9PT0gIm9iamVjdCIgJiYgb2JqZWN0Mi5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eSkpIHsKICAgICAgICAgICAgb2JqZWN0MlZhbHVlID0gb2JqZWN0Mltwcm9wZXJ0eV07CiAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0MlZhbHVlID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHJlc3VsdFtwcm9wZXJ0eV0gPSBjb21iaW5lKG9iamVjdDFWYWx1ZSwgb2JqZWN0MlZhbHVlLCBkZWVwKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXN1bHRbcHJvcGVydHldID0gb2JqZWN0MVZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXN1bHRbcHJvcGVydHldID0gb2JqZWN0MVZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKG9iamVjdDJEZWZpbmVkKSB7CiAgICAgIGZvciAocHJvcGVydHkgaW4gb2JqZWN0MikgewogICAgICAgIGlmIChvYmplY3QyLmhhc093blByb3BlcnR5KHByb3BlcnR5KSAmJiAhcmVzdWx0Lmhhc093blByb3BlcnR5KHByb3BlcnR5KSkgewogICAgICAgICAgb2JqZWN0MlZhbHVlID0gb2JqZWN0Mltwcm9wZXJ0eV07CiAgICAgICAgICByZXN1bHRbcHJvcGVydHldID0gb2JqZWN0MlZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdmFyIGNvbWJpbmVfZGVmYXVsdDsKICB2YXIgaW5pdF9jb21iaW5lID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9jb21iaW5lLmpzIigpIHsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGNvbWJpbmVfZGVmYXVsdCA9IGNvbWJpbmU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9kZWZlci5qcwogIGZ1bmN0aW9uIGRlZmVyKCkgewogICAgbGV0IHJlc29sdmU7CiAgICBsZXQgcmVqZWN0OwogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlcywgcmVqKSB7CiAgICAgIHJlc29sdmUgPSByZXM7CiAgICAgIHJlamVjdCA9IHJlajsKICAgIH0pOwogICAgcmV0dXJuIHsKICAgICAgcmVzb2x2ZSwKICAgICAgcmVqZWN0LAogICAgICBwcm9taXNlCiAgICB9OwogIH0KICB2YXIgZGVmZXJfZGVmYXVsdDsKICB2YXIgaW5pdF9kZWZlciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvZGVmZXIuanMiKCkgewogICAgICBkZWZlcl9kZWZhdWx0ID0gZGVmZXI7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9nZXRBYnNvbHV0ZVVyaS5qcwogIGZ1bmN0aW9uIGdldEFic29sdXRlVXJpKHJlbGF0aXZlLCBiYXNlKSB7CiAgICBsZXQgZG9jdW1lbnRPYmplY3Q7CiAgICBpZiAodHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIikgewogICAgICBkb2N1bWVudE9iamVjdCA9IGRvY3VtZW50OwogICAgfQogICAgcmV0dXJuIGdldEFic29sdXRlVXJpLl9pbXBsZW1lbnRhdGlvbihyZWxhdGl2ZSwgYmFzZSwgZG9jdW1lbnRPYmplY3QpOwogIH0KICB2YXIgaW1wb3J0X3VyaWpzLCBnZXRBYnNvbHV0ZVVyaV9kZWZhdWx0OwogIHZhciBpbml0X2dldEFic29sdXRlVXJpID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9nZXRBYnNvbHV0ZVVyaS5qcyIoKSB7CiAgICAgIGltcG9ydF91cmlqcyA9IF9fdG9FU00ocmVxdWlyZV9VUkkoKSwgMSk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGdldEFic29sdXRlVXJpLl9pbXBsZW1lbnRhdGlvbiA9IGZ1bmN0aW9uKHJlbGF0aXZlLCBiYXNlLCBkb2N1bWVudE9iamVjdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlbGF0aXZlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJlbGF0aXZlIHVyaSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYmFzZSkpIHsKICAgICAgICAgIGlmICh0eXBlb2YgZG9jdW1lbnRPYmplY3QgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIHJldHVybiByZWxhdGl2ZTsKICAgICAgICAgIH0KICAgICAgICAgIGJhc2UgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChkb2N1bWVudE9iamVjdC5iYXNlVVJJLCBkb2N1bWVudE9iamVjdC5sb2NhdGlvbi5ocmVmKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmVsYXRpdmVVcmkgPSBuZXcgaW1wb3J0X3VyaWpzLmRlZmF1bHQocmVsYXRpdmUpOwogICAgICAgIGlmIChyZWxhdGl2ZVVyaS5zY2hlbWUoKSAhPT0gIiIpIHsKICAgICAgICAgIHJldHVybiByZWxhdGl2ZVVyaS50b1N0cmluZygpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVsYXRpdmVVcmkuYWJzb2x1dGVUbyhiYXNlKS50b1N0cmluZygpOwogICAgICB9OwogICAgICBnZXRBYnNvbHV0ZVVyaV9kZWZhdWx0ID0gZ2V0QWJzb2x1dGVVcmk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9nZXRCYXNlVXJpLmpzCiAgZnVuY3Rpb24gZ2V0QmFzZVVyaSh1cmksIGluY2x1ZGVRdWVyeSkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodXJpKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidXJpIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgbGV0IGJhc2VQYXRoID0gIiI7CiAgICBjb25zdCBpID0gdXJpLmxhc3RJbmRleE9mKCIvIik7CiAgICBpZiAoaSAhPT0gLTEpIHsKICAgICAgYmFzZVBhdGggPSB1cmkuc3Vic3RyaW5nKDAsIGkgKyAxKTsKICAgIH0KICAgIGlmICghaW5jbHVkZVF1ZXJ5KSB7CiAgICAgIHJldHVybiBiYXNlUGF0aDsKICAgIH0KICAgIHVyaSA9IG5ldyBpbXBvcnRfdXJpanMyLmRlZmF1bHQodXJpKTsKICAgIGlmICh1cmkucXVlcnkoKS5sZW5ndGggIT09IDApIHsKICAgICAgYmFzZVBhdGggKz0gYD8ke3VyaS5xdWVyeSgpfWA7CiAgICB9CiAgICBpZiAodXJpLmZyYWdtZW50KCkubGVuZ3RoICE9PSAwKSB7CiAgICAgIGJhc2VQYXRoICs9IGAjJHt1cmkuZnJhZ21lbnQoKX1gOwogICAgfQogICAgcmV0dXJuIGJhc2VQYXRoOwogIH0KICB2YXIgaW1wb3J0X3VyaWpzMiwgZ2V0QmFzZVVyaV9kZWZhdWx0OwogIHZhciBpbml0X2dldEJhc2VVcmkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2dldEJhc2VVcmkuanMiKCkgewogICAgICBpbXBvcnRfdXJpanMyID0gX190b0VTTShyZXF1aXJlX1VSSSgpLCAxKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgZ2V0QmFzZVVyaV9kZWZhdWx0ID0gZ2V0QmFzZVVyaTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2dldEV4dGVuc2lvbkZyb21VcmkuanMKICBmdW5jdGlvbiBnZXRFeHRlbnNpb25Gcm9tVXJpKHVyaSkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodXJpKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidXJpIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgY29uc3QgdXJpT2JqZWN0ID0gbmV3IGltcG9ydF91cmlqczMuZGVmYXVsdCh1cmkpOwogICAgdXJpT2JqZWN0Lm5vcm1hbGl6ZSgpOwogICAgbGV0IHBhdGggPSB1cmlPYmplY3QucGF0aCgpOwogICAgbGV0IGluZGV4ID0gcGF0aC5sYXN0SW5kZXhPZigiLyIpOwogICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICBwYXRoID0gcGF0aC5zdWJzdHIoaW5kZXggKyAxKTsKICAgIH0KICAgIGluZGV4ID0gcGF0aC5sYXN0SW5kZXhPZigiLiIpOwogICAgaWYgKGluZGV4ID09PSAtMSkgewogICAgICBwYXRoID0gIiI7CiAgICB9IGVsc2UgewogICAgICBwYXRoID0gcGF0aC5zdWJzdHIoaW5kZXggKyAxKTsKICAgIH0KICAgIHJldHVybiBwYXRoOwogIH0KICB2YXIgaW1wb3J0X3VyaWpzMywgZ2V0RXh0ZW5zaW9uRnJvbVVyaV9kZWZhdWx0OwogIHZhciBpbml0X2dldEV4dGVuc2lvbkZyb21VcmkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2dldEV4dGVuc2lvbkZyb21VcmkuanMiKCkgewogICAgICBpbXBvcnRfdXJpanMzID0gX190b0VTTShyZXF1aXJlX1VSSSgpLCAxKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgZ2V0RXh0ZW5zaW9uRnJvbVVyaV9kZWZhdWx0ID0gZ2V0RXh0ZW5zaW9uRnJvbVVyaTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2dldEltYWdlUGl4ZWxzLmpzCiAgZnVuY3Rpb24gZ2V0SW1hZ2VQaXhlbHMoaW1hZ2UsIHdpZHRoLCBoZWlnaHQpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHdpZHRoKSkgewogICAgICB3aWR0aCA9IGltYWdlLndpZHRoOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaGVpZ2h0KSkgewogICAgICBoZWlnaHQgPSBpbWFnZS5oZWlnaHQ7CiAgICB9CiAgICBsZXQgY29udGV4dDJEc0J5SGVpZ2h0ID0gY29udGV4dDJEc0J5V2lkdGhBbmRIZWlnaHRbd2lkdGhdOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY29udGV4dDJEc0J5SGVpZ2h0KSkgewogICAgICBjb250ZXh0MkRzQnlIZWlnaHQgPSB7fTsKICAgICAgY29udGV4dDJEc0J5V2lkdGhBbmRIZWlnaHRbd2lkdGhdID0gY29udGV4dDJEc0J5SGVpZ2h0OwogICAgfQogICAgbGV0IGNvbnRleHQyZCA9IGNvbnRleHQyRHNCeUhlaWdodFtoZWlnaHRdOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY29udGV4dDJkKSkgewogICAgICBjb25zdCBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsKICAgICAgY2FudmFzLndpZHRoID0gd2lkdGg7CiAgICAgIGNhbnZhcy5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgIGNvbnRleHQyZCA9IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIsIHsgd2lsbFJlYWRGcmVxdWVudGx5OiB0cnVlIH0pOwogICAgICBjb250ZXh0MmQuZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gImNvcHkiOwogICAgICBjb250ZXh0MkRzQnlIZWlnaHRbaGVpZ2h0XSA9IGNvbnRleHQyZDsKICAgIH0KICAgIGNvbnRleHQyZC5kcmF3SW1hZ2UoaW1hZ2UsIDAsIDAsIHdpZHRoLCBoZWlnaHQpOwogICAgcmV0dXJuIGNvbnRleHQyZC5nZXRJbWFnZURhdGEoMCwgMCwgd2lkdGgsIGhlaWdodCkuZGF0YTsKICB9CiAgdmFyIGNvbnRleHQyRHNCeVdpZHRoQW5kSGVpZ2h0LCBnZXRJbWFnZVBpeGVsc19kZWZhdWx0OwogIHZhciBpbml0X2dldEltYWdlUGl4ZWxzID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9nZXRJbWFnZVBpeGVscy5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBjb250ZXh0MkRzQnlXaWR0aEFuZEhlaWdodCA9IHt9OwogICAgICBnZXRJbWFnZVBpeGVsc19kZWZhdWx0ID0gZ2V0SW1hZ2VQaXhlbHM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9pc0Jsb2JVcmkuanMKICBmdW5jdGlvbiBpc0Jsb2JVcmkodXJpKSB7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5zdHJpbmcoInVyaSIsIHVyaSk7CiAgICByZXR1cm4gYmxvYlVyaVJlZ2V4LnRlc3QodXJpKTsKICB9CiAgdmFyIGJsb2JVcmlSZWdleCwgaXNCbG9iVXJpX2RlZmF1bHQ7CiAgdmFyIGluaXRfaXNCbG9iVXJpID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9pc0Jsb2JVcmkuanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGJsb2JVcmlSZWdleCA9IC9eYmxvYjovaTsKICAgICAgaXNCbG9iVXJpX2RlZmF1bHQgPSBpc0Jsb2JVcmk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9pc0Nyb3NzT3JpZ2luVXJsLmpzCiAgZnVuY3Rpb24gaXNDcm9zc09yaWdpblVybCh1cmwpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGEpKSB7CiAgICAgIGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICB9CiAgICBhLmhyZWYgPSB3aW5kb3cubG9jYXRpb24uaHJlZjsKICAgIGNvbnN0IGhvc3QgPSBhLmhvc3Q7CiAgICBjb25zdCBwcm90b2NvbCA9IGEucHJvdG9jb2w7CiAgICBhLmhyZWYgPSB1cmw7CiAgICBhLmhyZWYgPSBhLmhyZWY7CiAgICByZXR1cm4gcHJvdG9jb2wgIT09IGEucHJvdG9jb2wgfHwgaG9zdCAhPT0gYS5ob3N0OwogIH0KICB2YXIgYSwgaXNDcm9zc09yaWdpblVybF9kZWZhdWx0OwogIHZhciBpbml0X2lzQ3Jvc3NPcmlnaW5VcmwgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2lzQ3Jvc3NPcmlnaW5VcmwuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaXNDcm9zc09yaWdpblVybF9kZWZhdWx0ID0gaXNDcm9zc09yaWdpblVybDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2lzRGF0YVVyaS5qcwogIGZ1bmN0aW9uIGlzRGF0YVVyaSh1cmkpIHsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLnN0cmluZygidXJpIiwgdXJpKTsKICAgIHJldHVybiBkYXRhVXJpUmVnZXgudGVzdCh1cmkpOwogIH0KICB2YXIgZGF0YVVyaVJlZ2V4LCBpc0RhdGFVcmlfZGVmYXVsdDsKICB2YXIgaW5pdF9pc0RhdGFVcmkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2lzRGF0YVVyaS5qcyIoKSB7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgZGF0YVVyaVJlZ2V4ID0gL15kYXRhOi9pOwogICAgICBpc0RhdGFVcmlfZGVmYXVsdCA9IGlzRGF0YVVyaTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2xvYWRBbmRFeGVjdXRlU2NyaXB0LmpzCiAgZnVuY3Rpb24gbG9hZEFuZEV4ZWN1dGVTY3JpcHQodXJsKSB7CiAgICBjb25zdCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgIHNjcmlwdC5hc3luYyA9IHRydWU7CiAgICBzY3JpcHQuc3JjID0gdXJsOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgaWYgKHdpbmRvdy5jcm9zc09yaWdpbklzb2xhdGVkKSB7CiAgICAgICAgc2NyaXB0LnNldEF0dHJpYnV0ZSgiY3Jvc3NvcmlnaW4iLCAiYW5vbnltb3VzIik7CiAgICAgIH0KICAgICAgY29uc3QgaGVhZCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJoZWFkIilbMF07CiAgICAgIHNjcmlwdC5vbmxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgICBzY3JpcHQub25sb2FkID0gdm9pZCAwOwogICAgICAgIGhlYWQucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKICAgICAgICByZXNvbHZlKCk7CiAgICAgIH07CiAgICAgIHNjcmlwdC5vbmVycm9yID0gZnVuY3Rpb24oZSkgewogICAgICAgIHJlamVjdChlKTsKICAgICAgfTsKICAgICAgaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQpOwogICAgfSk7CiAgfQogIHZhciBsb2FkQW5kRXhlY3V0ZVNjcmlwdF9kZWZhdWx0OwogIHZhciBpbml0X2xvYWRBbmRFeGVjdXRlU2NyaXB0ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9sb2FkQW5kRXhlY3V0ZVNjcmlwdC5qcyIoKSB7CiAgICAgIGxvYWRBbmRFeGVjdXRlU2NyaXB0X2RlZmF1bHQgPSBsb2FkQW5kRXhlY3V0ZVNjcmlwdDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL29iamVjdFRvUXVlcnkuanMKICBmdW5jdGlvbiBvYmplY3RUb1F1ZXJ5KG9iaikgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob2JqKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib2JqIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgbGV0IHJlc3VsdCA9ICIiOwogICAgZm9yIChjb25zdCBwcm9wTmFtZSBpbiBvYmopIHsKICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShwcm9wTmFtZSkpIHsKICAgICAgICBjb25zdCB2YWx1ZSA9IG9ialtwcm9wTmFtZV07CiAgICAgICAgY29uc3QgcGFydCA9IGAke2VuY29kZVVSSUNvbXBvbmVudChwcm9wTmFtZSl9PWA7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gdmFsdWUubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgICAgICAgICAgcmVzdWx0ICs9IGAke3BhcnQgKyBlbmNvZGVVUklDb21wb25lbnQodmFsdWVbaV0pfSZgOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQgKz0gYCR7cGFydCArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSl9JmA7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXN1bHQgPSByZXN1bHQuc2xpY2UoMCwgLTEpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdmFyIG9iamVjdFRvUXVlcnlfZGVmYXVsdDsKICB2YXIgaW5pdF9vYmplY3RUb1F1ZXJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9vYmplY3RUb1F1ZXJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgb2JqZWN0VG9RdWVyeV9kZWZhdWx0ID0gb2JqZWN0VG9RdWVyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL3F1ZXJ5VG9PYmplY3QuanMKICBmdW5jdGlvbiBxdWVyeVRvT2JqZWN0KHF1ZXJ5U3RyaW5nKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChxdWVyeVN0cmluZykpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInF1ZXJ5U3RyaW5nIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgY29uc3QgcmVzdWx0ID0ge307CiAgICBpZiAocXVlcnlTdHJpbmcgPT09ICIiKSB7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBjb25zdCBwYXJ0cyA9IHF1ZXJ5U3RyaW5nLnJlcGxhY2UoL1wrL2csICIlMjAiKS5zcGxpdCgvWyY7XS8pOwogICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IHBhcnRzLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICAgIGNvbnN0IHN1YnBhcnRzID0gcGFydHNbaV0uc3BsaXQoIj0iKTsKICAgICAgY29uc3QgbmFtZSA9IGRlY29kZVVSSUNvbXBvbmVudChzdWJwYXJ0c1swXSk7CiAgICAgIGxldCB2YWx1ZSA9IHN1YnBhcnRzWzFdOwogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHZhbHVlKSkgewogICAgICAgIHZhbHVlID0gZGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YWx1ZSA9ICIiOwogICAgICB9CiAgICAgIGNvbnN0IHJlc3VsdFZhbHVlID0gcmVzdWx0W25hbWVdOwogICAgICBpZiAodHlwZW9mIHJlc3VsdFZhbHVlID09PSAic3RyaW5nIikgewogICAgICAgIHJlc3VsdFtuYW1lXSA9IFtyZXN1bHRWYWx1ZSwgdmFsdWVdOwogICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0VmFsdWUpKSB7CiAgICAgICAgcmVzdWx0VmFsdWUucHVzaCh2YWx1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0W25hbWVdID0gdmFsdWU7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHZhciBxdWVyeVRvT2JqZWN0X2RlZmF1bHQ7CiAgdmFyIGluaXRfcXVlcnlUb09iamVjdCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvcXVlcnlUb09iamVjdC5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIHF1ZXJ5VG9PYmplY3RfZGVmYXVsdCA9IHF1ZXJ5VG9PYmplY3Q7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZXF1ZXN0U3RhdGUuanMKICB2YXIgUmVxdWVzdFN0YXRlLCBSZXF1ZXN0U3RhdGVfZGVmYXVsdDsKICB2YXIgaW5pdF9SZXF1ZXN0U3RhdGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JlcXVlc3RTdGF0ZS5qcyIoKSB7CiAgICAgIFJlcXVlc3RTdGF0ZSA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBJbml0aWFsIHVuaXNzdWVkIHN0YXRlLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBVTklTU1VFRDogMCwKICAgICAgICAvKioKICAgICAgICAgKiBJc3N1ZWQgYnV0IG5vdCB5ZXQgYWN0aXZlLiBXaWxsIGJlY29tZSBhY3RpdmUgd2hlbiBvcGVuIHNsb3RzIGFyZSBhdmFpbGFibGUuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIElTU1VFRDogMSwKICAgICAgICAvKioKICAgICAgICAgKiBBY3R1YWwgaHR0cCByZXF1ZXN0IGhhcyBiZWVuIHNlbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIEFDVElWRTogMiwKICAgICAgICAvKioKICAgICAgICAgKiBSZXF1ZXN0IGNvbXBsZXRlZCBzdWNjZXNzZnVsbHkuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJFQ0VJVkVEOiAzLAogICAgICAgIC8qKgogICAgICAgICAqIFJlcXVlc3Qgd2FzIGNhbmNlbGxlZCwgZWl0aGVyIGV4cGxpY2l0bHkgb3IgYXV0b21hdGljYWxseSBiZWNhdXNlIG9mIGxvdyBwcmlvcml0eS4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgQ0FOQ0VMTEVEOiA0LAogICAgICAgIC8qKgogICAgICAgICAqIFJlcXVlc3QgZmFpbGVkLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBGQUlMRUQ6IDUKICAgICAgfTsKICAgICAgUmVxdWVzdFN0YXRlX2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKFJlcXVlc3RTdGF0ZSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZXF1ZXN0VHlwZS5qcwogIHZhciBSZXF1ZXN0VHlwZSwgUmVxdWVzdFR5cGVfZGVmYXVsdDsKICB2YXIgaW5pdF9SZXF1ZXN0VHlwZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVxdWVzdFR5cGUuanMiKCkgewogICAgICBSZXF1ZXN0VHlwZSA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBUZXJyYWluIHJlcXVlc3QuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFRFUlJBSU46IDAsCiAgICAgICAgLyoqCiAgICAgICAgICogSW1hZ2VyeSByZXF1ZXN0LgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBJTUFHRVJZOiAxLAogICAgICAgIC8qKgogICAgICAgICAqIDNEIFRpbGVzIHJlcXVlc3QuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFRJTEVTM0Q6IDIsCiAgICAgICAgLyoqCiAgICAgICAgICogT3RoZXIgcmVxdWVzdC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgT1RIRVI6IDMKICAgICAgfTsKICAgICAgUmVxdWVzdFR5cGVfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoUmVxdWVzdFR5cGUpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVxdWVzdC5qcwogIGZ1bmN0aW9uIFJlcXVlc3Qob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCB0aHJvdHRsZUJ5U2VydmVyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy50aHJvdHRsZUJ5U2VydmVyLCBmYWxzZSk7CiAgICBjb25zdCB0aHJvdHRsZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMudGhyb3R0bGUsIGZhbHNlKTsKICAgIHRoaXMudXJsID0gb3B0aW9ucy51cmw7CiAgICB0aGlzLnJlcXVlc3RGdW5jdGlvbiA9IG9wdGlvbnMucmVxdWVzdEZ1bmN0aW9uOwogICAgdGhpcy5jYW5jZWxGdW5jdGlvbiA9IG9wdGlvbnMuY2FuY2VsRnVuY3Rpb247CiAgICB0aGlzLnByaW9yaXR5RnVuY3Rpb24gPSBvcHRpb25zLnByaW9yaXR5RnVuY3Rpb247CiAgICB0aGlzLnByaW9yaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5wcmlvcml0eSwgMCk7CiAgICB0aGlzLnRocm90dGxlID0gdGhyb3R0bGU7CiAgICB0aGlzLnRocm90dGxlQnlTZXJ2ZXIgPSB0aHJvdHRsZUJ5U2VydmVyOwogICAgdGhpcy50eXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy50eXBlLCBSZXF1ZXN0VHlwZV9kZWZhdWx0Lk9USEVSKTsKICAgIHRoaXMuc2VydmVyS2V5ID0gb3B0aW9ucy5zZXJ2ZXJLZXk7CiAgICB0aGlzLnN0YXRlID0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuVU5JU1NVRUQ7CiAgICB0aGlzLmRlZmVycmVkID0gdm9pZCAwOwogICAgdGhpcy5jYW5jZWxsZWQgPSBmYWxzZTsKICB9CiAgdmFyIFJlcXVlc3RfZGVmYXVsdDsKICB2YXIgaW5pdF9SZXF1ZXN0ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZXF1ZXN0LmpzIigpIHsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfUmVxdWVzdFN0YXRlKCk7CiAgICAgIGluaXRfUmVxdWVzdFR5cGUoKTsKICAgICAgUmVxdWVzdC5wcm90b3R5cGUuY2FuY2VsID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5jYW5jZWxsZWQgPSB0cnVlOwogICAgICB9OwogICAgICBSZXF1ZXN0LnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUmVxdWVzdCh0aGlzKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnVybCA9IHRoaXMudXJsOwogICAgICAgIHJlc3VsdC5yZXF1ZXN0RnVuY3Rpb24gPSB0aGlzLnJlcXVlc3RGdW5jdGlvbjsKICAgICAgICByZXN1bHQuY2FuY2VsRnVuY3Rpb24gPSB0aGlzLmNhbmNlbEZ1bmN0aW9uOwogICAgICAgIHJlc3VsdC5wcmlvcml0eUZ1bmN0aW9uID0gdGhpcy5wcmlvcml0eUZ1bmN0aW9uOwogICAgICAgIHJlc3VsdC5wcmlvcml0eSA9IHRoaXMucHJpb3JpdHk7CiAgICAgICAgcmVzdWx0LnRocm90dGxlID0gdGhpcy50aHJvdHRsZTsKICAgICAgICByZXN1bHQudGhyb3R0bGVCeVNlcnZlciA9IHRoaXMudGhyb3R0bGVCeVNlcnZlcjsKICAgICAgICByZXN1bHQudHlwZSA9IHRoaXMudHlwZTsKICAgICAgICByZXN1bHQuc2VydmVyS2V5ID0gdGhpcy5zZXJ2ZXJLZXk7CiAgICAgICAgcmVzdWx0LnN0YXRlID0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuVU5JU1NVRUQ7CiAgICAgICAgcmVzdWx0LmRlZmVycmVkID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5jYW5jZWxsZWQgPSBmYWxzZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZXF1ZXN0X2RlZmF1bHQgPSBSZXF1ZXN0OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvcGFyc2VSZXNwb25zZUhlYWRlcnMuanMKICBmdW5jdGlvbiBwYXJzZVJlc3BvbnNlSGVhZGVycyhoZWFkZXJTdHJpbmcpIHsKICAgIGNvbnN0IGhlYWRlcnMgPSB7fTsKICAgIGlmICghaGVhZGVyU3RyaW5nKSB7CiAgICAgIHJldHVybiBoZWFkZXJzOwogICAgfQogICAgY29uc3QgaGVhZGVyUGFpcnMgPSBoZWFkZXJTdHJpbmcuc3BsaXQoIlxyXG4iKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGVhZGVyUGFpcnMubGVuZ3RoOyArK2kpIHsKICAgICAgY29uc3QgaGVhZGVyUGFpciA9IGhlYWRlclBhaXJzW2ldOwogICAgICBjb25zdCBpbmRleCA9IGhlYWRlclBhaXIuaW5kZXhPZigiOiAiKTsKICAgICAgaWYgKGluZGV4ID4gMCkgewogICAgICAgIGNvbnN0IGtleSA9IGhlYWRlclBhaXIuc3Vic3RyaW5nKDAsIGluZGV4KTsKICAgICAgICBjb25zdCB2YWwgPSBoZWFkZXJQYWlyLnN1YnN0cmluZyhpbmRleCArIDIpOwogICAgICAgIGhlYWRlcnNba2V5XSA9IHZhbDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGhlYWRlcnM7CiAgfQogIHZhciBwYXJzZVJlc3BvbnNlSGVhZGVyc19kZWZhdWx0OwogIHZhciBpbml0X3BhcnNlUmVzcG9uc2VIZWFkZXJzID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9wYXJzZVJlc3BvbnNlSGVhZGVycy5qcyIoKSB7CiAgICAgIHBhcnNlUmVzcG9uc2VIZWFkZXJzX2RlZmF1bHQgPSBwYXJzZVJlc3BvbnNlSGVhZGVyczsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JlcXVlc3RFcnJvckV2ZW50LmpzCiAgZnVuY3Rpb24gUmVxdWVzdEVycm9yRXZlbnQoc3RhdHVzQ29kZSwgcmVzcG9uc2UsIHJlc3BvbnNlSGVhZGVycykgewogICAgdGhpcy5zdGF0dXNDb2RlID0gc3RhdHVzQ29kZTsKICAgIHRoaXMucmVzcG9uc2UgPSByZXNwb25zZTsKICAgIHRoaXMucmVzcG9uc2VIZWFkZXJzID0gcmVzcG9uc2VIZWFkZXJzOwogICAgaWYgKHR5cGVvZiB0aGlzLnJlc3BvbnNlSGVhZGVycyA9PT0gInN0cmluZyIpIHsKICAgICAgdGhpcy5yZXNwb25zZUhlYWRlcnMgPSBwYXJzZVJlc3BvbnNlSGVhZGVyc19kZWZhdWx0KHRoaXMucmVzcG9uc2VIZWFkZXJzKTsKICAgIH0KICB9CiAgdmFyIFJlcXVlc3RFcnJvckV2ZW50X2RlZmF1bHQ7CiAgdmFyIGluaXRfUmVxdWVzdEVycm9yRXZlbnQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JlcXVlc3RFcnJvckV2ZW50LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfcGFyc2VSZXNwb25zZUhlYWRlcnMoKTsKICAgICAgUmVxdWVzdEVycm9yRXZlbnQucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbGV0IHN0ciA9ICJSZXF1ZXN0IGhhcyBmYWlsZWQuIjsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHRoaXMuc3RhdHVzQ29kZSkpIHsKICAgICAgICAgIHN0ciArPSBgIFN0YXR1cyBDb2RlOiAke3RoaXMuc3RhdHVzQ29kZX1gOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyOwogICAgICB9OwogICAgICBSZXF1ZXN0RXJyb3JFdmVudF9kZWZhdWx0ID0gUmVxdWVzdEVycm9yRXZlbnQ7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FdmVudC5qcwogIGZ1bmN0aW9uIEV2ZW50KCkgewogICAgdGhpcy5fbGlzdGVuZXJzID0gW107CiAgICB0aGlzLl9zY29wZXMgPSBbXTsKICAgIHRoaXMuX3RvUmVtb3ZlID0gW107CiAgICB0aGlzLl9pbnNpZGVSYWlzZUV2ZW50ID0gZmFsc2U7CiAgfQogIGZ1bmN0aW9uIGNvbXBhcmVOdW1iZXIoYTMsIGIpIHsKICAgIHJldHVybiBiIC0gYTM7CiAgfQogIHZhciBFdmVudF9kZWZhdWx0OwogIHZhciBpbml0X0V2ZW50ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FdmVudC5qcyIoKSB7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEV2ZW50LnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBudW1iZXIgb2YgbGlzdGVuZXJzIGN1cnJlbnRseSBzdWJzY3JpYmVkIHRvIHRoZSBldmVudC4KICAgICAgICAgKiBAbWVtYmVyb2YgRXZlbnQucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBudW1iZXJPZkxpc3RlbmVyczogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2xpc3RlbmVycy5sZW5ndGggLSB0aGlzLl90b1JlbW92ZS5sZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgRXZlbnQucHJvdG90eXBlLmFkZEV2ZW50TGlzdGVuZXIgPSBmdW5jdGlvbihsaXN0ZW5lciwgc2NvcGUpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5mdW5jKCJsaXN0ZW5lciIsIGxpc3RlbmVyKTsKICAgICAgICB0aGlzLl9saXN0ZW5lcnMucHVzaChsaXN0ZW5lcik7CiAgICAgICAgdGhpcy5fc2NvcGVzLnB1c2goc2NvcGUpOwogICAgICAgIGNvbnN0IGV2ZW50ID0gdGhpczsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICBldmVudC5yZW1vdmVFdmVudExpc3RlbmVyKGxpc3RlbmVyLCBzY29wZSk7CiAgICAgICAgfTsKICAgICAgfTsKICAgICAgRXZlbnQucHJvdG90eXBlLnJlbW92ZUV2ZW50TGlzdGVuZXIgPSBmdW5jdGlvbihsaXN0ZW5lciwgc2NvcGUpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5mdW5jKCJsaXN0ZW5lciIsIGxpc3RlbmVyKTsKICAgICAgICBjb25zdCBsaXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnM7CiAgICAgICAgY29uc3Qgc2NvcGVzID0gdGhpcy5fc2NvcGVzOwogICAgICAgIGxldCBpbmRleCA9IC0xOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGlzdGVuZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAobGlzdGVuZXJzW2ldID09PSBsaXN0ZW5lciAmJiBzY29wZXNbaV0gPT09IHNjb3BlKSB7CiAgICAgICAgICAgIGluZGV4ID0gaTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHsKICAgICAgICAgIGlmICh0aGlzLl9pbnNpZGVSYWlzZUV2ZW50KSB7CiAgICAgICAgICAgIHRoaXMuX3RvUmVtb3ZlLnB1c2goaW5kZXgpOwogICAgICAgICAgICBsaXN0ZW5lcnNbaW5kZXhdID0gdm9pZCAwOwogICAgICAgICAgICBzY29wZXNbaW5kZXhdID0gdm9pZCAwOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlzdGVuZXJzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICAgIHNjb3Blcy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfTsKICAgICAgRXZlbnQucHJvdG90eXBlLnJhaXNlRXZlbnQgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLl9pbnNpZGVSYWlzZUV2ZW50ID0gdHJ1ZTsKICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCBsaXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnM7CiAgICAgICAgY29uc3Qgc2NvcGVzID0gdGhpcy5fc2NvcGVzOwogICAgICAgIGxldCBsZW5ndGggPSBsaXN0ZW5lcnMubGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgbGlzdGVuZXIgPSBsaXN0ZW5lcnNbaV07CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGxpc3RlbmVyKSkgewogICAgICAgICAgICBsaXN0ZW5lcnNbaV0uYXBwbHkoc2NvcGVzW2ldLCBhcmd1bWVudHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCB0b1JlbW92ZSA9IHRoaXMuX3RvUmVtb3ZlOwogICAgICAgIGxlbmd0aCA9IHRvUmVtb3ZlLmxlbmd0aDsKICAgICAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICAgICAgdG9SZW1vdmUuc29ydChjb21wYXJlTnVtYmVyKTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCBpbmRleCA9IHRvUmVtb3ZlW2ldOwogICAgICAgICAgICBsaXN0ZW5lcnMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgICAgc2NvcGVzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICB9CiAgICAgICAgICB0b1JlbW92ZS5sZW5ndGggPSAwOwogICAgICAgIH0KICAgICAgICB0aGlzLl9pbnNpZGVSYWlzZUV2ZW50ID0gZmFsc2U7CiAgICAgIH07CiAgICAgIEV2ZW50X2RlZmF1bHQgPSBFdmVudDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0hlYXAuanMKICBmdW5jdGlvbiBIZWFwKG9wdGlvbnMpIHsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib3B0aW9ucyIsIG9wdGlvbnMpOwogICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvcHRpb25zLmNvbXBhcmF0b3IiLCBvcHRpb25zLmNvbXBhcmF0b3IpOwogICAgdGhpcy5fY29tcGFyYXRvciA9IG9wdGlvbnMuY29tcGFyYXRvcjsKICAgIHRoaXMuX2FycmF5ID0gW107CiAgICB0aGlzLl9sZW5ndGggPSAwOwogICAgdGhpcy5fbWF4aW11bUxlbmd0aCA9IHZvaWQgMDsKICB9CiAgZnVuY3Rpb24gc3dhcChhcnJheSwgYTMsIGIpIHsKICAgIGNvbnN0IHRlbXAgPSBhcnJheVthM107CiAgICBhcnJheVthM10gPSBhcnJheVtiXTsKICAgIGFycmF5W2JdID0gdGVtcDsKICB9CiAgdmFyIEhlYXBfZGVmYXVsdDsKICB2YXIgaW5pdF9IZWFwID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9IZWFwLmpzIigpIHsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoSGVhcC5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBsZW5ndGggb2YgdGhlIGhlYXAuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgSGVhcC5wcm90b3R5cGUKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgbGVuZ3RoOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbGVuZ3RoOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgaW50ZXJuYWwgYXJyYXkuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgSGVhcC5wcm90b3R5cGUKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBpbnRlcm5hbEFycmF5OiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fYXJyYXk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIGFuZCBzZXRzIHRoZSBtYXhpbXVtIGxlbmd0aCBvZiB0aGUgaGVhcC4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBIZWFwLnByb3RvdHlwZQogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKi8KICAgICAgICBtYXhpbXVtTGVuZ3RoOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbWF4aW11bUxlbmd0aDsKICAgICAgICAgIH0sCiAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJtYXhpbXVtTGVuZ3RoIiwgdmFsdWUsIDApOwogICAgICAgICAgICBjb25zdCBvcmlnaW5hbExlbmd0aCA9IHRoaXMuX2xlbmd0aDsKICAgICAgICAgICAgaWYgKHZhbHVlIDwgb3JpZ2luYWxMZW5ndGgpIHsKICAgICAgICAgICAgICBjb25zdCBhcnJheSA9IHRoaXMuX2FycmF5OwogICAgICAgICAgICAgIGZvciAobGV0IGkgPSB2YWx1ZTsgaSA8IG9yaWdpbmFsTGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIGFycmF5W2ldID0gdm9pZCAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLl9sZW5ndGggPSB2YWx1ZTsKICAgICAgICAgICAgICBhcnJheS5sZW5ndGggPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9tYXhpbXVtTGVuZ3RoID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgY29tcGFyYXRvciB0byB1c2UgZm9yIHRoZSBoZWFwLiBJZiBjb21wYXJhdG9yKGEsIGIpIGlzIGxlc3MgdGhhbiAwLCBzb3J0IGEgdG8gYSBsb3dlciBpbmRleCB0aGFuIGIsIG90aGVyd2lzZSBzb3J0IHRvIGEgaGlnaGVyIGluZGV4LgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIEhlYXAucHJvdG90eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7SGVhcC5Db21wYXJhdG9yQ2FsbGJhY2t9CiAgICAgICAgICovCiAgICAgICAgY29tcGFyYXRvcjogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2NvbXBhcmF0b3I7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgSGVhcC5wcm90b3R5cGUucmVzZXJ2ZSA9IGZ1bmN0aW9uKGxlbmd0aCkgewogICAgICAgIGxlbmd0aCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGxlbmd0aCwgdGhpcy5fbGVuZ3RoKTsKICAgICAgICB0aGlzLl9hcnJheS5sZW5ndGggPSBsZW5ndGg7CiAgICAgIH07CiAgICAgIEhlYXAucHJvdG90eXBlLmhlYXBpZnkgPSBmdW5jdGlvbihpbmRleCkgewogICAgICAgIGluZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoaW5kZXgsIDApOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHRoaXMuX2xlbmd0aDsKICAgICAgICBjb25zdCBjb21wYXJhdG9yID0gdGhpcy5fY29tcGFyYXRvcjsKICAgICAgICBjb25zdCBhcnJheSA9IHRoaXMuX2FycmF5OwogICAgICAgIGxldCBjYW5kaWRhdGUgPSAtMTsKICAgICAgICBsZXQgaW5zZXJ0aW5nID0gdHJ1ZTsKICAgICAgICB3aGlsZSAoaW5zZXJ0aW5nKSB7CiAgICAgICAgICBjb25zdCByaWdodCA9IDIgKiAoaW5kZXggKyAxKTsKICAgICAgICAgIGNvbnN0IGxlZnQgPSByaWdodCAtIDE7CiAgICAgICAgICBpZiAobGVmdCA8IGxlbmd0aCAmJiBjb21wYXJhdG9yKGFycmF5W2xlZnRdLCBhcnJheVtpbmRleF0pIDwgMCkgewogICAgICAgICAgICBjYW5kaWRhdGUgPSBsZWZ0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2FuZGlkYXRlID0gaW5kZXg7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmlnaHQgPCBsZW5ndGggJiYgY29tcGFyYXRvcihhcnJheVtyaWdodF0sIGFycmF5W2NhbmRpZGF0ZV0pIDwgMCkgewogICAgICAgICAgICBjYW5kaWRhdGUgPSByaWdodDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjYW5kaWRhdGUgIT09IGluZGV4KSB7CiAgICAgICAgICAgIHN3YXAoYXJyYXksIGNhbmRpZGF0ZSwgaW5kZXgpOwogICAgICAgICAgICBpbmRleCA9IGNhbmRpZGF0ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGluc2VydGluZyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgICAgSGVhcC5wcm90b3R5cGUucmVzb3J0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gdGhpcy5fbGVuZ3RoOwogICAgICAgIGZvciAobGV0IGkgPSBNYXRoLmNlaWwobGVuZ3RoIC8gMik7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgICB0aGlzLmhlYXBpZnkoaSk7CiAgICAgICAgfQogICAgICB9OwogICAgICBIZWFwLnByb3RvdHlwZS5pbnNlcnQgPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJlbGVtZW50IiwgZWxlbWVudCk7CiAgICAgICAgY29uc3QgYXJyYXkgPSB0aGlzLl9hcnJheTsKICAgICAgICBjb25zdCBjb21wYXJhdG9yID0gdGhpcy5fY29tcGFyYXRvcjsKICAgICAgICBjb25zdCBtYXhpbXVtTGVuZ3RoID0gdGhpcy5fbWF4aW11bUxlbmd0aDsKICAgICAgICBsZXQgaW5kZXggPSB0aGlzLl9sZW5ndGgrKzsKICAgICAgICBpZiAoaW5kZXggPCBhcnJheS5sZW5ndGgpIHsKICAgICAgICAgIGFycmF5W2luZGV4XSA9IGVsZW1lbnQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFycmF5LnB1c2goZWxlbWVudCk7CiAgICAgICAgfQogICAgICAgIHdoaWxlIChpbmRleCAhPT0gMCkgewogICAgICAgICAgY29uc3QgcGFyZW50ID0gTWF0aC5mbG9vcigoaW5kZXggLSAxKSAvIDIpOwogICAgICAgICAgaWYgKGNvbXBhcmF0b3IoYXJyYXlbaW5kZXhdLCBhcnJheVtwYXJlbnRdKSA8IDApIHsKICAgICAgICAgICAgc3dhcChhcnJheSwgaW5kZXgsIHBhcmVudCk7CiAgICAgICAgICAgIGluZGV4ID0gcGFyZW50OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCByZW1vdmVkRWxlbWVudDsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1heGltdW1MZW5ndGgpICYmIHRoaXMuX2xlbmd0aCA+IG1heGltdW1MZW5ndGgpIHsKICAgICAgICAgIHJlbW92ZWRFbGVtZW50ID0gYXJyYXlbbWF4aW11bUxlbmd0aF07CiAgICAgICAgICB0aGlzLl9sZW5ndGggPSBtYXhpbXVtTGVuZ3RoOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVtb3ZlZEVsZW1lbnQ7CiAgICAgIH07CiAgICAgIEhlYXAucHJvdG90eXBlLnBvcCA9IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgaW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChpbmRleCwgMCk7CiAgICAgICAgaWYgKHRoaXMuX2xlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuKCJpbmRleCIsIGluZGV4LCB0aGlzLl9sZW5ndGgpOwogICAgICAgIGNvbnN0IGFycmF5ID0gdGhpcy5fYXJyYXk7CiAgICAgICAgY29uc3Qgcm9vdCA9IGFycmF5W2luZGV4XTsKICAgICAgICBzd2FwKGFycmF5LCBpbmRleCwgLS10aGlzLl9sZW5ndGgpOwogICAgICAgIHRoaXMuaGVhcGlmeShpbmRleCk7CiAgICAgICAgYXJyYXlbdGhpcy5fbGVuZ3RoXSA9IHZvaWQgMDsKICAgICAgICByZXR1cm4gcm9vdDsKICAgICAgfTsKICAgICAgSGVhcF9kZWZhdWx0ID0gSGVhcDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JlcXVlc3RTY2hlZHVsZXIuanMKICBmdW5jdGlvbiBzb3J0UmVxdWVzdHMoYTMsIGIpIHsKICAgIHJldHVybiBhMy5wcmlvcml0eSAtIGIucHJpb3JpdHk7CiAgfQogIGZ1bmN0aW9uIFJlcXVlc3RTY2hlZHVsZXIoKSB7CiAgfQogIGZ1bmN0aW9uIHVwZGF0ZVByaW9yaXR5KHJlcXVlc3QpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVxdWVzdC5wcmlvcml0eUZ1bmN0aW9uKSkgewogICAgICByZXF1ZXN0LnByaW9yaXR5ID0gcmVxdWVzdC5wcmlvcml0eUZ1bmN0aW9uKCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGlzc3VlUmVxdWVzdChyZXF1ZXN0KSB7CiAgICBpZiAocmVxdWVzdC5zdGF0ZSA9PT0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuVU5JU1NVRUQpIHsKICAgICAgcmVxdWVzdC5zdGF0ZSA9IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LklTU1VFRDsKICAgICAgcmVxdWVzdC5kZWZlcnJlZCA9IGRlZmVyX2RlZmF1bHQoKTsKICAgIH0KICAgIHJldHVybiByZXF1ZXN0LmRlZmVycmVkLnByb21pc2U7CiAgfQogIGZ1bmN0aW9uIGdldFJlcXVlc3RSZWNlaXZlZEZ1bmN0aW9uKHJlcXVlc3QpIHsKICAgIHJldHVybiBmdW5jdGlvbihyZXN1bHRzKSB7CiAgICAgIGlmIChyZXF1ZXN0LnN0YXRlID09PSBSZXF1ZXN0U3RhdGVfZGVmYXVsdC5DQU5DRUxMRUQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc3QgZGVmZXJyZWQgPSByZXF1ZXN0LmRlZmVycmVkOwogICAgICAtLXN0YXRpc3RpY3MubnVtYmVyT2ZBY3RpdmVSZXF1ZXN0czsKICAgICAgLS1udW1iZXJPZkFjdGl2ZVJlcXVlc3RzQnlTZXJ2ZXJbcmVxdWVzdC5zZXJ2ZXJLZXldOwogICAgICByZXF1ZXN0Q29tcGxldGVkRXZlbnQucmFpc2VFdmVudCgpOwogICAgICByZXF1ZXN0LnN0YXRlID0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuUkVDRUlWRUQ7CiAgICAgIHJlcXVlc3QuZGVmZXJyZWQgPSB2b2lkIDA7CiAgICAgIGRlZmVycmVkLnJlc29sdmUocmVzdWx0cyk7CiAgICB9OwogIH0KICBmdW5jdGlvbiBnZXRSZXF1ZXN0RmFpbGVkRnVuY3Rpb24ocmVxdWVzdCkgewogICAgcmV0dXJuIGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgIGlmIChyZXF1ZXN0LnN0YXRlID09PSBSZXF1ZXN0U3RhdGVfZGVmYXVsdC5DQU5DRUxMRUQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgKytzdGF0aXN0aWNzLm51bWJlck9mRmFpbGVkUmVxdWVzdHM7CiAgICAgIC0tc3RhdGlzdGljcy5udW1iZXJPZkFjdGl2ZVJlcXVlc3RzOwogICAgICAtLW51bWJlck9mQWN0aXZlUmVxdWVzdHNCeVNlcnZlcltyZXF1ZXN0LnNlcnZlcktleV07CiAgICAgIHJlcXVlc3RDb21wbGV0ZWRFdmVudC5yYWlzZUV2ZW50KGVycm9yKTsKICAgICAgcmVxdWVzdC5zdGF0ZSA9IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LkZBSUxFRDsKICAgICAgcmVxdWVzdC5kZWZlcnJlZC5yZWplY3QoZXJyb3IpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gc3RhcnRSZXF1ZXN0KHJlcXVlc3QpIHsKICAgIGNvbnN0IHByb21pc2UgPSBpc3N1ZVJlcXVlc3QocmVxdWVzdCk7CiAgICByZXF1ZXN0LnN0YXRlID0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuQUNUSVZFOwogICAgYWN0aXZlUmVxdWVzdHMucHVzaChyZXF1ZXN0KTsKICAgICsrc3RhdGlzdGljcy5udW1iZXJPZkFjdGl2ZVJlcXVlc3RzOwogICAgKytzdGF0aXN0aWNzLm51bWJlck9mQWN0aXZlUmVxdWVzdHNFdmVyOwogICAgKytudW1iZXJPZkFjdGl2ZVJlcXVlc3RzQnlTZXJ2ZXJbcmVxdWVzdC5zZXJ2ZXJLZXldOwogICAgcmVxdWVzdC5yZXF1ZXN0RnVuY3Rpb24oKS50aGVuKGdldFJlcXVlc3RSZWNlaXZlZEZ1bmN0aW9uKHJlcXVlc3QpKS5jYXRjaChnZXRSZXF1ZXN0RmFpbGVkRnVuY3Rpb24ocmVxdWVzdCkpOwogICAgcmV0dXJuIHByb21pc2U7CiAgfQogIGZ1bmN0aW9uIGNhbmNlbFJlcXVlc3QocmVxdWVzdCkgewogICAgY29uc3QgYWN0aXZlID0gcmVxdWVzdC5zdGF0ZSA9PT0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuQUNUSVZFOwogICAgcmVxdWVzdC5zdGF0ZSA9IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LkNBTkNFTExFRDsKICAgICsrc3RhdGlzdGljcy5udW1iZXJPZkNhbmNlbGxlZFJlcXVlc3RzOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZXF1ZXN0LmRlZmVycmVkKSkgewogICAgICBjb25zdCBkZWZlcnJlZCA9IHJlcXVlc3QuZGVmZXJyZWQ7CiAgICAgIHJlcXVlc3QuZGVmZXJyZWQgPSB2b2lkIDA7CiAgICAgIGRlZmVycmVkLnJlamVjdCgpOwogICAgfQogICAgaWYgKGFjdGl2ZSkgewogICAgICAtLXN0YXRpc3RpY3MubnVtYmVyT2ZBY3RpdmVSZXF1ZXN0czsKICAgICAgLS1udW1iZXJPZkFjdGl2ZVJlcXVlc3RzQnlTZXJ2ZXJbcmVxdWVzdC5zZXJ2ZXJLZXldOwogICAgICArK3N0YXRpc3RpY3MubnVtYmVyT2ZDYW5jZWxsZWRBY3RpdmVSZXF1ZXN0czsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVxdWVzdC5jYW5jZWxGdW5jdGlvbikpIHsKICAgICAgcmVxdWVzdC5jYW5jZWxGdW5jdGlvbigpOwogICAgfQogIH0KICBmdW5jdGlvbiB1cGRhdGVTdGF0aXN0aWNzKCkgewogICAgaWYgKCFSZXF1ZXN0U2NoZWR1bGVyLmRlYnVnU2hvd1N0YXRpc3RpY3MpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHN0YXRpc3RpY3MubnVtYmVyT2ZBY3RpdmVSZXF1ZXN0cyA9PT0gMCAmJiBzdGF0aXN0aWNzLmxhc3ROdW1iZXJPZkFjdGl2ZVJlcXVlc3RzID4gMCkgewogICAgICBpZiAoc3RhdGlzdGljcy5udW1iZXJPZkF0dGVtcHRlZFJlcXVlc3RzID4gMCkgewogICAgICAgIGNvbnNvbGUubG9nKAogICAgICAgICAgYE51bWJlciBvZiBhdHRlbXB0ZWQgcmVxdWVzdHM6ICR7c3RhdGlzdGljcy5udW1iZXJPZkF0dGVtcHRlZFJlcXVlc3RzfWAKICAgICAgICApOwogICAgICAgIHN0YXRpc3RpY3MubnVtYmVyT2ZBdHRlbXB0ZWRSZXF1ZXN0cyA9IDA7CiAgICAgIH0KICAgICAgaWYgKHN0YXRpc3RpY3MubnVtYmVyT2ZDYW5jZWxsZWRSZXF1ZXN0cyA+IDApIHsKICAgICAgICBjb25zb2xlLmxvZygKICAgICAgICAgIGBOdW1iZXIgb2YgY2FuY2VsbGVkIHJlcXVlc3RzOiAke3N0YXRpc3RpY3MubnVtYmVyT2ZDYW5jZWxsZWRSZXF1ZXN0c31gCiAgICAgICAgKTsKICAgICAgICBzdGF0aXN0aWNzLm51bWJlck9mQ2FuY2VsbGVkUmVxdWVzdHMgPSAwOwogICAgICB9CiAgICAgIGlmIChzdGF0aXN0aWNzLm51bWJlck9mQ2FuY2VsbGVkQWN0aXZlUmVxdWVzdHMgPiAwKSB7CiAgICAgICAgY29uc29sZS5sb2coCiAgICAgICAgICBgTnVtYmVyIG9mIGNhbmNlbGxlZCBhY3RpdmUgcmVxdWVzdHM6ICR7c3RhdGlzdGljcy5udW1iZXJPZkNhbmNlbGxlZEFjdGl2ZVJlcXVlc3RzfWAKICAgICAgICApOwogICAgICAgIHN0YXRpc3RpY3MubnVtYmVyT2ZDYW5jZWxsZWRBY3RpdmVSZXF1ZXN0cyA9IDA7CiAgICAgIH0KICAgICAgaWYgKHN0YXRpc3RpY3MubnVtYmVyT2ZGYWlsZWRSZXF1ZXN0cyA+IDApIHsKICAgICAgICBjb25zb2xlLmxvZygKICAgICAgICAgIGBOdW1iZXIgb2YgZmFpbGVkIHJlcXVlc3RzOiAke3N0YXRpc3RpY3MubnVtYmVyT2ZGYWlsZWRSZXF1ZXN0c31gCiAgICAgICAgKTsKICAgICAgICBzdGF0aXN0aWNzLm51bWJlck9mRmFpbGVkUmVxdWVzdHMgPSAwOwogICAgICB9CiAgICB9CiAgICBzdGF0aXN0aWNzLmxhc3ROdW1iZXJPZkFjdGl2ZVJlcXVlc3RzID0gc3RhdGlzdGljcy5udW1iZXJPZkFjdGl2ZVJlcXVlc3RzOwogIH0KICB2YXIgaW1wb3J0X3VyaWpzNCwgc3RhdGlzdGljcywgcHJpb3JpdHlIZWFwTGVuZ3RoLCByZXF1ZXN0SGVhcCwgYWN0aXZlUmVxdWVzdHMsIG51bWJlck9mQWN0aXZlUmVxdWVzdHNCeVNlcnZlciwgcGFnZVVyaSwgcmVxdWVzdENvbXBsZXRlZEV2ZW50LCBSZXF1ZXN0U2NoZWR1bGVyX2RlZmF1bHQ7CiAgdmFyIGluaXRfUmVxdWVzdFNjaGVkdWxlciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVxdWVzdFNjaGVkdWxlci5qcyIoKSB7CiAgICAgIGltcG9ydF91cmlqczQgPSBfX3RvRVNNKHJlcXVpcmVfVVJJKCksIDEpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmZXIoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRXZlbnQoKTsKICAgICAgaW5pdF9IZWFwKCk7CiAgICAgIGluaXRfaXNCbG9iVXJpKCk7CiAgICAgIGluaXRfaXNEYXRhVXJpKCk7CiAgICAgIGluaXRfUmVxdWVzdFN0YXRlKCk7CiAgICAgIHN0YXRpc3RpY3MgPSB7CiAgICAgICAgbnVtYmVyT2ZBdHRlbXB0ZWRSZXF1ZXN0czogMCwKICAgICAgICBudW1iZXJPZkFjdGl2ZVJlcXVlc3RzOiAwLAogICAgICAgIG51bWJlck9mQ2FuY2VsbGVkUmVxdWVzdHM6IDAsCiAgICAgICAgbnVtYmVyT2ZDYW5jZWxsZWRBY3RpdmVSZXF1ZXN0czogMCwKICAgICAgICBudW1iZXJPZkZhaWxlZFJlcXVlc3RzOiAwLAogICAgICAgIG51bWJlck9mQWN0aXZlUmVxdWVzdHNFdmVyOiAwLAogICAgICAgIGxhc3ROdW1iZXJPZkFjdGl2ZVJlcXVlc3RzOiAwCiAgICAgIH07CiAgICAgIHByaW9yaXR5SGVhcExlbmd0aCA9IDIwOwogICAgICByZXF1ZXN0SGVhcCA9IG5ldyBIZWFwX2RlZmF1bHQoewogICAgICAgIGNvbXBhcmF0b3I6IHNvcnRSZXF1ZXN0cwogICAgICB9KTsKICAgICAgcmVxdWVzdEhlYXAubWF4aW11bUxlbmd0aCA9IHByaW9yaXR5SGVhcExlbmd0aDsKICAgICAgcmVxdWVzdEhlYXAucmVzZXJ2ZShwcmlvcml0eUhlYXBMZW5ndGgpOwogICAgICBhY3RpdmVSZXF1ZXN0cyA9IFtdOwogICAgICBudW1iZXJPZkFjdGl2ZVJlcXVlc3RzQnlTZXJ2ZXIgPSB7fTsKICAgICAgcGFnZVVyaSA9IHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgPyBuZXcgaW1wb3J0X3VyaWpzNC5kZWZhdWx0KGRvY3VtZW50LmxvY2F0aW9uLmhyZWYpIDogbmV3IGltcG9ydF91cmlqczQuZGVmYXVsdCgpOwogICAgICByZXF1ZXN0Q29tcGxldGVkRXZlbnQgPSBuZXcgRXZlbnRfZGVmYXVsdCgpOwogICAgICBSZXF1ZXN0U2NoZWR1bGVyLm1heGltdW1SZXF1ZXN0cyA9IDUwOwogICAgICBSZXF1ZXN0U2NoZWR1bGVyLm1heGltdW1SZXF1ZXN0c1BlclNlcnZlciA9IDE4OwogICAgICBSZXF1ZXN0U2NoZWR1bGVyLnJlcXVlc3RzQnlTZXJ2ZXIgPSB7fTsKICAgICAgUmVxdWVzdFNjaGVkdWxlci50aHJvdHRsZVJlcXVlc3RzID0gdHJ1ZTsKICAgICAgUmVxdWVzdFNjaGVkdWxlci5kZWJ1Z1Nob3dTdGF0aXN0aWNzID0gZmFsc2U7CiAgICAgIFJlcXVlc3RTY2hlZHVsZXIucmVxdWVzdENvbXBsZXRlZEV2ZW50ID0gcmVxdWVzdENvbXBsZXRlZEV2ZW50OwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhSZXF1ZXN0U2NoZWR1bGVyLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0aGUgc3RhdGlzdGljcyB1c2VkIGJ5IHRoZSByZXF1ZXN0IHNjaGVkdWxlci4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBSZXF1ZXN0U2NoZWR1bGVyCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7b2JqZWN0fQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgc3RhdGlzdGljczogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHN0YXRpc3RpY3M7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgbWF4aW11bSBzaXplIG9mIHRoZSBwcmlvcml0eSBoZWFwLiBUaGlzIGxpbWl0cyB0aGUgbnVtYmVyIG9mIHJlcXVlc3RzIHRoYXQgYXJlIHNvcnRlZCBieSBwcmlvcml0eS4gT25seSBhcHBsaWVzIHRvIHJlcXVlc3RzIHRoYXQgYXJlIG5vdCB5ZXQgYWN0aXZlLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIFJlcXVlc3RTY2hlZHVsZXIKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGRlZmF1bHQgMjAKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHByaW9yaXR5SGVhcExlbmd0aDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHByaW9yaXR5SGVhcExlbmd0aDsKICAgICAgICAgIH0sCiAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSA8IHByaW9yaXR5SGVhcExlbmd0aCkgewogICAgICAgICAgICAgIHdoaWxlIChyZXF1ZXN0SGVhcC5sZW5ndGggPiB2YWx1ZSkgewogICAgICAgICAgICAgICAgY29uc3QgcmVxdWVzdCA9IHJlcXVlc3RIZWFwLnBvcCgpOwogICAgICAgICAgICAgICAgY2FuY2VsUmVxdWVzdChyZXF1ZXN0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHJpb3JpdHlIZWFwTGVuZ3RoID0gdmFsdWU7CiAgICAgICAgICAgIHJlcXVlc3RIZWFwLm1heGltdW1MZW5ndGggPSB2YWx1ZTsKICAgICAgICAgICAgcmVxdWVzdEhlYXAucmVzZXJ2ZSh2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgUmVxdWVzdFNjaGVkdWxlci5zZXJ2ZXJIYXNPcGVuU2xvdHMgPSBmdW5jdGlvbihzZXJ2ZXJLZXksIGRlc2lyZWRSZXF1ZXN0cykgewogICAgICAgIGRlc2lyZWRSZXF1ZXN0cyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGRlc2lyZWRSZXF1ZXN0cywgMSk7CiAgICAgICAgY29uc3QgbWF4UmVxdWVzdHMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgIFJlcXVlc3RTY2hlZHVsZXIucmVxdWVzdHNCeVNlcnZlcltzZXJ2ZXJLZXldLAogICAgICAgICAgUmVxdWVzdFNjaGVkdWxlci5tYXhpbXVtUmVxdWVzdHNQZXJTZXJ2ZXIKICAgICAgICApOwogICAgICAgIGNvbnN0IGhhc09wZW5TbG90c1NlcnZlciA9IG51bWJlck9mQWN0aXZlUmVxdWVzdHNCeVNlcnZlcltzZXJ2ZXJLZXldICsgZGVzaXJlZFJlcXVlc3RzIDw9IG1heFJlcXVlc3RzOwogICAgICAgIHJldHVybiBoYXNPcGVuU2xvdHNTZXJ2ZXI7CiAgICAgIH07CiAgICAgIFJlcXVlc3RTY2hlZHVsZXIuaGVhcEhhc09wZW5TbG90cyA9IGZ1bmN0aW9uKGRlc2lyZWRSZXF1ZXN0cykgewogICAgICAgIGNvbnN0IGhhc09wZW5TbG90c0hlYXAgPSByZXF1ZXN0SGVhcC5sZW5ndGggKyBkZXNpcmVkUmVxdWVzdHMgPD0gcHJpb3JpdHlIZWFwTGVuZ3RoOwogICAgICAgIHJldHVybiBoYXNPcGVuU2xvdHNIZWFwOwogICAgICB9OwogICAgICBSZXF1ZXN0U2NoZWR1bGVyLnVwZGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGxldCBpOwogICAgICAgIGxldCByZXF1ZXN0OwogICAgICAgIGxldCByZW1vdmVDb3VudCA9IDA7CiAgICAgICAgY29uc3QgYWN0aXZlTGVuZ3RoID0gYWN0aXZlUmVxdWVzdHMubGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBhY3RpdmVMZW5ndGg7ICsraSkgewogICAgICAgICAgcmVxdWVzdCA9IGFjdGl2ZVJlcXVlc3RzW2ldOwogICAgICAgICAgaWYgKHJlcXVlc3QuY2FuY2VsbGVkKSB7CiAgICAgICAgICAgIGNhbmNlbFJlcXVlc3QocmVxdWVzdCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmVxdWVzdC5zdGF0ZSAhPT0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuQUNUSVZFKSB7CiAgICAgICAgICAgICsrcmVtb3ZlQ291bnQ7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlbW92ZUNvdW50ID4gMCkgewogICAgICAgICAgICBhY3RpdmVSZXF1ZXN0c1tpIC0gcmVtb3ZlQ291bnRdID0gcmVxdWVzdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgYWN0aXZlUmVxdWVzdHMubGVuZ3RoIC09IHJlbW92ZUNvdW50OwogICAgICAgIGNvbnN0IGlzc3VlZFJlcXVlc3RzID0gcmVxdWVzdEhlYXAuaW50ZXJuYWxBcnJheTsKICAgICAgICBjb25zdCBpc3N1ZWRMZW5ndGggPSByZXF1ZXN0SGVhcC5sZW5ndGg7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGlzc3VlZExlbmd0aDsgKytpKSB7CiAgICAgICAgICB1cGRhdGVQcmlvcml0eShpc3N1ZWRSZXF1ZXN0c1tpXSk7CiAgICAgICAgfQogICAgICAgIHJlcXVlc3RIZWFwLnJlc29ydCgpOwogICAgICAgIGNvbnN0IG9wZW5TbG90cyA9IE1hdGgubWF4KAogICAgICAgICAgUmVxdWVzdFNjaGVkdWxlci5tYXhpbXVtUmVxdWVzdHMgLSBhY3RpdmVSZXF1ZXN0cy5sZW5ndGgsCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICBsZXQgZmlsbGVkU2xvdHMgPSAwOwogICAgICAgIHdoaWxlIChmaWxsZWRTbG90cyA8IG9wZW5TbG90cyAmJiByZXF1ZXN0SGVhcC5sZW5ndGggPiAwKSB7CiAgICAgICAgICByZXF1ZXN0ID0gcmVxdWVzdEhlYXAucG9wKCk7CiAgICAgICAgICBpZiAocmVxdWVzdC5jYW5jZWxsZWQpIHsKICAgICAgICAgICAgY2FuY2VsUmVxdWVzdChyZXF1ZXN0KTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmVxdWVzdC50aHJvdHRsZUJ5U2VydmVyICYmICFSZXF1ZXN0U2NoZWR1bGVyLnNlcnZlckhhc09wZW5TbG90cyhyZXF1ZXN0LnNlcnZlcktleSkpIHsKICAgICAgICAgICAgY2FuY2VsUmVxdWVzdChyZXF1ZXN0KTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBzdGFydFJlcXVlc3QocmVxdWVzdCk7CiAgICAgICAgICArK2ZpbGxlZFNsb3RzOwogICAgICAgIH0KICAgICAgICB1cGRhdGVTdGF0aXN0aWNzKCk7CiAgICAgIH07CiAgICAgIFJlcXVlc3RTY2hlZHVsZXIuZ2V0U2VydmVyS2V5ID0gZnVuY3Rpb24odXJsKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yuc3RyaW5nKCJ1cmwiLCB1cmwpOwogICAgICAgIGxldCB1cmkgPSBuZXcgaW1wb3J0X3VyaWpzNC5kZWZhdWx0KHVybCk7CiAgICAgICAgaWYgKHVyaS5zY2hlbWUoKSA9PT0gIiIpIHsKICAgICAgICAgIHVyaSA9IHVyaS5hYnNvbHV0ZVRvKHBhZ2VVcmkpOwogICAgICAgICAgdXJpLm5vcm1hbGl6ZSgpOwogICAgICAgIH0KICAgICAgICBsZXQgc2VydmVyS2V5ID0gdXJpLmF1dGhvcml0eSgpOwogICAgICAgIGlmICghLzovLnRlc3Qoc2VydmVyS2V5KSkgewogICAgICAgICAgc2VydmVyS2V5ID0gYCR7c2VydmVyS2V5fToke3VyaS5zY2hlbWUoKSA9PT0gImh0dHBzIiA/ICI0NDMiIDogIjgwIn1gOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBudW1iZXJPZkFjdGl2ZVJlcXVlc3RzQnlTZXJ2ZXJbc2VydmVyS2V5XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChsZW5ndGgpKSB7CiAgICAgICAgICBudW1iZXJPZkFjdGl2ZVJlcXVlc3RzQnlTZXJ2ZXJbc2VydmVyS2V5XSA9IDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzZXJ2ZXJLZXk7CiAgICAgIH07CiAgICAgIFJlcXVlc3RTY2hlZHVsZXIucmVxdWVzdCA9IGZ1bmN0aW9uKHJlcXVlc3QpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlcXVlc3QiLCByZXF1ZXN0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5zdHJpbmcoInJlcXVlc3QudXJsIiwgcmVxdWVzdC51cmwpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLmZ1bmMoInJlcXVlc3QucmVxdWVzdEZ1bmN0aW9uIiwgcmVxdWVzdC5yZXF1ZXN0RnVuY3Rpb24pOwogICAgICAgIGlmIChpc0RhdGFVcmlfZGVmYXVsdChyZXF1ZXN0LnVybCkgfHwgaXNCbG9iVXJpX2RlZmF1bHQocmVxdWVzdC51cmwpKSB7CiAgICAgICAgICByZXF1ZXN0Q29tcGxldGVkRXZlbnQucmFpc2VFdmVudCgpOwogICAgICAgICAgcmVxdWVzdC5zdGF0ZSA9IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LlJFQ0VJVkVEOwogICAgICAgICAgcmV0dXJuIHJlcXVlc3QucmVxdWVzdEZ1bmN0aW9uKCk7CiAgICAgICAgfQogICAgICAgICsrc3RhdGlzdGljcy5udW1iZXJPZkF0dGVtcHRlZFJlcXVlc3RzOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlcXVlc3Quc2VydmVyS2V5KSkgewogICAgICAgICAgcmVxdWVzdC5zZXJ2ZXJLZXkgPSBSZXF1ZXN0U2NoZWR1bGVyLmdldFNlcnZlcktleShyZXF1ZXN0LnVybCk7CiAgICAgICAgfQogICAgICAgIGlmIChSZXF1ZXN0U2NoZWR1bGVyLnRocm90dGxlUmVxdWVzdHMgJiYgcmVxdWVzdC50aHJvdHRsZUJ5U2VydmVyICYmICFSZXF1ZXN0U2NoZWR1bGVyLnNlcnZlckhhc09wZW5TbG90cyhyZXF1ZXN0LnNlcnZlcktleSkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghUmVxdWVzdFNjaGVkdWxlci50aHJvdHRsZVJlcXVlc3RzIHx8ICFyZXF1ZXN0LnRocm90dGxlKSB7CiAgICAgICAgICByZXR1cm4gc3RhcnRSZXF1ZXN0KHJlcXVlc3QpOwogICAgICAgIH0KICAgICAgICBpZiAoYWN0aXZlUmVxdWVzdHMubGVuZ3RoID49IFJlcXVlc3RTY2hlZHVsZXIubWF4aW11bVJlcXVlc3RzKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICB1cGRhdGVQcmlvcml0eShyZXF1ZXN0KTsKICAgICAgICBjb25zdCByZW1vdmVkUmVxdWVzdCA9IHJlcXVlc3RIZWFwLmluc2VydChyZXF1ZXN0KTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlbW92ZWRSZXF1ZXN0KSkgewogICAgICAgICAgaWYgKHJlbW92ZWRSZXF1ZXN0ID09PSByZXF1ZXN0KSB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICBjYW5jZWxSZXF1ZXN0KHJlbW92ZWRSZXF1ZXN0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGlzc3VlUmVxdWVzdChyZXF1ZXN0KTsKICAgICAgfTsKICAgICAgUmVxdWVzdFNjaGVkdWxlci5jbGVhckZvclNwZWNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgd2hpbGUgKHJlcXVlc3RIZWFwLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGNvbnN0IHJlcXVlc3QgPSByZXF1ZXN0SGVhcC5wb3AoKTsKICAgICAgICAgIGNhbmNlbFJlcXVlc3QocmVxdWVzdCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFjdGl2ZVJlcXVlc3RzLmxlbmd0aDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBjYW5jZWxSZXF1ZXN0KGFjdGl2ZVJlcXVlc3RzW2ldKTsKICAgICAgICB9CiAgICAgICAgYWN0aXZlUmVxdWVzdHMubGVuZ3RoID0gMDsKICAgICAgICBudW1iZXJPZkFjdGl2ZVJlcXVlc3RzQnlTZXJ2ZXIgPSB7fTsKICAgICAgICBzdGF0aXN0aWNzLm51bWJlck9mQXR0ZW1wdGVkUmVxdWVzdHMgPSAwOwogICAgICAgIHN0YXRpc3RpY3MubnVtYmVyT2ZBY3RpdmVSZXF1ZXN0cyA9IDA7CiAgICAgICAgc3RhdGlzdGljcy5udW1iZXJPZkNhbmNlbGxlZFJlcXVlc3RzID0gMDsKICAgICAgICBzdGF0aXN0aWNzLm51bWJlck9mQ2FuY2VsbGVkQWN0aXZlUmVxdWVzdHMgPSAwOwogICAgICAgIHN0YXRpc3RpY3MubnVtYmVyT2ZGYWlsZWRSZXF1ZXN0cyA9IDA7CiAgICAgICAgc3RhdGlzdGljcy5udW1iZXJPZkFjdGl2ZVJlcXVlc3RzRXZlciA9IDA7CiAgICAgICAgc3RhdGlzdGljcy5sYXN0TnVtYmVyT2ZBY3RpdmVSZXF1ZXN0cyA9IDA7CiAgICAgIH07CiAgICAgIFJlcXVlc3RTY2hlZHVsZXIubnVtYmVyT2ZBY3RpdmVSZXF1ZXN0c0J5U2VydmVyID0gZnVuY3Rpb24oc2VydmVyS2V5KSB7CiAgICAgICAgcmV0dXJuIG51bWJlck9mQWN0aXZlUmVxdWVzdHNCeVNlcnZlcltzZXJ2ZXJLZXldOwogICAgICB9OwogICAgICBSZXF1ZXN0U2NoZWR1bGVyLnJlcXVlc3RIZWFwID0gcmVxdWVzdEhlYXA7CiAgICAgIFJlcXVlc3RTY2hlZHVsZXJfZGVmYXVsdCA9IFJlcXVlc3RTY2hlZHVsZXI7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9UcnVzdGVkU2VydmVycy5qcwogIGZ1bmN0aW9uIGdldEF1dGhvcml0eSh1cmwpIHsKICAgIGNvbnN0IHVyaSA9IG5ldyBpbXBvcnRfdXJpanM1LmRlZmF1bHQodXJsKTsKICAgIHVyaS5ub3JtYWxpemUoKTsKICAgIGxldCBhdXRob3JpdHkgPSB1cmkuYXV0aG9yaXR5KCk7CiAgICBpZiAoYXV0aG9yaXR5Lmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgdXJpLmF1dGhvcml0eShhdXRob3JpdHkpOwogICAgaWYgKGF1dGhvcml0eS5pbmRleE9mKCJAIikgIT09IC0xKSB7CiAgICAgIGNvbnN0IHBhcnRzID0gYXV0aG9yaXR5LnNwbGl0KCJAIik7CiAgICAgIGF1dGhvcml0eSA9IHBhcnRzWzFdOwogICAgfQogICAgaWYgKGF1dGhvcml0eS5pbmRleE9mKCI6IikgPT09IC0xKSB7CiAgICAgIGxldCBzY2hlbWUgPSB1cmkuc2NoZW1lKCk7CiAgICAgIGlmIChzY2hlbWUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgc2NoZW1lID0gd2luZG93LmxvY2F0aW9uLnByb3RvY29sOwogICAgICAgIHNjaGVtZSA9IHNjaGVtZS5zdWJzdHJpbmcoMCwgc2NoZW1lLmxlbmd0aCAtIDEpOwogICAgICB9CiAgICAgIGlmIChzY2hlbWUgPT09ICJodHRwIikgewogICAgICAgIGF1dGhvcml0eSArPSAiOjgwIjsKICAgICAgfSBlbHNlIGlmIChzY2hlbWUgPT09ICJodHRwcyIpIHsKICAgICAgICBhdXRob3JpdHkgKz0gIjo0NDMiOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBhdXRob3JpdHk7CiAgfQogIHZhciBpbXBvcnRfdXJpanM1LCBUcnVzdGVkU2VydmVycywgX3NlcnZlcnMsIFRydXN0ZWRTZXJ2ZXJzX2RlZmF1bHQ7CiAgdmFyIGluaXRfVHJ1c3RlZFNlcnZlcnMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RydXN0ZWRTZXJ2ZXJzLmpzIigpIHsKICAgICAgaW1wb3J0X3VyaWpzNSA9IF9fdG9FU00ocmVxdWlyZV9VUkkoKSwgMSk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIFRydXN0ZWRTZXJ2ZXJzID0ge307CiAgICAgIF9zZXJ2ZXJzID0ge307CiAgICAgIFRydXN0ZWRTZXJ2ZXJzLmFkZCA9IGZ1bmN0aW9uKGhvc3QsIHBvcnQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChob3N0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImhvc3QgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvcnQpIHx8IHBvcnQgPD0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInBvcnQgaXMgcmVxdWlyZWQgdG8gYmUgZ3JlYXRlciB0aGFuIDAuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF1dGhvcml0eSA9IGAke2hvc3QudG9Mb3dlckNhc2UoKX06JHtwb3J0fWA7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoX3NlcnZlcnNbYXV0aG9yaXR5XSkpIHsKICAgICAgICAgIF9zZXJ2ZXJzW2F1dGhvcml0eV0gPSB0cnVlOwogICAgICAgIH0KICAgICAgfTsKICAgICAgVHJ1c3RlZFNlcnZlcnMucmVtb3ZlID0gZnVuY3Rpb24oaG9zdCwgcG9ydCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGhvc3QpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiaG9zdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9ydCkgfHwgcG9ydCA8PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicG9ydCBpcyByZXF1aXJlZCB0byBiZSBncmVhdGVyIHRoYW4gMC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXV0aG9yaXR5ID0gYCR7aG9zdC50b0xvd2VyQ2FzZSgpfToke3BvcnR9YDsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KF9zZXJ2ZXJzW2F1dGhvcml0eV0pKSB7CiAgICAgICAgICBkZWxldGUgX3NlcnZlcnNbYXV0aG9yaXR5XTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIFRydXN0ZWRTZXJ2ZXJzLmNvbnRhaW5zID0gZnVuY3Rpb24odXJsKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodXJsKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInVybCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXV0aG9yaXR5ID0gZ2V0QXV0aG9yaXR5KHVybCk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChhdXRob3JpdHkpICYmIGRlZmluZWRfZGVmYXVsdChfc2VydmVyc1thdXRob3JpdHldKSkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfTsKICAgICAgVHJ1c3RlZFNlcnZlcnMuY2xlYXIgPSBmdW5jdGlvbigpIHsKICAgICAgICBfc2VydmVycyA9IHt9OwogICAgICB9OwogICAgICBUcnVzdGVkU2VydmVyc19kZWZhdWx0ID0gVHJ1c3RlZFNlcnZlcnM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZXNvdXJjZS5qcwogIGZ1bmN0aW9uIFJlc291cmNlKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIikgewogICAgICBvcHRpb25zID0gewogICAgICAgIHVybDogb3B0aW9ucwogICAgICB9OwogICAgfQogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yuc3RyaW5nKCJvcHRpb25zLnVybCIsIG9wdGlvbnMudXJsKTsKICAgIHRoaXMuX3VybCA9IHZvaWQgMDsKICAgIHRoaXMuX3RlbXBsYXRlVmFsdWVzID0gZGVmYXVsdENsb25lKG9wdGlvbnMudGVtcGxhdGVWYWx1ZXMsIHt9KTsKICAgIHRoaXMuX3F1ZXJ5UGFyYW1ldGVycyA9IGRlZmF1bHRDbG9uZShvcHRpb25zLnF1ZXJ5UGFyYW1ldGVycywge30pOwogICAgdGhpcy5oZWFkZXJzID0gZGVmYXVsdENsb25lKG9wdGlvbnMuaGVhZGVycywge30pOwogICAgdGhpcy5yZXF1ZXN0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5yZXF1ZXN0LCBuZXcgUmVxdWVzdF9kZWZhdWx0KCkpOwogICAgdGhpcy5wcm94eSA9IG9wdGlvbnMucHJveHk7CiAgICB0aGlzLnJldHJ5Q2FsbGJhY2sgPSBvcHRpb25zLnJldHJ5Q2FsbGJhY2s7CiAgICB0aGlzLnJldHJ5QXR0ZW1wdHMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnJldHJ5QXR0ZW1wdHMsIDApOwogICAgdGhpcy5fcmV0cnlDb3VudCA9IDA7CiAgICBjb25zdCBwYXJzZVVybCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMucGFyc2VVcmwsIHRydWUpOwogICAgaWYgKHBhcnNlVXJsKSB7CiAgICAgIHRoaXMucGFyc2VVcmwob3B0aW9ucy51cmwsIHRydWUsIHRydWUpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fdXJsID0gb3B0aW9ucy51cmw7CiAgICB9CiAgICB0aGlzLl9jcmVkaXRzID0gb3B0aW9ucy5jcmVkaXRzOwogIH0KICBmdW5jdGlvbiBkZWZhdWx0Q2xvbmUodmFsdWUsIGRlZmF1bHRWYWx1ZTIpIHsKICAgIHJldHVybiBkZWZpbmVkX2RlZmF1bHQodmFsdWUpID8gY2xvbmVfZGVmYXVsdCh2YWx1ZSkgOiBkZWZhdWx0VmFsdWUyOwogIH0KICBmdW5jdGlvbiBwYXJzZVF1ZXJ5U3RyaW5nKHF1ZXJ5U3RyaW5nKSB7CiAgICBpZiAocXVlcnlTdHJpbmcubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiB7fTsKICAgIH0KICAgIGlmIChxdWVyeVN0cmluZy5pbmRleE9mKCI9IikgPT09IC0xKSB7CiAgICAgIHJldHVybiB7IFtxdWVyeVN0cmluZ106IHZvaWQgMCB9OwogICAgfQogICAgcmV0dXJuIHF1ZXJ5VG9PYmplY3RfZGVmYXVsdChxdWVyeVN0cmluZyk7CiAgfQogIGZ1bmN0aW9uIGNvbWJpbmVRdWVyeVBhcmFtZXRlcnMocTEyLCBxMjIsIHByZXNlcnZlUXVlcnlQYXJhbWV0ZXJzKSB7CiAgICBpZiAoIXByZXNlcnZlUXVlcnlQYXJhbWV0ZXJzKSB7CiAgICAgIHJldHVybiBjb21iaW5lX2RlZmF1bHQocTEyLCBxMjIpOwogICAgfQogICAgY29uc3QgcmVzdWx0ID0gY2xvbmVfZGVmYXVsdChxMTIsIHRydWUpOwogICAgZm9yIChjb25zdCBwYXJhbSBpbiBxMjIpIHsKICAgICAgaWYgKHEyMi5oYXNPd25Qcm9wZXJ0eShwYXJhbSkpIHsKICAgICAgICBsZXQgdmFsdWUgPSByZXN1bHRbcGFyYW1dOwogICAgICAgIGNvbnN0IHEyVmFsdWUgPSBxMjJbcGFyYW1dOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgIHZhbHVlID0gcmVzdWx0W3BhcmFtXSA9IFt2YWx1ZV07CiAgICAgICAgICB9CiAgICAgICAgICByZXN1bHRbcGFyYW1dID0gdmFsdWUuY29uY2F0KHEyVmFsdWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHRbcGFyYW1dID0gQXJyYXkuaXNBcnJheShxMlZhbHVlKSA/IHEyVmFsdWUuc2xpY2UoKSA6IHEyVmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBzdHJpbmdpZnlRdWVyeShxdWVyeU9iamVjdCkgewogICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHF1ZXJ5T2JqZWN0KTsKICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gIiI7CiAgICB9CiAgICBpZiAoa2V5cy5sZW5ndGggPT09IDEgJiYgIWRlZmluZWRfZGVmYXVsdChxdWVyeU9iamVjdFtrZXlzWzBdXSkpIHsKICAgICAgcmV0dXJuIGA/JHtrZXlzWzBdfWA7CiAgICB9CiAgICByZXR1cm4gYD8ke29iamVjdFRvUXVlcnlfZGVmYXVsdChxdWVyeU9iamVjdCl9YDsKICB9CiAgZnVuY3Rpb24gZmV0Y2hJbWFnZShvcHRpb25zKSB7CiAgICBjb25zdCByZXNvdXJjZSA9IG9wdGlvbnMucmVzb3VyY2U7CiAgICBjb25zdCBmbGlwWSA9IG9wdGlvbnMuZmxpcFk7CiAgICBjb25zdCBza2lwQ29sb3JTcGFjZUNvbnZlcnNpb24gPSBvcHRpb25zLnNraXBDb2xvclNwYWNlQ29udmVyc2lvbjsKICAgIGNvbnN0IHByZWZlckltYWdlQml0bWFwID0gb3B0aW9ucy5wcmVmZXJJbWFnZUJpdG1hcDsKICAgIGNvbnN0IHJlcXVlc3QgPSByZXNvdXJjZS5yZXF1ZXN0OwogICAgcmVxdWVzdC51cmwgPSByZXNvdXJjZS51cmw7CiAgICByZXF1ZXN0LnJlcXVlc3RGdW5jdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICBsZXQgY3Jvc3NPcmlnaW4gPSBmYWxzZTsKICAgICAgaWYgKCFyZXNvdXJjZS5pc0RhdGFVcmkgJiYgIXJlc291cmNlLmlzQmxvYlVyaSkgewogICAgICAgIGNyb3NzT3JpZ2luID0gcmVzb3VyY2UuaXNDcm9zc09yaWdpblVybDsKICAgICAgfQogICAgICBjb25zdCBkZWZlcnJlZCA9IGRlZmVyX2RlZmF1bHQoKTsKICAgICAgUmVzb3VyY2UuX0ltcGxlbWVudGF0aW9ucy5jcmVhdGVJbWFnZSgKICAgICAgICByZXF1ZXN0LAogICAgICAgIGNyb3NzT3JpZ2luLAogICAgICAgIGRlZmVycmVkLAogICAgICAgIGZsaXBZLAogICAgICAgIHNraXBDb2xvclNwYWNlQ29udmVyc2lvbiwKICAgICAgICBwcmVmZXJJbWFnZUJpdG1hcAogICAgICApOwogICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTsKICAgIH07CiAgICBjb25zdCBwcm9taXNlID0gUmVxdWVzdFNjaGVkdWxlcl9kZWZhdWx0LnJlcXVlc3QocmVxdWVzdCk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwcm9taXNlKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICByZXR1cm4gcHJvbWlzZS5jYXRjaChmdW5jdGlvbihlKSB7CiAgICAgIGlmIChyZXF1ZXN0LnN0YXRlICE9PSBSZXF1ZXN0U3RhdGVfZGVmYXVsdC5GQUlMRUQpIHsKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc291cmNlLnJldHJ5T25FcnJvcihlKS50aGVuKGZ1bmN0aW9uKHJldHJ5KSB7CiAgICAgICAgaWYgKHJldHJ5KSB7CiAgICAgICAgICByZXF1ZXN0LnN0YXRlID0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuVU5JU1NVRUQ7CiAgICAgICAgICByZXF1ZXN0LmRlZmVycmVkID0gdm9pZCAwOwogICAgICAgICAgcmV0dXJuIGZldGNoSW1hZ2UoewogICAgICAgICAgICByZXNvdXJjZSwKICAgICAgICAgICAgZmxpcFksCiAgICAgICAgICAgIHNraXBDb2xvclNwYWNlQ29udmVyc2lvbiwKICAgICAgICAgICAgcHJlZmVySW1hZ2VCaXRtYXAKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZSk7CiAgICAgIH0pOwogICAgfSk7CiAgfQogIGZ1bmN0aW9uIGZldGNoSnNvbnAocmVzb3VyY2UsIGNhbGxiYWNrUGFyYW1ldGVyTmFtZSwgZnVuY3Rpb25OYW1lKSB7CiAgICBjb25zdCBjYWxsYmFja1F1ZXJ5ID0ge307CiAgICBjYWxsYmFja1F1ZXJ5W2NhbGxiYWNrUGFyYW1ldGVyTmFtZV0gPSBmdW5jdGlvbk5hbWU7CiAgICByZXNvdXJjZS5zZXRRdWVyeVBhcmFtZXRlcnMoY2FsbGJhY2tRdWVyeSk7CiAgICBjb25zdCByZXF1ZXN0ID0gcmVzb3VyY2UucmVxdWVzdDsKICAgIGNvbnN0IHVybCA9IHJlc291cmNlLnVybDsKICAgIHJlcXVlc3QudXJsID0gdXJsOwogICAgcmVxdWVzdC5yZXF1ZXN0RnVuY3Rpb24gPSBmdW5jdGlvbigpIHsKICAgICAgY29uc3QgZGVmZXJyZWQgPSBkZWZlcl9kZWZhdWx0KCk7CiAgICAgIHdpbmRvd1tmdW5jdGlvbk5hbWVdID0gZnVuY3Rpb24oZGF0YSkgewogICAgICAgIGRlZmVycmVkLnJlc29sdmUoZGF0YSk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGRlbGV0ZSB3aW5kb3dbZnVuY3Rpb25OYW1lXTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICB3aW5kb3dbZnVuY3Rpb25OYW1lXSA9IHZvaWQgMDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIFJlc291cmNlLl9JbXBsZW1lbnRhdGlvbnMubG9hZEFuZEV4ZWN1dGVTY3JpcHQodXJsLCBmdW5jdGlvbk5hbWUsIGRlZmVycmVkKTsKICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7CiAgICB9OwogICAgY29uc3QgcHJvbWlzZSA9IFJlcXVlc3RTY2hlZHVsZXJfZGVmYXVsdC5yZXF1ZXN0KHJlcXVlc3QpOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocHJvbWlzZSkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgcmV0dXJuIHByb21pc2UuY2F0Y2goZnVuY3Rpb24oZSkgewogICAgICBpZiAocmVxdWVzdC5zdGF0ZSAhPT0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuRkFJTEVEKSB7CiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGUpOwogICAgICB9CiAgICAgIHJldHVybiByZXNvdXJjZS5yZXRyeU9uRXJyb3IoZSkudGhlbihmdW5jdGlvbihyZXRyeSkgewogICAgICAgIGlmIChyZXRyeSkgewogICAgICAgICAgcmVxdWVzdC5zdGF0ZSA9IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LlVOSVNTVUVEOwogICAgICAgICAgcmVxdWVzdC5kZWZlcnJlZCA9IHZvaWQgMDsKICAgICAgICAgIHJldHVybiBmZXRjaEpzb25wKHJlc291cmNlLCBjYWxsYmFja1BhcmFtZXRlck5hbWUsIGZ1bmN0aW9uTmFtZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlKTsKICAgICAgfSk7CiAgICB9KTsKICB9CiAgZnVuY3Rpb24gY2hlY2tBbmRSZXNldFJlcXVlc3QocmVxdWVzdCkgewogICAgaWYgKHJlcXVlc3Quc3RhdGUgPT09IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LklTU1VFRCB8fCByZXF1ZXN0LnN0YXRlID09PSBSZXF1ZXN0U3RhdGVfZGVmYXVsdC5BQ1RJVkUpIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJUaGUgUmVzb3VyY2UgaXMgYWxyZWFkeSBiZWluZyBmZXRjaGVkLiIpOwogICAgfQogICAgcmVxdWVzdC5zdGF0ZSA9IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LlVOSVNTVUVEOwogICAgcmVxdWVzdC5kZWZlcnJlZCA9IHZvaWQgMDsKICB9CiAgZnVuY3Rpb24gZGVjb2RlRGF0YVVyaVRleHQoaXNCYXNlNjQsIGRhdGEpIHsKICAgIGNvbnN0IHJlc3VsdCA9IGRlY29kZVVSSUNvbXBvbmVudChkYXRhKTsKICAgIGlmIChpc0Jhc2U2NCkgewogICAgICByZXR1cm4gYXRvYihyZXN1bHQpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gZGVjb2RlRGF0YVVyaUFycmF5QnVmZmVyKGlzQmFzZTY0LCBkYXRhKSB7CiAgICBjb25zdCBieXRlU3RyaW5nID0gZGVjb2RlRGF0YVVyaVRleHQoaXNCYXNlNjQsIGRhdGEpOwogICAgY29uc3QgYnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKGJ5dGVTdHJpbmcubGVuZ3RoKTsKICAgIGNvbnN0IHZpZXcgPSBuZXcgVWludDhBcnJheShidWZmZXIpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBieXRlU3RyaW5nLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZpZXdbaV0gPSBieXRlU3RyaW5nLmNoYXJDb2RlQXQoaSk7CiAgICB9CiAgICByZXR1cm4gYnVmZmVyOwogIH0KICBmdW5jdGlvbiBkZWNvZGVEYXRhVXJpKGRhdGFVcmlSZWdleFJlc3VsdCwgcmVzcG9uc2VUeXBlKSB7CiAgICByZXNwb25zZVR5cGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChyZXNwb25zZVR5cGUsICIiKTsKICAgIGNvbnN0IG1pbWVUeXBlID0gZGF0YVVyaVJlZ2V4UmVzdWx0WzFdOwogICAgY29uc3QgaXNCYXNlNjQgPSAhIWRhdGFVcmlSZWdleFJlc3VsdFsyXTsKICAgIGNvbnN0IGRhdGEgPSBkYXRhVXJpUmVnZXhSZXN1bHRbM107CiAgICBsZXQgYnVmZmVyOwogICAgbGV0IHBhcnNlcjsKICAgIHN3aXRjaCAocmVzcG9uc2VUeXBlKSB7CiAgICAgIGNhc2UgIiI6CiAgICAgIGNhc2UgInRleHQiOgogICAgICAgIHJldHVybiBkZWNvZGVEYXRhVXJpVGV4dChpc0Jhc2U2NCwgZGF0YSk7CiAgICAgIGNhc2UgImFycmF5YnVmZmVyIjoKICAgICAgICByZXR1cm4gZGVjb2RlRGF0YVVyaUFycmF5QnVmZmVyKGlzQmFzZTY0LCBkYXRhKTsKICAgICAgY2FzZSAiYmxvYiI6CiAgICAgICAgYnVmZmVyID0gZGVjb2RlRGF0YVVyaUFycmF5QnVmZmVyKGlzQmFzZTY0LCBkYXRhKTsKICAgICAgICByZXR1cm4gbmV3IEJsb2IoW2J1ZmZlcl0sIHsKICAgICAgICAgIHR5cGU6IG1pbWVUeXBlCiAgICAgICAgfSk7CiAgICAgIGNhc2UgImRvY3VtZW50IjoKICAgICAgICBwYXJzZXIgPSBuZXcgRE9NUGFyc2VyKCk7CiAgICAgICAgcmV0dXJuIHBhcnNlci5wYXJzZUZyb21TdHJpbmcoCiAgICAgICAgICBkZWNvZGVEYXRhVXJpVGV4dChpc0Jhc2U2NCwgZGF0YSksCiAgICAgICAgICBtaW1lVHlwZQogICAgICAgICk7CiAgICAgIGNhc2UgImpzb24iOgogICAgICAgIHJldHVybiBKU09OLnBhcnNlKGRlY29kZURhdGFVcmlUZXh0KGlzQmFzZTY0LCBkYXRhKSk7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoYFVuaGFuZGxlZCByZXNwb25zZVR5cGU6ICR7cmVzcG9uc2VUeXBlfWApOwogICAgfQogIH0KICBmdW5jdGlvbiBsb2FkV2l0aEh0dHBSZXF1ZXN0KHVybCwgcmVzcG9uc2VUeXBlLCBtZXRob2QsIGRhdGEsIGhlYWRlcnMsIGRlZmVycmVkLCBvdmVycmlkZU1pbWVUeXBlKSB7CiAgICBmZXRjaCh1cmwsIHsKICAgICAgbWV0aG9kLAogICAgICBoZWFkZXJzCiAgICB9KS50aGVuKGFzeW5jIChyZXNwb25zZSkgPT4gewogICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7CiAgICAgICAgY29uc3QgcmVzcG9uc2VIZWFkZXJzID0ge307CiAgICAgICAgcmVzcG9uc2UuaGVhZGVycy5mb3JFYWNoKCh2YWx1ZSwga2V5KSA9PiB7CiAgICAgICAgICByZXNwb25zZUhlYWRlcnNba2V5XSA9IHZhbHVlOwogICAgICAgIH0pOwogICAgICAgIGRlZmVycmVkLnJlamVjdCgKICAgICAgICAgIG5ldyBSZXF1ZXN0RXJyb3JFdmVudF9kZWZhdWx0KHJlc3BvbnNlLnN0YXR1cywgcmVzcG9uc2UsIHJlc3BvbnNlSGVhZGVycykKICAgICAgICApOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBzd2l0Y2ggKHJlc3BvbnNlVHlwZSkgewogICAgICAgIGNhc2UgInRleHQiOgogICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShyZXNwb25zZS50ZXh0KCkpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAianNvbiI6CiAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHJlc3BvbnNlLmpzb24oKSk7CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShuZXcgVWludDhBcnJheShhd2FpdCByZXNwb25zZS5hcnJheUJ1ZmZlcigpKS5idWZmZXIpOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0pLmNhdGNoKCgpID0+IHsKICAgICAgZGVmZXJyZWQucmVqZWN0KG5ldyBSZXF1ZXN0RXJyb3JFdmVudF9kZWZhdWx0KCkpOwogICAgfSk7CiAgfQogIHZhciBpbXBvcnRfdXJpanM2LCB4aHJCbG9iU3VwcG9ydGVkLCBzdXBwb3J0c0ltYWdlQml0bWFwT3B0aW9uc1Byb21pc2UsIGRhdGFVcmlSZWdleDIsIG5vWE1MSHR0cFJlcXVlc3QsIFJlc291cmNlX2RlZmF1bHQ7CiAgdmFyIGluaXRfUmVzb3VyY2UgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1Jlc291cmNlLmpzIigpIHsKICAgICAgaW1wb3J0X3VyaWpzNiA9IF9fdG9FU00ocmVxdWlyZV9VUkkoKSwgMSk7CiAgICAgIGluaXRfYXBwZW5kRm9yd2FyZFNsYXNoKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9jbG9uZSgpOwogICAgICBpbml0X2NvbWJpbmUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZlcigpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X2dldEFic29sdXRlVXJpKCk7CiAgICAgIGluaXRfZ2V0QmFzZVVyaSgpOwogICAgICBpbml0X2dldEV4dGVuc2lvbkZyb21VcmkoKTsKICAgICAgaW5pdF9nZXRJbWFnZVBpeGVscygpOwogICAgICBpbml0X2lzQmxvYlVyaSgpOwogICAgICBpbml0X2lzQ3Jvc3NPcmlnaW5VcmwoKTsKICAgICAgaW5pdF9pc0RhdGFVcmkoKTsKICAgICAgaW5pdF9sb2FkQW5kRXhlY3V0ZVNjcmlwdCgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9vYmplY3RUb1F1ZXJ5KCk7CiAgICAgIGluaXRfcXVlcnlUb09iamVjdCgpOwogICAgICBpbml0X1JlcXVlc3QoKTsKICAgICAgaW5pdF9SZXF1ZXN0RXJyb3JFdmVudCgpOwogICAgICBpbml0X1JlcXVlc3RTY2hlZHVsZXIoKTsKICAgICAgaW5pdF9SZXF1ZXN0U3RhdGUoKTsKICAgICAgaW5pdF9SdW50aW1lRXJyb3IoKTsKICAgICAgaW5pdF9UcnVzdGVkU2VydmVycygpOwogICAgICB4aHJCbG9iU3VwcG9ydGVkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbnN0IHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgICAgICAgeGhyLm9wZW4oIkdFVCIsICIjIiwgdHJ1ZSk7CiAgICAgICAgICB4aHIucmVzcG9uc2VUeXBlID0gImJsb2IiOwogICAgICAgICAgcmV0dXJuIHhoci5yZXNwb25zZVR5cGUgPT09ICJibG9iIjsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9KCk7CiAgICAgIFJlc291cmNlLmNyZWF0ZUlmTmVlZGVkID0gZnVuY3Rpb24ocmVzb3VyY2UpIHsKICAgICAgICBpZiAocmVzb3VyY2UgaW5zdGFuY2VvZiBSZXNvdXJjZSkgewogICAgICAgICAgcmV0dXJuIHJlc291cmNlLmdldERlcml2ZWRSZXNvdXJjZSh7CiAgICAgICAgICAgIHJlcXVlc3Q6IHJlc291cmNlLnJlcXVlc3QKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIHJlc291cmNlICE9PSAic3RyaW5nIikgewogICAgICAgICAgcmV0dXJuIHJlc291cmNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IFJlc291cmNlKHsKICAgICAgICAgIHVybDogcmVzb3VyY2UKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2Uuc3VwcG9ydHNJbWFnZUJpdG1hcE9wdGlvbnMgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHN1cHBvcnRzSW1hZ2VCaXRtYXBPcHRpb25zUHJvbWlzZSkpIHsKICAgICAgICAgIHJldHVybiBzdXBwb3J0c0ltYWdlQml0bWFwT3B0aW9uc1Byb21pc2U7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgY3JlYXRlSW1hZ2VCaXRtYXAgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIHN1cHBvcnRzSW1hZ2VCaXRtYXBPcHRpb25zUHJvbWlzZSA9IFByb21pc2UucmVzb2x2ZShmYWxzZSk7CiAgICAgICAgICByZXR1cm4gc3VwcG9ydHNJbWFnZUJpdG1hcE9wdGlvbnNQcm9taXNlOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbWFnZURhdGFVcmkgPSAiZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFBRUFBQUFCQ0FJQUFBQ1FkMVBlQUFBQUJHZEJUVUVBQUU0ZzNyRWlEZ0FBQUNCalNGSk5BQUI2SmdBQWdJUUFBUG9BQUFDQTZBQUFkVEFBQU9wZ0FBQTZtQUFBRjNDY3VsRThBQUFBREVsRVFWUUkxMk5nNkdBQUFBRVVBSW5nRTNaaUFBQUFBRWxGVGtTdVFtQ0MiOwogICAgICAgIHN1cHBvcnRzSW1hZ2VCaXRtYXBPcHRpb25zUHJvbWlzZSA9IFJlc291cmNlLmZldGNoQmxvYih7CiAgICAgICAgICB1cmw6IGltYWdlRGF0YVVyaQogICAgICAgIH0pLnRoZW4oZnVuY3Rpb24oYmxvYikgewogICAgICAgICAgY29uc3QgaW1hZ2VCaXRtYXBPcHRpb25zID0gewogICAgICAgICAgICBpbWFnZU9yaWVudGF0aW9uOiAiZmxpcFkiLAogICAgICAgICAgICAvLyBkZWZhdWx0IGlzICJub25lIgogICAgICAgICAgICBwcmVtdWx0aXBseUFscGhhOiAibm9uZSIsCiAgICAgICAgICAgIC8vIGRlZmF1bHQgaXMgImRlZmF1bHQiCiAgICAgICAgICAgIGNvbG9yU3BhY2VDb252ZXJzaW9uOiAibm9uZSIKICAgICAgICAgICAgLy8gZGVmYXVsdCBpcyAiZGVmYXVsdCIKICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoWwogICAgICAgICAgICBjcmVhdGVJbWFnZUJpdG1hcChibG9iLCBpbWFnZUJpdG1hcE9wdGlvbnMpLAogICAgICAgICAgICBjcmVhdGVJbWFnZUJpdG1hcChibG9iKQogICAgICAgICAgXSk7CiAgICAgICAgfSkudGhlbihmdW5jdGlvbihpbWFnZUJpdG1hcHMpIHsKICAgICAgICAgIGNvbnN0IGNvbG9yV2l0aE9wdGlvbnMgPSBnZXRJbWFnZVBpeGVsc19kZWZhdWx0KGltYWdlQml0bWFwc1swXSk7CiAgICAgICAgICBjb25zdCBjb2xvcldpdGhEZWZhdWx0cyA9IGdldEltYWdlUGl4ZWxzX2RlZmF1bHQoaW1hZ2VCaXRtYXBzWzFdKTsKICAgICAgICAgIHJldHVybiBjb2xvcldpdGhPcHRpb25zWzFdICE9PSBjb2xvcldpdGhEZWZhdWx0c1sxXTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gc3VwcG9ydHNJbWFnZUJpdG1hcE9wdGlvbnNQcm9taXNlOwogICAgICB9OwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhSZXNvdXJjZSwgewogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgdHJ1ZSBpZiBibG9icyBhcmUgc3VwcG9ydGVkLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIFJlc291cmNlCiAgICAgICAgICogQHR5cGUge2Jvb2xlYW59CiAgICAgICAgICoKICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBpc0Jsb2JTdXBwb3J0ZWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB4aHJCbG9iU3VwcG9ydGVkOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFJlc291cmNlLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIFF1ZXJ5IHBhcmFtZXRlcnMgYXBwZW5kZWQgdG8gdGhlIHVybC4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBSZXNvdXJjZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7b2JqZWN0fQogICAgICAgICAqCiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgcXVlcnlQYXJhbWV0ZXJzOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcXVlcnlQYXJhbWV0ZXJzOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIGtleS92YWx1ZSBwYWlycyB1c2VkIHRvIHJlcGxhY2UgdGVtcGxhdGUgcGFyYW1ldGVycyBpbiB0aGUgdXJsLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIFJlc291cmNlLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtvYmplY3R9CiAgICAgICAgICoKICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICB0ZW1wbGF0ZVZhbHVlczogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3RlbXBsYXRlVmFsdWVzOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIHVybCB0byB0aGUgcmVzb3VyY2Ugd2l0aCB0ZW1wbGF0ZSB2YWx1ZXMgcmVwbGFjZWQsIHF1ZXJ5IHN0cmluZyBhcHBlbmRlZCBhbmQgZW5jb2RlZCBieSBwcm94eSBpZiBvbmUgd2FzIHNldC4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBSZXNvdXJjZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7c3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHVybDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VXJsQ29tcG9uZW50KHRydWUsIHRydWUpOwogICAgICAgICAgfSwKICAgICAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5wYXJzZVVybCh2YWx1ZSwgZmFsc2UsIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBmaWxlIGV4dGVuc2lvbiBvZiB0aGUgcmVzb3VyY2UuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgUmVzb3VyY2UucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge3N0cmluZ30KICAgICAgICAgKgogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGV4dGVuc2lvbjogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGdldEV4dGVuc2lvbkZyb21VcmlfZGVmYXVsdCh0aGlzLl91cmwpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogVHJ1ZSBpZiB0aGUgUmVzb3VyY2UgcmVmZXJzIHRvIGEgZGF0YSBVUkkuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgUmVzb3VyY2UucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge2Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgaXNEYXRhVXJpOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gaXNEYXRhVXJpX2RlZmF1bHQodGhpcy5fdXJsKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFRydWUgaWYgdGhlIFJlc291cmNlIHJlZmVycyB0byBhIGJsb2IgVVJJLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIFJlc291cmNlLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtib29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzQmxvYlVyaTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGlzQmxvYlVyaV9kZWZhdWx0KHRoaXMuX3VybCk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBUcnVlIGlmIHRoZSBSZXNvdXJjZSByZWZlcnMgdG8gYSBjcm9zcyBvcmlnaW4gVVJMLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIFJlc291cmNlLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtib29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzQ3Jvc3NPcmlnaW5Vcmw6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBpc0Nyb3NzT3JpZ2luVXJsX2RlZmF1bHQodGhpcy5fdXJsKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFRydWUgaWYgdGhlIFJlc291cmNlIGhhcyByZXF1ZXN0IGhlYWRlcnMuIFRoaXMgaXMgZXF1aXZhbGVudCB0byBjaGVja2luZyBpZiB0aGUgaGVhZGVycyBwcm9wZXJ0eSBoYXMgYW55IGtleXMuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgUmVzb3VyY2UucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge2Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgaGFzSGVhZGVyczogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuaGVhZGVycykubGVuZ3RoID4gMDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGNyZWRpdHMgcmVxdWlyZWQgZm9yIGF0dHJpYnV0aW9uIG9mIGFuIGFzc2V0LgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgY3JlZGl0czogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2NyZWRpdHM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VXJsQ29tcG9uZW50KHRydWUsIHRydWUpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUucGFyc2VVcmwgPSBmdW5jdGlvbih1cmwsIG1lcmdlLCBwcmVzZXJ2ZVF1ZXJ5LCBiYXNlVXJsKSB7CiAgICAgICAgbGV0IHVyaSA9IG5ldyBpbXBvcnRfdXJpanM2LmRlZmF1bHQodXJsKTsKICAgICAgICBjb25zdCBxdWVyeSA9IHBhcnNlUXVlcnlTdHJpbmcodXJpLnF1ZXJ5KCkpOwogICAgICAgIHRoaXMuX3F1ZXJ5UGFyYW1ldGVycyA9IG1lcmdlID8gY29tYmluZVF1ZXJ5UGFyYW1ldGVycyhxdWVyeSwgdGhpcy5xdWVyeVBhcmFtZXRlcnMsIHByZXNlcnZlUXVlcnkpIDogcXVlcnk7CiAgICAgICAgdXJpLnNlYXJjaCgiIik7CiAgICAgICAgdXJpLmZyYWdtZW50KCIiKTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGJhc2VVcmwpICYmIHVyaS5zY2hlbWUoKSA9PT0gIiIpIHsKICAgICAgICAgIHVyaSA9IHVyaS5hYnNvbHV0ZVRvKGdldEFic29sdXRlVXJpX2RlZmF1bHQoYmFzZVVybCkpOwogICAgICAgIH0KICAgICAgICB0aGlzLl91cmwgPSB1cmkudG9TdHJpbmcoKTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmdldFVybENvbXBvbmVudCA9IGZ1bmN0aW9uKHF1ZXJ5LCBwcm94eSkgewogICAgICAgIGlmICh0aGlzLmlzRGF0YVVyaSkgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3VybDsKICAgICAgICB9CiAgICAgICAgbGV0IHVybCA9IHRoaXMuX3VybDsKICAgICAgICBpZiAocXVlcnkpIHsKICAgICAgICAgIHVybCA9IGAke3VybH0ke3N0cmluZ2lmeVF1ZXJ5KHRoaXMucXVlcnlQYXJhbWV0ZXJzKX1gOwogICAgICAgIH0KICAgICAgICB1cmwgPSB1cmwucmVwbGFjZSgvJTdCL2csICJ7IikucmVwbGFjZSgvJTdEL2csICJ9Iik7CiAgICAgICAgY29uc3QgdGVtcGxhdGVWYWx1ZXMgPSB0aGlzLl90ZW1wbGF0ZVZhbHVlczsKICAgICAgICBpZiAoT2JqZWN0LmtleXModGVtcGxhdGVWYWx1ZXMpLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHVybCA9IHVybC5yZXBsYWNlKC97KC4qPyl9L2csIGZ1bmN0aW9uKG1hdGNoLCBrZXkpIHsKICAgICAgICAgICAgY29uc3QgcmVwbGFjZW1lbnQgPSB0ZW1wbGF0ZVZhbHVlc1trZXldOwogICAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlcGxhY2VtZW50KSkgewogICAgICAgICAgICAgIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQocmVwbGFjZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAocHJveHkgJiYgZGVmaW5lZF9kZWZhdWx0KHRoaXMucHJveHkpKSB7CiAgICAgICAgICB1cmwgPSB0aGlzLnByb3h5LmdldFVSTCh1cmwpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdXJsOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUuc2V0UXVlcnlQYXJhbWV0ZXJzID0gZnVuY3Rpb24ocGFyYW1zLCB1c2VBc0RlZmF1bHQpIHsKICAgICAgICBpZiAodXNlQXNEZWZhdWx0KSB7CiAgICAgICAgICB0aGlzLl9xdWVyeVBhcmFtZXRlcnMgPSBjb21iaW5lUXVlcnlQYXJhbWV0ZXJzKAogICAgICAgICAgICB0aGlzLl9xdWVyeVBhcmFtZXRlcnMsCiAgICAgICAgICAgIHBhcmFtcywKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuX3F1ZXJ5UGFyYW1ldGVycyA9IGNvbWJpbmVRdWVyeVBhcmFtZXRlcnMoCiAgICAgICAgICAgIHBhcmFtcywKICAgICAgICAgICAgdGhpcy5fcXVlcnlQYXJhbWV0ZXJzLAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5hcHBlbmRRdWVyeVBhcmFtZXRlcnMgPSBmdW5jdGlvbihwYXJhbXMpIHsKICAgICAgICB0aGlzLl9xdWVyeVBhcmFtZXRlcnMgPSBjb21iaW5lUXVlcnlQYXJhbWV0ZXJzKAogICAgICAgICAgcGFyYW1zLAogICAgICAgICAgdGhpcy5fcXVlcnlQYXJhbWV0ZXJzLAogICAgICAgICAgdHJ1ZQogICAgICAgICk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5zZXRUZW1wbGF0ZVZhbHVlcyA9IGZ1bmN0aW9uKHRlbXBsYXRlLCB1c2VBc0RlZmF1bHQpIHsKICAgICAgICBpZiAodXNlQXNEZWZhdWx0KSB7CiAgICAgICAgICB0aGlzLl90ZW1wbGF0ZVZhbHVlcyA9IGNvbWJpbmVfZGVmYXVsdCh0aGlzLl90ZW1wbGF0ZVZhbHVlcywgdGVtcGxhdGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLl90ZW1wbGF0ZVZhbHVlcyA9IGNvbWJpbmVfZGVmYXVsdCh0ZW1wbGF0ZSwgdGhpcy5fdGVtcGxhdGVWYWx1ZXMpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmdldERlcml2ZWRSZXNvdXJjZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBjb25zdCByZXNvdXJjZSA9IHRoaXMuY2xvbmUoKTsKICAgICAgICByZXNvdXJjZS5fcmV0cnlDb3VudCA9IDA7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLnVybCkpIHsKICAgICAgICAgIGNvbnN0IHByZXNlcnZlUXVlcnkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnByZXNlcnZlUXVlcnlQYXJhbWV0ZXJzLCBmYWxzZSk7CiAgICAgICAgICByZXNvdXJjZS5wYXJzZVVybChvcHRpb25zLnVybCwgdHJ1ZSwgcHJlc2VydmVRdWVyeSwgdGhpcy5fdXJsKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLnF1ZXJ5UGFyYW1ldGVycykpIHsKICAgICAgICAgIHJlc291cmNlLl9xdWVyeVBhcmFtZXRlcnMgPSBjb21iaW5lX2RlZmF1bHQoCiAgICAgICAgICAgIG9wdGlvbnMucXVlcnlQYXJhbWV0ZXJzLAogICAgICAgICAgICByZXNvdXJjZS5xdWVyeVBhcmFtZXRlcnMKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy50ZW1wbGF0ZVZhbHVlcykpIHsKICAgICAgICAgIHJlc291cmNlLl90ZW1wbGF0ZVZhbHVlcyA9IGNvbWJpbmVfZGVmYXVsdCgKICAgICAgICAgICAgb3B0aW9ucy50ZW1wbGF0ZVZhbHVlcywKICAgICAgICAgICAgcmVzb3VyY2UudGVtcGxhdGVWYWx1ZXMKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5oZWFkZXJzKSkgewogICAgICAgICAgcmVzb3VyY2UuaGVhZGVycyA9IGNvbWJpbmVfZGVmYXVsdChvcHRpb25zLmhlYWRlcnMsIHJlc291cmNlLmhlYWRlcnMpOwogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMucHJveHkpKSB7CiAgICAgICAgICByZXNvdXJjZS5wcm94eSA9IG9wdGlvbnMucHJveHk7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5yZXF1ZXN0KSkgewogICAgICAgICAgcmVzb3VyY2UucmVxdWVzdCA9IG9wdGlvbnMucmVxdWVzdDsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLnJldHJ5Q2FsbGJhY2spKSB7CiAgICAgICAgICByZXNvdXJjZS5yZXRyeUNhbGxiYWNrID0gb3B0aW9ucy5yZXRyeUNhbGxiYWNrOwogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMucmV0cnlBdHRlbXB0cykpIHsKICAgICAgICAgIHJlc291cmNlLnJldHJ5QXR0ZW1wdHMgPSBvcHRpb25zLnJldHJ5QXR0ZW1wdHM7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXNvdXJjZTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLnJldHJ5T25FcnJvciA9IGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgICAgY29uc3QgcmV0cnlDYWxsYmFjayA9IHRoaXMucmV0cnlDYWxsYmFjazsKICAgICAgICBpZiAodHlwZW9mIHJldHJ5Q2FsbGJhY2sgIT09ICJmdW5jdGlvbiIgfHwgdGhpcy5fcmV0cnlDb3VudCA+PSB0aGlzLnJldHJ5QXR0ZW1wdHMpIHsKICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZmFsc2UpOwogICAgICAgIH0KICAgICAgICBjb25zdCB0aGF0ID0gdGhpczsKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJldHJ5Q2FsbGJhY2sodGhpcywgZXJyb3IpKS50aGVuKGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgICAgKyt0aGF0Ll9yZXRyeUNvdW50OwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBSZXNvdXJjZSh7CiAgICAgICAgICAgIHVybDogdGhpcy5fdXJsLAogICAgICAgICAgICBxdWVyeVBhcmFtZXRlcnM6IHRoaXMucXVlcnlQYXJhbWV0ZXJzLAogICAgICAgICAgICB0ZW1wbGF0ZVZhbHVlczogdGhpcy50ZW1wbGF0ZVZhbHVlcywKICAgICAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgICAgICBwcm94eTogdGhpcy5wcm94eSwKICAgICAgICAgICAgcmV0cnlDYWxsYmFjazogdGhpcy5yZXRyeUNhbGxiYWNrLAogICAgICAgICAgICByZXRyeUF0dGVtcHRzOiB0aGlzLnJldHJ5QXR0ZW1wdHMsCiAgICAgICAgICAgIHJlcXVlc3Q6IHRoaXMucmVxdWVzdC5jbG9uZSgpLAogICAgICAgICAgICBwYXJzZVVybDogZmFsc2UsCiAgICAgICAgICAgIGNyZWRpdHM6IGRlZmluZWRfZGVmYXVsdCh0aGlzLmNyZWRpdHMpID8gdGhpcy5jcmVkaXRzLnNsaWNlKCkgOiB2b2lkIDAKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX3VybCA9IHRoaXMuX3VybDsKICAgICAgICByZXN1bHQuX3F1ZXJ5UGFyYW1ldGVycyA9IGNsb25lX2RlZmF1bHQodGhpcy5fcXVlcnlQYXJhbWV0ZXJzKTsKICAgICAgICByZXN1bHQuX3RlbXBsYXRlVmFsdWVzID0gY2xvbmVfZGVmYXVsdCh0aGlzLl90ZW1wbGF0ZVZhbHVlcyk7CiAgICAgICAgcmVzdWx0LmhlYWRlcnMgPSBjbG9uZV9kZWZhdWx0KHRoaXMuaGVhZGVycyk7CiAgICAgICAgcmVzdWx0LnByb3h5ID0gdGhpcy5wcm94eTsKICAgICAgICByZXN1bHQucmV0cnlDYWxsYmFjayA9IHRoaXMucmV0cnlDYWxsYmFjazsKICAgICAgICByZXN1bHQucmV0cnlBdHRlbXB0cyA9IHRoaXMucmV0cnlBdHRlbXB0czsKICAgICAgICByZXN1bHQuX3JldHJ5Q291bnQgPSAwOwogICAgICAgIHJlc3VsdC5yZXF1ZXN0ID0gdGhpcy5yZXF1ZXN0LmNsb25lKCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmdldEJhc2VVcmkgPSBmdW5jdGlvbihpbmNsdWRlUXVlcnkpIHsKICAgICAgICByZXR1cm4gZ2V0QmFzZVVyaV9kZWZhdWx0KHRoaXMuZ2V0VXJsQ29tcG9uZW50KGluY2x1ZGVRdWVyeSksIGluY2x1ZGVRdWVyeSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5hcHBlbmRGb3J3YXJkU2xhc2ggPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLl91cmwgPSBhcHBlbmRGb3J3YXJkU2xhc2hfZGVmYXVsdCh0aGlzLl91cmwpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUuZmV0Y2hBcnJheUJ1ZmZlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmZldGNoKHsKICAgICAgICAgIHJlc3BvbnNlVHlwZTogImFycmF5YnVmZmVyIgogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5mZXRjaEFycmF5QnVmZmVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGNvbnN0IHJlc291cmNlID0gbmV3IFJlc291cmNlKG9wdGlvbnMpOwogICAgICAgIHJldHVybiByZXNvdXJjZS5mZXRjaEFycmF5QnVmZmVyKCk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5mZXRjaEJsb2IgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5mZXRjaCh7CiAgICAgICAgICByZXNwb25zZVR5cGU6ICJibG9iIgogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5mZXRjaEJsb2IgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgUmVzb3VyY2Uob3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLmZldGNoQmxvYigpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUuZmV0Y2hJbWFnZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgICAgICBjb25zdCBwcmVmZXJJbWFnZUJpdG1hcCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMucHJlZmVySW1hZ2VCaXRtYXAsIGZhbHNlKTsKICAgICAgICBjb25zdCBwcmVmZXJCbG9iID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5wcmVmZXJCbG9iLCBmYWxzZSk7CiAgICAgICAgY29uc3QgZmxpcFkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmZsaXBZLCBmYWxzZSk7CiAgICAgICAgY29uc3Qgc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgICAgICBvcHRpb25zLnNraXBDb2xvclNwYWNlQ29udmVyc2lvbiwKICAgICAgICAgIGZhbHNlCiAgICAgICAgKTsKICAgICAgICBjaGVja0FuZFJlc2V0UmVxdWVzdCh0aGlzLnJlcXVlc3QpOwogICAgICAgIGlmICgheGhyQmxvYlN1cHBvcnRlZCB8fCB0aGlzLmlzRGF0YVVyaSB8fCB0aGlzLmlzQmxvYlVyaSB8fCAhdGhpcy5oYXNIZWFkZXJzICYmICFwcmVmZXJCbG9iKSB7CiAgICAgICAgICByZXR1cm4gZmV0Y2hJbWFnZSh7CiAgICAgICAgICAgIHJlc291cmNlOiB0aGlzLAogICAgICAgICAgICBmbGlwWSwKICAgICAgICAgICAgc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uLAogICAgICAgICAgICBwcmVmZXJJbWFnZUJpdG1hcAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGJsb2JQcm9taXNlID0gdGhpcy5mZXRjaEJsb2IoKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChibG9iUHJvbWlzZSkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgbGV0IHN1cHBvcnRzSW1hZ2VCaXRtYXA7CiAgICAgICAgbGV0IHVzZUltYWdlQml0bWFwOwogICAgICAgIGxldCBnZW5lcmF0ZWRCbG9iUmVzb3VyY2U7CiAgICAgICAgbGV0IGdlbmVyYXRlZEJsb2I7CiAgICAgICAgcmV0dXJuIFJlc291cmNlLnN1cHBvcnRzSW1hZ2VCaXRtYXBPcHRpb25zKCkudGhlbihmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICAgIHN1cHBvcnRzSW1hZ2VCaXRtYXAgPSByZXN1bHQ7CiAgICAgICAgICB1c2VJbWFnZUJpdG1hcCA9IHN1cHBvcnRzSW1hZ2VCaXRtYXAgJiYgcHJlZmVySW1hZ2VCaXRtYXA7CiAgICAgICAgICByZXR1cm4gYmxvYlByb21pc2U7CiAgICAgICAgfSkudGhlbihmdW5jdGlvbihibG9iKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChibG9iKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBnZW5lcmF0ZWRCbG9iID0gYmxvYjsKICAgICAgICAgIGlmICh1c2VJbWFnZUJpdG1hcCkgewogICAgICAgICAgICByZXR1cm4gUmVzb3VyY2UuY3JlYXRlSW1hZ2VCaXRtYXBGcm9tQmxvYihibG9iLCB7CiAgICAgICAgICAgICAgZmxpcFksCiAgICAgICAgICAgICAgcHJlbXVsdGlwbHlBbHBoYTogZmFsc2UsCiAgICAgICAgICAgICAgc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgYmxvYlVybCA9IHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOwogICAgICAgICAgZ2VuZXJhdGVkQmxvYlJlc291cmNlID0gbmV3IFJlc291cmNlKHsKICAgICAgICAgICAgdXJsOiBibG9iVXJsCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBmZXRjaEltYWdlKHsKICAgICAgICAgICAgcmVzb3VyY2U6IGdlbmVyYXRlZEJsb2JSZXNvdXJjZSwKICAgICAgICAgICAgZmxpcFksCiAgICAgICAgICAgIHNraXBDb2xvclNwYWNlQ29udmVyc2lvbiwKICAgICAgICAgICAgcHJlZmVySW1hZ2VCaXRtYXA6IGZhbHNlCiAgICAgICAgICB9KTsKICAgICAgICB9KS50aGVuKGZ1bmN0aW9uKGltYWdlKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbWFnZSkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaW1hZ2UuYmxvYiA9IGdlbmVyYXRlZEJsb2I7CiAgICAgICAgICBpZiAodXNlSW1hZ2VCaXRtYXApIHsKICAgICAgICAgICAgcmV0dXJuIGltYWdlOwogICAgICAgICAgfQogICAgICAgICAgd2luZG93LlVSTC5yZXZva2VPYmplY3RVUkwoZ2VuZXJhdGVkQmxvYlJlc291cmNlLnVybCk7CiAgICAgICAgICByZXR1cm4gaW1hZ2U7CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyb3IpIHsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZ2VuZXJhdGVkQmxvYlJlc291cmNlKSkgewogICAgICAgICAgICB3aW5kb3cuVVJMLnJldm9rZU9iamVjdFVSTChnZW5lcmF0ZWRCbG9iUmVzb3VyY2UudXJsKTsKICAgICAgICAgIH0KICAgICAgICAgIGVycm9yLmJsb2IgPSBnZW5lcmF0ZWRCbG9iOwogICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuZmV0Y2hJbWFnZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBjb25zdCByZXNvdXJjZSA9IG5ldyBSZXNvdXJjZShvcHRpb25zKTsKICAgICAgICByZXR1cm4gcmVzb3VyY2UuZmV0Y2hJbWFnZSh7CiAgICAgICAgICBmbGlwWTogb3B0aW9ucy5mbGlwWSwKICAgICAgICAgIHNraXBDb2xvclNwYWNlQ29udmVyc2lvbjogb3B0aW9ucy5za2lwQ29sb3JTcGFjZUNvbnZlcnNpb24sCiAgICAgICAgICBwcmVmZXJCbG9iOiBvcHRpb25zLnByZWZlckJsb2IsCiAgICAgICAgICBwcmVmZXJJbWFnZUJpdG1hcDogb3B0aW9ucy5wcmVmZXJJbWFnZUJpdG1hcAogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUuZmV0Y2hUZXh0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZmV0Y2goewogICAgICAgICAgcmVzcG9uc2VUeXBlOiAidGV4dCIKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuZmV0Y2hUZXh0ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGNvbnN0IHJlc291cmNlID0gbmV3IFJlc291cmNlKG9wdGlvbnMpOwogICAgICAgIHJldHVybiByZXNvdXJjZS5mZXRjaFRleHQoKTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmZldGNoSnNvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnN0IHByb21pc2UgPSB0aGlzLmZldGNoKHsKICAgICAgICAgIHJlc3BvbnNlVHlwZTogInRleHQiLAogICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICBBY2NlcHQ6ICJhcHBsaWNhdGlvbi9qc29uLCovKjtxPTAuMDEiCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocHJvbWlzZSkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwcm9taXNlLnRoZW4oZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZhbHVlKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZSh2YWx1ZSk7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLmZldGNoSnNvbiA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBjb25zdCByZXNvdXJjZSA9IG5ldyBSZXNvdXJjZShvcHRpb25zKTsKICAgICAgICByZXR1cm4gcmVzb3VyY2UuZmV0Y2hKc29uKCk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5mZXRjaFhNTCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmZldGNoKHsKICAgICAgICAgIHJlc3BvbnNlVHlwZTogImRvY3VtZW50IiwKICAgICAgICAgIG92ZXJyaWRlTWltZVR5cGU6ICJ0ZXh0L3htbCIKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuZmV0Y2hYTUwgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgUmVzb3VyY2Uob3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLmZldGNoWE1MKCk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5mZXRjaEpzb25wID0gZnVuY3Rpb24oY2FsbGJhY2tQYXJhbWV0ZXJOYW1lKSB7CiAgICAgICAgY2FsbGJhY2tQYXJhbWV0ZXJOYW1lID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY2FsbGJhY2tQYXJhbWV0ZXJOYW1lLCAiY2FsbGJhY2siKTsKICAgICAgICBjaGVja0FuZFJlc2V0UmVxdWVzdCh0aGlzLnJlcXVlc3QpOwogICAgICAgIGxldCBmdW5jdGlvbk5hbWU7CiAgICAgICAgZG8gewogICAgICAgICAgZnVuY3Rpb25OYW1lID0gYGxvYWRKc29ucCR7TWF0aF9kZWZhdWx0Lm5leHRSYW5kb21OdW1iZXIoKS50b1N0cmluZygpLnN1YnN0cmluZygyLCA4KX1gOwogICAgICAgIH0gd2hpbGUgKGRlZmluZWRfZGVmYXVsdCh3aW5kb3dbZnVuY3Rpb25OYW1lXSkpOwogICAgICAgIHJldHVybiBmZXRjaEpzb25wKHRoaXMsIGNhbGxiYWNrUGFyYW1ldGVyTmFtZSwgZnVuY3Rpb25OYW1lKTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuZmV0Y2hKc29ucCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBjb25zdCByZXNvdXJjZSA9IG5ldyBSZXNvdXJjZShvcHRpb25zKTsKICAgICAgICByZXR1cm4gcmVzb3VyY2UuZmV0Y2hKc29ucChvcHRpb25zLmNhbGxiYWNrUGFyYW1ldGVyTmFtZSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5fbWFrZVJlcXVlc3QgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSB0aGlzOwogICAgICAgIGNoZWNrQW5kUmVzZXRSZXF1ZXN0KHJlc291cmNlLnJlcXVlc3QpOwogICAgICAgIGNvbnN0IHJlcXVlc3QgPSByZXNvdXJjZS5yZXF1ZXN0OwogICAgICAgIGNvbnN0IHVybCA9IHJlc291cmNlLnVybDsKICAgICAgICByZXF1ZXN0LnVybCA9IHVybDsKICAgICAgICByZXF1ZXN0LnJlcXVlc3RGdW5jdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgY29uc3QgcmVzcG9uc2VUeXBlID0gb3B0aW9ucy5yZXNwb25zZVR5cGU7CiAgICAgICAgICBjb25zdCBoZWFkZXJzID0gY29tYmluZV9kZWZhdWx0KG9wdGlvbnMuaGVhZGVycywgcmVzb3VyY2UuaGVhZGVycyk7CiAgICAgICAgICBjb25zdCBvdmVycmlkZU1pbWVUeXBlID0gb3B0aW9ucy5vdmVycmlkZU1pbWVUeXBlOwogICAgICAgICAgY29uc3QgbWV0aG9kID0gb3B0aW9ucy5tZXRob2Q7CiAgICAgICAgICBjb25zdCBkYXRhID0gb3B0aW9ucy5kYXRhOwogICAgICAgICAgY29uc3QgZGVmZXJyZWQgPSBkZWZlcl9kZWZhdWx0KCk7CiAgICAgICAgICBjb25zdCB4aHIgPSBSZXNvdXJjZS5fSW1wbGVtZW50YXRpb25zLmxvYWRXaXRoWGhyKAogICAgICAgICAgICB1cmwsCiAgICAgICAgICAgIHJlc3BvbnNlVHlwZSwKICAgICAgICAgICAgbWV0aG9kLAogICAgICAgICAgICBkYXRhLAogICAgICAgICAgICBoZWFkZXJzLAogICAgICAgICAgICBkZWZlcnJlZCwKICAgICAgICAgICAgb3ZlcnJpZGVNaW1lVHlwZQogICAgICAgICAgKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoeGhyKSAmJiBkZWZpbmVkX2RlZmF1bHQoeGhyLmFib3J0KSkgewogICAgICAgICAgICByZXF1ZXN0LmNhbmNlbEZ1bmN0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgeGhyLmFib3J0KCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IHByb21pc2UgPSBSZXF1ZXN0U2NoZWR1bGVyX2RlZmF1bHQucmVxdWVzdChyZXF1ZXN0KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwcm9taXNlKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcHJvbWlzZS50aGVuKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgIHJlcXVlc3QuY2FuY2VsRnVuY3Rpb24gPSB2b2lkIDA7CiAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlKSB7CiAgICAgICAgICByZXF1ZXN0LmNhbmNlbEZ1bmN0aW9uID0gdm9pZCAwOwogICAgICAgICAgaWYgKHJlcXVlc3Quc3RhdGUgIT09IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LkZBSUxFRCkgewogICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzb3VyY2UucmV0cnlPbkVycm9yKGUpLnRoZW4oZnVuY3Rpb24ocmV0cnkpIHsKICAgICAgICAgICAgaWYgKHJldHJ5KSB7CiAgICAgICAgICAgICAgcmVxdWVzdC5zdGF0ZSA9IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LlVOSVNTVUVEOwogICAgICAgICAgICAgIHJlcXVlc3QuZGVmZXJyZWQgPSB2b2lkIDA7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc291cmNlLmZldGNoKG9wdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9OwogICAgICBkYXRhVXJpUmVnZXgyID0gL15kYXRhOiguKj8pKDtiYXNlNjQpPywoLiopJC87CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5mZXRjaCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdENsb25lKG9wdGlvbnMsIHt9KTsKICAgICAgICBvcHRpb25zLm1ldGhvZCA9ICJHRVQiOwogICAgICAgIHJldHVybiB0aGlzLl9tYWtlUmVxdWVzdChvcHRpb25zKTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuZmV0Y2ggPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgUmVzb3VyY2Uob3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLmZldGNoKHsKICAgICAgICAgIC8vIE1ha2UgY29weSBvZiBqdXN0IHRoZSBuZWVkZWQgZmllbGRzIGJlY2F1c2UgaGVhZGVycyBjYW4gYmUgcGFzc2VkIHRvIGJvdGggdGhlIGNvbnN0cnVjdG9yIGFuZCB0byBmZXRjaAogICAgICAgICAgcmVzcG9uc2VUeXBlOiBvcHRpb25zLnJlc3BvbnNlVHlwZSwKICAgICAgICAgIG92ZXJyaWRlTWltZVR5cGU6IG9wdGlvbnMub3ZlcnJpZGVNaW1lVHlwZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUuZGVsZXRlID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0Q2xvbmUob3B0aW9ucywge30pOwogICAgICAgIG9wdGlvbnMubWV0aG9kID0gIkRFTEVURSI7CiAgICAgICAgcmV0dXJuIHRoaXMuX21ha2VSZXF1ZXN0KG9wdGlvbnMpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5kZWxldGUgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgUmVzb3VyY2Uob3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLmRlbGV0ZSh7CiAgICAgICAgICAvLyBNYWtlIGNvcHkgb2YganVzdCB0aGUgbmVlZGVkIGZpZWxkcyBiZWNhdXNlIGhlYWRlcnMgY2FuIGJlIHBhc3NlZCB0byBib3RoIHRoZSBjb25zdHJ1Y3RvciBhbmQgdG8gZmV0Y2gKICAgICAgICAgIHJlc3BvbnNlVHlwZTogb3B0aW9ucy5yZXNwb25zZVR5cGUsCiAgICAgICAgICBvdmVycmlkZU1pbWVUeXBlOiBvcHRpb25zLm92ZXJyaWRlTWltZVR5cGUsCiAgICAgICAgICBkYXRhOiBvcHRpb25zLmRhdGEKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmhlYWQgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IGRlZmF1bHRDbG9uZShvcHRpb25zLCB7fSk7CiAgICAgICAgb3B0aW9ucy5tZXRob2QgPSAiSEVBRCI7CiAgICAgICAgcmV0dXJuIHRoaXMuX21ha2VSZXF1ZXN0KG9wdGlvbnMpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5oZWFkID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGNvbnN0IHJlc291cmNlID0gbmV3IFJlc291cmNlKG9wdGlvbnMpOwogICAgICAgIHJldHVybiByZXNvdXJjZS5oZWFkKHsKICAgICAgICAgIC8vIE1ha2UgY29weSBvZiBqdXN0IHRoZSBuZWVkZWQgZmllbGRzIGJlY2F1c2UgaGVhZGVycyBjYW4gYmUgcGFzc2VkIHRvIGJvdGggdGhlIGNvbnN0cnVjdG9yIGFuZCB0byBmZXRjaAogICAgICAgICAgcmVzcG9uc2VUeXBlOiBvcHRpb25zLnJlc3BvbnNlVHlwZSwKICAgICAgICAgIG92ZXJyaWRlTWltZVR5cGU6IG9wdGlvbnMub3ZlcnJpZGVNaW1lVHlwZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUub3B0aW9ucyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdENsb25lKG9wdGlvbnMsIHt9KTsKICAgICAgICBvcHRpb25zLm1ldGhvZCA9ICJPUFRJT05TIjsKICAgICAgICByZXR1cm4gdGhpcy5fbWFrZVJlcXVlc3Qob3B0aW9ucyk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLm9wdGlvbnMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgUmVzb3VyY2Uob3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLm9wdGlvbnMoewogICAgICAgICAgLy8gTWFrZSBjb3B5IG9mIGp1c3QgdGhlIG5lZWRlZCBmaWVsZHMgYmVjYXVzZSBoZWFkZXJzIGNhbiBiZSBwYXNzZWQgdG8gYm90aCB0aGUgY29uc3RydWN0b3IgYW5kIHRvIGZldGNoCiAgICAgICAgICByZXNwb25zZVR5cGU6IG9wdGlvbnMucmVzcG9uc2VUeXBlLAogICAgICAgICAgb3ZlcnJpZGVNaW1lVHlwZTogb3B0aW9ucy5vdmVycmlkZU1pbWVUeXBlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5wb3N0ID0gZnVuY3Rpb24oZGF0YSwgb3B0aW9ucykgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiZGF0YSIsIGRhdGEpOwogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0Q2xvbmUob3B0aW9ucywge30pOwogICAgICAgIG9wdGlvbnMubWV0aG9kID0gIlBPU1QiOwogICAgICAgIG9wdGlvbnMuZGF0YSA9IGRhdGE7CiAgICAgICAgcmV0dXJuIHRoaXMuX21ha2VSZXF1ZXN0KG9wdGlvbnMpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wb3N0ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGNvbnN0IHJlc291cmNlID0gbmV3IFJlc291cmNlKG9wdGlvbnMpOwogICAgICAgIHJldHVybiByZXNvdXJjZS5wb3N0KG9wdGlvbnMuZGF0YSwgewogICAgICAgICAgLy8gTWFrZSBjb3B5IG9mIGp1c3QgdGhlIG5lZWRlZCBmaWVsZHMgYmVjYXVzZSBoZWFkZXJzIGNhbiBiZSBwYXNzZWQgdG8gYm90aCB0aGUgY29uc3RydWN0b3IgYW5kIHRvIHBvc3QKICAgICAgICAgIHJlc3BvbnNlVHlwZTogb3B0aW9ucy5yZXNwb25zZVR5cGUsCiAgICAgICAgICBvdmVycmlkZU1pbWVUeXBlOiBvcHRpb25zLm92ZXJyaWRlTWltZVR5cGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLnB1dCA9IGZ1bmN0aW9uKGRhdGEsIG9wdGlvbnMpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImRhdGEiLCBkYXRhKTsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdENsb25lKG9wdGlvbnMsIHt9KTsKICAgICAgICBvcHRpb25zLm1ldGhvZCA9ICJQVVQiOwogICAgICAgIG9wdGlvbnMuZGF0YSA9IGRhdGE7CiAgICAgICAgcmV0dXJuIHRoaXMuX21ha2VSZXF1ZXN0KG9wdGlvbnMpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wdXQgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgUmVzb3VyY2Uob3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLnB1dChvcHRpb25zLmRhdGEsIHsKICAgICAgICAgIC8vIE1ha2UgY29weSBvZiBqdXN0IHRoZSBuZWVkZWQgZmllbGRzIGJlY2F1c2UgaGVhZGVycyBjYW4gYmUgcGFzc2VkIHRvIGJvdGggdGhlIGNvbnN0cnVjdG9yIGFuZCB0byBwb3N0CiAgICAgICAgICByZXNwb25zZVR5cGU6IG9wdGlvbnMucmVzcG9uc2VUeXBlLAogICAgICAgICAgb3ZlcnJpZGVNaW1lVHlwZTogb3B0aW9ucy5vdmVycmlkZU1pbWVUeXBlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5wYXRjaCA9IGZ1bmN0aW9uKGRhdGEsIG9wdGlvbnMpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImRhdGEiLCBkYXRhKTsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdENsb25lKG9wdGlvbnMsIHt9KTsKICAgICAgICBvcHRpb25zLm1ldGhvZCA9ICJQQVRDSCI7CiAgICAgICAgb3B0aW9ucy5kYXRhID0gZGF0YTsKICAgICAgICByZXR1cm4gdGhpcy5fbWFrZVJlcXVlc3Qob3B0aW9ucyk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnBhdGNoID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGNvbnN0IHJlc291cmNlID0gbmV3IFJlc291cmNlKG9wdGlvbnMpOwogICAgICAgIHJldHVybiByZXNvdXJjZS5wYXRjaChvcHRpb25zLmRhdGEsIHsKICAgICAgICAgIC8vIE1ha2UgY29weSBvZiBqdXN0IHRoZSBuZWVkZWQgZmllbGRzIGJlY2F1c2UgaGVhZGVycyBjYW4gYmUgcGFzc2VkIHRvIGJvdGggdGhlIGNvbnN0cnVjdG9yIGFuZCB0byBwb3N0CiAgICAgICAgICByZXNwb25zZVR5cGU6IG9wdGlvbnMucmVzcG9uc2VUeXBlLAogICAgICAgICAgb3ZlcnJpZGVNaW1lVHlwZTogb3B0aW9ucy5vdmVycmlkZU1pbWVUeXBlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLl9JbXBsZW1lbnRhdGlvbnMgPSB7fTsKICAgICAgUmVzb3VyY2UuX0ltcGxlbWVudGF0aW9ucy5sb2FkSW1hZ2VFbGVtZW50ID0gZnVuY3Rpb24odXJsLCBjcm9zc09yaWdpbiwgZGVmZXJyZWQpIHsKICAgICAgICBjb25zdCBpbWFnZSA9IG5ldyBJbWFnZSgpOwogICAgICAgIGltYWdlLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKGltYWdlLm5hdHVyYWxXaWR0aCA9PT0gMCAmJiBpbWFnZS5uYXR1cmFsSGVpZ2h0ID09PSAwICYmIGltYWdlLndpZHRoID09PSAwICYmIGltYWdlLmhlaWdodCA9PT0gMCkgewogICAgICAgICAgICBpbWFnZS53aWR0aCA9IDMwMDsKICAgICAgICAgICAgaW1hZ2UuaGVpZ2h0ID0gMTUwOwogICAgICAgICAgfQogICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShpbWFnZSk7CiAgICAgICAgfTsKICAgICAgICBpbWFnZS5vbmVycm9yID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgZGVmZXJyZWQucmVqZWN0KGUpOwogICAgICAgIH07CiAgICAgICAgaWYgKGNyb3NzT3JpZ2luKSB7CiAgICAgICAgICBpZiAoVHJ1c3RlZFNlcnZlcnNfZGVmYXVsdC5jb250YWlucyh1cmwpKSB7CiAgICAgICAgICAgIGltYWdlLmNyb3NzT3JpZ2luID0gInVzZS1jcmVkZW50aWFscyI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpbWFnZS5jcm9zc09yaWdpbiA9ICIiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpbWFnZS5zcmMgPSB1cmw7CiAgICAgIH07CiAgICAgIFJlc291cmNlLl9JbXBsZW1lbnRhdGlvbnMuY3JlYXRlSW1hZ2UgPSBmdW5jdGlvbihyZXF1ZXN0LCBjcm9zc09yaWdpbiwgZGVmZXJyZWQsIGZsaXBZLCBza2lwQ29sb3JTcGFjZUNvbnZlcnNpb24sIHByZWZlckltYWdlQml0bWFwKSB7CiAgICAgICAgY29uc3QgdXJsID0gcmVxdWVzdC51cmw7CiAgICAgICAgUmVzb3VyY2Uuc3VwcG9ydHNJbWFnZUJpdG1hcE9wdGlvbnMoKS50aGVuKGZ1bmN0aW9uKHN1cHBvcnRzSW1hZ2VCaXRtYXApIHsKICAgICAgICAgIGlmICghKHN1cHBvcnRzSW1hZ2VCaXRtYXAgJiYgcHJlZmVySW1hZ2VCaXRtYXApKSB7CiAgICAgICAgICAgIFJlc291cmNlLl9JbXBsZW1lbnRhdGlvbnMubG9hZEltYWdlRWxlbWVudCh1cmwsIGNyb3NzT3JpZ2luLCBkZWZlcnJlZCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHJlc3BvbnNlVHlwZSA9ICJibG9iIjsKICAgICAgICAgIGNvbnN0IG1ldGhvZCA9ICJHRVQiOwogICAgICAgICAgY29uc3QgeGhyRGVmZXJyZWQgPSBkZWZlcl9kZWZhdWx0KCk7CiAgICAgICAgICBjb25zdCB4aHIgPSBSZXNvdXJjZS5fSW1wbGVtZW50YXRpb25zLmxvYWRXaXRoWGhyKAogICAgICAgICAgICB1cmwsCiAgICAgICAgICAgIHJlc3BvbnNlVHlwZSwKICAgICAgICAgICAgbWV0aG9kLAogICAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgICAgeGhyRGVmZXJyZWQsCiAgICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgICAgdm9pZCAwLAogICAgICAgICAgICB2b2lkIDAKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHhocikgJiYgZGVmaW5lZF9kZWZhdWx0KHhoci5hYm9ydCkpIHsKICAgICAgICAgICAgcmVxdWVzdC5jYW5jZWxGdW5jdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHhoci5hYm9ydCgpOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHhockRlZmVycmVkLnByb21pc2UudGhlbihmdW5jdGlvbihibG9iKSB7CiAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJsb2IpKSB7CiAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KAogICAgICAgICAgICAgICAgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAgICAgICBgU3VjY2Vzc2Z1bGx5IHJldHJpZXZlZCAke3VybH0gYnV0IGl0IGNvbnRhaW5lZCBubyBjb250ZW50LmAKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gUmVzb3VyY2UuY3JlYXRlSW1hZ2VCaXRtYXBGcm9tQmxvYihibG9iLCB7CiAgICAgICAgICAgICAgZmxpcFksCiAgICAgICAgICAgICAgcHJlbXVsdGlwbHlBbHBoYTogZmFsc2UsCiAgICAgICAgICAgICAgc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSkudGhlbihmdW5jdGlvbihpbWFnZSkgewogICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGltYWdlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuY3JlYXRlSW1hZ2VCaXRtYXBGcm9tQmxvYiA9IGZ1bmN0aW9uKGJsb2IsIG9wdGlvbnMpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9wdGlvbnMiLCBvcHRpb25zKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5ib29sKCJvcHRpb25zLmZsaXBZIiwgb3B0aW9ucy5mbGlwWSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YuYm9vbCgib3B0aW9ucy5wcmVtdWx0aXBseUFscGhhIiwgb3B0aW9ucy5wcmVtdWx0aXBseUFscGhhKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5ib29sKAogICAgICAgICAgIm9wdGlvbnMuc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uIiwKICAgICAgICAgIG9wdGlvbnMuc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gY3JlYXRlSW1hZ2VCaXRtYXAoYmxvYiwgewogICAgICAgICAgaW1hZ2VPcmllbnRhdGlvbjogb3B0aW9ucy5mbGlwWSA/ICJmbGlwWSIgOiAibm9uZSIsCiAgICAgICAgICBwcmVtdWx0aXBseUFscGhhOiBvcHRpb25zLnByZW11bHRpcGx5QWxwaGEgPyAicHJlbXVsdGlwbHkiIDogIm5vbmUiLAogICAgICAgICAgY29sb3JTcGFjZUNvbnZlcnNpb246IG9wdGlvbnMuc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uID8gIm5vbmUiIDogImRlZmF1bHQiCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIG5vWE1MSHR0cFJlcXVlc3QgPSB0eXBlb2YgWE1MSHR0cFJlcXVlc3QgPT09ICJ1bmRlZmluZWQiOwogICAgICBSZXNvdXJjZS5fSW1wbGVtZW50YXRpb25zLmxvYWRXaXRoWGhyID0gZnVuY3Rpb24odXJsLCByZXNwb25zZVR5cGUsIG1ldGhvZCwgZGF0YSwgaGVhZGVycywgZGVmZXJyZWQsIG92ZXJyaWRlTWltZVR5cGUpIHsKICAgICAgICBjb25zdCBkYXRhVXJpUmVnZXhSZXN1bHQgPSBkYXRhVXJpUmVnZXgyLmV4ZWModXJsKTsKICAgICAgICBpZiAoZGF0YVVyaVJlZ2V4UmVzdWx0ICE9PSBudWxsKSB7CiAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGRlY29kZURhdGFVcmkoZGF0YVVyaVJlZ2V4UmVzdWx0LCByZXNwb25zZVR5cGUpKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKG5vWE1MSHR0cFJlcXVlc3QpIHsKICAgICAgICAgIGxvYWRXaXRoSHR0cFJlcXVlc3QoCiAgICAgICAgICAgIHVybCwKICAgICAgICAgICAgcmVzcG9uc2VUeXBlLAogICAgICAgICAgICBtZXRob2QsCiAgICAgICAgICAgIGRhdGEsCiAgICAgICAgICAgIGhlYWRlcnMsCiAgICAgICAgICAgIGRlZmVycmVkLAogICAgICAgICAgICBvdmVycmlkZU1pbWVUeXBlCiAgICAgICAgICApOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgICAgICBpZiAoVHJ1c3RlZFNlcnZlcnNfZGVmYXVsdC5jb250YWlucyh1cmwpKSB7CiAgICAgICAgICB4aHIud2l0aENyZWRlbnRpYWxzID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgeGhyLm9wZW4obWV0aG9kLCB1cmwsIHRydWUpOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3ZlcnJpZGVNaW1lVHlwZSkgJiYgZGVmaW5lZF9kZWZhdWx0KHhoci5vdmVycmlkZU1pbWVUeXBlKSkgewogICAgICAgICAgeGhyLm92ZXJyaWRlTWltZVR5cGUob3ZlcnJpZGVNaW1lVHlwZSk7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaGVhZGVycykpIHsKICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIGhlYWRlcnMpIHsKICAgICAgICAgICAgaWYgKGhlYWRlcnMuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGtleSwgaGVhZGVyc1trZXldKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlc3BvbnNlVHlwZSkpIHsKICAgICAgICAgIHhoci5yZXNwb25zZVR5cGUgPSByZXNwb25zZVR5cGU7CiAgICAgICAgfQogICAgICAgIGxldCBsb2NhbEZpbGUgPSBmYWxzZTsKICAgICAgICBpZiAodHlwZW9mIHVybCA9PT0gInN0cmluZyIpIHsKICAgICAgICAgIGxvY2FsRmlsZSA9IHVybC5pbmRleE9mKCJmaWxlOi8vIikgPT09IDAgfHwgdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93LmxvY2F0aW9uLm9yaWdpbiA9PT0gImZpbGU6Ly8iOwogICAgICAgIH0KICAgICAgICB4aHIub25sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoKHhoci5zdGF0dXMgPCAyMDAgfHwgeGhyLnN0YXR1cyA+PSAzMDApICYmICEobG9jYWxGaWxlICYmIHhoci5zdGF0dXMgPT09IDApKSB7CiAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdCgKICAgICAgICAgICAgICBuZXcgUmVxdWVzdEVycm9yRXZlbnRfZGVmYXVsdCgKICAgICAgICAgICAgICAgIHhoci5zdGF0dXMsCiAgICAgICAgICAgICAgICB4aHIucmVzcG9uc2UsCiAgICAgICAgICAgICAgICB4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCkKICAgICAgICAgICAgICApCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0geGhyLnJlc3BvbnNlOwogICAgICAgICAgY29uc3QgYnJvd3NlclJlc3BvbnNlVHlwZSA9IHhoci5yZXNwb25zZVR5cGU7CiAgICAgICAgICBpZiAobWV0aG9kID09PSAiSEVBRCIgfHwgbWV0aG9kID09PSAiT1BUSU9OUyIpIHsKICAgICAgICAgICAgY29uc3QgcmVzcG9uc2VIZWFkZXJTdHJpbmcgPSB4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7CiAgICAgICAgICAgIGNvbnN0IHNwbGl0SGVhZGVycyA9IHJlc3BvbnNlSGVhZGVyU3RyaW5nLnRyaW0oKS5zcGxpdCgvW1xyXG5dKy8pOwogICAgICAgICAgICBjb25zdCByZXNwb25zZUhlYWRlcnMgPSB7fTsKICAgICAgICAgICAgc3BsaXRIZWFkZXJzLmZvckVhY2goZnVuY3Rpb24obGluZSkgewogICAgICAgICAgICAgIGNvbnN0IHBhcnRzID0gbGluZS5zcGxpdCgiOiAiKTsKICAgICAgICAgICAgICBjb25zdCBoZWFkZXIgPSBwYXJ0cy5zaGlmdCgpOwogICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVyc1toZWFkZXJdID0gcGFydHMuam9pbigiOiAiKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUocmVzcG9uc2VIZWFkZXJzKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHhoci5zdGF0dXMgPT09IDIwNCkgewogICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHZvaWQgMCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGRlZmluZWRfZGVmYXVsdChyZXNwb25zZSkgJiYgKCFkZWZpbmVkX2RlZmF1bHQocmVzcG9uc2VUeXBlKSB8fCBicm93c2VyUmVzcG9uc2VUeXBlID09PSByZXNwb25zZVR5cGUpKSB7CiAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUocmVzcG9uc2UpOwogICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZVR5cGUgPT09ICJqc29uIiAmJiB0eXBlb2YgcmVzcG9uc2UgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShKU09OLnBhcnNlKHJlc3BvbnNlKSk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoKGJyb3dzZXJSZXNwb25zZVR5cGUgPT09ICIiIHx8IGJyb3dzZXJSZXNwb25zZVR5cGUgPT09ICJkb2N1bWVudCIpICYmIGRlZmluZWRfZGVmYXVsdCh4aHIucmVzcG9uc2VYTUwpICYmIHhoci5yZXNwb25zZVhNTC5oYXNDaGlsZE5vZGVzKCkpIHsKICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSh4aHIucmVzcG9uc2VYTUwpOwogICAgICAgICAgfSBlbHNlIGlmICgoYnJvd3NlclJlc3BvbnNlVHlwZSA9PT0gIiIgfHwgYnJvd3NlclJlc3BvbnNlVHlwZSA9PT0gInRleHQiKSAmJiBkZWZpbmVkX2RlZmF1bHQoeGhyLnJlc3BvbnNlVGV4dCkpIHsKICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSh4aHIucmVzcG9uc2VUZXh0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdCgKICAgICAgICAgICAgICBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIkludmFsaWQgWE1MSHR0cFJlcXVlc3QgcmVzcG9uc2UgdHlwZS4iKQogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgeGhyLm9uZXJyb3IgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICBkZWZlcnJlZC5yZWplY3QobmV3IFJlcXVlc3RFcnJvckV2ZW50X2RlZmF1bHQoKSk7CiAgICAgICAgfTsKICAgICAgICB4aHIuc2VuZChkYXRhKTsKICAgICAgICByZXR1cm4geGhyOwogICAgICB9OwogICAgICBSZXNvdXJjZS5fSW1wbGVtZW50YXRpb25zLmxvYWRBbmRFeGVjdXRlU2NyaXB0ID0gZnVuY3Rpb24odXJsLCBmdW5jdGlvbk5hbWUsIGRlZmVycmVkKSB7CiAgICAgICAgcmV0dXJuIGxvYWRBbmRFeGVjdXRlU2NyaXB0X2RlZmF1bHQodXJsLCBmdW5jdGlvbk5hbWUpLmNhdGNoKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuX0RlZmF1bHRJbXBsZW1lbnRhdGlvbnMgPSB7fTsKICAgICAgUmVzb3VyY2UuX0RlZmF1bHRJbXBsZW1lbnRhdGlvbnMuY3JlYXRlSW1hZ2UgPSBSZXNvdXJjZS5fSW1wbGVtZW50YXRpb25zLmNyZWF0ZUltYWdlOwogICAgICBSZXNvdXJjZS5fRGVmYXVsdEltcGxlbWVudGF0aW9ucy5sb2FkV2l0aFhociA9IFJlc291cmNlLl9JbXBsZW1lbnRhdGlvbnMubG9hZFdpdGhYaHI7CiAgICAgIFJlc291cmNlLl9EZWZhdWx0SW1wbGVtZW50YXRpb25zLmxvYWRBbmRFeGVjdXRlU2NyaXB0ID0gUmVzb3VyY2UuX0ltcGxlbWVudGF0aW9ucy5sb2FkQW5kRXhlY3V0ZVNjcmlwdDsKICAgICAgUmVzb3VyY2UuREVGQVVMVCA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IFJlc291cmNlKHsKICAgICAgICAgIHVybDogdHlwZW9mIGRvY3VtZW50ID09PSAidW5kZWZpbmVkIiA/ICIiIDogZG9jdW1lbnQubG9jYXRpb24uaHJlZi5zcGxpdCgiPyIpWzBdCiAgICAgICAgfSkKICAgICAgKTsKICAgICAgUmVzb3VyY2VfZGVmYXVsdCA9IFJlc291cmNlOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnMuanMKICBmdW5jdGlvbiBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVycyhvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIHRoaXMuX2RhdGVzID0gdm9pZCAwOwogICAgdGhpcy5fc2FtcGxlcyA9IHZvaWQgMDsKICAgIHRoaXMuX2RhdGVDb2x1bW4gPSAtMTsKICAgIHRoaXMuX3hQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbiA9IC0xOwogICAgdGhpcy5feVBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uID0gLTE7CiAgICB0aGlzLl91dDFNaW51c1V0Y1NlY29uZHNDb2x1bW4gPSAtMTsKICAgIHRoaXMuX3hDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbiA9IC0xOwogICAgdGhpcy5feUNlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uID0gLTE7CiAgICB0aGlzLl90YWlNaW51c1V0Y1NlY29uZHNDb2x1bW4gPSAtMTsKICAgIHRoaXMuX2NvbHVtbkNvdW50ID0gMDsKICAgIHRoaXMuX2xhc3RJbmRleCA9IC0xOwogICAgdGhpcy5fYWRkTmV3TGVhcFNlY29uZHMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmFkZE5ld0xlYXBTZWNvbmRzLCB0cnVlKTsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5kYXRhKSkgewogICAgICBvbkRhdGFSZWFkeSh0aGlzLCBvcHRpb25zLmRhdGEpOwogICAgfSBlbHNlIHsKICAgICAgb25EYXRhUmVhZHkodGhpcywgewogICAgICAgIGNvbHVtbk5hbWVzOiBbCiAgICAgICAgICAiZGF0ZUlzbzg2MDEiLAogICAgICAgICAgIm1vZGlmaWVkSnVsaWFuRGF0ZVV0YyIsCiAgICAgICAgICAieFBvbGVXYW5kZXJSYWRpYW5zIiwKICAgICAgICAgICJ5UG9sZVdhbmRlclJhZGlhbnMiLAogICAgICAgICAgInV0MU1pbnVzVXRjU2Vjb25kcyIsCiAgICAgICAgICAibGVuZ3RoT2ZEYXlDb3JyZWN0aW9uU2Vjb25kcyIsCiAgICAgICAgICAieENlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zIiwKICAgICAgICAgICJ5Q2VsZXN0aWFsUG9sZU9mZnNldFJhZGlhbnMiLAogICAgICAgICAgInRhaU1pbnVzVXRjU2Vjb25kcyIKICAgICAgICBdLAogICAgICAgIHNhbXBsZXM6IFtdCiAgICAgIH0pOwogICAgfQogIH0KICBmdW5jdGlvbiBjb21wYXJlTGVhcFNlY29uZERhdGVzMihsZWFwU2Vjb25kLCBkYXRlVG9GaW5kKSB7CiAgICByZXR1cm4gSnVsaWFuRGF0ZV9kZWZhdWx0LmNvbXBhcmUobGVhcFNlY29uZC5qdWxpYW5EYXRlLCBkYXRlVG9GaW5kKTsKICB9CiAgZnVuY3Rpb24gb25EYXRhUmVhZHkoZW9wLCBlb3BEYXRhKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChlb3BEYXRhLmNvbHVtbk5hbWVzKSkgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoCiAgICAgICAgIkVycm9yIGluIGxvYWRlZCBFT1AgZGF0YTogVGhlIGNvbHVtbk5hbWVzIHByb3BlcnR5IGlzIHJlcXVpcmVkLiIKICAgICAgKTsKICAgIH0KICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGVvcERhdGEuc2FtcGxlcykpIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KAogICAgICAgICJFcnJvciBpbiBsb2FkZWQgRU9QIGRhdGE6IFRoZSBzYW1wbGVzIHByb3BlcnR5IGlzIHJlcXVpcmVkLiIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGRhdGVDb2x1bW4gPSBlb3BEYXRhLmNvbHVtbk5hbWVzLmluZGV4T2YoIm1vZGlmaWVkSnVsaWFuRGF0ZVV0YyIpOwogICAgY29uc3QgeFBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uID0gZW9wRGF0YS5jb2x1bW5OYW1lcy5pbmRleE9mKAogICAgICAieFBvbGVXYW5kZXJSYWRpYW5zIgogICAgKTsKICAgIGNvbnN0IHlQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbiA9IGVvcERhdGEuY29sdW1uTmFtZXMuaW5kZXhPZigKICAgICAgInlQb2xlV2FuZGVyUmFkaWFucyIKICAgICk7CiAgICBjb25zdCB1dDFNaW51c1V0Y1NlY29uZHNDb2x1bW4gPSBlb3BEYXRhLmNvbHVtbk5hbWVzLmluZGV4T2YoCiAgICAgICJ1dDFNaW51c1V0Y1NlY29uZHMiCiAgICApOwogICAgY29uc3QgeENlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uID0gZW9wRGF0YS5jb2x1bW5OYW1lcy5pbmRleE9mKAogICAgICAieENlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zIgogICAgKTsKICAgIGNvbnN0IHlDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbiA9IGVvcERhdGEuY29sdW1uTmFtZXMuaW5kZXhPZigKICAgICAgInlDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFucyIKICAgICk7CiAgICBjb25zdCB0YWlNaW51c1V0Y1NlY29uZHNDb2x1bW4gPSBlb3BEYXRhLmNvbHVtbk5hbWVzLmluZGV4T2YoCiAgICAgICJ0YWlNaW51c1V0Y1NlY29uZHMiCiAgICApOwogICAgaWYgKGRhdGVDb2x1bW4gPCAwIHx8IHhQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbiA8IDAgfHwgeVBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uIDwgMCB8fCB1dDFNaW51c1V0Y1NlY29uZHNDb2x1bW4gPCAwIHx8IHhDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbiA8IDAgfHwgeUNlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uIDwgMCB8fCB0YWlNaW51c1V0Y1NlY29uZHNDb2x1bW4gPCAwKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgKICAgICAgICAiRXJyb3IgaW4gbG9hZGVkIEVPUCBkYXRhOiBUaGUgY29sdW1uTmFtZXMgcHJvcGVydHkgbXVzdCBpbmNsdWRlIG1vZGlmaWVkSnVsaWFuRGF0ZVV0YywgeFBvbGVXYW5kZXJSYWRpYW5zLCB5UG9sZVdhbmRlclJhZGlhbnMsIHV0MU1pbnVzVXRjU2Vjb25kcywgeENlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zLCB5Q2VsZXN0aWFsUG9sZU9mZnNldFJhZGlhbnMsIGFuZCB0YWlNaW51c1V0Y1NlY29uZHMgY29sdW1ucyIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IHNhbXBsZXMgPSBlb3AuX3NhbXBsZXMgPSBlb3BEYXRhLnNhbXBsZXM7CiAgICBjb25zdCBkYXRlcyA9IGVvcC5fZGF0ZXMgPSBbXTsKICAgIGVvcC5fZGF0ZUNvbHVtbiA9IGRhdGVDb2x1bW47CiAgICBlb3AuX3hQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbiA9IHhQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbjsKICAgIGVvcC5feVBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uID0geVBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uOwogICAgZW9wLl91dDFNaW51c1V0Y1NlY29uZHNDb2x1bW4gPSB1dDFNaW51c1V0Y1NlY29uZHNDb2x1bW47CiAgICBlb3AuX3hDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbiA9IHhDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbjsKICAgIGVvcC5feUNlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uID0geUNlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uOwogICAgZW9wLl90YWlNaW51c1V0Y1NlY29uZHNDb2x1bW4gPSB0YWlNaW51c1V0Y1NlY29uZHNDb2x1bW47CiAgICBlb3AuX2NvbHVtbkNvdW50ID0gZW9wRGF0YS5jb2x1bW5OYW1lcy5sZW5ndGg7CiAgICBlb3AuX2xhc3RJbmRleCA9IHZvaWQgMDsKICAgIGxldCBsYXN0VGFpTWludXNVdGM7CiAgICBjb25zdCBhZGROZXdMZWFwU2Vjb25kcyA9IGVvcC5fYWRkTmV3TGVhcFNlY29uZHM7CiAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gc2FtcGxlcy5sZW5ndGg7IGkgPCBsZW47IGkgKz0gZW9wLl9jb2x1bW5Db3VudCkgewogICAgICBjb25zdCBtamQgPSBzYW1wbGVzW2kgKyBkYXRlQ29sdW1uXTsKICAgICAgY29uc3QgdGFpTWludXNVdGMgPSBzYW1wbGVzW2kgKyB0YWlNaW51c1V0Y1NlY29uZHNDb2x1bW5dOwogICAgICBjb25zdCBkYXkgPSBtamQgKyBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuTU9ESUZJRURfSlVMSUFOX0RBVEVfRElGRkVSRU5DRTsKICAgICAgY29uc3QgZGF0ZSA9IG5ldyBKdWxpYW5EYXRlX2RlZmF1bHQoZGF5LCB0YWlNaW51c1V0YywgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKTsKICAgICAgZGF0ZXMucHVzaChkYXRlKTsKICAgICAgaWYgKGFkZE5ld0xlYXBTZWNvbmRzKSB7CiAgICAgICAgaWYgKHRhaU1pbnVzVXRjICE9PSBsYXN0VGFpTWludXNVdGMgJiYgZGVmaW5lZF9kZWZhdWx0KGxhc3RUYWlNaW51c1V0YykpIHsKICAgICAgICAgIGNvbnN0IGxlYXBTZWNvbmRzID0gSnVsaWFuRGF0ZV9kZWZhdWx0LmxlYXBTZWNvbmRzOwogICAgICAgICAgY29uc3QgbGVhcFNlY29uZEluZGV4ID0gYmluYXJ5U2VhcmNoX2RlZmF1bHQoCiAgICAgICAgICAgIGxlYXBTZWNvbmRzLAogICAgICAgICAgICBkYXRlLAogICAgICAgICAgICBjb21wYXJlTGVhcFNlY29uZERhdGVzMgogICAgICAgICAgKTsKICAgICAgICAgIGlmIChsZWFwU2Vjb25kSW5kZXggPCAwKSB7CiAgICAgICAgICAgIGNvbnN0IGxlYXBTZWNvbmQgPSBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KGRhdGUsIHRhaU1pbnVzVXRjKTsKICAgICAgICAgICAgbGVhcFNlY29uZHMuc3BsaWNlKH5sZWFwU2Vjb25kSW5kZXgsIDAsIGxlYXBTZWNvbmQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBsYXN0VGFpTWludXNVdGMgPSB0YWlNaW51c1V0YzsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBmaWxsUmVzdWx0RnJvbUluZGV4KGVvcCwgc2FtcGxlcywgaW5kZXgsIGNvbHVtbkNvdW50LCByZXN1bHQpIHsKICAgIGNvbnN0IHN0YXJ0ID0gaW5kZXggKiBjb2x1bW5Db3VudDsKICAgIHJlc3VsdC54UG9sZVdhbmRlciA9IHNhbXBsZXNbc3RhcnQgKyBlb3AuX3hQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbl07CiAgICByZXN1bHQueVBvbGVXYW5kZXIgPSBzYW1wbGVzW3N0YXJ0ICsgZW9wLl95UG9sZVdhbmRlclJhZGlhbnNDb2x1bW5dOwogICAgcmVzdWx0LnhQb2xlT2Zmc2V0ID0gc2FtcGxlc1tzdGFydCArIGVvcC5feENlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uXTsKICAgIHJlc3VsdC55UG9sZU9mZnNldCA9IHNhbXBsZXNbc3RhcnQgKyBlb3AuX3lDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbl07CiAgICByZXN1bHQudXQxTWludXNVdGMgPSBzYW1wbGVzW3N0YXJ0ICsgZW9wLl91dDFNaW51c1V0Y1NlY29uZHNDb2x1bW5dOwogIH0KICBmdW5jdGlvbiBsaW5lYXJJbnRlcnAoZHgsIHkxLCB5MikgewogICAgcmV0dXJuIHkxICsgZHggKiAoeTIgLSB5MSk7CiAgfQogIGZ1bmN0aW9uIGludGVycG9sYXRlKGVvcCwgZGF0ZXMsIHNhbXBsZXMsIGRhdGUsIGJlZm9yZSwgYWZ0ZXIsIHJlc3VsdCkgewogICAgY29uc3QgY29sdW1uQ291bnQgPSBlb3AuX2NvbHVtbkNvdW50OwogICAgaWYgKGFmdGVyID4gZGF0ZXMubGVuZ3RoIC0gMSkgewogICAgICByZXN1bHQueFBvbGVXYW5kZXIgPSAwOwogICAgICByZXN1bHQueVBvbGVXYW5kZXIgPSAwOwogICAgICByZXN1bHQueFBvbGVPZmZzZXQgPSAwOwogICAgICByZXN1bHQueVBvbGVPZmZzZXQgPSAwOwogICAgICByZXN1bHQudXQxTWludXNVdGMgPSAwOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgY29uc3QgYmVmb3JlRGF0ZSA9IGRhdGVzW2JlZm9yZV07CiAgICBjb25zdCBhZnRlckRhdGUgPSBkYXRlc1thZnRlcl07CiAgICBpZiAoYmVmb3JlRGF0ZS5lcXVhbHMoYWZ0ZXJEYXRlKSB8fCBkYXRlLmVxdWFscyhiZWZvcmVEYXRlKSkgewogICAgICBmaWxsUmVzdWx0RnJvbUluZGV4KGVvcCwgc2FtcGxlcywgYmVmb3JlLCBjb2x1bW5Db3VudCwgcmVzdWx0KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0gZWxzZSBpZiAoZGF0ZS5lcXVhbHMoYWZ0ZXJEYXRlKSkgewogICAgICBmaWxsUmVzdWx0RnJvbUluZGV4KGVvcCwgc2FtcGxlcywgYWZ0ZXIsIGNvbHVtbkNvdW50LCByZXN1bHQpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgY29uc3QgZmFjdG9yID0gSnVsaWFuRGF0ZV9kZWZhdWx0LnNlY29uZHNEaWZmZXJlbmNlKGRhdGUsIGJlZm9yZURhdGUpIC8gSnVsaWFuRGF0ZV9kZWZhdWx0LnNlY29uZHNEaWZmZXJlbmNlKGFmdGVyRGF0ZSwgYmVmb3JlRGF0ZSk7CiAgICBjb25zdCBzdGFydEJlZm9yZSA9IGJlZm9yZSAqIGNvbHVtbkNvdW50OwogICAgY29uc3Qgc3RhcnRBZnRlciA9IGFmdGVyICogY29sdW1uQ291bnQ7CiAgICBsZXQgYmVmb3JlVXQxTWludXNVdGMgPSBzYW1wbGVzW3N0YXJ0QmVmb3JlICsgZW9wLl91dDFNaW51c1V0Y1NlY29uZHNDb2x1bW5dOwogICAgbGV0IGFmdGVyVXQxTWludXNVdGMgPSBzYW1wbGVzW3N0YXJ0QWZ0ZXIgKyBlb3AuX3V0MU1pbnVzVXRjU2Vjb25kc0NvbHVtbl07CiAgICBjb25zdCBvZmZzZXREaWZmZXJlbmNlID0gYWZ0ZXJVdDFNaW51c1V0YyAtIGJlZm9yZVV0MU1pbnVzVXRjOwogICAgaWYgKG9mZnNldERpZmZlcmVuY2UgPiAwLjUgfHwgb2Zmc2V0RGlmZmVyZW5jZSA8IC0wLjUpIHsKICAgICAgY29uc3QgYmVmb3JlVGFpTWludXNVdGMgPSBzYW1wbGVzW3N0YXJ0QmVmb3JlICsgZW9wLl90YWlNaW51c1V0Y1NlY29uZHNDb2x1bW5dOwogICAgICBjb25zdCBhZnRlclRhaU1pbnVzVXRjID0gc2FtcGxlc1tzdGFydEFmdGVyICsgZW9wLl90YWlNaW51c1V0Y1NlY29uZHNDb2x1bW5dOwogICAgICBpZiAoYmVmb3JlVGFpTWludXNVdGMgIT09IGFmdGVyVGFpTWludXNVdGMpIHsKICAgICAgICBpZiAoYWZ0ZXJEYXRlLmVxdWFscyhkYXRlKSkgewogICAgICAgICAgYmVmb3JlVXQxTWludXNVdGMgPSBhZnRlclV0MU1pbnVzVXRjOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhZnRlclV0MU1pbnVzVXRjIC09IGFmdGVyVGFpTWludXNVdGMgLSBiZWZvcmVUYWlNaW51c1V0YzsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJlc3VsdC54UG9sZVdhbmRlciA9IGxpbmVhckludGVycCgKICAgICAgZmFjdG9yLAogICAgICBzYW1wbGVzW3N0YXJ0QmVmb3JlICsgZW9wLl94UG9sZVdhbmRlclJhZGlhbnNDb2x1bW5dLAogICAgICBzYW1wbGVzW3N0YXJ0QWZ0ZXIgKyBlb3AuX3hQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbl0KICAgICk7CiAgICByZXN1bHQueVBvbGVXYW5kZXIgPSBsaW5lYXJJbnRlcnAoCiAgICAgIGZhY3RvciwKICAgICAgc2FtcGxlc1tzdGFydEJlZm9yZSArIGVvcC5feVBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uXSwKICAgICAgc2FtcGxlc1tzdGFydEFmdGVyICsgZW9wLl95UG9sZVdhbmRlclJhZGlhbnNDb2x1bW5dCiAgICApOwogICAgcmVzdWx0LnhQb2xlT2Zmc2V0ID0gbGluZWFySW50ZXJwKAogICAgICBmYWN0b3IsCiAgICAgIHNhbXBsZXNbc3RhcnRCZWZvcmUgKyBlb3AuX3hDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbl0sCiAgICAgIHNhbXBsZXNbc3RhcnRBZnRlciArIGVvcC5feENlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uXQogICAgKTsKICAgIHJlc3VsdC55UG9sZU9mZnNldCA9IGxpbmVhckludGVycCgKICAgICAgZmFjdG9yLAogICAgICBzYW1wbGVzW3N0YXJ0QmVmb3JlICsgZW9wLl95Q2VsZXN0aWFsUG9sZU9mZnNldFJhZGlhbnNDb2x1bW5dLAogICAgICBzYW1wbGVzW3N0YXJ0QWZ0ZXIgKyBlb3AuX3lDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbl0KICAgICk7CiAgICByZXN1bHQudXQxTWludXNVdGMgPSBsaW5lYXJJbnRlcnAoCiAgICAgIGZhY3RvciwKICAgICAgYmVmb3JlVXQxTWludXNVdGMsCiAgICAgIGFmdGVyVXQxTWludXNVdGMKICAgICk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICB2YXIgRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnNfZGVmYXVsdDsKICB2YXIgaW5pdF9FYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVycyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnMuanMiKCkgewogICAgICBpbml0X2JpbmFyeVNlYXJjaCgpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzU2FtcGxlKCk7CiAgICAgIGluaXRfSnVsaWFuRGF0ZSgpOwogICAgICBpbml0X0xlYXBTZWNvbmQoKTsKICAgICAgaW5pdF9SZXNvdXJjZSgpOwogICAgICBpbml0X1J1bnRpbWVFcnJvcigpOwogICAgICBpbml0X1RpbWVDb25zdGFudHMoKTsKICAgICAgaW5pdF9UaW1lU3RhbmRhcmQoKTsKICAgICAgRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnMuZnJvbVVybCA9IGFzeW5jIGZ1bmN0aW9uKHVybCwgb3B0aW9ucykgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidXJsIiwgdXJsKTsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgICAgICBjb25zdCByZXNvdXJjZSA9IFJlc291cmNlX2RlZmF1bHQuY3JlYXRlSWZOZWVkZWQodXJsKTsKICAgICAgICBsZXQgZW9wRGF0YTsKICAgICAgICB0cnkgewogICAgICAgICAgZW9wRGF0YSA9IGF3YWl0IHJlc291cmNlLmZldGNoSnNvbigpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgYEFuIGVycm9yIG9jY3VycmVkIHdoaWxlIHJldHJpZXZpbmcgdGhlIEVPUCBkYXRhIGZyb20gdGhlIFVSTCAke3Jlc291cmNlLnVybH0uYAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVycyh7CiAgICAgICAgICBhZGROZXdMZWFwU2Vjb25kczogb3B0aW9ucy5hZGROZXdMZWFwU2Vjb25kcywKICAgICAgICAgIGRhdGE6IGVvcERhdGEKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnMuTk9ORSA9IE9iamVjdC5mcmVlemUoewogICAgICAgIGNvbXB1dGU6IGZ1bmN0aW9uKGRhdGUsIHJlc3VsdCkgewogICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgICByZXN1bHQgPSBuZXcgRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnNTYW1wbGVfZGVmYXVsdCgwLCAwLCAwLCAwLCAwKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3VsdC54UG9sZVdhbmRlciA9IDA7CiAgICAgICAgICAgIHJlc3VsdC55UG9sZVdhbmRlciA9IDA7CiAgICAgICAgICAgIHJlc3VsdC54UG9sZU9mZnNldCA9IDA7CiAgICAgICAgICAgIHJlc3VsdC55UG9sZU9mZnNldCA9IDA7CiAgICAgICAgICAgIHJlc3VsdC51dDFNaW51c1V0YyA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIEVhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzLnByb3RvdHlwZS5jb21wdXRlID0gZnVuY3Rpb24oZGF0ZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhpcy5fc2FtcGxlcykpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVyc1NhbXBsZV9kZWZhdWx0KDAsIDAsIDAsIDAsIDApOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5fc2FtcGxlcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHJlc3VsdC54UG9sZVdhbmRlciA9IDA7CiAgICAgICAgICByZXN1bHQueVBvbGVXYW5kZXIgPSAwOwogICAgICAgICAgcmVzdWx0LnhQb2xlT2Zmc2V0ID0gMDsKICAgICAgICAgIHJlc3VsdC55UG9sZU9mZnNldCA9IDA7CiAgICAgICAgICByZXN1bHQudXQxTWludXNVdGMgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGF0ZXMgPSB0aGlzLl9kYXRlczsKICAgICAgICBjb25zdCBsYXN0SW5kZXggPSB0aGlzLl9sYXN0SW5kZXg7CiAgICAgICAgbGV0IGJlZm9yZSA9IDA7CiAgICAgICAgbGV0IGFmdGVyID0gMDsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGxhc3RJbmRleCkpIHsKICAgICAgICAgIGNvbnN0IHByZXZpb3VzSW5kZXhEYXRlID0gZGF0ZXNbbGFzdEluZGV4XTsKICAgICAgICAgIGNvbnN0IG5leHRJbmRleERhdGUgPSBkYXRlc1tsYXN0SW5kZXggKyAxXTsKICAgICAgICAgIGNvbnN0IGlzQWZ0ZXJQcmV2aW91cyA9IEp1bGlhbkRhdGVfZGVmYXVsdC5sZXNzVGhhbk9yRXF1YWxzKAogICAgICAgICAgICBwcmV2aW91c0luZGV4RGF0ZSwKICAgICAgICAgICAgZGF0ZQogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IGlzQWZ0ZXJMYXN0U2FtcGxlID0gIWRlZmluZWRfZGVmYXVsdChuZXh0SW5kZXhEYXRlKTsKICAgICAgICAgIGNvbnN0IGlzQmVmb3JlTmV4dCA9IGlzQWZ0ZXJMYXN0U2FtcGxlIHx8IEp1bGlhbkRhdGVfZGVmYXVsdC5ncmVhdGVyVGhhbk9yRXF1YWxzKG5leHRJbmRleERhdGUsIGRhdGUpOwogICAgICAgICAgaWYgKGlzQWZ0ZXJQcmV2aW91cyAmJiBpc0JlZm9yZU5leHQpIHsKICAgICAgICAgICAgYmVmb3JlID0gbGFzdEluZGV4OwogICAgICAgICAgICBpZiAoIWlzQWZ0ZXJMYXN0U2FtcGxlICYmIG5leHRJbmRleERhdGUuZXF1YWxzKGRhdGUpKSB7CiAgICAgICAgICAgICAgKytiZWZvcmU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYWZ0ZXIgPSBiZWZvcmUgKyAxOwogICAgICAgICAgICBpbnRlcnBvbGF0ZSh0aGlzLCBkYXRlcywgdGhpcy5fc2FtcGxlcywgZGF0ZSwgYmVmb3JlLCBhZnRlciwgcmVzdWx0KTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGV0IGluZGV4ID0gYmluYXJ5U2VhcmNoX2RlZmF1bHQoZGF0ZXMsIGRhdGUsIEp1bGlhbkRhdGVfZGVmYXVsdC5jb21wYXJlLCB0aGlzLl9kYXRlQ29sdW1uKTsKICAgICAgICBpZiAoaW5kZXggPj0gMCkgewogICAgICAgICAgaWYgKGluZGV4IDwgZGF0ZXMubGVuZ3RoIC0gMSAmJiBkYXRlc1tpbmRleCArIDFdLmVxdWFscyhkYXRlKSkgewogICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgfQogICAgICAgICAgYmVmb3JlID0gaW5kZXg7CiAgICAgICAgICBhZnRlciA9IGluZGV4OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhZnRlciA9IH5pbmRleDsKICAgICAgICAgIGJlZm9yZSA9IGFmdGVyIC0gMTsKICAgICAgICAgIGlmIChiZWZvcmUgPCAwKSB7CiAgICAgICAgICAgIGJlZm9yZSA9IDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuX2xhc3RJbmRleCA9IGJlZm9yZTsKICAgICAgICBpbnRlcnBvbGF0ZSh0aGlzLCBkYXRlcywgdGhpcy5fc2FtcGxlcywgZGF0ZSwgYmVmb3JlLCBhZnRlciwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVyc19kZWZhdWx0ID0gRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9IZWFkaW5nUGl0Y2hSb2xsLmpzCiAgZnVuY3Rpb24gSGVhZGluZ1BpdGNoUm9sbChoZWFkaW5nLCBwaXRjaCwgcm9sbCkgewogICAgdGhpcy5oZWFkaW5nID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoaGVhZGluZywgMCk7CiAgICB0aGlzLnBpdGNoID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQocGl0Y2gsIDApOwogICAgdGhpcy5yb2xsID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQocm9sbCwgMCk7CiAgfQogIHZhciBIZWFkaW5nUGl0Y2hSb2xsX2RlZmF1bHQ7CiAgdmFyIGluaXRfSGVhZGluZ1BpdGNoUm9sbCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSGVhZGluZ1BpdGNoUm9sbC5qcyIoKSB7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBIZWFkaW5nUGl0Y2hSb2xsLmZyb21RdWF0ZXJuaW9uID0gZnVuY3Rpb24ocXVhdGVybmlvbiwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocXVhdGVybmlvbikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJxdWF0ZXJuaW9uIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBIZWFkaW5nUGl0Y2hSb2xsKCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHRlc3QgPSAyICogKHF1YXRlcm5pb24udyAqIHF1YXRlcm5pb24ueSAtIHF1YXRlcm5pb24ueiAqIHF1YXRlcm5pb24ueCk7CiAgICAgICAgY29uc3QgZGVub21pbmF0b3JSb2xsID0gMSAtIDIgKiAocXVhdGVybmlvbi54ICogcXVhdGVybmlvbi54ICsgcXVhdGVybmlvbi55ICogcXVhdGVybmlvbi55KTsKICAgICAgICBjb25zdCBudW1lcmF0b3JSb2xsID0gMiAqIChxdWF0ZXJuaW9uLncgKiBxdWF0ZXJuaW9uLnggKyBxdWF0ZXJuaW9uLnkgKiBxdWF0ZXJuaW9uLnopOwogICAgICAgIGNvbnN0IGRlbm9taW5hdG9ySGVhZGluZyA9IDEgLSAyICogKHF1YXRlcm5pb24ueSAqIHF1YXRlcm5pb24ueSArIHF1YXRlcm5pb24ueiAqIHF1YXRlcm5pb24ueik7CiAgICAgICAgY29uc3QgbnVtZXJhdG9ySGVhZGluZyA9IDIgKiAocXVhdGVybmlvbi53ICogcXVhdGVybmlvbi56ICsgcXVhdGVybmlvbi54ICogcXVhdGVybmlvbi55KTsKICAgICAgICByZXN1bHQuaGVhZGluZyA9IC1NYXRoLmF0YW4yKG51bWVyYXRvckhlYWRpbmcsIGRlbm9taW5hdG9ySGVhZGluZyk7CiAgICAgICAgcmVzdWx0LnJvbGwgPSBNYXRoLmF0YW4yKG51bWVyYXRvclJvbGwsIGRlbm9taW5hdG9yUm9sbCk7CiAgICAgICAgcmVzdWx0LnBpdGNoID0gLU1hdGhfZGVmYXVsdC5hc2luQ2xhbXBlZCh0ZXN0KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBIZWFkaW5nUGl0Y2hSb2xsLmZyb21EZWdyZWVzID0gZnVuY3Rpb24oaGVhZGluZywgcGl0Y2gsIHJvbGwsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGhlYWRpbmcpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiaGVhZGluZyBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwaXRjaCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwaXRjaCBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyb2xsKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJvbGwgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEhlYWRpbmdQaXRjaFJvbGwoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmhlYWRpbmcgPSBoZWFkaW5nICogTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRTsKICAgICAgICByZXN1bHQucGl0Y2ggPSBwaXRjaCAqIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUU7CiAgICAgICAgcmVzdWx0LnJvbGwgPSByb2xsICogTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBIZWFkaW5nUGl0Y2hSb2xsLmNsb25lID0gZnVuY3Rpb24oaGVhZGluZ1BpdGNoUm9sbCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaGVhZGluZ1BpdGNoUm9sbCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgSGVhZGluZ1BpdGNoUm9sbCgKICAgICAgICAgICAgaGVhZGluZ1BpdGNoUm9sbC5oZWFkaW5nLAogICAgICAgICAgICBoZWFkaW5nUGl0Y2hSb2xsLnBpdGNoLAogICAgICAgICAgICBoZWFkaW5nUGl0Y2hSb2xsLnJvbGwKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5oZWFkaW5nID0gaGVhZGluZ1BpdGNoUm9sbC5oZWFkaW5nOwogICAgICAgIHJlc3VsdC5waXRjaCA9IGhlYWRpbmdQaXRjaFJvbGwucGl0Y2g7CiAgICAgICAgcmVzdWx0LnJvbGwgPSBoZWFkaW5nUGl0Y2hSb2xsLnJvbGw7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgSGVhZGluZ1BpdGNoUm9sbC5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBsZWZ0LmhlYWRpbmcgPT09IHJpZ2h0LmhlYWRpbmcgJiYgbGVmdC5waXRjaCA9PT0gcmlnaHQucGl0Y2ggJiYgbGVmdC5yb2xsID09PSByaWdodC5yb2xsOwogICAgICB9OwogICAgICBIZWFkaW5nUGl0Y2hSb2xsLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVsYXRpdmVFcHNpbG9uLCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBsZWZ0LmhlYWRpbmcsCiAgICAgICAgICByaWdodC5oZWFkaW5nLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGxlZnQucGl0Y2gsCiAgICAgICAgICByaWdodC5waXRjaCwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBsZWZ0LnJvbGwsCiAgICAgICAgICByaWdodC5yb2xsLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgSGVhZGluZ1BpdGNoUm9sbC5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICByZXR1cm4gSGVhZGluZ1BpdGNoUm9sbC5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBIZWFkaW5nUGl0Y2hSb2xsLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiBIZWFkaW5nUGl0Y2hSb2xsLmVxdWFscyh0aGlzLCByaWdodCk7CiAgICAgIH07CiAgICAgIEhlYWRpbmdQaXRjaFJvbGwucHJvdG90eXBlLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihyaWdodCwgcmVsYXRpdmVFcHNpbG9uLCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICByZXR1cm4gSGVhZGluZ1BpdGNoUm9sbC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcywKICAgICAgICAgIHJpZ2h0LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgSGVhZGluZ1BpdGNoUm9sbC5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYCgke3RoaXMuaGVhZGluZ30sICR7dGhpcy5waXRjaH0sICR7dGhpcy5yb2xsfSlgOwogICAgICB9OwogICAgICBIZWFkaW5nUGl0Y2hSb2xsX2RlZmF1bHQgPSBIZWFkaW5nUGl0Y2hSb2xsOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvYnVpbGRNb2R1bGVVcmwuanMKICBmdW5jdGlvbiBnZXRCYXNlVXJsRnJvbUNlc2l1bVNjcmlwdCgpIHsKICAgIGNvbnN0IHNjcmlwdHMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgic2NyaXB0Iik7CiAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gc2NyaXB0cy5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICBjb25zdCBzcmMgPSBzY3JpcHRzW2ldLmdldEF0dHJpYnV0ZSgic3JjIik7CiAgICAgIGNvbnN0IHJlc3VsdCA9IGNlc2l1bVNjcmlwdFJlZ2V4LmV4ZWMoc3JjKTsKICAgICAgaWYgKHJlc3VsdCAhPT0gbnVsbCkgewogICAgICAgIHJldHVybiByZXN1bHRbMV07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGZ1bmN0aW9uIHRyeU1ha2VBYnNvbHV0ZSh1cmwpIHsKICAgIGlmICh0eXBlb2YgZG9jdW1lbnQgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHJldHVybiB1cmw7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhMikpIHsKICAgICAgYTIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICB9CiAgICBhMi5ocmVmID0gdXJsOwogICAgcmV0dXJuIGEyLmhyZWY7CiAgfQogIGZ1bmN0aW9uIGdldENlc2l1bUJhc2VVcmwoKSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGJhc2VSZXNvdXJjZSkpIHsKICAgICAgcmV0dXJuIGJhc2VSZXNvdXJjZTsKICAgIH0KICAgIGxldCBiYXNlVXJsU3RyaW5nOwogICAgaWYgKHR5cGVvZiBDRVNJVU1fQkFTRV9VUkwgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIGJhc2VVcmxTdHJpbmcgPSBDRVNJVU1fQkFTRV9VUkw7CiAgICB9IGVsc2UgaWYgKGRlZmluZWRfZGVmYXVsdChpbXBvcnRfbWV0YT8udXJsKSkgewogICAgICBiYXNlVXJsU3RyaW5nID0gZ2V0QWJzb2x1dGVVcmlfZGVmYXVsdCgiLiIsIGltcG9ydF9tZXRhLnVybCk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICJvYmplY3QiICYmIGRlZmluZWRfZGVmYXVsdChkZWZpbmUuYW1kKSAmJiAhZGVmaW5lLmFtZC50b1VybFVuZGVmaW5lZCAmJiBkZWZpbmVkX2RlZmF1bHQoX19yZXF1aXJlLnRvVXJsKSkgewogICAgICBiYXNlVXJsU3RyaW5nID0gZ2V0QWJzb2x1dGVVcmlfZGVmYXVsdCgKICAgICAgICAiLi4iLAogICAgICAgIGJ1aWxkTW9kdWxlVXJsKCJDb3JlL2J1aWxkTW9kdWxlVXJsLmpzIikKICAgICAgKTsKICAgIH0gZWxzZSB7CiAgICAgIGJhc2VVcmxTdHJpbmcgPSBnZXRCYXNlVXJsRnJvbUNlc2l1bVNjcmlwdCgpOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYmFzZVVybFN0cmluZykpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIlVuYWJsZSB0byBkZXRlcm1pbmUgQ2VzaXVtIGJhc2UgVVJMIGF1dG9tYXRpY2FsbHksIHRyeSBkZWZpbmluZyBhIGdsb2JhbCB2YXJpYWJsZSBjYWxsZWQgQ0VTSVVNX0JBU0VfVVJMLiIKICAgICAgKTsKICAgIH0KICAgIGJhc2VSZXNvdXJjZSA9IG5ldyBSZXNvdXJjZV9kZWZhdWx0KHsKICAgICAgdXJsOiB0cnlNYWtlQWJzb2x1dGUoYmFzZVVybFN0cmluZykKICAgIH0pOwogICAgYmFzZVJlc291cmNlLmFwcGVuZEZvcndhcmRTbGFzaCgpOwogICAgcmV0dXJuIGJhc2VSZXNvdXJjZTsKICB9CiAgZnVuY3Rpb24gYnVpbGRNb2R1bGVVcmxGcm9tUmVxdWlyZVRvVXJsKG1vZHVsZUlEKSB7CiAgICByZXR1cm4gdHJ5TWFrZUFic29sdXRlKF9fcmVxdWlyZS50b1VybChgLi4vJHttb2R1bGVJRH1gKSk7CiAgfQogIGZ1bmN0aW9uIGJ1aWxkTW9kdWxlVXJsRnJvbUJhc2VVcmwobW9kdWxlSUQpIHsKICAgIGNvbnN0IHJlc291cmNlID0gZ2V0Q2VzaXVtQmFzZVVybCgpLmdldERlcml2ZWRSZXNvdXJjZSh7CiAgICAgIHVybDogbW9kdWxlSUQKICAgIH0pOwogICAgcmV0dXJuIHJlc291cmNlLnVybDsKICB9CiAgZnVuY3Rpb24gYnVpbGRNb2R1bGVVcmwocmVsYXRpdmVVcmwpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGltcGxlbWVudGF0aW9uKSkgewogICAgICBpZiAodHlwZW9mIGRlZmluZSA9PT0gIm9iamVjdCIgJiYgZGVmaW5lZF9kZWZhdWx0KGRlZmluZS5hbWQpICYmICFkZWZpbmUuYW1kLnRvVXJsVW5kZWZpbmVkICYmIGRlZmluZWRfZGVmYXVsdChfX3JlcXVpcmUudG9VcmwpKSB7CiAgICAgICAgaW1wbGVtZW50YXRpb24gPSBidWlsZE1vZHVsZVVybEZyb21SZXF1aXJlVG9Vcmw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaW1wbGVtZW50YXRpb24gPSBidWlsZE1vZHVsZVVybEZyb21CYXNlVXJsOwogICAgICB9CiAgICB9CiAgICBjb25zdCB1cmwgPSBpbXBsZW1lbnRhdGlvbihyZWxhdGl2ZVVybCk7CiAgICByZXR1cm4gdXJsOwogIH0KICB2YXIgaW1wb3J0X21ldGEsIGNlc2l1bVNjcmlwdFJlZ2V4LCBhMiwgYmFzZVJlc291cmNlLCBpbXBsZW1lbnRhdGlvbiwgYnVpbGRNb2R1bGVVcmxfZGVmYXVsdDsKICB2YXIgaW5pdF9idWlsZE1vZHVsZVVybCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvYnVpbGRNb2R1bGVVcmwuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X2dldEFic29sdXRlVXJpKCk7CiAgICAgIGluaXRfUmVzb3VyY2UoKTsKICAgICAgaW1wb3J0X21ldGEgPSB7fTsKICAgICAgY2VzaXVtU2NyaXB0UmVnZXggPSAvKCg/Oi4qXC8pfF4pQ2VzaXVtXC5qcyg/Olw/fFwjfCQpLzsKICAgICAgYnVpbGRNb2R1bGVVcmwuX2Nlc2l1bVNjcmlwdFJlZ2V4ID0gY2VzaXVtU2NyaXB0UmVnZXg7CiAgICAgIGJ1aWxkTW9kdWxlVXJsLl9idWlsZE1vZHVsZVVybEZyb21CYXNlVXJsID0gYnVpbGRNb2R1bGVVcmxGcm9tQmFzZVVybDsKICAgICAgYnVpbGRNb2R1bGVVcmwuX2NsZWFyQmFzZVJlc291cmNlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgYmFzZVJlc291cmNlID0gdm9pZCAwOwogICAgICB9OwogICAgICBidWlsZE1vZHVsZVVybC5zZXRCYXNlVXJsID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBiYXNlUmVzb3VyY2UgPSBSZXNvdXJjZV9kZWZhdWx0LkRFRkFVTFQuZ2V0RGVyaXZlZFJlc291cmNlKHsKICAgICAgICAgIHVybDogdmFsdWUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgYnVpbGRNb2R1bGVVcmwuZ2V0Q2VzaXVtQmFzZVVybCA9IGdldENlc2l1bUJhc2VVcmw7CiAgICAgIGJ1aWxkTW9kdWxlVXJsX2RlZmF1bHQgPSBidWlsZE1vZHVsZVVybDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0lhdTIwMDZYeXNTYW1wbGUuanMKICBmdW5jdGlvbiBJYXUyMDA2WHlzU2FtcGxlKHgsIHksIHMpIHsKICAgIHRoaXMueCA9IHg7CiAgICB0aGlzLnkgPSB5OwogICAgdGhpcy5zID0gczsKICB9CiAgdmFyIElhdTIwMDZYeXNTYW1wbGVfZGVmYXVsdDsKICB2YXIgaW5pdF9JYXUyMDA2WHlzU2FtcGxlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9JYXUyMDA2WHlzU2FtcGxlLmpzIigpIHsKICAgICAgSWF1MjAwNlh5c1NhbXBsZV9kZWZhdWx0ID0gSWF1MjAwNlh5c1NhbXBsZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0lhdTIwMDZYeXNEYXRhLmpzCiAgZnVuY3Rpb24gSWF1MjAwNlh5c0RhdGEob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICB0aGlzLl94eXNGaWxlVXJsVGVtcGxhdGUgPSBSZXNvdXJjZV9kZWZhdWx0LmNyZWF0ZUlmTmVlZGVkKAogICAgICBvcHRpb25zLnh5c0ZpbGVVcmxUZW1wbGF0ZQogICAgKTsKICAgIHRoaXMuX2ludGVycG9sYXRpb25PcmRlciA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuaW50ZXJwb2xhdGlvbk9yZGVyLCA5KTsKICAgIHRoaXMuX3NhbXBsZVplcm9KdWxpYW5FcGhlbWVyaXNEYXRlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMuc2FtcGxlWmVyb0p1bGlhbkVwaGVtZXJpc0RhdGUsCiAgICAgIDI0NDIzOTY1ZS0xCiAgICApOwogICAgdGhpcy5fc2FtcGxlWmVyb0RhdGVUVCA9IG5ldyBKdWxpYW5EYXRlX2RlZmF1bHQoCiAgICAgIHRoaXMuX3NhbXBsZVplcm9KdWxpYW5FcGhlbWVyaXNEYXRlLAogICAgICAwLAogICAgICBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkKICAgICk7CiAgICB0aGlzLl9zdGVwU2l6ZURheXMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnN0ZXBTaXplRGF5cywgMSk7CiAgICB0aGlzLl9zYW1wbGVzUGVyWHlzRmlsZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuc2FtcGxlc1Blclh5c0ZpbGUsIDFlMyk7CiAgICB0aGlzLl90b3RhbFNhbXBsZXMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnRvdGFsU2FtcGxlcywgMjc0MjYpOwogICAgdGhpcy5fc2FtcGxlcyA9IG5ldyBBcnJheSh0aGlzLl90b3RhbFNhbXBsZXMgKiAzKTsKICAgIHRoaXMuX2NodW5rRG93bmxvYWRzSW5Qcm9ncmVzcyA9IFtdOwogICAgY29uc3Qgb3JkZXIgPSB0aGlzLl9pbnRlcnBvbGF0aW9uT3JkZXI7CiAgICBjb25zdCBkZW5vbSA9IHRoaXMuX2Rlbm9taW5hdG9ycyA9IG5ldyBBcnJheShvcmRlciArIDEpOwogICAgY29uc3QgeFRhYmxlID0gdGhpcy5feFRhYmxlID0gbmV3IEFycmF5KG9yZGVyICsgMSk7CiAgICBjb25zdCBzdGVwTiA9IE1hdGgucG93KHRoaXMuX3N0ZXBTaXplRGF5cywgb3JkZXIpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPD0gb3JkZXI7ICsraSkgewogICAgICBkZW5vbVtpXSA9IHN0ZXBOOwogICAgICB4VGFibGVbaV0gPSBpICogdGhpcy5fc3RlcFNpemVEYXlzOwogICAgICBmb3IgKGxldCBqID0gMDsgaiA8PSBvcmRlcjsgKytqKSB7CiAgICAgICAgaWYgKGogIT09IGkpIHsKICAgICAgICAgIGRlbm9tW2ldICo9IGkgLSBqOwogICAgICAgIH0KICAgICAgfQogICAgICBkZW5vbVtpXSA9IDEgLyBkZW5vbVtpXTsKICAgIH0KICAgIHRoaXMuX3dvcmsgPSBuZXcgQXJyYXkob3JkZXIgKyAxKTsKICAgIHRoaXMuX2NvZWYgPSBuZXcgQXJyYXkob3JkZXIgKyAxKTsKICB9CiAgZnVuY3Rpb24gZ2V0RGF5c1NpbmNlRXBvY2goeHlzLCBkYXlUVCwgc2Vjb25kVFQpIHsKICAgIGNvbnN0IGRhdGVUVCA9IGp1bGlhbkRhdGVTY3JhdGNoOwogICAgZGF0ZVRULmRheU51bWJlciA9IGRheVRUOwogICAgZGF0ZVRULnNlY29uZHNPZkRheSA9IHNlY29uZFRUOwogICAgcmV0dXJuIEp1bGlhbkRhdGVfZGVmYXVsdC5kYXlzRGlmZmVyZW5jZShkYXRlVFQsIHh5cy5fc2FtcGxlWmVyb0RhdGVUVCk7CiAgfQogIGZ1bmN0aW9uIHJlcXVlc3RYeXNDaHVuayh4eXNEYXRhLCBjaHVua0luZGV4KSB7CiAgICBpZiAoeHlzRGF0YS5fY2h1bmtEb3dubG9hZHNJblByb2dyZXNzW2NodW5rSW5kZXhdKSB7CiAgICAgIHJldHVybiB4eXNEYXRhLl9jaHVua0Rvd25sb2Fkc0luUHJvZ3Jlc3NbY2h1bmtJbmRleF07CiAgICB9CiAgICBsZXQgY2h1bmtVcmw7CiAgICBjb25zdCB4eXNGaWxlVXJsVGVtcGxhdGUgPSB4eXNEYXRhLl94eXNGaWxlVXJsVGVtcGxhdGU7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHh5c0ZpbGVVcmxUZW1wbGF0ZSkpIHsKICAgICAgY2h1bmtVcmwgPSB4eXNGaWxlVXJsVGVtcGxhdGUuZ2V0RGVyaXZlZFJlc291cmNlKHsKICAgICAgICB0ZW1wbGF0ZVZhbHVlczogewogICAgICAgICAgMDogY2h1bmtJbmRleAogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBjaHVua1VybCA9IG5ldyBSZXNvdXJjZV9kZWZhdWx0KHsKICAgICAgICB1cmw6IGJ1aWxkTW9kdWxlVXJsX2RlZmF1bHQoYEFzc2V0cy9JQVUyMDA2X1hZUy9JQVUyMDA2X1hZU18ke2NodW5rSW5kZXh9Lmpzb25gKQogICAgICB9KTsKICAgIH0KICAgIGNvbnN0IHByb21pc2UgPSBjaHVua1VybC5mZXRjaEpzb24oKS50aGVuKGZ1bmN0aW9uKGNodW5rKSB7CiAgICAgIHh5c0RhdGEuX2NodW5rRG93bmxvYWRzSW5Qcm9ncmVzc1tjaHVua0luZGV4XSA9IGZhbHNlOwogICAgICBjb25zdCBzYW1wbGVzID0geHlzRGF0YS5fc2FtcGxlczsKICAgICAgY29uc3QgbmV3U2FtcGxlcyA9IGNodW5rLnNhbXBsZXM7CiAgICAgIGNvbnN0IHN0YXJ0SW5kZXggPSBjaHVua0luZGV4ICogeHlzRGF0YS5fc2FtcGxlc1Blclh5c0ZpbGUgKiAzOwogICAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gbmV3U2FtcGxlcy5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICAgIHNhbXBsZXNbc3RhcnRJbmRleCArIGldID0gbmV3U2FtcGxlc1tpXTsKICAgICAgfQogICAgfSk7CiAgICB4eXNEYXRhLl9jaHVua0Rvd25sb2Fkc0luUHJvZ3Jlc3NbY2h1bmtJbmRleF0gPSBwcm9taXNlOwogICAgcmV0dXJuIHByb21pc2U7CiAgfQogIHZhciBqdWxpYW5EYXRlU2NyYXRjaCwgSWF1MjAwNlh5c0RhdGFfZGVmYXVsdDsKICB2YXIgaW5pdF9JYXUyMDA2WHlzRGF0YSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSWF1MjAwNlh5c0RhdGEuanMiKCkgewogICAgICBpbml0X2J1aWxkTW9kdWxlVXJsKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0lhdTIwMDZYeXNTYW1wbGUoKTsKICAgICAgaW5pdF9KdWxpYW5EYXRlKCk7CiAgICAgIGluaXRfUmVzb3VyY2UoKTsKICAgICAgaW5pdF9UaW1lU3RhbmRhcmQoKTsKICAgICAganVsaWFuRGF0ZVNjcmF0Y2ggPSBuZXcgSnVsaWFuRGF0ZV9kZWZhdWx0KDAsIDAsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSk7CiAgICAgIElhdTIwMDZYeXNEYXRhLnByb3RvdHlwZS5wcmVsb2FkID0gZnVuY3Rpb24oc3RhcnREYXlUVCwgc3RhcnRTZWNvbmRUVCwgc3RvcERheVRULCBzdG9wU2Vjb25kVFQpIHsKICAgICAgICBjb25zdCBzdGFydERheXNTaW5jZUVwb2NoID0gZ2V0RGF5c1NpbmNlRXBvY2goCiAgICAgICAgICB0aGlzLAogICAgICAgICAgc3RhcnREYXlUVCwKICAgICAgICAgIHN0YXJ0U2Vjb25kVFQKICAgICAgICApOwogICAgICAgIGNvbnN0IHN0b3BEYXlzU2luY2VFcG9jaCA9IGdldERheXNTaW5jZUVwb2NoKHRoaXMsIHN0b3BEYXlUVCwgc3RvcFNlY29uZFRUKTsKICAgICAgICBsZXQgc3RhcnRJbmRleCA9IHN0YXJ0RGF5c1NpbmNlRXBvY2ggLyB0aGlzLl9zdGVwU2l6ZURheXMgLSB0aGlzLl9pbnRlcnBvbGF0aW9uT3JkZXIgLyAyIHwgMDsKICAgICAgICBpZiAoc3RhcnRJbmRleCA8IDApIHsKICAgICAgICAgIHN0YXJ0SW5kZXggPSAwOwogICAgICAgIH0KICAgICAgICBsZXQgc3RvcEluZGV4ID0gc3RvcERheXNTaW5jZUVwb2NoIC8gdGhpcy5fc3RlcFNpemVEYXlzIC0gdGhpcy5faW50ZXJwb2xhdGlvbk9yZGVyIC8gMiB8IDAgKyB0aGlzLl9pbnRlcnBvbGF0aW9uT3JkZXI7CiAgICAgICAgaWYgKHN0b3BJbmRleCA+PSB0aGlzLl90b3RhbFNhbXBsZXMpIHsKICAgICAgICAgIHN0b3BJbmRleCA9IHRoaXMuX3RvdGFsU2FtcGxlcyAtIDE7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHN0YXJ0Q2h1bmsgPSBzdGFydEluZGV4IC8gdGhpcy5fc2FtcGxlc1Blclh5c0ZpbGUgfCAwOwogICAgICAgIGNvbnN0IHN0b3BDaHVuayA9IHN0b3BJbmRleCAvIHRoaXMuX3NhbXBsZXNQZXJYeXNGaWxlIHwgMDsKICAgICAgICBjb25zdCBwcm9taXNlcyA9IFtdOwogICAgICAgIGZvciAobGV0IGkgPSBzdGFydENodW5rOyBpIDw9IHN0b3BDaHVuazsgKytpKSB7CiAgICAgICAgICBwcm9taXNlcy5wdXNoKHJlcXVlc3RYeXNDaHVuayh0aGlzLCBpKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNlcyk7CiAgICAgIH07CiAgICAgIElhdTIwMDZYeXNEYXRhLnByb3RvdHlwZS5jb21wdXRlWHlzUmFkaWFucyA9IGZ1bmN0aW9uKGRheVRULCBzZWNvbmRUVCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgZGF5c1NpbmNlRXBvY2ggPSBnZXREYXlzU2luY2VFcG9jaCh0aGlzLCBkYXlUVCwgc2Vjb25kVFQpOwogICAgICAgIGlmIChkYXlzU2luY2VFcG9jaCA8IDApIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNlbnRlckluZGV4ID0gZGF5c1NpbmNlRXBvY2ggLyB0aGlzLl9zdGVwU2l6ZURheXMgfCAwOwogICAgICAgIGlmIChjZW50ZXJJbmRleCA+PSB0aGlzLl90b3RhbFNhbXBsZXMpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGRlZ3JlZSA9IHRoaXMuX2ludGVycG9sYXRpb25PcmRlcjsKICAgICAgICBsZXQgZmlyc3RJbmRleCA9IGNlbnRlckluZGV4IC0gKGRlZ3JlZSAvIDIgfCAwKTsKICAgICAgICBpZiAoZmlyc3RJbmRleCA8IDApIHsKICAgICAgICAgIGZpcnN0SW5kZXggPSAwOwogICAgICAgIH0KICAgICAgICBsZXQgbGFzdEluZGV4ID0gZmlyc3RJbmRleCArIGRlZ3JlZTsKICAgICAgICBpZiAobGFzdEluZGV4ID49IHRoaXMuX3RvdGFsU2FtcGxlcykgewogICAgICAgICAgbGFzdEluZGV4ID0gdGhpcy5fdG90YWxTYW1wbGVzIC0gMTsKICAgICAgICAgIGZpcnN0SW5kZXggPSBsYXN0SW5kZXggLSBkZWdyZWU7CiAgICAgICAgICBpZiAoZmlyc3RJbmRleCA8IDApIHsKICAgICAgICAgICAgZmlyc3RJbmRleCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCBpc0RhdGFNaXNzaW5nID0gZmFsc2U7CiAgICAgICAgY29uc3Qgc2FtcGxlcyA9IHRoaXMuX3NhbXBsZXM7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc2FtcGxlc1tmaXJzdEluZGV4ICogM10pKSB7CiAgICAgICAgICByZXF1ZXN0WHlzQ2h1bmsodGhpcywgZmlyc3RJbmRleCAvIHRoaXMuX3NhbXBsZXNQZXJYeXNGaWxlIHwgMCk7CiAgICAgICAgICBpc0RhdGFNaXNzaW5nID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc2FtcGxlc1tsYXN0SW5kZXggKiAzXSkpIHsKICAgICAgICAgIHJlcXVlc3RYeXNDaHVuayh0aGlzLCBsYXN0SW5kZXggLyB0aGlzLl9zYW1wbGVzUGVyWHlzRmlsZSB8IDApOwogICAgICAgICAgaXNEYXRhTWlzc2luZyA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGlmIChpc0RhdGFNaXNzaW5nKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgSWF1MjAwNlh5c1NhbXBsZV9kZWZhdWx0KDAsIDAsIDApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQueCA9IDA7CiAgICAgICAgICByZXN1bHQueSA9IDA7CiAgICAgICAgICByZXN1bHQucyA9IDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHggPSBkYXlzU2luY2VFcG9jaCAtIGZpcnN0SW5kZXggKiB0aGlzLl9zdGVwU2l6ZURheXM7CiAgICAgICAgY29uc3Qgd29yayA9IHRoaXMuX3dvcms7CiAgICAgICAgY29uc3QgZGVub20gPSB0aGlzLl9kZW5vbWluYXRvcnM7CiAgICAgICAgY29uc3QgY29lZiA9IHRoaXMuX2NvZWY7CiAgICAgICAgY29uc3QgeFRhYmxlID0gdGhpcy5feFRhYmxlOwogICAgICAgIGxldCBpLCBqOwogICAgICAgIGZvciAoaSA9IDA7IGkgPD0gZGVncmVlOyArK2kpIHsKICAgICAgICAgIHdvcmtbaV0gPSB4IC0geFRhYmxlW2ldOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSAwOyBpIDw9IGRlZ3JlZTsgKytpKSB7CiAgICAgICAgICBjb2VmW2ldID0gMTsKICAgICAgICAgIGZvciAoaiA9IDA7IGogPD0gZGVncmVlOyArK2opIHsKICAgICAgICAgICAgaWYgKGogIT09IGkpIHsKICAgICAgICAgICAgICBjb2VmW2ldICo9IHdvcmtbal07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNvZWZbaV0gKj0gZGVub21baV07CiAgICAgICAgICBsZXQgc2FtcGxlSW5kZXggPSAoZmlyc3RJbmRleCArIGkpICogMzsKICAgICAgICAgIHJlc3VsdC54ICs9IGNvZWZbaV0gKiBzYW1wbGVzW3NhbXBsZUluZGV4KytdOwogICAgICAgICAgcmVzdWx0LnkgKz0gY29lZltpXSAqIHNhbXBsZXNbc2FtcGxlSW5kZXgrK107CiAgICAgICAgICByZXN1bHQucyArPSBjb2VmW2ldICogc2FtcGxlc1tzYW1wbGVJbmRleF07CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIElhdTIwMDZYeXNEYXRhX2RlZmF1bHQgPSBJYXUyMDA2WHlzRGF0YTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RyYW5zZm9ybXMuanMKICB2YXIgVHJhbnNmb3JtcywgdmVjdG9yUHJvZHVjdExvY2FsRnJhbWUsIGRlZ2VuZXJhdGVQb3NpdGlvbkxvY2FsRnJhbWUsIGxvY2FsRnJhbWVUb0ZpeGVkRnJhbWVDYWNoZSwgc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbiwgc2NyYXRjaEZpcnN0Q2FydGVzaWFuLCBzY3JhdGNoU2Vjb25kQ2FydGVzaWFuLCBzY3JhdGNoVGhpcmRDYXJ0ZXNpYW4sIHNjcmF0Y2hIUFJRdWF0ZXJuaW9uMiwgc2NyYXRjaFNjYWxlLCBzY3JhdGNoSFBSTWF0cml4NCwgc2NyYXRjaEVOVU1hdHJpeDQsIHNjcmF0Y2hIUFJNYXRyaXgzLCBub1NjYWxlLCBocHJDZW50ZXJTY3JhdGNoLCBmZlNjcmF0Y2gsIGhwclRyYW5zZm9ybVNjcmF0Y2gsIGhwclJvdGF0aW9uU2NyYXRjaCwgaHByUXVhdGVybmlvblNjcmF0Y2gsIGdtc3RDb25zdGFudDAsIGdtc3RDb25zdGFudDEsIGdtc3RDb25zdGFudDIsIGdtc3RDb25zdGFudDMsIHJhdGVDb2VmLCB3Z3M4NFdSUHJlY2Vzc2luZywgdHdvUGlPdmVyU2Vjb25kc0luRGF5LCBkYXRlSW5VdGMsIHR0TWludXNUYWksIGoyMDAwdHREYXlzLCB4eXNTY3JhdGNoLCBlb3BTY3JhdGNoLCByb3RhdGlvbjFTY3JhdGNoLCByb3RhdGlvbjJTY3JhdGNoLCBwb2ludFRvV2luZG93Q29vcmRpbmF0ZXNUZW1wLCBub3JtYWxTY3JhdGNoLCByaWdodFNjcmF0Y2gsIHVwU2NyYXRjaCwgc3dpenpsZU1hdHJpeCwgc2NyYXRjaENhcnRvZ3JhcGhpYywgc2NyYXRjaENhcnRlc2lhbjNQcm9qZWN0aW9uLCBzY3JhdGNoQ2VudGVyLCBzY3JhdGNoUm90YXRpb24sIHNjcmF0Y2hGcm9tRU5VLCBzY3JhdGNoVG9FTlUsIFRyYW5zZm9ybXNfZGVmYXVsdDsKICB2YXIgaW5pdF9UcmFuc2Zvcm1zID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9UcmFuc2Zvcm1zLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRlc2lhbjQoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzKCk7CiAgICAgIGluaXRfRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnNTYW1wbGUoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9IZWFkaW5nUGl0Y2hSb2xsKCk7CiAgICAgIGluaXRfSWF1MjAwNlh5c0RhdGEoKTsKICAgICAgaW5pdF9JYXUyMDA2WHlzU2FtcGxlKCk7CiAgICAgIGluaXRfSnVsaWFuRGF0ZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfTWF0cml4NCgpOwogICAgICBpbml0X1F1YXRlcm5pb24oKTsKICAgICAgaW5pdF9UaW1lQ29uc3RhbnRzKCk7CiAgICAgIFRyYW5zZm9ybXMgPSB7fTsKICAgICAgdmVjdG9yUHJvZHVjdExvY2FsRnJhbWUgPSB7CiAgICAgICAgdXA6IHsKICAgICAgICAgIHNvdXRoOiAiZWFzdCIsCiAgICAgICAgICBub3J0aDogIndlc3QiLAogICAgICAgICAgd2VzdDogInNvdXRoIiwKICAgICAgICAgIGVhc3Q6ICJub3J0aCIKICAgICAgICB9LAogICAgICAgIGRvd246IHsKICAgICAgICAgIHNvdXRoOiAid2VzdCIsCiAgICAgICAgICBub3J0aDogImVhc3QiLAogICAgICAgICAgd2VzdDogIm5vcnRoIiwKICAgICAgICAgIGVhc3Q6ICJzb3V0aCIKICAgICAgICB9LAogICAgICAgIHNvdXRoOiB7CiAgICAgICAgICB1cDogIndlc3QiLAogICAgICAgICAgZG93bjogImVhc3QiLAogICAgICAgICAgd2VzdDogImRvd24iLAogICAgICAgICAgZWFzdDogInVwIgogICAgICAgIH0sCiAgICAgICAgbm9ydGg6IHsKICAgICAgICAgIHVwOiAiZWFzdCIsCiAgICAgICAgICBkb3duOiAid2VzdCIsCiAgICAgICAgICB3ZXN0OiAidXAiLAogICAgICAgICAgZWFzdDogImRvd24iCiAgICAgICAgfSwKICAgICAgICB3ZXN0OiB7CiAgICAgICAgICB1cDogIm5vcnRoIiwKICAgICAgICAgIGRvd246ICJzb3V0aCIsCiAgICAgICAgICBub3J0aDogImRvd24iLAogICAgICAgICAgc291dGg6ICJ1cCIKICAgICAgICB9LAogICAgICAgIGVhc3Q6IHsKICAgICAgICAgIHVwOiAic291dGgiLAogICAgICAgICAgZG93bjogIm5vcnRoIiwKICAgICAgICAgIG5vcnRoOiAidXAiLAogICAgICAgICAgc291dGg6ICJkb3duIgogICAgICAgIH0KICAgICAgfTsKICAgICAgZGVnZW5lcmF0ZVBvc2l0aW9uTG9jYWxGcmFtZSA9IHsKICAgICAgICBub3J0aDogWy0xLCAwLCAwXSwKICAgICAgICBlYXN0OiBbMCwgMSwgMF0sCiAgICAgICAgdXA6IFswLCAwLCAxXSwKICAgICAgICBzb3V0aDogWzEsIDAsIDBdLAogICAgICAgIHdlc3Q6IFswLCAtMSwgMF0sCiAgICAgICAgZG93bjogWzAsIDAsIC0xXQogICAgICB9OwogICAgICBsb2NhbEZyYW1lVG9GaXhlZEZyYW1lQ2FjaGUgPSB7fTsKICAgICAgc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbiA9IHsKICAgICAgICBlYXN0OiBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgbm9ydGg6IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICB1cDogbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgIHdlc3Q6IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICBzb3V0aDogbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgIGRvd246IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKQogICAgICB9OwogICAgICBzY3JhdGNoRmlyc3RDYXJ0ZXNpYW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hTZWNvbmRDYXJ0ZXNpYW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hUaGlyZENhcnRlc2lhbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgVHJhbnNmb3Jtcy5sb2NhbEZyYW1lVG9GaXhlZEZyYW1lR2VuZXJhdG9yID0gZnVuY3Rpb24oZmlyc3RBeGlzLCBzZWNvbmRBeGlzKSB7CiAgICAgICAgaWYgKCF2ZWN0b3JQcm9kdWN0TG9jYWxGcmFtZS5oYXNPd25Qcm9wZXJ0eShmaXJzdEF4aXMpIHx8ICF2ZWN0b3JQcm9kdWN0TG9jYWxGcmFtZVtmaXJzdEF4aXNdLmhhc093blByb3BlcnR5KHNlY29uZEF4aXMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgImZpcnN0QXhpcyBhbmQgc2Vjb25kQXhpcyBtdXN0IGJlIGVhc3QsIG5vcnRoLCB1cCwgd2VzdCwgc291dGggb3IgZG93bi4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCB0aGlyZEF4aXMgPSB2ZWN0b3JQcm9kdWN0TG9jYWxGcmFtZVtmaXJzdEF4aXNdW3NlY29uZEF4aXNdOwogICAgICAgIGxldCByZXN1bHRhdDsKICAgICAgICBjb25zdCBoYXNoQXhpcyA9IGZpcnN0QXhpcyArIHNlY29uZEF4aXM7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChsb2NhbEZyYW1lVG9GaXhlZEZyYW1lQ2FjaGVbaGFzaEF4aXNdKSkgewogICAgICAgICAgcmVzdWx0YXQgPSBsb2NhbEZyYW1lVG9GaXhlZEZyYW1lQ2FjaGVbaGFzaEF4aXNdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHRhdCA9IGZ1bmN0aW9uKG9yaWdpbiwgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob3JpZ2luKSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcmlnaW4gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzTmFOKG9yaWdpbi54KSB8fCBpc05hTihvcmlnaW4ueSkgfHwgaXNOYU4ob3JpZ2luLnopKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9yaWdpbiBoYXMgYSBOYU4gY29tcG9uZW50Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgICAgIHJlc3VsdCA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24ob3JpZ2luLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgTWF0aF9kZWZhdWx0LkVQU0lMT04xNCkpIHsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICAgICAgZGVnZW5lcmF0ZVBvc2l0aW9uTG9jYWxGcmFtZVtmaXJzdEF4aXNdLAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIHNjcmF0Y2hGaXJzdENhcnRlc2lhbgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgICAgIGRlZ2VuZXJhdGVQb3NpdGlvbkxvY2FsRnJhbWVbc2Vjb25kQXhpc10sCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgc2NyYXRjaFNlY29uZENhcnRlc2lhbgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgICAgIGRlZ2VuZXJhdGVQb3NpdGlvbkxvY2FsRnJhbWVbdGhpcmRBeGlzXSwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICBzY3JhdGNoVGhpcmRDYXJ0ZXNpYW4KICAgICAgICAgICAgICApOwogICAgICAgICAgICB9IGVsc2UgaWYgKE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKG9yaWdpbi54LCAwLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE0KSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihvcmlnaW4ueSwgMCwgTWF0aF9kZWZhdWx0LkVQU0lMT04xNCkpIHsKICAgICAgICAgICAgICBjb25zdCBzaWduMiA9IE1hdGhfZGVmYXVsdC5zaWduKG9yaWdpbi56KTsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICAgICAgZGVnZW5lcmF0ZVBvc2l0aW9uTG9jYWxGcmFtZVtmaXJzdEF4aXNdLAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIHNjcmF0Y2hGaXJzdENhcnRlc2lhbgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKGZpcnN0QXhpcyAhPT0gImVhc3QiICYmIGZpcnN0QXhpcyAhPT0gIndlc3QiKSB7CiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgICAgICAgICAgc2NyYXRjaEZpcnN0Q2FydGVzaWFuLAogICAgICAgICAgICAgICAgICBzaWduMiwKICAgICAgICAgICAgICAgICAgc2NyYXRjaEZpcnN0Q2FydGVzaWFuCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICAgICAgZGVnZW5lcmF0ZVBvc2l0aW9uTG9jYWxGcmFtZVtzZWNvbmRBeGlzXSwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICBzY3JhdGNoU2Vjb25kQ2FydGVzaWFuCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAoc2Vjb25kQXhpcyAhPT0gImVhc3QiICYmIHNlY29uZEF4aXMgIT09ICJ3ZXN0IikgewogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgICAgICAgIHNjcmF0Y2hTZWNvbmRDYXJ0ZXNpYW4sCiAgICAgICAgICAgICAgICAgIHNpZ24yLAogICAgICAgICAgICAgICAgICBzY3JhdGNoU2Vjb25kQ2FydGVzaWFuCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICAgICAgZGVnZW5lcmF0ZVBvc2l0aW9uTG9jYWxGcmFtZVt0aGlyZEF4aXNdLAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIHNjcmF0Y2hUaGlyZENhcnRlc2lhbgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKHRoaXJkQXhpcyAhPT0gImVhc3QiICYmIHRoaXJkQXhpcyAhPT0gIndlc3QiKSB7CiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgICAgICAgICAgc2NyYXRjaFRoaXJkQ2FydGVzaWFuLAogICAgICAgICAgICAgICAgICBzaWduMiwKICAgICAgICAgICAgICAgICAgc2NyYXRjaFRoaXJkQ2FydGVzaWFuCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgICAgICAgICAgICBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKG9yaWdpbiwgc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbi51cCk7CiAgICAgICAgICAgICAgY29uc3QgdXAgPSBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuLnVwOwogICAgICAgICAgICAgIGNvbnN0IGVhc3QgPSBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuLmVhc3Q7CiAgICAgICAgICAgICAgZWFzdC54ID0gLW9yaWdpbi55OwogICAgICAgICAgICAgIGVhc3QueSA9IG9yaWdpbi54OwogICAgICAgICAgICAgIGVhc3QueiA9IDA7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShlYXN0LCBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuLmVhc3QpOwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyh1cCwgZWFzdCwgc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbi5ub3J0aCk7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgICAgICBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuLnVwLAogICAgICAgICAgICAgICAgLTEsCiAgICAgICAgICAgICAgICBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuLmRvd24KICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICAgICAgc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbi5lYXN0LAogICAgICAgICAgICAgICAgLTEsCiAgICAgICAgICAgICAgICBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuLndlc3QKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICAgICAgc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbi5ub3J0aCwKICAgICAgICAgICAgICAgIC0xLAogICAgICAgICAgICAgICAgc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbi5zb3V0aAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgc2NyYXRjaEZpcnN0Q2FydGVzaWFuID0gc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbltmaXJzdEF4aXNdOwogICAgICAgICAgICAgIHNjcmF0Y2hTZWNvbmRDYXJ0ZXNpYW4gPSBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuW3NlY29uZEF4aXNdOwogICAgICAgICAgICAgIHNjcmF0Y2hUaGlyZENhcnRlc2lhbiA9IHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW5bdGhpcmRBeGlzXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXN1bHRbMF0gPSBzY3JhdGNoRmlyc3RDYXJ0ZXNpYW4ueDsKICAgICAgICAgICAgcmVzdWx0WzFdID0gc2NyYXRjaEZpcnN0Q2FydGVzaWFuLnk7CiAgICAgICAgICAgIHJlc3VsdFsyXSA9IHNjcmF0Y2hGaXJzdENhcnRlc2lhbi56OwogICAgICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgICAgICByZXN1bHRbNF0gPSBzY3JhdGNoU2Vjb25kQ2FydGVzaWFuLng7CiAgICAgICAgICAgIHJlc3VsdFs1XSA9IHNjcmF0Y2hTZWNvbmRDYXJ0ZXNpYW4ueTsKICAgICAgICAgICAgcmVzdWx0WzZdID0gc2NyYXRjaFNlY29uZENhcnRlc2lhbi56OwogICAgICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgICAgICByZXN1bHRbOF0gPSBzY3JhdGNoVGhpcmRDYXJ0ZXNpYW4ueDsKICAgICAgICAgICAgcmVzdWx0WzldID0gc2NyYXRjaFRoaXJkQ2FydGVzaWFuLnk7CiAgICAgICAgICAgIHJlc3VsdFsxMF0gPSBzY3JhdGNoVGhpcmRDYXJ0ZXNpYW4uejsKICAgICAgICAgICAgcmVzdWx0WzExXSA9IDA7CiAgICAgICAgICAgIHJlc3VsdFsxMl0gPSBvcmlnaW4ueDsKICAgICAgICAgICAgcmVzdWx0WzEzXSA9IG9yaWdpbi55OwogICAgICAgICAgICByZXN1bHRbMTRdID0gb3JpZ2luLno7CiAgICAgICAgICAgIHJlc3VsdFsxNV0gPSAxOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgfTsKICAgICAgICAgIGxvY2FsRnJhbWVUb0ZpeGVkRnJhbWVDYWNoZVtoYXNoQXhpc10gPSByZXN1bHRhdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdGF0OwogICAgICB9OwogICAgICBUcmFuc2Zvcm1zLmVhc3ROb3J0aFVwVG9GaXhlZEZyYW1lID0gVHJhbnNmb3Jtcy5sb2NhbEZyYW1lVG9GaXhlZEZyYW1lR2VuZXJhdG9yKAogICAgICAgICJlYXN0IiwKICAgICAgICAibm9ydGgiCiAgICAgICk7CiAgICAgIFRyYW5zZm9ybXMubm9ydGhFYXN0RG93blRvRml4ZWRGcmFtZSA9IFRyYW5zZm9ybXMubG9jYWxGcmFtZVRvRml4ZWRGcmFtZUdlbmVyYXRvcigKICAgICAgICAibm9ydGgiLAogICAgICAgICJlYXN0IgogICAgICApOwogICAgICBUcmFuc2Zvcm1zLm5vcnRoVXBFYXN0VG9GaXhlZEZyYW1lID0gVHJhbnNmb3Jtcy5sb2NhbEZyYW1lVG9GaXhlZEZyYW1lR2VuZXJhdG9yKAogICAgICAgICJub3J0aCIsCiAgICAgICAgInVwIgogICAgICApOwogICAgICBUcmFuc2Zvcm1zLm5vcnRoV2VzdFVwVG9GaXhlZEZyYW1lID0gVHJhbnNmb3Jtcy5sb2NhbEZyYW1lVG9GaXhlZEZyYW1lR2VuZXJhdG9yKAogICAgICAgICJub3J0aCIsCiAgICAgICAgIndlc3QiCiAgICAgICk7CiAgICAgIHNjcmF0Y2hIUFJRdWF0ZXJuaW9uMiA9IG5ldyBRdWF0ZXJuaW9uX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFNjYWxlID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgxLCAxLCAxKTsKICAgICAgc2NyYXRjaEhQUk1hdHJpeDQgPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIFRyYW5zZm9ybXMuaGVhZGluZ1BpdGNoUm9sbFRvRml4ZWRGcmFtZSA9IGZ1bmN0aW9uKG9yaWdpbiwgaGVhZGluZ1BpdGNoUm9sbCwgZWxsaXBzb2lkLCBmaXhlZEZyYW1lVHJhbnNmb3JtLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIkhlYWRpbmdQaXRjaFJvbGwiLCBoZWFkaW5nUGl0Y2hSb2xsKTsKICAgICAgICBmaXhlZEZyYW1lVHJhbnNmb3JtID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgICAgICBmaXhlZEZyYW1lVHJhbnNmb3JtLAogICAgICAgICAgVHJhbnNmb3Jtcy5lYXN0Tm9ydGhVcFRvRml4ZWRGcmFtZQogICAgICAgICk7CiAgICAgICAgY29uc3QgaHByUXVhdGVybmlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tSGVhZGluZ1BpdGNoUm9sbCgKICAgICAgICAgIGhlYWRpbmdQaXRjaFJvbGwsCiAgICAgICAgICBzY3JhdGNoSFBSUXVhdGVybmlvbjIKICAgICAgICApOwogICAgICAgIGNvbnN0IGhwck1hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC5mcm9tVHJhbnNsYXRpb25RdWF0ZXJuaW9uUm90YXRpb25TY2FsZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLAogICAgICAgICAgaHByUXVhdGVybmlvbiwKICAgICAgICAgIHNjcmF0Y2hTY2FsZSwKICAgICAgICAgIHNjcmF0Y2hIUFJNYXRyaXg0CiAgICAgICAgKTsKICAgICAgICByZXN1bHQgPSBmaXhlZEZyYW1lVHJhbnNmb3JtKG9yaWdpbiwgZWxsaXBzb2lkLCByZXN1bHQpOwogICAgICAgIHJldHVybiBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHkocmVzdWx0LCBocHJNYXRyaXgsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFTlVNYXRyaXg0ID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoSFBSTWF0cml4MyA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgVHJhbnNmb3Jtcy5oZWFkaW5nUGl0Y2hSb2xsUXVhdGVybmlvbiA9IGZ1bmN0aW9uKG9yaWdpbiwgaGVhZGluZ1BpdGNoUm9sbCwgZWxsaXBzb2lkLCBmaXhlZEZyYW1lVHJhbnNmb3JtLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIkhlYWRpbmdQaXRjaFJvbGwiLCBoZWFkaW5nUGl0Y2hSb2xsKTsKICAgICAgICBjb25zdCB0cmFuc2Zvcm0yID0gVHJhbnNmb3Jtcy5oZWFkaW5nUGl0Y2hSb2xsVG9GaXhlZEZyYW1lKAogICAgICAgICAgb3JpZ2luLAogICAgICAgICAgaGVhZGluZ1BpdGNoUm9sbCwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIGZpeGVkRnJhbWVUcmFuc2Zvcm0sCiAgICAgICAgICBzY3JhdGNoRU5VTWF0cml4NAogICAgICAgICk7CiAgICAgICAgY29uc3Qgcm90YXRpb24gPSBNYXRyaXg0X2RlZmF1bHQuZ2V0TWF0cml4Myh0cmFuc2Zvcm0yLCBzY3JhdGNoSFBSTWF0cml4Myk7CiAgICAgICAgcmV0dXJuIFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tUm90YXRpb25NYXRyaXgocm90YXRpb24sIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIG5vU2NhbGUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KDEsIDEsIDEpOwogICAgICBocHJDZW50ZXJTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmZlNjcmF0Y2ggPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIGhwclRyYW5zZm9ybVNjcmF0Y2ggPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIGhwclJvdGF0aW9uU2NyYXRjaCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgaHByUXVhdGVybmlvblNjcmF0Y2ggPSBuZXcgUXVhdGVybmlvbl9kZWZhdWx0KCk7CiAgICAgIFRyYW5zZm9ybXMuZml4ZWRGcmFtZVRvSGVhZGluZ1BpdGNoUm9sbCA9IGZ1bmN0aW9uKHRyYW5zZm9ybTIsIGVsbGlwc29pZCwgZml4ZWRGcmFtZVRyYW5zZm9ybSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ0cmFuc2Zvcm0iLCB0cmFuc2Zvcm0yKTsKICAgICAgICBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgICAgICBmaXhlZEZyYW1lVHJhbnNmb3JtID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgICAgICBmaXhlZEZyYW1lVHJhbnNmb3JtLAogICAgICAgICAgVHJhbnNmb3Jtcy5lYXN0Tm9ydGhVcFRvRml4ZWRGcmFtZQogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEhlYWRpbmdQaXRjaFJvbGxfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBjZW50ZXIgPSBNYXRyaXg0X2RlZmF1bHQuZ2V0VHJhbnNsYXRpb24odHJhbnNmb3JtMiwgaHByQ2VudGVyU2NyYXRjaCk7CiAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMoY2VudGVyLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTykpIHsKICAgICAgICAgIHJlc3VsdC5oZWFkaW5nID0gMDsKICAgICAgICAgIHJlc3VsdC5waXRjaCA9IDA7CiAgICAgICAgICByZXN1bHQucm9sbCA9IDA7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBsZXQgdG9GaXhlZEZyYW1lID0gTWF0cml4NF9kZWZhdWx0LmludmVyc2VUcmFuc2Zvcm1hdGlvbigKICAgICAgICAgIGZpeGVkRnJhbWVUcmFuc2Zvcm0oY2VudGVyLCBlbGxpcHNvaWQsIGZmU2NyYXRjaCksCiAgICAgICAgICBmZlNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGxldCB0cmFuc2Zvcm1Db3B5ID0gTWF0cml4NF9kZWZhdWx0LnNldFNjYWxlKHRyYW5zZm9ybTIsIG5vU2NhbGUsIGhwclRyYW5zZm9ybVNjcmF0Y2gpOwogICAgICAgIHRyYW5zZm9ybUNvcHkgPSBNYXRyaXg0X2RlZmF1bHQuc2V0VHJhbnNsYXRpb24oCiAgICAgICAgICB0cmFuc2Zvcm1Db3B5LAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sCiAgICAgICAgICB0cmFuc2Zvcm1Db3B5CiAgICAgICAgKTsKICAgICAgICB0b0ZpeGVkRnJhbWUgPSBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHkodG9GaXhlZEZyYW1lLCB0cmFuc2Zvcm1Db3B5LCB0b0ZpeGVkRnJhbWUpOwogICAgICAgIGxldCBxdWF0ZXJuaW9uUm90YXRpb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbVJvdGF0aW9uTWF0cml4KAogICAgICAgICAgTWF0cml4NF9kZWZhdWx0LmdldE1hdHJpeDModG9GaXhlZEZyYW1lLCBocHJSb3RhdGlvblNjcmF0Y2gpLAogICAgICAgICAgaHByUXVhdGVybmlvblNjcmF0Y2gKICAgICAgICApOwogICAgICAgIHF1YXRlcm5pb25Sb3RhdGlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICBxdWF0ZXJuaW9uUm90YXRpb24sCiAgICAgICAgICBxdWF0ZXJuaW9uUm90YXRpb24KICAgICAgICApOwogICAgICAgIHJldHVybiBIZWFkaW5nUGl0Y2hSb2xsX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24ocXVhdGVybmlvblJvdGF0aW9uLCByZXN1bHQpOwogICAgICB9OwogICAgICBnbXN0Q29uc3RhbnQwID0gNiAqIDM2MDAgKyA0MSAqIDYwICsgNTAuNTQ4NDE7CiAgICAgIGdtc3RDb25zdGFudDEgPSA4NjQwMTg0ODEyODY2ZS02OwogICAgICBnbXN0Q29uc3RhbnQyID0gMC4wOTMxMDQ7CiAgICAgIGdtc3RDb25zdGFudDMgPSAtNjJlLTc7CiAgICAgIHJhdGVDb2VmID0gMTE3NzI3NTgzODQ2NjhlLTMyOwogICAgICB3Z3M4NFdSUHJlY2Vzc2luZyA9IDcyOTIxMTU4NTUzZS0xNTsKICAgICAgdHdvUGlPdmVyU2Vjb25kc0luRGF5ID0gTWF0aF9kZWZhdWx0LlRXT19QSSAvIDg2NDAwOwogICAgICBkYXRlSW5VdGMgPSBuZXcgSnVsaWFuRGF0ZV9kZWZhdWx0KCk7CiAgICAgIFRyYW5zZm9ybXMuY29tcHV0ZVRlbWVUb1BzZXVkb0ZpeGVkTWF0cml4ID0gZnVuY3Rpb24oZGF0ZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZGF0ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkYXRlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBkYXRlSW5VdGMgPSBKdWxpYW5EYXRlX2RlZmF1bHQuYWRkU2Vjb25kcygKICAgICAgICAgIGRhdGUsCiAgICAgICAgICAtSnVsaWFuRGF0ZV9kZWZhdWx0LmNvbXB1dGVUYWlNaW51c1V0YyhkYXRlKSwKICAgICAgICAgIGRhdGVJblV0YwogICAgICAgICk7CiAgICAgICAgY29uc3QgdXRjRGF5TnVtYmVyID0gZGF0ZUluVXRjLmRheU51bWJlcjsKICAgICAgICBjb25zdCB1dGNTZWNvbmRzSW50b0RheSA9IGRhdGVJblV0Yy5zZWNvbmRzT2ZEYXk7CiAgICAgICAgbGV0IHQ7CiAgICAgICAgY29uc3QgZGlmZkRheXMgPSB1dGNEYXlOdW1iZXIgLSAyNDUxNTQ1OwogICAgICAgIGlmICh1dGNTZWNvbmRzSW50b0RheSA+PSA0MzIwMCkgewogICAgICAgICAgdCA9IChkaWZmRGF5cyArIDAuNSkgLyBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuREFZU19QRVJfSlVMSUFOX0NFTlRVUlk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHQgPSAoZGlmZkRheXMgLSAwLjUpIC8gVGltZUNvbnN0YW50c19kZWZhdWx0LkRBWVNfUEVSX0pVTElBTl9DRU5UVVJZOwogICAgICAgIH0KICAgICAgICBjb25zdCBnbXN0MCA9IGdtc3RDb25zdGFudDAgKyB0ICogKGdtc3RDb25zdGFudDEgKyB0ICogKGdtc3RDb25zdGFudDIgKyB0ICogZ21zdENvbnN0YW50MykpOwogICAgICAgIGNvbnN0IGFuZ2xlID0gZ21zdDAgKiB0d29QaU92ZXJTZWNvbmRzSW5EYXkgJSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIGNvbnN0IHJhdGlvID0gd2dzODRXUlByZWNlc3NpbmcgKyByYXRlQ29lZiAqICh1dGNEYXlOdW1iZXIgLSAyNDUxNTQ1NWUtMSk7CiAgICAgICAgY29uc3Qgc2Vjb25kc1NpbmNlTWlkbmlnaHQgPSAodXRjU2Vjb25kc0ludG9EYXkgKyBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuU0VDT05EU19QRVJfREFZICogMC41KSAlIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9EQVk7CiAgICAgICAgY29uc3QgZ2hhID0gYW5nbGUgKyByYXRpbyAqIHNlY29uZHNTaW5jZU1pZG5pZ2h0OwogICAgICAgIGNvbnN0IGNvc0doYSA9IE1hdGguY29zKGdoYSk7CiAgICAgICAgY29uc3Qgc2luR2hhID0gTWF0aC5zaW4oZ2hhKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDNfZGVmYXVsdCgKICAgICAgICAgICAgY29zR2hhLAogICAgICAgICAgICBzaW5HaGEsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIC1zaW5HaGEsCiAgICAgICAgICAgIGNvc0doYSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gY29zR2hhOwogICAgICAgIHJlc3VsdFsxXSA9IC1zaW5HaGE7CiAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICByZXN1bHRbM10gPSBzaW5HaGE7CiAgICAgICAgcmVzdWx0WzRdID0gY29zR2hhOwogICAgICAgIHJlc3VsdFs1XSA9IDA7CiAgICAgICAgcmVzdWx0WzZdID0gMDsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IDE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgVHJhbnNmb3Jtcy5pYXUyMDA2WHlzRGF0YSA9IG5ldyBJYXUyMDA2WHlzRGF0YV9kZWZhdWx0KCk7CiAgICAgIFRyYW5zZm9ybXMuZWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnMgPSBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVyc19kZWZhdWx0Lk5PTkU7CiAgICAgIHR0TWludXNUYWkgPSAzMi4xODQ7CiAgICAgIGoyMDAwdHREYXlzID0gMjQ1MTU0NTsKICAgICAgVHJhbnNmb3Jtcy5wcmVsb2FkSWNyZkZpeGVkID0gZnVuY3Rpb24odGltZUludGVydmFsKSB7CiAgICAgICAgY29uc3Qgc3RhcnREYXlUVCA9IHRpbWVJbnRlcnZhbC5zdGFydC5kYXlOdW1iZXI7CiAgICAgICAgY29uc3Qgc3RhcnRTZWNvbmRUVCA9IHRpbWVJbnRlcnZhbC5zdGFydC5zZWNvbmRzT2ZEYXkgKyB0dE1pbnVzVGFpOwogICAgICAgIGNvbnN0IHN0b3BEYXlUVCA9IHRpbWVJbnRlcnZhbC5zdG9wLmRheU51bWJlcjsKICAgICAgICBjb25zdCBzdG9wU2Vjb25kVFQgPSB0aW1lSW50ZXJ2YWwuc3RvcC5zZWNvbmRzT2ZEYXkgKyB0dE1pbnVzVGFpOwogICAgICAgIHJldHVybiBUcmFuc2Zvcm1zLmlhdTIwMDZYeXNEYXRhLnByZWxvYWQoCiAgICAgICAgICBzdGFydERheVRULAogICAgICAgICAgc3RhcnRTZWNvbmRUVCwKICAgICAgICAgIHN0b3BEYXlUVCwKICAgICAgICAgIHN0b3BTZWNvbmRUVAogICAgICAgICk7CiAgICAgIH07CiAgICAgIFRyYW5zZm9ybXMuY29tcHV0ZUljcmZUb0ZpeGVkTWF0cml4ID0gZnVuY3Rpb24oZGF0ZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZGF0ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkYXRlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGZpeGVkVG9JY3JmTXR4ID0gVHJhbnNmb3Jtcy5jb21wdXRlRml4ZWRUb0ljcmZNYXRyaXgoZGF0ZSwgcmVzdWx0KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChmaXhlZFRvSWNyZk10eCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBNYXRyaXgzX2RlZmF1bHQudHJhbnNwb3NlKGZpeGVkVG9JY3JmTXR4LCByZXN1bHQpOwogICAgICB9OwogICAgICB4eXNTY3JhdGNoID0gbmV3IElhdTIwMDZYeXNTYW1wbGVfZGVmYXVsdCgwLCAwLCAwKTsKICAgICAgZW9wU2NyYXRjaCA9IG5ldyBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVyc1NhbXBsZV9kZWZhdWx0KAogICAgICAgIDAsCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIDAsCiAgICAgICAgMCwKICAgICAgICAwCiAgICAgICk7CiAgICAgIHJvdGF0aW9uMVNjcmF0Y2ggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIHJvdGF0aW9uMlNjcmF0Y2ggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIFRyYW5zZm9ybXMuY29tcHV0ZUZpeGVkVG9JY3JmTWF0cml4ID0gZnVuY3Rpb24oZGF0ZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZGF0ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkYXRlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVvcCA9IFRyYW5zZm9ybXMuZWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnMuY29tcHV0ZShkYXRlLCBlb3BTY3JhdGNoKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChlb3ApKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBjb25zdCBkYXlUVCA9IGRhdGUuZGF5TnVtYmVyOwogICAgICAgIGNvbnN0IHNlY29uZFRUID0gZGF0ZS5zZWNvbmRzT2ZEYXkgKyB0dE1pbnVzVGFpOwogICAgICAgIGNvbnN0IHh5cyA9IFRyYW5zZm9ybXMuaWF1MjAwNlh5c0RhdGEuY29tcHV0ZVh5c1JhZGlhbnMoCiAgICAgICAgICBkYXlUVCwKICAgICAgICAgIHNlY29uZFRULAogICAgICAgICAgeHlzU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoeHlzKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgY29uc3QgeCA9IHh5cy54ICsgZW9wLnhQb2xlT2Zmc2V0OwogICAgICAgIGNvbnN0IHkgPSB4eXMueSArIGVvcC55UG9sZU9mZnNldDsKICAgICAgICBjb25zdCBhMyA9IDEgLyAoMSArIE1hdGguc3FydCgxIC0geCAqIHggLSB5ICogeSkpOwogICAgICAgIGNvbnN0IHJvdGF0aW9uMSA9IHJvdGF0aW9uMVNjcmF0Y2g7CiAgICAgICAgcm90YXRpb24xWzBdID0gMSAtIGEzICogeCAqIHg7CiAgICAgICAgcm90YXRpb24xWzNdID0gLWEzICogeCAqIHk7CiAgICAgICAgcm90YXRpb24xWzZdID0geDsKICAgICAgICByb3RhdGlvbjFbMV0gPSAtYTMgKiB4ICogeTsKICAgICAgICByb3RhdGlvbjFbNF0gPSAxIC0gYTMgKiB5ICogeTsKICAgICAgICByb3RhdGlvbjFbN10gPSB5OwogICAgICAgIHJvdGF0aW9uMVsyXSA9IC14OwogICAgICAgIHJvdGF0aW9uMVs1XSA9IC15OwogICAgICAgIHJvdGF0aW9uMVs4XSA9IDEgLSBhMyAqICh4ICogeCArIHkgKiB5KTsKICAgICAgICBjb25zdCByb3RhdGlvbjIgPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVJvdGF0aW9uWigteHlzLnMsIHJvdGF0aW9uMlNjcmF0Y2gpOwogICAgICAgIGNvbnN0IG1hdHJpeFEgPSBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHkocm90YXRpb24xLCByb3RhdGlvbjIsIHJvdGF0aW9uMVNjcmF0Y2gpOwogICAgICAgIGNvbnN0IGRhdGVVdDFkYXkgPSBkYXRlLmRheU51bWJlcjsKICAgICAgICBjb25zdCBkYXRlVXQxc2VjID0gZGF0ZS5zZWNvbmRzT2ZEYXkgLSBKdWxpYW5EYXRlX2RlZmF1bHQuY29tcHV0ZVRhaU1pbnVzVXRjKGRhdGUpICsgZW9wLnV0MU1pbnVzVXRjOwogICAgICAgIGNvbnN0IGRheXNTaW5jZUoyMDAwID0gZGF0ZVV0MWRheSAtIDI0NTE1NDU7CiAgICAgICAgY29uc3QgZnJhY3Rpb25PZkRheSA9IGRhdGVVdDFzZWMgLyBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuU0VDT05EU19QRVJfREFZOwogICAgICAgIGxldCBlcmEgPSAwLjc3OTA1NzI3MzI2NCArIGZyYWN0aW9uT2ZEYXkgKyAwLjAwMjczNzgxMTkxMTM1NDQ4ICogKGRheXNTaW5jZUoyMDAwICsgZnJhY3Rpb25PZkRheSk7CiAgICAgICAgZXJhID0gZXJhICUgMSAqIE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgY29uc3QgZWFydGhSb3RhdGlvbiA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tUm90YXRpb25aKGVyYSwgcm90YXRpb24yU2NyYXRjaCk7CiAgICAgICAgY29uc3QgcGZUb0ljcmYgPSBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHkobWF0cml4USwgZWFydGhSb3RhdGlvbiwgcm90YXRpb24xU2NyYXRjaCk7CiAgICAgICAgY29uc3QgY29zeHAgPSBNYXRoLmNvcyhlb3AueFBvbGVXYW5kZXIpOwogICAgICAgIGNvbnN0IGNvc3lwID0gTWF0aC5jb3MoZW9wLnlQb2xlV2FuZGVyKTsKICAgICAgICBjb25zdCBzaW54cCA9IE1hdGguc2luKGVvcC54UG9sZVdhbmRlcik7CiAgICAgICAgY29uc3Qgc2lueXAgPSBNYXRoLnNpbihlb3AueVBvbGVXYW5kZXIpOwogICAgICAgIGxldCB0dHQgPSBkYXlUVCAtIGoyMDAwdHREYXlzICsgc2Vjb25kVFQgLyBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuU0VDT05EU19QRVJfREFZOwogICAgICAgIHR0dCAvPSAzNjUyNTsKICAgICAgICBjb25zdCBzcCA9IC00N2UtNiAqIHR0dCAqIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUgLyAzNjAwOwogICAgICAgIGNvbnN0IGNvc3NwID0gTWF0aC5jb3Moc3ApOwogICAgICAgIGNvbnN0IHNpbnNwID0gTWF0aC5zaW4oc3ApOwogICAgICAgIGNvbnN0IGZUb1BmTXR4ID0gcm90YXRpb24yU2NyYXRjaDsKICAgICAgICBmVG9QZk10eFswXSA9IGNvc3hwICogY29zc3A7CiAgICAgICAgZlRvUGZNdHhbMV0gPSBjb3N4cCAqIHNpbnNwOwogICAgICAgIGZUb1BmTXR4WzJdID0gc2lueHA7CiAgICAgICAgZlRvUGZNdHhbM10gPSAtY29zeXAgKiBzaW5zcCArIHNpbnlwICogc2lueHAgKiBjb3NzcDsKICAgICAgICBmVG9QZk10eFs0XSA9IGNvc3lwICogY29zc3AgKyBzaW55cCAqIHNpbnhwICogc2luc3A7CiAgICAgICAgZlRvUGZNdHhbNV0gPSAtc2lueXAgKiBjb3N4cDsKICAgICAgICBmVG9QZk10eFs2XSA9IC1zaW55cCAqIHNpbnNwIC0gY29zeXAgKiBzaW54cCAqIGNvc3NwOwogICAgICAgIGZUb1BmTXR4WzddID0gc2lueXAgKiBjb3NzcCAtIGNvc3lwICogc2lueHAgKiBzaW5zcDsKICAgICAgICBmVG9QZk10eFs4XSA9IGNvc3lwICogY29zeHA7CiAgICAgICAgcmV0dXJuIE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseShwZlRvSWNyZiwgZlRvUGZNdHgsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHBvaW50VG9XaW5kb3dDb29yZGluYXRlc1RlbXAgPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgIFRyYW5zZm9ybXMucG9pbnRUb1dpbmRvd0Nvb3JkaW5hdGVzID0gZnVuY3Rpb24obW9kZWxWaWV3UHJvamVjdGlvbk1hdHJpeCwgdmlld3BvcnRUcmFuc2Zvcm1hdGlvbiwgcG9pbnQsIHJlc3VsdCkgewogICAgICAgIHJlc3VsdCA9IFRyYW5zZm9ybXMucG9pbnRUb0dMV2luZG93Q29vcmRpbmF0ZXMoCiAgICAgICAgICBtb2RlbFZpZXdQcm9qZWN0aW9uTWF0cml4LAogICAgICAgICAgdmlld3BvcnRUcmFuc2Zvcm1hdGlvbiwKICAgICAgICAgIHBvaW50LAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgICByZXN1bHQueSA9IDIgKiB2aWV3cG9ydFRyYW5zZm9ybWF0aW9uWzVdIC0gcmVzdWx0Lnk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgVHJhbnNmb3Jtcy5wb2ludFRvR0xXaW5kb3dDb29yZGluYXRlcyA9IGZ1bmN0aW9uKG1vZGVsVmlld1Byb2plY3Rpb25NYXRyaXgsIHZpZXdwb3J0VHJhbnNmb3JtYXRpb24sIHBvaW50LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChtb2RlbFZpZXdQcm9qZWN0aW9uTWF0cml4KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm1vZGVsVmlld1Byb2plY3Rpb25NYXRyaXggaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZpZXdwb3J0VHJhbnNmb3JtYXRpb24pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmlld3BvcnRUcmFuc2Zvcm1hdGlvbiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9pbnQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicG9pbnQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdG1wMiA9IHBvaW50VG9XaW5kb3dDb29yZGluYXRlc1RlbXA7CiAgICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoCiAgICAgICAgICBtb2RlbFZpZXdQcm9qZWN0aW9uTWF0cml4LAogICAgICAgICAgQ2FydGVzaWFuNF9kZWZhdWx0LmZyb21FbGVtZW50cyhwb2ludC54LCBwb2ludC55LCBwb2ludC56LCAxLCB0bXAyKSwKICAgICAgICAgIHRtcDIKICAgICAgICApOwogICAgICAgIENhcnRlc2lhbjRfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHRtcDIsIDEgLyB0bXAyLncsIHRtcDIpOwogICAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKHZpZXdwb3J0VHJhbnNmb3JtYXRpb24sIHRtcDIsIHRtcDIpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUNhcnRlc2lhbjQodG1wMiwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgbm9ybWFsU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcmlnaHRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB1cFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFRyYW5zZm9ybXMucm90YXRpb25NYXRyaXhGcm9tUG9zaXRpb25WZWxvY2l0eSA9IGZ1bmN0aW9uKHBvc2l0aW9uLCB2ZWxvY2l0eSwgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwb3NpdGlvbiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmVsb2NpdHkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmVsb2NpdHkgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5vcm1hbDIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KS5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoCiAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgIG5vcm1hbFNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGxldCByaWdodCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyh2ZWxvY2l0eSwgbm9ybWFsMiwgcmlnaHRTY3JhdGNoKTsKICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24ocmlnaHQsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjYpKSB7CiAgICAgICAgICByaWdodCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YLCByaWdodCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHVwID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHJpZ2h0LCB2ZWxvY2l0eSwgdXBTY3JhdGNoKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHVwLCB1cCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHZlbG9jaXR5LCB1cCwgcmlnaHQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUocmlnaHQsIHJpZ2h0KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHJpZ2h0LCByaWdodCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSB2ZWxvY2l0eS54OwogICAgICAgIHJlc3VsdFsxXSA9IHZlbG9jaXR5Lnk7CiAgICAgICAgcmVzdWx0WzJdID0gdmVsb2NpdHkuejsKICAgICAgICByZXN1bHRbM10gPSByaWdodC54OwogICAgICAgIHJlc3VsdFs0XSA9IHJpZ2h0Lnk7CiAgICAgICAgcmVzdWx0WzVdID0gcmlnaHQuejsKICAgICAgICByZXN1bHRbNl0gPSB1cC54OwogICAgICAgIHJlc3VsdFs3XSA9IHVwLnk7CiAgICAgICAgcmVzdWx0WzhdID0gdXAuejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzd2l6emxlTWF0cml4ID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgKICAgICAgICAwLAogICAgICAgIDAsCiAgICAgICAgMSwKICAgICAgICAwLAogICAgICAgIDEsCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIDAsCiAgICAgICAgMCwKICAgICAgICAxLAogICAgICAgIDAsCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIDAsCiAgICAgICAgMCwKICAgICAgICAxCiAgICAgICk7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWMgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjNQcm9qZWN0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2VudGVyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUm90YXRpb24gPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hGcm9tRU5VID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVG9FTlUgPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIFRyYW5zZm9ybXMuYmFzaXNUbzJEID0gZnVuY3Rpb24ocHJvamVjdGlvbiwgbWF0cml4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwcm9qZWN0aW9uKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInByb2plY3Rpb24gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG1hdHJpeCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJtYXRyaXggaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyZXN1bHQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJ0Y0NlbnRlciA9IE1hdHJpeDRfZGVmYXVsdC5nZXRUcmFuc2xhdGlvbihtYXRyaXgsIHNjcmF0Y2hDZW50ZXIpOwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHByb2plY3Rpb24uZWxsaXBzb2lkOwogICAgICAgIGxldCBwcm9qZWN0ZWRQb3NpdGlvbjsKICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhydGNDZW50ZXIsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSkgewogICAgICAgICAgcHJvamVjdGVkUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLAogICAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuM1Byb2plY3Rpb24KICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IGNhcnRvZ3JhcGhpYzIgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgICAgIHJ0Y0NlbnRlciwKICAgICAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYwogICAgICAgICAgKTsKICAgICAgICAgIHByb2plY3RlZFBvc2l0aW9uID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgICBjYXJ0b2dyYXBoaWMyLAogICAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuM1Byb2plY3Rpb24KICAgICAgICAgICk7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUVsZW1lbnRzKAogICAgICAgICAgICBwcm9qZWN0ZWRQb3NpdGlvbi56LAogICAgICAgICAgICBwcm9qZWN0ZWRQb3NpdGlvbi54LAogICAgICAgICAgICBwcm9qZWN0ZWRQb3NpdGlvbi55LAogICAgICAgICAgICBwcm9qZWN0ZWRQb3NpdGlvbgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZnJvbUVOVSA9IFRyYW5zZm9ybXMuZWFzdE5vcnRoVXBUb0ZpeGVkRnJhbWUoCiAgICAgICAgICBydGNDZW50ZXIsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBzY3JhdGNoRnJvbUVOVQogICAgICAgICk7CiAgICAgICAgY29uc3QgdG9FTlUgPSBNYXRyaXg0X2RlZmF1bHQuaW52ZXJzZVRyYW5zZm9ybWF0aW9uKGZyb21FTlUsIHNjcmF0Y2hUb0VOVSk7CiAgICAgICAgY29uc3Qgcm90YXRpb24gPSBNYXRyaXg0X2RlZmF1bHQuZ2V0TWF0cml4MyhtYXRyaXgsIHNjcmF0Y2hSb3RhdGlvbik7CiAgICAgICAgY29uc3QgbG9jYWwgPSBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeU1hdHJpeDModG9FTlUsIHJvdGF0aW9uLCByZXN1bHQpOwogICAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseShzd2l6emxlTWF0cml4LCBsb2NhbCwgcmVzdWx0KTsKICAgICAgICBNYXRyaXg0X2RlZmF1bHQuc2V0VHJhbnNsYXRpb24ocmVzdWx0LCBwcm9qZWN0ZWRQb3NpdGlvbiwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBUcmFuc2Zvcm1zLndnczg0VG8yRE1vZGVsTWF0cml4ID0gZnVuY3Rpb24ocHJvamVjdGlvbiwgY2VudGVyLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwcm9qZWN0aW9uKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInByb2plY3Rpb24gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNlbnRlcikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjZW50ZXIgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyZXN1bHQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHByb2plY3Rpb24uZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IGZyb21FTlUgPSBUcmFuc2Zvcm1zLmVhc3ROb3J0aFVwVG9GaXhlZEZyYW1lKAogICAgICAgICAgY2VudGVyLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgc2NyYXRjaEZyb21FTlUKICAgICAgICApOwogICAgICAgIGNvbnN0IHRvRU5VID0gTWF0cml4NF9kZWZhdWx0LmludmVyc2VUcmFuc2Zvcm1hdGlvbihmcm9tRU5VLCBzY3JhdGNoVG9FTlUpOwogICAgICAgIGNvbnN0IGNhcnRvZ3JhcGhpYzIgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgICBjZW50ZXIsCiAgICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljCiAgICAgICAgKTsKICAgICAgICBjb25zdCBwcm9qZWN0ZWRQb3NpdGlvbiA9IHByb2plY3Rpb24ucHJvamVjdCgKICAgICAgICAgIGNhcnRvZ3JhcGhpYzIsCiAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuM1Byb2plY3Rpb24KICAgICAgICApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tRWxlbWVudHMoCiAgICAgICAgICBwcm9qZWN0ZWRQb3NpdGlvbi56LAogICAgICAgICAgcHJvamVjdGVkUG9zaXRpb24ueCwKICAgICAgICAgIHByb2plY3RlZFBvc2l0aW9uLnksCiAgICAgICAgICBwcm9qZWN0ZWRQb3NpdGlvbgogICAgICAgICk7CiAgICAgICAgY29uc3QgdHJhbnNsYXRpb24yID0gTWF0cml4NF9kZWZhdWx0LmZyb21UcmFuc2xhdGlvbigKICAgICAgICAgIHByb2plY3RlZFBvc2l0aW9uLAogICAgICAgICAgc2NyYXRjaEZyb21FTlUKICAgICAgICApOwogICAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseShzd2l6emxlTWF0cml4LCB0b0VOVSwgcmVzdWx0KTsKICAgICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHkodHJhbnNsYXRpb24yLCByZXN1bHQsIHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgVHJhbnNmb3Jtc19kZWZhdWx0ID0gVHJhbnNmb3JtczsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dlb21ldHJ5LmpzCiAgZnVuY3Rpb24gR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm9wdGlvbnMuYXR0cmlidXRlcyIsIG9wdGlvbnMuYXR0cmlidXRlcyk7CiAgICB0aGlzLmF0dHJpYnV0ZXMgPSBvcHRpb25zLmF0dHJpYnV0ZXM7CiAgICB0aGlzLmluZGljZXMgPSBvcHRpb25zLmluZGljZXM7CiAgICB0aGlzLnByaW1pdGl2ZVR5cGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgb3B0aW9ucy5wcmltaXRpdmVUeXBlLAogICAgICBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTCiAgICApOwogICAgdGhpcy5ib3VuZGluZ1NwaGVyZSA9IG9wdGlvbnMuYm91bmRpbmdTcGhlcmU7CiAgICB0aGlzLmdlb21ldHJ5VHlwZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZ2VvbWV0cnlUeXBlLCBHZW9tZXRyeVR5cGVfZGVmYXVsdC5OT05FKTsKICAgIHRoaXMuYm91bmRpbmdTcGhlcmVDViA9IG9wdGlvbnMuYm91bmRpbmdTcGhlcmVDVjsKICAgIHRoaXMub2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgfQogIHZhciByZWN0YW5nbGVDZW50ZXJTY3JhdGNoLCBlbnVDZW50ZXJTY3JhdGNoLCBmaXhlZEZyYW1lVG9FbnVTY3JhdGNoLCBib3VuZGluZ1JlY3RhbmdsZVBvaW50c0NhcnRvZ3JhcGhpY1NjcmF0Y2gsIGJvdW5kaW5nUmVjdGFuZ2xlUG9pbnRzRW51U2NyYXRjaCwgcG9pbnRzMkRTY3JhdGNoLCBwb2ludEVudVNjcmF0Y2gsIGVudVJvdGF0aW9uU2NyYXRjaCwgZW51Um90YXRpb25NYXRyaXhTY3JhdGNoLCByb3RhdGlvbjJEU2NyYXRjaCwgR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9HZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9HZW9tZXRyeVR5cGUoKTsKICAgICAgaW5pdF9NYXRyaXgyKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfUXVhdGVybmlvbigpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X1RyYW5zZm9ybXMoKTsKICAgICAgR2VvbWV0cnkuY29tcHV0ZU51bWJlck9mVmVydGljZXMgPSBmdW5jdGlvbihnZW9tZXRyeSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZ2VvbWV0cnkiLCBnZW9tZXRyeSk7CiAgICAgICAgbGV0IG51bWJlck9mVmVydGljZXMgPSAtMTsKICAgICAgICBmb3IgKGNvbnN0IHByb3BlcnR5IGluIGdlb21ldHJ5LmF0dHJpYnV0ZXMpIHsKICAgICAgICAgIGlmIChnZW9tZXRyeS5hdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KHByb3BlcnR5KSAmJiBkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkuYXR0cmlidXRlc1twcm9wZXJ0eV0pICYmIGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5hdHRyaWJ1dGVzW3Byb3BlcnR5XS52YWx1ZXMpKSB7CiAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IGdlb21ldHJ5LmF0dHJpYnV0ZXNbcHJvcGVydHldOwogICAgICAgICAgICBjb25zdCBudW0gPSBhdHRyaWJ1dGUudmFsdWVzLmxlbmd0aCAvIGF0dHJpYnV0ZS5jb21wb25lbnRzUGVyQXR0cmlidXRlOwogICAgICAgICAgICBpZiAobnVtYmVyT2ZWZXJ0aWNlcyAhPT0gbnVtICYmIG51bWJlck9mVmVydGljZXMgIT09IC0xKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICAgICAiQWxsIGF0dHJpYnV0ZSBsaXN0cyBtdXN0IGhhdmUgdGhlIHNhbWUgbnVtYmVyIG9mIGF0dHJpYnV0ZXMuIgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbnVtYmVyT2ZWZXJ0aWNlcyA9IG51bTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bWJlck9mVmVydGljZXM7CiAgICAgIH07CiAgICAgIHJlY3RhbmdsZUNlbnRlclNjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgZW51Q2VudGVyU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZml4ZWRGcmFtZVRvRW51U2NyYXRjaCA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgYm91bmRpbmdSZWN0YW5nbGVQb2ludHNDYXJ0b2dyYXBoaWNTY3JhdGNoID0gWwogICAgICAgIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpLAogICAgICAgIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpLAogICAgICAgIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpCiAgICAgIF07CiAgICAgIGJvdW5kaW5nUmVjdGFuZ2xlUG9pbnRzRW51U2NyYXRjaCA9IFsKICAgICAgICBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCksCiAgICAgICAgbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpLAogICAgICAgIG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKQogICAgICBdOwogICAgICBwb2ludHMyRFNjcmF0Y2ggPSBbbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpLCBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCksIG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKV07CiAgICAgIHBvaW50RW51U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZW51Um90YXRpb25TY3JhdGNoID0gbmV3IFF1YXRlcm5pb25fZGVmYXVsdCgpOwogICAgICBlbnVSb3RhdGlvbk1hdHJpeFNjcmF0Y2ggPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIHJvdGF0aW9uMkRTY3JhdGNoID0gbmV3IE1hdHJpeDJfZGVmYXVsdCgpOwogICAgICBHZW9tZXRyeS5fdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50cyA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgc3RSb3RhdGlvbiwgZWxsaXBzb2lkLCBib3VuZGluZ1JlY3RhbmdsZSkgewogICAgICAgIGxldCBpOwogICAgICAgIGNvbnN0IHJlY3RhbmdsZUNlbnRlciA9IFJlY3RhbmdsZV9kZWZhdWx0LmNlbnRlcigKICAgICAgICAgIGJvdW5kaW5nUmVjdGFuZ2xlLAogICAgICAgICAgcmVjdGFuZ2xlQ2VudGVyU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3QgZW51Q2VudGVyID0gQ2FydG9ncmFwaGljX2RlZmF1bHQudG9DYXJ0ZXNpYW4oCiAgICAgICAgICByZWN0YW5nbGVDZW50ZXIsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBlbnVDZW50ZXJTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBlbnVUb0ZpeGVkRnJhbWUgPSBUcmFuc2Zvcm1zX2RlZmF1bHQuZWFzdE5vcnRoVXBUb0ZpeGVkRnJhbWUoCiAgICAgICAgICBlbnVDZW50ZXIsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBmaXhlZEZyYW1lVG9FbnVTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBmaXhlZEZyYW1lVG9FbnUgPSBNYXRyaXg0X2RlZmF1bHQuaW52ZXJzZSgKICAgICAgICAgIGVudVRvRml4ZWRGcmFtZSwKICAgICAgICAgIGZpeGVkRnJhbWVUb0VudVNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IGJvdW5kaW5nUG9pbnRzRW51ID0gYm91bmRpbmdSZWN0YW5nbGVQb2ludHNFbnVTY3JhdGNoOwogICAgICAgIGNvbnN0IGJvdW5kaW5nUG9pbnRzQ2FydG8gPSBib3VuZGluZ1JlY3RhbmdsZVBvaW50c0NhcnRvZ3JhcGhpY1NjcmF0Y2g7CiAgICAgICAgYm91bmRpbmdQb2ludHNDYXJ0b1swXS5sb25naXR1ZGUgPSBib3VuZGluZ1JlY3RhbmdsZS53ZXN0OwogICAgICAgIGJvdW5kaW5nUG9pbnRzQ2FydG9bMF0ubGF0aXR1ZGUgPSBib3VuZGluZ1JlY3RhbmdsZS5zb3V0aDsKICAgICAgICBib3VuZGluZ1BvaW50c0NhcnRvWzFdLmxvbmdpdHVkZSA9IGJvdW5kaW5nUmVjdGFuZ2xlLndlc3Q7CiAgICAgICAgYm91bmRpbmdQb2ludHNDYXJ0b1sxXS5sYXRpdHVkZSA9IGJvdW5kaW5nUmVjdGFuZ2xlLm5vcnRoOwogICAgICAgIGJvdW5kaW5nUG9pbnRzQ2FydG9bMl0ubG9uZ2l0dWRlID0gYm91bmRpbmdSZWN0YW5nbGUuZWFzdDsKICAgICAgICBib3VuZGluZ1BvaW50c0NhcnRvWzJdLmxhdGl0dWRlID0gYm91bmRpbmdSZWN0YW5nbGUuc291dGg7CiAgICAgICAgbGV0IHBvc0VudSA9IHBvaW50RW51U2NyYXRjaDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgMzsgaSsrKSB7CiAgICAgICAgICBDYXJ0b2dyYXBoaWNfZGVmYXVsdC50b0NhcnRlc2lhbihib3VuZGluZ1BvaW50c0NhcnRvW2ldLCBlbGxpcHNvaWQsIHBvc0VudSk7CiAgICAgICAgICBwb3NFbnUgPSBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50QXNWZWN0b3IoZml4ZWRGcmFtZVRvRW51LCBwb3NFbnUsIHBvc0VudSk7CiAgICAgICAgICBib3VuZGluZ1BvaW50c0VudVtpXS54ID0gcG9zRW51Lng7CiAgICAgICAgICBib3VuZGluZ1BvaW50c0VudVtpXS55ID0gcG9zRW51Lnk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJvdGF0aW9uID0gUXVhdGVybmlvbl9kZWZhdWx0LmZyb21BeGlzQW5nbGUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9aLAogICAgICAgICAgLXN0Um90YXRpb24sCiAgICAgICAgICBlbnVSb3RhdGlvblNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IHRleHR1cmVNYXRyaXggPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24oCiAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgIGVudVJvdGF0aW9uTWF0cml4U2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zTGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBsZXQgZW51TWluWCA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgICAgICBsZXQgZW51TWluWSA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgICAgICBsZXQgZW51TWF4WCA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgICAgICBsZXQgZW51TWF4WSA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcG9zaXRpb25zTGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHBvc0VudSA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnRBc1ZlY3RvcigKICAgICAgICAgICAgZml4ZWRGcmFtZVRvRW51LAogICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgIHBvc0VudQogICAgICAgICAgKTsKICAgICAgICAgIHBvc0VudSA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKHRleHR1cmVNYXRyaXgsIHBvc0VudSwgcG9zRW51KTsKICAgICAgICAgIGVudU1pblggPSBNYXRoLm1pbihlbnVNaW5YLCBwb3NFbnUueCk7CiAgICAgICAgICBlbnVNaW5ZID0gTWF0aC5taW4oZW51TWluWSwgcG9zRW51LnkpOwogICAgICAgICAgZW51TWF4WCA9IE1hdGgubWF4KGVudU1heFgsIHBvc0VudS54KTsKICAgICAgICAgIGVudU1heFkgPSBNYXRoLm1heChlbnVNYXhZLCBwb3NFbnUueSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHRvRGVzaXJlZEluQ29tcHV0ZWQgPSBNYXRyaXgyX2RlZmF1bHQuZnJvbVJvdGF0aW9uKAogICAgICAgICAgc3RSb3RhdGlvbiwKICAgICAgICAgIHJvdGF0aW9uMkRTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBwb2ludHMyRCA9IHBvaW50czJEU2NyYXRjaDsKICAgICAgICBwb2ludHMyRFswXS54ID0gZW51TWluWDsKICAgICAgICBwb2ludHMyRFswXS55ID0gZW51TWluWTsKICAgICAgICBwb2ludHMyRFsxXS54ID0gZW51TWluWDsKICAgICAgICBwb2ludHMyRFsxXS55ID0gZW51TWF4WTsKICAgICAgICBwb2ludHMyRFsyXS54ID0gZW51TWF4WDsKICAgICAgICBwb2ludHMyRFsyXS55ID0gZW51TWluWTsKICAgICAgICBjb25zdCBib3VuZGluZ0VudU1pbiA9IGJvdW5kaW5nUG9pbnRzRW51WzBdOwogICAgICAgIGNvbnN0IGJvdW5kaW5nUG9pbnRzV2lkdGggPSBib3VuZGluZ1BvaW50c0VudVsyXS54IC0gYm91bmRpbmdFbnVNaW4ueDsKICAgICAgICBjb25zdCBib3VuZGluZ1BvaW50c0hlaWdodCA9IGJvdW5kaW5nUG9pbnRzRW51WzFdLnkgLSBib3VuZGluZ0VudU1pbi55OwogICAgICAgIGZvciAoaSA9IDA7IGkgPCAzOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHBvaW50MkQgPSBwb2ludHMyRFtpXTsKICAgICAgICAgIE1hdHJpeDJfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKHRvRGVzaXJlZEluQ29tcHV0ZWQsIHBvaW50MkQsIHBvaW50MkQpOwogICAgICAgICAgcG9pbnQyRC54ID0gKHBvaW50MkQueCAtIGJvdW5kaW5nRW51TWluLngpIC8gYm91bmRpbmdQb2ludHNXaWR0aDsKICAgICAgICAgIHBvaW50MkQueSA9IChwb2ludDJELnkgLSBib3VuZGluZ0VudU1pbi55KSAvIGJvdW5kaW5nUG9pbnRzSGVpZ2h0OwogICAgICAgIH0KICAgICAgICBjb25zdCBtaW5YWUNvcm5lciA9IHBvaW50czJEWzBdOwogICAgICAgIGNvbnN0IG1heFlDb3JuZXIgPSBwb2ludHMyRFsxXTsKICAgICAgICBjb25zdCBtYXhYQ29ybmVyID0gcG9pbnRzMkRbMl07CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IEFycmF5KDYpOwogICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrKG1pblhZQ29ybmVyLCByZXN1bHQpOwogICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrKG1heFlDb3JuZXIsIHJlc3VsdCwgMik7CiAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0LnBhY2sobWF4WENvcm5lciwgcmVzdWx0LCA0KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBHZW9tZXRyeV9kZWZhdWx0ID0gR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9HZW9tZXRyeUF0dHJpYnV0ZS5qcwogIGZ1bmN0aW9uIEdlb21ldHJ5QXR0cmlidXRlKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5jb21wb25lbnREYXRhdHlwZSkpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMuY29tcG9uZW50RGF0YXR5cGUgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvcHRpb25zLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGUpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGUgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICBpZiAob3B0aW9ucy5jb21wb25lbnRzUGVyQXR0cmlidXRlIDwgMSB8fCBvcHRpb25zLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGUgPiA0KSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJvcHRpb25zLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGUgbXVzdCBiZSBiZXR3ZWVuIDEgYW5kIDQuIgogICAgICApOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy52YWx1ZXMpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnZhbHVlcyBpcyByZXF1aXJlZC4iKTsKICAgIH0KICAgIHRoaXMuY29tcG9uZW50RGF0YXR5cGUgPSBvcHRpb25zLmNvbXBvbmVudERhdGF0eXBlOwogICAgdGhpcy5jb21wb25lbnRzUGVyQXR0cmlidXRlID0gb3B0aW9ucy5jb21wb25lbnRzUGVyQXR0cmlidXRlOwogICAgdGhpcy5ub3JtYWxpemUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm5vcm1hbGl6ZSwgZmFsc2UpOwogICAgdGhpcy52YWx1ZXMgPSBvcHRpb25zLnZhbHVlczsKICB9CiAgdmFyIEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQ7CiAgdmFyIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dlb21ldHJ5QXR0cmlidXRlLmpzIigpIHsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCA9IEdlb21ldHJ5QXR0cmlidXRlOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvbWV0cnlBdHRyaWJ1dGVzLmpzCiAgZnVuY3Rpb24gR2VvbWV0cnlBdHRyaWJ1dGVzKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgdGhpcy5wb3NpdGlvbiA9IG9wdGlvbnMucG9zaXRpb247CiAgICB0aGlzLm5vcm1hbCA9IG9wdGlvbnMubm9ybWFsOwogICAgdGhpcy5zdCA9IG9wdGlvbnMuc3Q7CiAgICB0aGlzLmJpdGFuZ2VudCA9IG9wdGlvbnMuYml0YW5nZW50OwogICAgdGhpcy50YW5nZW50ID0gb3B0aW9ucy50YW5nZW50OwogICAgdGhpcy5jb2xvciA9IG9wdGlvbnMuY29sb3I7CiAgfQogIHZhciBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdDsKICB2YXIgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dlb21ldHJ5QXR0cmlidXRlcy5qcyIoKSB7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0ID0gR2VvbWV0cnlBdHRyaWJ1dGVzOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1NjZW5lL0F0dHJpYnV0ZVR5cGUuanMKICB2YXIgQXR0cmlidXRlVHlwZSwgQXR0cmlidXRlVHlwZV9kZWZhdWx0OwogIHZhciBpbml0X0F0dHJpYnV0ZVR5cGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9TY2VuZS9BdHRyaWJ1dGVUeXBlLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRlc2lhbjQoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfTWF0cml4MigpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIEF0dHJpYnV0ZVR5cGUgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIGF0dHJpYnV0ZSBpcyBhIHNpbmdsZSBjb21wb25lbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7c3RyaW5nfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFNDQUxBUjogIlNDQUxBUiIsCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIGF0dHJpYnV0ZSBpcyBhIHR3by1jb21wb25lbnQgdmVjdG9yLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge3N0cmluZ30KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBWRUMyOiAiVkVDMiIsCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIGF0dHJpYnV0ZSBpcyBhIHRocmVlLWNvbXBvbmVudCB2ZWN0b3IuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7c3RyaW5nfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFZFQzM6ICJWRUMzIiwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgYXR0cmlidXRlIGlzIGEgZm91ci1jb21wb25lbnQgdmVjdG9yLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge3N0cmluZ30KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBWRUM0OiAiVkVDNCIsCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIGF0dHJpYnV0ZSBpcyBhIDJ4MiBtYXRyaXguCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7c3RyaW5nfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIE1BVDI6ICJNQVQyIiwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgYXR0cmlidXRlIGlzIGEgM3gzIG1hdHJpeC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtzdHJpbmd9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgTUFUMzogIk1BVDMiLAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBhdHRyaWJ1dGUgaXMgYSA0eDQgbWF0cml4LgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge3N0cmluZ30KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBNQVQ0OiAiTUFUNCIKICAgICAgfTsKICAgICAgQXR0cmlidXRlVHlwZS5nZXRNYXRoVHlwZSA9IGZ1bmN0aW9uKGF0dHJpYnV0ZVR5cGUpIHsKICAgICAgICBzd2l0Y2ggKGF0dHJpYnV0ZVR5cGUpIHsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5TQ0FMQVI6CiAgICAgICAgICAgIHJldHVybiBOdW1iZXI7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuVkVDMjoKICAgICAgICAgICAgcmV0dXJuIENhcnRlc2lhbjJfZGVmYXVsdDsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5WRUMzOgogICAgICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0OwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLlZFQzQ6CiAgICAgICAgICAgIHJldHVybiBDYXJ0ZXNpYW40X2RlZmF1bHQ7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuTUFUMjoKICAgICAgICAgICAgcmV0dXJuIE1hdHJpeDJfZGVmYXVsdDsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5NQVQzOgogICAgICAgICAgICByZXR1cm4gTWF0cml4M19kZWZhdWx0OwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLk1BVDQ6CiAgICAgICAgICAgIHJldHVybiBNYXRyaXg0X2RlZmF1bHQ7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXR0cmlidXRlVHlwZSBpcyBub3QgYSB2YWxpZCB2YWx1ZS4iKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZVR5cGUuZ2V0TnVtYmVyT2ZDb21wb25lbnRzID0gZnVuY3Rpb24oYXR0cmlidXRlVHlwZSkgewogICAgICAgIHN3aXRjaCAoYXR0cmlidXRlVHlwZSkgewogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLlNDQUxBUjoKICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuVkVDMjoKICAgICAgICAgICAgcmV0dXJuIDI7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuVkVDMzoKICAgICAgICAgICAgcmV0dXJuIDM7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuVkVDNDoKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5NQVQyOgogICAgICAgICAgICByZXR1cm4gNDsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5NQVQzOgogICAgICAgICAgICByZXR1cm4gOTsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5NQVQ0OgogICAgICAgICAgICByZXR1cm4gMTY7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXR0cmlidXRlVHlwZSBpcyBub3QgYSB2YWxpZCB2YWx1ZS4iKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZVR5cGUuZ2V0QXR0cmlidXRlTG9jYXRpb25Db3VudCA9IGZ1bmN0aW9uKGF0dHJpYnV0ZVR5cGUpIHsKICAgICAgICBzd2l0Y2ggKGF0dHJpYnV0ZVR5cGUpIHsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5TQ0FMQVI6CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuVkVDMjoKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5WRUMzOgogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLlZFQzQ6CiAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLk1BVDI6CiAgICAgICAgICAgIHJldHVybiAyOwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLk1BVDM6CiAgICAgICAgICAgIHJldHVybiAzOwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLk1BVDQ6CiAgICAgICAgICAgIHJldHVybiA0OwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImF0dHJpYnV0ZVR5cGUgaXMgbm90IGEgdmFsaWQgdmFsdWUuIik7CiAgICAgICAgfQogICAgICB9OwogICAgICBBdHRyaWJ1dGVUeXBlLmdldEdsc2xUeXBlID0gZnVuY3Rpb24oYXR0cmlidXRlVHlwZSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLnN0cmluZygiYXR0cmlidXRlVHlwZSIsIGF0dHJpYnV0ZVR5cGUpOwogICAgICAgIHN3aXRjaCAoYXR0cmlidXRlVHlwZSkgewogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLlNDQUxBUjoKICAgICAgICAgICAgcmV0dXJuICJmbG9hdCI7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuVkVDMjoKICAgICAgICAgICAgcmV0dXJuICJ2ZWMyIjsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5WRUMzOgogICAgICAgICAgICByZXR1cm4gInZlYzMiOwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLlZFQzQ6CiAgICAgICAgICAgIHJldHVybiAidmVjNCI7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuTUFUMjoKICAgICAgICAgICAgcmV0dXJuICJtYXQyIjsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5NQVQzOgogICAgICAgICAgICByZXR1cm4gIm1hdDMiOwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLk1BVDQ6CiAgICAgICAgICAgIHJldHVybiAibWF0NCI7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXR0cmlidXRlVHlwZSBpcyBub3QgYSB2YWxpZCB2YWx1ZS4iKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZVR5cGVfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoQXR0cmlidXRlVHlwZSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9BdHRyaWJ1dGVDb21wcmVzc2lvbi5qcwogIGZ1bmN0aW9uIGZvcmNlVWludDgodmFsdWUpIHsKICAgIHVpbnQ4Rm9yY2VBcnJheVswXSA9IHZhbHVlOwogICAgcmV0dXJuIHVpbnQ4Rm9yY2VBcnJheVswXTsKICB9CiAgZnVuY3Rpb24gemlnWmFnRGVjb2RlKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgPj4gMSBeIC0odmFsdWUgJiAxKTsKICB9CiAgdmFyIFJJR0hUX1NISUZULCBMRUZUX1NISUZULCBBdHRyaWJ1dGVDb21wcmVzc2lvbiwgb2N0RW5jb2RlU2NyYXRjaCwgdWludDhGb3JjZUFycmF5LCBzY3JhdGNoRW5jb2RlQ2FydDIsIEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQ7CiAgdmFyIGluaXRfQXR0cmlidXRlQ29tcHJlc3Npb24gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0F0dHJpYnV0ZUNvbXByZXNzaW9uLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfQXR0cmlidXRlVHlwZSgpOwogICAgICBSSUdIVF9TSElGVCA9IDEgLyAyNTY7CiAgICAgIExFRlRfU0hJRlQgPSAyNTY7CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uID0ge307CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdEVuY29kZUluUmFuZ2UgPSBmdW5jdGlvbih2ZWN0b3IsIHJhbmdlTWF4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInZlY3RvciIsIHZlY3Rvcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IG1hZ1NxdWFyZWQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCh2ZWN0b3IpOwogICAgICAgIGlmIChNYXRoLmFicyhtYWdTcXVhcmVkIC0gMSkgPiBNYXRoX2RlZmF1bHQuRVBTSUxPTjYpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2ZWN0b3IgbXVzdCBiZSBub3JtYWxpemVkLiIpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IHZlY3Rvci54IC8gKE1hdGguYWJzKHZlY3Rvci54KSArIE1hdGguYWJzKHZlY3Rvci55KSArIE1hdGguYWJzKHZlY3Rvci56KSk7CiAgICAgICAgcmVzdWx0LnkgPSB2ZWN0b3IueSAvIChNYXRoLmFicyh2ZWN0b3IueCkgKyBNYXRoLmFicyh2ZWN0b3IueSkgKyBNYXRoLmFicyh2ZWN0b3IueikpOwogICAgICAgIGlmICh2ZWN0b3IueiA8IDApIHsKICAgICAgICAgIGNvbnN0IHggPSByZXN1bHQueDsKICAgICAgICAgIGNvbnN0IHkgPSByZXN1bHQueTsKICAgICAgICAgIHJlc3VsdC54ID0gKDEgLSBNYXRoLmFicyh5KSkgKiBNYXRoX2RlZmF1bHQuc2lnbk5vdFplcm8oeCk7CiAgICAgICAgICByZXN1bHQueSA9ICgxIC0gTWF0aC5hYnMoeCkpICogTWF0aF9kZWZhdWx0LnNpZ25Ob3RaZXJvKHkpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IE1hdGhfZGVmYXVsdC50b1NOb3JtKHJlc3VsdC54LCByYW5nZU1heCk7CiAgICAgICAgcmVzdWx0LnkgPSBNYXRoX2RlZmF1bHQudG9TTm9ybShyZXN1bHQueSwgcmFuZ2VNYXgpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdEVuY29kZSA9IGZ1bmN0aW9uKHZlY3RvciwgcmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdEVuY29kZUluUmFuZ2UodmVjdG9yLCAyNTUsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIG9jdEVuY29kZVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIHVpbnQ4Rm9yY2VBcnJheSA9IG5ldyBVaW50OEFycmF5KDEpOwogICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3RFbmNvZGVUb0NhcnRlc2lhbjQgPSBmdW5jdGlvbih2ZWN0b3IsIHJlc3VsdCkgewogICAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdEVuY29kZUluUmFuZ2UodmVjdG9yLCA2NTUzNSwgb2N0RW5jb2RlU2NyYXRjaCk7CiAgICAgICAgcmVzdWx0LnggPSBmb3JjZVVpbnQ4KG9jdEVuY29kZVNjcmF0Y2gueCAqIFJJR0hUX1NISUZUKTsKICAgICAgICByZXN1bHQueSA9IGZvcmNlVWludDgob2N0RW5jb2RlU2NyYXRjaC54KTsKICAgICAgICByZXN1bHQueiA9IGZvcmNlVWludDgob2N0RW5jb2RlU2NyYXRjaC55ICogUklHSFRfU0hJRlQpOwogICAgICAgIHJlc3VsdC53ID0gZm9yY2VVaW50OChvY3RFbmNvZGVTY3JhdGNoLnkpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdERlY29kZUluUmFuZ2UgPSBmdW5jdGlvbih4LCB5LCByYW5nZU1heCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGlmICh4IDwgMCB8fCB4ID4gcmFuZ2VNYXggfHwgeSA8IDAgfHwgeSA+IHJhbmdlTWF4KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgYHggYW5kIHkgbXVzdCBiZSB1bnNpZ25lZCBub3JtYWxpemVkIGludGVnZXJzIGJldHdlZW4gMCBhbmQgJHtyYW5nZU1heH1gCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IE1hdGhfZGVmYXVsdC5mcm9tU05vcm0oeCwgcmFuZ2VNYXgpOwogICAgICAgIHJlc3VsdC55ID0gTWF0aF9kZWZhdWx0LmZyb21TTm9ybSh5LCByYW5nZU1heCk7CiAgICAgICAgcmVzdWx0LnogPSAxIC0gKE1hdGguYWJzKHJlc3VsdC54KSArIE1hdGguYWJzKHJlc3VsdC55KSk7CiAgICAgICAgaWYgKHJlc3VsdC56IDwgMCkgewogICAgICAgICAgY29uc3Qgb2xkVlggPSByZXN1bHQueDsKICAgICAgICAgIHJlc3VsdC54ID0gKDEgLSBNYXRoLmFicyhyZXN1bHQueSkpICogTWF0aF9kZWZhdWx0LnNpZ25Ob3RaZXJvKG9sZFZYKTsKICAgICAgICAgIHJlc3VsdC55ID0gKDEgLSBNYXRoLmFicyhvbGRWWCkpICogTWF0aF9kZWZhdWx0LnNpZ25Ob3RaZXJvKHJlc3VsdC55KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmVzdWx0LCByZXN1bHQpOwogICAgICB9OwogICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3REZWNvZGUgPSBmdW5jdGlvbih4LCB5LCByZXN1bHQpIHsKICAgICAgICByZXR1cm4gQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RGVjb2RlSW5SYW5nZSh4LCB5LCAyNTUsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdERlY29kZUZyb21DYXJ0ZXNpYW40ID0gZnVuY3Rpb24oZW5jb2RlZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJlbmNvZGVkIiwgZW5jb2RlZCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHggPSBlbmNvZGVkLng7CiAgICAgICAgY29uc3QgeSA9IGVuY29kZWQueTsKICAgICAgICBjb25zdCB6ID0gZW5jb2RlZC56OwogICAgICAgIGNvbnN0IHcgPSBlbmNvZGVkLnc7CiAgICAgICAgaWYgKHggPCAwIHx8IHggPiAyNTUgfHwgeSA8IDAgfHwgeSA+IDI1NSB8fCB6IDwgMCB8fCB6ID4gMjU1IHx8IHcgPCAwIHx8IHcgPiAyNTUpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAieCwgeSwgeiwgYW5kIHcgbXVzdCBiZSB1bnNpZ25lZCBub3JtYWxpemVkIGludGVnZXJzIGJldHdlZW4gMCBhbmQgMjU1IgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgeE9jdDE2ID0geCAqIExFRlRfU0hJRlQgKyB5OwogICAgICAgIGNvbnN0IHlPY3QxNiA9IHogKiBMRUZUX1NISUZUICsgdzsKICAgICAgICByZXR1cm4gQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RGVjb2RlSW5SYW5nZSh4T2N0MTYsIHlPY3QxNiwgNjU1MzUsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdFBhY2tGbG9hdCA9IGZ1bmN0aW9uKGVuY29kZWQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImVuY29kZWQiLCBlbmNvZGVkKTsKICAgICAgICByZXR1cm4gMjU2ICogZW5jb2RlZC54ICsgZW5jb2RlZC55OwogICAgICB9OwogICAgICBzY3JhdGNoRW5jb2RlQ2FydDIgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdEVuY29kZUZsb2F0ID0gZnVuY3Rpb24odmVjdG9yKSB7CiAgICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RW5jb2RlKHZlY3Rvciwgc2NyYXRjaEVuY29kZUNhcnQyKTsKICAgICAgICByZXR1cm4gQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0UGFja0Zsb2F0KHNjcmF0Y2hFbmNvZGVDYXJ0Mik7CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdERlY29kZUZsb2F0ID0gZnVuY3Rpb24odmFsdWUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgY29uc3QgdGVtcCA9IHZhbHVlIC8gMjU2OwogICAgICAgIGNvbnN0IHggPSBNYXRoLmZsb29yKHRlbXApOwogICAgICAgIGNvbnN0IHkgPSAodGVtcCAtIHgpICogMjU2OwogICAgICAgIHJldHVybiBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3REZWNvZGUoeCwgeSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0UGFjayA9IGZ1bmN0aW9uKHYxMiwgdjIyLCB2MywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2MSIsIHYxMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2MiIsIHYyMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2MyIsIHYzKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgZW5jb2RlZDEgPSBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3RFbmNvZGVGbG9hdCh2MTIpOwogICAgICAgIGNvbnN0IGVuY29kZWQyID0gQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RW5jb2RlRmxvYXQodjIyKTsKICAgICAgICBjb25zdCBlbmNvZGVkMyA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdEVuY29kZSh2Mywgc2NyYXRjaEVuY29kZUNhcnQyKTsKICAgICAgICByZXN1bHQueCA9IDY1NTM2ICogZW5jb2RlZDMueCArIGVuY29kZWQxOwogICAgICAgIHJlc3VsdC55ID0gNjU1MzYgKiBlbmNvZGVkMy55ICsgZW5jb2RlZDI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0VW5wYWNrID0gZnVuY3Rpb24ocGFja2VkLCB2MTIsIHYyMiwgdjMpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInBhY2tlZCIsIHBhY2tlZCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2MSIsIHYxMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2MiIsIHYyMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2MyIsIHYzKTsKICAgICAgICBsZXQgdGVtcCA9IHBhY2tlZC54IC8gNjU1MzY7CiAgICAgICAgY29uc3QgeCA9IE1hdGguZmxvb3IodGVtcCk7CiAgICAgICAgY29uc3QgZW5jb2RlZEZsb2F0MSA9ICh0ZW1wIC0geCkgKiA2NTUzNjsKICAgICAgICB0ZW1wID0gcGFja2VkLnkgLyA2NTUzNjsKICAgICAgICBjb25zdCB5ID0gTWF0aC5mbG9vcih0ZW1wKTsKICAgICAgICBjb25zdCBlbmNvZGVkRmxvYXQyID0gKHRlbXAgLSB5KSAqIDY1NTM2OwogICAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdERlY29kZUZsb2F0KGVuY29kZWRGbG9hdDEsIHYxMik7CiAgICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RGVjb2RlRmxvYXQoZW5jb2RlZEZsb2F0MiwgdjIyKTsKICAgICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3REZWNvZGUoeCwgeSwgdjMpOwogICAgICB9OwogICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5jb21wcmVzc1RleHR1cmVDb29yZGluYXRlcyA9IGZ1bmN0aW9uKHRleHR1cmVDb29yZGluYXRlcykgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidGV4dHVyZUNvb3JkaW5hdGVzIiwgdGV4dHVyZUNvb3JkaW5hdGVzKTsKICAgICAgICBjb25zdCB4ID0gdGV4dHVyZUNvb3JkaW5hdGVzLnggKiA0MDk1IHwgMDsKICAgICAgICBjb25zdCB5ID0gdGV4dHVyZUNvb3JkaW5hdGVzLnkgKiA0MDk1IHwgMDsKICAgICAgICByZXR1cm4gNDA5NiAqIHggKyB5OwogICAgICB9OwogICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5kZWNvbXByZXNzVGV4dHVyZUNvb3JkaW5hdGVzID0gZnVuY3Rpb24oY29tcHJlc3NlZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjb21wcmVzc2VkIiwgY29tcHJlc3NlZCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHRlbXAgPSBjb21wcmVzc2VkIC8gNDA5NjsKICAgICAgICBjb25zdCB4WmVyb1RvNDA5NSA9IE1hdGguZmxvb3IodGVtcCk7CiAgICAgICAgcmVzdWx0LnggPSB4WmVyb1RvNDA5NSAvIDQwOTU7CiAgICAgICAgcmVzdWx0LnkgPSAoY29tcHJlc3NlZCAtIHhaZXJvVG80MDk1ICogNDA5NikgLyA0MDk1OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLnppZ1phZ0RlbHRhRGVjb2RlID0gZnVuY3Rpb24odUJ1ZmZlciwgdkJ1ZmZlciwgaGVpZ2h0QnVmZmVyKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ1QnVmZmVyIiwgdUJ1ZmZlcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2QnVmZmVyIiwgdkJ1ZmZlcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmVxdWFscygKICAgICAgICAgICJ1QnVmZmVyLmxlbmd0aCIsCiAgICAgICAgICAidkJ1ZmZlci5sZW5ndGgiLAogICAgICAgICAgdUJ1ZmZlci5sZW5ndGgsCiAgICAgICAgICB2QnVmZmVyLmxlbmd0aAogICAgICAgICk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChoZWlnaHRCdWZmZXIpKSB7CiAgICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZXF1YWxzKAogICAgICAgICAgICAidUJ1ZmZlci5sZW5ndGgiLAogICAgICAgICAgICAiaGVpZ2h0QnVmZmVyLmxlbmd0aCIsCiAgICAgICAgICAgIHVCdWZmZXIubGVuZ3RoLAogICAgICAgICAgICBoZWlnaHRCdWZmZXIubGVuZ3RoCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb3VudCA9IHVCdWZmZXIubGVuZ3RoOwogICAgICAgIGxldCB1MyA9IDA7CiAgICAgICAgbGV0IHYzID0gMDsKICAgICAgICBsZXQgaGVpZ2h0ID0gMDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyArK2kpIHsKICAgICAgICAgIHUzICs9IHppZ1phZ0RlY29kZSh1QnVmZmVyW2ldKTsKICAgICAgICAgIHYzICs9IHppZ1phZ0RlY29kZSh2QnVmZmVyW2ldKTsKICAgICAgICAgIHVCdWZmZXJbaV0gPSB1MzsKICAgICAgICAgIHZCdWZmZXJbaV0gPSB2MzsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaGVpZ2h0QnVmZmVyKSkgewogICAgICAgICAgICBoZWlnaHQgKz0gemlnWmFnRGVjb2RlKGhlaWdodEJ1ZmZlcltpXSk7CiAgICAgICAgICAgIGhlaWdodEJ1ZmZlcltpXSA9IGhlaWdodDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLmRlcXVhbnRpemUgPSBmdW5jdGlvbih0eXBlZEFycmF5LCBjb21wb25lbnREYXRhdHlwZSwgdHlwZSwgY291bnQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInR5cGVkQXJyYXkiLCB0eXBlZEFycmF5KTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNvbXBvbmVudERhdGF0eXBlIiwgY29tcG9uZW50RGF0YXR5cGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidHlwZSIsIHR5cGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY291bnQiLCBjb3VudCk7CiAgICAgICAgY29uc3QgY29tcG9uZW50c1BlckF0dHJpYnV0ZSA9IEF0dHJpYnV0ZVR5cGVfZGVmYXVsdC5nZXROdW1iZXJPZkNvbXBvbmVudHModHlwZSk7CiAgICAgICAgbGV0IGRpdmlzb3I7CiAgICAgICAgc3dpdGNoIChjb21wb25lbnREYXRhdHlwZSkgewogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkJZVEU6CiAgICAgICAgICAgIGRpdmlzb3IgPSAxMjc7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEU6CiAgICAgICAgICAgIGRpdmlzb3IgPSAyNTU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlNIT1JUOgogICAgICAgICAgICBkaXZpc29yID0gMzI3Njc7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX1NIT1JUOgogICAgICAgICAgICBkaXZpc29yID0gNjU1MzU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LklOVDoKICAgICAgICAgICAgZGl2aXNvciA9IDIxNDc0ODM2NDc7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0lOVDoKICAgICAgICAgICAgZGl2aXNvciA9IDQyOTQ5NjcyOTU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICAgYENhbm5vdCBkZXF1YW50aXplIGNvbXBvbmVudCBkYXRhdHlwZTogJHtjb21wb25lbnREYXRhdHlwZX1gCiAgICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGRlcXVhbnRpemVkVHlwZWRBcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkoCiAgICAgICAgICBjb3VudCAqIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUKICAgICAgICApOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnQ7IGkrKykgewogICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBjb21wb25lbnRzUGVyQXR0cmlidXRlOyBqKyspIHsKICAgICAgICAgICAgY29uc3QgaW5kZXggPSBpICogY29tcG9uZW50c1BlckF0dHJpYnV0ZSArIGo7CiAgICAgICAgICAgIGRlcXVhbnRpemVkVHlwZWRBcnJheVtpbmRleF0gPSBNYXRoLm1heCgKICAgICAgICAgICAgICB0eXBlZEFycmF5W2luZGV4XSAvIGRpdmlzb3IsCiAgICAgICAgICAgICAgLTEKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlcXVhbnRpemVkVHlwZWRBcnJheTsKICAgICAgfTsKICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24uZGVjb2RlUkdCNTY1ID0gZnVuY3Rpb24odHlwZWRBcnJheSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ0eXBlZEFycmF5IiwgdHlwZWRBcnJheSk7CiAgICAgICAgY29uc3QgZXhwZWN0ZWRMZW5ndGggPSB0eXBlZEFycmF5Lmxlbmd0aCAqIDM7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZXF1YWxzKAogICAgICAgICAgICAicmVzdWx0Lmxlbmd0aCIsCiAgICAgICAgICAgICJ0eXBlZEFycmF5Lmxlbmd0aCAqIDMiLAogICAgICAgICAgICByZXN1bHQubGVuZ3RoLAogICAgICAgICAgICBleHBlY3RlZExlbmd0aAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY291bnQgPSB0eXBlZEFycmF5Lmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgRmxvYXQzMkFycmF5KGNvdW50ICogMyk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG1hc2s1ID0gKDEgPDwgNSkgLSAxOwogICAgICAgIGNvbnN0IG1hc2s2ID0gKDEgPDwgNikgLSAxOwogICAgICAgIGNvbnN0IG5vcm1hbGl6ZTUgPSAxIC8gMzE7CiAgICAgICAgY29uc3Qgbm9ybWFsaXplNiA9IDEgLyA2MzsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgICAgIGNvbnN0IHZhbHVlID0gdHlwZWRBcnJheVtpXTsKICAgICAgICAgIGNvbnN0IHJlZCA9IHZhbHVlID4+IDExOwogICAgICAgICAgY29uc3QgZ3JlZW4gPSB2YWx1ZSA+PiA1ICYgbWFzazY7CiAgICAgICAgICBjb25zdCBibHVlID0gdmFsdWUgJiBtYXNrNTsKICAgICAgICAgIGNvbnN0IG9mZnNldCA9IDMgKiBpOwogICAgICAgICAgcmVzdWx0W29mZnNldF0gPSByZWQgKiBub3JtYWxpemU1OwogICAgICAgICAgcmVzdWx0W29mZnNldCArIDFdID0gZ3JlZW4gKiBub3JtYWxpemU2OwogICAgICAgICAgcmVzdWx0W29mZnNldCArIDJdID0gYmx1ZSAqIG5vcm1hbGl6ZTU7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQgPSBBdHRyaWJ1dGVDb21wcmVzc2lvbjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2JhcnljZW50cmljQ29vcmRpbmF0ZXMuanMKICBmdW5jdGlvbiBiYXJ5Y2VudHJpY0Nvb3JkaW5hdGVzKHBvaW50LCBwMCwgcDEsIHAyLCByZXN1bHQpIHsKICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicG9pbnQiLCBwb2ludCk7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInAwIiwgcDApOwogICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJwMSIsIHAxKTsKICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicDIiLCBwMik7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgIH0KICAgIGxldCB2MDI7CiAgICBsZXQgdjEyOwogICAgbGV0IHYyMjsKICAgIGxldCBkb3QwMDsKICAgIGxldCBkb3QwMTsKICAgIGxldCBkb3QwMjsKICAgIGxldCBkb3QxMTsKICAgIGxldCBkb3QxMjsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHAwLnopKSB7CiAgICAgIGlmIChDYXJ0ZXNpYW4yX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihwb2ludCwgcDAsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQpKSB7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YLCByZXN1bHQpOwogICAgICB9CiAgICAgIGlmIChDYXJ0ZXNpYW4yX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihwb2ludCwgcDEsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQpKSB7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9ZLCByZXN1bHQpOwogICAgICB9CiAgICAgIGlmIChDYXJ0ZXNpYW4yX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihwb2ludCwgcDIsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQpKSB7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9aLCByZXN1bHQpOwogICAgICB9CiAgICAgIHYwMiA9IENhcnRlc2lhbjJfZGVmYXVsdC5zdWJ0cmFjdChwMSwgcDAsIHNjcmF0Y2hDYXJ0ZXNpYW4xKTsKICAgICAgdjEyID0gQ2FydGVzaWFuMl9kZWZhdWx0LnN1YnRyYWN0KHAyLCBwMCwgc2NyYXRjaENhcnRlc2lhbjIpOwogICAgICB2MjIgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuc3VidHJhY3QocG9pbnQsIHAwLCBzY3JhdGNoQ2FydGVzaWFuMzIpOwogICAgICBkb3QwMCA9IENhcnRlc2lhbjJfZGVmYXVsdC5kb3QodjAyLCB2MDIpOwogICAgICBkb3QwMSA9IENhcnRlc2lhbjJfZGVmYXVsdC5kb3QodjAyLCB2MTIpOwogICAgICBkb3QwMiA9IENhcnRlc2lhbjJfZGVmYXVsdC5kb3QodjAyLCB2MjIpOwogICAgICBkb3QxMSA9IENhcnRlc2lhbjJfZGVmYXVsdC5kb3QodjEyLCB2MTIpOwogICAgICBkb3QxMiA9IENhcnRlc2lhbjJfZGVmYXVsdC5kb3QodjEyLCB2MjIpOwogICAgfSBlbHNlIHsKICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKHBvaW50LCBwMCwgTWF0aF9kZWZhdWx0LkVQU0lMT04xNCkpIHsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1gsIHJlc3VsdCk7CiAgICAgIH0KICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKHBvaW50LCBwMSwgTWF0aF9kZWZhdWx0LkVQU0lMT04xNCkpIHsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1ksIHJlc3VsdCk7CiAgICAgIH0KICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKHBvaW50LCBwMiwgTWF0aF9kZWZhdWx0LkVQU0lMT04xNCkpIHsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1osIHJlc3VsdCk7CiAgICAgIH0KICAgICAgdjAyID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHAxLCBwMCwgc2NyYXRjaENhcnRlc2lhbjEpOwogICAgICB2MTIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocDIsIHAwLCBzY3JhdGNoQ2FydGVzaWFuMik7CiAgICAgIHYyMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwb2ludCwgcDAsIHNjcmF0Y2hDYXJ0ZXNpYW4zMik7CiAgICAgIGRvdDAwID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh2MDIsIHYwMik7CiAgICAgIGRvdDAxID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh2MDIsIHYxMik7CiAgICAgIGRvdDAyID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh2MDIsIHYyMik7CiAgICAgIGRvdDExID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh2MTIsIHYxMik7CiAgICAgIGRvdDEyID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh2MTIsIHYyMik7CiAgICB9CiAgICByZXN1bHQueSA9IGRvdDExICogZG90MDIgLSBkb3QwMSAqIGRvdDEyOwogICAgcmVzdWx0LnogPSBkb3QwMCAqIGRvdDEyIC0gZG90MDEgKiBkb3QwMjsKICAgIGNvbnN0IHEgPSBkb3QwMCAqIGRvdDExIC0gZG90MDEgKiBkb3QwMTsKICAgIGlmIChxID09PSAwKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICByZXN1bHQueSAvPSBxOwogICAgcmVzdWx0LnogLz0gcTsKICAgIHJlc3VsdC54ID0gMSAtIHJlc3VsdC55IC0gcmVzdWx0Lno7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICB2YXIgc2NyYXRjaENhcnRlc2lhbjEsIHNjcmF0Y2hDYXJ0ZXNpYW4yLCBzY3JhdGNoQ2FydGVzaWFuMzIsIGJhcnljZW50cmljQ29vcmRpbmF0ZXNfZGVmYXVsdDsKICB2YXIgaW5pdF9iYXJ5Y2VudHJpY0Nvb3JkaW5hdGVzID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9iYXJ5Y2VudHJpY0Nvb3JkaW5hdGVzLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjEgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4yID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMzIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGJhcnljZW50cmljQ29vcmRpbmF0ZXNfZGVmYXVsdCA9IGJhcnljZW50cmljQ29vcmRpbmF0ZXM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbmNvZGVkQ2FydGVzaWFuMy5qcwogIGZ1bmN0aW9uIEVuY29kZWRDYXJ0ZXNpYW4zKCkgewogICAgdGhpcy5oaWdoID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKTsKICAgIHRoaXMubG93ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKTsKICB9CiAgdmFyIHNjcmF0Y2hFbmNvZGUsIGVuY29kZWRQLCBFbmNvZGVkQ2FydGVzaWFuM19kZWZhdWx0OwogIHZhciBpbml0X0VuY29kZWRDYXJ0ZXNpYW4zID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbmNvZGVkQ2FydGVzaWFuMy5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBFbmNvZGVkQ2FydGVzaWFuMy5lbmNvZGUgPSBmdW5jdGlvbih2YWx1ZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSB7CiAgICAgICAgICAgIGhpZ2g6IDAsCiAgICAgICAgICAgIGxvdzogMAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgbGV0IGRvdWJsZUhpZ2g7CiAgICAgICAgaWYgKHZhbHVlID49IDApIHsKICAgICAgICAgIGRvdWJsZUhpZ2ggPSBNYXRoLmZsb29yKHZhbHVlIC8gNjU1MzYpICogNjU1MzY7CiAgICAgICAgICByZXN1bHQuaGlnaCA9IGRvdWJsZUhpZ2g7CiAgICAgICAgICByZXN1bHQubG93ID0gdmFsdWUgLSBkb3VibGVIaWdoOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkb3VibGVIaWdoID0gTWF0aC5mbG9vcigtdmFsdWUgLyA2NTUzNikgKiA2NTUzNjsKICAgICAgICAgIHJlc3VsdC5oaWdoID0gLWRvdWJsZUhpZ2g7CiAgICAgICAgICByZXN1bHQubG93ID0gdmFsdWUgKyBkb3VibGVIaWdoOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoRW5jb2RlID0gewogICAgICAgIGhpZ2g6IDAsCiAgICAgICAgbG93OiAwCiAgICAgIH07CiAgICAgIEVuY29kZWRDYXJ0ZXNpYW4zLmZyb21DYXJ0ZXNpYW4gPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEVuY29kZWRDYXJ0ZXNpYW4zKCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGhpZ2ggPSByZXN1bHQuaGlnaDsKICAgICAgICBjb25zdCBsb3cgPSByZXN1bHQubG93OwogICAgICAgIEVuY29kZWRDYXJ0ZXNpYW4zLmVuY29kZShjYXJ0ZXNpYW4xMS54LCBzY3JhdGNoRW5jb2RlKTsKICAgICAgICBoaWdoLnggPSBzY3JhdGNoRW5jb2RlLmhpZ2g7CiAgICAgICAgbG93LnggPSBzY3JhdGNoRW5jb2RlLmxvdzsKICAgICAgICBFbmNvZGVkQ2FydGVzaWFuMy5lbmNvZGUoY2FydGVzaWFuMTEueSwgc2NyYXRjaEVuY29kZSk7CiAgICAgICAgaGlnaC55ID0gc2NyYXRjaEVuY29kZS5oaWdoOwogICAgICAgIGxvdy55ID0gc2NyYXRjaEVuY29kZS5sb3c7CiAgICAgICAgRW5jb2RlZENhcnRlc2lhbjMuZW5jb2RlKGNhcnRlc2lhbjExLnosIHNjcmF0Y2hFbmNvZGUpOwogICAgICAgIGhpZ2gueiA9IHNjcmF0Y2hFbmNvZGUuaGlnaDsKICAgICAgICBsb3cueiA9IHNjcmF0Y2hFbmNvZGUubG93OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGVuY29kZWRQID0gbmV3IEVuY29kZWRDYXJ0ZXNpYW4zKCk7CiAgICAgIEVuY29kZWRDYXJ0ZXNpYW4zLndyaXRlRWxlbWVudHMgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgY2FydGVzaWFuQXJyYXksIGluZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjYXJ0ZXNpYW5BcnJheSIsIGNhcnRlc2lhbkFycmF5KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImluZGV4IiwgaW5kZXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAwKTsKICAgICAgICBFbmNvZGVkQ2FydGVzaWFuMy5mcm9tQ2FydGVzaWFuKGNhcnRlc2lhbjExLCBlbmNvZGVkUCk7CiAgICAgICAgY29uc3QgaGlnaCA9IGVuY29kZWRQLmhpZ2g7CiAgICAgICAgY29uc3QgbG93ID0gZW5jb2RlZFAubG93OwogICAgICAgIGNhcnRlc2lhbkFycmF5W2luZGV4XSA9IGhpZ2gueDsKICAgICAgICBjYXJ0ZXNpYW5BcnJheVtpbmRleCArIDFdID0gaGlnaC55OwogICAgICAgIGNhcnRlc2lhbkFycmF5W2luZGV4ICsgMl0gPSBoaWdoLno7CiAgICAgICAgY2FydGVzaWFuQXJyYXlbaW5kZXggKyAzXSA9IGxvdy54OwogICAgICAgIGNhcnRlc2lhbkFycmF5W2luZGV4ICsgNF0gPSBsb3cueTsKICAgICAgICBjYXJ0ZXNpYW5BcnJheVtpbmRleCArIDVdID0gbG93Lno7CiAgICAgIH07CiAgICAgIEVuY29kZWRDYXJ0ZXNpYW4zX2RlZmF1bHQgPSBFbmNvZGVkQ2FydGVzaWFuMzsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0luZGV4RGF0YXR5cGUuanMKICB2YXIgSW5kZXhEYXRhdHlwZSwgSW5kZXhEYXRhdHlwZV9kZWZhdWx0OwogIHZhciBpbml0X0luZGV4RGF0YXR5cGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0luZGV4RGF0YXR5cGUuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9XZWJHTENvbnN0YW50cygpOwogICAgICBJbmRleERhdGF0eXBlID0gewogICAgICAgIC8qKgogICAgICAgICAqIDgtYml0IHVuc2lnbmVkIGJ5dGUgY29ycmVzcG9uZGluZyB0byA8Y29kZT5VTlNJR05FRF9CWVRFPC9jb2RlPiBhbmQgdGhlIHR5cGUKICAgICAgICAgKiBvZiBhbiBlbGVtZW50IGluIDxjb2RlPlVpbnQ4QXJyYXk8L2NvZGU+LgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBVTlNJR05FRF9CWVRFOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgLyoqCiAgICAgICAgICogMTYtYml0IHVuc2lnbmVkIHNob3J0IGNvcnJlc3BvbmRpbmcgdG8gPGNvZGU+VU5TSUdORURfU0hPUlQ8L2NvZGU+IGFuZCB0aGUgdHlwZQogICAgICAgICAqIG9mIGFuIGVsZW1lbnQgaW4gPGNvZGU+VWludDE2QXJyYXk8L2NvZGU+LgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBVTlNJR05FRF9TSE9SVDogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9TSE9SVCwKICAgICAgICAvKioKICAgICAgICAgKiAzMi1iaXQgdW5zaWduZWQgaW50IGNvcnJlc3BvbmRpbmcgdG8gPGNvZGU+VU5TSUdORURfSU5UPC9jb2RlPiBhbmQgdGhlIHR5cGUKICAgICAgICAgKiBvZiBhbiBlbGVtZW50IGluIDxjb2RlPlVpbnQzMkFycmF5PC9jb2RlPi4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVU5TSUdORURfSU5UOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlVOU0lHTkVEX0lOVAogICAgICB9OwogICAgICBJbmRleERhdGF0eXBlLmdldFNpemVJbkJ5dGVzID0gZnVuY3Rpb24oaW5kZXhEYXRhdHlwZSkgewogICAgICAgIHN3aXRjaCAoaW5kZXhEYXRhdHlwZSkgewogICAgICAgICAgY2FzZSBJbmRleERhdGF0eXBlLlVOU0lHTkVEX0JZVEU6CiAgICAgICAgICAgIHJldHVybiBVaW50OEFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICAgICAgY2FzZSBJbmRleERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUOgogICAgICAgICAgICByZXR1cm4gVWludDE2QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgICAgICBjYXNlIEluZGV4RGF0YXR5cGUuVU5TSUdORURfSU5UOgogICAgICAgICAgICByZXR1cm4gVWludDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgICAgfQogICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgImluZGV4RGF0YXR5cGUgaXMgcmVxdWlyZWQgYW5kIG11c3QgYmUgYSB2YWxpZCBJbmRleERhdGF0eXBlIGNvbnN0YW50LiIKICAgICAgICApOwogICAgICB9OwogICAgICBJbmRleERhdGF0eXBlLmZyb21TaXplSW5CeXRlcyA9IGZ1bmN0aW9uKHNpemVJbkJ5dGVzKSB7CiAgICAgICAgc3dpdGNoIChzaXplSW5CeXRlcykgewogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICByZXR1cm4gSW5kZXhEYXRhdHlwZS5VTlNJR05FRF9TSE9SVDsKICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgcmV0dXJuIEluZGV4RGF0YXR5cGUuVU5TSUdORURfSU5UOwogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICByZXR1cm4gSW5kZXhEYXRhdHlwZS5VTlNJR05FRF9CWVRFOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICAgIlNpemUgaW4gYnl0ZXMgY2Fubm90IGJlIG1hcHBlZCB0byBhbiBJbmRleERhdGF0eXBlIgogICAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgSW5kZXhEYXRhdHlwZS52YWxpZGF0ZSA9IGZ1bmN0aW9uKGluZGV4RGF0YXR5cGUpIHsKICAgICAgICByZXR1cm4gZGVmaW5lZF9kZWZhdWx0KGluZGV4RGF0YXR5cGUpICYmIChpbmRleERhdGF0eXBlID09PSBJbmRleERhdGF0eXBlLlVOU0lHTkVEX0JZVEUgfHwgaW5kZXhEYXRhdHlwZSA9PT0gSW5kZXhEYXRhdHlwZS5VTlNJR05FRF9TSE9SVCB8fCBpbmRleERhdGF0eXBlID09PSBJbmRleERhdGF0eXBlLlVOU0lHTkVEX0lOVCk7CiAgICAgIH07CiAgICAgIEluZGV4RGF0YXR5cGUuY3JlYXRlVHlwZWRBcnJheSA9IGZ1bmN0aW9uKG51bWJlck9mVmVydGljZXMsIGluZGljZXNMZW5ndGhPckFycmF5KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobnVtYmVyT2ZWZXJ0aWNlcykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJudW1iZXJPZlZlcnRpY2VzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAobnVtYmVyT2ZWZXJ0aWNlcyA+PSBNYXRoX2RlZmF1bHQuU0lYVFlfRk9VUl9LSUxPQllURVMpIHsKICAgICAgICAgIHJldHVybiBuZXcgVWludDMyQXJyYXkoaW5kaWNlc0xlbmd0aE9yQXJyYXkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IFVpbnQxNkFycmF5KGluZGljZXNMZW5ndGhPckFycmF5KTsKICAgICAgfTsKICAgICAgSW5kZXhEYXRhdHlwZS5jcmVhdGVUeXBlZEFycmF5RnJvbUFycmF5QnVmZmVyID0gZnVuY3Rpb24obnVtYmVyT2ZWZXJ0aWNlcywgc291cmNlQXJyYXksIGJ5dGVPZmZzZXQsIGxlbmd0aCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG51bWJlck9mVmVydGljZXMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibnVtYmVyT2ZWZXJ0aWNlcyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc291cmNlQXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgic291cmNlQXJyYXkgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJ5dGVPZmZzZXQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYnl0ZU9mZnNldCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKG51bWJlck9mVmVydGljZXMgPj0gTWF0aF9kZWZhdWx0LlNJWFRZX0ZPVVJfS0lMT0JZVEVTKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFVpbnQzMkFycmF5KHNvdXJjZUFycmF5LCBieXRlT2Zmc2V0LCBsZW5ndGgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IFVpbnQxNkFycmF5KHNvdXJjZUFycmF5LCBieXRlT2Zmc2V0LCBsZW5ndGgpOwogICAgICB9OwogICAgICBJbmRleERhdGF0eXBlLmZyb21UeXBlZEFycmF5ID0gZnVuY3Rpb24oYXJyYXkpIHsKICAgICAgICBpZiAoYXJyYXkgaW5zdGFuY2VvZiBVaW50OEFycmF5KSB7CiAgICAgICAgICByZXR1cm4gSW5kZXhEYXRhdHlwZS5VTlNJR05FRF9CWVRFOwogICAgICAgIH0KICAgICAgICBpZiAoYXJyYXkgaW5zdGFuY2VvZiBVaW50MTZBcnJheSkgewogICAgICAgICAgcmV0dXJuIEluZGV4RGF0YXR5cGUuVU5TSUdORURfU0hPUlQ7CiAgICAgICAgfQogICAgICAgIGlmIChhcnJheSBpbnN0YW5jZW9mIFVpbnQzMkFycmF5KSB7CiAgICAgICAgICByZXR1cm4gSW5kZXhEYXRhdHlwZS5VTlNJR05FRF9JTlQ7CiAgICAgICAgfQogICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgImFycmF5IG11c3QgYmUgYSBVaW50OEFycmF5LCBVaW50MTZBcnJheSwgb3IgVWludDMyQXJyYXkuIgogICAgICAgICk7CiAgICAgIH07CiAgICAgIEluZGV4RGF0YXR5cGVfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoSW5kZXhEYXRhdHlwZSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9RdWFkcmF0aWNSZWFsUG9seW5vbWlhbC5qcwogIGZ1bmN0aW9uIGFkZFdpdGhDYW5jZWxsYXRpb25DaGVjayhsZWZ0LCByaWdodCwgdG9sZXJhbmNlKSB7CiAgICBjb25zdCBkaWZmZXJlbmNlID0gbGVmdCArIHJpZ2h0OwogICAgaWYgKE1hdGhfZGVmYXVsdC5zaWduKGxlZnQpICE9PSBNYXRoX2RlZmF1bHQuc2lnbihyaWdodCkgJiYgTWF0aC5hYnMoZGlmZmVyZW5jZSAvIE1hdGgubWF4KE1hdGguYWJzKGxlZnQpLCBNYXRoLmFicyhyaWdodCkpKSA8IHRvbGVyYW5jZSkgewogICAgICByZXR1cm4gMDsKICAgIH0KICAgIHJldHVybiBkaWZmZXJlbmNlOwogIH0KICB2YXIgUXVhZHJhdGljUmVhbFBvbHlub21pYWwsIFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQ7CiAgdmFyIGluaXRfUXVhZHJhdGljUmVhbFBvbHlub21pYWwgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1F1YWRyYXRpY1JlYWxQb2x5bm9taWFsLmpzIigpIHsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgUXVhZHJhdGljUmVhbFBvbHlub21pYWwgPSB7fTsKICAgICAgUXVhZHJhdGljUmVhbFBvbHlub21pYWwuY29tcHV0ZURpc2NyaW1pbmFudCA9IGZ1bmN0aW9uKGEzLCBiLCBjKSB7CiAgICAgICAgaWYgKHR5cGVvZiBhMyAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGIgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYiBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBjICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImMgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGRpc2NyaW1pbmFudCA9IGIgKiBiIC0gNCAqIGEzICogYzsKICAgICAgICByZXR1cm4gZGlzY3JpbWluYW50OwogICAgICB9OwogICAgICBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbC5jb21wdXRlUmVhbFJvb3RzID0gZnVuY3Rpb24oYTMsIGIsIGMpIHsKICAgICAgICBpZiAodHlwZW9mIGEzICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImEgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgYiAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJiIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGMgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYyBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgbGV0IHJhdGlvOwogICAgICAgIGlmIChhMyA9PT0gMCkgewogICAgICAgICAgaWYgKGIgPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIFstYyAvIGJdOwogICAgICAgIH0gZWxzZSBpZiAoYiA9PT0gMCkgewogICAgICAgICAgaWYgKGMgPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIFswLCAwXTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGNNYWduaXR1ZGUgPSBNYXRoLmFicyhjKTsKICAgICAgICAgIGNvbnN0IGFNYWduaXR1ZGUgPSBNYXRoLmFicyhhMyk7CiAgICAgICAgICBpZiAoY01hZ25pdHVkZSA8IGFNYWduaXR1ZGUgJiYgY01hZ25pdHVkZSAvIGFNYWduaXR1ZGUgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE0KSB7CiAgICAgICAgICAgIHJldHVybiBbMCwgMF07CiAgICAgICAgICB9IGVsc2UgaWYgKGNNYWduaXR1ZGUgPiBhTWFnbml0dWRlICYmIGFNYWduaXR1ZGUgLyBjTWFnbml0dWRlIDwgTWF0aF9kZWZhdWx0LkVQU0lMT04xNCkgewogICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgICB9CiAgICAgICAgICByYXRpbyA9IC1jIC8gYTM7CiAgICAgICAgICBpZiAocmF0aW8gPCAwKSB7CiAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHJvb3QgPSBNYXRoLnNxcnQocmF0aW8pOwogICAgICAgICAgcmV0dXJuIFstcm9vdCwgcm9vdF07CiAgICAgICAgfSBlbHNlIGlmIChjID09PSAwKSB7CiAgICAgICAgICByYXRpbyA9IC1iIC8gYTM7CiAgICAgICAgICBpZiAocmF0aW8gPCAwKSB7CiAgICAgICAgICAgIHJldHVybiBbcmF0aW8sIDBdOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIFswLCByYXRpb107CiAgICAgICAgfQogICAgICAgIGNvbnN0IGIyID0gYiAqIGI7CiAgICAgICAgY29uc3QgZm91cl9hYyA9IDQgKiBhMyAqIGM7CiAgICAgICAgY29uc3QgcmFkaWNhbmQgPSBhZGRXaXRoQ2FuY2VsbGF0aW9uQ2hlY2soYjIsIC1mb3VyX2FjLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE0KTsKICAgICAgICBpZiAocmFkaWNhbmQgPCAwKSB7CiAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgfQogICAgICAgIGNvbnN0IHEgPSAtMC41ICogYWRkV2l0aENhbmNlbGxhdGlvbkNoZWNrKAogICAgICAgICAgYiwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5zaWduKGIpICogTWF0aC5zcXJ0KHJhZGljYW5kKSwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQKICAgICAgICApOwogICAgICAgIGlmIChiID4gMCkgewogICAgICAgICAgcmV0dXJuIFtxIC8gYTMsIGMgLyBxXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFtjIC8gcSwgcSAvIGEzXTsKICAgICAgfTsKICAgICAgUXVhZHJhdGljUmVhbFBvbHlub21pYWxfZGVmYXVsdCA9IFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ3ViaWNSZWFsUG9seW5vbWlhbC5qcwogIGZ1bmN0aW9uIGNvbXB1dGVSZWFsUm9vdHMoYTMsIGIsIGMsIGQpIHsKICAgIGNvbnN0IEEgPSBhMzsKICAgIGNvbnN0IEIgPSBiIC8gMzsKICAgIGNvbnN0IEMgPSBjIC8gMzsKICAgIGNvbnN0IEQgPSBkOwogICAgY29uc3QgQUMgPSBBICogQzsKICAgIGNvbnN0IEJEID0gQiAqIEQ7CiAgICBjb25zdCBCMiA9IEIgKiBCOwogICAgY29uc3QgQzIgPSBDICogQzsKICAgIGNvbnN0IGRlbHRhMSA9IEEgKiBDIC0gQjI7CiAgICBjb25zdCBkZWx0YTIgPSBBICogRCAtIEIgKiBDOwogICAgY29uc3QgZGVsdGEzID0gQiAqIEQgLSBDMjsKICAgIGNvbnN0IGRpc2NyaW1pbmFudCA9IDQgKiBkZWx0YTEgKiBkZWx0YTMgLSBkZWx0YTIgKiBkZWx0YTI7CiAgICBsZXQgdGVtcDsKICAgIGxldCB0ZW1wMTsKICAgIGlmIChkaXNjcmltaW5hbnQgPCAwKSB7CiAgICAgIGxldCBBQmFyOwogICAgICBsZXQgQ0JhcjsKICAgICAgbGV0IERCYXI7CiAgICAgIGlmIChCMiAqIEJEID49IEFDICogQzIpIHsKICAgICAgICBBQmFyID0gQTsKICAgICAgICBDQmFyID0gZGVsdGExOwogICAgICAgIERCYXIgPSAtMiAqIEIgKiBkZWx0YTEgKyBBICogZGVsdGEyOwogICAgICB9IGVsc2UgewogICAgICAgIEFCYXIgPSBEOwogICAgICAgIENCYXIgPSBkZWx0YTM7CiAgICAgICAgREJhciA9IC1EICogZGVsdGEyICsgMiAqIEMgKiBkZWx0YTM7CiAgICAgIH0KICAgICAgY29uc3QgcyA9IERCYXIgPCAwID8gLTEgOiAxOwogICAgICBjb25zdCB0ZW1wMCA9IC1zICogTWF0aC5hYnMoQUJhcikgKiBNYXRoLnNxcnQoLWRpc2NyaW1pbmFudCk7CiAgICAgIHRlbXAxID0gLURCYXIgKyB0ZW1wMDsKICAgICAgY29uc3QgeCA9IHRlbXAxIC8gMjsKICAgICAgY29uc3QgcCA9IHggPCAwID8gLU1hdGgucG93KC14LCAxIC8gMykgOiBNYXRoLnBvdyh4LCAxIC8gMyk7CiAgICAgIGNvbnN0IHEgPSB0ZW1wMSA9PT0gdGVtcDAgPyAtcCA6IC1DQmFyIC8gcDsKICAgICAgdGVtcCA9IENCYXIgPD0gMCA/IHAgKyBxIDogLURCYXIgLyAocCAqIHAgKyBxICogcSArIENCYXIpOwogICAgICBpZiAoQjIgKiBCRCA+PSBBQyAqIEMyKSB7CiAgICAgICAgcmV0dXJuIFsodGVtcCAtIEIpIC8gQV07CiAgICAgIH0KICAgICAgcmV0dXJuIFstRCAvICh0ZW1wICsgQyldOwogICAgfQogICAgY29uc3QgQ0JhckEgPSBkZWx0YTE7CiAgICBjb25zdCBEQmFyQSA9IC0yICogQiAqIGRlbHRhMSArIEEgKiBkZWx0YTI7CiAgICBjb25zdCBDQmFyRCA9IGRlbHRhMzsKICAgIGNvbnN0IERCYXJEID0gLUQgKiBkZWx0YTIgKyAyICogQyAqIGRlbHRhMzsKICAgIGNvbnN0IHNxdWFyZVJvb3RPZkRpc2NyaW1pbmFudCA9IE1hdGguc3FydChkaXNjcmltaW5hbnQpOwogICAgY29uc3QgaGFsZlNxdWFyZVJvb3RPZjMgPSBNYXRoLnNxcnQoMykgLyAyOwogICAgbGV0IHRoZXRhID0gTWF0aC5hYnMoTWF0aC5hdGFuMihBICogc3F1YXJlUm9vdE9mRGlzY3JpbWluYW50LCAtREJhckEpIC8gMyk7CiAgICB0ZW1wID0gMiAqIE1hdGguc3FydCgtQ0JhckEpOwogICAgbGV0IGNvc2luZSA9IE1hdGguY29zKHRoZXRhKTsKICAgIHRlbXAxID0gdGVtcCAqIGNvc2luZTsKICAgIGxldCB0ZW1wMyA9IHRlbXAgKiAoLWNvc2luZSAvIDIgLSBoYWxmU3F1YXJlUm9vdE9mMyAqIE1hdGguc2luKHRoZXRhKSk7CiAgICBjb25zdCBudW1lcmF0b3JMYXJnZSA9IHRlbXAxICsgdGVtcDMgPiAyICogQiA/IHRlbXAxIC0gQiA6IHRlbXAzIC0gQjsKICAgIGNvbnN0IGRlbm9taW5hdG9yTGFyZ2UgPSBBOwogICAgY29uc3Qgcm9vdDEgPSBudW1lcmF0b3JMYXJnZSAvIGRlbm9taW5hdG9yTGFyZ2U7CiAgICB0aGV0YSA9IE1hdGguYWJzKE1hdGguYXRhbjIoRCAqIHNxdWFyZVJvb3RPZkRpc2NyaW1pbmFudCwgLURCYXJEKSAvIDMpOwogICAgdGVtcCA9IDIgKiBNYXRoLnNxcnQoLUNCYXJEKTsKICAgIGNvc2luZSA9IE1hdGguY29zKHRoZXRhKTsKICAgIHRlbXAxID0gdGVtcCAqIGNvc2luZTsKICAgIHRlbXAzID0gdGVtcCAqICgtY29zaW5lIC8gMiAtIGhhbGZTcXVhcmVSb290T2YzICogTWF0aC5zaW4odGhldGEpKTsKICAgIGNvbnN0IG51bWVyYXRvclNtYWxsID0gLUQ7CiAgICBjb25zdCBkZW5vbWluYXRvclNtYWxsID0gdGVtcDEgKyB0ZW1wMyA8IDIgKiBDID8gdGVtcDEgKyBDIDogdGVtcDMgKyBDOwogICAgY29uc3Qgcm9vdDMgPSBudW1lcmF0b3JTbWFsbCAvIGRlbm9taW5hdG9yU21hbGw7CiAgICBjb25zdCBFID0gZGVub21pbmF0b3JMYXJnZSAqIGRlbm9taW5hdG9yU21hbGw7CiAgICBjb25zdCBGID0gLW51bWVyYXRvckxhcmdlICogZGVub21pbmF0b3JTbWFsbCAtIGRlbm9taW5hdG9yTGFyZ2UgKiBudW1lcmF0b3JTbWFsbDsKICAgIGNvbnN0IEcgPSBudW1lcmF0b3JMYXJnZSAqIG51bWVyYXRvclNtYWxsOwogICAgY29uc3Qgcm9vdDIgPSAoQyAqIEYgLSBCICogRykgLyAoLUIgKiBGICsgQyAqIEUpOwogICAgaWYgKHJvb3QxIDw9IHJvb3QyKSB7CiAgICAgIGlmIChyb290MSA8PSByb290MykgewogICAgICAgIGlmIChyb290MiA8PSByb290MykgewogICAgICAgICAgcmV0dXJuIFtyb290MSwgcm9vdDIsIHJvb3QzXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFtyb290MSwgcm9vdDMsIHJvb3QyXTsKICAgICAgfQogICAgICByZXR1cm4gW3Jvb3QzLCByb290MSwgcm9vdDJdOwogICAgfQogICAgaWYgKHJvb3QxIDw9IHJvb3QzKSB7CiAgICAgIHJldHVybiBbcm9vdDIsIHJvb3QxLCByb290M107CiAgICB9CiAgICBpZiAocm9vdDIgPD0gcm9vdDMpIHsKICAgICAgcmV0dXJuIFtyb290Miwgcm9vdDMsIHJvb3QxXTsKICAgIH0KICAgIHJldHVybiBbcm9vdDMsIHJvb3QyLCByb290MV07CiAgfQogIHZhciBDdWJpY1JlYWxQb2x5bm9taWFsLCBDdWJpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQ7CiAgdmFyIGluaXRfQ3ViaWNSZWFsUG9seW5vbWlhbCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ3ViaWNSZWFsUG9seW5vbWlhbC5qcyIoKSB7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9RdWFkcmF0aWNSZWFsUG9seW5vbWlhbCgpOwogICAgICBDdWJpY1JlYWxQb2x5bm9taWFsID0ge307CiAgICAgIEN1YmljUmVhbFBvbHlub21pYWwuY29tcHV0ZURpc2NyaW1pbmFudCA9IGZ1bmN0aW9uKGEzLCBiLCBjLCBkKSB7CiAgICAgICAgaWYgKHR5cGVvZiBhMyAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGIgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYiBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBjICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImMgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgZCAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhMjIgPSBhMyAqIGEzOwogICAgICAgIGNvbnN0IGIyID0gYiAqIGI7CiAgICAgICAgY29uc3QgYzIgPSBjICogYzsKICAgICAgICBjb25zdCBkMiA9IGQgKiBkOwogICAgICAgIGNvbnN0IGRpc2NyaW1pbmFudCA9IDE4ICogYTMgKiBiICogYyAqIGQgKyBiMiAqIGMyIC0gMjcgKiBhMjIgKiBkMiAtIDQgKiAoYTMgKiBjMiAqIGMgKyBiMiAqIGIgKiBkKTsKICAgICAgICByZXR1cm4gZGlzY3JpbWluYW50OwogICAgICB9OwogICAgICBDdWJpY1JlYWxQb2x5bm9taWFsLmNvbXB1dGVSZWFsUm9vdHMgPSBmdW5jdGlvbihhMywgYiwgYywgZCkgewogICAgICAgIGlmICh0eXBlb2YgYTMgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYSBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImIgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgYyAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGQgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZCBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgbGV0IHJvb3RzOwogICAgICAgIGxldCByYXRpbzsKICAgICAgICBpZiAoYTMgPT09IDApIHsKICAgICAgICAgIHJldHVybiBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0LmNvbXB1dGVSZWFsUm9vdHMoYiwgYywgZCk7CiAgICAgICAgfSBlbHNlIGlmIChiID09PSAwKSB7CiAgICAgICAgICBpZiAoYyA9PT0gMCkgewogICAgICAgICAgICBpZiAoZCA9PT0gMCkgewogICAgICAgICAgICAgIHJldHVybiBbMCwgMCwgMF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmF0aW8gPSAtZCAvIGEzOwogICAgICAgICAgICBjb25zdCByb290ID0gcmF0aW8gPCAwID8gLU1hdGgucG93KC1yYXRpbywgMSAvIDMpIDogTWF0aC5wb3cocmF0aW8sIDEgLyAzKTsKICAgICAgICAgICAgcmV0dXJuIFtyb290LCByb290LCByb290XTsKICAgICAgICAgIH0gZWxzZSBpZiAoZCA9PT0gMCkgewogICAgICAgICAgICByb290cyA9IFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQuY29tcHV0ZVJlYWxSb290cyhhMywgMCwgYyk7CiAgICAgICAgICAgIGlmIChyb290cy5MZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICByZXR1cm4gWzBdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBbcm9vdHNbMF0sIDAsIHJvb3RzWzFdXTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb21wdXRlUmVhbFJvb3RzKGEzLCAwLCBjLCBkKTsKICAgICAgICB9IGVsc2UgaWYgKGMgPT09IDApIHsKICAgICAgICAgIGlmIChkID09PSAwKSB7CiAgICAgICAgICAgIHJhdGlvID0gLWIgLyBhMzsKICAgICAgICAgICAgaWYgKHJhdGlvIDwgMCkgewogICAgICAgICAgICAgIHJldHVybiBbcmF0aW8sIDAsIDBdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBbMCwgMCwgcmF0aW9dOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbXB1dGVSZWFsUm9vdHMoYTMsIGIsIDAsIGQpOwogICAgICAgIH0gZWxzZSBpZiAoZCA9PT0gMCkgewogICAgICAgICAgcm9vdHMgPSBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0LmNvbXB1dGVSZWFsUm9vdHMoYTMsIGIsIGMpOwogICAgICAgICAgaWYgKHJvb3RzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gWzBdOwogICAgICAgICAgfSBlbHNlIGlmIChyb290c1sxXSA8PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBbcm9vdHNbMF0sIHJvb3RzWzFdLCAwXTsKICAgICAgICAgIH0gZWxzZSBpZiAocm9vdHNbMF0gPj0gMCkgewogICAgICAgICAgICByZXR1cm4gWzAsIHJvb3RzWzBdLCByb290c1sxXV07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gW3Jvb3RzWzBdLCAwLCByb290c1sxXV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBjb21wdXRlUmVhbFJvb3RzKGEzLCBiLCBjLCBkKTsKICAgICAgfTsKICAgICAgQ3ViaWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0ID0gQ3ViaWNSZWFsUG9seW5vbWlhbDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1F1YXJ0aWNSZWFsUG9seW5vbWlhbC5qcwogIGZ1bmN0aW9uIG9yaWdpbmFsKGEzLCBhMjIsIGExLCBhMCkgewogICAgY29uc3QgYTNTcXVhcmVkID0gYTMgKiBhMzsKICAgIGNvbnN0IHAgPSBhMjIgLSAzICogYTNTcXVhcmVkIC8gODsKICAgIGNvbnN0IHEgPSBhMSAtIGEyMiAqIGEzIC8gMiArIGEzU3F1YXJlZCAqIGEzIC8gODsKICAgIGNvbnN0IHIgPSBhMCAtIGExICogYTMgLyA0ICsgYTIyICogYTNTcXVhcmVkIC8gMTYgLSAzICogYTNTcXVhcmVkICogYTNTcXVhcmVkIC8gMjU2OwogICAgY29uc3QgY3ViaWNSb290cyA9IEN1YmljUmVhbFBvbHlub21pYWxfZGVmYXVsdC5jb21wdXRlUmVhbFJvb3RzKAogICAgICAxLAogICAgICAyICogcCwKICAgICAgcCAqIHAgLSA0ICogciwKICAgICAgLXEgKiBxCiAgICApOwogICAgaWYgKGN1YmljUm9vdHMubGVuZ3RoID4gMCkgewogICAgICBjb25zdCB0ZW1wID0gLWEzIC8gNDsKICAgICAgY29uc3QgaFNxdWFyZWQgPSBjdWJpY1Jvb3RzW2N1YmljUm9vdHMubGVuZ3RoIC0gMV07CiAgICAgIGlmIChNYXRoLmFicyhoU3F1YXJlZCkgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE0KSB7CiAgICAgICAgY29uc3Qgcm9vdHMgPSBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0LmNvbXB1dGVSZWFsUm9vdHMoMSwgcCwgcik7CiAgICAgICAgaWYgKHJvb3RzLmxlbmd0aCA9PT0gMikgewogICAgICAgICAgY29uc3Qgcm9vdDAgPSByb290c1swXTsKICAgICAgICAgIGNvbnN0IHJvb3QxID0gcm9vdHNbMV07CiAgICAgICAgICBsZXQgeTsKICAgICAgICAgIGlmIChyb290MCA+PSAwICYmIHJvb3QxID49IDApIHsKICAgICAgICAgICAgY29uc3QgeTAgPSBNYXRoLnNxcnQocm9vdDApOwogICAgICAgICAgICBjb25zdCB5MSA9IE1hdGguc3FydChyb290MSk7CiAgICAgICAgICAgIHJldHVybiBbdGVtcCAtIHkxLCB0ZW1wIC0geTAsIHRlbXAgKyB5MCwgdGVtcCArIHkxXTsKICAgICAgICAgIH0gZWxzZSBpZiAocm9vdDAgPj0gMCAmJiByb290MSA8IDApIHsKICAgICAgICAgICAgeSA9IE1hdGguc3FydChyb290MCk7CiAgICAgICAgICAgIHJldHVybiBbdGVtcCAtIHksIHRlbXAgKyB5XTsKICAgICAgICAgIH0gZWxzZSBpZiAocm9vdDAgPCAwICYmIHJvb3QxID49IDApIHsKICAgICAgICAgICAgeSA9IE1hdGguc3FydChyb290MSk7CiAgICAgICAgICAgIHJldHVybiBbdGVtcCAtIHksIHRlbXAgKyB5XTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIFtdOwogICAgICB9IGVsc2UgaWYgKGhTcXVhcmVkID4gMCkgewogICAgICAgIGNvbnN0IGggPSBNYXRoLnNxcnQoaFNxdWFyZWQpOwogICAgICAgIGNvbnN0IG0gPSAocCArIGhTcXVhcmVkIC0gcSAvIGgpIC8gMjsKICAgICAgICBjb25zdCBuID0gKHAgKyBoU3F1YXJlZCArIHEgLyBoKSAvIDI7CiAgICAgICAgY29uc3Qgcm9vdHMxID0gUXVhZHJhdGljUmVhbFBvbHlub21pYWxfZGVmYXVsdC5jb21wdXRlUmVhbFJvb3RzKDEsIGgsIG0pOwogICAgICAgIGNvbnN0IHJvb3RzMiA9IFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQuY29tcHV0ZVJlYWxSb290cygxLCAtaCwgbik7CiAgICAgICAgaWYgKHJvb3RzMS5sZW5ndGggIT09IDApIHsKICAgICAgICAgIHJvb3RzMVswXSArPSB0ZW1wOwogICAgICAgICAgcm9vdHMxWzFdICs9IHRlbXA7CiAgICAgICAgICBpZiAocm9vdHMyLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICByb290czJbMF0gKz0gdGVtcDsKICAgICAgICAgICAgcm9vdHMyWzFdICs9IHRlbXA7CiAgICAgICAgICAgIGlmIChyb290czFbMV0gPD0gcm9vdHMyWzBdKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFtyb290czFbMF0sIHJvb3RzMVsxXSwgcm9vdHMyWzBdLCByb290czJbMV1dOwogICAgICAgICAgICB9IGVsc2UgaWYgKHJvb3RzMlsxXSA8PSByb290czFbMF0pIHsKICAgICAgICAgICAgICByZXR1cm4gW3Jvb3RzMlswXSwgcm9vdHMyWzFdLCByb290czFbMF0sIHJvb3RzMVsxXV07CiAgICAgICAgICAgIH0gZWxzZSBpZiAocm9vdHMxWzBdID49IHJvb3RzMlswXSAmJiByb290czFbMV0gPD0gcm9vdHMyWzFdKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFtyb290czJbMF0sIHJvb3RzMVswXSwgcm9vdHMxWzFdLCByb290czJbMV1dOwogICAgICAgICAgICB9IGVsc2UgaWYgKHJvb3RzMlswXSA+PSByb290czFbMF0gJiYgcm9vdHMyWzFdIDw9IHJvb3RzMVsxXSkgewogICAgICAgICAgICAgIHJldHVybiBbcm9vdHMxWzBdLCByb290czJbMF0sIHJvb3RzMlsxXSwgcm9vdHMxWzFdXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyb290czFbMF0gPiByb290czJbMF0gJiYgcm9vdHMxWzBdIDwgcm9vdHMyWzFdKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFtyb290czJbMF0sIHJvb3RzMVswXSwgcm9vdHMyWzFdLCByb290czFbMV1dOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBbcm9vdHMxWzBdLCByb290czJbMF0sIHJvb3RzMVsxXSwgcm9vdHMyWzFdXTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByb290czE7CiAgICAgICAgfQogICAgICAgIGlmIChyb290czIubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICByb290czJbMF0gKz0gdGVtcDsKICAgICAgICAgIHJvb3RzMlsxXSArPSB0ZW1wOwogICAgICAgICAgcmV0dXJuIHJvb3RzMjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFtdOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gW107CiAgfQogIGZ1bmN0aW9uIG5ldW1hcmsoYTMsIGEyMiwgYTEsIGEwKSB7CiAgICBjb25zdCBhMVNxdWFyZWQgPSBhMSAqIGExOwogICAgY29uc3QgYTJTcXVhcmVkID0gYTIyICogYTIyOwogICAgY29uc3QgYTNTcXVhcmVkID0gYTMgKiBhMzsKICAgIGNvbnN0IHAgPSAtMiAqIGEyMjsKICAgIGNvbnN0IHEgPSBhMSAqIGEzICsgYTJTcXVhcmVkIC0gNCAqIGEwOwogICAgY29uc3QgciA9IGEzU3F1YXJlZCAqIGEwIC0gYTEgKiBhMjIgKiBhMyArIGExU3F1YXJlZDsKICAgIGNvbnN0IGN1YmljUm9vdHMgPSBDdWJpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQuY29tcHV0ZVJlYWxSb290cygxLCBwLCBxLCByKTsKICAgIGlmIChjdWJpY1Jvb3RzLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgeSA9IGN1YmljUm9vdHNbMF07CiAgICAgIGNvbnN0IHRlbXAgPSBhMjIgLSB5OwogICAgICBjb25zdCB0ZW1wU3F1YXJlZCA9IHRlbXAgKiB0ZW1wOwogICAgICBjb25zdCBnMSA9IGEzIC8gMjsKICAgICAgY29uc3QgaDEgPSB0ZW1wIC8gMjsKICAgICAgY29uc3QgbSA9IHRlbXBTcXVhcmVkIC0gNCAqIGEwOwogICAgICBjb25zdCBtRXJyb3IgPSB0ZW1wU3F1YXJlZCArIDQgKiBNYXRoLmFicyhhMCk7CiAgICAgIGNvbnN0IG4gPSBhM1NxdWFyZWQgLSA0ICogeTsKICAgICAgY29uc3QgbkVycm9yID0gYTNTcXVhcmVkICsgNCAqIE1hdGguYWJzKHkpOwogICAgICBsZXQgZzI7CiAgICAgIGxldCBoMjsKICAgICAgaWYgKHkgPCAwIHx8IG0gKiBuRXJyb3IgPCBuICogbUVycm9yKSB7CiAgICAgICAgY29uc3Qgc3F1YXJlUm9vdE9mTiA9IE1hdGguc3FydChuKTsKICAgICAgICBnMiA9IHNxdWFyZVJvb3RPZk4gLyAyOwogICAgICAgIGgyID0gc3F1YXJlUm9vdE9mTiA9PT0gMCA/IDAgOiAoYTMgKiBoMSAtIGExKSAvIHNxdWFyZVJvb3RPZk47CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgc3F1YXJlUm9vdE9mTSA9IE1hdGguc3FydChtKTsKICAgICAgICBnMiA9IHNxdWFyZVJvb3RPZk0gPT09IDAgPyAwIDogKGEzICogaDEgLSBhMSkgLyBzcXVhcmVSb290T2ZNOwogICAgICAgIGgyID0gc3F1YXJlUm9vdE9mTSAvIDI7CiAgICAgIH0KICAgICAgbGV0IEc7CiAgICAgIGxldCBnOwogICAgICBpZiAoZzEgPT09IDAgJiYgZzIgPT09IDApIHsKICAgICAgICBHID0gMDsKICAgICAgICBnID0gMDsKICAgICAgfSBlbHNlIGlmIChNYXRoX2RlZmF1bHQuc2lnbihnMSkgPT09IE1hdGhfZGVmYXVsdC5zaWduKGcyKSkgewogICAgICAgIEcgPSBnMSArIGcyOwogICAgICAgIGcgPSB5IC8gRzsKICAgICAgfSBlbHNlIHsKICAgICAgICBnID0gZzEgLSBnMjsKICAgICAgICBHID0geSAvIGc7CiAgICAgIH0KICAgICAgbGV0IEg7CiAgICAgIGxldCBoOwogICAgICBpZiAoaDEgPT09IDAgJiYgaDIgPT09IDApIHsKICAgICAgICBIID0gMDsKICAgICAgICBoID0gMDsKICAgICAgfSBlbHNlIGlmIChNYXRoX2RlZmF1bHQuc2lnbihoMSkgPT09IE1hdGhfZGVmYXVsdC5zaWduKGgyKSkgewogICAgICAgIEggPSBoMSArIGgyOwogICAgICAgIGggPSBhMCAvIEg7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaCA9IGgxIC0gaDI7CiAgICAgICAgSCA9IGEwIC8gaDsKICAgICAgfQogICAgICBjb25zdCByb290czEgPSBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0LmNvbXB1dGVSZWFsUm9vdHMoMSwgRywgSCk7CiAgICAgIGNvbnN0IHJvb3RzMiA9IFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQuY29tcHV0ZVJlYWxSb290cygxLCBnLCBoKTsKICAgICAgaWYgKHJvb3RzMS5sZW5ndGggIT09IDApIHsKICAgICAgICBpZiAocm9vdHMyLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgaWYgKHJvb3RzMVsxXSA8PSByb290czJbMF0pIHsKICAgICAgICAgICAgcmV0dXJuIFtyb290czFbMF0sIHJvb3RzMVsxXSwgcm9vdHMyWzBdLCByb290czJbMV1dOwogICAgICAgICAgfSBlbHNlIGlmIChyb290czJbMV0gPD0gcm9vdHMxWzBdKSB7CiAgICAgICAgICAgIHJldHVybiBbcm9vdHMyWzBdLCByb290czJbMV0sIHJvb3RzMVswXSwgcm9vdHMxWzFdXTsKICAgICAgICAgIH0gZWxzZSBpZiAocm9vdHMxWzBdID49IHJvb3RzMlswXSAmJiByb290czFbMV0gPD0gcm9vdHMyWzFdKSB7CiAgICAgICAgICAgIHJldHVybiBbcm9vdHMyWzBdLCByb290czFbMF0sIHJvb3RzMVsxXSwgcm9vdHMyWzFdXTsKICAgICAgICAgIH0gZWxzZSBpZiAocm9vdHMyWzBdID49IHJvb3RzMVswXSAmJiByb290czJbMV0gPD0gcm9vdHMxWzFdKSB7CiAgICAgICAgICAgIHJldHVybiBbcm9vdHMxWzBdLCByb290czJbMF0sIHJvb3RzMlsxXSwgcm9vdHMxWzFdXTsKICAgICAgICAgIH0gZWxzZSBpZiAocm9vdHMxWzBdID4gcm9vdHMyWzBdICYmIHJvb3RzMVswXSA8IHJvb3RzMlsxXSkgewogICAgICAgICAgICByZXR1cm4gW3Jvb3RzMlswXSwgcm9vdHMxWzBdLCByb290czJbMV0sIHJvb3RzMVsxXV07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gW3Jvb3RzMVswXSwgcm9vdHMyWzBdLCByb290czFbMV0sIHJvb3RzMlsxXV07CiAgICAgICAgfQogICAgICAgIHJldHVybiByb290czE7CiAgICAgIH0KICAgICAgaWYgKHJvb3RzMi5sZW5ndGggIT09IDApIHsKICAgICAgICByZXR1cm4gcm9vdHMyOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gW107CiAgfQogIHZhciBRdWFydGljUmVhbFBvbHlub21pYWwsIFF1YXJ0aWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0OwogIHZhciBpbml0X1F1YXJ0aWNSZWFsUG9seW5vbWlhbCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUXVhcnRpY1JlYWxQb2x5bm9taWFsLmpzIigpIHsKICAgICAgaW5pdF9DdWJpY1JlYWxQb2x5bm9taWFsKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUXVhZHJhdGljUmVhbFBvbHlub21pYWwoKTsKICAgICAgUXVhcnRpY1JlYWxQb2x5bm9taWFsID0ge307CiAgICAgIFF1YXJ0aWNSZWFsUG9seW5vbWlhbC5jb21wdXRlRGlzY3JpbWluYW50ID0gZnVuY3Rpb24oYTMsIGIsIGMsIGQsIGUpIHsKICAgICAgICBpZiAodHlwZW9mIGEzICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImEgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgYiAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJiIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGMgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYyBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBkICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImQgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgZSAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJlIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhMjIgPSBhMyAqIGEzOwogICAgICAgIGNvbnN0IGEzMiA9IGEyMiAqIGEzOwogICAgICAgIGNvbnN0IGIyID0gYiAqIGI7CiAgICAgICAgY29uc3QgYjMgPSBiMiAqIGI7CiAgICAgICAgY29uc3QgYzIgPSBjICogYzsKICAgICAgICBjb25zdCBjMzIgPSBjMiAqIGM7CiAgICAgICAgY29uc3QgZDIgPSBkICogZDsKICAgICAgICBjb25zdCBkMyA9IGQyICogZDsKICAgICAgICBjb25zdCBlMiA9IGUgKiBlOwogICAgICAgIGNvbnN0IGUzID0gZTIgKiBlOwogICAgICAgIGNvbnN0IGRpc2NyaW1pbmFudCA9IGIyICogYzIgKiBkMiAtIDQgKiBiMyAqIGQzIC0gNCAqIGEzICogYzMyICogZDIgKyAxOCAqIGEzICogYiAqIGMgKiBkMyAtIDI3ICogYTIyICogZDIgKiBkMiArIDI1NiAqIGEzMiAqIGUzICsgZSAqICgxOCAqIGIzICogYyAqIGQgLSA0ICogYjIgKiBjMzIgKyAxNiAqIGEzICogYzIgKiBjMiAtIDgwICogYTMgKiBiICogYzIgKiBkIC0gNiAqIGEzICogYjIgKiBkMiArIDE0NCAqIGEyMiAqIGMgKiBkMikgKyBlMiAqICgxNDQgKiBhMyAqIGIyICogYyAtIDI3ICogYjIgKiBiMiAtIDEyOCAqIGEyMiAqIGMyIC0gMTkyICogYTIyICogYiAqIGQpOwogICAgICAgIHJldHVybiBkaXNjcmltaW5hbnQ7CiAgICAgIH07CiAgICAgIFF1YXJ0aWNSZWFsUG9seW5vbWlhbC5jb21wdXRlUmVhbFJvb3RzID0gZnVuY3Rpb24oYTMsIGIsIGMsIGQsIGUpIHsKICAgICAgICBpZiAodHlwZW9mIGEzICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImEgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgYiAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJiIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGMgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYyBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBkICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImQgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgZSAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJlIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoTWF0aC5hYnMoYTMpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT04xNSkgewogICAgICAgICAgcmV0dXJuIEN1YmljUmVhbFBvbHlub21pYWxfZGVmYXVsdC5jb21wdXRlUmVhbFJvb3RzKGIsIGMsIGQsIGUpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhMzIgPSBiIC8gYTM7CiAgICAgICAgY29uc3QgYTIyID0gYyAvIGEzOwogICAgICAgIGNvbnN0IGExID0gZCAvIGEzOwogICAgICAgIGNvbnN0IGEwID0gZSAvIGEzOwogICAgICAgIGxldCBrID0gYTMyIDwgMCA/IDEgOiAwOwogICAgICAgIGsgKz0gYTIyIDwgMCA/IGsgKyAxIDogazsKICAgICAgICBrICs9IGExIDwgMCA/IGsgKyAxIDogazsKICAgICAgICBrICs9IGEwIDwgMCA/IGsgKyAxIDogazsKICAgICAgICBzd2l0Y2ggKGspIHsKICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICByZXR1cm4gbmV1bWFyayhhMzIsIGEyMiwgYTEsIGEwKTsKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgcmV0dXJuIG5ldW1hcmsoYTMyLCBhMjIsIGExLCBhMCk7CiAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbChhMzIsIGEyMiwgYTEsIGEwKTsKICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICByZXR1cm4gbmV1bWFyayhhMzIsIGEyMiwgYTEsIGEwKTsKICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICByZXR1cm4gb3JpZ2luYWwoYTMyLCBhMjIsIGExLCBhMCk7CiAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgIHJldHVybiBuZXVtYXJrKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgY2FzZSA5OgogICAgICAgICAgICByZXR1cm4gb3JpZ2luYWwoYTMyLCBhMjIsIGExLCBhMCk7CiAgICAgICAgICBjYXNlIDEwOgogICAgICAgICAgICByZXR1cm4gb3JpZ2luYWwoYTMyLCBhMjIsIGExLCBhMCk7CiAgICAgICAgICBjYXNlIDExOgogICAgICAgICAgICByZXR1cm4gbmV1bWFyayhhMzIsIGEyMiwgYTEsIGEwKTsKICAgICAgICAgIGNhc2UgMTI6CiAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbChhMzIsIGEyMiwgYTEsIGEwKTsKICAgICAgICAgIGNhc2UgMTM6CiAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbChhMzIsIGEyMiwgYTEsIGEwKTsKICAgICAgICAgIGNhc2UgMTQ6CiAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbChhMzIsIGEyMiwgYTEsIGEwKTsKICAgICAgICAgIGNhc2UgMTU6CiAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbChhMzIsIGEyMiwgYTEsIGEwKTsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICB9OwogICAgICBRdWFydGljUmVhbFBvbHlub21pYWxfZGVmYXVsdCA9IFF1YXJ0aWNSZWFsUG9seW5vbWlhbDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JheS5qcwogIGZ1bmN0aW9uIFJheShvcmlnaW4sIGRpcmVjdGlvbjIpIHsKICAgIGRpcmVjdGlvbjIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZGVmYXVsdFZhbHVlX2RlZmF1bHQoZGlyZWN0aW9uMiwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pKTsKICAgIGlmICghQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhkaXJlY3Rpb24yLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTykpIHsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShkaXJlY3Rpb24yLCBkaXJlY3Rpb24yKTsKICAgIH0KICAgIHRoaXMub3JpZ2luID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9yaWdpbiwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pKTsKICAgIHRoaXMuZGlyZWN0aW9uID0gZGlyZWN0aW9uMjsKICB9CiAgdmFyIFJheV9kZWZhdWx0OwogIHZhciBpbml0X1JheSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmF5LmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIFJheS5jbG9uZSA9IGZ1bmN0aW9uKHJheSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmF5KSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBSYXkocmF5Lm9yaWdpbiwgcmF5LmRpcmVjdGlvbik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5vcmlnaW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocmF5Lm9yaWdpbik7CiAgICAgICAgcmVzdWx0LmRpcmVjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShyYXkuZGlyZWN0aW9uKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSYXkuZ2V0UG9pbnQgPSBmdW5jdGlvbihyYXksIHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmF5IiwgcmF5KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInQiLCB0KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHJheS5kaXJlY3Rpb24sIHQsIHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmF5Lm9yaWdpbiwgcmVzdWx0LCByZXN1bHQpOwogICAgICB9OwogICAgICBSYXlfZGVmYXVsdCA9IFJheTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0ludGVyc2VjdGlvblRlc3RzLmpzCiAgZnVuY3Rpb24gc29sdmVRdWFkcmF0aWMoYTMsIGIsIGMsIHJlc3VsdCkgewogICAgY29uc3QgZGV0ID0gYiAqIGIgLSA0ICogYTMgKiBjOwogICAgaWYgKGRldCA8IDApIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0gZWxzZSBpZiAoZGV0ID4gMCkgewogICAgICBjb25zdCBkZW5vbSA9IDEgLyAoMiAqIGEzKTsKICAgICAgY29uc3QgZGlzYyA9IE1hdGguc3FydChkZXQpOwogICAgICBjb25zdCByb290MCA9ICgtYiArIGRpc2MpICogZGVub207CiAgICAgIGNvbnN0IHJvb3QxID0gKC1iIC0gZGlzYykgKiBkZW5vbTsKICAgICAgaWYgKHJvb3QwIDwgcm9vdDEpIHsKICAgICAgICByZXN1bHQucm9vdDAgPSByb290MDsKICAgICAgICByZXN1bHQucm9vdDEgPSByb290MTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHQucm9vdDAgPSByb290MTsKICAgICAgICByZXN1bHQucm9vdDEgPSByb290MDsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgY29uc3Qgcm9vdCA9IC1iIC8gKDIgKiBhMyk7CiAgICBpZiAocm9vdCA9PT0gMCkgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgcmVzdWx0LnJvb3QwID0gcmVzdWx0LnJvb3QxID0gcm9vdDsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIHJheVNwaGVyZShyYXksIHNwaGVyZSwgcmVzdWx0KSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgIHJlc3VsdCA9IG5ldyBJbnRlcnZhbF9kZWZhdWx0KCk7CiAgICB9CiAgICBjb25zdCBvcmlnaW4gPSByYXkub3JpZ2luOwogICAgY29uc3QgZGlyZWN0aW9uMiA9IHJheS5kaXJlY3Rpb247CiAgICBjb25zdCBjZW50ZXIgPSBzcGhlcmUuY2VudGVyOwogICAgY29uc3QgcmFkaXVzU3F1YXJlZCA9IHNwaGVyZS5yYWRpdXMgKiBzcGhlcmUucmFkaXVzOwogICAgY29uc3QgZGlmZiA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChvcmlnaW4sIGNlbnRlciwgc2NyYXRjaFBWZWMpOwogICAgY29uc3QgYTMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjIsIGRpcmVjdGlvbjIpOwogICAgY29uc3QgYiA9IDIgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjIsIGRpZmYpOwogICAgY29uc3QgYyA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKGRpZmYpIC0gcmFkaXVzU3F1YXJlZDsKICAgIGNvbnN0IHJvb3RzID0gc29sdmVRdWFkcmF0aWMoYTMsIGIsIGMsIHJheVNwaGVyZVJvb3RzKTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJvb3RzKSkgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgcmVzdWx0LnN0YXJ0ID0gcm9vdHMucm9vdDA7CiAgICByZXN1bHQuc3RvcCA9IHJvb3RzLnJvb3QxOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gYWRkV2l0aENhbmNlbGxhdGlvbkNoZWNrMihsZWZ0LCByaWdodCwgdG9sZXJhbmNlKSB7CiAgICBjb25zdCBkaWZmZXJlbmNlID0gbGVmdCArIHJpZ2h0OwogICAgaWYgKE1hdGhfZGVmYXVsdC5zaWduKGxlZnQpICE9PSBNYXRoX2RlZmF1bHQuc2lnbihyaWdodCkgJiYgTWF0aC5hYnMoZGlmZmVyZW5jZSAvIE1hdGgubWF4KE1hdGguYWJzKGxlZnQpLCBNYXRoLmFicyhyaWdodCkpKSA8IHRvbGVyYW5jZSkgewogICAgICByZXR1cm4gMDsKICAgIH0KICAgIHJldHVybiBkaWZmZXJlbmNlOwogIH0KICB2YXIgSW50ZXJzZWN0aW9uVGVzdHMsIHNjcmF0Y2hFZGdlMCwgc2NyYXRjaEVkZ2UxLCBzY3JhdGNoUFZlYywgc2NyYXRjaFRWZWMsIHNjcmF0Y2hRVmVjLCBzY3JhdGNoTGluZVNlZ21lbnRUcmlhbmdsZVJheSwgcmF5U3BoZXJlUm9vdHMsIHNjcmF0Y2hMaW5lU2VnbWVudFJheSwgc2NyYXRjaFEsIHNjcmF0Y2hXLCBmaXJzdEF4aXNTY3JhdGNoLCBzZWNvbmRBeGlzU2NyYXRjaCwgdGhpcmRBeGlzU2NyYXRjaCwgcmVmZXJlbmNlU2NyYXRjaCwgYkNhcnQsIGJTY3JhdGNoLCBidFNjcmF0Y2gsIGRpU2NyYXRjaCwgZFNjcmF0Y2gsIGNTY3JhdGNoLCB0ZW1wTWF0cml4LCBhU2NyYXRjaCwgc1NjcmF0Y2gsIGNsb3Nlc3RTY3JhdGNoLCBzdXJmUG9pbnRTY3JhdGNoLCBsaW5lU2VnbWVudFBsYW5lRGlmZmVyZW5jZSwgSW50ZXJzZWN0aW9uVGVzdHNfZGVmYXVsdDsKICB2YXIgaW5pdF9JbnRlcnNlY3Rpb25UZXN0cyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSW50ZXJzZWN0aW9uVGVzdHMuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9JbnRlcnZhbCgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfUXVhZHJhdGljUmVhbFBvbHlub21pYWwoKTsKICAgICAgaW5pdF9RdWFydGljUmVhbFBvbHlub21pYWwoKTsKICAgICAgaW5pdF9SYXkoKTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMgPSB7fTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMucmF5UGxhbmUgPSBmdW5jdGlvbihyYXksIHBsYW5lLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmF5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwbGFuZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBvcmlnaW4gPSByYXkub3JpZ2luOwogICAgICAgIGNvbnN0IGRpcmVjdGlvbjIgPSByYXkuZGlyZWN0aW9uOwogICAgICAgIGNvbnN0IG5vcm1hbDIgPSBwbGFuZS5ub3JtYWw7CiAgICAgICAgY29uc3QgZGVub21pbmF0b3IgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KG5vcm1hbDIsIGRpcmVjdGlvbjIpOwogICAgICAgIGlmIChNYXRoLmFicyhkZW5vbWluYXRvcikgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE1KSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBjb25zdCB0ID0gKC1wbGFuZS5kaXN0YW5jZSAtIENhcnRlc2lhbjNfZGVmYXVsdC5kb3Qobm9ybWFsMiwgb3JpZ2luKSkgLyBkZW5vbWluYXRvcjsKICAgICAgICBpZiAodCA8IDApIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGRpcmVjdGlvbjIsIHQsIHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQob3JpZ2luLCByZXN1bHQsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFZGdlMCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEVkZ2UxID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUFZlYyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFRWZWMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hRVmVjID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBJbnRlcnNlY3Rpb25UZXN0cy5yYXlUcmlhbmdsZVBhcmFtZXRyaWMgPSBmdW5jdGlvbihyYXksIHAwLCBwMSwgcDIsIGN1bGxCYWNrRmFjZXMpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmF5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwMCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwMCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocDEpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicDEgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHAyKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInAyIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjdWxsQmFja0ZhY2VzID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY3VsbEJhY2tGYWNlcywgZmFsc2UpOwogICAgICAgIGNvbnN0IG9yaWdpbiA9IHJheS5vcmlnaW47CiAgICAgICAgY29uc3QgZGlyZWN0aW9uMiA9IHJheS5kaXJlY3Rpb247CiAgICAgICAgY29uc3QgZWRnZTAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocDEsIHAwLCBzY3JhdGNoRWRnZTApOwogICAgICAgIGNvbnN0IGVkZ2UxID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHAyLCBwMCwgc2NyYXRjaEVkZ2UxKTsKICAgICAgICBjb25zdCBwID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKGRpcmVjdGlvbjIsIGVkZ2UxLCBzY3JhdGNoUFZlYyk7CiAgICAgICAgY29uc3QgZGV0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChlZGdlMCwgcCk7CiAgICAgICAgbGV0IHR2ZWM7CiAgICAgICAgbGV0IHE7CiAgICAgICAgbGV0IHUzOwogICAgICAgIGxldCB2MzsKICAgICAgICBsZXQgdDsKICAgICAgICBpZiAoY3VsbEJhY2tGYWNlcykgewogICAgICAgICAgaWYgKGRldCA8IE1hdGhfZGVmYXVsdC5FUFNJTE9ONikgewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgICAgdHZlYyA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChvcmlnaW4sIHAwLCBzY3JhdGNoVFZlYyk7CiAgICAgICAgICB1MyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodHZlYywgcCk7CiAgICAgICAgICBpZiAodTMgPCAwIHx8IHUzID4gZGV0KSB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICBxID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHR2ZWMsIGVkZ2UwLCBzY3JhdGNoUVZlYyk7CiAgICAgICAgICB2MyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgcSk7CiAgICAgICAgICBpZiAodjMgPCAwIHx8IHUzICsgdjMgPiBkZXQpIHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGVkZ2UxLCBxKSAvIGRldDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKE1hdGguYWJzKGRldCkgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjYpIHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGludkRldCA9IDEgLyBkZXQ7CiAgICAgICAgICB0dmVjID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG9yaWdpbiwgcDAsIHNjcmF0Y2hUVmVjKTsKICAgICAgICAgIHUzID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh0dmVjLCBwKSAqIGludkRldDsKICAgICAgICAgIGlmICh1MyA8IDAgfHwgdTMgPiAxKSB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICBxID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHR2ZWMsIGVkZ2UwLCBzY3JhdGNoUVZlYyk7CiAgICAgICAgICB2MyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgcSkgKiBpbnZEZXQ7CiAgICAgICAgICBpZiAodjMgPCAwIHx8IHUzICsgdjMgPiAxKSB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICB0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChlZGdlMSwgcSkgKiBpbnZEZXQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0OwogICAgICB9OwogICAgICBJbnRlcnNlY3Rpb25UZXN0cy5yYXlUcmlhbmdsZSA9IGZ1bmN0aW9uKHJheSwgcDAsIHAxLCBwMiwgY3VsbEJhY2tGYWNlcywgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgdCA9IEludGVyc2VjdGlvblRlc3RzLnJheVRyaWFuZ2xlUGFyYW1ldHJpYygKICAgICAgICAgIHJheSwKICAgICAgICAgIHAwLAogICAgICAgICAgcDEsCiAgICAgICAgICBwMiwKICAgICAgICAgIGN1bGxCYWNrRmFjZXMKICAgICAgICApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHQpIHx8IHQgPCAwKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHJheS5kaXJlY3Rpb24sIHQsIHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmF5Lm9yaWdpbiwgcmVzdWx0LCByZXN1bHQpOwogICAgICB9OwogICAgICBzY3JhdGNoTGluZVNlZ21lbnRUcmlhbmdsZVJheSA9IG5ldyBSYXlfZGVmYXVsdCgpOwogICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFRyaWFuZ2xlID0gZnVuY3Rpb24odjAyLCB2MTIsIHAwLCBwMSwgcDIsIGN1bGxCYWNrRmFjZXMsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHYwMikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2MCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodjEyKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInYxIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwMCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwMCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocDEpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicDEgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHAyKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInAyIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCByYXkgPSBzY3JhdGNoTGluZVNlZ21lbnRUcmlhbmdsZVJheTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUodjAyLCByYXkub3JpZ2luKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QodjEyLCB2MDIsIHJheS5kaXJlY3Rpb24pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmF5LmRpcmVjdGlvbiwgcmF5LmRpcmVjdGlvbik7CiAgICAgICAgY29uc3QgdCA9IEludGVyc2VjdGlvblRlc3RzLnJheVRyaWFuZ2xlUGFyYW1ldHJpYygKICAgICAgICAgIHJheSwKICAgICAgICAgIHAwLAogICAgICAgICAgcDEsCiAgICAgICAgICBwMiwKICAgICAgICAgIGN1bGxCYWNrRmFjZXMKICAgICAgICApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHQpIHx8IHQgPCAwIHx8IHQgPiBDYXJ0ZXNpYW4zX2RlZmF1bHQuZGlzdGFuY2UodjAyLCB2MTIpKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHJheS5kaXJlY3Rpb24sIHQsIHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmF5Lm9yaWdpbiwgcmVzdWx0LCByZXN1bHQpOwogICAgICB9OwogICAgICByYXlTcGhlcmVSb290cyA9IHsKICAgICAgICByb290MDogMCwKICAgICAgICByb290MTogMAogICAgICB9OwogICAgICBJbnRlcnNlY3Rpb25UZXN0cy5yYXlTcGhlcmUgPSBmdW5jdGlvbihyYXksIHNwaGVyZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJheSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc3BoZXJlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInNwaGVyZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0ID0gcmF5U3BoZXJlKHJheSwgc3BoZXJlLCByZXN1bHQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkgfHwgcmVzdWx0LnN0b3AgPCAwKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICByZXN1bHQuc3RhcnQgPSBNYXRoLm1heChyZXN1bHQuc3RhcnQsIDApOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hMaW5lU2VnbWVudFJheSA9IG5ldyBSYXlfZGVmYXVsdCgpOwogICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFNwaGVyZSA9IGZ1bmN0aW9uKHAwLCBwMSwgc3BoZXJlLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwMCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwMCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocDEpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicDEgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHNwaGVyZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJzcGhlcmUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJheSA9IHNjcmF0Y2hMaW5lU2VnbWVudFJheTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocDAsIHJheS5vcmlnaW4pOwogICAgICAgIGNvbnN0IGRpcmVjdGlvbjIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocDEsIHAwLCByYXkuZGlyZWN0aW9uKTsKICAgICAgICBjb25zdCBtYXhUID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZShkaXJlY3Rpb24yKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGRpcmVjdGlvbjIsIGRpcmVjdGlvbjIpOwogICAgICAgIHJlc3VsdCA9IHJheVNwaGVyZShyYXksIHNwaGVyZSwgcmVzdWx0KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpIHx8IHJlc3VsdC5zdG9wIDwgMCB8fCByZXN1bHQuc3RhcnQgPiBtYXhUKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICByZXN1bHQuc3RhcnQgPSBNYXRoLm1heChyZXN1bHQuc3RhcnQsIDApOwogICAgICAgIHJlc3VsdC5zdG9wID0gTWF0aC5taW4ocmVzdWx0LnN0b3AsIG1heFQpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hRID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMucmF5RWxsaXBzb2lkID0gZnVuY3Rpb24ocmF5LCBlbGxpcHNvaWQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmF5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChlbGxpcHNvaWQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZWxsaXBzb2lkIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbnZlcnNlUmFkaWkgPSBlbGxpcHNvaWQub25lT3ZlclJhZGlpOwogICAgICAgIGNvbnN0IHEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlDb21wb25lbnRzKGludmVyc2VSYWRpaSwgcmF5Lm9yaWdpbiwgc2NyYXRjaFEpOwogICAgICAgIGNvbnN0IHcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlDb21wb25lbnRzKAogICAgICAgICAgaW52ZXJzZVJhZGlpLAogICAgICAgICAgcmF5LmRpcmVjdGlvbiwKICAgICAgICAgIHNjcmF0Y2hXCiAgICAgICAgKTsKICAgICAgICBjb25zdCBxMjIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZChxKTsKICAgICAgICBjb25zdCBxdyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QocSwgdyk7CiAgICAgICAgbGV0IGRpZmZlcmVuY2UsIHcyLCBwcm9kdWN0LCBkaXNjcmltaW5hbnQsIHRlbXA7CiAgICAgICAgaWYgKHEyMiA+IDEpIHsKICAgICAgICAgIGlmIChxdyA+PSAwKSB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBxdzIgPSBxdyAqIHF3OwogICAgICAgICAgZGlmZmVyZW5jZSA9IHEyMiAtIDE7CiAgICAgICAgICB3MiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKHcpOwogICAgICAgICAgcHJvZHVjdCA9IHcyICogZGlmZmVyZW5jZTsKICAgICAgICAgIGlmIChxdzIgPCBwcm9kdWN0KSB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9IGVsc2UgaWYgKHF3MiA+IHByb2R1Y3QpIHsKICAgICAgICAgICAgZGlzY3JpbWluYW50ID0gcXcgKiBxdyAtIHByb2R1Y3Q7CiAgICAgICAgICAgIHRlbXAgPSAtcXcgKyBNYXRoLnNxcnQoZGlzY3JpbWluYW50KTsKICAgICAgICAgICAgY29uc3Qgcm9vdDAgPSB0ZW1wIC8gdzI7CiAgICAgICAgICAgIGNvbnN0IHJvb3QxID0gZGlmZmVyZW5jZSAvIHRlbXA7CiAgICAgICAgICAgIGlmIChyb290MCA8IHJvb3QxKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBJbnRlcnZhbF9kZWZhdWx0KHJvb3QwLCByb290MSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBzdGFydDogcm9vdDEsCiAgICAgICAgICAgICAgc3RvcDogcm9vdDAKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHJvb3QgPSBNYXRoLnNxcnQoZGlmZmVyZW5jZSAvIHcyKTsKICAgICAgICAgIHJldHVybiBuZXcgSW50ZXJ2YWxfZGVmYXVsdChyb290LCByb290KTsKICAgICAgICB9IGVsc2UgaWYgKHEyMiA8IDEpIHsKICAgICAgICAgIGRpZmZlcmVuY2UgPSBxMjIgLSAxOwogICAgICAgICAgdzIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCh3KTsKICAgICAgICAgIHByb2R1Y3QgPSB3MiAqIGRpZmZlcmVuY2U7CiAgICAgICAgICBkaXNjcmltaW5hbnQgPSBxdyAqIHF3IC0gcHJvZHVjdDsKICAgICAgICAgIHRlbXAgPSAtcXcgKyBNYXRoLnNxcnQoZGlzY3JpbWluYW50KTsKICAgICAgICAgIHJldHVybiBuZXcgSW50ZXJ2YWxfZGVmYXVsdCgwLCB0ZW1wIC8gdzIpOwogICAgICAgIH0KICAgICAgICBpZiAocXcgPCAwKSB7CiAgICAgICAgICB3MiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKHcpOwogICAgICAgICAgcmV0dXJuIG5ldyBJbnRlcnZhbF9kZWZhdWx0KDAsIC1xdyAvIHcyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgfTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMucXVhZHJhdGljVmVjdG9yRXhwcmVzc2lvbiA9IGZ1bmN0aW9uKEEsIGIsIGMsIHgsIHcpIHsKICAgICAgICBjb25zdCB4U3F1YXJlZCA9IHggKiB4OwogICAgICAgIGNvbnN0IHdTcXVhcmVkID0gdyAqIHc7CiAgICAgICAgY29uc3QgbDIgPSAoQVtNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMVJPVzFdIC0gQVtNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMlJPVzJdKSAqIHdTcXVhcmVkOwogICAgICAgIGNvbnN0IGwxID0gdyAqICh4ICogYWRkV2l0aENhbmNlbGxhdGlvbkNoZWNrMigKICAgICAgICAgIEFbTWF0cml4M19kZWZhdWx0LkNPTFVNTjFST1cwXSwKICAgICAgICAgIEFbTWF0cml4M19kZWZhdWx0LkNPTFVNTjBST1cxXSwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTUKICAgICAgICApICsgYi55KTsKICAgICAgICBjb25zdCBsMCA9IEFbTWF0cml4M19kZWZhdWx0LkNPTFVNTjBST1cwXSAqIHhTcXVhcmVkICsgQVtNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMlJPVzJdICogd1NxdWFyZWQgKyB4ICogYi54ICsgYzsKICAgICAgICBjb25zdCByMSA9IHdTcXVhcmVkICogYWRkV2l0aENhbmNlbGxhdGlvbkNoZWNrMigKICAgICAgICAgIEFbTWF0cml4M19kZWZhdWx0LkNPTFVNTjJST1cxXSwKICAgICAgICAgIEFbTWF0cml4M19kZWZhdWx0LkNPTFVNTjFST1cyXSwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTUKICAgICAgICApOwogICAgICAgIGNvbnN0IHIwID0gdyAqICh4ICogYWRkV2l0aENhbmNlbGxhdGlvbkNoZWNrMihBW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4yUk9XMF0sIEFbTWF0cml4M19kZWZhdWx0LkNPTFVNTjBST1cyXSkgKyBiLnopOwogICAgICAgIGxldCBjb3NpbmVzOwogICAgICAgIGNvbnN0IHNvbHV0aW9ucyA9IFtdOwogICAgICAgIGlmIChyMCA9PT0gMCAmJiByMSA9PT0gMCkgewogICAgICAgICAgY29zaW5lcyA9IFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQuY29tcHV0ZVJlYWxSb290cyhsMiwgbDEsIGwwKTsKICAgICAgICAgIGlmIChjb3NpbmVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gc29sdXRpb25zOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgY29zaW5lMCA9IGNvc2luZXNbMF07CiAgICAgICAgICBjb25zdCBzaW5lMCA9IE1hdGguc3FydChNYXRoLm1heCgxIC0gY29zaW5lMCAqIGNvc2luZTAsIDApKTsKICAgICAgICAgIHNvbHV0aW9ucy5wdXNoKG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCwgdyAqIGNvc2luZTAsIHcgKiAtc2luZTApKTsKICAgICAgICAgIHNvbHV0aW9ucy5wdXNoKG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCwgdyAqIGNvc2luZTAsIHcgKiBzaW5lMCkpOwogICAgICAgICAgaWYgKGNvc2luZXMubGVuZ3RoID09PSAyKSB7CiAgICAgICAgICAgIGNvbnN0IGNvc2luZTEgPSBjb3NpbmVzWzFdOwogICAgICAgICAgICBjb25zdCBzaW5lMSA9IE1hdGguc3FydChNYXRoLm1heCgxIC0gY29zaW5lMSAqIGNvc2luZTEsIDApKTsKICAgICAgICAgICAgc29sdXRpb25zLnB1c2gobmV3IENhcnRlc2lhbjNfZGVmYXVsdCh4LCB3ICogY29zaW5lMSwgdyAqIC1zaW5lMSkpOwogICAgICAgICAgICBzb2x1dGlvbnMucHVzaChuZXcgQ2FydGVzaWFuM19kZWZhdWx0KHgsIHcgKiBjb3NpbmUxLCB3ICogc2luZTEpKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzb2x1dGlvbnM7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHIwU3F1YXJlZCA9IHIwICogcjA7CiAgICAgICAgY29uc3QgcjFTcXVhcmVkID0gcjEgKiByMTsKICAgICAgICBjb25zdCBsMlNxdWFyZWQgPSBsMiAqIGwyOwogICAgICAgIGNvbnN0IHIwcjEgPSByMCAqIHIxOwogICAgICAgIGNvbnN0IGM0ID0gbDJTcXVhcmVkICsgcjFTcXVhcmVkOwogICAgICAgIGNvbnN0IGMzMiA9IDIgKiAobDEgKiBsMiArIHIwcjEpOwogICAgICAgIGNvbnN0IGMyID0gMiAqIGwwICogbDIgKyBsMSAqIGwxIC0gcjFTcXVhcmVkICsgcjBTcXVhcmVkOwogICAgICAgIGNvbnN0IGMxID0gMiAqIChsMCAqIGwxIC0gcjByMSk7CiAgICAgICAgY29uc3QgYzAgPSBsMCAqIGwwIC0gcjBTcXVhcmVkOwogICAgICAgIGlmIChjNCA9PT0gMCAmJiBjMzIgPT09IDAgJiYgYzIgPT09IDAgJiYgYzEgPT09IDApIHsKICAgICAgICAgIHJldHVybiBzb2x1dGlvbnM7CiAgICAgICAgfQogICAgICAgIGNvc2luZXMgPSBRdWFydGljUmVhbFBvbHlub21pYWxfZGVmYXVsdC5jb21wdXRlUmVhbFJvb3RzKGM0LCBjMzIsIGMyLCBjMSwgYzApOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNvc2luZXMubGVuZ3RoOwogICAgICAgIGlmIChsZW5ndGggPT09IDApIHsKICAgICAgICAgIHJldHVybiBzb2x1dGlvbnM7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGNvbnN0IGNvc2luZSA9IGNvc2luZXNbaV07CiAgICAgICAgICBjb25zdCBjb3NpbmVTcXVhcmVkID0gY29zaW5lICogY29zaW5lOwogICAgICAgICAgY29uc3Qgc2luZVNxdWFyZWQgPSBNYXRoLm1heCgxIC0gY29zaW5lU3F1YXJlZCwgMCk7CiAgICAgICAgICBjb25zdCBzaW5lID0gTWF0aC5zcXJ0KHNpbmVTcXVhcmVkKTsKICAgICAgICAgIGxldCBsZWZ0OwogICAgICAgICAgaWYgKE1hdGhfZGVmYXVsdC5zaWduKGwyKSA9PT0gTWF0aF9kZWZhdWx0LnNpZ24obDApKSB7CiAgICAgICAgICAgIGxlZnQgPSBhZGRXaXRoQ2FuY2VsbGF0aW9uQ2hlY2syKAogICAgICAgICAgICAgIGwyICogY29zaW5lU3F1YXJlZCArIGwwLAogICAgICAgICAgICAgIGwxICogY29zaW5lLAogICAgICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTIKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSBpZiAoTWF0aF9kZWZhdWx0LnNpZ24obDApID09PSBNYXRoX2RlZmF1bHQuc2lnbihsMSAqIGNvc2luZSkpIHsKICAgICAgICAgICAgbGVmdCA9IGFkZFdpdGhDYW5jZWxsYXRpb25DaGVjazIoCiAgICAgICAgICAgICAgbDIgKiBjb3NpbmVTcXVhcmVkLAogICAgICAgICAgICAgIGwxICogY29zaW5lICsgbDAsCiAgICAgICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04xMgogICAgICAgICAgICApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGVmdCA9IGFkZFdpdGhDYW5jZWxsYXRpb25DaGVjazIoCiAgICAgICAgICAgICAgbDIgKiBjb3NpbmVTcXVhcmVkICsgbDEgKiBjb3NpbmUsCiAgICAgICAgICAgICAgbDAsCiAgICAgICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04xMgogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcmlnaHQgPSBhZGRXaXRoQ2FuY2VsbGF0aW9uQ2hlY2syKAogICAgICAgICAgICByMSAqIGNvc2luZSwKICAgICAgICAgICAgcjAsCiAgICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTUKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBwcm9kdWN0ID0gbGVmdCAqIHJpZ2h0OwogICAgICAgICAgaWYgKHByb2R1Y3QgPCAwKSB7CiAgICAgICAgICAgIHNvbHV0aW9ucy5wdXNoKG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCwgdyAqIGNvc2luZSwgdyAqIHNpbmUpKTsKICAgICAgICAgIH0gZWxzZSBpZiAocHJvZHVjdCA+IDApIHsKICAgICAgICAgICAgc29sdXRpb25zLnB1c2gobmV3IENhcnRlc2lhbjNfZGVmYXVsdCh4LCB3ICogY29zaW5lLCB3ICogLXNpbmUpKTsKICAgICAgICAgIH0gZWxzZSBpZiAoc2luZSAhPT0gMCkgewogICAgICAgICAgICBzb2x1dGlvbnMucHVzaChuZXcgQ2FydGVzaWFuM19kZWZhdWx0KHgsIHcgKiBjb3NpbmUsIHcgKiAtc2luZSkpOwogICAgICAgICAgICBzb2x1dGlvbnMucHVzaChuZXcgQ2FydGVzaWFuM19kZWZhdWx0KHgsIHcgKiBjb3NpbmUsIHcgKiBzaW5lKSk7CiAgICAgICAgICAgICsraTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNvbHV0aW9ucy5wdXNoKG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCwgdyAqIGNvc2luZSwgdyAqIHNpbmUpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNvbHV0aW9uczsKICAgICAgfTsKICAgICAgZmlyc3RBeGlzU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2Vjb25kQXhpc1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHRoaXJkQXhpc1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHJlZmVyZW5jZVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGJDYXJ0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBiU2NyYXRjaCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgYnRTY3JhdGNoID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBkaVNjcmF0Y2ggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIGRTY3JhdGNoID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBjU2NyYXRjaCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgdGVtcE1hdHJpeCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgYVNjcmF0Y2ggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIHNTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjbG9zZXN0U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc3VyZlBvaW50U2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBJbnRlcnNlY3Rpb25UZXN0cy5ncmF6aW5nQWx0aXR1ZGVMb2NhdGlvbiA9IGZ1bmN0aW9uKHJheSwgZWxsaXBzb2lkKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJheSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZWxsaXBzb2lkKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImVsbGlwc29pZCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcG9zaXRpb24gPSByYXkub3JpZ2luOwogICAgICAgIGNvbnN0IGRpcmVjdGlvbjIgPSByYXkuZGlyZWN0aW9uOwogICAgICAgIGlmICghQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhwb3NpdGlvbiwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pKSB7CiAgICAgICAgICBjb25zdCBub3JtYWwyID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbiwgZmlyc3RBeGlzU2NyYXRjaCk7CiAgICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmRvdChkaXJlY3Rpb24yLCBub3JtYWwyKSA+PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBwb3NpdGlvbjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgaW50ZXJzZWN0cyA9IGRlZmluZWRfZGVmYXVsdCh0aGlzLnJheUVsbGlwc29pZChyYXksIGVsbGlwc29pZCkpOwogICAgICAgIGNvbnN0IGYgPSBlbGxpcHNvaWQudHJhbnNmb3JtUG9zaXRpb25Ub1NjYWxlZFNwYWNlKAogICAgICAgICAgZGlyZWN0aW9uMiwKICAgICAgICAgIGZpcnN0QXhpc1NjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IGZpcnN0QXhpcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZiwgZik7CiAgICAgICAgY29uc3QgcmVmZXJlbmNlID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1vc3RPcnRob2dvbmFsQXhpcyhmLCByZWZlcmVuY2VTY3JhdGNoKTsKICAgICAgICBjb25zdCBzZWNvbmRBeGlzID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhyZWZlcmVuY2UsIGZpcnN0QXhpcywgc2Vjb25kQXhpc1NjcmF0Y2gpLAogICAgICAgICAgc2Vjb25kQXhpc1NjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IHRoaXJkQXhpcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoZmlyc3RBeGlzLCBzZWNvbmRBeGlzLCB0aGlyZEF4aXNTY3JhdGNoKSwKICAgICAgICAgIHRoaXJkQXhpc1NjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IEIgPSBiU2NyYXRjaDsKICAgICAgICBCWzBdID0gZmlyc3RBeGlzLng7CiAgICAgICAgQlsxXSA9IGZpcnN0QXhpcy55OwogICAgICAgIEJbMl0gPSBmaXJzdEF4aXMuejsKICAgICAgICBCWzNdID0gc2Vjb25kQXhpcy54OwogICAgICAgIEJbNF0gPSBzZWNvbmRBeGlzLnk7CiAgICAgICAgQls1XSA9IHNlY29uZEF4aXMuejsKICAgICAgICBCWzZdID0gdGhpcmRBeGlzLng7CiAgICAgICAgQls3XSA9IHRoaXJkQXhpcy55OwogICAgICAgIEJbOF0gPSB0aGlyZEF4aXMuejsKICAgICAgICBjb25zdCBCX1QgPSBNYXRyaXgzX2RlZmF1bHQudHJhbnNwb3NlKEIsIGJ0U2NyYXRjaCk7CiAgICAgICAgY29uc3QgRF9JID0gTWF0cml4M19kZWZhdWx0LmZyb21TY2FsZShlbGxpcHNvaWQucmFkaWksIGRpU2NyYXRjaCk7CiAgICAgICAgY29uc3QgRCA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tU2NhbGUoZWxsaXBzb2lkLm9uZU92ZXJSYWRpaSwgZFNjcmF0Y2gpOwogICAgICAgIGNvbnN0IEMgPSBjU2NyYXRjaDsKICAgICAgICBDWzBdID0gMDsKICAgICAgICBDWzFdID0gLWRpcmVjdGlvbjIuejsKICAgICAgICBDWzJdID0gZGlyZWN0aW9uMi55OwogICAgICAgIENbM10gPSBkaXJlY3Rpb24yLno7CiAgICAgICAgQ1s0XSA9IDA7CiAgICAgICAgQ1s1XSA9IC1kaXJlY3Rpb24yLng7CiAgICAgICAgQ1s2XSA9IC1kaXJlY3Rpb24yLnk7CiAgICAgICAgQ1s3XSA9IGRpcmVjdGlvbjIueDsKICAgICAgICBDWzhdID0gMDsKICAgICAgICBjb25zdCB0ZW1wID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5KAogICAgICAgICAgTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5KEJfVCwgRCwgdGVtcE1hdHJpeCksCiAgICAgICAgICBDLAogICAgICAgICAgdGVtcE1hdHJpeAogICAgICAgICk7CiAgICAgICAgY29uc3QgQSA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseSgKICAgICAgICAgIE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseSh0ZW1wLCBEX0ksIGFTY3JhdGNoKSwKICAgICAgICAgIEIsCiAgICAgICAgICBhU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3QgYiA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKHRlbXAsIHBvc2l0aW9uLCBiQ2FydCk7CiAgICAgICAgY29uc3Qgc29sdXRpb25zID0gSW50ZXJzZWN0aW9uVGVzdHMucXVhZHJhdGljVmVjdG9yRXhwcmVzc2lvbigKICAgICAgICAgIEEsCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGIsIGZpcnN0QXhpc1NjcmF0Y2gpLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICBsZXQgczsKICAgICAgICBsZXQgYWx0aXR1ZGU7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gc29sdXRpb25zLmxlbmd0aDsKICAgICAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICAgICAgbGV0IGNsb3Nlc3QgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIGNsb3Nlc3RTY3JhdGNoKTsKICAgICAgICAgIGxldCBtYXhpbXVtVmFsdWUgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIHMgPSBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3RvcigKICAgICAgICAgICAgICBEX0ksCiAgICAgICAgICAgICAgTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoQiwgc29sdXRpb25zW2ldLCBzU2NyYXRjaCksCiAgICAgICAgICAgICAgc1NjcmF0Y2gKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29uc3QgdjMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChzLCBwb3NpdGlvbiwgcmVmZXJlbmNlU2NyYXRjaCksCiAgICAgICAgICAgICAgcmVmZXJlbmNlU2NyYXRjaAogICAgICAgICAgICApOwogICAgICAgICAgICBjb25zdCBkb3RQcm9kdWN0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh2MywgZGlyZWN0aW9uMik7CiAgICAgICAgICAgIGlmIChkb3RQcm9kdWN0ID4gbWF4aW11bVZhbHVlKSB7CiAgICAgICAgICAgICAgbWF4aW11bVZhbHVlID0gZG90UHJvZHVjdDsKICAgICAgICAgICAgICBjbG9zZXN0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHMsIGNsb3Nlc3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBzdXJmYWNlUG9pbnQgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgICAgIGNsb3Nlc3QsCiAgICAgICAgICAgIHN1cmZQb2ludFNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBtYXhpbXVtVmFsdWUgPSBNYXRoX2RlZmF1bHQuY2xhbXAobWF4aW11bVZhbHVlLCAwLCAxKTsKICAgICAgICAgIGFsdGl0dWRlID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSgKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNsb3Nlc3QsIHBvc2l0aW9uLCByZWZlcmVuY2VTY3JhdGNoKQogICAgICAgICAgKSAqIE1hdGguc3FydCgxIC0gbWF4aW11bVZhbHVlICogbWF4aW11bVZhbHVlKTsKICAgICAgICAgIGFsdGl0dWRlID0gaW50ZXJzZWN0cyA/IC1hbHRpdHVkZSA6IGFsdGl0dWRlOwogICAgICAgICAgc3VyZmFjZVBvaW50LmhlaWdodCA9IGFsdGl0dWRlOwogICAgICAgICAgcmV0dXJuIGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihzdXJmYWNlUG9pbnQsIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgIH07CiAgICAgIGxpbmVTZWdtZW50UGxhbmVEaWZmZXJlbmNlID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFBsYW5lID0gZnVuY3Rpb24oZW5kUG9pbnQwLCBlbmRQb2ludDEsIHBsYW5lLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChlbmRQb2ludDApKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZW5kUG9pbnQwIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChlbmRQb2ludDEpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZW5kUG9pbnQxIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwbGFuZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBkaWZmZXJlbmNlID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgZW5kUG9pbnQxLAogICAgICAgICAgZW5kUG9pbnQwLAogICAgICAgICAgbGluZVNlZ21lbnRQbGFuZURpZmZlcmVuY2UKICAgICAgICApOwogICAgICAgIGNvbnN0IG5vcm1hbDIgPSBwbGFuZS5ub3JtYWw7CiAgICAgICAgY29uc3QgbkRvdERpZmYgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KG5vcm1hbDIsIGRpZmZlcmVuY2UpOwogICAgICAgIGlmIChNYXRoLmFicyhuRG90RGlmZikgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjYpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5Eb3RQMCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3Qobm9ybWFsMiwgZW5kUG9pbnQwKTsKICAgICAgICBjb25zdCB0ID0gLShwbGFuZS5kaXN0YW5jZSArIG5Eb3RQMCkgLyBuRG90RGlmZjsKICAgICAgICBpZiAodCA8IDAgfHwgdCA+IDEpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGRpZmZlcmVuY2UsIHQsIHJlc3VsdCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChlbmRQb2ludDAsIHJlc3VsdCwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBJbnRlcnNlY3Rpb25UZXN0cy50cmlhbmdsZVBsYW5lSW50ZXJzZWN0aW9uID0gZnVuY3Rpb24ocDAsIHAxLCBwMiwgcGxhbmUpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwMCkgfHwgIWRlZmluZWRfZGVmYXVsdChwMSkgfHwgIWRlZmluZWRfZGVmYXVsdChwMikgfHwgIWRlZmluZWRfZGVmYXVsdChwbGFuZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwMCwgcDEsIHAyLCBhbmQgcGxhbmUgYXJlIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBwbGFuZU5vcm1hbCA9IHBsYW5lLm5vcm1hbDsKICAgICAgICBjb25zdCBwbGFuZUQgPSBwbGFuZS5kaXN0YW5jZTsKICAgICAgICBjb25zdCBwMEJlaGluZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QocGxhbmVOb3JtYWwsIHAwKSArIHBsYW5lRCA8IDA7CiAgICAgICAgY29uc3QgcDFCZWhpbmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHBsYW5lTm9ybWFsLCBwMSkgKyBwbGFuZUQgPCAwOwogICAgICAgIGNvbnN0IHAyQmVoaW5kID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChwbGFuZU5vcm1hbCwgcDIpICsgcGxhbmVEIDwgMDsKICAgICAgICBsZXQgbnVtQmVoaW5kID0gMDsKICAgICAgICBudW1CZWhpbmQgKz0gcDBCZWhpbmQgPyAxIDogMDsKICAgICAgICBudW1CZWhpbmQgKz0gcDFCZWhpbmQgPyAxIDogMDsKICAgICAgICBudW1CZWhpbmQgKz0gcDJCZWhpbmQgPyAxIDogMDsKICAgICAgICBsZXQgdTEyLCB1MjI7CiAgICAgICAgaWYgKG51bUJlaGluZCA9PT0gMSB8fCBudW1CZWhpbmQgPT09IDIpIHsKICAgICAgICAgIHUxMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICAgIHUyMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgaWYgKG51bUJlaGluZCA9PT0gMSkgewogICAgICAgICAgaWYgKHAwQmVoaW5kKSB7CiAgICAgICAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50UGxhbmUocDAsIHAxLCBwbGFuZSwgdTEyKTsKICAgICAgICAgICAgSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRQbGFuZShwMCwgcDIsIHBsYW5lLCB1MjIpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHBvc2l0aW9uczogW3AwLCBwMSwgcDIsIHUxMiwgdTIyXSwKICAgICAgICAgICAgICBpbmRpY2VzOiBbCiAgICAgICAgICAgICAgICAvLyBCZWhpbmQKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAzLAogICAgICAgICAgICAgICAgNCwKICAgICAgICAgICAgICAgIC8vIEluIGZyb250CiAgICAgICAgICAgICAgICAxLAogICAgICAgICAgICAgICAgMiwKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAxLAogICAgICAgICAgICAgICAgNCwKICAgICAgICAgICAgICAgIDMKICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgaWYgKHAxQmVoaW5kKSB7CiAgICAgICAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50UGxhbmUocDEsIHAyLCBwbGFuZSwgdTEyKTsKICAgICAgICAgICAgSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRQbGFuZShwMSwgcDAsIHBsYW5lLCB1MjIpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHBvc2l0aW9uczogW3AwLCBwMSwgcDIsIHUxMiwgdTIyXSwKICAgICAgICAgICAgICBpbmRpY2VzOiBbCiAgICAgICAgICAgICAgICAvLyBCZWhpbmQKICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICAzLAogICAgICAgICAgICAgICAgNCwKICAgICAgICAgICAgICAgIC8vIEluIGZyb250CiAgICAgICAgICAgICAgICAyLAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAyLAogICAgICAgICAgICAgICAgNCwKICAgICAgICAgICAgICAgIDMKICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgaWYgKHAyQmVoaW5kKSB7CiAgICAgICAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50UGxhbmUocDIsIHAwLCBwbGFuZSwgdTEyKTsKICAgICAgICAgICAgSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRQbGFuZShwMiwgcDEsIHBsYW5lLCB1MjIpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHBvc2l0aW9uczogW3AwLCBwMSwgcDIsIHUxMiwgdTIyXSwKICAgICAgICAgICAgICBpbmRpY2VzOiBbCiAgICAgICAgICAgICAgICAvLyBCZWhpbmQKICAgICAgICAgICAgICAgIDIsCiAgICAgICAgICAgICAgICAzLAogICAgICAgICAgICAgICAgNCwKICAgICAgICAgICAgICAgIC8vIEluIGZyb250CiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgMSwKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgNCwKICAgICAgICAgICAgICAgIDMKICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChudW1CZWhpbmQgPT09IDIpIHsKICAgICAgICAgIGlmICghcDBCZWhpbmQpIHsKICAgICAgICAgICAgSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRQbGFuZShwMSwgcDAsIHBsYW5lLCB1MTIpOwogICAgICAgICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFBsYW5lKHAyLCBwMCwgcGxhbmUsIHUyMik7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgcG9zaXRpb25zOiBbcDAsIHAxLCBwMiwgdTEyLCB1MjJdLAogICAgICAgICAgICAgIGluZGljZXM6IFsKICAgICAgICAgICAgICAgIC8vIEJlaGluZAogICAgICAgICAgICAgICAgMSwKICAgICAgICAgICAgICAgIDIsCiAgICAgICAgICAgICAgICA0LAogICAgICAgICAgICAgICAgMSwKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAzLAogICAgICAgICAgICAgICAgLy8gSW4gZnJvbnQKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAzLAogICAgICAgICAgICAgICAgNAogICAgICAgICAgICAgIF0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSBpZiAoIXAxQmVoaW5kKSB7CiAgICAgICAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50UGxhbmUocDIsIHAxLCBwbGFuZSwgdTEyKTsKICAgICAgICAgICAgSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRQbGFuZShwMCwgcDEsIHBsYW5lLCB1MjIpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHBvc2l0aW9uczogW3AwLCBwMSwgcDIsIHUxMiwgdTIyXSwKICAgICAgICAgICAgICBpbmRpY2VzOiBbCiAgICAgICAgICAgICAgICAvLyBCZWhpbmQKICAgICAgICAgICAgICAgIDIsCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgNCwKICAgICAgICAgICAgICAgIDIsCiAgICAgICAgICAgICAgICA0LAogICAgICAgICAgICAgICAgMywKICAgICAgICAgICAgICAgIC8vIEluIGZyb250CiAgICAgICAgICAgICAgICAxLAogICAgICAgICAgICAgICAgMywKICAgICAgICAgICAgICAgIDQKICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgaWYgKCFwMkJlaGluZCkgewogICAgICAgICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFBsYW5lKHAwLCBwMiwgcGxhbmUsIHUxMik7CiAgICAgICAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50UGxhbmUocDEsIHAyLCBwbGFuZSwgdTIyKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBwb3NpdGlvbnM6IFtwMCwgcDEsIHAyLCB1MTIsIHUyMl0sCiAgICAgICAgICAgICAgaW5kaWNlczogWwogICAgICAgICAgICAgICAgLy8gQmVoaW5kCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgMSwKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgNCwKICAgICAgICAgICAgICAgIDMsCiAgICAgICAgICAgICAgICAvLyBJbiBmcm9udAogICAgICAgICAgICAgICAgMiwKICAgICAgICAgICAgICAgIDMsCiAgICAgICAgICAgICAgICA0CiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICB9OwogICAgICBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0ID0gSW50ZXJzZWN0aW9uVGVzdHM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9QbGFuZS5qcwogIGZ1bmN0aW9uIFBsYW5lKG5vcm1hbDIsIGRpc3RhbmNlKSB7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm5vcm1hbCIsIG5vcm1hbDIpOwogICAgaWYgKCFNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZShub3JtYWwyKSwKICAgICAgMSwKICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT042CiAgICApKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJub3JtYWwgbXVzdCBiZSBub3JtYWxpemVkLiIpOwogICAgfQogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJkaXN0YW5jZSIsIGRpc3RhbmNlKTsKICAgIHRoaXMubm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG5vcm1hbDIpOwogICAgdGhpcy5kaXN0YW5jZSA9IGRpc3RhbmNlOwogIH0KICB2YXIgc2NyYXRjaE5vcm1hbCwgc2NyYXRjaENhcnRlc2lhbiwgc2NyYXRjaEludmVyc2VUcmFuc3Bvc2UsIHNjcmF0Y2hQbGFuZUNhcnRlc2lhbjQsIHNjcmF0Y2hUcmFuc2Zvcm1Ob3JtYWwsIFBsYW5lX2RlZmF1bHQ7CiAgdmFyIGluaXRfUGxhbmUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BsYW5lLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuNCgpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgUGxhbmUuZnJvbVBvaW50Tm9ybWFsID0gZnVuY3Rpb24ocG9pbnQsIG5vcm1hbDIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicG9pbnQiLCBwb2ludCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJub3JtYWwiLCBub3JtYWwyKTsKICAgICAgICBpZiAoIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZShub3JtYWwyKSwKICAgICAgICAgIDEsCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjYKICAgICAgICApKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibm9ybWFsIG11c3QgYmUgbm9ybWFsaXplZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGlzdGFuY2UgPSAtQ2FydGVzaWFuM19kZWZhdWx0LmRvdChub3JtYWwyLCBwb2ludCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBQbGFuZShub3JtYWwyLCBkaXN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShub3JtYWwyLCByZXN1bHQubm9ybWFsKTsKICAgICAgICByZXN1bHQuZGlzdGFuY2UgPSBkaXN0YW5jZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBQbGFuZS5mcm9tQ2FydGVzaWFuNCA9IGZ1bmN0aW9uKGNvZWZmaWNpZW50cywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjb2VmZmljaWVudHMiLCBjb2VmZmljaWVudHMpOwogICAgICAgIGNvbnN0IG5vcm1hbDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUNhcnRlc2lhbjQoY29lZmZpY2llbnRzLCBzY3JhdGNoTm9ybWFsKTsKICAgICAgICBjb25zdCBkaXN0YW5jZSA9IGNvZWZmaWNpZW50cy53OwogICAgICAgIGlmICghTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKG5vcm1hbDIpLAogICAgICAgICAgMSwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9ONgogICAgICAgICkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJub3JtYWwgbXVzdCBiZSBub3JtYWxpemVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFBsYW5lKG5vcm1hbDIsIGRpc3RhbmNlKTsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG5vcm1hbDIsIHJlc3VsdC5ub3JtYWwpOwogICAgICAgIHJlc3VsdC5kaXN0YW5jZSA9IGRpc3RhbmNlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFBsYW5lLmdldFBvaW50RGlzdGFuY2UgPSBmdW5jdGlvbihwbGFuZSwgcG9pbnQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInBsYW5lIiwgcGxhbmUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicG9pbnQiLCBwb2ludCk7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5kb3QocGxhbmUubm9ybWFsLCBwb2ludCkgKyBwbGFuZS5kaXN0YW5jZTsKICAgICAgfTsKICAgICAgc2NyYXRjaENhcnRlc2lhbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgUGxhbmUucHJvamVjdFBvaW50T250b1BsYW5lID0gZnVuY3Rpb24ocGxhbmUsIHBvaW50LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInBsYW5lIiwgcGxhbmUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicG9pbnQiLCBwb2ludCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBwb2ludERpc3RhbmNlID0gUGxhbmUuZ2V0UG9pbnREaXN0YW5jZShwbGFuZSwgcG9pbnQpOwogICAgICAgIGNvbnN0IHNjYWxlZE5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgcGxhbmUubm9ybWFsLAogICAgICAgICAgcG9pbnREaXN0YW5jZSwKICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4KICAgICAgICApOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocG9pbnQsIHNjYWxlZE5vcm1hbCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgc2NyYXRjaEludmVyc2VUcmFuc3Bvc2UgPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQbGFuZUNhcnRlc2lhbjQgPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hUcmFuc2Zvcm1Ob3JtYWwgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFBsYW5lLnRyYW5zZm9ybSA9IGZ1bmN0aW9uKHBsYW5lLCB0cmFuc2Zvcm0yLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInBsYW5lIiwgcGxhbmUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidHJhbnNmb3JtIiwgdHJhbnNmb3JtMik7CiAgICAgICAgY29uc3Qgbm9ybWFsMiA9IHBsYW5lLm5vcm1hbDsKICAgICAgICBjb25zdCBkaXN0YW5jZSA9IHBsYW5lLmRpc3RhbmNlOwogICAgICAgIGNvbnN0IGludmVyc2VUcmFuc3Bvc2UyID0gTWF0cml4NF9kZWZhdWx0LmludmVyc2VUcmFuc3Bvc2UoCiAgICAgICAgICB0cmFuc2Zvcm0yLAogICAgICAgICAgc2NyYXRjaEludmVyc2VUcmFuc3Bvc2UKICAgICAgICApOwogICAgICAgIGxldCBwbGFuZUFzQ2FydGVzaWFuNCA9IENhcnRlc2lhbjRfZGVmYXVsdC5mcm9tRWxlbWVudHMoCiAgICAgICAgICBub3JtYWwyLngsCiAgICAgICAgICBub3JtYWwyLnksCiAgICAgICAgICBub3JtYWwyLnosCiAgICAgICAgICBkaXN0YW5jZSwKICAgICAgICAgIHNjcmF0Y2hQbGFuZUNhcnRlc2lhbjQKICAgICAgICApOwogICAgICAgIHBsYW5lQXNDYXJ0ZXNpYW40ID0gTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoCiAgICAgICAgICBpbnZlcnNlVHJhbnNwb3NlMiwKICAgICAgICAgIHBsYW5lQXNDYXJ0ZXNpYW40LAogICAgICAgICAgcGxhbmVBc0NhcnRlc2lhbjQKICAgICAgICApOwogICAgICAgIGNvbnN0IHRyYW5zZm9ybWVkTm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21DYXJ0ZXNpYW40KAogICAgICAgICAgcGxhbmVBc0NhcnRlc2lhbjQsCiAgICAgICAgICBzY3JhdGNoVHJhbnNmb3JtTm9ybWFsCiAgICAgICAgKTsKICAgICAgICBwbGFuZUFzQ2FydGVzaWFuNCA9IENhcnRlc2lhbjRfZGVmYXVsdC5kaXZpZGVCeVNjYWxhcigKICAgICAgICAgIHBsYW5lQXNDYXJ0ZXNpYW40LAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSh0cmFuc2Zvcm1lZE5vcm1hbCksCiAgICAgICAgICBwbGFuZUFzQ2FydGVzaWFuNAogICAgICAgICk7CiAgICAgICAgcmV0dXJuIFBsYW5lLmZyb21DYXJ0ZXNpYW40KHBsYW5lQXNDYXJ0ZXNpYW40LCByZXN1bHQpOwogICAgICB9OwogICAgICBQbGFuZS5jbG9uZSA9IGZ1bmN0aW9uKHBsYW5lLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInBsYW5lIiwgcGxhbmUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUGxhbmUocGxhbmUubm9ybWFsLCBwbGFuZS5kaXN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwbGFuZS5ub3JtYWwsIHJlc3VsdC5ub3JtYWwpOwogICAgICAgIHJlc3VsdC5kaXN0YW5jZSA9IHBsYW5lLmRpc3RhbmNlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFBsYW5lLmVxdWFscyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICByZXR1cm4gbGVmdC5kaXN0YW5jZSA9PT0gcmlnaHQuZGlzdGFuY2UgJiYgQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhsZWZ0Lm5vcm1hbCwgcmlnaHQubm9ybWFsKTsKICAgICAgfTsKICAgICAgUGxhbmUuT1JJR0lOX1hZX1BMQU5FID0gT2JqZWN0LmZyZWV6ZShuZXcgUGxhbmUoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWiwgMCkpOwogICAgICBQbGFuZS5PUklHSU5fWVpfUExBTkUgPSBPYmplY3QuZnJlZXplKG5ldyBQbGFuZShDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YLCAwKSk7CiAgICAgIFBsYW5lLk9SSUdJTl9aWF9QTEFORSA9IE9iamVjdC5mcmVlemUobmV3IFBsYW5lKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1ksIDApKTsKICAgICAgUGxhbmVfZGVmYXVsdCA9IFBsYW5lOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVGlwc2lmeS5qcwogIHZhciBUaXBzaWZ5LCBUaXBzaWZ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfVGlwc2lmeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVGlwc2lmeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIFRpcHNpZnkgPSB7fTsKICAgICAgVGlwc2lmeS5jYWxjdWxhdGVBQ01SID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGNvbnN0IGluZGljZXMgPSBvcHRpb25zLmluZGljZXM7CiAgICAgICAgbGV0IG1heGltdW1JbmRleCA9IG9wdGlvbnMubWF4aW11bUluZGV4OwogICAgICAgIGNvbnN0IGNhY2hlU2l6ZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuY2FjaGVTaXplLCAyNCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaW5kaWNlcykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJpbmRpY2VzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBudW1JbmRpY2VzID0gaW5kaWNlcy5sZW5ndGg7CiAgICAgICAgaWYgKG51bUluZGljZXMgPCAzIHx8IG51bUluZGljZXMgJSAzICE9PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiaW5kaWNlcyBsZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIHRocmVlLiIpOwogICAgICAgIH0KICAgICAgICBpZiAobWF4aW11bUluZGV4IDw9IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJtYXhpbXVtSW5kZXggbXVzdCBiZSBncmVhdGVyIHRoYW4gemVyby4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKGNhY2hlU2l6ZSA8IDMpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjYWNoZVNpemUgbXVzdCBiZSBncmVhdGVyIHRoYW4gdHdvLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChtYXhpbXVtSW5kZXgpKSB7CiAgICAgICAgICBtYXhpbXVtSW5kZXggPSAwOwogICAgICAgICAgbGV0IGN1cnJlbnRJbmRleCA9IDA7CiAgICAgICAgICBsZXQgaW50b0luZGljZXMgPSBpbmRpY2VzW2N1cnJlbnRJbmRleF07CiAgICAgICAgICB3aGlsZSAoY3VycmVudEluZGV4IDwgbnVtSW5kaWNlcykgewogICAgICAgICAgICBpZiAoaW50b0luZGljZXMgPiBtYXhpbXVtSW5kZXgpIHsKICAgICAgICAgICAgICBtYXhpbXVtSW5kZXggPSBpbnRvSW5kaWNlczsKICAgICAgICAgICAgfQogICAgICAgICAgICArK2N1cnJlbnRJbmRleDsKICAgICAgICAgICAgaW50b0luZGljZXMgPSBpbmRpY2VzW2N1cnJlbnRJbmRleF07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IHZlcnRleFRpbWVTdGFtcHMgPSBbXTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1heGltdW1JbmRleCArIDE7IGkrKykgewogICAgICAgICAgdmVydGV4VGltZVN0YW1wc1tpXSA9IDA7CiAgICAgICAgfQogICAgICAgIGxldCBzID0gY2FjaGVTaXplICsgMTsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IG51bUluZGljZXM7ICsraikgewogICAgICAgICAgaWYgKHMgLSB2ZXJ0ZXhUaW1lU3RhbXBzW2luZGljZXNbal1dID4gY2FjaGVTaXplKSB7CiAgICAgICAgICAgIHZlcnRleFRpbWVTdGFtcHNbaW5kaWNlc1tqXV0gPSBzOwogICAgICAgICAgICArK3M7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiAocyAtIGNhY2hlU2l6ZSArIDEpIC8gKG51bUluZGljZXMgLyAzKTsKICAgICAgfTsKICAgICAgVGlwc2lmeS50aXBzaWZ5ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGNvbnN0IGluZGljZXMgPSBvcHRpb25zLmluZGljZXM7CiAgICAgICAgY29uc3QgbWF4aW11bUluZGV4ID0gb3B0aW9ucy5tYXhpbXVtSW5kZXg7CiAgICAgICAgY29uc3QgY2FjaGVTaXplID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5jYWNoZVNpemUsIDI0KTsKICAgICAgICBsZXQgY3Vyc29yOwogICAgICAgIGZ1bmN0aW9uIHNraXBEZWFkRW5kKHZlcnRpY2VzMiwgZGVhZEVuZDIsIGluZGljZXMyLCBtYXhpbXVtSW5kZXhQbHVzT25lMikgewogICAgICAgICAgd2hpbGUgKGRlYWRFbmQyLmxlbmd0aCA+PSAxKSB7CiAgICAgICAgICAgIGNvbnN0IGQgPSBkZWFkRW5kMltkZWFkRW5kMi5sZW5ndGggLSAxXTsKICAgICAgICAgICAgZGVhZEVuZDIuc3BsaWNlKGRlYWRFbmQyLmxlbmd0aCAtIDEsIDEpOwogICAgICAgICAgICBpZiAodmVydGljZXMyW2RdLm51bUxpdmVUcmlhbmdsZXMgPiAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChjdXJzb3IgPCBtYXhpbXVtSW5kZXhQbHVzT25lMikgewogICAgICAgICAgICBpZiAodmVydGljZXMyW2N1cnNvcl0ubnVtTGl2ZVRyaWFuZ2xlcyA+IDApIHsKICAgICAgICAgICAgICArK2N1cnNvcjsKICAgICAgICAgICAgICByZXR1cm4gY3Vyc29yIC0gMTsKICAgICAgICAgICAgfQogICAgICAgICAgICArK2N1cnNvcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmV4dFZlcnRleChpbmRpY2VzMiwgY2FjaGVTaXplMiwgb25lUmluZzIsIHZlcnRpY2VzMiwgczIsIGRlYWRFbmQyLCBtYXhpbXVtSW5kZXhQbHVzT25lMikgewogICAgICAgICAgbGV0IG4gPSAtMTsKICAgICAgICAgIGxldCBwOwogICAgICAgICAgbGV0IG0gPSAtMTsKICAgICAgICAgIGxldCBpdE9uZVJpbmcgPSAwOwogICAgICAgICAgd2hpbGUgKGl0T25lUmluZyA8IG9uZVJpbmcyLmxlbmd0aCkgewogICAgICAgICAgICBjb25zdCBpbmRleDIgPSBvbmVSaW5nMltpdE9uZVJpbmddOwogICAgICAgICAgICBpZiAodmVydGljZXMyW2luZGV4Ml0ubnVtTGl2ZVRyaWFuZ2xlcykgewogICAgICAgICAgICAgIHAgPSAwOwogICAgICAgICAgICAgIGlmIChzMiAtIHZlcnRpY2VzMltpbmRleDJdLnRpbWVTdGFtcCArIDIgKiB2ZXJ0aWNlczJbaW5kZXgyXS5udW1MaXZlVHJpYW5nbGVzIDw9IGNhY2hlU2l6ZTIpIHsKICAgICAgICAgICAgICAgIHAgPSBzMiAtIHZlcnRpY2VzMltpbmRleDJdLnRpbWVTdGFtcDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHAgPiBtIHx8IG0gPT09IC0xKSB7CiAgICAgICAgICAgICAgICBtID0gcDsKICAgICAgICAgICAgICAgIG4gPSBpbmRleDI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgICsraXRPbmVSaW5nOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG4gPT09IC0xKSB7CiAgICAgICAgICAgIHJldHVybiBza2lwRGVhZEVuZCh2ZXJ0aWNlczIsIGRlYWRFbmQyLCBpbmRpY2VzMiwgbWF4aW11bUluZGV4UGx1c09uZTIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG47CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGluZGljZXMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiaW5kaWNlcyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbnVtSW5kaWNlcyA9IGluZGljZXMubGVuZ3RoOwogICAgICAgIGlmIChudW1JbmRpY2VzIDwgMyB8fCBudW1JbmRpY2VzICUgMyAhPT0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImluZGljZXMgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiB0aHJlZS4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKG1heGltdW1JbmRleCA8PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibWF4aW11bUluZGV4IG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8uIik7CiAgICAgICAgfQogICAgICAgIGlmIChjYWNoZVNpemUgPCAzKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiY2FjaGVTaXplIG11c3QgYmUgZ3JlYXRlciB0aGFuIHR3by4iKTsKICAgICAgICB9CiAgICAgICAgbGV0IG1heGltdW1JbmRleFBsdXNPbmUgPSAwOwogICAgICAgIGxldCBjdXJyZW50SW5kZXggPSAwOwogICAgICAgIGxldCBpbnRvSW5kaWNlcyA9IGluZGljZXNbY3VycmVudEluZGV4XTsKICAgICAgICBjb25zdCBlbmRJbmRleCA9IG51bUluZGljZXM7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChtYXhpbXVtSW5kZXgpKSB7CiAgICAgICAgICBtYXhpbXVtSW5kZXhQbHVzT25lID0gbWF4aW11bUluZGV4ICsgMTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgd2hpbGUgKGN1cnJlbnRJbmRleCA8IGVuZEluZGV4KSB7CiAgICAgICAgICAgIGlmIChpbnRvSW5kaWNlcyA+IG1heGltdW1JbmRleFBsdXNPbmUpIHsKICAgICAgICAgICAgICBtYXhpbXVtSW5kZXhQbHVzT25lID0gaW50b0luZGljZXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKytjdXJyZW50SW5kZXg7CiAgICAgICAgICAgIGludG9JbmRpY2VzID0gaW5kaWNlc1tjdXJyZW50SW5kZXhdOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG1heGltdW1JbmRleFBsdXNPbmUgPT09IC0xKSB7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgfQogICAgICAgICAgKyttYXhpbXVtSW5kZXhQbHVzT25lOwogICAgICAgIH0KICAgICAgICBjb25zdCB2ZXJ0aWNlcyA9IFtdOwogICAgICAgIGxldCBpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBtYXhpbXVtSW5kZXhQbHVzT25lOyBpKyspIHsKICAgICAgICAgIHZlcnRpY2VzW2ldID0gewogICAgICAgICAgICBudW1MaXZlVHJpYW5nbGVzOiAwLAogICAgICAgICAgICB0aW1lU3RhbXA6IDAsCiAgICAgICAgICAgIHZlcnRleFRyaWFuZ2xlczogW10KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGN1cnJlbnRJbmRleCA9IDA7CiAgICAgICAgbGV0IHRyaWFuZ2xlID0gMDsKICAgICAgICB3aGlsZSAoY3VycmVudEluZGV4IDwgZW5kSW5kZXgpIHsKICAgICAgICAgIHZlcnRpY2VzW2luZGljZXNbY3VycmVudEluZGV4XV0udmVydGV4VHJpYW5nbGVzLnB1c2godHJpYW5nbGUpOwogICAgICAgICAgKyt2ZXJ0aWNlc1tpbmRpY2VzW2N1cnJlbnRJbmRleF1dLm51bUxpdmVUcmlhbmdsZXM7CiAgICAgICAgICB2ZXJ0aWNlc1tpbmRpY2VzW2N1cnJlbnRJbmRleCArIDFdXS52ZXJ0ZXhUcmlhbmdsZXMucHVzaCh0cmlhbmdsZSk7CiAgICAgICAgICArK3ZlcnRpY2VzW2luZGljZXNbY3VycmVudEluZGV4ICsgMV1dLm51bUxpdmVUcmlhbmdsZXM7CiAgICAgICAgICB2ZXJ0aWNlc1tpbmRpY2VzW2N1cnJlbnRJbmRleCArIDJdXS52ZXJ0ZXhUcmlhbmdsZXMucHVzaCh0cmlhbmdsZSk7CiAgICAgICAgICArK3ZlcnRpY2VzW2luZGljZXNbY3VycmVudEluZGV4ICsgMl1dLm51bUxpdmVUcmlhbmdsZXM7CiAgICAgICAgICArK3RyaWFuZ2xlOwogICAgICAgICAgY3VycmVudEluZGV4ICs9IDM7CiAgICAgICAgfQogICAgICAgIGxldCBmID0gMDsKICAgICAgICBsZXQgcyA9IGNhY2hlU2l6ZSArIDE7CiAgICAgICAgY3Vyc29yID0gMTsKICAgICAgICBsZXQgb25lUmluZyA9IFtdOwogICAgICAgIGNvbnN0IGRlYWRFbmQgPSBbXTsKICAgICAgICBsZXQgdmVydGV4OwogICAgICAgIGxldCBpbnRvVmVydGljZXM7CiAgICAgICAgbGV0IGN1cnJlbnRPdXRwdXRJbmRleCA9IDA7CiAgICAgICAgY29uc3Qgb3V0cHV0SW5kaWNlcyA9IFtdOwogICAgICAgIGNvbnN0IG51bVRyaWFuZ2xlcyA9IG51bUluZGljZXMgLyAzOwogICAgICAgIGNvbnN0IHRyaWFuZ2xlRW1pdHRlZCA9IFtdOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1UcmlhbmdsZXM7IGkrKykgewogICAgICAgICAgdHJpYW5nbGVFbWl0dGVkW2ldID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGxldCBpbmRleDsKICAgICAgICBsZXQgbGltaXQ7CiAgICAgICAgd2hpbGUgKGYgIT09IC0xKSB7CiAgICAgICAgICBvbmVSaW5nID0gW107CiAgICAgICAgICBpbnRvVmVydGljZXMgPSB2ZXJ0aWNlc1tmXTsKICAgICAgICAgIGxpbWl0ID0gaW50b1ZlcnRpY2VzLnZlcnRleFRyaWFuZ2xlcy5sZW5ndGg7CiAgICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IGxpbWl0OyArK2spIHsKICAgICAgICAgICAgdHJpYW5nbGUgPSBpbnRvVmVydGljZXMudmVydGV4VHJpYW5nbGVzW2tdOwogICAgICAgICAgICBpZiAoIXRyaWFuZ2xlRW1pdHRlZFt0cmlhbmdsZV0pIHsKICAgICAgICAgICAgICB0cmlhbmdsZUVtaXR0ZWRbdHJpYW5nbGVdID0gdHJ1ZTsKICAgICAgICAgICAgICBjdXJyZW50SW5kZXggPSB0cmlhbmdsZSArIHRyaWFuZ2xlICsgdHJpYW5nbGU7CiAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCAzOyArK2opIHsKICAgICAgICAgICAgICAgIGluZGV4ID0gaW5kaWNlc1tjdXJyZW50SW5kZXhdOwogICAgICAgICAgICAgICAgb25lUmluZy5wdXNoKGluZGV4KTsKICAgICAgICAgICAgICAgIGRlYWRFbmQucHVzaChpbmRleCk7CiAgICAgICAgICAgICAgICBvdXRwdXRJbmRpY2VzW2N1cnJlbnRPdXRwdXRJbmRleF0gPSBpbmRleDsKICAgICAgICAgICAgICAgICsrY3VycmVudE91dHB1dEluZGV4OwogICAgICAgICAgICAgICAgdmVydGV4ID0gdmVydGljZXNbaW5kZXhdOwogICAgICAgICAgICAgICAgLS12ZXJ0ZXgubnVtTGl2ZVRyaWFuZ2xlczsKICAgICAgICAgICAgICAgIGlmIChzIC0gdmVydGV4LnRpbWVTdGFtcCA+IGNhY2hlU2l6ZSkgewogICAgICAgICAgICAgICAgICB2ZXJ0ZXgudGltZVN0YW1wID0gczsKICAgICAgICAgICAgICAgICAgKytzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgKytjdXJyZW50SW5kZXg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmID0gZ2V0TmV4dFZlcnRleCgKICAgICAgICAgICAgaW5kaWNlcywKICAgICAgICAgICAgY2FjaGVTaXplLAogICAgICAgICAgICBvbmVSaW5nLAogICAgICAgICAgICB2ZXJ0aWNlcywKICAgICAgICAgICAgcywKICAgICAgICAgICAgZGVhZEVuZCwKICAgICAgICAgICAgbWF4aW11bUluZGV4UGx1c09uZQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG91dHB1dEluZGljZXM7CiAgICAgIH07CiAgICAgIFRpcHNpZnlfZGVmYXVsdCA9IFRpcHNpZnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9HZW9tZXRyeVBpcGVsaW5lLmpzCiAgZnVuY3Rpb24gYWRkVHJpYW5nbGUobGluZXMsIGluZGV4LCBpMCwgaTEsIGkyKSB7CiAgICBsaW5lc1tpbmRleCsrXSA9IGkwOwogICAgbGluZXNbaW5kZXgrK10gPSBpMTsKICAgIGxpbmVzW2luZGV4KytdID0gaTE7CiAgICBsaW5lc1tpbmRleCsrXSA9IGkyOwogICAgbGluZXNbaW5kZXgrK10gPSBpMjsKICAgIGxpbmVzW2luZGV4XSA9IGkwOwogIH0KICBmdW5jdGlvbiB0cmlhbmdsZXNUb0xpbmVzKHRyaWFuZ2xlcykgewogICAgY29uc3QgY291bnQgPSB0cmlhbmdsZXMubGVuZ3RoOwogICAgY29uc3Qgc2l6ZSA9IGNvdW50IC8gMyAqIDY7CiAgICBjb25zdCBsaW5lcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KGNvdW50LCBzaXplKTsKICAgIGxldCBpbmRleCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpICs9IDMsIGluZGV4ICs9IDYpIHsKICAgICAgYWRkVHJpYW5nbGUobGluZXMsIGluZGV4LCB0cmlhbmdsZXNbaV0sIHRyaWFuZ2xlc1tpICsgMV0sIHRyaWFuZ2xlc1tpICsgMl0pOwogICAgfQogICAgcmV0dXJuIGxpbmVzOwogIH0KICBmdW5jdGlvbiB0cmlhbmdsZVN0cmlwVG9MaW5lcyh0cmlhbmdsZXMpIHsKICAgIGNvbnN0IGNvdW50ID0gdHJpYW5nbGVzLmxlbmd0aDsKICAgIGlmIChjb3VudCA+PSAzKSB7CiAgICAgIGNvbnN0IHNpemUgPSAoY291bnQgLSAyKSAqIDY7CiAgICAgIGNvbnN0IGxpbmVzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoY291bnQsIHNpemUpOwogICAgICBhZGRUcmlhbmdsZShsaW5lcywgMCwgdHJpYW5nbGVzWzBdLCB0cmlhbmdsZXNbMV0sIHRyaWFuZ2xlc1syXSk7CiAgICAgIGxldCBpbmRleCA9IDY7CiAgICAgIGZvciAobGV0IGkgPSAzOyBpIDwgY291bnQ7ICsraSwgaW5kZXggKz0gNikgewogICAgICAgIGFkZFRyaWFuZ2xlKAogICAgICAgICAgbGluZXMsCiAgICAgICAgICBpbmRleCwKICAgICAgICAgIHRyaWFuZ2xlc1tpIC0gMV0sCiAgICAgICAgICB0cmlhbmdsZXNbaV0sCiAgICAgICAgICB0cmlhbmdsZXNbaSAtIDJdCiAgICAgICAgKTsKICAgICAgfQogICAgICByZXR1cm4gbGluZXM7CiAgICB9CiAgICByZXR1cm4gbmV3IFVpbnQxNkFycmF5KCk7CiAgfQogIGZ1bmN0aW9uIHRyaWFuZ2xlRmFuVG9MaW5lcyh0cmlhbmdsZXMpIHsKICAgIGlmICh0cmlhbmdsZXMubGVuZ3RoID4gMCkgewogICAgICBjb25zdCBjb3VudCA9IHRyaWFuZ2xlcy5sZW5ndGggLSAxOwogICAgICBjb25zdCBzaXplID0gKGNvdW50IC0gMSkgKiA2OwogICAgICBjb25zdCBsaW5lcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KGNvdW50LCBzaXplKTsKICAgICAgY29uc3QgYmFzZSA9IHRyaWFuZ2xlc1swXTsKICAgICAgbGV0IGluZGV4ID0gMDsKICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBjb3VudDsgKytpLCBpbmRleCArPSA2KSB7CiAgICAgICAgYWRkVHJpYW5nbGUobGluZXMsIGluZGV4LCBiYXNlLCB0cmlhbmdsZXNbaV0sIHRyaWFuZ2xlc1tpICsgMV0pOwogICAgICB9CiAgICAgIHJldHVybiBsaW5lczsKICAgIH0KICAgIHJldHVybiBuZXcgVWludDE2QXJyYXkoKTsKICB9CiAgZnVuY3Rpb24gY29weUF0dHJpYnV0ZXNEZXNjcmlwdGlvbnMoYXR0cmlidXRlcykgewogICAgY29uc3QgbmV3QXR0cmlidXRlcyA9IHt9OwogICAgZm9yIChjb25zdCBhdHRyaWJ1dGUgaW4gYXR0cmlidXRlcykgewogICAgICBpZiAoYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShhdHRyaWJ1dGUpICYmIGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzW2F0dHJpYnV0ZV0pICYmIGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzW2F0dHJpYnV0ZV0udmFsdWVzKSkgewogICAgICAgIGNvbnN0IGF0dHIgPSBhdHRyaWJ1dGVzW2F0dHJpYnV0ZV07CiAgICAgICAgbmV3QXR0cmlidXRlc1thdHRyaWJ1dGVdID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IGF0dHIuY29tcG9uZW50RGF0YXR5cGUsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiBhdHRyLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGUsCiAgICAgICAgICBub3JtYWxpemU6IGF0dHIubm9ybWFsaXplLAogICAgICAgICAgdmFsdWVzOiBbXQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbmV3QXR0cmlidXRlczsKICB9CiAgZnVuY3Rpb24gY29weVZlcnRleChkZXN0aW5hdGlvbkF0dHJpYnV0ZXMsIHNvdXJjZUF0dHJpYnV0ZXMsIGluZGV4KSB7CiAgICBmb3IgKGNvbnN0IGF0dHJpYnV0ZSBpbiBzb3VyY2VBdHRyaWJ1dGVzKSB7CiAgICAgIGlmIChzb3VyY2VBdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KGF0dHJpYnV0ZSkgJiYgZGVmaW5lZF9kZWZhdWx0KHNvdXJjZUF0dHJpYnV0ZXNbYXR0cmlidXRlXSkgJiYgZGVmaW5lZF9kZWZhdWx0KHNvdXJjZUF0dHJpYnV0ZXNbYXR0cmlidXRlXS52YWx1ZXMpKSB7CiAgICAgICAgY29uc3QgYXR0ciA9IHNvdXJjZUF0dHJpYnV0ZXNbYXR0cmlidXRlXTsKICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IGF0dHIuY29tcG9uZW50c1BlckF0dHJpYnV0ZTsgKytrKSB7CiAgICAgICAgICBkZXN0aW5hdGlvbkF0dHJpYnV0ZXNbYXR0cmlidXRlXS52YWx1ZXMucHVzaCgKICAgICAgICAgICAgYXR0ci52YWx1ZXNbaW5kZXggKiBhdHRyLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGUgKyBrXQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gdHJhbnNmb3JtUG9pbnQobWF0cml4LCBhdHRyaWJ1dGUpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlKSkgewogICAgICBjb25zdCB2YWx1ZXMgPSBhdHRyaWJ1dGUudmFsdWVzOwogICAgICBjb25zdCBsZW5ndGggPSB2YWx1ZXMubGVuZ3RoOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAzKSB7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayh2YWx1ZXMsIGksIHNjcmF0Y2hDYXJ0ZXNpYW4zMyk7CiAgICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludChtYXRyaXgsIHNjcmF0Y2hDYXJ0ZXNpYW4zMywgc2NyYXRjaENhcnRlc2lhbjMzKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhzY3JhdGNoQ2FydGVzaWFuMzMsIHZhbHVlcywgaSk7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gdHJhbnNmb3JtVmVjdG9yKG1hdHJpeCwgYXR0cmlidXRlKSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZSkpIHsKICAgICAgY29uc3QgdmFsdWVzID0gYXR0cmlidXRlLnZhbHVlczsKICAgICAgY29uc3QgbGVuZ3RoID0gdmFsdWVzLmxlbmd0aDsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMykgewogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2sodmFsdWVzLCBpLCBzY3JhdGNoQ2FydGVzaWFuMzMpOwogICAgICAgIE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKG1hdHJpeCwgc2NyYXRjaENhcnRlc2lhbjMzLCBzY3JhdGNoQ2FydGVzaWFuMzMpOwogICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zMyA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuMzMsCiAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuMzMKICAgICAgICApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHNjcmF0Y2hDYXJ0ZXNpYW4zMywgdmFsdWVzLCBpKTsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBmaW5kQXR0cmlidXRlc0luQWxsR2VvbWV0cmllcyhpbnN0YW5jZXMsIHByb3BlcnR5TmFtZSkgewogICAgY29uc3QgbGVuZ3RoID0gaW5zdGFuY2VzLmxlbmd0aDsKICAgIGNvbnN0IGF0dHJpYnV0ZXNJbkFsbEdlb21ldHJpZXMgPSB7fTsKICAgIGNvbnN0IGF0dHJpYnV0ZXMwID0gaW5zdGFuY2VzWzBdW3Byb3BlcnR5TmFtZV0uYXR0cmlidXRlczsKICAgIGxldCBuYW1lOwogICAgZm9yIChuYW1lIGluIGF0dHJpYnV0ZXMwKSB7CiAgICAgIGlmIChhdHRyaWJ1dGVzMC5oYXNPd25Qcm9wZXJ0eShuYW1lKSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlczBbbmFtZV0pICYmIGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzMFtuYW1lXS52YWx1ZXMpKSB7CiAgICAgICAgY29uc3QgYXR0cmlidXRlID0gYXR0cmlidXRlczBbbmFtZV07CiAgICAgICAgbGV0IG51bWJlck9mQ29tcG9uZW50cyA9IGF0dHJpYnV0ZS52YWx1ZXMubGVuZ3RoOwogICAgICAgIGxldCBpbkFsbEdlb21ldHJpZXMgPSB0cnVlOwogICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGNvbnN0IG90aGVyQXR0cmlidXRlID0gaW5zdGFuY2VzW2ldW3Byb3BlcnR5TmFtZV0uYXR0cmlidXRlc1tuYW1lXTsKICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG90aGVyQXR0cmlidXRlKSB8fCBhdHRyaWJ1dGUuY29tcG9uZW50RGF0YXR5cGUgIT09IG90aGVyQXR0cmlidXRlLmNvbXBvbmVudERhdGF0eXBlIHx8IGF0dHJpYnV0ZS5jb21wb25lbnRzUGVyQXR0cmlidXRlICE9PSBvdGhlckF0dHJpYnV0ZS5jb21wb25lbnRzUGVyQXR0cmlidXRlIHx8IGF0dHJpYnV0ZS5ub3JtYWxpemUgIT09IG90aGVyQXR0cmlidXRlLm5vcm1hbGl6ZSkgewogICAgICAgICAgICBpbkFsbEdlb21ldHJpZXMgPSBmYWxzZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBudW1iZXJPZkNvbXBvbmVudHMgKz0gb3RoZXJBdHRyaWJ1dGUudmFsdWVzLmxlbmd0aDsKICAgICAgICB9CiAgICAgICAgaWYgKGluQWxsR2VvbWV0cmllcykgewogICAgICAgICAgYXR0cmlidXRlc0luQWxsR2VvbWV0cmllc1tuYW1lXSA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IGF0dHJpYnV0ZS5jb21wb25lbnREYXRhdHlwZSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogYXR0cmlidXRlLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGUsCiAgICAgICAgICAgIG5vcm1hbGl6ZTogYXR0cmlidXRlLm5vcm1hbGl6ZSwKICAgICAgICAgICAgdmFsdWVzOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgICAgICAgICAgYXR0cmlidXRlLmNvbXBvbmVudERhdGF0eXBlLAogICAgICAgICAgICAgIG51bWJlck9mQ29tcG9uZW50cwogICAgICAgICAgICApCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBhdHRyaWJ1dGVzSW5BbGxHZW9tZXRyaWVzOwogIH0KICBmdW5jdGlvbiBjb21iaW5lR2VvbWV0cmllcyhpbnN0YW5jZXMsIHByb3BlcnR5TmFtZSkgewogICAgY29uc3QgbGVuZ3RoID0gaW5zdGFuY2VzLmxlbmd0aDsKICAgIGxldCBuYW1lOwogICAgbGV0IGk7CiAgICBsZXQgajsKICAgIGxldCBrOwogICAgY29uc3QgbSA9IGluc3RhbmNlc1swXS5tb2RlbE1hdHJpeDsKICAgIGNvbnN0IGhhdmVJbmRpY2VzID0gZGVmaW5lZF9kZWZhdWx0KGluc3RhbmNlc1swXVtwcm9wZXJ0eU5hbWVdLmluZGljZXMpOwogICAgY29uc3QgcHJpbWl0aXZlVHlwZSA9IGluc3RhbmNlc1swXVtwcm9wZXJ0eU5hbWVdLnByaW1pdGl2ZVR5cGU7CiAgICBmb3IgKGkgPSAxOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgaWYgKCFNYXRyaXg0X2RlZmF1bHQuZXF1YWxzKGluc3RhbmNlc1tpXS5tb2RlbE1hdHJpeCwgbSkpIHsKICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiQWxsIGluc3RhbmNlcyBtdXN0IGhhdmUgdGhlIHNhbWUgbW9kZWxNYXRyaXguIik7CiAgICAgIH0KICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZXNbaV1bcHJvcGVydHlOYW1lXS5pbmRpY2VzKSAhPT0gaGF2ZUluZGljZXMpIHsKICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICJBbGwgaW5zdGFuY2UgZ2VvbWV0cmllcyBtdXN0IGhhdmUgYW4gaW5kaWNlcyBvciBub3QgaGF2ZSBvbmUuIgogICAgICAgICk7CiAgICAgIH0KICAgICAgaWYgKGluc3RhbmNlc1tpXVtwcm9wZXJ0eU5hbWVdLnByaW1pdGl2ZVR5cGUgIT09IHByaW1pdGl2ZVR5cGUpIHsKICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICJBbGwgaW5zdGFuY2UgZ2VvbWV0cmllcyBtdXN0IGhhdmUgdGhlIHNhbWUgcHJpbWl0aXZlVHlwZS4iCiAgICAgICAgKTsKICAgICAgfQogICAgfQogICAgY29uc3QgYXR0cmlidXRlcyA9IGZpbmRBdHRyaWJ1dGVzSW5BbGxHZW9tZXRyaWVzKGluc3RhbmNlcywgcHJvcGVydHlOYW1lKTsKICAgIGxldCB2YWx1ZXM7CiAgICBsZXQgc291cmNlVmFsdWVzOwogICAgbGV0IHNvdXJjZVZhbHVlc0xlbmd0aDsKICAgIGZvciAobmFtZSBpbiBhdHRyaWJ1dGVzKSB7CiAgICAgIGlmIChhdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgdmFsdWVzID0gYXR0cmlidXRlc1tuYW1lXS52YWx1ZXM7CiAgICAgICAgayA9IDA7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBzb3VyY2VWYWx1ZXMgPSBpbnN0YW5jZXNbaV1bcHJvcGVydHlOYW1lXS5hdHRyaWJ1dGVzW25hbWVdLnZhbHVlczsKICAgICAgICAgIHNvdXJjZVZhbHVlc0xlbmd0aCA9IHNvdXJjZVZhbHVlcy5sZW5ndGg7CiAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgc291cmNlVmFsdWVzTGVuZ3RoOyArK2opIHsKICAgICAgICAgICAgdmFsdWVzW2srK10gPSBzb3VyY2VWYWx1ZXNbal07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBsZXQgaW5kaWNlczsKICAgIGlmIChoYXZlSW5kaWNlcykgewogICAgICBsZXQgbnVtYmVyT2ZJbmRpY2VzID0gMDsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgbnVtYmVyT2ZJbmRpY2VzICs9IGluc3RhbmNlc1tpXVtwcm9wZXJ0eU5hbWVdLmluZGljZXMubGVuZ3RoOwogICAgICB9CiAgICAgIGNvbnN0IG51bWJlck9mVmVydGljZXMgPSBHZW9tZXRyeV9kZWZhdWx0LmNvbXB1dGVOdW1iZXJPZlZlcnRpY2VzKAogICAgICAgIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuUE9JTlRTCiAgICAgICAgfSkKICAgICAgKTsKICAgICAgY29uc3QgZGVzdEluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgICBudW1iZXJPZlZlcnRpY2VzLAogICAgICAgIG51bWJlck9mSW5kaWNlcwogICAgICApOwogICAgICBsZXQgZGVzdE9mZnNldCA9IDA7CiAgICAgIGxldCBvZmZzZXQgPSAwOwogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICBjb25zdCBzb3VyY2VJbmRpY2VzID0gaW5zdGFuY2VzW2ldW3Byb3BlcnR5TmFtZV0uaW5kaWNlczsKICAgICAgICBjb25zdCBzb3VyY2VJbmRpY2VzTGVuID0gc291cmNlSW5kaWNlcy5sZW5ndGg7CiAgICAgICAgZm9yIChrID0gMDsgayA8IHNvdXJjZUluZGljZXNMZW47ICsraykgewogICAgICAgICAgZGVzdEluZGljZXNbZGVzdE9mZnNldCsrXSA9IG9mZnNldCArIHNvdXJjZUluZGljZXNba107CiAgICAgICAgfQogICAgICAgIG9mZnNldCArPSBHZW9tZXRyeV9kZWZhdWx0LmNvbXB1dGVOdW1iZXJPZlZlcnRpY2VzKGluc3RhbmNlc1tpXVtwcm9wZXJ0eU5hbWVdKTsKICAgICAgfQogICAgICBpbmRpY2VzID0gZGVzdEluZGljZXM7CiAgICB9CiAgICBsZXQgY2VudGVyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgbGV0IHJhZGl1cyA9IDA7CiAgICBsZXQgYnM7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgYnMgPSBpbnN0YW5jZXNbaV1bcHJvcGVydHlOYW1lXS5ib3VuZGluZ1NwaGVyZTsKICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYnMpKSB7CiAgICAgICAgY2VudGVyID0gdm9pZCAwOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoYnMuY2VudGVyLCBjZW50ZXIsIGNlbnRlcik7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGNlbnRlcikpIHsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmRpdmlkZUJ5U2NhbGFyKGNlbnRlciwgbGVuZ3RoLCBjZW50ZXIpOwogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICBicyA9IGluc3RhbmNlc1tpXVtwcm9wZXJ0eU5hbWVdLmJvdW5kaW5nU3BoZXJlOwogICAgICAgIGNvbnN0IHRlbXBSYWRpdXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGJzLmNlbnRlciwgY2VudGVyLCB0ZW1wU2NyYXRjaCkKICAgICAgICApICsgYnMucmFkaXVzOwogICAgICAgIGlmICh0ZW1wUmFkaXVzID4gcmFkaXVzKSB7CiAgICAgICAgICByYWRpdXMgPSB0ZW1wUmFkaXVzOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgYXR0cmlidXRlcywKICAgICAgaW5kaWNlcywKICAgICAgcHJpbWl0aXZlVHlwZSwKICAgICAgYm91bmRpbmdTcGhlcmU6IGRlZmluZWRfZGVmYXVsdChjZW50ZXIpID8gbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoY2VudGVyLCByYWRpdXMpIDogdm9pZCAwCiAgICB9KTsKICB9CiAgZnVuY3Rpb24gaW5kZXhUcmlhbmdsZXMoZ2VvbWV0cnkpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkuaW5kaWNlcykpIHsKICAgICAgcmV0dXJuIGdlb21ldHJ5OwogICAgfQogICAgY29uc3QgbnVtYmVyT2ZWZXJ0aWNlcyA9IEdlb21ldHJ5X2RlZmF1bHQuY29tcHV0ZU51bWJlck9mVmVydGljZXMoZ2VvbWV0cnkpOwogICAgaWYgKG51bWJlck9mVmVydGljZXMgPCAzKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJUaGUgbnVtYmVyIG9mIHZlcnRpY2VzIG11c3QgYmUgYXQgbGVhc3QgdGhyZWUuIik7CiAgICB9CiAgICBpZiAobnVtYmVyT2ZWZXJ0aWNlcyAlIDMgIT09IDApIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIlRoZSBudW1iZXIgb2YgdmVydGljZXMgbXVzdCBiZSBhIG11bHRpcGxlIG9mIHRocmVlLiIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgbnVtYmVyT2ZWZXJ0aWNlcywKICAgICAgbnVtYmVyT2ZWZXJ0aWNlcwogICAgKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtYmVyT2ZWZXJ0aWNlczsgKytpKSB7CiAgICAgIGluZGljZXNbaV0gPSBpOwogICAgfQogICAgZ2VvbWV0cnkuaW5kaWNlcyA9IGluZGljZXM7CiAgICByZXR1cm4gZ2VvbWV0cnk7CiAgfQogIGZ1bmN0aW9uIGluZGV4VHJpYW5nbGVGYW4oZ2VvbWV0cnkpIHsKICAgIGNvbnN0IG51bWJlck9mVmVydGljZXMgPSBHZW9tZXRyeV9kZWZhdWx0LmNvbXB1dGVOdW1iZXJPZlZlcnRpY2VzKGdlb21ldHJ5KTsKICAgIGlmIChudW1iZXJPZlZlcnRpY2VzIDwgMykgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiVGhlIG51bWJlciBvZiB2ZXJ0aWNlcyBtdXN0IGJlIGF0IGxlYXN0IHRocmVlLiIpOwogICAgfQogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBudW1iZXJPZlZlcnRpY2VzLAogICAgICAobnVtYmVyT2ZWZXJ0aWNlcyAtIDIpICogMwogICAgKTsKICAgIGluZGljZXNbMF0gPSAxOwogICAgaW5kaWNlc1sxXSA9IDA7CiAgICBpbmRpY2VzWzJdID0gMjsKICAgIGxldCBpbmRpY2VzSW5kZXggPSAzOwogICAgZm9yIChsZXQgaSA9IDM7IGkgPCBudW1iZXJPZlZlcnRpY2VzOyArK2kpIHsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpIC0gMTsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSAwOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGk7CiAgICB9CiAgICBnZW9tZXRyeS5pbmRpY2VzID0gaW5kaWNlczsKICAgIGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUgPSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTOwogICAgcmV0dXJuIGdlb21ldHJ5OwogIH0KICBmdW5jdGlvbiBpbmRleFRyaWFuZ2xlU3RyaXAoZ2VvbWV0cnkpIHsKICAgIGNvbnN0IG51bWJlck9mVmVydGljZXMgPSBHZW9tZXRyeV9kZWZhdWx0LmNvbXB1dGVOdW1iZXJPZlZlcnRpY2VzKGdlb21ldHJ5KTsKICAgIGlmIChudW1iZXJPZlZlcnRpY2VzIDwgMykgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiVGhlIG51bWJlciBvZiB2ZXJ0aWNlcyBtdXN0IGJlIGF0IGxlYXN0IDMuIik7CiAgICB9CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIG51bWJlck9mVmVydGljZXMsCiAgICAgIChudW1iZXJPZlZlcnRpY2VzIC0gMikgKiAzCiAgICApOwogICAgaW5kaWNlc1swXSA9IDA7CiAgICBpbmRpY2VzWzFdID0gMTsKICAgIGluZGljZXNbMl0gPSAyOwogICAgaWYgKG51bWJlck9mVmVydGljZXMgPiAzKSB7CiAgICAgIGluZGljZXNbM10gPSAwOwogICAgICBpbmRpY2VzWzRdID0gMjsKICAgICAgaW5kaWNlc1s1XSA9IDM7CiAgICB9CiAgICBsZXQgaW5kaWNlc0luZGV4ID0gNjsKICAgIGZvciAobGV0IGkgPSAzOyBpIDwgbnVtYmVyT2ZWZXJ0aWNlcyAtIDE7IGkgKz0gMikgewogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGk7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaSAtIDE7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaSArIDE7CiAgICAgIGlmIChpICsgMiA8IG51bWJlck9mVmVydGljZXMpIHsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGk7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpICsgMTsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGkgKyAyOwogICAgICB9CiAgICB9CiAgICBnZW9tZXRyeS5pbmRpY2VzID0gaW5kaWNlczsKICAgIGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUgPSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTOwogICAgcmV0dXJuIGdlb21ldHJ5OwogIH0KICBmdW5jdGlvbiBpbmRleExpbmVzKGdlb21ldHJ5KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmluZGljZXMpKSB7CiAgICAgIHJldHVybiBnZW9tZXRyeTsKICAgIH0KICAgIGNvbnN0IG51bWJlck9mVmVydGljZXMgPSBHZW9tZXRyeV9kZWZhdWx0LmNvbXB1dGVOdW1iZXJPZlZlcnRpY2VzKGdlb21ldHJ5KTsKICAgIGlmIChudW1iZXJPZlZlcnRpY2VzIDwgMikgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiVGhlIG51bWJlciBvZiB2ZXJ0aWNlcyBtdXN0IGJlIGF0IGxlYXN0IHR3by4iKTsKICAgIH0KICAgIGlmIChudW1iZXJPZlZlcnRpY2VzICUgMiAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiVGhlIG51bWJlciBvZiB2ZXJ0aWNlcyBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMi4iKTsKICAgIH0KICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgbnVtYmVyT2ZWZXJ0aWNlcywKICAgICAgbnVtYmVyT2ZWZXJ0aWNlcwogICAgKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtYmVyT2ZWZXJ0aWNlczsgKytpKSB7CiAgICAgIGluZGljZXNbaV0gPSBpOwogICAgfQogICAgZ2VvbWV0cnkuaW5kaWNlcyA9IGluZGljZXM7CiAgICByZXR1cm4gZ2VvbWV0cnk7CiAgfQogIGZ1bmN0aW9uIGluZGV4TGluZVN0cmlwKGdlb21ldHJ5KSB7CiAgICBjb25zdCBudW1iZXJPZlZlcnRpY2VzID0gR2VvbWV0cnlfZGVmYXVsdC5jb21wdXRlTnVtYmVyT2ZWZXJ0aWNlcyhnZW9tZXRyeSk7CiAgICBpZiAobnVtYmVyT2ZWZXJ0aWNlcyA8IDIpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIlRoZSBudW1iZXIgb2YgdmVydGljZXMgbXVzdCBiZSBhdCBsZWFzdCB0d28uIik7CiAgICB9CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIG51bWJlck9mVmVydGljZXMsCiAgICAgIChudW1iZXJPZlZlcnRpY2VzIC0gMSkgKiAyCiAgICApOwogICAgaW5kaWNlc1swXSA9IDA7CiAgICBpbmRpY2VzWzFdID0gMTsKICAgIGxldCBpbmRpY2VzSW5kZXggPSAyOwogICAgZm9yIChsZXQgaSA9IDI7IGkgPCBudW1iZXJPZlZlcnRpY2VzOyArK2kpIHsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpIC0gMTsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpOwogICAgfQogICAgZ2VvbWV0cnkuaW5kaWNlcyA9IGluZGljZXM7CiAgICBnZW9tZXRyeS5wcmltaXRpdmVUeXBlID0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTOwogICAgcmV0dXJuIGdlb21ldHJ5OwogIH0KICBmdW5jdGlvbiBpbmRleExpbmVMb29wKGdlb21ldHJ5KSB7CiAgICBjb25zdCBudW1iZXJPZlZlcnRpY2VzID0gR2VvbWV0cnlfZGVmYXVsdC5jb21wdXRlTnVtYmVyT2ZWZXJ0aWNlcyhnZW9tZXRyeSk7CiAgICBpZiAobnVtYmVyT2ZWZXJ0aWNlcyA8IDIpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIlRoZSBudW1iZXIgb2YgdmVydGljZXMgbXVzdCBiZSBhdCBsZWFzdCB0d28uIik7CiAgICB9CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIG51bWJlck9mVmVydGljZXMsCiAgICAgIG51bWJlck9mVmVydGljZXMgKiAyCiAgICApOwogICAgaW5kaWNlc1swXSA9IDA7CiAgICBpbmRpY2VzWzFdID0gMTsKICAgIGxldCBpbmRpY2VzSW5kZXggPSAyOwogICAgZm9yIChsZXQgaSA9IDI7IGkgPCBudW1iZXJPZlZlcnRpY2VzOyArK2kpIHsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpIC0gMTsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpOwogICAgfQogICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBudW1iZXJPZlZlcnRpY2VzIC0gMTsKICAgIGluZGljZXNbaW5kaWNlc0luZGV4XSA9IDA7CiAgICBnZW9tZXRyeS5pbmRpY2VzID0gaW5kaWNlczsKICAgIGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUgPSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVM7CiAgICByZXR1cm4gZ2VvbWV0cnk7CiAgfQogIGZ1bmN0aW9uIGluZGV4UHJpbWl0aXZlKGdlb21ldHJ5KSB7CiAgICBzd2l0Y2ggKGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUpIHsKICAgICAgY2FzZSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVfRkFOOgogICAgICAgIHJldHVybiBpbmRleFRyaWFuZ2xlRmFuKGdlb21ldHJ5KTsKICAgICAgY2FzZSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVfU1RSSVA6CiAgICAgICAgcmV0dXJuIGluZGV4VHJpYW5nbGVTdHJpcChnZW9tZXRyeSk7CiAgICAgIGNhc2UgUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUzoKICAgICAgICByZXR1cm4gaW5kZXhUcmlhbmdsZXMoZ2VvbWV0cnkpOwogICAgICBjYXNlIFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FX1NUUklQOgogICAgICAgIHJldHVybiBpbmRleExpbmVTdHJpcChnZW9tZXRyeSk7CiAgICAgIGNhc2UgUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVfTE9PUDoKICAgICAgICByZXR1cm4gaW5kZXhMaW5lTG9vcChnZW9tZXRyeSk7CiAgICAgIGNhc2UgUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTOgogICAgICAgIHJldHVybiBpbmRleExpbmVzKGdlb21ldHJ5KTsKICAgIH0KICAgIHJldHVybiBnZW9tZXRyeTsKICB9CiAgZnVuY3Rpb24gb2Zmc2V0UG9pbnRGcm9tWFpQbGFuZShwLCBpc0JlaGluZCkgewogICAgaWYgKE1hdGguYWJzKHAueSkgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjYpIHsKICAgICAgaWYgKGlzQmVoaW5kKSB7CiAgICAgICAgcC55ID0gLU1hdGhfZGVmYXVsdC5FUFNJTE9ONjsKICAgICAgfSBlbHNlIHsKICAgICAgICBwLnkgPSBNYXRoX2RlZmF1bHQuRVBTSUxPTjY7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gb2Zmc2V0VHJpYW5nbGVGcm9tWFpQbGFuZShwMCwgcDEsIHAyKSB7CiAgICBpZiAocDAueSAhPT0gMCAmJiBwMS55ICE9PSAwICYmIHAyLnkgIT09IDApIHsKICAgICAgb2Zmc2V0UG9pbnRGcm9tWFpQbGFuZShwMCwgcDAueSA8IDApOwogICAgICBvZmZzZXRQb2ludEZyb21YWlBsYW5lKHAxLCBwMS55IDwgMCk7CiAgICAgIG9mZnNldFBvaW50RnJvbVhaUGxhbmUocDIsIHAyLnkgPCAwKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgcDB5ID0gTWF0aC5hYnMocDAueSk7CiAgICBjb25zdCBwMXkgPSBNYXRoLmFicyhwMS55KTsKICAgIGNvbnN0IHAyeSA9IE1hdGguYWJzKHAyLnkpOwogICAgbGV0IHNpZ24yOwogICAgaWYgKHAweSA+IHAxeSkgewogICAgICBpZiAocDB5ID4gcDJ5KSB7CiAgICAgICAgc2lnbjIgPSBNYXRoX2RlZmF1bHQuc2lnbihwMC55KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzaWduMiA9IE1hdGhfZGVmYXVsdC5zaWduKHAyLnkpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKHAxeSA+IHAyeSkgewogICAgICBzaWduMiA9IE1hdGhfZGVmYXVsdC5zaWduKHAxLnkpOwogICAgfSBlbHNlIHsKICAgICAgc2lnbjIgPSBNYXRoX2RlZmF1bHQuc2lnbihwMi55KTsKICAgIH0KICAgIGNvbnN0IGlzQmVoaW5kID0gc2lnbjIgPCAwOwogICAgb2Zmc2V0UG9pbnRGcm9tWFpQbGFuZShwMCwgaXNCZWhpbmQpOwogICAgb2Zmc2V0UG9pbnRGcm9tWFpQbGFuZShwMSwgaXNCZWhpbmQpOwogICAgb2Zmc2V0UG9pbnRGcm9tWFpQbGFuZShwMiwgaXNCZWhpbmQpOwogIH0KICBmdW5jdGlvbiBnZXRYWkludGVyc2VjdGlvbk9mZnNldFBvaW50cyhwLCBwMSwgdTEyLCB2MTIpIHsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgIHAsCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwMSwgcCwgYzMpLAogICAgICAgIHAueSAvIChwLnkgLSBwMS55KSwKICAgICAgICBjMwogICAgICApLAogICAgICB1MTIKICAgICk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUodTEyLCB2MTIpOwogICAgb2Zmc2V0UG9pbnRGcm9tWFpQbGFuZSh1MTIsIHRydWUpOwogICAgb2Zmc2V0UG9pbnRGcm9tWFpQbGFuZSh2MTIsIGZhbHNlKTsKICB9CiAgZnVuY3Rpb24gc3BsaXRUcmlhbmdsZShwMCwgcDEsIHAyKSB7CiAgICBpZiAocDAueCA+PSAwIHx8IHAxLnggPj0gMCB8fCBwMi54ID49IDApIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIG9mZnNldFRyaWFuZ2xlRnJvbVhaUGxhbmUocDAsIHAxLCBwMik7CiAgICBjb25zdCBwMEJlaGluZCA9IHAwLnkgPCAwOwogICAgY29uc3QgcDFCZWhpbmQgPSBwMS55IDwgMDsKICAgIGNvbnN0IHAyQmVoaW5kID0gcDIueSA8IDA7CiAgICBsZXQgbnVtQmVoaW5kID0gMDsKICAgIG51bUJlaGluZCArPSBwMEJlaGluZCA/IDEgOiAwOwogICAgbnVtQmVoaW5kICs9IHAxQmVoaW5kID8gMSA6IDA7CiAgICBudW1CZWhpbmQgKz0gcDJCZWhpbmQgPyAxIDogMDsKICAgIGNvbnN0IGluZGljZXMgPSBzcGxpdFRyaWFuZ2xlUmVzdWx0LmluZGljZXM7CiAgICBpZiAobnVtQmVoaW5kID09PSAxKSB7CiAgICAgIGluZGljZXNbMV0gPSAzOwogICAgICBpbmRpY2VzWzJdID0gNDsKICAgICAgaW5kaWNlc1s1XSA9IDY7CiAgICAgIGluZGljZXNbN10gPSA2OwogICAgICBpbmRpY2VzWzhdID0gNTsKICAgICAgaWYgKHAwQmVoaW5kKSB7CiAgICAgICAgZ2V0WFpJbnRlcnNlY3Rpb25PZmZzZXRQb2ludHMocDAsIHAxLCB1MSwgcTEpOwogICAgICAgIGdldFhaSW50ZXJzZWN0aW9uT2Zmc2V0UG9pbnRzKHAwLCBwMiwgdTIsIHEyKTsKICAgICAgICBpbmRpY2VzWzBdID0gMDsKICAgICAgICBpbmRpY2VzWzNdID0gMTsKICAgICAgICBpbmRpY2VzWzRdID0gMjsKICAgICAgICBpbmRpY2VzWzZdID0gMTsKICAgICAgfSBlbHNlIGlmIChwMUJlaGluZCkgewogICAgICAgIGdldFhaSW50ZXJzZWN0aW9uT2Zmc2V0UG9pbnRzKHAxLCBwMiwgdTEsIHExKTsKICAgICAgICBnZXRYWkludGVyc2VjdGlvbk9mZnNldFBvaW50cyhwMSwgcDAsIHUyLCBxMik7CiAgICAgICAgaW5kaWNlc1swXSA9IDE7CiAgICAgICAgaW5kaWNlc1szXSA9IDI7CiAgICAgICAgaW5kaWNlc1s0XSA9IDA7CiAgICAgICAgaW5kaWNlc1s2XSA9IDI7CiAgICAgIH0gZWxzZSBpZiAocDJCZWhpbmQpIHsKICAgICAgICBnZXRYWkludGVyc2VjdGlvbk9mZnNldFBvaW50cyhwMiwgcDAsIHUxLCBxMSk7CiAgICAgICAgZ2V0WFpJbnRlcnNlY3Rpb25PZmZzZXRQb2ludHMocDIsIHAxLCB1MiwgcTIpOwogICAgICAgIGluZGljZXNbMF0gPSAyOwogICAgICAgIGluZGljZXNbM10gPSAwOwogICAgICAgIGluZGljZXNbNF0gPSAxOwogICAgICAgIGluZGljZXNbNl0gPSAwOwogICAgICB9CiAgICB9IGVsc2UgaWYgKG51bUJlaGluZCA9PT0gMikgewogICAgICBpbmRpY2VzWzJdID0gNDsKICAgICAgaW5kaWNlc1s0XSA9IDQ7CiAgICAgIGluZGljZXNbNV0gPSAzOwogICAgICBpbmRpY2VzWzddID0gNTsKICAgICAgaW5kaWNlc1s4XSA9IDY7CiAgICAgIGlmICghcDBCZWhpbmQpIHsKICAgICAgICBnZXRYWkludGVyc2VjdGlvbk9mZnNldFBvaW50cyhwMCwgcDEsIHUxLCBxMSk7CiAgICAgICAgZ2V0WFpJbnRlcnNlY3Rpb25PZmZzZXRQb2ludHMocDAsIHAyLCB1MiwgcTIpOwogICAgICAgIGluZGljZXNbMF0gPSAxOwogICAgICAgIGluZGljZXNbMV0gPSAyOwogICAgICAgIGluZGljZXNbM10gPSAxOwogICAgICAgIGluZGljZXNbNl0gPSAwOwogICAgICB9IGVsc2UgaWYgKCFwMUJlaGluZCkgewogICAgICAgIGdldFhaSW50ZXJzZWN0aW9uT2Zmc2V0UG9pbnRzKHAxLCBwMiwgdTEsIHExKTsKICAgICAgICBnZXRYWkludGVyc2VjdGlvbk9mZnNldFBvaW50cyhwMSwgcDAsIHUyLCBxMik7CiAgICAgICAgaW5kaWNlc1swXSA9IDI7CiAgICAgICAgaW5kaWNlc1sxXSA9IDA7CiAgICAgICAgaW5kaWNlc1szXSA9IDI7CiAgICAgICAgaW5kaWNlc1s2XSA9IDE7CiAgICAgIH0gZWxzZSBpZiAoIXAyQmVoaW5kKSB7CiAgICAgICAgZ2V0WFpJbnRlcnNlY3Rpb25PZmZzZXRQb2ludHMocDIsIHAwLCB1MSwgcTEpOwogICAgICAgIGdldFhaSW50ZXJzZWN0aW9uT2Zmc2V0UG9pbnRzKHAyLCBwMSwgdTIsIHEyKTsKICAgICAgICBpbmRpY2VzWzBdID0gMDsKICAgICAgICBpbmRpY2VzWzFdID0gMTsKICAgICAgICBpbmRpY2VzWzNdID0gMDsKICAgICAgICBpbmRpY2VzWzZdID0gMjsKICAgICAgfQogICAgfQogICAgY29uc3QgcG9zaXRpb25zID0gc3BsaXRUcmlhbmdsZVJlc3VsdC5wb3NpdGlvbnM7CiAgICBwb3NpdGlvbnNbMF0gPSBwMDsKICAgIHBvc2l0aW9uc1sxXSA9IHAxOwogICAgcG9zaXRpb25zWzJdID0gcDI7CiAgICBwb3NpdGlvbnMubGVuZ3RoID0gMzsKICAgIGlmIChudW1CZWhpbmQgPT09IDEgfHwgbnVtQmVoaW5kID09PSAyKSB7CiAgICAgIHBvc2l0aW9uc1szXSA9IHUxOwogICAgICBwb3NpdGlvbnNbNF0gPSB1MjsKICAgICAgcG9zaXRpb25zWzVdID0gcTE7CiAgICAgIHBvc2l0aW9uc1s2XSA9IHEyOwogICAgICBwb3NpdGlvbnMubGVuZ3RoID0gNzsKICAgIH0KICAgIHJldHVybiBzcGxpdFRyaWFuZ2xlUmVzdWx0OwogIH0KICBmdW5jdGlvbiB1cGRhdGVHZW9tZXRyeUFmdGVyU3BsaXQoZ2VvbWV0cnksIGNvbXB1dGVCb3VuZGluZ1NwaGVyZSkgewogICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICBpZiAoYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICBmb3IgKGNvbnN0IHByb3BlcnR5IGluIGF0dHJpYnV0ZXMpIHsKICAgICAgaWYgKGF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkocHJvcGVydHkpICYmIGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzW3Byb3BlcnR5XSkgJiYgZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXNbcHJvcGVydHldLnZhbHVlcykpIHsKICAgICAgICBjb25zdCBhdHRyaWJ1dGUgPSBhdHRyaWJ1dGVzW3Byb3BlcnR5XTsKICAgICAgICBhdHRyaWJ1dGUudmFsdWVzID0gQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICAgICAgYXR0cmlidXRlLmNvbXBvbmVudERhdGF0eXBlLAogICAgICAgICAgYXR0cmlidXRlLnZhbHVlcwogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IG51bWJlck9mVmVydGljZXMgPSBHZW9tZXRyeV9kZWZhdWx0LmNvbXB1dGVOdW1iZXJPZlZlcnRpY2VzKGdlb21ldHJ5KTsKICAgIGdlb21ldHJ5LmluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgbnVtYmVyT2ZWZXJ0aWNlcywKICAgICAgZ2VvbWV0cnkuaW5kaWNlcwogICAgKTsKICAgIGlmIChjb21wdXRlQm91bmRpbmdTcGhlcmUpIHsKICAgICAgZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmUgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21WZXJ0aWNlcygKICAgICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcwogICAgICApOwogICAgfQogICAgcmV0dXJuIGdlb21ldHJ5OwogIH0KICBmdW5jdGlvbiBjb3B5R2VvbWV0cnlGb3JTcGxpdChnZW9tZXRyeSkgewogICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICBjb25zdCBjb3BpZWRBdHRyaWJ1dGVzID0ge307CiAgICBmb3IgKGNvbnN0IHByb3BlcnR5IGluIGF0dHJpYnV0ZXMpIHsKICAgICAgaWYgKGF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkocHJvcGVydHkpICYmIGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzW3Byb3BlcnR5XSkgJiYgZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXNbcHJvcGVydHldLnZhbHVlcykpIHsKICAgICAgICBjb25zdCBhdHRyaWJ1dGUgPSBhdHRyaWJ1dGVzW3Byb3BlcnR5XTsKICAgICAgICBjb3BpZWRBdHRyaWJ1dGVzW3Byb3BlcnR5XSA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBhdHRyaWJ1dGUuY29tcG9uZW50RGF0YXR5cGUsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiBhdHRyaWJ1dGUuY29tcG9uZW50c1BlckF0dHJpYnV0ZSwKICAgICAgICAgIG5vcm1hbGl6ZTogYXR0cmlidXRlLm5vcm1hbGl6ZSwKICAgICAgICAgIHZhbHVlczogW10KICAgICAgICB9KTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgYXR0cmlidXRlczogY29waWVkQXR0cmlidXRlcywKICAgICAgaW5kaWNlczogW10sCiAgICAgIHByaW1pdGl2ZVR5cGU6IGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUKICAgIH0pOwogIH0KICBmdW5jdGlvbiB1cGRhdGVJbnN0YW5jZUFmdGVyU3BsaXQoaW5zdGFuY2UsIHdlc3RHZW9tZXRyeSwgZWFzdEdlb21ldHJ5KSB7CiAgICBjb25zdCBjb21wdXRlQm91bmRpbmdTcGhlcmUgPSBkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2UuZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmUpOwogICAgd2VzdEdlb21ldHJ5ID0gdXBkYXRlR2VvbWV0cnlBZnRlclNwbGl0KHdlc3RHZW9tZXRyeSwgY29tcHV0ZUJvdW5kaW5nU3BoZXJlKTsKICAgIGVhc3RHZW9tZXRyeSA9IHVwZGF0ZUdlb21ldHJ5QWZ0ZXJTcGxpdChlYXN0R2VvbWV0cnksIGNvbXB1dGVCb3VuZGluZ1NwaGVyZSk7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGVhc3RHZW9tZXRyeSkgJiYgIWRlZmluZWRfZGVmYXVsdCh3ZXN0R2VvbWV0cnkpKSB7CiAgICAgIGluc3RhbmNlLmdlb21ldHJ5ID0gZWFzdEdlb21ldHJ5OwogICAgfSBlbHNlIGlmICghZGVmaW5lZF9kZWZhdWx0KGVhc3RHZW9tZXRyeSkgJiYgZGVmaW5lZF9kZWZhdWx0KHdlc3RHZW9tZXRyeSkpIHsKICAgICAgaW5zdGFuY2UuZ2VvbWV0cnkgPSB3ZXN0R2VvbWV0cnk7CiAgICB9IGVsc2UgewogICAgICBpbnN0YW5jZS53ZXN0SGVtaXNwaGVyZUdlb21ldHJ5ID0gd2VzdEdlb21ldHJ5OwogICAgICBpbnN0YW5jZS5lYXN0SGVtaXNwaGVyZUdlb21ldHJ5ID0gZWFzdEdlb21ldHJ5OwogICAgICBpbnN0YW5jZS5nZW9tZXRyeSA9IHZvaWQgMDsKICAgIH0KICB9CiAgZnVuY3Rpb24gZ2VuZXJhdGVCYXJ5Y2VudHJpY0ludGVycG9sYXRlRnVuY3Rpb24oQ2FydGVzaWFuVHlwZSwgbnVtYmVyT2ZDb21wb25lbnRzKSB7CiAgICBjb25zdCB2MFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuVHlwZSgpOwogICAgY29uc3QgdjFTY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW5UeXBlKCk7CiAgICBjb25zdCB2MlNjcmF0Y2gyID0gbmV3IENhcnRlc2lhblR5cGUoKTsKICAgIHJldHVybiBmdW5jdGlvbihpMCwgaTEsIGkyLCBjb29yZHMsIHNvdXJjZVZhbHVlcywgY3VycmVudFZhbHVlcywgaW5zZXJ0ZWRJbmRleCwgbm9ybWFsaXplKSB7CiAgICAgIGNvbnN0IHYwMiA9IENhcnRlc2lhblR5cGUuZnJvbUFycmF5KAogICAgICAgIHNvdXJjZVZhbHVlcywKICAgICAgICBpMCAqIG51bWJlck9mQ29tcG9uZW50cywKICAgICAgICB2MFNjcmF0Y2gKICAgICAgKTsKICAgICAgY29uc3QgdjEyID0gQ2FydGVzaWFuVHlwZS5mcm9tQXJyYXkoCiAgICAgICAgc291cmNlVmFsdWVzLAogICAgICAgIGkxICogbnVtYmVyT2ZDb21wb25lbnRzLAogICAgICAgIHYxU2NyYXRjaDIKICAgICAgKTsKICAgICAgY29uc3QgdjIyID0gQ2FydGVzaWFuVHlwZS5mcm9tQXJyYXkoCiAgICAgICAgc291cmNlVmFsdWVzLAogICAgICAgIGkyICogbnVtYmVyT2ZDb21wb25lbnRzLAogICAgICAgIHYyU2NyYXRjaDIKICAgICAgKTsKICAgICAgQ2FydGVzaWFuVHlwZS5tdWx0aXBseUJ5U2NhbGFyKHYwMiwgY29vcmRzLngsIHYwMik7CiAgICAgIENhcnRlc2lhblR5cGUubXVsdGlwbHlCeVNjYWxhcih2MTIsIGNvb3Jkcy55LCB2MTIpOwogICAgICBDYXJ0ZXNpYW5UeXBlLm11bHRpcGx5QnlTY2FsYXIodjIyLCBjb29yZHMueiwgdjIyKTsKICAgICAgY29uc3QgdmFsdWUgPSBDYXJ0ZXNpYW5UeXBlLmFkZCh2MDIsIHYxMiwgdjAyKTsKICAgICAgQ2FydGVzaWFuVHlwZS5hZGQodmFsdWUsIHYyMiwgdmFsdWUpOwogICAgICBpZiAobm9ybWFsaXplKSB7CiAgICAgICAgQ2FydGVzaWFuVHlwZS5ub3JtYWxpemUodmFsdWUsIHZhbHVlKTsKICAgICAgfQogICAgICBDYXJ0ZXNpYW5UeXBlLnBhY2soCiAgICAgICAgdmFsdWUsCiAgICAgICAgY3VycmVudFZhbHVlcywKICAgICAgICBpbnNlcnRlZEluZGV4ICogbnVtYmVyT2ZDb21wb25lbnRzCiAgICAgICk7CiAgICB9OwogIH0KICBmdW5jdGlvbiBjb21wdXRlVHJpYW5nbGVBdHRyaWJ1dGVzKGkwLCBpMSwgaTIsIHBvaW50LCBwb3NpdGlvbnMsIG5vcm1hbHMsIHRhbmdlbnRzLCBiaXRhbmdlbnRzLCB0ZXhDb29yZHMsIGV4dHJ1ZGVEaXJlY3Rpb25zLCBhcHBseU9mZnNldCwgY3VycmVudEF0dHJpYnV0ZXMsIGN1c3RvbUF0dHJpYnV0ZU5hbWVzLCBjdXN0b21BdHRyaWJ1dGVzTGVuZ3RoLCBhbGxBdHRyaWJ1dGVzLCBpbnNlcnRlZEluZGV4KSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChub3JtYWxzKSAmJiAhZGVmaW5lZF9kZWZhdWx0KHRhbmdlbnRzKSAmJiAhZGVmaW5lZF9kZWZhdWx0KGJpdGFuZ2VudHMpICYmICFkZWZpbmVkX2RlZmF1bHQodGV4Q29vcmRzKSAmJiAhZGVmaW5lZF9kZWZhdWx0KGV4dHJ1ZGVEaXJlY3Rpb25zKSAmJiBjdXN0b21BdHRyaWJ1dGVzTGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHAwID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGkwICogMywgcDBTY3JhdGNoKTsKICAgIGNvbnN0IHAxID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGkxICogMywgcDFTY3JhdGNoKTsKICAgIGNvbnN0IHAyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGkyICogMywgcDJTY3JhdGNoKTsKICAgIGNvbnN0IGNvb3JkcyA9IGJhcnljZW50cmljQ29vcmRpbmF0ZXNfZGVmYXVsdChwb2ludCwgcDAsIHAxLCBwMiwgYmFyeWNlbnRyaWNTY3JhdGNoKTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNvb3JkcykpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChub3JtYWxzKSkgewogICAgICBpbnRlcnBvbGF0ZUFuZFBhY2tDYXJ0ZXNpYW4zKAogICAgICAgIGkwLAogICAgICAgIGkxLAogICAgICAgIGkyLAogICAgICAgIGNvb3JkcywKICAgICAgICBub3JtYWxzLAogICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLm5vcm1hbC52YWx1ZXMsCiAgICAgICAgaW5zZXJ0ZWRJbmRleCwKICAgICAgICB0cnVlCiAgICAgICk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGV4dHJ1ZGVEaXJlY3Rpb25zKSkgewogICAgICBjb25zdCBkMCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoZXh0cnVkZURpcmVjdGlvbnMsIGkwICogMywgcDBTY3JhdGNoKTsKICAgICAgY29uc3QgZDEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGV4dHJ1ZGVEaXJlY3Rpb25zLCBpMSAqIDMsIHAxU2NyYXRjaCk7CiAgICAgIGNvbnN0IGQyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShleHRydWRlRGlyZWN0aW9ucywgaTIgKiAzLCBwMlNjcmF0Y2gpOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihkMCwgY29vcmRzLngsIGQwKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoZDEsIGNvb3Jkcy55LCBkMSk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGQyLCBjb29yZHMueiwgZDIpOwogICAgICBsZXQgZGlyZWN0aW9uMjsKICAgICAgaWYgKCFDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKGQwLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTykgfHwgIUNhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMoZDEsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSB8fCAhQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhkMiwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pKSB7CiAgICAgICAgZGlyZWN0aW9uMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoZDAsIGQxLCBkMCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChkaXJlY3Rpb24yLCBkMiwgZGlyZWN0aW9uMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShkaXJlY3Rpb24yLCBkaXJlY3Rpb24yKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkaXJlY3Rpb24yID0gcDBTY3JhdGNoOwogICAgICAgIGRpcmVjdGlvbjIueCA9IDA7CiAgICAgICAgZGlyZWN0aW9uMi55ID0gMDsKICAgICAgICBkaXJlY3Rpb24yLnogPSAwOwogICAgICB9CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKAogICAgICAgIGRpcmVjdGlvbjIsCiAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMuZXh0cnVkZURpcmVjdGlvbi52YWx1ZXMsCiAgICAgICAgaW5zZXJ0ZWRJbmRleCAqIDMKICAgICAgKTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYXBwbHlPZmZzZXQpKSB7CiAgICAgIGludGVycG9sYXRlQW5kUGFja0Jvb2xlYW4oCiAgICAgICAgaTAsCiAgICAgICAgaTEsCiAgICAgICAgaTIsCiAgICAgICAgY29vcmRzLAogICAgICAgIGFwcGx5T2Zmc2V0LAogICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0LnZhbHVlcywKICAgICAgICBpbnNlcnRlZEluZGV4CiAgICAgICk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHRhbmdlbnRzKSkgewogICAgICBpbnRlcnBvbGF0ZUFuZFBhY2tDYXJ0ZXNpYW4zKAogICAgICAgIGkwLAogICAgICAgIGkxLAogICAgICAgIGkyLAogICAgICAgIGNvb3JkcywKICAgICAgICB0YW5nZW50cywKICAgICAgICBjdXJyZW50QXR0cmlidXRlcy50YW5nZW50LnZhbHVlcywKICAgICAgICBpbnNlcnRlZEluZGV4LAogICAgICAgIHRydWUKICAgICAgKTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYml0YW5nZW50cykpIHsKICAgICAgaW50ZXJwb2xhdGVBbmRQYWNrQ2FydGVzaWFuMygKICAgICAgICBpMCwKICAgICAgICBpMSwKICAgICAgICBpMiwKICAgICAgICBjb29yZHMsCiAgICAgICAgYml0YW5nZW50cywKICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5iaXRhbmdlbnQudmFsdWVzLAogICAgICAgIGluc2VydGVkSW5kZXgsCiAgICAgICAgdHJ1ZQogICAgICApOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0ZXhDb29yZHMpKSB7CiAgICAgIGludGVycG9sYXRlQW5kUGFja0NhcnRlc2lhbjIoCiAgICAgICAgaTAsCiAgICAgICAgaTEsCiAgICAgICAgaTIsCiAgICAgICAgY29vcmRzLAogICAgICAgIHRleENvb3JkcywKICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5zdC52YWx1ZXMsCiAgICAgICAgaW5zZXJ0ZWRJbmRleAogICAgICApOwogICAgfQogICAgaWYgKGN1c3RvbUF0dHJpYnV0ZXNMZW5ndGggPiAwKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY3VzdG9tQXR0cmlidXRlc0xlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgYXR0cmlidXRlTmFtZSA9IGN1c3RvbUF0dHJpYnV0ZU5hbWVzW2ldOwogICAgICAgIGdlbmVyaWNJbnRlcnBvbGF0ZSgKICAgICAgICAgIGkwLAogICAgICAgICAgaTEsCiAgICAgICAgICBpMiwKICAgICAgICAgIGNvb3JkcywKICAgICAgICAgIGluc2VydGVkSW5kZXgsCiAgICAgICAgICBhbGxBdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdLAogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV0KICAgICAgICApOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdlbmVyaWNJbnRlcnBvbGF0ZShpMCwgaTEsIGkyLCBjb29yZHMsIGluc2VydGVkSW5kZXgsIHNvdXJjZUF0dHJpYnV0ZSwgY3VycmVudEF0dHJpYnV0ZSkgewogICAgY29uc3QgY29tcG9uZW50c1BlckF0dHJpYnV0ZSA9IHNvdXJjZUF0dHJpYnV0ZS5jb21wb25lbnRzUGVyQXR0cmlidXRlOwogICAgY29uc3Qgc291cmNlVmFsdWVzID0gc291cmNlQXR0cmlidXRlLnZhbHVlczsKICAgIGNvbnN0IGN1cnJlbnRWYWx1ZXMgPSBjdXJyZW50QXR0cmlidXRlLnZhbHVlczsKICAgIHN3aXRjaCAoY29tcG9uZW50c1BlckF0dHJpYnV0ZSkgewogICAgICBjYXNlIDQ6CiAgICAgICAgaW50ZXJwb2xhdGVBbmRQYWNrQ2FydGVzaWFuNCgKICAgICAgICAgIGkwLAogICAgICAgICAgaTEsCiAgICAgICAgICBpMiwKICAgICAgICAgIGNvb3JkcywKICAgICAgICAgIHNvdXJjZVZhbHVlcywKICAgICAgICAgIGN1cnJlbnRWYWx1ZXMsCiAgICAgICAgICBpbnNlcnRlZEluZGV4LAogICAgICAgICAgZmFsc2UKICAgICAgICApOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDM6CiAgICAgICAgaW50ZXJwb2xhdGVBbmRQYWNrQ2FydGVzaWFuMygKICAgICAgICAgIGkwLAogICAgICAgICAgaTEsCiAgICAgICAgICBpMiwKICAgICAgICAgIGNvb3JkcywKICAgICAgICAgIHNvdXJjZVZhbHVlcywKICAgICAgICAgIGN1cnJlbnRWYWx1ZXMsCiAgICAgICAgICBpbnNlcnRlZEluZGV4LAogICAgICAgICAgZmFsc2UKICAgICAgICApOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDI6CiAgICAgICAgaW50ZXJwb2xhdGVBbmRQYWNrQ2FydGVzaWFuMigKICAgICAgICAgIGkwLAogICAgICAgICAgaTEsCiAgICAgICAgICBpMiwKICAgICAgICAgIGNvb3JkcywKICAgICAgICAgIHNvdXJjZVZhbHVlcywKICAgICAgICAgIGN1cnJlbnRWYWx1ZXMsCiAgICAgICAgICBpbnNlcnRlZEluZGV4LAogICAgICAgICAgZmFsc2UKICAgICAgICApOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIGN1cnJlbnRWYWx1ZXNbaW5zZXJ0ZWRJbmRleF0gPSBzb3VyY2VWYWx1ZXNbaTBdICogY29vcmRzLnggKyBzb3VyY2VWYWx1ZXNbaTFdICogY29vcmRzLnkgKyBzb3VyY2VWYWx1ZXNbaTJdICogY29vcmRzLno7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGluc2VydFNwbGl0UG9pbnQoY3VycmVudEF0dHJpYnV0ZXMsIGN1cnJlbnRJbmRpY2VzLCBjdXJyZW50SW5kZXhNYXAsIGluZGljZXMsIGN1cnJlbnRJbmRleCwgcG9pbnQpIHsKICAgIGNvbnN0IGluc2VydEluZGV4ID0gY3VycmVudEF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aCAvIDM7CiAgICBpZiAoY3VycmVudEluZGV4ICE9PSAtMSkgewogICAgICBjb25zdCBwcmV2SW5kZXggPSBpbmRpY2VzW2N1cnJlbnRJbmRleF07CiAgICAgIGNvbnN0IG5ld0luZGV4ID0gY3VycmVudEluZGV4TWFwW3ByZXZJbmRleF07CiAgICAgIGlmIChuZXdJbmRleCA9PT0gLTEpIHsKICAgICAgICBjdXJyZW50SW5kZXhNYXBbcHJldkluZGV4XSA9IGluc2VydEluZGV4OwogICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5wdXNoKHBvaW50LngsIHBvaW50LnksIHBvaW50LnopOwogICAgICAgIGN1cnJlbnRJbmRpY2VzLnB1c2goaW5zZXJ0SW5kZXgpOwogICAgICAgIHJldHVybiBpbnNlcnRJbmRleDsKICAgICAgfQogICAgICBjdXJyZW50SW5kaWNlcy5wdXNoKG5ld0luZGV4KTsKICAgICAgcmV0dXJuIG5ld0luZGV4OwogICAgfQogICAgY3VycmVudEF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLnB1c2gocG9pbnQueCwgcG9pbnQueSwgcG9pbnQueik7CiAgICBjdXJyZW50SW5kaWNlcy5wdXNoKGluc2VydEluZGV4KTsKICAgIHJldHVybiBpbnNlcnRJbmRleDsKICB9CiAgZnVuY3Rpb24gc3BsaXRMb25naXR1ZGVUcmlhbmdsZXMoaW5zdGFuY2UpIHsKICAgIGNvbnN0IGdlb21ldHJ5ID0gaW5zdGFuY2UuZ2VvbWV0cnk7CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gZ2VvbWV0cnkuYXR0cmlidXRlczsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgY29uc3Qgbm9ybWFscyA9IGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLm5vcm1hbCkgPyBhdHRyaWJ1dGVzLm5vcm1hbC52YWx1ZXMgOiB2b2lkIDA7CiAgICBjb25zdCBiaXRhbmdlbnRzID0gZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXMuYml0YW5nZW50KSA/IGF0dHJpYnV0ZXMuYml0YW5nZW50LnZhbHVlcyA6IHZvaWQgMDsKICAgIGNvbnN0IHRhbmdlbnRzID0gZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXMudGFuZ2VudCkgPyBhdHRyaWJ1dGVzLnRhbmdlbnQudmFsdWVzIDogdm9pZCAwOwogICAgY29uc3QgdGV4Q29vcmRzID0gZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXMuc3QpID8gYXR0cmlidXRlcy5zdC52YWx1ZXMgOiB2b2lkIDA7CiAgICBjb25zdCBleHRydWRlRGlyZWN0aW9ucyA9IGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLmV4dHJ1ZGVEaXJlY3Rpb24pID8gYXR0cmlidXRlcy5leHRydWRlRGlyZWN0aW9uLnZhbHVlcyA6IHZvaWQgMDsKICAgIGNvbnN0IGFwcGx5T2Zmc2V0ID0gZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQpID8gYXR0cmlidXRlcy5hcHBseU9mZnNldC52YWx1ZXMgOiB2b2lkIDA7CiAgICBjb25zdCBpbmRpY2VzID0gZ2VvbWV0cnkuaW5kaWNlczsKICAgIGNvbnN0IGN1c3RvbUF0dHJpYnV0ZU5hbWVzID0gW107CiAgICBmb3IgKGNvbnN0IGF0dHJpYnV0ZU5hbWUgaW4gYXR0cmlidXRlcykgewogICAgICBpZiAoYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShhdHRyaWJ1dGVOYW1lKSAmJiAhTkFNRURfQVRUUklCVVRFU1thdHRyaWJ1dGVOYW1lXSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlc1thdHRyaWJ1dGVOYW1lXSkpIHsKICAgICAgICBjdXN0b21BdHRyaWJ1dGVOYW1lcy5wdXNoKGF0dHJpYnV0ZU5hbWUpOwogICAgICB9CiAgICB9CiAgICBjb25zdCBjdXN0b21BdHRyaWJ1dGVzTGVuZ3RoID0gY3VzdG9tQXR0cmlidXRlTmFtZXMubGVuZ3RoOwogICAgY29uc3QgZWFzdEdlb21ldHJ5ID0gY29weUdlb21ldHJ5Rm9yU3BsaXQoZ2VvbWV0cnkpOwogICAgY29uc3Qgd2VzdEdlb21ldHJ5ID0gY29weUdlb21ldHJ5Rm9yU3BsaXQoZ2VvbWV0cnkpOwogICAgbGV0IGN1cnJlbnRBdHRyaWJ1dGVzOwogICAgbGV0IGN1cnJlbnRJbmRpY2VzOwogICAgbGV0IGN1cnJlbnRJbmRleE1hcDsKICAgIGxldCBpbnNlcnRlZEluZGV4OwogICAgbGV0IGk7CiAgICBjb25zdCB3ZXN0R2VvbWV0cnlJbmRleE1hcCA9IFtdOwogICAgd2VzdEdlb21ldHJ5SW5kZXhNYXAubGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICBjb25zdCBlYXN0R2VvbWV0cnlJbmRleE1hcCA9IFtdOwogICAgZWFzdEdlb21ldHJ5SW5kZXhNYXAubGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICBmb3IgKGkgPSAwOyBpIDwgd2VzdEdlb21ldHJ5SW5kZXhNYXAubGVuZ3RoOyArK2kpIHsKICAgICAgd2VzdEdlb21ldHJ5SW5kZXhNYXBbaV0gPSAtMTsKICAgICAgZWFzdEdlb21ldHJ5SW5kZXhNYXBbaV0gPSAtMTsKICAgIH0KICAgIGNvbnN0IGxlbiA9IGluZGljZXMubGVuZ3RoOwogICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSArPSAzKSB7CiAgICAgIGNvbnN0IGkwID0gaW5kaWNlc1tpXTsKICAgICAgY29uc3QgaTEgPSBpbmRpY2VzW2kgKyAxXTsKICAgICAgY29uc3QgaTIgPSBpbmRpY2VzW2kgKyAyXTsKICAgICAgbGV0IHAwID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGkwICogMyk7CiAgICAgIGxldCBwMSA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpMSAqIDMpOwogICAgICBsZXQgcDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaTIgKiAzKTsKICAgICAgY29uc3QgcmVzdWx0ID0gc3BsaXRUcmlhbmdsZShwMCwgcDEsIHAyKTsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZXN1bHQpICYmIHJlc3VsdC5wb3NpdGlvbnMubGVuZ3RoID4gMykgewogICAgICAgIGNvbnN0IHJlc3VsdFBvc2l0aW9ucyA9IHJlc3VsdC5wb3NpdGlvbnM7CiAgICAgICAgY29uc3QgcmVzdWx0SW5kaWNlcyA9IHJlc3VsdC5pbmRpY2VzOwogICAgICAgIGNvbnN0IHJlc3VsdExlbmd0aCA9IHJlc3VsdEluZGljZXMubGVuZ3RoOwogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgcmVzdWx0TGVuZ3RoOyArK2opIHsKICAgICAgICAgIGNvbnN0IHJlc3VsdEluZGV4ID0gcmVzdWx0SW5kaWNlc1tqXTsKICAgICAgICAgIGNvbnN0IHBvaW50ID0gcmVzdWx0UG9zaXRpb25zW3Jlc3VsdEluZGV4XTsKICAgICAgICAgIGlmIChwb2ludC55IDwgMCkgewogICAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcyA9IHdlc3RHZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgICAgICAgICBjdXJyZW50SW5kaWNlcyA9IHdlc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgICBjdXJyZW50SW5kZXhNYXAgPSB3ZXN0R2VvbWV0cnlJbmRleE1hcDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzID0gZWFzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICAgIGN1cnJlbnRJbmRpY2VzID0gZWFzdEdlb21ldHJ5LmluZGljZXM7CiAgICAgICAgICAgIGN1cnJlbnRJbmRleE1hcCA9IGVhc3RHZW9tZXRyeUluZGV4TWFwOwogICAgICAgICAgfQogICAgICAgICAgaW5zZXJ0ZWRJbmRleCA9IGluc2VydFNwbGl0UG9pbnQoCiAgICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLAogICAgICAgICAgICBjdXJyZW50SW5kaWNlcywKICAgICAgICAgICAgY3VycmVudEluZGV4TWFwLAogICAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgICByZXN1bHRJbmRleCA8IDMgPyBpICsgcmVzdWx0SW5kZXggOiAtMSwKICAgICAgICAgICAgcG9pbnQKICAgICAgICAgICk7CiAgICAgICAgICBjb21wdXRlVHJpYW5nbGVBdHRyaWJ1dGVzKAogICAgICAgICAgICBpMCwKICAgICAgICAgICAgaTEsCiAgICAgICAgICAgIGkyLAogICAgICAgICAgICBwb2ludCwKICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICBub3JtYWxzLAogICAgICAgICAgICB0YW5nZW50cywKICAgICAgICAgICAgYml0YW5nZW50cywKICAgICAgICAgICAgdGV4Q29vcmRzLAogICAgICAgICAgICBleHRydWRlRGlyZWN0aW9ucywKICAgICAgICAgICAgYXBwbHlPZmZzZXQsCiAgICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLAogICAgICAgICAgICBjdXN0b21BdHRyaWJ1dGVOYW1lcywKICAgICAgICAgICAgY3VzdG9tQXR0cmlidXRlc0xlbmd0aCwKICAgICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgICAgaW5zZXJ0ZWRJbmRleAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBwMCA9IHJlc3VsdC5wb3NpdGlvbnNbMF07CiAgICAgICAgICBwMSA9IHJlc3VsdC5wb3NpdGlvbnNbMV07CiAgICAgICAgICBwMiA9IHJlc3VsdC5wb3NpdGlvbnNbMl07CiAgICAgICAgfQogICAgICAgIGlmIChwMC55IDwgMCkgewogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMgPSB3ZXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICAgIGN1cnJlbnRJbmRpY2VzID0gd2VzdEdlb21ldHJ5LmluZGljZXM7CiAgICAgICAgICBjdXJyZW50SW5kZXhNYXAgPSB3ZXN0R2VvbWV0cnlJbmRleE1hcDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMgPSBlYXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICAgIGN1cnJlbnRJbmRpY2VzID0gZWFzdEdlb21ldHJ5LmluZGljZXM7CiAgICAgICAgICBjdXJyZW50SW5kZXhNYXAgPSBlYXN0R2VvbWV0cnlJbmRleE1hcDsKICAgICAgICB9CiAgICAgICAgaW5zZXJ0ZWRJbmRleCA9IGluc2VydFNwbGl0UG9pbnQoCiAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcywKICAgICAgICAgIGN1cnJlbnRJbmRpY2VzLAogICAgICAgICAgY3VycmVudEluZGV4TWFwLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIGksCiAgICAgICAgICBwMAogICAgICAgICk7CiAgICAgICAgY29tcHV0ZVRyaWFuZ2xlQXR0cmlidXRlcygKICAgICAgICAgIGkwLAogICAgICAgICAgaTEsCiAgICAgICAgICBpMiwKICAgICAgICAgIHAwLAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgbm9ybWFscywKICAgICAgICAgIHRhbmdlbnRzLAogICAgICAgICAgYml0YW5nZW50cywKICAgICAgICAgIHRleENvb3JkcywKICAgICAgICAgIGV4dHJ1ZGVEaXJlY3Rpb25zLAogICAgICAgICAgYXBwbHlPZmZzZXQsCiAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcywKICAgICAgICAgIGN1c3RvbUF0dHJpYnV0ZU5hbWVzLAogICAgICAgICAgY3VzdG9tQXR0cmlidXRlc0xlbmd0aCwKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbnNlcnRlZEluZGV4CiAgICAgICAgKTsKICAgICAgICBpbnNlcnRlZEluZGV4ID0gaW5zZXJ0U3BsaXRQb2ludCgKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLAogICAgICAgICAgY3VycmVudEluZGljZXMsCiAgICAgICAgICBjdXJyZW50SW5kZXhNYXAsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgaSArIDEsCiAgICAgICAgICBwMQogICAgICAgICk7CiAgICAgICAgY29tcHV0ZVRyaWFuZ2xlQXR0cmlidXRlcygKICAgICAgICAgIGkwLAogICAgICAgICAgaTEsCiAgICAgICAgICBpMiwKICAgICAgICAgIHAxLAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgbm9ybWFscywKICAgICAgICAgIHRhbmdlbnRzLAogICAgICAgICAgYml0YW5nZW50cywKICAgICAgICAgIHRleENvb3JkcywKICAgICAgICAgIGV4dHJ1ZGVEaXJlY3Rpb25zLAogICAgICAgICAgYXBwbHlPZmZzZXQsCiAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcywKICAgICAgICAgIGN1c3RvbUF0dHJpYnV0ZU5hbWVzLAogICAgICAgICAgY3VzdG9tQXR0cmlidXRlc0xlbmd0aCwKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbnNlcnRlZEluZGV4CiAgICAgICAgKTsKICAgICAgICBpbnNlcnRlZEluZGV4ID0gaW5zZXJ0U3BsaXRQb2ludCgKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLAogICAgICAgICAgY3VycmVudEluZGljZXMsCiAgICAgICAgICBjdXJyZW50SW5kZXhNYXAsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgaSArIDIsCiAgICAgICAgICBwMgogICAgICAgICk7CiAgICAgICAgY29tcHV0ZVRyaWFuZ2xlQXR0cmlidXRlcygKICAgICAgICAgIGkwLAogICAgICAgICAgaTEsCiAgICAgICAgICBpMiwKICAgICAgICAgIHAyLAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgbm9ybWFscywKICAgICAgICAgIHRhbmdlbnRzLAogICAgICAgICAgYml0YW5nZW50cywKICAgICAgICAgIHRleENvb3JkcywKICAgICAgICAgIGV4dHJ1ZGVEaXJlY3Rpb25zLAogICAgICAgICAgYXBwbHlPZmZzZXQsCiAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcywKICAgICAgICAgIGN1c3RvbUF0dHJpYnV0ZU5hbWVzLAogICAgICAgICAgY3VzdG9tQXR0cmlidXRlc0xlbmd0aCwKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbnNlcnRlZEluZGV4CiAgICAgICAgKTsKICAgICAgfQogICAgfQogICAgdXBkYXRlSW5zdGFuY2VBZnRlclNwbGl0KGluc3RhbmNlLCB3ZXN0R2VvbWV0cnksIGVhc3RHZW9tZXRyeSk7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVMaW5lQXR0cmlidXRlcyhpMCwgaTEsIHBvaW50LCBwb3NpdGlvbnMsIGluc2VydEluZGV4LCBjdXJyZW50QXR0cmlidXRlcywgYXBwbHlPZmZzZXQpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFwcGx5T2Zmc2V0KSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBwMCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpMCAqIDMsIHAwU2NyYXRjaCk7CiAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24ocDAsIHBvaW50LCBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwKSkgewogICAgICBjdXJyZW50QXR0cmlidXRlcy5hcHBseU9mZnNldC52YWx1ZXNbaW5zZXJ0SW5kZXhdID0gYXBwbHlPZmZzZXRbaTBdOwogICAgfSBlbHNlIHsKICAgICAgY3VycmVudEF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQudmFsdWVzW2luc2VydEluZGV4XSA9IGFwcGx5T2Zmc2V0W2kxXTsKICAgIH0KICB9CiAgZnVuY3Rpb24gc3BsaXRMb25naXR1ZGVMaW5lcyhpbnN0YW5jZSkgewogICAgY29uc3QgZ2VvbWV0cnkgPSBpbnN0YW5jZS5nZW9tZXRyeTsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgY29uc3QgcG9zaXRpb25zID0gYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXM7CiAgICBjb25zdCBhcHBseU9mZnNldCA9IGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0KSA/IGF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQudmFsdWVzIDogdm9pZCAwOwogICAgY29uc3QgaW5kaWNlcyA9IGdlb21ldHJ5LmluZGljZXM7CiAgICBjb25zdCBlYXN0R2VvbWV0cnkgPSBjb3B5R2VvbWV0cnlGb3JTcGxpdChnZW9tZXRyeSk7CiAgICBjb25zdCB3ZXN0R2VvbWV0cnkgPSBjb3B5R2VvbWV0cnlGb3JTcGxpdChnZW9tZXRyeSk7CiAgICBsZXQgaTsKICAgIGNvbnN0IGxlbmd0aCA9IGluZGljZXMubGVuZ3RoOwogICAgY29uc3Qgd2VzdEdlb21ldHJ5SW5kZXhNYXAgPSBbXTsKICAgIHdlc3RHZW9tZXRyeUluZGV4TWFwLmxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgY29uc3QgZWFzdEdlb21ldHJ5SW5kZXhNYXAgPSBbXTsKICAgIGVhc3RHZW9tZXRyeUluZGV4TWFwLmxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgZm9yIChpID0gMDsgaSA8IHdlc3RHZW9tZXRyeUluZGV4TWFwLmxlbmd0aDsgKytpKSB7CiAgICAgIHdlc3RHZW9tZXRyeUluZGV4TWFwW2ldID0gLTE7CiAgICAgIGVhc3RHZW9tZXRyeUluZGV4TWFwW2ldID0gLTE7CiAgICB9CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDIpIHsKICAgICAgY29uc3QgaTAgPSBpbmRpY2VzW2ldOwogICAgICBjb25zdCBpMSA9IGluZGljZXNbaSArIDFdOwogICAgICBjb25zdCBwMCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpMCAqIDMsIHAwU2NyYXRjaCk7CiAgICAgIGNvbnN0IHAxID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGkxICogMywgcDFTY3JhdGNoKTsKICAgICAgbGV0IGluc2VydEluZGV4OwogICAgICBpZiAoTWF0aC5hYnMocDAueSkgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjYpIHsKICAgICAgICBpZiAocDAueSA8IDApIHsKICAgICAgICAgIHAwLnkgPSAtTWF0aF9kZWZhdWx0LkVQU0lMT042OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBwMC55ID0gTWF0aF9kZWZhdWx0LkVQU0lMT042OwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoTWF0aC5hYnMocDEueSkgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjYpIHsKICAgICAgICBpZiAocDEueSA8IDApIHsKICAgICAgICAgIHAxLnkgPSAtTWF0aF9kZWZhdWx0LkVQU0lMT042OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBwMS55ID0gTWF0aF9kZWZhdWx0LkVQU0lMT042OwogICAgICAgIH0KICAgICAgfQogICAgICBsZXQgcDBBdHRyaWJ1dGVzID0gZWFzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgIGxldCBwMEluZGljZXMgPSBlYXN0R2VvbWV0cnkuaW5kaWNlczsKICAgICAgbGV0IHAwSW5kZXhNYXAgPSBlYXN0R2VvbWV0cnlJbmRleE1hcDsKICAgICAgbGV0IHAxQXR0cmlidXRlcyA9IHdlc3RHZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgICBsZXQgcDFJbmRpY2VzID0gd2VzdEdlb21ldHJ5LmluZGljZXM7CiAgICAgIGxldCBwMUluZGV4TWFwID0gd2VzdEdlb21ldHJ5SW5kZXhNYXA7CiAgICAgIGNvbnN0IGludGVyc2VjdGlvbiA9IEludGVyc2VjdGlvblRlc3RzX2RlZmF1bHQubGluZVNlZ21lbnRQbGFuZSgKICAgICAgICBwMCwKICAgICAgICBwMSwKICAgICAgICB4elBsYW5lLAogICAgICAgIHAyU2NyYXRjaAogICAgICApOwogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGludGVyc2VjdGlvbikpIHsKICAgICAgICBjb25zdCBvZmZzZXQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1ksCiAgICAgICAgICA1ICogTWF0aF9kZWZhdWx0LkVQU0lMT045LAogICAgICAgICAgb2Zmc2V0U2NyYXRjaAogICAgICAgICk7CiAgICAgICAgaWYgKHAwLnkgPCAwKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKG9mZnNldCwgb2Zmc2V0KTsKICAgICAgICAgIHAwQXR0cmlidXRlcyA9IHdlc3RHZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgICAgICAgcDBJbmRpY2VzID0gd2VzdEdlb21ldHJ5LmluZGljZXM7CiAgICAgICAgICBwMEluZGV4TWFwID0gd2VzdEdlb21ldHJ5SW5kZXhNYXA7CiAgICAgICAgICBwMUF0dHJpYnV0ZXMgPSBlYXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICAgIHAxSW5kaWNlcyA9IGVhc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgcDFJbmRleE1hcCA9IGVhc3RHZW9tZXRyeUluZGV4TWFwOwogICAgICAgIH0KICAgICAgICBjb25zdCBvZmZzZXRQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICBpbnRlcnNlY3Rpb24sCiAgICAgICAgICBvZmZzZXQsCiAgICAgICAgICBvZmZzZXRQb2ludFNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGluc2VydEluZGV4ID0gaW5zZXJ0U3BsaXRQb2ludCgKICAgICAgICAgIHAwQXR0cmlidXRlcywKICAgICAgICAgIHAwSW5kaWNlcywKICAgICAgICAgIHAwSW5kZXhNYXAsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgaSwKICAgICAgICAgIHAwCiAgICAgICAgKTsKICAgICAgICBjb21wdXRlTGluZUF0dHJpYnV0ZXMoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgcDAsCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBpbnNlcnRJbmRleCwKICAgICAgICAgIHAwQXR0cmlidXRlcywKICAgICAgICAgIGFwcGx5T2Zmc2V0CiAgICAgICAgKTsKICAgICAgICBpbnNlcnRJbmRleCA9IGluc2VydFNwbGl0UG9pbnQoCiAgICAgICAgICBwMEF0dHJpYnV0ZXMsCiAgICAgICAgICBwMEluZGljZXMsCiAgICAgICAgICBwMEluZGV4TWFwLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIC0xLAogICAgICAgICAgb2Zmc2V0UG9pbnQKICAgICAgICApOwogICAgICAgIGNvbXB1dGVMaW5lQXR0cmlidXRlcygKICAgICAgICAgIGkwLAogICAgICAgICAgaTEsCiAgICAgICAgICBvZmZzZXRQb2ludCwKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIGluc2VydEluZGV4LAogICAgICAgICAgcDBBdHRyaWJ1dGVzLAogICAgICAgICAgYXBwbHlPZmZzZXQKICAgICAgICApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUob2Zmc2V0LCBvZmZzZXQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoaW50ZXJzZWN0aW9uLCBvZmZzZXQsIG9mZnNldFBvaW50KTsKICAgICAgICBpbnNlcnRJbmRleCA9IGluc2VydFNwbGl0UG9pbnQoCiAgICAgICAgICBwMUF0dHJpYnV0ZXMsCiAgICAgICAgICBwMUluZGljZXMsCiAgICAgICAgICBwMUluZGV4TWFwLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIC0xLAogICAgICAgICAgb2Zmc2V0UG9pbnQKICAgICAgICApOwogICAgICAgIGNvbXB1dGVMaW5lQXR0cmlidXRlcygKICAgICAgICAgIGkwLAogICAgICAgICAgaTEsCiAgICAgICAgICBvZmZzZXRQb2ludCwKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIGluc2VydEluZGV4LAogICAgICAgICAgcDFBdHRyaWJ1dGVzLAogICAgICAgICAgYXBwbHlPZmZzZXQKICAgICAgICApOwogICAgICAgIGluc2VydEluZGV4ID0gaW5zZXJ0U3BsaXRQb2ludCgKICAgICAgICAgIHAxQXR0cmlidXRlcywKICAgICAgICAgIHAxSW5kaWNlcywKICAgICAgICAgIHAxSW5kZXhNYXAsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgaSArIDEsCiAgICAgICAgICBwMQogICAgICAgICk7CiAgICAgICAgY29tcHV0ZUxpbmVBdHRyaWJ1dGVzKAogICAgICAgICAgaTAsCiAgICAgICAgICBpMSwKICAgICAgICAgIHAxLAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgaW5zZXJ0SW5kZXgsCiAgICAgICAgICBwMUF0dHJpYnV0ZXMsCiAgICAgICAgICBhcHBseU9mZnNldAogICAgICAgICk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbGV0IGN1cnJlbnRBdHRyaWJ1dGVzOwogICAgICAgIGxldCBjdXJyZW50SW5kaWNlczsKICAgICAgICBsZXQgY3VycmVudEluZGV4TWFwOwogICAgICAgIGlmIChwMC55IDwgMCkgewogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMgPSB3ZXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICAgIGN1cnJlbnRJbmRpY2VzID0gd2VzdEdlb21ldHJ5LmluZGljZXM7CiAgICAgICAgICBjdXJyZW50SW5kZXhNYXAgPSB3ZXN0R2VvbWV0cnlJbmRleE1hcDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMgPSBlYXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICAgIGN1cnJlbnRJbmRpY2VzID0gZWFzdEdlb21ldHJ5LmluZGljZXM7CiAgICAgICAgICBjdXJyZW50SW5kZXhNYXAgPSBlYXN0R2VvbWV0cnlJbmRleE1hcDsKICAgICAgICB9CiAgICAgICAgaW5zZXJ0SW5kZXggPSBpbnNlcnRTcGxpdFBvaW50KAogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMsCiAgICAgICAgICBjdXJyZW50SW5kaWNlcywKICAgICAgICAgIGN1cnJlbnRJbmRleE1hcCwKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBpLAogICAgICAgICAgcDAKICAgICAgICApOwogICAgICAgIGNvbXB1dGVMaW5lQXR0cmlidXRlcygKICAgICAgICAgIGkwLAogICAgICAgICAgaTEsCiAgICAgICAgICBwMCwKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIGluc2VydEluZGV4LAogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMsCiAgICAgICAgICBhcHBseU9mZnNldAogICAgICAgICk7CiAgICAgICAgaW5zZXJ0SW5kZXggPSBpbnNlcnRTcGxpdFBvaW50KAogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMsCiAgICAgICAgICBjdXJyZW50SW5kaWNlcywKICAgICAgICAgIGN1cnJlbnRJbmRleE1hcCwKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBpICsgMSwKICAgICAgICAgIHAxCiAgICAgICAgKTsKICAgICAgICBjb21wdXRlTGluZUF0dHJpYnV0ZXMoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgcDEsCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBpbnNlcnRJbmRleCwKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLAogICAgICAgICAgYXBwbHlPZmZzZXQKICAgICAgICApOwogICAgICB9CiAgICB9CiAgICB1cGRhdGVJbnN0YW5jZUFmdGVyU3BsaXQoaW5zdGFuY2UsIHdlc3RHZW9tZXRyeSwgZWFzdEdlb21ldHJ5KTsKICB9CiAgZnVuY3Rpb24gdXBkYXRlQWRqYWNlbmN5QWZ0ZXJTcGxpdChnZW9tZXRyeSkgewogICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgIGNvbnN0IHByZXZQb3NpdGlvbnMgPSBhdHRyaWJ1dGVzLnByZXZQb3NpdGlvbi52YWx1ZXM7CiAgICBjb25zdCBuZXh0UG9zaXRpb25zID0gYXR0cmlidXRlcy5uZXh0UG9zaXRpb24udmFsdWVzOwogICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgIGZvciAobGV0IGogPSAwOyBqIDwgbGVuZ3RoOyBqICs9IDMpIHsKICAgICAgY29uc3QgcG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKHBvc2l0aW9ucywgaiwgY2FydGVzaWFuM1NjcmF0Y2gwKTsKICAgICAgaWYgKHBvc2l0aW9uLnggPiAwKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29uc3QgcHJldlBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICBwcmV2UG9zaXRpb25zLAogICAgICAgIGosCiAgICAgICAgY2FydGVzaWFuM1NjcmF0Y2gyCiAgICAgICk7CiAgICAgIGlmIChwb3NpdGlvbi55IDwgMCAmJiBwcmV2UG9zaXRpb24ueSA+IDAgfHwgcG9zaXRpb24ueSA+IDAgJiYgcHJldlBvc2l0aW9uLnkgPCAwKSB7CiAgICAgICAgaWYgKGogLSAzID4gMCkgewogICAgICAgICAgcHJldlBvc2l0aW9uc1tqXSA9IHBvc2l0aW9uc1tqIC0gM107CiAgICAgICAgICBwcmV2UG9zaXRpb25zW2ogKyAxXSA9IHBvc2l0aW9uc1tqIC0gMl07CiAgICAgICAgICBwcmV2UG9zaXRpb25zW2ogKyAyXSA9IHBvc2l0aW9uc1tqIC0gMV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHBvc2l0aW9uLCBwcmV2UG9zaXRpb25zLCBqKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgbmV4dFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICBuZXh0UG9zaXRpb25zLAogICAgICAgIGosCiAgICAgICAgY2FydGVzaWFuM1NjcmF0Y2gzCiAgICAgICk7CiAgICAgIGlmIChwb3NpdGlvbi55IDwgMCAmJiBuZXh0UG9zaXRpb24ueSA+IDAgfHwgcG9zaXRpb24ueSA+IDAgJiYgbmV4dFBvc2l0aW9uLnkgPCAwKSB7CiAgICAgICAgaWYgKGogKyAzIDwgbGVuZ3RoKSB7CiAgICAgICAgICBuZXh0UG9zaXRpb25zW2pdID0gcG9zaXRpb25zW2ogKyAzXTsKICAgICAgICAgIG5leHRQb3NpdGlvbnNbaiArIDFdID0gcG9zaXRpb25zW2ogKyA0XTsKICAgICAgICAgIG5leHRQb3NpdGlvbnNbaiArIDJdID0gcG9zaXRpb25zW2ogKyA1XTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2socG9zaXRpb24sIG5leHRQb3NpdGlvbnMsIGopOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBzcGxpdExvbmdpdHVkZVBvbHlsaW5lKGluc3RhbmNlKSB7CiAgICBjb25zdCBnZW9tZXRyeSA9IGluc3RhbmNlLmdlb21ldHJ5OwogICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgIGNvbnN0IHByZXZQb3NpdGlvbnMgPSBhdHRyaWJ1dGVzLnByZXZQb3NpdGlvbi52YWx1ZXM7CiAgICBjb25zdCBuZXh0UG9zaXRpb25zID0gYXR0cmlidXRlcy5uZXh0UG9zaXRpb24udmFsdWVzOwogICAgY29uc3QgZXhwYW5kQW5kV2lkdGhzID0gYXR0cmlidXRlcy5leHBhbmRBbmRXaWR0aC52YWx1ZXM7CiAgICBjb25zdCB0ZXhDb29yZHMgPSBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlcy5zdCkgPyBhdHRyaWJ1dGVzLnN0LnZhbHVlcyA6IHZvaWQgMDsKICAgIGNvbnN0IGNvbG9ycyA9IGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLmNvbG9yKSA/IGF0dHJpYnV0ZXMuY29sb3IudmFsdWVzIDogdm9pZCAwOwogICAgY29uc3QgZWFzdEdlb21ldHJ5ID0gY29weUdlb21ldHJ5Rm9yU3BsaXQoZ2VvbWV0cnkpOwogICAgY29uc3Qgd2VzdEdlb21ldHJ5ID0gY29weUdlb21ldHJ5Rm9yU3BsaXQoZ2VvbWV0cnkpOwogICAgbGV0IGk7CiAgICBsZXQgajsKICAgIGxldCBpbmRleDsKICAgIGxldCBpbnRlcnNlY3Rpb25Gb3VuZCA9IGZhbHNlOwogICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDQpIHsKICAgICAgY29uc3QgaTAgPSBpOwogICAgICBjb25zdCBpMiA9IGkgKyAyOwogICAgICBjb25zdCBwMCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpMCAqIDMsIGNhcnRlc2lhbjNTY3JhdGNoMCk7CiAgICAgIGNvbnN0IHAyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGkyICogMywgY2FydGVzaWFuM1NjcmF0Y2gyKTsKICAgICAgaWYgKE1hdGguYWJzKHAwLnkpIDwgY29wbGFuYXJPZmZzZXQpIHsKICAgICAgICBwMC55ID0gY29wbGFuYXJPZmZzZXQgKiAocDIueSA8IDAgPyAtMSA6IDEpOwogICAgICAgIHBvc2l0aW9uc1tpICogMyArIDFdID0gcDAueTsKICAgICAgICBwb3NpdGlvbnNbKGkgKyAxKSAqIDMgKyAxXSA9IHAwLnk7CiAgICAgICAgZm9yIChqID0gaTAgKiAzOyBqIDwgaTAgKiAzICsgNCAqIDM7IGogKz0gMykgewogICAgICAgICAgcHJldlBvc2l0aW9uc1tqXSA9IHBvc2l0aW9uc1tpICogM107CiAgICAgICAgICBwcmV2UG9zaXRpb25zW2ogKyAxXSA9IHBvc2l0aW9uc1tpICogMyArIDFdOwogICAgICAgICAgcHJldlBvc2l0aW9uc1tqICsgMl0gPSBwb3NpdGlvbnNbaSAqIDMgKyAyXTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKE1hdGguYWJzKHAyLnkpIDwgY29wbGFuYXJPZmZzZXQpIHsKICAgICAgICBwMi55ID0gY29wbGFuYXJPZmZzZXQgKiAocDAueSA8IDAgPyAtMSA6IDEpOwogICAgICAgIHBvc2l0aW9uc1soaSArIDIpICogMyArIDFdID0gcDIueTsKICAgICAgICBwb3NpdGlvbnNbKGkgKyAzKSAqIDMgKyAxXSA9IHAyLnk7CiAgICAgICAgZm9yIChqID0gaTAgKiAzOyBqIDwgaTAgKiAzICsgNCAqIDM7IGogKz0gMykgewogICAgICAgICAgbmV4dFBvc2l0aW9uc1tqXSA9IHBvc2l0aW9uc1soaSArIDIpICogM107CiAgICAgICAgICBuZXh0UG9zaXRpb25zW2ogKyAxXSA9IHBvc2l0aW9uc1soaSArIDIpICogMyArIDFdOwogICAgICAgICAgbmV4dFBvc2l0aW9uc1tqICsgMl0gPSBwb3NpdGlvbnNbKGkgKyAyKSAqIDMgKyAyXTsKICAgICAgICB9CiAgICAgIH0KICAgICAgbGV0IHAwQXR0cmlidXRlcyA9IGVhc3RHZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgICBsZXQgcDBJbmRpY2VzID0gZWFzdEdlb21ldHJ5LmluZGljZXM7CiAgICAgIGxldCBwMkF0dHJpYnV0ZXMgPSB3ZXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgbGV0IHAySW5kaWNlcyA9IHdlc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICBjb25zdCBpbnRlcnNlY3Rpb24gPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LmxpbmVTZWdtZW50UGxhbmUoCiAgICAgICAgcDAsCiAgICAgICAgcDIsCiAgICAgICAgeHpQbGFuZSwKICAgICAgICBjYXJ0ZXNpYW4zU2NyYXRjaDQKICAgICAgKTsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnRlcnNlY3Rpb24pKSB7CiAgICAgICAgaW50ZXJzZWN0aW9uRm91bmQgPSB0cnVlOwogICAgICAgIGNvbnN0IG9mZnNldCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWSwKICAgICAgICAgIG9mZnNldFNjYWxhciwKICAgICAgICAgIGNhcnRlc2lhbjNTY3JhdGNoNQogICAgICAgICk7CiAgICAgICAgaWYgKHAwLnkgPCAwKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKG9mZnNldCwgb2Zmc2V0KTsKICAgICAgICAgIHAwQXR0cmlidXRlcyA9IHdlc3RHZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgICAgICAgcDBJbmRpY2VzID0gd2VzdEdlb21ldHJ5LmluZGljZXM7CiAgICAgICAgICBwMkF0dHJpYnV0ZXMgPSBlYXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICAgIHAySW5kaWNlcyA9IGVhc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgIH0KICAgICAgICBjb25zdCBvZmZzZXRQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICBpbnRlcnNlY3Rpb24sCiAgICAgICAgICBvZmZzZXQsCiAgICAgICAgICBjYXJ0ZXNpYW4zU2NyYXRjaDYKICAgICAgICApOwogICAgICAgIHAwQXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMucHVzaChwMC54LCBwMC55LCBwMC56LCBwMC54LCBwMC55LCBwMC56KTsKICAgICAgICBwMEF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLnB1c2goCiAgICAgICAgICBvZmZzZXRQb2ludC54LAogICAgICAgICAgb2Zmc2V0UG9pbnQueSwKICAgICAgICAgIG9mZnNldFBvaW50LnoKICAgICAgICApOwogICAgICAgIHAwQXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMucHVzaCgKICAgICAgICAgIG9mZnNldFBvaW50LngsCiAgICAgICAgICBvZmZzZXRQb2ludC55LAogICAgICAgICAgb2Zmc2V0UG9pbnQuegogICAgICAgICk7CiAgICAgICAgcDBBdHRyaWJ1dGVzLnByZXZQb3NpdGlvbi52YWx1ZXMucHVzaCgKICAgICAgICAgIHByZXZQb3NpdGlvbnNbaTAgKiAzXSwKICAgICAgICAgIHByZXZQb3NpdGlvbnNbaTAgKiAzICsgMV0sCiAgICAgICAgICBwcmV2UG9zaXRpb25zW2kwICogMyArIDJdCiAgICAgICAgKTsKICAgICAgICBwMEF0dHJpYnV0ZXMucHJldlBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgcHJldlBvc2l0aW9uc1tpMCAqIDMgKyAzXSwKICAgICAgICAgIHByZXZQb3NpdGlvbnNbaTAgKiAzICsgNF0sCiAgICAgICAgICBwcmV2UG9zaXRpb25zW2kwICogMyArIDVdCiAgICAgICAgKTsKICAgICAgICBwMEF0dHJpYnV0ZXMucHJldlBvc2l0aW9uLnZhbHVlcy5wdXNoKHAwLngsIHAwLnksIHAwLnosIHAwLngsIHAwLnksIHAwLnopOwogICAgICAgIHAwQXR0cmlidXRlcy5uZXh0UG9zaXRpb24udmFsdWVzLnB1c2goCiAgICAgICAgICBvZmZzZXRQb2ludC54LAogICAgICAgICAgb2Zmc2V0UG9pbnQueSwKICAgICAgICAgIG9mZnNldFBvaW50LnoKICAgICAgICApOwogICAgICAgIHAwQXR0cmlidXRlcy5uZXh0UG9zaXRpb24udmFsdWVzLnB1c2goCiAgICAgICAgICBvZmZzZXRQb2ludC54LAogICAgICAgICAgb2Zmc2V0UG9pbnQueSwKICAgICAgICAgIG9mZnNldFBvaW50LnoKICAgICAgICApOwogICAgICAgIHAwQXR0cmlidXRlcy5uZXh0UG9zaXRpb24udmFsdWVzLnB1c2goCiAgICAgICAgICBvZmZzZXRQb2ludC54LAogICAgICAgICAgb2Zmc2V0UG9pbnQueSwKICAgICAgICAgIG9mZnNldFBvaW50LnoKICAgICAgICApOwogICAgICAgIHAwQXR0cmlidXRlcy5uZXh0UG9zaXRpb24udmFsdWVzLnB1c2goCiAgICAgICAgICBvZmZzZXRQb2ludC54LAogICAgICAgICAgb2Zmc2V0UG9pbnQueSwKICAgICAgICAgIG9mZnNldFBvaW50LnoKICAgICAgICApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUob2Zmc2V0LCBvZmZzZXQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoaW50ZXJzZWN0aW9uLCBvZmZzZXQsIG9mZnNldFBvaW50KTsKICAgICAgICBwMkF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLnB1c2goCiAgICAgICAgICBvZmZzZXRQb2ludC54LAogICAgICAgICAgb2Zmc2V0UG9pbnQueSwKICAgICAgICAgIG9mZnNldFBvaW50LnoKICAgICAgICApOwogICAgICAgIHAyQXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMucHVzaCgKICAgICAgICAgIG9mZnNldFBvaW50LngsCiAgICAgICAgICBvZmZzZXRQb2ludC55LAogICAgICAgICAgb2Zmc2V0UG9pbnQuegogICAgICAgICk7CiAgICAgICAgcDJBdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5wdXNoKHAyLngsIHAyLnksIHAyLnosIHAyLngsIHAyLnksIHAyLnopOwogICAgICAgIHAyQXR0cmlidXRlcy5wcmV2UG9zaXRpb24udmFsdWVzLnB1c2goCiAgICAgICAgICBvZmZzZXRQb2ludC54LAogICAgICAgICAgb2Zmc2V0UG9pbnQueSwKICAgICAgICAgIG9mZnNldFBvaW50LnoKICAgICAgICApOwogICAgICAgIHAyQXR0cmlidXRlcy5wcmV2UG9zaXRpb24udmFsdWVzLnB1c2goCiAgICAgICAgICBvZmZzZXRQb2ludC54LAogICAgICAgICAgb2Zmc2V0UG9pbnQueSwKICAgICAgICAgIG9mZnNldFBvaW50LnoKICAgICAgICApOwogICAgICAgIHAyQXR0cmlidXRlcy5wcmV2UG9zaXRpb24udmFsdWVzLnB1c2goCiAgICAgICAgICBvZmZzZXRQb2ludC54LAogICAgICAgICAgb2Zmc2V0UG9pbnQueSwKICAgICAgICAgIG9mZnNldFBvaW50LnoKICAgICAgICApOwogICAgICAgIHAyQXR0cmlidXRlcy5wcmV2UG9zaXRpb24udmFsdWVzLnB1c2goCiAgICAgICAgICBvZmZzZXRQb2ludC54LAogICAgICAgICAgb2Zmc2V0UG9pbnQueSwKICAgICAgICAgIG9mZnNldFBvaW50LnoKICAgICAgICApOwogICAgICAgIHAyQXR0cmlidXRlcy5uZXh0UG9zaXRpb24udmFsdWVzLnB1c2gocDIueCwgcDIueSwgcDIueiwgcDIueCwgcDIueSwgcDIueik7CiAgICAgICAgcDJBdHRyaWJ1dGVzLm5leHRQb3NpdGlvbi52YWx1ZXMucHVzaCgKICAgICAgICAgIG5leHRQb3NpdGlvbnNbaTIgKiAzXSwKICAgICAgICAgIG5leHRQb3NpdGlvbnNbaTIgKiAzICsgMV0sCiAgICAgICAgICBuZXh0UG9zaXRpb25zW2kyICogMyArIDJdCiAgICAgICAgKTsKICAgICAgICBwMkF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgbmV4dFBvc2l0aW9uc1tpMiAqIDMgKyAzXSwKICAgICAgICAgIG5leHRQb3NpdGlvbnNbaTIgKiAzICsgNF0sCiAgICAgICAgICBuZXh0UG9zaXRpb25zW2kyICogMyArIDVdCiAgICAgICAgKTsKICAgICAgICBjb25zdCBldzAgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgZXhwYW5kQW5kV2lkdGhzLAogICAgICAgICAgaTAgKiAyLAogICAgICAgICAgY2FydGVzaWFuMlNjcmF0Y2gwCiAgICAgICAgKTsKICAgICAgICBjb25zdCB3aWR0aCA9IE1hdGguYWJzKGV3MC55KTsKICAgICAgICBwMEF0dHJpYnV0ZXMuZXhwYW5kQW5kV2lkdGgudmFsdWVzLnB1c2goLTEsIHdpZHRoLCAxLCB3aWR0aCk7CiAgICAgICAgcDBBdHRyaWJ1dGVzLmV4cGFuZEFuZFdpZHRoLnZhbHVlcy5wdXNoKC0xLCAtd2lkdGgsIDEsIC13aWR0aCk7CiAgICAgICAgcDJBdHRyaWJ1dGVzLmV4cGFuZEFuZFdpZHRoLnZhbHVlcy5wdXNoKC0xLCB3aWR0aCwgMSwgd2lkdGgpOwogICAgICAgIHAyQXR0cmlidXRlcy5leHBhbmRBbmRXaWR0aC52YWx1ZXMucHVzaCgtMSwgLXdpZHRoLCAxLCAtd2lkdGgpOwogICAgICAgIGxldCB0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoaW50ZXJzZWN0aW9uLCBwMCwgY2FydGVzaWFuM1NjcmF0Y2gzKQogICAgICAgICk7CiAgICAgICAgdCAvPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwMiwgcDAsIGNhcnRlc2lhbjNTY3JhdGNoMykKICAgICAgICApOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoY29sb3JzKSkgewogICAgICAgICAgY29uc3QgYzAgPSBDYXJ0ZXNpYW40X2RlZmF1bHQuZnJvbUFycmF5KGNvbG9ycywgaTAgKiA0LCBjYXJ0ZXNpYW40U2NyYXRjaDApOwogICAgICAgICAgY29uc3QgYzIgPSBDYXJ0ZXNpYW40X2RlZmF1bHQuZnJvbUFycmF5KGNvbG9ycywgaTIgKiA0LCBjYXJ0ZXNpYW40U2NyYXRjaDApOwogICAgICAgICAgY29uc3QgciA9IE1hdGhfZGVmYXVsdC5sZXJwKGMwLngsIGMyLngsIHQpOwogICAgICAgICAgY29uc3QgZyA9IE1hdGhfZGVmYXVsdC5sZXJwKGMwLnksIGMyLnksIHQpOwogICAgICAgICAgY29uc3QgYiA9IE1hdGhfZGVmYXVsdC5sZXJwKGMwLnosIGMyLnosIHQpOwogICAgICAgICAgY29uc3QgYTMgPSBNYXRoX2RlZmF1bHQubGVycChjMC53LCBjMi53LCB0KTsKICAgICAgICAgIGZvciAoaiA9IGkwICogNDsgaiA8IGkwICogNCArIDIgKiA0OyArK2opIHsKICAgICAgICAgICAgcDBBdHRyaWJ1dGVzLmNvbG9yLnZhbHVlcy5wdXNoKGNvbG9yc1tqXSk7CiAgICAgICAgICB9CiAgICAgICAgICBwMEF0dHJpYnV0ZXMuY29sb3IudmFsdWVzLnB1c2gociwgZywgYiwgYTMpOwogICAgICAgICAgcDBBdHRyaWJ1dGVzLmNvbG9yLnZhbHVlcy5wdXNoKHIsIGcsIGIsIGEzKTsKICAgICAgICAgIHAyQXR0cmlidXRlcy5jb2xvci52YWx1ZXMucHVzaChyLCBnLCBiLCBhMyk7CiAgICAgICAgICBwMkF0dHJpYnV0ZXMuY29sb3IudmFsdWVzLnB1c2gociwgZywgYiwgYTMpOwogICAgICAgICAgZm9yIChqID0gaTIgKiA0OyBqIDwgaTIgKiA0ICsgMiAqIDQ7ICsraikgewogICAgICAgICAgICBwMkF0dHJpYnV0ZXMuY29sb3IudmFsdWVzLnB1c2goY29sb3JzW2pdKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0ZXhDb29yZHMpKSB7CiAgICAgICAgICBjb25zdCBzMCA9IENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tQXJyYXkodGV4Q29vcmRzLCBpMCAqIDIsIGNhcnRlc2lhbjJTY3JhdGNoMCk7CiAgICAgICAgICBjb25zdCBzMyA9IENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgIHRleENvb3JkcywKICAgICAgICAgICAgKGkgKyAzKSAqIDIsCiAgICAgICAgICAgIGNhcnRlc2lhbjJTY3JhdGNoMQogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHN4ID0gTWF0aF9kZWZhdWx0LmxlcnAoczAueCwgczMueCwgdCk7CiAgICAgICAgICBmb3IgKGogPSBpMCAqIDI7IGogPCBpMCAqIDIgKyAyICogMjsgKytqKSB7CiAgICAgICAgICAgIHAwQXR0cmlidXRlcy5zdC52YWx1ZXMucHVzaCh0ZXhDb29yZHNbal0pOwogICAgICAgICAgfQogICAgICAgICAgcDBBdHRyaWJ1dGVzLnN0LnZhbHVlcy5wdXNoKHN4LCBzMC55KTsKICAgICAgICAgIHAwQXR0cmlidXRlcy5zdC52YWx1ZXMucHVzaChzeCwgczMueSk7CiAgICAgICAgICBwMkF0dHJpYnV0ZXMuc3QudmFsdWVzLnB1c2goc3gsIHMwLnkpOwogICAgICAgICAgcDJBdHRyaWJ1dGVzLnN0LnZhbHVlcy5wdXNoKHN4LCBzMy55KTsKICAgICAgICAgIGZvciAoaiA9IGkyICogMjsgaiA8IGkyICogMiArIDIgKiAyOyArK2opIHsKICAgICAgICAgICAgcDJBdHRyaWJ1dGVzLnN0LnZhbHVlcy5wdXNoKHRleENvb3Jkc1tqXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGluZGV4ID0gcDBBdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGggLyAzIC0gNDsKICAgICAgICBwMEluZGljZXMucHVzaChpbmRleCwgaW5kZXggKyAyLCBpbmRleCArIDEpOwogICAgICAgIHAwSW5kaWNlcy5wdXNoKGluZGV4ICsgMSwgaW5kZXggKyAyLCBpbmRleCArIDMpOwogICAgICAgIGluZGV4ID0gcDJBdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGggLyAzIC0gNDsKICAgICAgICBwMkluZGljZXMucHVzaChpbmRleCwgaW5kZXggKyAyLCBpbmRleCArIDEpOwogICAgICAgIHAySW5kaWNlcy5wdXNoKGluZGV4ICsgMSwgaW5kZXggKyAyLCBpbmRleCArIDMpOwogICAgICB9IGVsc2UgewogICAgICAgIGxldCBjdXJyZW50QXR0cmlidXRlczsKICAgICAgICBsZXQgY3VycmVudEluZGljZXM7CiAgICAgICAgaWYgKHAwLnkgPCAwKSB7CiAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcyA9IHdlc3RHZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgICAgICAgY3VycmVudEluZGljZXMgPSB3ZXN0R2VvbWV0cnkuaW5kaWNlczsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMgPSBlYXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICAgIGN1cnJlbnRJbmRpY2VzID0gZWFzdEdlb21ldHJ5LmluZGljZXM7CiAgICAgICAgfQogICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5wdXNoKHAwLngsIHAwLnksIHAwLnopOwogICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5wdXNoKHAwLngsIHAwLnksIHAwLnopOwogICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5wdXNoKHAyLngsIHAyLnksIHAyLnopOwogICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5wdXNoKHAyLngsIHAyLnksIHAyLnopOwogICAgICAgIGZvciAoaiA9IGkgKiAzOyBqIDwgaSAqIDMgKyA0ICogMzsgKytqKSB7CiAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5wcmV2UG9zaXRpb24udmFsdWVzLnB1c2gocHJldlBvc2l0aW9uc1tqXSk7CiAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5uZXh0UG9zaXRpb24udmFsdWVzLnB1c2gobmV4dFBvc2l0aW9uc1tqXSk7CiAgICAgICAgfQogICAgICAgIGZvciAoaiA9IGkgKiAyOyBqIDwgaSAqIDIgKyA0ICogMjsgKytqKSB7CiAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5leHBhbmRBbmRXaWR0aC52YWx1ZXMucHVzaChleHBhbmRBbmRXaWR0aHNbal0pOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0ZXhDb29yZHMpKSB7CiAgICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLnN0LnZhbHVlcy5wdXNoKHRleENvb3Jkc1tqXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoY29sb3JzKSkgewogICAgICAgICAgZm9yIChqID0gaSAqIDQ7IGogPCBpICogNCArIDQgKiA0OyArK2opIHsKICAgICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMuY29sb3IudmFsdWVzLnB1c2goY29sb3JzW2pdKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaW5kZXggPSBjdXJyZW50QXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoIC8gMyAtIDQ7CiAgICAgICAgY3VycmVudEluZGljZXMucHVzaChpbmRleCwgaW5kZXggKyAyLCBpbmRleCArIDEpOwogICAgICAgIGN1cnJlbnRJbmRpY2VzLnB1c2goaW5kZXggKyAxLCBpbmRleCArIDIsIGluZGV4ICsgMyk7CiAgICAgIH0KICAgIH0KICAgIGlmIChpbnRlcnNlY3Rpb25Gb3VuZCkgewogICAgICB1cGRhdGVBZGphY2VuY3lBZnRlclNwbGl0KHdlc3RHZW9tZXRyeSk7CiAgICAgIHVwZGF0ZUFkamFjZW5jeUFmdGVyU3BsaXQoZWFzdEdlb21ldHJ5KTsKICAgIH0KICAgIHVwZGF0ZUluc3RhbmNlQWZ0ZXJTcGxpdChpbnN0YW5jZSwgd2VzdEdlb21ldHJ5LCBlYXN0R2VvbWV0cnkpOwogIH0KICB2YXIgR2VvbWV0cnlQaXBlbGluZSwgc2NyYXRjaFByb2plY3RUbzJEQ2FydGVzaWFuMywgc2NyYXRjaFByb2plY3RUbzJEQ2FydG9ncmFwaGljLCBlbmNvZGVkUmVzdWx0LCBzY3JhdGNoQ2FydGVzaWFuMzMsIGludmVyc2VUcmFuc3Bvc2UsIG5vcm1hbE1hdHJpeCwgdGVtcFNjcmF0Y2gsIG5vcm1hbCwgdjAsIHYxLCB2Miwgbm9ybWFsU2NyYXRjaDIsIG5vcm1hbFNjYWxlLCB0U2NyYXRjaCwgc2NyYXRjaENhcnRlc2lhbjIyLCB0b0VuY29kZTEsIHRvRW5jb2RlMiwgdG9FbmNvZGUzLCBlbmNvZGVSZXN1bHQyLCBjMywgdTEsIHUyLCBxMSwgcTIsIHNwbGl0VHJpYW5nbGVSZXN1bHQsIGludGVycG9sYXRlQW5kUGFja0NhcnRlc2lhbjQsIGludGVycG9sYXRlQW5kUGFja0NhcnRlc2lhbjMsIGludGVycG9sYXRlQW5kUGFja0NhcnRlc2lhbjIsIGludGVycG9sYXRlQW5kUGFja0Jvb2xlYW4sIHAwU2NyYXRjaCwgcDFTY3JhdGNoLCBwMlNjcmF0Y2gsIGJhcnljZW50cmljU2NyYXRjaCwgTkFNRURfQVRUUklCVVRFUywgeHpQbGFuZSwgb2Zmc2V0U2NyYXRjaCwgb2Zmc2V0UG9pbnRTY3JhdGNoLCBjYXJ0ZXNpYW4yU2NyYXRjaDAsIGNhcnRlc2lhbjJTY3JhdGNoMSwgY2FydGVzaWFuM1NjcmF0Y2gwLCBjYXJ0ZXNpYW4zU2NyYXRjaDIsIGNhcnRlc2lhbjNTY3JhdGNoMywgY2FydGVzaWFuM1NjcmF0Y2g0LCBjYXJ0ZXNpYW4zU2NyYXRjaDUsIGNhcnRlc2lhbjNTY3JhdGNoNiwgY2FydGVzaWFuNFNjcmF0Y2gwLCBvZmZzZXRTY2FsYXIsIGNvcGxhbmFyT2Zmc2V0LCBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQ7CiAgdmFyIGluaXRfR2VvbWV0cnlQaXBlbGluZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvbWV0cnlQaXBlbGluZS5qcyIoKSB7CiAgICAgIGluaXRfQXR0cmlidXRlQ29tcHJlc3Npb24oKTsKICAgICAgaW5pdF9iYXJ5Y2VudHJpY0Nvb3JkaW5hdGVzKCk7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRlc2lhbjQoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VuY29kZWRDYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfR2VvZ3JhcGhpY1Byb2plY3Rpb24oKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlUeXBlKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X0ludGVyc2VjdCgpOwogICAgICBpbml0X0ludGVyc2VjdGlvblRlc3RzKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIGluaXRfUGxhbmUoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfVGlwc2lmeSgpOwogICAgICBHZW9tZXRyeVBpcGVsaW5lID0ge307CiAgICAgIEdlb21ldHJ5UGlwZWxpbmUudG9XaXJlZnJhbWUgPSBmdW5jdGlvbihnZW9tZXRyeSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbmRpY2VzID0gZ2VvbWV0cnkuaW5kaWNlczsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGluZGljZXMpKSB7CiAgICAgICAgICBzd2l0Y2ggKGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUpIHsKICAgICAgICAgICAgY2FzZSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTOgogICAgICAgICAgICAgIGdlb21ldHJ5LmluZGljZXMgPSB0cmlhbmdsZXNUb0xpbmVzKGluZGljZXMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRV9TVFJJUDoKICAgICAgICAgICAgICBnZW9tZXRyeS5pbmRpY2VzID0gdHJpYW5nbGVTdHJpcFRvTGluZXMoaW5kaWNlcyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFX0ZBTjoKICAgICAgICAgICAgICBnZW9tZXRyeS5pbmRpY2VzID0gdHJpYW5nbGVGYW5Ub0xpbmVzKGluZGljZXMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAgICAgImdlb21ldHJ5LnByaW1pdGl2ZVR5cGUgbXVzdCBiZSBUUklBTkdMRVMsIFRSSUFOR0xFX1NUUklQLCBvciBUUklBTkdMRV9GQU4uIgogICAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICBnZW9tZXRyeS5wcmltaXRpdmVUeXBlID0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgIH07CiAgICAgIEdlb21ldHJ5UGlwZWxpbmUuY3JlYXRlTGluZVNlZ21lbnRzRm9yVmVjdG9ycyA9IGZ1bmN0aW9uKGdlb21ldHJ5LCBhdHRyaWJ1dGVOYW1lLCBsZW5ndGgpIHsKICAgICAgICBhdHRyaWJ1dGVOYW1lID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoYXR0cmlidXRlTmFtZSwgIm5vcm1hbCIpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgYGdlb21ldHJ5LmF0dHJpYnV0ZXMgbXVzdCBoYXZlIGFuIGF0dHJpYnV0ZSB3aXRoIHRoZSBzYW1lIG5hbWUgYXMgdGhlIGF0dHJpYnV0ZU5hbWUgcGFyYW1ldGVyLCAke2F0dHJpYnV0ZU5hbWV9LmAKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGxlbmd0aCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGxlbmd0aCwgMWU0KTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgICAgICBjb25zdCB2ZWN0b3JzID0gZ2VvbWV0cnkuYXR0cmlidXRlc1thdHRyaWJ1dGVOYW1lXS52YWx1ZXM7CiAgICAgICAgY29uc3QgcG9zaXRpb25zTGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBjb25zdCBuZXdQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KDIgKiBwb3NpdGlvbnNMZW5ndGgpOwogICAgICAgIGxldCBqID0gMDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9uc0xlbmd0aDsgaSArPSAzKSB7CiAgICAgICAgICBuZXdQb3NpdGlvbnNbaisrXSA9IHBvc2l0aW9uc1tpXTsKICAgICAgICAgIG5ld1Bvc2l0aW9uc1tqKytdID0gcG9zaXRpb25zW2kgKyAxXTsKICAgICAgICAgIG5ld1Bvc2l0aW9uc1tqKytdID0gcG9zaXRpb25zW2kgKyAyXTsKICAgICAgICAgIG5ld1Bvc2l0aW9uc1tqKytdID0gcG9zaXRpb25zW2ldICsgdmVjdG9yc1tpXSAqIGxlbmd0aDsKICAgICAgICAgIG5ld1Bvc2l0aW9uc1tqKytdID0gcG9zaXRpb25zW2kgKyAxXSArIHZlY3RvcnNbaSArIDFdICogbGVuZ3RoOwogICAgICAgICAgbmV3UG9zaXRpb25zW2orK10gPSBwb3NpdGlvbnNbaSArIDJdICsgdmVjdG9yc1tpICsgMl0gKiBsZW5ndGg7CiAgICAgICAgfQogICAgICAgIGxldCBuZXdCb3VuZGluZ1NwaGVyZTsKICAgICAgICBjb25zdCBicyA9IGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYnMpKSB7CiAgICAgICAgICBuZXdCb3VuZGluZ1NwaGVyZSA9IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KGJzLmNlbnRlciwgYnMucmFkaXVzICsgbGVuZ3RoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXM6IHsKICAgICAgICAgICAgcG9zaXRpb246IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IG5ld1Bvc2l0aW9ucwogICAgICAgICAgICB9KQogICAgICAgICAgfSwKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBuZXdCb3VuZGluZ1NwaGVyZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBHZW9tZXRyeVBpcGVsaW5lLmNyZWF0ZUF0dHJpYnV0ZUxvY2F0aW9ucyA9IGZ1bmN0aW9uKGdlb21ldHJ5KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZ2VvbWV0cnkgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNlbWFudGljcyA9IFsKICAgICAgICAgICJwb3NpdGlvbiIsCiAgICAgICAgICAicG9zaXRpb25IaWdoIiwKICAgICAgICAgICJwb3NpdGlvbkxvdyIsCiAgICAgICAgICAvLyBGcm9tIFZlcnRleEZvcm1hdC5wb3NpdGlvbiAtIGFmdGVyIDJEIHByb2plY3Rpb24gYW5kIGhpZ2gtcHJlY2lzaW9uIGVuY29kaW5nCiAgICAgICAgICAicG9zaXRpb24zREhpZ2giLAogICAgICAgICAgInBvc2l0aW9uM0RMb3ciLAogICAgICAgICAgInBvc2l0aW9uMkRIaWdoIiwKICAgICAgICAgICJwb3NpdGlvbjJETG93IiwKICAgICAgICAgIC8vIEZyb20gUHJpbWl0aXZlCiAgICAgICAgICAicGlja0NvbG9yIiwKICAgICAgICAgIC8vIEZyb20gVmVydGV4Rm9ybWF0CiAgICAgICAgICAibm9ybWFsIiwKICAgICAgICAgICJzdCIsCiAgICAgICAgICAidGFuZ2VudCIsCiAgICAgICAgICAiYml0YW5nZW50IiwKICAgICAgICAgIC8vIEZvciBzaGFkb3cgdm9sdW1lcwogICAgICAgICAgImV4dHJ1ZGVEaXJlY3Rpb24iLAogICAgICAgICAgLy8gRnJvbSBjb21wcmVzc2luZyB0ZXh0dXJlIGNvb3JkaW5hdGVzIGFuZCBub3JtYWxzCiAgICAgICAgICAiY29tcHJlc3NlZEF0dHJpYnV0ZXMiCiAgICAgICAgXTsKICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gZ2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICBjb25zdCBpbmRpY2VzID0ge307CiAgICAgICAgbGV0IGogPSAwOwogICAgICAgIGxldCBpOwogICAgICAgIGNvbnN0IGxlbiA9IHNlbWFudGljcy5sZW5ndGg7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgICBjb25zdCBzZW1hbnRpYyA9IHNlbWFudGljc1tpXTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlc1tzZW1hbnRpY10pKSB7CiAgICAgICAgICAgIGluZGljZXNbc2VtYW50aWNdID0gaisrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IG5hbWUgaW4gYXR0cmlidXRlcykgewogICAgICAgICAgaWYgKGF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkobmFtZSkgJiYgIWRlZmluZWRfZGVmYXVsdChpbmRpY2VzW25hbWVdKSkgewogICAgICAgICAgICBpbmRpY2VzW25hbWVdID0gaisrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gaW5kaWNlczsKICAgICAgfTsKICAgICAgR2VvbWV0cnlQaXBlbGluZS5yZW9yZGVyRm9yUHJlVmVydGV4Q2FjaGUgPSBmdW5jdGlvbihnZW9tZXRyeSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBudW1WZXJ0aWNlcyA9IEdlb21ldHJ5X2RlZmF1bHQuY29tcHV0ZU51bWJlck9mVmVydGljZXMoZ2VvbWV0cnkpOwogICAgICAgIGNvbnN0IGluZGljZXMgPSBnZW9tZXRyeS5pbmRpY2VzOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW5kaWNlcykpIHsKICAgICAgICAgIGNvbnN0IGluZGV4Q3Jvc3NSZWZlcmVuY2VPbGRUb05ldyA9IG5ldyBJbnQzMkFycmF5KG51bVZlcnRpY2VzKTsKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtVmVydGljZXM7IGkrKykgewogICAgICAgICAgICBpbmRleENyb3NzUmVmZXJlbmNlT2xkVG9OZXdbaV0gPSAtMTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGluZGljZXNJbiA9IGluZGljZXM7CiAgICAgICAgICBjb25zdCBudW1JbmRpY2VzID0gaW5kaWNlc0luLmxlbmd0aDsKICAgICAgICAgIGNvbnN0IGluZGljZXNPdXQgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShudW1WZXJ0aWNlcywgbnVtSW5kaWNlcyk7CiAgICAgICAgICBsZXQgaW50b0luZGljZXNJbiA9IDA7CiAgICAgICAgICBsZXQgaW50b0luZGljZXNPdXQgPSAwOwogICAgICAgICAgbGV0IG5leHRJbmRleCA9IDA7CiAgICAgICAgICBsZXQgdGVtcEluZGV4OwogICAgICAgICAgd2hpbGUgKGludG9JbmRpY2VzSW4gPCBudW1JbmRpY2VzKSB7CiAgICAgICAgICAgIHRlbXBJbmRleCA9IGluZGV4Q3Jvc3NSZWZlcmVuY2VPbGRUb05ld1tpbmRpY2VzSW5baW50b0luZGljZXNJbl1dOwogICAgICAgICAgICBpZiAodGVtcEluZGV4ICE9PSAtMSkgewogICAgICAgICAgICAgIGluZGljZXNPdXRbaW50b0luZGljZXNPdXRdID0gdGVtcEluZGV4OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRlbXBJbmRleCA9IGluZGljZXNJbltpbnRvSW5kaWNlc0luXTsKICAgICAgICAgICAgICBpbmRleENyb3NzUmVmZXJlbmNlT2xkVG9OZXdbdGVtcEluZGV4XSA9IG5leHRJbmRleDsKICAgICAgICAgICAgICBpbmRpY2VzT3V0W2ludG9JbmRpY2VzT3V0XSA9IG5leHRJbmRleDsKICAgICAgICAgICAgICArK25leHRJbmRleDsKICAgICAgICAgICAgfQogICAgICAgICAgICArK2ludG9JbmRpY2VzSW47CiAgICAgICAgICAgICsraW50b0luZGljZXNPdXQ7CiAgICAgICAgICB9CiAgICAgICAgICBnZW9tZXRyeS5pbmRpY2VzID0gaW5kaWNlc091dDsKICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgICAgICAgZm9yIChjb25zdCBwcm9wZXJ0eSBpbiBhdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgIGlmIChhdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KHByb3BlcnR5KSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlc1twcm9wZXJ0eV0pICYmIGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzW3Byb3BlcnR5XS52YWx1ZXMpKSB7CiAgICAgICAgICAgICAgY29uc3QgYXR0cmlidXRlID0gYXR0cmlidXRlc1twcm9wZXJ0eV07CiAgICAgICAgICAgICAgY29uc3QgZWxlbWVudHNJbiA9IGF0dHJpYnV0ZS52YWx1ZXM7CiAgICAgICAgICAgICAgbGV0IGludG9FbGVtZW50c0luID0gMDsKICAgICAgICAgICAgICBjb25zdCBudW1Db21wb25lbnRzID0gYXR0cmlidXRlLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGU7CiAgICAgICAgICAgICAgY29uc3QgZWxlbWVudHNPdXQgPSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgICAgICAgICAgICBhdHRyaWJ1dGUuY29tcG9uZW50RGF0YXR5cGUsCiAgICAgICAgICAgICAgICBuZXh0SW5kZXggKiBudW1Db21wb25lbnRzCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB3aGlsZSAoaW50b0VsZW1lbnRzSW4gPCBudW1WZXJ0aWNlcykgewogICAgICAgICAgICAgICAgY29uc3QgdGVtcCA9IGluZGV4Q3Jvc3NSZWZlcmVuY2VPbGRUb05ld1tpbnRvRWxlbWVudHNJbl07CiAgICAgICAgICAgICAgICBpZiAodGVtcCAhPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBudW1Db21wb25lbnRzOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50c091dFtudW1Db21wb25lbnRzICogdGVtcCArIGpdID0gZWxlbWVudHNJbltudW1Db21wb25lbnRzICogaW50b0VsZW1lbnRzSW4gKyBqXTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgKytpbnRvRWxlbWVudHNJbjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYXR0cmlidXRlLnZhbHVlcyA9IGVsZW1lbnRzT3V0OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBnZW9tZXRyeTsKICAgICAgfTsKICAgICAgR2VvbWV0cnlQaXBlbGluZS5yZW9yZGVyRm9yUG9zdFZlcnRleENhY2hlID0gZnVuY3Rpb24oZ2VvbWV0cnksIGNhY2hlQ2FwYWNpdHkpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJnZW9tZXRyeSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgaW5kaWNlcyA9IGdlb21ldHJ5LmluZGljZXM7CiAgICAgICAgaWYgKGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMgJiYgZGVmaW5lZF9kZWZhdWx0KGluZGljZXMpKSB7CiAgICAgICAgICBjb25zdCBudW1JbmRpY2VzID0gaW5kaWNlcy5sZW5ndGg7CiAgICAgICAgICBsZXQgbWF4aW11bUluZGV4ID0gMDsKICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbnVtSW5kaWNlczsgaisrKSB7CiAgICAgICAgICAgIGlmIChpbmRpY2VzW2pdID4gbWF4aW11bUluZGV4KSB7CiAgICAgICAgICAgICAgbWF4aW11bUluZGV4ID0gaW5kaWNlc1tqXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcyA9IFRpcHNpZnlfZGVmYXVsdC50aXBzaWZ5KHsKICAgICAgICAgICAgaW5kaWNlcywKICAgICAgICAgICAgbWF4aW11bUluZGV4LAogICAgICAgICAgICBjYWNoZVNpemU6IGNhY2hlQ2FwYWNpdHkKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgIH07CiAgICAgIEdlb21ldHJ5UGlwZWxpbmUuZml0VG9VbnNpZ25lZFNob3J0SW5kaWNlcyA9IGZ1bmN0aW9uKGdlb21ldHJ5KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZ2VvbWV0cnkgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkuaW5kaWNlcykgJiYgZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSAhPT0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUyAmJiBnZW9tZXRyeS5wcmltaXRpdmVUeXBlICE9PSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMgJiYgZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSAhPT0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlBPSU5UUykgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJnZW9tZXRyeS5wcmltaXRpdmVUeXBlIG11c3QgZXF1YWwgdG8gUHJpbWl0aXZlVHlwZS5UUklBTkdMRVMsIFByaW1pdGl2ZVR5cGUuTElORVMsIG9yIFByaW1pdGl2ZVR5cGUuUE9JTlRTLiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGdlb21ldHJpZXMgPSBbXTsKICAgICAgICBjb25zdCBudW1iZXJPZlZlcnRpY2VzID0gR2VvbWV0cnlfZGVmYXVsdC5jb21wdXRlTnVtYmVyT2ZWZXJ0aWNlcyhnZW9tZXRyeSk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5pbmRpY2VzKSAmJiBudW1iZXJPZlZlcnRpY2VzID49IE1hdGhfZGVmYXVsdC5TSVhUWV9GT1VSX0tJTE9CWVRFUykgewogICAgICAgICAgbGV0IG9sZFRvTmV3SW5kZXggPSBbXTsKICAgICAgICAgIGxldCBuZXdJbmRpY2VzID0gW107CiAgICAgICAgICBsZXQgY3VycmVudEluZGV4ID0gMDsKICAgICAgICAgIGxldCBuZXdBdHRyaWJ1dGVzID0gY29weUF0dHJpYnV0ZXNEZXNjcmlwdGlvbnMoZ2VvbWV0cnkuYXR0cmlidXRlcyk7CiAgICAgICAgICBjb25zdCBvcmlnaW5hbEluZGljZXMgPSBnZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgY29uc3QgbnVtYmVyT2ZJbmRpY2VzID0gb3JpZ2luYWxJbmRpY2VzLmxlbmd0aDsKICAgICAgICAgIGxldCBpbmRpY2VzUGVyUHJpbWl0aXZlOwogICAgICAgICAgaWYgKGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMpIHsKICAgICAgICAgICAgaW5kaWNlc1BlclByaW1pdGl2ZSA9IDM7CiAgICAgICAgICB9IGVsc2UgaWYgKGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUykgewogICAgICAgICAgICBpbmRpY2VzUGVyUHJpbWl0aXZlID0gMjsKICAgICAgICAgIH0gZWxzZSBpZiAoZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSA9PT0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlBPSU5UUykgewogICAgICAgICAgICBpbmRpY2VzUGVyUHJpbWl0aXZlID0gMTsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbnVtYmVyT2ZJbmRpY2VzOyBqICs9IGluZGljZXNQZXJQcmltaXRpdmUpIHsKICAgICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBpbmRpY2VzUGVyUHJpbWl0aXZlOyArK2spIHsKICAgICAgICAgICAgICBjb25zdCB4ID0gb3JpZ2luYWxJbmRpY2VzW2ogKyBrXTsKICAgICAgICAgICAgICBsZXQgaSA9IG9sZFRvTmV3SW5kZXhbeF07CiAgICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaSkpIHsKICAgICAgICAgICAgICAgIGkgPSBjdXJyZW50SW5kZXgrKzsKICAgICAgICAgICAgICAgIG9sZFRvTmV3SW5kZXhbeF0gPSBpOwogICAgICAgICAgICAgICAgY29weVZlcnRleChuZXdBdHRyaWJ1dGVzLCBnZW9tZXRyeS5hdHRyaWJ1dGVzLCB4KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbmV3SW5kaWNlcy5wdXNoKGkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjdXJyZW50SW5kZXggKyBpbmRpY2VzUGVyUHJpbWl0aXZlID49IE1hdGhfZGVmYXVsdC5TSVhUWV9GT1VSX0tJTE9CWVRFUykgewogICAgICAgICAgICAgIGdlb21ldHJpZXMucHVzaCgKICAgICAgICAgICAgICAgIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgICAgICAgICAgYXR0cmlidXRlczogbmV3QXR0cmlidXRlcywKICAgICAgICAgICAgICAgICAgaW5kaWNlczogbmV3SW5kaWNlcywKICAgICAgICAgICAgICAgICAgcHJpbWl0aXZlVHlwZTogZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSwKICAgICAgICAgICAgICAgICAgYm91bmRpbmdTcGhlcmU6IGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlLAogICAgICAgICAgICAgICAgICBib3VuZGluZ1NwaGVyZUNWOiBnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZUNWCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgb2xkVG9OZXdJbmRleCA9IFtdOwogICAgICAgICAgICAgIG5ld0luZGljZXMgPSBbXTsKICAgICAgICAgICAgICBjdXJyZW50SW5kZXggPSAwOwogICAgICAgICAgICAgIG5ld0F0dHJpYnV0ZXMgPSBjb3B5QXR0cmlidXRlc0Rlc2NyaXB0aW9ucyhnZW9tZXRyeS5hdHRyaWJ1dGVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKG5ld0luZGljZXMubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgIGdlb21ldHJpZXMucHVzaCgKICAgICAgICAgICAgICBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzOiBuZXdBdHRyaWJ1dGVzLAogICAgICAgICAgICAgICAgaW5kaWNlczogbmV3SW5kaWNlcywKICAgICAgICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUsCiAgICAgICAgICAgICAgICBib3VuZGluZ1NwaGVyZTogZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmUsCiAgICAgICAgICAgICAgICBib3VuZGluZ1NwaGVyZUNWOiBnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZUNWCiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZ2VvbWV0cmllcy5wdXNoKGdlb21ldHJ5KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGdlb21ldHJpZXM7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hQcm9qZWN0VG8yRENhcnRlc2lhbjMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQcm9qZWN0VG8yRENhcnRvZ3JhcGhpYyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBHZW9tZXRyeVBpcGVsaW5lLnByb2plY3RUbzJEID0gZnVuY3Rpb24oZ2VvbWV0cnksIGF0dHJpYnV0ZU5hbWUsIGF0dHJpYnV0ZU5hbWUzRCwgYXR0cmlidXRlTmFtZTJELCBwcm9qZWN0aW9uKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZ2VvbWV0cnkgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXR0cmlidXRlTmFtZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlTmFtZTNEKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImF0dHJpYnV0ZU5hbWUzRCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlTmFtZTJEKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImF0dHJpYnV0ZU5hbWUyRCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkuYXR0cmlidXRlc1thdHRyaWJ1dGVOYW1lXSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICBgZ2VvbWV0cnkgbXVzdCBoYXZlIGF0dHJpYnV0ZSBtYXRjaGluZyB0aGUgYXR0cmlidXRlTmFtZSBhcmd1bWVudDogJHthdHRyaWJ1dGVOYW1lfS5gCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoZ2VvbWV0cnkuYXR0cmlidXRlc1thdHRyaWJ1dGVOYW1lXS5jb21wb25lbnREYXRhdHlwZSAhPT0gQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiVGhlIGF0dHJpYnV0ZSBjb21wb25lbnREYXRhdHlwZSBtdXN0IGJlIENvbXBvbmVudERhdGF0eXBlLkRPVUJMRS4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGUgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdOwogICAgICAgIHByb2plY3Rpb24gPSBkZWZpbmVkX2RlZmF1bHQocHJvamVjdGlvbikgPyBwcm9qZWN0aW9uIDogbmV3IEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQoKTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBwcm9qZWN0aW9uLmVsbGlwc29pZDsKICAgICAgICBjb25zdCB2YWx1ZXMzRCA9IGF0dHJpYnV0ZS52YWx1ZXM7CiAgICAgICAgY29uc3QgcHJvamVjdGVkVmFsdWVzID0gbmV3IEZsb2F0NjRBcnJheSh2YWx1ZXMzRC5sZW5ndGgpOwogICAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2YWx1ZXMzRC5sZW5ndGg7IGkgKz0gMykgewogICAgICAgICAgY29uc3QgdmFsdWUgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICB2YWx1ZXMzRCwKICAgICAgICAgICAgaSwKICAgICAgICAgICAgc2NyYXRjaFByb2plY3RUbzJEQ2FydGVzaWFuMwogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IGxvbkxhdCA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgIHNjcmF0Y2hQcm9qZWN0VG8yRENhcnRvZ3JhcGhpYwogICAgICAgICAgKTsKICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGxvbkxhdCkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICAgYENvdWxkIG5vdCBwcm9qZWN0IHBvaW50ICgke3ZhbHVlLnh9LCAke3ZhbHVlLnl9LCAke3ZhbHVlLnp9KSB0byAyRC5gCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBwcm9qZWN0ZWRMb25MYXQgPSBwcm9qZWN0aW9uLnByb2plY3QoCiAgICAgICAgICAgIGxvbkxhdCwKICAgICAgICAgICAgc2NyYXRjaFByb2plY3RUbzJEQ2FydGVzaWFuMwogICAgICAgICAgKTsKICAgICAgICAgIHByb2plY3RlZFZhbHVlc1tpbmRleCsrXSA9IHByb2plY3RlZExvbkxhdC54OwogICAgICAgICAgcHJvamVjdGVkVmFsdWVzW2luZGV4KytdID0gcHJvamVjdGVkTG9uTGF0Lnk7CiAgICAgICAgICBwcm9qZWN0ZWRWYWx1ZXNbaW5kZXgrK10gPSBwcm9qZWN0ZWRMb25MYXQuejsKICAgICAgICB9CiAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlc1thdHRyaWJ1dGVOYW1lM0RdID0gYXR0cmlidXRlOwogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZTJEXSA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICB2YWx1ZXM6IHByb2plY3RlZFZhbHVlcwogICAgICAgIH0pOwogICAgICAgIGRlbGV0ZSBnZW9tZXRyeS5hdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdOwogICAgICAgIHJldHVybiBnZW9tZXRyeTsKICAgICAgfTsKICAgICAgZW5jb2RlZFJlc3VsdCA9IHsKICAgICAgICBoaWdoOiAwLAogICAgICAgIGxvdzogMAogICAgICB9OwogICAgICBHZW9tZXRyeVBpcGVsaW5lLmVuY29kZUF0dHJpYnV0ZSA9IGZ1bmN0aW9uKGdlb21ldHJ5LCBhdHRyaWJ1dGVOYW1lLCBhdHRyaWJ1dGVIaWdoTmFtZSwgYXR0cmlidXRlTG93TmFtZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImF0dHJpYnV0ZU5hbWUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZUhpZ2hOYW1lKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImF0dHJpYnV0ZUhpZ2hOYW1lIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVMb3dOYW1lKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImF0dHJpYnV0ZUxvd05hbWUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgYGdlb21ldHJ5IG11c3QgaGF2ZSBhdHRyaWJ1dGUgbWF0Y2hpbmcgdGhlIGF0dHJpYnV0ZU5hbWUgYXJndW1lbnQ6ICR7YXR0cmlidXRlTmFtZX0uYAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaWYgKGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV0uY29tcG9uZW50RGF0YXR5cGUgIT09IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIlRoZSBhdHRyaWJ1dGUgY29tcG9uZW50RGF0YXR5cGUgbXVzdCBiZSBDb21wb25lbnREYXRhdHlwZS5ET1VCTEUuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlID0gZ2VvbWV0cnkuYXR0cmlidXRlc1thdHRyaWJ1dGVOYW1lXTsKICAgICAgICBjb25zdCB2YWx1ZXMgPSBhdHRyaWJ1dGUudmFsdWVzOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHZhbHVlcy5sZW5ndGg7CiAgICAgICAgY29uc3QgaGlnaFZhbHVlcyA9IG5ldyBGbG9hdDMyQXJyYXkobGVuZ3RoKTsKICAgICAgICBjb25zdCBsb3dWYWx1ZXMgPSBuZXcgRmxvYXQzMkFycmF5KGxlbmd0aCk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgRW5jb2RlZENhcnRlc2lhbjNfZGVmYXVsdC5lbmNvZGUodmFsdWVzW2ldLCBlbmNvZGVkUmVzdWx0KTsKICAgICAgICAgIGhpZ2hWYWx1ZXNbaV0gPSBlbmNvZGVkUmVzdWx0LmhpZ2g7CiAgICAgICAgICBsb3dWYWx1ZXNbaV0gPSBlbmNvZGVkUmVzdWx0LmxvdzsKICAgICAgICB9CiAgICAgICAgY29uc3QgY29tcG9uZW50c1BlckF0dHJpYnV0ZSA9IGF0dHJpYnV0ZS5jb21wb25lbnRzUGVyQXR0cmlidXRlOwogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlSGlnaE5hbWVdID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlLAogICAgICAgICAgdmFsdWVzOiBoaWdoVmFsdWVzCiAgICAgICAgfSk7CiAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlc1thdHRyaWJ1dGVMb3dOYW1lXSA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZSwKICAgICAgICAgIHZhbHVlczogbG93VmFsdWVzCiAgICAgICAgfSk7CiAgICAgICAgZGVsZXRlIGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV07CiAgICAgICAgcmV0dXJuIGdlb21ldHJ5OwogICAgICB9OwogICAgICBzY3JhdGNoQ2FydGVzaWFuMzMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGludmVyc2VUcmFuc3Bvc2UgPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIG5vcm1hbE1hdHJpeCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgR2VvbWV0cnlQaXBlbGluZS50cmFuc2Zvcm1Ub1dvcmxkQ29vcmRpbmF0ZXMgPSBmdW5jdGlvbihpbnN0YW5jZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGluc3RhbmNlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImluc3RhbmNlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBtb2RlbE1hdHJpeCA9IGluc3RhbmNlLm1vZGVsTWF0cml4OwogICAgICAgIGlmIChNYXRyaXg0X2RlZmF1bHQuZXF1YWxzKG1vZGVsTWF0cml4LCBNYXRyaXg0X2RlZmF1bHQuSURFTlRJVFkpKSB7CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBpbnN0YW5jZS5nZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgICAgIHRyYW5zZm9ybVBvaW50KG1vZGVsTWF0cml4LCBhdHRyaWJ1dGVzLnBvc2l0aW9uKTsKICAgICAgICB0cmFuc2Zvcm1Qb2ludChtb2RlbE1hdHJpeCwgYXR0cmlidXRlcy5wcmV2UG9zaXRpb24pOwogICAgICAgIHRyYW5zZm9ybVBvaW50KG1vZGVsTWF0cml4LCBhdHRyaWJ1dGVzLm5leHRQb3NpdGlvbik7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLm5vcm1hbCkgfHwgZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXMudGFuZ2VudCkgfHwgZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXMuYml0YW5nZW50KSkgewogICAgICAgICAgTWF0cml4NF9kZWZhdWx0LmludmVyc2UobW9kZWxNYXRyaXgsIGludmVyc2VUcmFuc3Bvc2UpOwogICAgICAgICAgTWF0cml4NF9kZWZhdWx0LnRyYW5zcG9zZShpbnZlcnNlVHJhbnNwb3NlLCBpbnZlcnNlVHJhbnNwb3NlKTsKICAgICAgICAgIE1hdHJpeDRfZGVmYXVsdC5nZXRNYXRyaXgzKGludmVyc2VUcmFuc3Bvc2UsIG5vcm1hbE1hdHJpeCk7CiAgICAgICAgICB0cmFuc2Zvcm1WZWN0b3Iobm9ybWFsTWF0cml4LCBhdHRyaWJ1dGVzLm5vcm1hbCk7CiAgICAgICAgICB0cmFuc2Zvcm1WZWN0b3Iobm9ybWFsTWF0cml4LCBhdHRyaWJ1dGVzLnRhbmdlbnQpOwogICAgICAgICAgdHJhbnNmb3JtVmVjdG9yKG5vcm1hbE1hdHJpeCwgYXR0cmlidXRlcy5iaXRhbmdlbnQpOwogICAgICAgIH0KICAgICAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IGluc3RhbmNlLmdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYm91bmRpbmdTcGhlcmUpKSB7CiAgICAgICAgICBpbnN0YW5jZS5nZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQudHJhbnNmb3JtKAogICAgICAgICAgICBib3VuZGluZ1NwaGVyZSwKICAgICAgICAgICAgbW9kZWxNYXRyaXgsCiAgICAgICAgICAgIGJvdW5kaW5nU3BoZXJlCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpbnN0YW5jZS5tb2RlbE1hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC5jbG9uZShNYXRyaXg0X2RlZmF1bHQuSURFTlRJVFkpOwogICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgfTsKICAgICAgdGVtcFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEdlb21ldHJ5UGlwZWxpbmUuY29tYmluZUluc3RhbmNlcyA9IGZ1bmN0aW9uKGluc3RhbmNlcykgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGluc3RhbmNlcykgfHwgaW5zdGFuY2VzLmxlbmd0aCA8IDEpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiaW5zdGFuY2VzIGlzIHJlcXVpcmVkIGFuZCBtdXN0IGhhdmUgbGVuZ3RoIGdyZWF0ZXIgdGhhbiB6ZXJvLiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGluc3RhbmNlR2VvbWV0cnkgPSBbXTsKICAgICAgICBjb25zdCBpbnN0YW5jZVNwbGl0R2VvbWV0cnkgPSBbXTsKICAgICAgICBjb25zdCBsZW5ndGggPSBpbnN0YW5jZXMubGVuZ3RoOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGNvbnN0IGluc3RhbmNlID0gaW5zdGFuY2VzW2ldOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZS5nZW9tZXRyeSkpIHsKICAgICAgICAgICAgaW5zdGFuY2VHZW9tZXRyeS5wdXNoKGluc3RhbmNlKTsKICAgICAgICAgIH0gZWxzZSBpZiAoZGVmaW5lZF9kZWZhdWx0KGluc3RhbmNlLndlc3RIZW1pc3BoZXJlR2VvbWV0cnkpICYmIGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZS5lYXN0SGVtaXNwaGVyZUdlb21ldHJ5KSkgewogICAgICAgICAgICBpbnN0YW5jZVNwbGl0R2VvbWV0cnkucHVzaChpbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGdlb21ldHJpZXMgPSBbXTsKICAgICAgICBpZiAoaW5zdGFuY2VHZW9tZXRyeS5sZW5ndGggPiAwKSB7CiAgICAgICAgICBnZW9tZXRyaWVzLnB1c2goY29tYmluZUdlb21ldHJpZXMoaW5zdGFuY2VHZW9tZXRyeSwgImdlb21ldHJ5IikpOwogICAgICAgIH0KICAgICAgICBpZiAoaW5zdGFuY2VTcGxpdEdlb21ldHJ5Lmxlbmd0aCA+IDApIHsKICAgICAgICAgIGdlb21ldHJpZXMucHVzaCgKICAgICAgICAgICAgY29tYmluZUdlb21ldHJpZXMoaW5zdGFuY2VTcGxpdEdlb21ldHJ5LCAid2VzdEhlbWlzcGhlcmVHZW9tZXRyeSIpCiAgICAgICAgICApOwogICAgICAgICAgZ2VvbWV0cmllcy5wdXNoKAogICAgICAgICAgICBjb21iaW5lR2VvbWV0cmllcyhpbnN0YW5jZVNwbGl0R2VvbWV0cnksICJlYXN0SGVtaXNwaGVyZUdlb21ldHJ5IikKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBnZW9tZXRyaWVzOwogICAgICB9OwogICAgICBub3JtYWwgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHYwID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB2MSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEdlb21ldHJ5UGlwZWxpbmUuY29tcHV0ZU5vcm1hbCA9IGZ1bmN0aW9uKGdlb21ldHJ5KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZ2VvbWV0cnkgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24pIHx8ICFkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgImdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzIGlzIHJlcXVpcmVkLiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmluZGljZXMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZ2VvbWV0cnkuaW5kaWNlcyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKGdlb21ldHJ5LmluZGljZXMubGVuZ3RoIDwgMiB8fCBnZW9tZXRyeS5pbmRpY2VzLmxlbmd0aCAlIDMgIT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiZ2VvbWV0cnkuaW5kaWNlcyBsZW5ndGggbXVzdCBiZSBncmVhdGVyIHRoYW4gMCBhbmQgYmUgYSBtdWx0aXBsZSBvZiAzLiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChnZW9tZXRyeS5wcmltaXRpdmVUeXBlICE9PSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgImdlb21ldHJ5LnByaW1pdGl2ZVR5cGUgbXVzdCBiZSBQcmltaXRpdmVUeXBlLlRSSUFOR0xFUy4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbmRpY2VzID0gZ2VvbWV0cnkuaW5kaWNlczsKICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gZ2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICBjb25zdCB2ZXJ0aWNlcyA9IGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgICAgIGNvbnN0IG51bVZlcnRpY2VzID0gYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoIC8gMzsKICAgICAgICBjb25zdCBudW1JbmRpY2VzID0gaW5kaWNlcy5sZW5ndGg7CiAgICAgICAgY29uc3Qgbm9ybWFsc1BlclZlcnRleCA9IG5ldyBBcnJheShudW1WZXJ0aWNlcyk7CiAgICAgICAgY29uc3Qgbm9ybWFsc1BlclRyaWFuZ2xlID0gbmV3IEFycmF5KG51bUluZGljZXMgLyAzKTsKICAgICAgICBjb25zdCBub3JtYWxJbmRpY2VzID0gbmV3IEFycmF5KG51bUluZGljZXMpOwogICAgICAgIGxldCBpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1WZXJ0aWNlczsgaSsrKSB7CiAgICAgICAgICBub3JtYWxzUGVyVmVydGV4W2ldID0gewogICAgICAgICAgICBpbmRleE9mZnNldDogMCwKICAgICAgICAgICAgY291bnQ6IDAsCiAgICAgICAgICAgIGN1cnJlbnRDb3VudDogMAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgbGV0IGogPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1JbmRpY2VzOyBpICs9IDMpIHsKICAgICAgICAgIGNvbnN0IGkwID0gaW5kaWNlc1tpXTsKICAgICAgICAgIGNvbnN0IGkxID0gaW5kaWNlc1tpICsgMV07CiAgICAgICAgICBjb25zdCBpMiA9IGluZGljZXNbaSArIDJdOwogICAgICAgICAgY29uc3QgaTAzID0gaTAgKiAzOwogICAgICAgICAgY29uc3QgaTEzID0gaTEgKiAzOwogICAgICAgICAgY29uc3QgaTIzID0gaTIgKiAzOwogICAgICAgICAgdjAueCA9IHZlcnRpY2VzW2kwM107CiAgICAgICAgICB2MC55ID0gdmVydGljZXNbaTAzICsgMV07CiAgICAgICAgICB2MC56ID0gdmVydGljZXNbaTAzICsgMl07CiAgICAgICAgICB2MS54ID0gdmVydGljZXNbaTEzXTsKICAgICAgICAgIHYxLnkgPSB2ZXJ0aWNlc1tpMTMgKyAxXTsKICAgICAgICAgIHYxLnogPSB2ZXJ0aWNlc1tpMTMgKyAyXTsKICAgICAgICAgIHYyLnggPSB2ZXJ0aWNlc1tpMjNdOwogICAgICAgICAgdjIueSA9IHZlcnRpY2VzW2kyMyArIDFdOwogICAgICAgICAgdjIueiA9IHZlcnRpY2VzW2kyMyArIDJdOwogICAgICAgICAgbm9ybWFsc1BlclZlcnRleFtpMF0uY291bnQrKzsKICAgICAgICAgIG5vcm1hbHNQZXJWZXJ0ZXhbaTFdLmNvdW50Kys7CiAgICAgICAgICBub3JtYWxzUGVyVmVydGV4W2kyXS5jb3VudCsrOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHYxLCB2MCwgdjEpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHYyLCB2MCwgdjIpOwogICAgICAgICAgbm9ybWFsc1BlclRyaWFuZ2xlW2pdID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHYxLCB2MiwgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpKTsKICAgICAgICAgIGorKzsKICAgICAgICB9CiAgICAgICAgbGV0IGluZGV4T2Zmc2V0ID0gMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtVmVydGljZXM7IGkrKykgewogICAgICAgICAgbm9ybWFsc1BlclZlcnRleFtpXS5pbmRleE9mZnNldCArPSBpbmRleE9mZnNldDsKICAgICAgICAgIGluZGV4T2Zmc2V0ICs9IG5vcm1hbHNQZXJWZXJ0ZXhbaV0uY291bnQ7CiAgICAgICAgfQogICAgICAgIGogPSAwOwogICAgICAgIGxldCB2ZXJ0ZXhOb3JtYWxEYXRhOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1JbmRpY2VzOyBpICs9IDMpIHsKICAgICAgICAgIHZlcnRleE5vcm1hbERhdGEgPSBub3JtYWxzUGVyVmVydGV4W2luZGljZXNbaV1dOwogICAgICAgICAgbGV0IGluZGV4ID0gdmVydGV4Tm9ybWFsRGF0YS5pbmRleE9mZnNldCArIHZlcnRleE5vcm1hbERhdGEuY3VycmVudENvdW50OwogICAgICAgICAgbm9ybWFsSW5kaWNlc1tpbmRleF0gPSBqOwogICAgICAgICAgdmVydGV4Tm9ybWFsRGF0YS5jdXJyZW50Q291bnQrKzsKICAgICAgICAgIHZlcnRleE5vcm1hbERhdGEgPSBub3JtYWxzUGVyVmVydGV4W2luZGljZXNbaSArIDFdXTsKICAgICAgICAgIGluZGV4ID0gdmVydGV4Tm9ybWFsRGF0YS5pbmRleE9mZnNldCArIHZlcnRleE5vcm1hbERhdGEuY3VycmVudENvdW50OwogICAgICAgICAgbm9ybWFsSW5kaWNlc1tpbmRleF0gPSBqOwogICAgICAgICAgdmVydGV4Tm9ybWFsRGF0YS5jdXJyZW50Q291bnQrKzsKICAgICAgICAgIHZlcnRleE5vcm1hbERhdGEgPSBub3JtYWxzUGVyVmVydGV4W2luZGljZXNbaSArIDJdXTsKICAgICAgICAgIGluZGV4ID0gdmVydGV4Tm9ybWFsRGF0YS5pbmRleE9mZnNldCArIHZlcnRleE5vcm1hbERhdGEuY3VycmVudENvdW50OwogICAgICAgICAgbm9ybWFsSW5kaWNlc1tpbmRleF0gPSBqOwogICAgICAgICAgdmVydGV4Tm9ybWFsRGF0YS5jdXJyZW50Q291bnQrKzsKICAgICAgICAgIGorKzsKICAgICAgICB9CiAgICAgICAgY29uc3Qgbm9ybWFsVmFsdWVzID0gbmV3IEZsb2F0MzJBcnJheShudW1WZXJ0aWNlcyAqIDMpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1WZXJ0aWNlczsgaSsrKSB7CiAgICAgICAgICBjb25zdCBpMyA9IGkgKiAzOwogICAgICAgICAgdmVydGV4Tm9ybWFsRGF0YSA9IG5vcm1hbHNQZXJWZXJ0ZXhbaV07CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIG5vcm1hbCk7CiAgICAgICAgICBpZiAodmVydGV4Tm9ybWFsRGF0YS5jb3VudCA+IDApIHsKICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IHZlcnRleE5vcm1hbERhdGEuY291bnQ7IGorKykgewogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICAgICAgICBub3JtYWwsCiAgICAgICAgICAgICAgICBub3JtYWxzUGVyVHJpYW5nbGVbbm9ybWFsSW5kaWNlc1t2ZXJ0ZXhOb3JtYWxEYXRhLmluZGV4T2Zmc2V0ICsgal1dLAogICAgICAgICAgICAgICAgbm9ybWFsCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24oQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIG5vcm1hbCwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMCkpIHsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoCiAgICAgICAgICAgICAgICBub3JtYWxzUGVyVHJpYW5nbGVbbm9ybWFsSW5kaWNlc1t2ZXJ0ZXhOb3JtYWxEYXRhLmluZGV4T2Zmc2V0XV0sCiAgICAgICAgICAgICAgICBub3JtYWwKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24oQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIG5vcm1hbCwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMCkpIHsKICAgICAgICAgICAgbm9ybWFsLnogPSAxOwogICAgICAgICAgfQogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShub3JtYWwsIG5vcm1hbCk7CiAgICAgICAgICBub3JtYWxWYWx1ZXNbaTNdID0gbm9ybWFsLng7CiAgICAgICAgICBub3JtYWxWYWx1ZXNbaTMgKyAxXSA9IG5vcm1hbC55OwogICAgICAgICAgbm9ybWFsVmFsdWVzW2kzICsgMl0gPSBub3JtYWwuejsKICAgICAgICB9CiAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5ub3JtYWwgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICB2YWx1ZXM6IG5vcm1hbFZhbHVlcwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBnZW9tZXRyeTsKICAgICAgfTsKICAgICAgbm9ybWFsU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIG5vcm1hbFNjYWxlID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB0U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgR2VvbWV0cnlQaXBlbGluZS5jb21wdXRlVGFuZ2VudEFuZEJpdGFuZ2VudCA9IGZ1bmN0aW9uKGdlb21ldHJ5KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZ2VvbWV0cnkgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgICAgIGNvbnN0IGluZGljZXMgPSBnZW9tZXRyeS5pbmRpY2VzOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXMucG9zaXRpb24pIHx8ICFkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgImdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzIGlzIHJlcXVpcmVkLiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXMubm9ybWFsKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXMubm9ybWFsLnZhbHVlcykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJnZW9tZXRyeS5hdHRyaWJ1dGVzLm5vcm1hbC52YWx1ZXMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXMuc3QpIHx8ICFkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlcy5zdC52YWx1ZXMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZ2VvbWV0cnkuYXR0cmlidXRlcy5zdC52YWx1ZXMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGluZGljZXMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZ2VvbWV0cnkuaW5kaWNlcyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKGluZGljZXMubGVuZ3RoIDwgMiB8fCBpbmRpY2VzLmxlbmd0aCAlIDMgIT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiZ2VvbWV0cnkuaW5kaWNlcyBsZW5ndGggbXVzdCBiZSBncmVhdGVyIHRoYW4gMCBhbmQgYmUgYSBtdWx0aXBsZSBvZiAzLiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChnZW9tZXRyeS5wcmltaXRpdmVUeXBlICE9PSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgImdlb21ldHJ5LnByaW1pdGl2ZVR5cGUgbXVzdCBiZSBQcmltaXRpdmVUeXBlLlRSSUFOR0xFUy4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCB2ZXJ0aWNlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgICAgIGNvbnN0IG5vcm1hbHMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLm5vcm1hbC52YWx1ZXM7CiAgICAgICAgY29uc3Qgc3QgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnN0LnZhbHVlczsKICAgICAgICBjb25zdCBudW1WZXJ0aWNlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aCAvIDM7CiAgICAgICAgY29uc3QgbnVtSW5kaWNlcyA9IGluZGljZXMubGVuZ3RoOwogICAgICAgIGNvbnN0IHRhbjEgPSBuZXcgQXJyYXkobnVtVmVydGljZXMgKiAzKTsKICAgICAgICBsZXQgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGFuMS5sZW5ndGg7IGkrKykgewogICAgICAgICAgdGFuMVtpXSA9IDA7CiAgICAgICAgfQogICAgICAgIGxldCBpMDM7CiAgICAgICAgbGV0IGkxMzsKICAgICAgICBsZXQgaTIzOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1JbmRpY2VzOyBpICs9IDMpIHsKICAgICAgICAgIGNvbnN0IGkwID0gaW5kaWNlc1tpXTsKICAgICAgICAgIGNvbnN0IGkxID0gaW5kaWNlc1tpICsgMV07CiAgICAgICAgICBjb25zdCBpMiA9IGluZGljZXNbaSArIDJdOwogICAgICAgICAgaTAzID0gaTAgKiAzOwogICAgICAgICAgaTEzID0gaTEgKiAzOwogICAgICAgICAgaTIzID0gaTIgKiAzOwogICAgICAgICAgY29uc3QgaTAyID0gaTAgKiAyOwogICAgICAgICAgY29uc3QgaTEyID0gaTEgKiAyOwogICAgICAgICAgY29uc3QgaTIyID0gaTIgKiAyOwogICAgICAgICAgY29uc3QgdXggPSB2ZXJ0aWNlc1tpMDNdOwogICAgICAgICAgY29uc3QgdXkgPSB2ZXJ0aWNlc1tpMDMgKyAxXTsKICAgICAgICAgIGNvbnN0IHV6ID0gdmVydGljZXNbaTAzICsgMl07CiAgICAgICAgICBjb25zdCB3eCA9IHN0W2kwMl07CiAgICAgICAgICBjb25zdCB3eSA9IHN0W2kwMiArIDFdOwogICAgICAgICAgY29uc3QgdDEgPSBzdFtpMTIgKyAxXSAtIHd5OwogICAgICAgICAgY29uc3QgdDIgPSBzdFtpMjIgKyAxXSAtIHd5OwogICAgICAgICAgY29uc3QgciA9IDEgLyAoKHN0W2kxMl0gLSB3eCkgKiB0MiAtIChzdFtpMjJdIC0gd3gpICogdDEpOwogICAgICAgICAgY29uc3Qgc2RpcnggPSAodDIgKiAodmVydGljZXNbaTEzXSAtIHV4KSAtIHQxICogKHZlcnRpY2VzW2kyM10gLSB1eCkpICogcjsKICAgICAgICAgIGNvbnN0IHNkaXJ5ID0gKHQyICogKHZlcnRpY2VzW2kxMyArIDFdIC0gdXkpIC0gdDEgKiAodmVydGljZXNbaTIzICsgMV0gLSB1eSkpICogcjsKICAgICAgICAgIGNvbnN0IHNkaXJ6ID0gKHQyICogKHZlcnRpY2VzW2kxMyArIDJdIC0gdXopIC0gdDEgKiAodmVydGljZXNbaTIzICsgMl0gLSB1eikpICogcjsKICAgICAgICAgIHRhbjFbaTAzXSArPSBzZGlyeDsKICAgICAgICAgIHRhbjFbaTAzICsgMV0gKz0gc2Rpcnk7CiAgICAgICAgICB0YW4xW2kwMyArIDJdICs9IHNkaXJ6OwogICAgICAgICAgdGFuMVtpMTNdICs9IHNkaXJ4OwogICAgICAgICAgdGFuMVtpMTMgKyAxXSArPSBzZGlyeTsKICAgICAgICAgIHRhbjFbaTEzICsgMl0gKz0gc2Rpcno7CiAgICAgICAgICB0YW4xW2kyM10gKz0gc2Rpcng7CiAgICAgICAgICB0YW4xW2kyMyArIDFdICs9IHNkaXJ5OwogICAgICAgICAgdGFuMVtpMjMgKyAyXSArPSBzZGlyejsKICAgICAgICB9CiAgICAgICAgY29uc3QgdGFuZ2VudFZhbHVlcyA9IG5ldyBGbG9hdDMyQXJyYXkobnVtVmVydGljZXMgKiAzKTsKICAgICAgICBjb25zdCBiaXRhbmdlbnRWYWx1ZXMgPSBuZXcgRmxvYXQzMkFycmF5KG51bVZlcnRpY2VzICogMyk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IG51bVZlcnRpY2VzOyBpKyspIHsKICAgICAgICAgIGkwMyA9IGkgKiAzOwogICAgICAgICAgaTEzID0gaTAzICsgMTsKICAgICAgICAgIGkyMyA9IGkwMyArIDI7CiAgICAgICAgICBjb25zdCBuID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShub3JtYWxzLCBpMDMsIG5vcm1hbFNjcmF0Y2gyKTsKICAgICAgICAgIGNvbnN0IHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHRhbjEsIGkwMywgdFNjcmF0Y2gpOwogICAgICAgICAgY29uc3Qgc2NhbGFyID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChuLCB0KTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG4sIHNjYWxhciwgbm9ybWFsU2NhbGUpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QodCwgbm9ybWFsU2NhbGUsIHQpLCB0KTsKICAgICAgICAgIHRhbmdlbnRWYWx1ZXNbaTAzXSA9IHQueDsKICAgICAgICAgIHRhbmdlbnRWYWx1ZXNbaTEzXSA9IHQueTsKICAgICAgICAgIHRhbmdlbnRWYWx1ZXNbaTIzXSA9IHQuejsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKG4sIHQsIHQpLCB0KTsKICAgICAgICAgIGJpdGFuZ2VudFZhbHVlc1tpMDNdID0gdC54OwogICAgICAgICAgYml0YW5nZW50VmFsdWVzW2kxM10gPSB0Lnk7CiAgICAgICAgICBiaXRhbmdlbnRWYWx1ZXNbaTIzXSA9IHQuejsKICAgICAgICB9CiAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy50YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiB0YW5nZW50VmFsdWVzCiAgICAgICAgfSk7CiAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5iaXRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICB2YWx1ZXM6IGJpdGFuZ2VudFZhbHVlcwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBnZW9tZXRyeTsKICAgICAgfTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjIyID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICB0b0VuY29kZTEgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHRvRW5jb2RlMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdG9FbmNvZGUzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBlbmNvZGVSZXN1bHQyID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBHZW9tZXRyeVBpcGVsaW5lLmNvbXByZXNzVmVydGljZXMgPSBmdW5jdGlvbihnZW9tZXRyeSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBleHRydWRlQXR0cmlidXRlID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5leHRydWRlRGlyZWN0aW9uOwogICAgICAgIGxldCBpOwogICAgICAgIGxldCBudW1WZXJ0aWNlczsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGV4dHJ1ZGVBdHRyaWJ1dGUpKSB7CiAgICAgICAgICBjb25zdCBleHRydWRlRGlyZWN0aW9ucyA9IGV4dHJ1ZGVBdHRyaWJ1dGUudmFsdWVzOwogICAgICAgICAgbnVtVmVydGljZXMgPSBleHRydWRlRGlyZWN0aW9ucy5sZW5ndGggLyAzOwogICAgICAgICAgY29uc3QgY29tcHJlc3NlZERpcmVjdGlvbnMgPSBuZXcgRmxvYXQzMkFycmF5KG51bVZlcnRpY2VzICogMik7CiAgICAgICAgICBsZXQgaTIgPSAwOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IG51bVZlcnRpY2VzOyArK2kpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShleHRydWRlRGlyZWN0aW9ucywgaSAqIDMsIHRvRW5jb2RlMSk7CiAgICAgICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKHRvRW5jb2RlMSwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pKSB7CiAgICAgICAgICAgICAgaTIgKz0gMjsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbmNvZGVSZXN1bHQyID0gQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC5vY3RFbmNvZGVJblJhbmdlKAogICAgICAgICAgICAgIHRvRW5jb2RlMSwKICAgICAgICAgICAgICA2NTUzNSwKICAgICAgICAgICAgICBlbmNvZGVSZXN1bHQyCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbXByZXNzZWREaXJlY3Rpb25zW2kyKytdID0gZW5jb2RlUmVzdWx0Mi54OwogICAgICAgICAgICBjb21wcmVzc2VkRGlyZWN0aW9uc1tpMisrXSA9IGVuY29kZVJlc3VsdDIueTsKICAgICAgICAgIH0KICAgICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMuY29tcHJlc3NlZEF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgICAgICB2YWx1ZXM6IGNvbXByZXNzZWREaXJlY3Rpb25zCiAgICAgICAgICB9KTsKICAgICAgICAgIGRlbGV0ZSBnZW9tZXRyeS5hdHRyaWJ1dGVzLmV4dHJ1ZGVEaXJlY3Rpb247CiAgICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5vcm1hbEF0dHJpYnV0ZSA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMubm9ybWFsOwogICAgICAgIGNvbnN0IHN0QXR0cmlidXRlID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5zdDsKICAgICAgICBjb25zdCBoYXNOb3JtYWwgPSBkZWZpbmVkX2RlZmF1bHQobm9ybWFsQXR0cmlidXRlKTsKICAgICAgICBjb25zdCBoYXNTdCA9IGRlZmluZWRfZGVmYXVsdChzdEF0dHJpYnV0ZSk7CiAgICAgICAgaWYgKCFoYXNOb3JtYWwgJiYgIWhhc1N0KSB7CiAgICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHRhbmdlbnRBdHRyaWJ1dGUgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnRhbmdlbnQ7CiAgICAgICAgY29uc3QgYml0YW5nZW50QXR0cmlidXRlID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5iaXRhbmdlbnQ7CiAgICAgICAgY29uc3QgaGFzVGFuZ2VudCA9IGRlZmluZWRfZGVmYXVsdCh0YW5nZW50QXR0cmlidXRlKTsKICAgICAgICBjb25zdCBoYXNCaXRhbmdlbnQgPSBkZWZpbmVkX2RlZmF1bHQoYml0YW5nZW50QXR0cmlidXRlKTsKICAgICAgICBsZXQgbm9ybWFsczsKICAgICAgICBsZXQgc3Q7CiAgICAgICAgbGV0IHRhbmdlbnRzOwogICAgICAgIGxldCBiaXRhbmdlbnRzOwogICAgICAgIGlmIChoYXNOb3JtYWwpIHsKICAgICAgICAgIG5vcm1hbHMgPSBub3JtYWxBdHRyaWJ1dGUudmFsdWVzOwogICAgICAgIH0KICAgICAgICBpZiAoaGFzU3QpIHsKICAgICAgICAgIHN0ID0gc3RBdHRyaWJ1dGUudmFsdWVzOwogICAgICAgIH0KICAgICAgICBpZiAoaGFzVGFuZ2VudCkgewogICAgICAgICAgdGFuZ2VudHMgPSB0YW5nZW50QXR0cmlidXRlLnZhbHVlczsKICAgICAgICB9CiAgICAgICAgaWYgKGhhc0JpdGFuZ2VudCkgewogICAgICAgICAgYml0YW5nZW50cyA9IGJpdGFuZ2VudEF0dHJpYnV0ZS52YWx1ZXM7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGhhc05vcm1hbCA/IG5vcm1hbHMubGVuZ3RoIDogc3QubGVuZ3RoOwogICAgICAgIGNvbnN0IG51bUNvbXBvbmVudHMgPSBoYXNOb3JtYWwgPyAzIDogMjsKICAgICAgICBudW1WZXJ0aWNlcyA9IGxlbmd0aCAvIG51bUNvbXBvbmVudHM7CiAgICAgICAgbGV0IGNvbXByZXNzZWRMZW5ndGggPSBudW1WZXJ0aWNlczsKICAgICAgICBsZXQgbnVtQ29tcHJlc3NlZENvbXBvbmVudHMgPSBoYXNTdCAmJiBoYXNOb3JtYWwgPyAyIDogMTsKICAgICAgICBudW1Db21wcmVzc2VkQ29tcG9uZW50cyArPSBoYXNUYW5nZW50IHx8IGhhc0JpdGFuZ2VudCA/IDEgOiAwOwogICAgICAgIGNvbXByZXNzZWRMZW5ndGggKj0gbnVtQ29tcHJlc3NlZENvbXBvbmVudHM7CiAgICAgICAgY29uc3QgY29tcHJlc3NlZEF0dHJpYnV0ZXMgPSBuZXcgRmxvYXQzMkFycmF5KGNvbXByZXNzZWRMZW5ndGgpOwogICAgICAgIGxldCBub3JtYWxJbmRleCA9IDA7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IG51bVZlcnRpY2VzOyArK2kpIHsKICAgICAgICAgIGlmIChoYXNTdCkgewogICAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUFycmF5KHN0LCBpICogMiwgc2NyYXRjaENhcnRlc2lhbjIyKTsKICAgICAgICAgICAgY29tcHJlc3NlZEF0dHJpYnV0ZXNbbm9ybWFsSW5kZXgrK10gPSBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0LmNvbXByZXNzVGV4dHVyZUNvb3JkaW5hdGVzKHNjcmF0Y2hDYXJ0ZXNpYW4yMik7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBpbmRleCA9IGkgKiAzOwogICAgICAgICAgaWYgKGhhc05vcm1hbCAmJiBkZWZpbmVkX2RlZmF1bHQodGFuZ2VudHMpICYmIGRlZmluZWRfZGVmYXVsdChiaXRhbmdlbnRzKSkgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KG5vcm1hbHMsIGluZGV4LCB0b0VuY29kZTEpOwogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHRhbmdlbnRzLCBpbmRleCwgdG9FbmNvZGUyKTsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShiaXRhbmdlbnRzLCBpbmRleCwgdG9FbmNvZGUzKTsKICAgICAgICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC5vY3RQYWNrKAogICAgICAgICAgICAgIHRvRW5jb2RlMSwKICAgICAgICAgICAgICB0b0VuY29kZTIsCiAgICAgICAgICAgICAgdG9FbmNvZGUzLAogICAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4yMgogICAgICAgICAgICApOwogICAgICAgICAgICBjb21wcmVzc2VkQXR0cmlidXRlc1tub3JtYWxJbmRleCsrXSA9IHNjcmF0Y2hDYXJ0ZXNpYW4yMi54OwogICAgICAgICAgICBjb21wcmVzc2VkQXR0cmlidXRlc1tub3JtYWxJbmRleCsrXSA9IHNjcmF0Y2hDYXJ0ZXNpYW4yMi55OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGhhc05vcm1hbCkgewogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkobm9ybWFscywgaW5kZXgsIHRvRW5jb2RlMSk7CiAgICAgICAgICAgICAgY29tcHJlc3NlZEF0dHJpYnV0ZXNbbm9ybWFsSW5kZXgrK10gPSBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0Lm9jdEVuY29kZUZsb2F0KHRvRW5jb2RlMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhhc1RhbmdlbnQpIHsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHRhbmdlbnRzLCBpbmRleCwgdG9FbmNvZGUxKTsKICAgICAgICAgICAgICBjb21wcmVzc2VkQXR0cmlidXRlc1tub3JtYWxJbmRleCsrXSA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQub2N0RW5jb2RlRmxvYXQodG9FbmNvZGUxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaGFzQml0YW5nZW50KSB7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShiaXRhbmdlbnRzLCBpbmRleCwgdG9FbmNvZGUxKTsKICAgICAgICAgICAgICBjb21wcmVzc2VkQXR0cmlidXRlc1tub3JtYWxJbmRleCsrXSA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQub2N0RW5jb2RlRmxvYXQodG9FbmNvZGUxKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLmNvbXByZXNzZWRBdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiBudW1Db21wcmVzc2VkQ29tcG9uZW50cywKICAgICAgICAgIHZhbHVlczogY29tcHJlc3NlZEF0dHJpYnV0ZXMKICAgICAgICB9KTsKICAgICAgICBpZiAoaGFzTm9ybWFsKSB7CiAgICAgICAgICBkZWxldGUgZ2VvbWV0cnkuYXR0cmlidXRlcy5ub3JtYWw7CiAgICAgICAgfQogICAgICAgIGlmIChoYXNTdCkgewogICAgICAgICAgZGVsZXRlIGdlb21ldHJ5LmF0dHJpYnV0ZXMuc3Q7CiAgICAgICAgfQogICAgICAgIGlmIChoYXNCaXRhbmdlbnQpIHsKICAgICAgICAgIGRlbGV0ZSBnZW9tZXRyeS5hdHRyaWJ1dGVzLmJpdGFuZ2VudDsKICAgICAgICB9CiAgICAgICAgaWYgKGhhc1RhbmdlbnQpIHsKICAgICAgICAgIGRlbGV0ZSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnRhbmdlbnQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBnZW9tZXRyeTsKICAgICAgfTsKICAgICAgYzMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHUxID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB1MiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcTEgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHEyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzcGxpdFRyaWFuZ2xlUmVzdWx0ID0gewogICAgICAgIHBvc2l0aW9uczogbmV3IEFycmF5KDcpLAogICAgICAgIGluZGljZXM6IG5ldyBBcnJheSgzICogMykKICAgICAgfTsKICAgICAgaW50ZXJwb2xhdGVBbmRQYWNrQ2FydGVzaWFuNCA9IGdlbmVyYXRlQmFyeWNlbnRyaWNJbnRlcnBvbGF0ZUZ1bmN0aW9uKAogICAgICAgIENhcnRlc2lhbjRfZGVmYXVsdCwKICAgICAgICA0CiAgICAgICk7CiAgICAgIGludGVycG9sYXRlQW5kUGFja0NhcnRlc2lhbjMgPSBnZW5lcmF0ZUJhcnljZW50cmljSW50ZXJwb2xhdGVGdW5jdGlvbigKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQsCiAgICAgICAgMwogICAgICApOwogICAgICBpbnRlcnBvbGF0ZUFuZFBhY2tDYXJ0ZXNpYW4yID0gZ2VuZXJhdGVCYXJ5Y2VudHJpY0ludGVycG9sYXRlRnVuY3Rpb24oCiAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0LAogICAgICAgIDIKICAgICAgKTsKICAgICAgaW50ZXJwb2xhdGVBbmRQYWNrQm9vbGVhbiA9IGZ1bmN0aW9uKGkwLCBpMSwgaTIsIGNvb3Jkcywgc291cmNlVmFsdWVzLCBjdXJyZW50VmFsdWVzLCBpbnNlcnRlZEluZGV4KSB7CiAgICAgICAgY29uc3QgdjEyID0gc291cmNlVmFsdWVzW2kwXSAqIGNvb3Jkcy54OwogICAgICAgIGNvbnN0IHYyMiA9IHNvdXJjZVZhbHVlc1tpMV0gKiBjb29yZHMueTsKICAgICAgICBjb25zdCB2MyA9IHNvdXJjZVZhbHVlc1tpMl0gKiBjb29yZHMuejsKICAgICAgICBjdXJyZW50VmFsdWVzW2luc2VydGVkSW5kZXhdID0gdjEyICsgdjIyICsgdjMgPiBNYXRoX2RlZmF1bHQuRVBTSUxPTjYgPyAxIDogMDsKICAgICAgfTsKICAgICAgcDBTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwMVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHAyU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYmFyeWNlbnRyaWNTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBOQU1FRF9BVFRSSUJVVEVTID0gewogICAgICAgIHBvc2l0aW9uOiB0cnVlLAogICAgICAgIG5vcm1hbDogdHJ1ZSwKICAgICAgICBiaXRhbmdlbnQ6IHRydWUsCiAgICAgICAgdGFuZ2VudDogdHJ1ZSwKICAgICAgICBzdDogdHJ1ZSwKICAgICAgICBleHRydWRlRGlyZWN0aW9uOiB0cnVlLAogICAgICAgIGFwcGx5T2Zmc2V0OiB0cnVlCiAgICAgIH07CiAgICAgIHh6UGxhbmUgPSBQbGFuZV9kZWZhdWx0LmZyb21Qb2ludE5vcm1hbChDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWSk7CiAgICAgIG9mZnNldFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIG9mZnNldFBvaW50U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuMlNjcmF0Y2gwID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4yU2NyYXRjaDEgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjNTY3JhdGNoMCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuM1NjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4zU2NyYXRjaDMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjNTY3JhdGNoNCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuM1NjcmF0Y2g1ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4zU2NyYXRjaDYgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjRTY3JhdGNoMCA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoKTsKICAgICAgb2Zmc2V0U2NhbGFyID0gNSAqIE1hdGhfZGVmYXVsdC5FUFNJTE9OOTsKICAgICAgY29wbGFuYXJPZmZzZXQgPSBNYXRoX2RlZmF1bHQuRVBTSUxPTjY7CiAgICAgIEdlb21ldHJ5UGlwZWxpbmUuc3BsaXRMb25naXR1ZGUgPSBmdW5jdGlvbihpbnN0YW5jZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGluc3RhbmNlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImluc3RhbmNlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBnZW9tZXRyeSA9IGluc3RhbmNlLmdlb21ldHJ5OwogICAgICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlID0gZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmU7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChib3VuZGluZ1NwaGVyZSkpIHsKICAgICAgICAgIGNvbnN0IG1pblggPSBib3VuZGluZ1NwaGVyZS5jZW50ZXIueCAtIGJvdW5kaW5nU3BoZXJlLnJhZGl1czsKICAgICAgICAgIGlmIChtaW5YID4gMCB8fCBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmludGVyc2VjdFBsYW5lKGJvdW5kaW5nU3BoZXJlLCBQbGFuZV9kZWZhdWx0Lk9SSUdJTl9aWF9QTEFORSkgIT09IEludGVyc2VjdF9kZWZhdWx0LklOVEVSU0VDVElORykgewogICAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChnZW9tZXRyeS5nZW9tZXRyeVR5cGUgIT09IEdlb21ldHJ5VHlwZV9kZWZhdWx0Lk5PTkUpIHsKICAgICAgICAgIHN3aXRjaCAoZ2VvbWV0cnkuZ2VvbWV0cnlUeXBlKSB7CiAgICAgICAgICAgIGNhc2UgR2VvbWV0cnlUeXBlX2RlZmF1bHQuUE9MWUxJTkVTOgogICAgICAgICAgICAgIHNwbGl0TG9uZ2l0dWRlUG9seWxpbmUoaW5zdGFuY2UpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIEdlb21ldHJ5VHlwZV9kZWZhdWx0LlRSSUFOR0xFUzoKICAgICAgICAgICAgICBzcGxpdExvbmdpdHVkZVRyaWFuZ2xlcyhpbnN0YW5jZSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgR2VvbWV0cnlUeXBlX2RlZmF1bHQuTElORVM6CiAgICAgICAgICAgICAgc3BsaXRMb25naXR1ZGVMaW5lcyhpbnN0YW5jZSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGluZGV4UHJpbWl0aXZlKGdlb21ldHJ5KTsKICAgICAgICAgIGlmIChnZW9tZXRyeS5wcmltaXRpdmVUeXBlID09PSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTKSB7CiAgICAgICAgICAgIHNwbGl0TG9uZ2l0dWRlVHJpYW5nbGVzKGluc3RhbmNlKTsKICAgICAgICAgIH0gZWxzZSBpZiAoZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSA9PT0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTKSB7CiAgICAgICAgICAgIHNwbGl0TG9uZ2l0dWRlTGluZXMoaW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgIH07CiAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdCA9IEdlb21ldHJ5UGlwZWxpbmU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9PZmZzZXRHZW9tZXRyeUluc3RhbmNlQXR0cmlidXRlLmpzCiAgZnVuY3Rpb24gT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZSh4LCB5LCB6KSB7CiAgICB4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeCwgMCk7CiAgICB5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeSwgMCk7CiAgICB6ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeiwgMCk7CiAgICB0aGlzLnZhbHVlID0gbmV3IEZsb2F0MzJBcnJheShbeCwgeSwgel0pOwogIH0KICB2YXIgT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZV9kZWZhdWx0OwogIHZhciBpbml0X09mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL09mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGUuanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGUucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIGRhdGF0eXBlIG9mIGVhY2ggY29tcG9uZW50IGluIHRoZSBhdHRyaWJ1dGUsIGUuZy4sIGluZGl2aWR1YWwgZWxlbWVudHMgaW4KICAgICAgICAgKiB7QGxpbmsgT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZSN2YWx1ZX0uCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZS5wcm90b3R5cGUKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtDb21wb25lbnREYXRhdHlwZX0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKgogICAgICAgICAqIEBkZWZhdWx0IHtAbGluayBDb21wb25lbnREYXRhdHlwZS5GTE9BVH0KICAgICAgICAgKi8KICAgICAgICBjb21wb25lbnREYXRhdHlwZTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQ7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgbnVtYmVyIG9mIGNvbXBvbmVudHMgaW4gdGhlIGF0dHJpYnV0ZXMsIGkuZS4sIHtAbGluayBPZmZzZXRHZW9tZXRyeUluc3RhbmNlQXR0cmlidXRlI3ZhbHVlfS4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBPZmZzZXRHZW9tZXRyeUluc3RhbmNlQXR0cmlidXRlLnByb3RvdHlwZQogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKgogICAgICAgICAqIEBkZWZhdWx0IDMKICAgICAgICAgKi8KICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gMzsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFdoZW4gPGNvZGU+dHJ1ZTwvY29kZT4gYW5kIDxjb2RlPmNvbXBvbmVudERhdGF0eXBlPC9jb2RlPiBpcyBhbiBpbnRlZ2VyIGZvcm1hdCwKICAgICAgICAgKiBpbmRpY2F0ZSB0aGF0IHRoZSBjb21wb25lbnRzIHNob3VsZCBiZSBtYXBwZWQgdG8gdGhlIHJhbmdlIFswLCAxXSAodW5zaWduZWQpCiAgICAgICAgICogb3IgWy0xLCAxXSAoc2lnbmVkKSB3aGVuIHRoZXkgYXJlIGFjY2Vzc2VkIGFzIGZsb2F0aW5nLXBvaW50IGZvciByZW5kZXJpbmcuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZS5wcm90b3R5cGUKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtib29sZWFufQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqCiAgICAgICAgICogQGRlZmF1bHQgZmFsc2UKICAgICAgICAgKi8KICAgICAgICBub3JtYWxpemU6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBPZmZzZXRHZW9tZXRyeUluc3RhbmNlQXR0cmlidXRlLmZyb21DYXJ0ZXNpYW4zID0gZnVuY3Rpb24ob2Zmc2V0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvZmZzZXQiLCBvZmZzZXQpOwogICAgICAgIHJldHVybiBuZXcgT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZShvZmZzZXQueCwgb2Zmc2V0LnksIG9mZnNldC56KTsKICAgICAgfTsKICAgICAgT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZS50b1ZhbHVlID0gZnVuY3Rpb24ob2Zmc2V0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9mZnNldCIsIG9mZnNldCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEZsb2F0MzJBcnJheShbb2Zmc2V0LngsIG9mZnNldC55LCBvZmZzZXQuel0pOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBvZmZzZXQueDsKICAgICAgICByZXN1bHRbMV0gPSBvZmZzZXQueTsKICAgICAgICByZXN1bHRbMl0gPSBvZmZzZXQuejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBPZmZzZXRHZW9tZXRyeUluc3RhbmNlQXR0cmlidXRlX2RlZmF1bHQgPSBPZmZzZXRHZW9tZXRyeUluc3RhbmNlQXR0cmlidXRlOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvV2ViTWVyY2F0b3JQcm9qZWN0aW9uLmpzCiAgZnVuY3Rpb24gV2ViTWVyY2F0b3JQcm9qZWN0aW9uKGVsbGlwc29pZCkgewogICAgdGhpcy5fZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICB0aGlzLl9zZW1pbWFqb3JBeGlzID0gdGhpcy5fZWxsaXBzb2lkLm1heGltdW1SYWRpdXM7CiAgICB0aGlzLl9vbmVPdmVyU2VtaW1ham9yQXhpcyA9IDEgLyB0aGlzLl9zZW1pbWFqb3JBeGlzOwogIH0KICB2YXIgV2ViTWVyY2F0b3JQcm9qZWN0aW9uX2RlZmF1bHQ7CiAgdmFyIGluaXRfV2ViTWVyY2F0b3JQcm9qZWN0aW9uID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9XZWJNZXJjYXRvclByb2plY3Rpb24uanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFdlYk1lcmNhdG9yUHJvamVjdGlvbi5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSB7QGxpbmsgRWxsaXBzb2lkfS4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBXZWJNZXJjYXRvclByb2plY3Rpb24ucHJvdG90eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7RWxsaXBzb2lkfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGVsbGlwc29pZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VsbGlwc29pZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBXZWJNZXJjYXRvclByb2plY3Rpb24ubWVyY2F0b3JBbmdsZVRvR2VvZGV0aWNMYXRpdHVkZSA9IGZ1bmN0aW9uKG1lcmNhdG9yQW5nbGUpIHsKICAgICAgICByZXR1cm4gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIC0gMiAqIE1hdGguYXRhbihNYXRoLmV4cCgtbWVyY2F0b3JBbmdsZSkpOwogICAgICB9OwogICAgICBXZWJNZXJjYXRvclByb2plY3Rpb24uZ2VvZGV0aWNMYXRpdHVkZVRvTWVyY2F0b3JBbmdsZSA9IGZ1bmN0aW9uKGxhdGl0dWRlKSB7CiAgICAgICAgaWYgKGxhdGl0dWRlID4gV2ViTWVyY2F0b3JQcm9qZWN0aW9uLk1heGltdW1MYXRpdHVkZSkgewogICAgICAgICAgbGF0aXR1ZGUgPSBXZWJNZXJjYXRvclByb2plY3Rpb24uTWF4aW11bUxhdGl0dWRlOwogICAgICAgIH0gZWxzZSBpZiAobGF0aXR1ZGUgPCAtV2ViTWVyY2F0b3JQcm9qZWN0aW9uLk1heGltdW1MYXRpdHVkZSkgewogICAgICAgICAgbGF0aXR1ZGUgPSAtV2ViTWVyY2F0b3JQcm9qZWN0aW9uLk1heGltdW1MYXRpdHVkZTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc2luTGF0aXR1ZGUgPSBNYXRoLnNpbihsYXRpdHVkZSk7CiAgICAgICAgcmV0dXJuIDAuNSAqIE1hdGgubG9nKCgxICsgc2luTGF0aXR1ZGUpIC8gKDEgLSBzaW5MYXRpdHVkZSkpOwogICAgICB9OwogICAgICBXZWJNZXJjYXRvclByb2plY3Rpb24uTWF4aW11bUxhdGl0dWRlID0gV2ViTWVyY2F0b3JQcm9qZWN0aW9uLm1lcmNhdG9yQW5nbGVUb0dlb2RldGljTGF0aXR1ZGUoCiAgICAgICAgTWF0aC5QSQogICAgICApOwogICAgICBXZWJNZXJjYXRvclByb2plY3Rpb24ucHJvdG90eXBlLnByb2plY3QgPSBmdW5jdGlvbihjYXJ0b2dyYXBoaWMyLCByZXN1bHQpIHsKICAgICAgICBjb25zdCBzZW1pbWFqb3JBeGlzID0gdGhpcy5fc2VtaW1ham9yQXhpczsKICAgICAgICBjb25zdCB4ID0gY2FydG9ncmFwaGljMi5sb25naXR1ZGUgKiBzZW1pbWFqb3JBeGlzOwogICAgICAgIGNvbnN0IHkgPSBXZWJNZXJjYXRvclByb2plY3Rpb24uZ2VvZGV0aWNMYXRpdHVkZVRvTWVyY2F0b3JBbmdsZSgKICAgICAgICAgIGNhcnRvZ3JhcGhpYzIubGF0aXR1ZGUKICAgICAgICApICogc2VtaW1ham9yQXhpczsKICAgICAgICBjb25zdCB6ID0gY2FydG9ncmFwaGljMi5oZWlnaHQ7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCwgeSwgeik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFdlYk1lcmNhdG9yUHJvamVjdGlvbi5wcm90b3R5cGUudW5wcm9qZWN0ID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNhcnRlc2lhbjExKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImNhcnRlc2lhbiBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBvbmVPdmVyRWFydGhTZW1pbWFqb3JBeGlzID0gdGhpcy5fb25lT3ZlclNlbWltYWpvckF4aXM7CiAgICAgICAgY29uc3QgbG9uZ2l0dWRlID0gY2FydGVzaWFuMTEueCAqIG9uZU92ZXJFYXJ0aFNlbWltYWpvckF4aXM7CiAgICAgICAgY29uc3QgbGF0aXR1ZGUgPSBXZWJNZXJjYXRvclByb2plY3Rpb24ubWVyY2F0b3JBbmdsZVRvR2VvZGV0aWNMYXRpdHVkZSgKICAgICAgICAgIGNhcnRlc2lhbjExLnkgKiBvbmVPdmVyRWFydGhTZW1pbWFqb3JBeGlzCiAgICAgICAgKTsKICAgICAgICBjb25zdCBoZWlnaHQgPSBjYXJ0ZXNpYW4xMS56OwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQobG9uZ2l0dWRlLCBsYXRpdHVkZSwgaGVpZ2h0KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IGxvbmdpdHVkZTsKICAgICAgICByZXN1bHQubGF0aXR1ZGUgPSBsYXRpdHVkZTsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0ID0gV2ViTWVyY2F0b3JQcm9qZWN0aW9uOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1NjZW5lL1ByaW1pdGl2ZVBpcGVsaW5lLmpzCiAgZnVuY3Rpb24gdHJhbnNmb3JtVG9Xb3JsZENvb3JkaW5hdGVzKGluc3RhbmNlcywgcHJpbWl0aXZlTW9kZWxNYXRyaXgsIHNjZW5lM0RPbmx5KSB7CiAgICBsZXQgdG9Xb3JsZCA9ICFzY2VuZTNET25seTsKICAgIGNvbnN0IGxlbmd0aCA9IGluc3RhbmNlcy5sZW5ndGg7CiAgICBsZXQgaTsKICAgIGlmICghdG9Xb3JsZCAmJiBsZW5ndGggPiAxKSB7CiAgICAgIGNvbnN0IG1vZGVsTWF0cml4ID0gaW5zdGFuY2VzWzBdLm1vZGVsTWF0cml4OwogICAgICBmb3IgKGkgPSAxOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICBpZiAoIU1hdHJpeDRfZGVmYXVsdC5lcXVhbHMobW9kZWxNYXRyaXgsIGluc3RhbmNlc1tpXS5tb2RlbE1hdHJpeCkpIHsKICAgICAgICAgIHRvV29ybGQgPSB0cnVlOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAodG9Xb3JsZCkgewogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGluc3RhbmNlc1tpXS5nZW9tZXRyeSkpIHsKICAgICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC50cmFuc2Zvcm1Ub1dvcmxkQ29vcmRpbmF0ZXMoaW5zdGFuY2VzW2ldKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseVRyYW5zZm9ybWF0aW9uKAogICAgICAgIHByaW1pdGl2ZU1vZGVsTWF0cml4LAogICAgICAgIGluc3RhbmNlc1swXS5tb2RlbE1hdHJpeCwKICAgICAgICBwcmltaXRpdmVNb2RlbE1hdHJpeAogICAgICApOwogICAgfQogIH0KICBmdW5jdGlvbiBhZGRHZW9tZXRyeUJhdGNoSWQoZ2VvbWV0cnksIGJhdGNoSWQpIHsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgY29uc3QgcG9zaXRpb25BdHRyID0gYXR0cmlidXRlcy5wb3NpdGlvbjsKICAgIGNvbnN0IG51bWJlck9mQ29tcG9uZW50cyA9IHBvc2l0aW9uQXR0ci52YWx1ZXMubGVuZ3RoIC8gcG9zaXRpb25BdHRyLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGU7CiAgICBhdHRyaWJ1dGVzLmJhdGNoSWQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICB2YWx1ZXM6IG5ldyBGbG9hdDMyQXJyYXkobnVtYmVyT2ZDb21wb25lbnRzKQogICAgfSk7CiAgICBjb25zdCB2YWx1ZXMgPSBhdHRyaWJ1dGVzLmJhdGNoSWQudmFsdWVzOwogICAgZm9yIChsZXQgaiA9IDA7IGogPCBudW1iZXJPZkNvbXBvbmVudHM7ICsraikgewogICAgICB2YWx1ZXNbal0gPSBiYXRjaElkOwogICAgfQogIH0KICBmdW5jdGlvbiBhZGRCYXRjaElkcyhpbnN0YW5jZXMpIHsKICAgIGNvbnN0IGxlbmd0aCA9IGluc3RhbmNlcy5sZW5ndGg7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGNvbnN0IGluc3RhbmNlID0gaW5zdGFuY2VzW2ldOwogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGluc3RhbmNlLmdlb21ldHJ5KSkgewogICAgICAgIGFkZEdlb21ldHJ5QmF0Y2hJZChpbnN0YW5jZS5nZW9tZXRyeSwgaSk7CiAgICAgIH0gZWxzZSBpZiAoZGVmaW5lZF9kZWZhdWx0KGluc3RhbmNlLndlc3RIZW1pc3BoZXJlR2VvbWV0cnkpICYmIGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZS5lYXN0SGVtaXNwaGVyZUdlb21ldHJ5KSkgewogICAgICAgIGFkZEdlb21ldHJ5QmF0Y2hJZChpbnN0YW5jZS53ZXN0SGVtaXNwaGVyZUdlb21ldHJ5LCBpKTsKICAgICAgICBhZGRHZW9tZXRyeUJhdGNoSWQoaW5zdGFuY2UuZWFzdEhlbWlzcGhlcmVHZW9tZXRyeSwgaSk7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gZ2VvbWV0cnlQaXBlbGluZShwYXJhbWV0ZXJzKSB7CiAgICBjb25zdCBpbnN0YW5jZXMgPSBwYXJhbWV0ZXJzLmluc3RhbmNlczsKICAgIGNvbnN0IHByb2plY3Rpb24gPSBwYXJhbWV0ZXJzLnByb2plY3Rpb247CiAgICBjb25zdCB1aW50SW5kZXhTdXBwb3J0ID0gcGFyYW1ldGVycy5lbGVtZW50SW5kZXhVaW50U3VwcG9ydGVkOwogICAgY29uc3Qgc2NlbmUzRE9ubHkgPSBwYXJhbWV0ZXJzLnNjZW5lM0RPbmx5OwogICAgY29uc3QgdmVydGV4Q2FjaGVPcHRpbWl6ZSA9IHBhcmFtZXRlcnMudmVydGV4Q2FjaGVPcHRpbWl6ZTsKICAgIGNvbnN0IGNvbXByZXNzVmVydGljZXMgPSBwYXJhbWV0ZXJzLmNvbXByZXNzVmVydGljZXM7CiAgICBjb25zdCBtb2RlbE1hdHJpeCA9IHBhcmFtZXRlcnMubW9kZWxNYXRyaXg7CiAgICBsZXQgaTsKICAgIGxldCBnZW9tZXRyeTsKICAgIGxldCBwcmltaXRpdmVUeXBlOwogICAgbGV0IGxlbmd0aCA9IGluc3RhbmNlcy5sZW5ndGg7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZXNbaV0uZ2VvbWV0cnkpKSB7CiAgICAgICAgcHJpbWl0aXZlVHlwZSA9IGluc3RhbmNlc1tpXS5nZW9tZXRyeS5wcmltaXRpdmVUeXBlOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICBmb3IgKGkgPSAxOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZXNbaV0uZ2VvbWV0cnkpICYmIGluc3RhbmNlc1tpXS5nZW9tZXRyeS5wcmltaXRpdmVUeXBlICE9PSBwcmltaXRpdmVUeXBlKSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAiQWxsIGluc3RhbmNlIGdlb21ldHJpZXMgbXVzdCBoYXZlIHRoZSBzYW1lIHByaW1pdGl2ZVR5cGUuIgogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIHRyYW5zZm9ybVRvV29ybGRDb29yZGluYXRlcyhpbnN0YW5jZXMsIG1vZGVsTWF0cml4LCBzY2VuZTNET25seSk7CiAgICBpZiAoIXNjZW5lM0RPbmx5KSB7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2VzW2ldLmdlb21ldHJ5KSkgewogICAgICAgICAgR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LnNwbGl0TG9uZ2l0dWRlKGluc3RhbmNlc1tpXSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBhZGRCYXRjaElkcyhpbnN0YW5jZXMpOwogICAgaWYgKHZlcnRleENhY2hlT3B0aW1pemUpIHsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgY29uc3QgaW5zdGFuY2UgPSBpbnN0YW5jZXNbaV07CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZS5nZW9tZXRyeSkpIHsKICAgICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5yZW9yZGVyRm9yUG9zdFZlcnRleENhY2hlKGluc3RhbmNlLmdlb21ldHJ5KTsKICAgICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5yZW9yZGVyRm9yUHJlVmVydGV4Q2FjaGUoaW5zdGFuY2UuZ2VvbWV0cnkpOwogICAgICAgIH0gZWxzZSBpZiAoZGVmaW5lZF9kZWZhdWx0KGluc3RhbmNlLndlc3RIZW1pc3BoZXJlR2VvbWV0cnkpICYmIGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZS5lYXN0SGVtaXNwaGVyZUdlb21ldHJ5KSkgewogICAgICAgICAgR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LnJlb3JkZXJGb3JQb3N0VmVydGV4Q2FjaGUoCiAgICAgICAgICAgIGluc3RhbmNlLndlc3RIZW1pc3BoZXJlR2VvbWV0cnkKICAgICAgICAgICk7CiAgICAgICAgICBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQucmVvcmRlckZvclByZVZlcnRleENhY2hlKAogICAgICAgICAgICBpbnN0YW5jZS53ZXN0SGVtaXNwaGVyZUdlb21ldHJ5CiAgICAgICAgICApOwogICAgICAgICAgR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LnJlb3JkZXJGb3JQb3N0VmVydGV4Q2FjaGUoCiAgICAgICAgICAgIGluc3RhbmNlLmVhc3RIZW1pc3BoZXJlR2VvbWV0cnkKICAgICAgICAgICk7CiAgICAgICAgICBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQucmVvcmRlckZvclByZVZlcnRleENhY2hlKAogICAgICAgICAgICBpbnN0YW5jZS5lYXN0SGVtaXNwaGVyZUdlb21ldHJ5CiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgbGV0IGdlb21ldHJpZXMgPSBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQuY29tYmluZUluc3RhbmNlcyhpbnN0YW5jZXMpOwogICAgbGVuZ3RoID0gZ2VvbWV0cmllcy5sZW5ndGg7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgZ2VvbWV0cnkgPSBnZW9tZXRyaWVzW2ldOwogICAgICBjb25zdCBhdHRyaWJ1dGVzID0gZ2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgaWYgKCFzY2VuZTNET25seSkgewogICAgICAgIGZvciAoY29uc3QgbmFtZSBpbiBhdHRyaWJ1dGVzKSB7CiAgICAgICAgICBpZiAoYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSAmJiBhdHRyaWJ1dGVzW25hbWVdLmNvbXBvbmVudERhdGF0eXBlID09PSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSkgewogICAgICAgICAgICBjb25zdCBuYW1lM0QgPSBgJHtuYW1lfTNEYDsKICAgICAgICAgICAgY29uc3QgbmFtZTJEID0gYCR7bmFtZX0yRGA7CiAgICAgICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5wcm9qZWN0VG8yRCgKICAgICAgICAgICAgICBnZW9tZXRyeSwKICAgICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAgIG5hbWUzRCwKICAgICAgICAgICAgICBuYW1lMkQsCiAgICAgICAgICAgICAgcHJvamVjdGlvbgogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlKSAmJiBuYW1lID09PSAicG9zaXRpb24iKSB7CiAgICAgICAgICAgICAgZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmVDViA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVZlcnRpY2VzKAogICAgICAgICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbjJELnZhbHVlcwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LmVuY29kZUF0dHJpYnV0ZSgKICAgICAgICAgICAgICBnZW9tZXRyeSwKICAgICAgICAgICAgICBuYW1lM0QsCiAgICAgICAgICAgICAgYCR7bmFtZTNEfUhpZ2hgLAogICAgICAgICAgICAgIGAke25hbWUzRH1Mb3dgCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5lbmNvZGVBdHRyaWJ1dGUoCiAgICAgICAgICAgICAgZ2VvbWV0cnksCiAgICAgICAgICAgICAgbmFtZTJELAogICAgICAgICAgICAgIGAke25hbWUyRH1IaWdoYCwKICAgICAgICAgICAgICBgJHtuYW1lMkR9TG93YAogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBmb3IgKGNvbnN0IG5hbWUgaW4gYXR0cmlidXRlcykgewogICAgICAgICAgaWYgKGF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkobmFtZSkgJiYgYXR0cmlidXRlc1tuYW1lXS5jb21wb25lbnREYXRhdHlwZSA9PT0gQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUpIHsKICAgICAgICAgICAgR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LmVuY29kZUF0dHJpYnV0ZSgKICAgICAgICAgICAgICBnZW9tZXRyeSwKICAgICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAgIGAke25hbWV9M0RIaWdoYCwKICAgICAgICAgICAgICBgJHtuYW1lfTNETG93YAogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoY29tcHJlc3NWZXJ0aWNlcykgewogICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5jb21wcmVzc1ZlcnRpY2VzKGdlb21ldHJ5KTsKICAgICAgfQogICAgfQogICAgaWYgKCF1aW50SW5kZXhTdXBwb3J0KSB7CiAgICAgIGxldCBzcGxpdEdlb21ldHJpZXMgPSBbXTsKICAgICAgbGVuZ3RoID0gZ2VvbWV0cmllcy5sZW5ndGg7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgIGdlb21ldHJ5ID0gZ2VvbWV0cmllc1tpXTsKICAgICAgICBzcGxpdEdlb21ldHJpZXMgPSBzcGxpdEdlb21ldHJpZXMuY29uY2F0KAogICAgICAgICAgR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LmZpdFRvVW5zaWduZWRTaG9ydEluZGljZXMoZ2VvbWV0cnkpCiAgICAgICAgKTsKICAgICAgfQogICAgICBnZW9tZXRyaWVzID0gc3BsaXRHZW9tZXRyaWVzOwogICAgfQogICAgcmV0dXJuIGdlb21ldHJpZXM7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVBpY2tPZmZzZXRzKGluc3RhbmNlcywgZ2VvbWV0cnlOYW1lLCBnZW9tZXRyaWVzLCBwaWNrT2Zmc2V0cykgewogICAgbGV0IG9mZnNldDsKICAgIGxldCBpbmRleENvdW50OwogICAgbGV0IGdlb21ldHJ5SW5kZXg7CiAgICBjb25zdCBvZmZzZXRJbmRleCA9IHBpY2tPZmZzZXRzLmxlbmd0aCAtIDE7CiAgICBpZiAob2Zmc2V0SW5kZXggPj0gMCkgewogICAgICBjb25zdCBwaWNrT2Zmc2V0ID0gcGlja09mZnNldHNbb2Zmc2V0SW5kZXhdOwogICAgICBvZmZzZXQgPSBwaWNrT2Zmc2V0Lm9mZnNldCArIHBpY2tPZmZzZXQuY291bnQ7CiAgICAgIGdlb21ldHJ5SW5kZXggPSBwaWNrT2Zmc2V0LmluZGV4OwogICAgICBpbmRleENvdW50ID0gZ2VvbWV0cmllc1tnZW9tZXRyeUluZGV4XS5pbmRpY2VzLmxlbmd0aDsKICAgIH0gZWxzZSB7CiAgICAgIG9mZnNldCA9IDA7CiAgICAgIGdlb21ldHJ5SW5kZXggPSAwOwogICAgICBpbmRleENvdW50ID0gZ2VvbWV0cmllc1tnZW9tZXRyeUluZGV4XS5pbmRpY2VzLmxlbmd0aDsKICAgIH0KICAgIGNvbnN0IGxlbmd0aCA9IGluc3RhbmNlcy5sZW5ndGg7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGNvbnN0IGluc3RhbmNlID0gaW5zdGFuY2VzW2ldOwogICAgICBjb25zdCBnZW9tZXRyeSA9IGluc3RhbmNlW2dlb21ldHJ5TmFtZV07CiAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbnN0IGNvdW50ID0gZ2VvbWV0cnkuaW5kaWNlcy5sZW5ndGg7CiAgICAgIGlmIChvZmZzZXQgKyBjb3VudCA+IGluZGV4Q291bnQpIHsKICAgICAgICBvZmZzZXQgPSAwOwogICAgICAgIGluZGV4Q291bnQgPSBnZW9tZXRyaWVzWysrZ2VvbWV0cnlJbmRleF0uaW5kaWNlcy5sZW5ndGg7CiAgICAgIH0KICAgICAgcGlja09mZnNldHMucHVzaCh7CiAgICAgICAgaW5kZXg6IGdlb21ldHJ5SW5kZXgsCiAgICAgICAgb2Zmc2V0LAogICAgICAgIGNvdW50CiAgICAgIH0pOwogICAgICBvZmZzZXQgKz0gY291bnQ7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZUluc3RhbmNlUGlja09mZnNldHMoaW5zdGFuY2VzLCBnZW9tZXRyaWVzKSB7CiAgICBjb25zdCBwaWNrT2Zmc2V0cyA9IFtdOwogICAgY3JlYXRlUGlja09mZnNldHMoaW5zdGFuY2VzLCAiZ2VvbWV0cnkiLCBnZW9tZXRyaWVzLCBwaWNrT2Zmc2V0cyk7CiAgICBjcmVhdGVQaWNrT2Zmc2V0cygKICAgICAgaW5zdGFuY2VzLAogICAgICAid2VzdEhlbWlzcGhlcmVHZW9tZXRyeSIsCiAgICAgIGdlb21ldHJpZXMsCiAgICAgIHBpY2tPZmZzZXRzCiAgICApOwogICAgY3JlYXRlUGlja09mZnNldHMoCiAgICAgIGluc3RhbmNlcywKICAgICAgImVhc3RIZW1pc3BoZXJlR2VvbWV0cnkiLAogICAgICBnZW9tZXRyaWVzLAogICAgICBwaWNrT2Zmc2V0cwogICAgKTsKICAgIHJldHVybiBwaWNrT2Zmc2V0czsKICB9CiAgZnVuY3Rpb24gdHJhbnNmZXJHZW9tZXRyeShnZW9tZXRyeSwgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICBmb3IgKGNvbnN0IG5hbWUgaW4gYXR0cmlidXRlcykgewogICAgICBpZiAoYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZXNbbmFtZV07CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGUpICYmIGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGUudmFsdWVzKSkgewogICAgICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKGF0dHJpYnV0ZS52YWx1ZXMuYnVmZmVyKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkuaW5kaWNlcykpIHsKICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKGdlb21ldHJ5LmluZGljZXMuYnVmZmVyKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gdHJhbnNmZXJHZW9tZXRyaWVzKGdlb21ldHJpZXMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IGxlbmd0aCA9IGdlb21ldHJpZXMubGVuZ3RoOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICB0cmFuc2Zlckdlb21ldHJ5KGdlb21ldHJpZXNbaV0sIHRyYW5zZmVyYWJsZU9iamVjdHMpOwogICAgfQogIH0KICBmdW5jdGlvbiBjb3VudENyZWF0ZUdlb21ldHJ5UmVzdWx0cyhpdGVtcykgewogICAgbGV0IGNvdW50ID0gMTsKICAgIGNvbnN0IGxlbmd0aCA9IGl0ZW1zLmxlbmd0aDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgZ2VvbWV0cnkgPSBpdGVtc1tpXTsKICAgICAgKytjb3VudDsKICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkpKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgIGNvdW50ICs9IDcgKyAyICogQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAoZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmluZGljZXMpID8gZ2VvbWV0cnkuaW5kaWNlcy5sZW5ndGggOiAwKTsKICAgICAgZm9yIChjb25zdCBwcm9wZXJ0eSBpbiBhdHRyaWJ1dGVzKSB7CiAgICAgICAgaWYgKGF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkocHJvcGVydHkpICYmIGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzW3Byb3BlcnR5XSkpIHsKICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZXNbcHJvcGVydHldOwogICAgICAgICAgY291bnQgKz0gNSArIGF0dHJpYnV0ZS52YWx1ZXMubGVuZ3RoOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGNvdW50OwogIH0KICBmdW5jdGlvbiBwYWNrSW5zdGFuY2VzRm9yQ29tYmluZShpbnN0YW5jZXMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IGxlbmd0aCA9IGluc3RhbmNlcy5sZW5ndGg7CiAgICBjb25zdCBwYWNrZWREYXRhID0gbmV3IEZsb2F0NjRBcnJheSgxICsgbGVuZ3RoICogMTkpOwogICAgbGV0IGNvdW50ID0gMDsKICAgIHBhY2tlZERhdGFbY291bnQrK10gPSBsZW5ndGg7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGluc3RhbmNlID0gaW5zdGFuY2VzW2ldOwogICAgICBNYXRyaXg0X2RlZmF1bHQucGFjayhpbnN0YW5jZS5tb2RlbE1hdHJpeCwgcGFja2VkRGF0YSwgY291bnQpOwogICAgICBjb3VudCArPSBNYXRyaXg0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGluc3RhbmNlLmF0dHJpYnV0ZXMpICYmIGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZS5hdHRyaWJ1dGVzLm9mZnNldCkpIHsKICAgICAgICBjb25zdCB2YWx1ZXMgPSBpbnN0YW5jZS5hdHRyaWJ1dGVzLm9mZnNldC52YWx1ZTsKICAgICAgICBwYWNrZWREYXRhW2NvdW50XSA9IHZhbHVlc1swXTsKICAgICAgICBwYWNrZWREYXRhW2NvdW50ICsgMV0gPSB2YWx1ZXNbMV07CiAgICAgICAgcGFja2VkRGF0YVtjb3VudCArIDJdID0gdmFsdWVzWzJdOwogICAgICB9CiAgICAgIGNvdW50ICs9IDM7CiAgICB9CiAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2gocGFja2VkRGF0YS5idWZmZXIpOwogICAgcmV0dXJuIHBhY2tlZERhdGE7CiAgfQogIGZ1bmN0aW9uIHVucGFja0luc3RhbmNlc0ZvckNvbWJpbmUoZGF0YSkgewogICAgY29uc3QgcGFja2VkSW5zdGFuY2VzID0gZGF0YTsKICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBBcnJheShwYWNrZWRJbnN0YW5jZXNbMF0pOwogICAgbGV0IGNvdW50ID0gMDsKICAgIGxldCBpID0gMTsKICAgIHdoaWxlIChpIDwgcGFja2VkSW5zdGFuY2VzLmxlbmd0aCkgewogICAgICBjb25zdCBtb2RlbE1hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC51bnBhY2socGFja2VkSW5zdGFuY2VzLCBpKTsKICAgICAgbGV0IGF0dHJpYnV0ZXM7CiAgICAgIGkgKz0gTWF0cml4NF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChwYWNrZWRJbnN0YW5jZXNbaV0pKSB7CiAgICAgICAgYXR0cmlidXRlcyA9IHsKICAgICAgICAgIG9mZnNldDogbmV3IE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGVfZGVmYXVsdCgKICAgICAgICAgICAgcGFja2VkSW5zdGFuY2VzW2ldLAogICAgICAgICAgICBwYWNrZWRJbnN0YW5jZXNbaSArIDFdLAogICAgICAgICAgICBwYWNrZWRJbnN0YW5jZXNbaSArIDJdCiAgICAgICAgICApCiAgICAgICAgfTsKICAgICAgfQogICAgICBpICs9IDM7CiAgICAgIHJlc3VsdFtjb3VudCsrXSA9IHsKICAgICAgICBtb2RlbE1hdHJpeCwKICAgICAgICBhdHRyaWJ1dGVzCiAgICAgIH07CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBwYWNrQm91bmRpbmdTcGhlcmVzKGJvdW5kaW5nU3BoZXJlcykgewogICAgY29uc3QgbGVuZ3RoID0gYm91bmRpbmdTcGhlcmVzLmxlbmd0aDsKICAgIGNvbnN0IGJ1ZmZlckxlbmd0aCA9IDEgKyAoQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAxKSAqIGxlbmd0aDsKICAgIGNvbnN0IGJ1ZmZlciA9IG5ldyBGbG9hdDMyQXJyYXkoYnVmZmVyTGVuZ3RoKTsKICAgIGxldCBidWZmZXJJbmRleCA9IDA7CiAgICBidWZmZXJbYnVmZmVySW5kZXgrK10gPSBsZW5ndGg7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGNvbnN0IGJzID0gYm91bmRpbmdTcGhlcmVzW2ldOwogICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChicykpIHsKICAgICAgICBidWZmZXJbYnVmZmVySW5kZXgrK10gPSAwOwogICAgICB9IGVsc2UgewogICAgICAgIGJ1ZmZlcltidWZmZXJJbmRleCsrXSA9IDE7CiAgICAgICAgQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrKGJvdW5kaW5nU3BoZXJlc1tpXSwgYnVmZmVyLCBidWZmZXJJbmRleCk7CiAgICAgIH0KICAgICAgYnVmZmVySW5kZXggKz0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICB9CiAgICByZXR1cm4gYnVmZmVyOwogIH0KICBmdW5jdGlvbiB1bnBhY2tCb3VuZGluZ1NwaGVyZXMoYnVmZmVyKSB7CiAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXkoYnVmZmVyWzBdKTsKICAgIGxldCBjb3VudCA9IDA7CiAgICBsZXQgaSA9IDE7CiAgICB3aGlsZSAoaSA8IGJ1ZmZlci5sZW5ndGgpIHsKICAgICAgaWYgKGJ1ZmZlcltpKytdID09PSAxKSB7CiAgICAgICAgcmVzdWx0W2NvdW50XSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQudW5wYWNrKGJ1ZmZlciwgaSk7CiAgICAgIH0KICAgICAgKytjb3VudDsKICAgICAgaSArPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHZhciBQcmltaXRpdmVQaXBlbGluZSwgUHJpbWl0aXZlUGlwZWxpbmVfZGVmYXVsdDsKICB2YXIgaW5pdF9QcmltaXRpdmVQaXBlbGluZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1NjZW5lL1ByaW1pdGl2ZVBpcGVsaW5lLmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvZ3JhcGhpY1Byb2plY3Rpb24oKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlQaXBlbGluZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIGluaXRfT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZSgpOwogICAgICBpbml0X1dlYk1lcmNhdG9yUHJvamVjdGlvbigpOwogICAgICBQcmltaXRpdmVQaXBlbGluZSA9IHt9OwogICAgICBQcmltaXRpdmVQaXBlbGluZS5jb21iaW5lR2VvbWV0cnkgPSBmdW5jdGlvbihwYXJhbWV0ZXJzKSB7CiAgICAgICAgbGV0IGdlb21ldHJpZXM7CiAgICAgICAgbGV0IGF0dHJpYnV0ZUxvY2F0aW9uczsKICAgICAgICBjb25zdCBpbnN0YW5jZXMgPSBwYXJhbWV0ZXJzLmluc3RhbmNlczsKICAgICAgICBjb25zdCBsZW5ndGggPSBpbnN0YW5jZXMubGVuZ3RoOwogICAgICAgIGxldCBwaWNrT2Zmc2V0czsKICAgICAgICBsZXQgb2Zmc2V0SW5zdGFuY2VFeHRlbmQ7CiAgICAgICAgbGV0IGhhc09mZnNldCA9IGZhbHNlOwogICAgICAgIGlmIChsZW5ndGggPiAwKSB7CiAgICAgICAgICBnZW9tZXRyaWVzID0gZ2VvbWV0cnlQaXBlbGluZShwYXJhbWV0ZXJzKTsKICAgICAgICAgIGlmIChnZW9tZXRyaWVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgYXR0cmlidXRlTG9jYXRpb25zID0gR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LmNyZWF0ZUF0dHJpYnV0ZUxvY2F0aW9ucygKICAgICAgICAgICAgICBnZW9tZXRyaWVzWzBdCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmIChwYXJhbWV0ZXJzLmNyZWF0ZVBpY2tPZmZzZXRzKSB7CiAgICAgICAgICAgICAgcGlja09mZnNldHMgPSBjcmVhdGVJbnN0YW5jZVBpY2tPZmZzZXRzKGluc3RhbmNlcywgZ2VvbWV0cmllcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2VzWzBdLmF0dHJpYnV0ZXMpICYmIGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZXNbMF0uYXR0cmlidXRlcy5vZmZzZXQpKSB7CiAgICAgICAgICAgIG9mZnNldEluc3RhbmNlRXh0ZW5kID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgICAgIGhhc09mZnNldCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlcyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlc0NWID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgY29uc3QgaW5zdGFuY2UgPSBpbnN0YW5jZXNbaV07CiAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IGluc3RhbmNlLmdlb21ldHJ5OwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeSkpIHsKICAgICAgICAgICAgYm91bmRpbmdTcGhlcmVzW2ldID0gZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmU7CiAgICAgICAgICAgIGJvdW5kaW5nU3BoZXJlc0NWW2ldID0gZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmVDVjsKICAgICAgICAgICAgaWYgKGhhc09mZnNldCkgewogICAgICAgICAgICAgIG9mZnNldEluc3RhbmNlRXh0ZW5kW2ldID0gaW5zdGFuY2UuZ2VvbWV0cnkub2Zmc2V0QXR0cmlidXRlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBlYXN0SGVtaXNwaGVyZUdlb21ldHJ5ID0gaW5zdGFuY2UuZWFzdEhlbWlzcGhlcmVHZW9tZXRyeTsKICAgICAgICAgIGNvbnN0IHdlc3RIZW1pc3BoZXJlR2VvbWV0cnkgPSBpbnN0YW5jZS53ZXN0SGVtaXNwaGVyZUdlb21ldHJ5OwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChlYXN0SGVtaXNwaGVyZUdlb21ldHJ5KSAmJiBkZWZpbmVkX2RlZmF1bHQod2VzdEhlbWlzcGhlcmVHZW9tZXRyeSkpIHsKICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChlYXN0SGVtaXNwaGVyZUdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlKSAmJiBkZWZpbmVkX2RlZmF1bHQod2VzdEhlbWlzcGhlcmVHZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSkpIHsKICAgICAgICAgICAgICBib3VuZGluZ1NwaGVyZXNbaV0gPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnVuaW9uKAogICAgICAgICAgICAgICAgZWFzdEhlbWlzcGhlcmVHZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSwKICAgICAgICAgICAgICAgIHdlc3RIZW1pc3BoZXJlR2VvbWV0cnkuYm91bmRpbmdTcGhlcmUKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZWFzdEhlbWlzcGhlcmVHZW9tZXRyeS5ib3VuZGluZ1NwaGVyZUNWKSAmJiBkZWZpbmVkX2RlZmF1bHQod2VzdEhlbWlzcGhlcmVHZW9tZXRyeS5ib3VuZGluZ1NwaGVyZUNWKSkgewogICAgICAgICAgICAgIGJvdW5kaW5nU3BoZXJlc0NWW2ldID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC51bmlvbigKICAgICAgICAgICAgICAgIGVhc3RIZW1pc3BoZXJlR2VvbWV0cnkuYm91bmRpbmdTcGhlcmVDViwKICAgICAgICAgICAgICAgIHdlc3RIZW1pc3BoZXJlR2VvbWV0cnkuYm91bmRpbmdTcGhlcmVDVgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGdlb21ldHJpZXMsCiAgICAgICAgICBtb2RlbE1hdHJpeDogcGFyYW1ldGVycy5tb2RlbE1hdHJpeCwKICAgICAgICAgIGF0dHJpYnV0ZUxvY2F0aW9ucywKICAgICAgICAgIHBpY2tPZmZzZXRzLAogICAgICAgICAgb2Zmc2V0SW5zdGFuY2VFeHRlbmQsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZXMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZXNDVgogICAgICAgIH07CiAgICAgIH07CiAgICAgIFByaW1pdGl2ZVBpcGVsaW5lLnBhY2tDcmVhdGVHZW9tZXRyeVJlc3VsdHMgPSBmdW5jdGlvbihpdGVtcywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgICAgIGNvbnN0IHBhY2tlZERhdGEgPSBuZXcgRmxvYXQ2NEFycmF5KGNvdW50Q3JlYXRlR2VvbWV0cnlSZXN1bHRzKGl0ZW1zKSk7CiAgICAgICAgY29uc3Qgc3RyaW5nVGFibGUgPSBbXTsKICAgICAgICBjb25zdCBzdHJpbmdIYXNoID0ge307CiAgICAgICAgY29uc3QgbGVuZ3RoID0gaXRlbXMubGVuZ3RoOwogICAgICAgIGxldCBjb3VudCA9IDA7CiAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IGxlbmd0aDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IGl0ZW1zW2ldOwogICAgICAgICAgY29uc3QgdmFsaWRHZW9tZXRyeSA9IGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeSk7CiAgICAgICAgICBwYWNrZWREYXRhW2NvdW50KytdID0gdmFsaWRHZW9tZXRyeSA/IDEgOiAwOwogICAgICAgICAgaWYgKCF2YWxpZEdlb21ldHJ5KSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IGdlb21ldHJ5LnByaW1pdGl2ZVR5cGU7CiAgICAgICAgICBwYWNrZWREYXRhW2NvdW50KytdID0gZ2VvbWV0cnkuZ2VvbWV0cnlUeXBlOwogICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGdlb21ldHJ5Lm9mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgICAgY29uc3QgdmFsaWRCb3VuZGluZ1NwaGVyZSA9IGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSkgPyAxIDogMDsKICAgICAgICAgIHBhY2tlZERhdGFbY291bnQrK10gPSB2YWxpZEJvdW5kaW5nU3BoZXJlOwogICAgICAgICAgaWYgKHZhbGlkQm91bmRpbmdTcGhlcmUpIHsKICAgICAgICAgICAgQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrKGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlLCBwYWNrZWREYXRhLCBjb3VudCk7CiAgICAgICAgICB9CiAgICAgICAgICBjb3VudCArPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICAgIGNvbnN0IHZhbGlkQm91bmRpbmdTcGhlcmVDViA9IGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZUNWKSA/IDEgOiAwOwogICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IHZhbGlkQm91bmRpbmdTcGhlcmVDVjsKICAgICAgICAgIGlmICh2YWxpZEJvdW5kaW5nU3BoZXJlQ1YpIHsKICAgICAgICAgICAgQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrKGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlQ1YsIHBhY2tlZERhdGEsIGNvdW50KTsKICAgICAgICAgIH0KICAgICAgICAgIGNvdW50ICs9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVzVG9Xcml0ZSA9IFtdOwogICAgICAgICAgZm9yIChjb25zdCBwcm9wZXJ0eSBpbiBhdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgIGlmIChhdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KHByb3BlcnR5KSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlc1twcm9wZXJ0eV0pKSB7CiAgICAgICAgICAgICAgYXR0cmlidXRlc1RvV3JpdGUucHVzaChwcm9wZXJ0eSk7CiAgICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc3RyaW5nSGFzaFtwcm9wZXJ0eV0pKSB7CiAgICAgICAgICAgICAgICBzdHJpbmdIYXNoW3Byb3BlcnR5XSA9IHN0cmluZ1RhYmxlLmxlbmd0aDsKICAgICAgICAgICAgICAgIHN0cmluZ1RhYmxlLnB1c2gocHJvcGVydHkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IGF0dHJpYnV0ZXNUb1dyaXRlLmxlbmd0aDsKICAgICAgICAgIGZvciAobGV0IHEgPSAwOyBxIDwgYXR0cmlidXRlc1RvV3JpdGUubGVuZ3RoOyBxKyspIHsKICAgICAgICAgICAgY29uc3QgbmFtZSA9IGF0dHJpYnV0ZXNUb1dyaXRlW3FdOwogICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGUgPSBhdHRyaWJ1dGVzW25hbWVdOwogICAgICAgICAgICBwYWNrZWREYXRhW2NvdW50KytdID0gc3RyaW5nSGFzaFtuYW1lXTsKICAgICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IGF0dHJpYnV0ZS5jb21wb25lbnREYXRhdHlwZTsKICAgICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IGF0dHJpYnV0ZS5jb21wb25lbnRzUGVyQXR0cmlidXRlOwogICAgICAgICAgICBwYWNrZWREYXRhW2NvdW50KytdID0gYXR0cmlidXRlLm5vcm1hbGl6ZSA/IDEgOiAwOwogICAgICAgICAgICBwYWNrZWREYXRhW2NvdW50KytdID0gYXR0cmlidXRlLnZhbHVlcy5sZW5ndGg7CiAgICAgICAgICAgIHBhY2tlZERhdGEuc2V0KGF0dHJpYnV0ZS52YWx1ZXMsIGNvdW50KTsKICAgICAgICAgICAgY291bnQgKz0gYXR0cmlidXRlLnZhbHVlcy5sZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBpbmRpY2VzTGVuZ3RoID0gZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmluZGljZXMpID8gZ2VvbWV0cnkuaW5kaWNlcy5sZW5ndGggOiAwOwogICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IGluZGljZXNMZW5ndGg7CiAgICAgICAgICBpZiAoaW5kaWNlc0xlbmd0aCA+IDApIHsKICAgICAgICAgICAgcGFja2VkRGF0YS5zZXQoZ2VvbWV0cnkuaW5kaWNlcywgY291bnQpOwogICAgICAgICAgICBjb3VudCArPSBpbmRpY2VzTGVuZ3RoOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2gocGFja2VkRGF0YS5idWZmZXIpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBzdHJpbmdUYWJsZSwKICAgICAgICAgIHBhY2tlZERhdGEKICAgICAgICB9OwogICAgICB9OwogICAgICBQcmltaXRpdmVQaXBlbGluZS51bnBhY2tDcmVhdGVHZW9tZXRyeVJlc3VsdHMgPSBmdW5jdGlvbihjcmVhdGVHZW9tZXRyeVJlc3VsdCkgewogICAgICAgIGNvbnN0IHN0cmluZ1RhYmxlID0gY3JlYXRlR2VvbWV0cnlSZXN1bHQuc3RyaW5nVGFibGU7CiAgICAgICAgY29uc3QgcGFja2VkR2VvbWV0cnkgPSBjcmVhdGVHZW9tZXRyeVJlc3VsdC5wYWNrZWREYXRhOwogICAgICAgIGxldCBpOwogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBBcnJheShwYWNrZWRHZW9tZXRyeVswXSk7CiAgICAgICAgbGV0IHJlc3VsdEluZGV4ID0gMDsKICAgICAgICBsZXQgcGFja2VkR2VvbWV0cnlJbmRleCA9IDE7CiAgICAgICAgd2hpbGUgKHBhY2tlZEdlb21ldHJ5SW5kZXggPCBwYWNrZWRHZW9tZXRyeS5sZW5ndGgpIHsKICAgICAgICAgIGNvbnN0IHZhbGlkID0gcGFja2VkR2VvbWV0cnlbcGFja2VkR2VvbWV0cnlJbmRleCsrXSA9PT0gMTsKICAgICAgICAgIGlmICghdmFsaWQpIHsKICAgICAgICAgICAgcmVzdWx0W3Jlc3VsdEluZGV4KytdID0gdm9pZCAwOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHByaW1pdGl2ZVR5cGUgPSBwYWNrZWRHZW9tZXRyeVtwYWNrZWRHZW9tZXRyeUluZGV4KytdOwogICAgICAgICAgY29uc3QgZ2VvbWV0cnlUeXBlID0gcGFja2VkR2VvbWV0cnlbcGFja2VkR2VvbWV0cnlJbmRleCsrXTsKICAgICAgICAgIGxldCBvZmZzZXRBdHRyaWJ1dGUgPSBwYWNrZWRHZW9tZXRyeVtwYWNrZWRHZW9tZXRyeUluZGV4KytdOwogICAgICAgICAgaWYgKG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEpIHsKICAgICAgICAgICAgb2Zmc2V0QXR0cmlidXRlID0gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgICAgbGV0IGJvdW5kaW5nU3BoZXJlOwogICAgICAgICAgbGV0IGJvdW5kaW5nU3BoZXJlQ1Y7CiAgICAgICAgICBjb25zdCB2YWxpZEJvdW5kaW5nU3BoZXJlID0gcGFja2VkR2VvbWV0cnlbcGFja2VkR2VvbWV0cnlJbmRleCsrXSA9PT0gMTsKICAgICAgICAgIGlmICh2YWxpZEJvdW5kaW5nU3BoZXJlKSB7CiAgICAgICAgICAgIGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICAgICAgcGFja2VkR2VvbWV0cnksCiAgICAgICAgICAgICAgcGFja2VkR2VvbWV0cnlJbmRleAogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgcGFja2VkR2VvbWV0cnlJbmRleCArPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICAgIGNvbnN0IHZhbGlkQm91bmRpbmdTcGhlcmVDViA9IHBhY2tlZEdlb21ldHJ5W3BhY2tlZEdlb21ldHJ5SW5kZXgrK10gPT09IDE7CiAgICAgICAgICBpZiAodmFsaWRCb3VuZGluZ1NwaGVyZUNWKSB7CiAgICAgICAgICAgIGJvdW5kaW5nU3BoZXJlQ1YgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgICBwYWNrZWRHZW9tZXRyeSwKICAgICAgICAgICAgICBwYWNrZWRHZW9tZXRyeUluZGV4CiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICBwYWNrZWRHZW9tZXRyeUluZGV4ICs9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgICAgbGV0IGxlbmd0aDsKICAgICAgICAgIGxldCB2YWx1ZXM7CiAgICAgICAgICBsZXQgY29tcG9uZW50c1BlckF0dHJpYnV0ZTsKICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoKTsKICAgICAgICAgIGNvbnN0IG51bUF0dHJpYnV0ZXMgPSBwYWNrZWRHZW9tZXRyeVtwYWNrZWRHZW9tZXRyeUluZGV4KytdOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IG51bUF0dHJpYnV0ZXM7IGkrKykgewogICAgICAgICAgICBjb25zdCBuYW1lID0gc3RyaW5nVGFibGVbcGFja2VkR2VvbWV0cnlbcGFja2VkR2VvbWV0cnlJbmRleCsrXV07CiAgICAgICAgICAgIGNvbnN0IGNvbXBvbmVudERhdGF0eXBlID0gcGFja2VkR2VvbWV0cnlbcGFja2VkR2VvbWV0cnlJbmRleCsrXTsKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZSA9IHBhY2tlZEdlb21ldHJ5W3BhY2tlZEdlb21ldHJ5SW5kZXgrK107CiAgICAgICAgICAgIGNvbnN0IG5vcm1hbGl6ZSA9IHBhY2tlZEdlb21ldHJ5W3BhY2tlZEdlb21ldHJ5SW5kZXgrK10gIT09IDA7CiAgICAgICAgICAgIGxlbmd0aCA9IHBhY2tlZEdlb21ldHJ5W3BhY2tlZEdlb21ldHJ5SW5kZXgrK107CiAgICAgICAgICAgIHZhbHVlcyA9IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShjb21wb25lbnREYXRhdHlwZSwgbGVuZ3RoKTsKICAgICAgICAgICAgZm9yIChsZXQgdmFsdWVzSW5kZXggPSAwOyB2YWx1ZXNJbmRleCA8IGxlbmd0aDsgdmFsdWVzSW5kZXgrKykgewogICAgICAgICAgICAgIHZhbHVlc1t2YWx1ZXNJbmRleF0gPSBwYWNrZWRHZW9tZXRyeVtwYWNrZWRHZW9tZXRyeUluZGV4KytdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGF0dHJpYnV0ZXNbbmFtZV0gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGUsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZSwKICAgICAgICAgICAgICBub3JtYWxpemUsCiAgICAgICAgICAgICAgdmFsdWVzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgbGV0IGluZGljZXM7CiAgICAgICAgICBsZW5ndGggPSBwYWNrZWRHZW9tZXRyeVtwYWNrZWRHZW9tZXRyeUluZGV4KytdOwogICAgICAgICAgaWYgKGxlbmd0aCA+IDApIHsKICAgICAgICAgICAgY29uc3QgbnVtYmVyT2ZWZXJ0aWNlcyA9IHZhbHVlcy5sZW5ndGggLyBjb21wb25lbnRzUGVyQXR0cmlidXRlOwogICAgICAgICAgICBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobnVtYmVyT2ZWZXJ0aWNlcywgbGVuZ3RoKTsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgaW5kaWNlc1tpXSA9IHBhY2tlZEdlb21ldHJ5W3BhY2tlZEdlb21ldHJ5SW5kZXgrK107CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdFtyZXN1bHRJbmRleCsrXSA9IG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgICAgcHJpbWl0aXZlVHlwZSwKICAgICAgICAgICAgZ2VvbWV0cnlUeXBlLAogICAgICAgICAgICBib3VuZGluZ1NwaGVyZSwKICAgICAgICAgICAgYm91bmRpbmdTcGhlcmVDViwKICAgICAgICAgICAgaW5kaWNlcywKICAgICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgICAgb2Zmc2V0QXR0cmlidXRlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUHJpbWl0aXZlUGlwZWxpbmUucGFja0NvbWJpbmVHZW9tZXRyeVBhcmFtZXRlcnMgPSBmdW5jdGlvbihwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICAgICAgY29uc3QgY3JlYXRlR2VvbWV0cnlSZXN1bHRzID0gcGFyYW1ldGVycy5jcmVhdGVHZW9tZXRyeVJlc3VsdHM7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gY3JlYXRlR2VvbWV0cnlSZXN1bHRzLmxlbmd0aDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2goY3JlYXRlR2VvbWV0cnlSZXN1bHRzW2ldLnBhY2tlZERhdGEuYnVmZmVyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGNyZWF0ZUdlb21ldHJ5UmVzdWx0czogcGFyYW1ldGVycy5jcmVhdGVHZW9tZXRyeVJlc3VsdHMsCiAgICAgICAgICBwYWNrZWRJbnN0YW5jZXM6IHBhY2tJbnN0YW5jZXNGb3JDb21iaW5lKAogICAgICAgICAgICBwYXJhbWV0ZXJzLmluc3RhbmNlcywKICAgICAgICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cwogICAgICAgICAgKSwKICAgICAgICAgIGVsbGlwc29pZDogcGFyYW1ldGVycy5lbGxpcHNvaWQsCiAgICAgICAgICBpc0dlb2dyYXBoaWM6IHBhcmFtZXRlcnMucHJvamVjdGlvbiBpbnN0YW5jZW9mIEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQsCiAgICAgICAgICBlbGVtZW50SW5kZXhVaW50U3VwcG9ydGVkOiBwYXJhbWV0ZXJzLmVsZW1lbnRJbmRleFVpbnRTdXBwb3J0ZWQsCiAgICAgICAgICBzY2VuZTNET25seTogcGFyYW1ldGVycy5zY2VuZTNET25seSwKICAgICAgICAgIHZlcnRleENhY2hlT3B0aW1pemU6IHBhcmFtZXRlcnMudmVydGV4Q2FjaGVPcHRpbWl6ZSwKICAgICAgICAgIGNvbXByZXNzVmVydGljZXM6IHBhcmFtZXRlcnMuY29tcHJlc3NWZXJ0aWNlcywKICAgICAgICAgIG1vZGVsTWF0cml4OiBwYXJhbWV0ZXJzLm1vZGVsTWF0cml4LAogICAgICAgICAgY3JlYXRlUGlja09mZnNldHM6IHBhcmFtZXRlcnMuY3JlYXRlUGlja09mZnNldHMKICAgICAgICB9OwogICAgICB9OwogICAgICBQcmltaXRpdmVQaXBlbGluZS51bnBhY2tDb21iaW5lR2VvbWV0cnlQYXJhbWV0ZXJzID0gZnVuY3Rpb24ocGFja2VkUGFyYW1ldGVycykgewogICAgICAgIGNvbnN0IGluc3RhbmNlcyA9IHVucGFja0luc3RhbmNlc0ZvckNvbWJpbmUocGFja2VkUGFyYW1ldGVycy5wYWNrZWRJbnN0YW5jZXMpOwogICAgICAgIGNvbnN0IGNyZWF0ZUdlb21ldHJ5UmVzdWx0cyA9IHBhY2tlZFBhcmFtZXRlcnMuY3JlYXRlR2VvbWV0cnlSZXN1bHRzOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNyZWF0ZUdlb21ldHJ5UmVzdWx0cy5sZW5ndGg7CiAgICAgICAgbGV0IGluc3RhbmNlSW5kZXggPSAwOwogICAgICAgIGZvciAobGV0IHJlc3VsdEluZGV4ID0gMDsgcmVzdWx0SW5kZXggPCBsZW5ndGg7IHJlc3VsdEluZGV4KyspIHsKICAgICAgICAgIGNvbnN0IGdlb21ldHJpZXMgPSBQcmltaXRpdmVQaXBlbGluZS51bnBhY2tDcmVhdGVHZW9tZXRyeVJlc3VsdHMoCiAgICAgICAgICAgIGNyZWF0ZUdlb21ldHJ5UmVzdWx0c1tyZXN1bHRJbmRleF0KICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBnZW9tZXRyaWVzTGVuZ3RoID0gZ2VvbWV0cmllcy5sZW5ndGg7CiAgICAgICAgICBmb3IgKGxldCBnZW9tZXRyeUluZGV4ID0gMDsgZ2VvbWV0cnlJbmRleCA8IGdlb21ldHJpZXNMZW5ndGg7IGdlb21ldHJ5SW5kZXgrKykgewogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IGdlb21ldHJpZXNbZ2VvbWV0cnlJbmRleF07CiAgICAgICAgICAgIGNvbnN0IGluc3RhbmNlID0gaW5zdGFuY2VzW2luc3RhbmNlSW5kZXhdOwogICAgICAgICAgICBpbnN0YW5jZS5nZW9tZXRyeSA9IGdlb21ldHJ5OwogICAgICAgICAgICArK2luc3RhbmNlSW5kZXg7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKHBhY2tlZFBhcmFtZXRlcnMuZWxsaXBzb2lkKTsKICAgICAgICBjb25zdCBwcm9qZWN0aW9uID0gcGFja2VkUGFyYW1ldGVycy5pc0dlb2dyYXBoaWMgPyBuZXcgR2VvZ3JhcGhpY1Byb2plY3Rpb25fZGVmYXVsdChlbGxpcHNvaWQpIDogbmV3IFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0KGVsbGlwc29pZCk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGluc3RhbmNlcywKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHByb2plY3Rpb24sCiAgICAgICAgICBlbGVtZW50SW5kZXhVaW50U3VwcG9ydGVkOiBwYWNrZWRQYXJhbWV0ZXJzLmVsZW1lbnRJbmRleFVpbnRTdXBwb3J0ZWQsCiAgICAgICAgICBzY2VuZTNET25seTogcGFja2VkUGFyYW1ldGVycy5zY2VuZTNET25seSwKICAgICAgICAgIHZlcnRleENhY2hlT3B0aW1pemU6IHBhY2tlZFBhcmFtZXRlcnMudmVydGV4Q2FjaGVPcHRpbWl6ZSwKICAgICAgICAgIGNvbXByZXNzVmVydGljZXM6IHBhY2tlZFBhcmFtZXRlcnMuY29tcHJlc3NWZXJ0aWNlcywKICAgICAgICAgIG1vZGVsTWF0cml4OiBNYXRyaXg0X2RlZmF1bHQuY2xvbmUocGFja2VkUGFyYW1ldGVycy5tb2RlbE1hdHJpeCksCiAgICAgICAgICBjcmVhdGVQaWNrT2Zmc2V0czogcGFja2VkUGFyYW1ldGVycy5jcmVhdGVQaWNrT2Zmc2V0cwogICAgICAgIH07CiAgICAgIH07CiAgICAgIFByaW1pdGl2ZVBpcGVsaW5lLnBhY2tDb21iaW5lR2VvbWV0cnlSZXN1bHRzID0gZnVuY3Rpb24ocmVzdWx0cywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVzdWx0cy5nZW9tZXRyaWVzKSkgewogICAgICAgICAgdHJhbnNmZXJHZW9tZXRyaWVzKHJlc3VsdHMuZ2VvbWV0cmllcywgdHJhbnNmZXJhYmxlT2JqZWN0cyk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBhY2tlZEJvdW5kaW5nU3BoZXJlcyA9IHBhY2tCb3VuZGluZ1NwaGVyZXMocmVzdWx0cy5ib3VuZGluZ1NwaGVyZXMpOwogICAgICAgIGNvbnN0IHBhY2tlZEJvdW5kaW5nU3BoZXJlc0NWID0gcGFja0JvdW5kaW5nU3BoZXJlcygKICAgICAgICAgIHJlc3VsdHMuYm91bmRpbmdTcGhlcmVzQ1YKICAgICAgICApOwogICAgICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaCgKICAgICAgICAgIHBhY2tlZEJvdW5kaW5nU3BoZXJlcy5idWZmZXIsCiAgICAgICAgICBwYWNrZWRCb3VuZGluZ1NwaGVyZXNDVi5idWZmZXIKICAgICAgICApOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBnZW9tZXRyaWVzOiByZXN1bHRzLmdlb21ldHJpZXMsCiAgICAgICAgICBhdHRyaWJ1dGVMb2NhdGlvbnM6IHJlc3VsdHMuYXR0cmlidXRlTG9jYXRpb25zLAogICAgICAgICAgbW9kZWxNYXRyaXg6IHJlc3VsdHMubW9kZWxNYXRyaXgsCiAgICAgICAgICBwaWNrT2Zmc2V0czogcmVzdWx0cy5waWNrT2Zmc2V0cywKICAgICAgICAgIG9mZnNldEluc3RhbmNlRXh0ZW5kOiByZXN1bHRzLm9mZnNldEluc3RhbmNlRXh0ZW5kLAogICAgICAgICAgYm91bmRpbmdTcGhlcmVzOiBwYWNrZWRCb3VuZGluZ1NwaGVyZXMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZXNDVjogcGFja2VkQm91bmRpbmdTcGhlcmVzQ1YKICAgICAgICB9OwogICAgICB9OwogICAgICBQcmltaXRpdmVQaXBlbGluZS51bnBhY2tDb21iaW5lR2VvbWV0cnlSZXN1bHRzID0gZnVuY3Rpb24ocGFja2VkUmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGdlb21ldHJpZXM6IHBhY2tlZFJlc3VsdC5nZW9tZXRyaWVzLAogICAgICAgICAgYXR0cmlidXRlTG9jYXRpb25zOiBwYWNrZWRSZXN1bHQuYXR0cmlidXRlTG9jYXRpb25zLAogICAgICAgICAgbW9kZWxNYXRyaXg6IHBhY2tlZFJlc3VsdC5tb2RlbE1hdHJpeCwKICAgICAgICAgIHBpY2tPZmZzZXRzOiBwYWNrZWRSZXN1bHQucGlja09mZnNldHMsCiAgICAgICAgICBvZmZzZXRJbnN0YW5jZUV4dGVuZDogcGFja2VkUmVzdWx0Lm9mZnNldEluc3RhbmNlRXh0ZW5kLAogICAgICAgICAgYm91bmRpbmdTcGhlcmVzOiB1bnBhY2tCb3VuZGluZ1NwaGVyZXMocGFja2VkUmVzdWx0LmJvdW5kaW5nU3BoZXJlcyksCiAgICAgICAgICBib3VuZGluZ1NwaGVyZXNDVjogdW5wYWNrQm91bmRpbmdTcGhlcmVzKHBhY2tlZFJlc3VsdC5ib3VuZGluZ1NwaGVyZXNDVikKICAgICAgICB9OwogICAgICB9OwogICAgICBQcmltaXRpdmVQaXBlbGluZV9kZWZhdWx0ID0gUHJpbWl0aXZlUGlwZWxpbmU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9mb3JtYXRFcnJvci5qcwogIGZ1bmN0aW9uIGZvcm1hdEVycm9yKG9iamVjdCkgewogICAgbGV0IHJlc3VsdDsKICAgIGNvbnN0IG5hbWUgPSBvYmplY3QubmFtZTsKICAgIGNvbnN0IG1lc3NhZ2UgPSBvYmplY3QubWVzc2FnZTsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobmFtZSkgJiYgZGVmaW5lZF9kZWZhdWx0KG1lc3NhZ2UpKSB7CiAgICAgIHJlc3VsdCA9IGAke25hbWV9OiAke21lc3NhZ2V9YDsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdCA9IG9iamVjdC50b1N0cmluZygpOwogICAgfQogICAgY29uc3Qgc3RhY2sgPSBvYmplY3Quc3RhY2s7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHN0YWNrKSkgewogICAgICByZXN1bHQgKz0gYAoke3N0YWNrfWA7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICB2YXIgZm9ybWF0RXJyb3JfZGVmYXVsdDsKICB2YXIgaW5pdF9mb3JtYXRFcnJvciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvZm9ybWF0RXJyb3IuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgZm9ybWF0RXJyb3JfZGVmYXVsdCA9IGZvcm1hdEVycm9yOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlci5qcwogIHZhciBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIod29ya2VyRnVuY3Rpb24pIHsKICAgIGFzeW5jIGZ1bmN0aW9uIG9uTWVzc2FnZUhhbmRsZXIoeyBkYXRhIH0pIHsKICAgICAgY29uc3QgdHJhbnNmZXJhYmxlT2JqZWN0cyA9IFtdOwogICAgICBjb25zdCByZXNwb25zZU1lc3NhZ2UgPSB7CiAgICAgICAgaWQ6IGRhdGEuaWQsCiAgICAgICAgcmVzdWx0OiB2b2lkIDAsCiAgICAgICAgZXJyb3I6IHZvaWQgMAogICAgICB9OwogICAgICBzZWxmLkNFU0lVTV9CQVNFX1VSTCA9IGRhdGEuYmFzZVVybDsKICAgICAgdHJ5IHsKICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB3b3JrZXJGdW5jdGlvbihkYXRhLnBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpOwogICAgICAgIHJlc3BvbnNlTWVzc2FnZS5yZXN1bHQgPSByZXN1bHQ7CiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICAgIHJlc3BvbnNlTWVzc2FnZS5lcnJvciA9IHsKICAgICAgICAgICAgbmFtZTogZXJyb3IubmFtZSwKICAgICAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSwKICAgICAgICAgICAgc3RhY2s6IGVycm9yLnN0YWNrCiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXNwb25zZU1lc3NhZ2UuZXJyb3IgPSBlcnJvcjsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKCFkYXRhLmNhblRyYW5zZmVyQXJyYXlCdWZmZXIpIHsKICAgICAgICB0cmFuc2ZlcmFibGVPYmplY3RzLmxlbmd0aCA9IDA7CiAgICAgIH0KICAgICAgdHJ5IHsKICAgICAgICBwb3N0TWVzc2FnZShyZXNwb25zZU1lc3NhZ2UsIHRyYW5zZmVyYWJsZU9iamVjdHMpOwogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIHJlc3BvbnNlTWVzc2FnZS5yZXN1bHQgPSB2b2lkIDA7CiAgICAgICAgcmVzcG9uc2VNZXNzYWdlLmVycm9yID0gYHBvc3RNZXNzYWdlIGZhaWxlZCB3aXRoIGVycm9yOiAke2Zvcm1hdEVycm9yX2RlZmF1bHQoCiAgICAgICAgICBlcnJvcgogICAgICAgICl9CiAgd2l0aCByZXNwb25zZU1lc3NhZ2U6ICR7SlNPTi5zdHJpbmdpZnkocmVzcG9uc2VNZXNzYWdlKX1gOwogICAgICAgIHBvc3RNZXNzYWdlKHJlc3BvbnNlTWVzc2FnZSk7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIG9uTWVzc2FnZUVycm9ySGFuZGxlcihldmVudCkgewogICAgICBwb3N0TWVzc2FnZSh7CiAgICAgICAgaWQ6IGV2ZW50LmRhdGE/LmlkLAogICAgICAgIGVycm9yOiBgcG9zdE1lc3NhZ2UgZmFpbGVkIHdpdGggZXJyb3I6ICR7SlNPTi5zdHJpbmdpZnkoZXZlbnQpfWAKICAgICAgfSk7CiAgICB9CiAgICBzZWxmLm9ubWVzc2FnZSA9IG9uTWVzc2FnZUhhbmRsZXI7CiAgICBzZWxmLm9ubWVzc2FnZWVycm9yID0gb25NZXNzYWdlRXJyb3JIYW5kbGVyOwogICAgcmV0dXJuIHNlbGY7CiAgfQogIHZhciBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlci5qcyIoKSB7CiAgICAgIGluaXRfZm9ybWF0RXJyb3IoKTsKICAgICAgY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0ID0gY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NvbWJpbmVHZW9tZXRyeS5qcwogIHZhciBjb21iaW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNvbWJpbmVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjb21iaW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNvbWJpbmVHZW9tZXRyeShwYWNrZWRQYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBjb25zdCBwYXJhbWV0ZXJzID0gUHJpbWl0aXZlUGlwZWxpbmVfZGVmYXVsdC51bnBhY2tDb21iaW5lR2VvbWV0cnlQYXJhbWV0ZXJzKAogICAgICBwYWNrZWRQYXJhbWV0ZXJzCiAgICApOwogICAgY29uc3QgcmVzdWx0cyA9IFByaW1pdGl2ZVBpcGVsaW5lX2RlZmF1bHQuY29tYmluZUdlb21ldHJ5KHBhcmFtZXRlcnMpOwogICAgcmV0dXJuIFByaW1pdGl2ZVBpcGVsaW5lX2RlZmF1bHQucGFja0NvbWJpbmVHZW9tZXRyeVJlc3VsdHMoCiAgICAgIHJlc3VsdHMsCiAgICAgIHRyYW5zZmVyYWJsZU9iamVjdHMKICAgICk7CiAgfQogIHZhciBjb21iaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jb21iaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NvbWJpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfUHJpbWl0aXZlUGlwZWxpbmUoKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIGNvbWJpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0KGNvbWJpbmVHZW9tZXRyeSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZS5qcwogIHZhciBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSwgR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdDsKICB2YXIgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUuanMiKCkgewogICAgICBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSA9IHsKICAgICAgICBOT05FOiAwLAogICAgICAgIFRPUDogMSwKICAgICAgICBBTEw6IDIKICAgICAgfTsKICAgICAgR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVmVydGV4Rm9ybWF0LmpzCiAgZnVuY3Rpb24gVmVydGV4Rm9ybWF0KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgdGhpcy5wb3NpdGlvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMucG9zaXRpb24sIGZhbHNlKTsKICAgIHRoaXMubm9ybWFsID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5ub3JtYWwsIGZhbHNlKTsKICAgIHRoaXMuc3QgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnN0LCBmYWxzZSk7CiAgICB0aGlzLmJpdGFuZ2VudCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuYml0YW5nZW50LCBmYWxzZSk7CiAgICB0aGlzLnRhbmdlbnQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnRhbmdlbnQsIGZhbHNlKTsKICAgIHRoaXMuY29sb3IgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmNvbG9yLCBmYWxzZSk7CiAgfQogIHZhciBWZXJ0ZXhGb3JtYXRfZGVmYXVsdDsKICB2YXIgaW5pdF9WZXJ0ZXhGb3JtYXQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1ZlcnRleEZvcm1hdC5qcyIoKSB7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIFZlcnRleEZvcm1hdC5QT1NJVElPTl9PTkxZID0gT2JqZWN0LmZyZWV6ZSgKICAgICAgICBuZXcgVmVydGV4Rm9ybWF0KHsKICAgICAgICAgIHBvc2l0aW9uOiB0cnVlCiAgICAgICAgfSkKICAgICAgKTsKICAgICAgVmVydGV4Rm9ybWF0LlBPU0lUSU9OX0FORF9OT1JNQUwgPSBPYmplY3QuZnJlZXplKAogICAgICAgIG5ldyBWZXJ0ZXhGb3JtYXQoewogICAgICAgICAgcG9zaXRpb246IHRydWUsCiAgICAgICAgICBub3JtYWw6IHRydWUKICAgICAgICB9KQogICAgICApOwogICAgICBWZXJ0ZXhGb3JtYXQuUE9TSVRJT05fTk9STUFMX0FORF9TVCA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IFZlcnRleEZvcm1hdCh7CiAgICAgICAgICBwb3NpdGlvbjogdHJ1ZSwKICAgICAgICAgIG5vcm1hbDogdHJ1ZSwKICAgICAgICAgIHN0OiB0cnVlCiAgICAgICAgfSkKICAgICAgKTsKICAgICAgVmVydGV4Rm9ybWF0LlBPU0lUSU9OX0FORF9TVCA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IFZlcnRleEZvcm1hdCh7CiAgICAgICAgICBwb3NpdGlvbjogdHJ1ZSwKICAgICAgICAgIHN0OiB0cnVlCiAgICAgICAgfSkKICAgICAgKTsKICAgICAgVmVydGV4Rm9ybWF0LlBPU0lUSU9OX0FORF9DT0xPUiA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IFZlcnRleEZvcm1hdCh7CiAgICAgICAgICBwb3NpdGlvbjogdHJ1ZSwKICAgICAgICAgIGNvbG9yOiB0cnVlCiAgICAgICAgfSkKICAgICAgKTsKICAgICAgVmVydGV4Rm9ybWF0LkFMTCA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IFZlcnRleEZvcm1hdCh7CiAgICAgICAgICBwb3NpdGlvbjogdHJ1ZSwKICAgICAgICAgIG5vcm1hbDogdHJ1ZSwKICAgICAgICAgIHN0OiB0cnVlLAogICAgICAgICAgdGFuZ2VudDogdHJ1ZSwKICAgICAgICAgIGJpdGFuZ2VudDogdHJ1ZQogICAgICAgIH0pCiAgICAgICk7CiAgICAgIFZlcnRleEZvcm1hdC5ERUZBVUxUID0gVmVydGV4Rm9ybWF0LlBPU0lUSU9OX05PUk1BTF9BTkRfU1Q7CiAgICAgIFZlcnRleEZvcm1hdC5wYWNrZWRMZW5ndGggPSA2OwogICAgICBWZXJ0ZXhGb3JtYXQucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZhbHVlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInZhbHVlIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUucG9zaXRpb24gPyAxIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUubm9ybWFsID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLnN0ID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLnRhbmdlbnQgPyAxIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuYml0YW5nZW50ID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5jb2xvciA/IDEgOiAwOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgVmVydGV4Rm9ybWF0LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFZlcnRleEZvcm1hdCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQucG9zaXRpb24gPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIHJlc3VsdC5ub3JtYWwgPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIHJlc3VsdC5zdCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPT09IDE7CiAgICAgICAgcmVzdWx0LnRhbmdlbnQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIHJlc3VsdC5iaXRhbmdlbnQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIHJlc3VsdC5jb2xvciA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdID09PSAxOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFZlcnRleEZvcm1hdC5jbG9uZSA9IGZ1bmN0aW9uKHZlcnRleEZvcm1hdCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmVydGV4Rm9ybWF0KSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFZlcnRleEZvcm1hdCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQucG9zaXRpb24gPSB2ZXJ0ZXhGb3JtYXQucG9zaXRpb247CiAgICAgICAgcmVzdWx0Lm5vcm1hbCA9IHZlcnRleEZvcm1hdC5ub3JtYWw7CiAgICAgICAgcmVzdWx0LnN0ID0gdmVydGV4Rm9ybWF0LnN0OwogICAgICAgIHJlc3VsdC50YW5nZW50ID0gdmVydGV4Rm9ybWF0LnRhbmdlbnQ7CiAgICAgICAgcmVzdWx0LmJpdGFuZ2VudCA9IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQ7CiAgICAgICAgcmVzdWx0LmNvbG9yID0gdmVydGV4Rm9ybWF0LmNvbG9yOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFZlcnRleEZvcm1hdF9kZWZhdWx0ID0gVmVydGV4Rm9ybWF0OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQm94R2VvbWV0cnkuanMKICBmdW5jdGlvbiBCb3hHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IG1pbjMgPSBvcHRpb25zLm1pbmltdW07CiAgICBjb25zdCBtYXgzID0gb3B0aW9ucy5tYXhpbXVtOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtaW4iLCBtaW4zKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF4IiwgbWF4Myk7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlKSAmJiBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5UT1ApIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIkdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlLlRPUCBpcyBub3QgYSBzdXBwb3J0ZWQgb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgZm9yIHRoaXMgZ2VvbWV0cnkuIgogICAgICApOwogICAgfQogICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy52ZXJ0ZXhGb3JtYXQsIFZlcnRleEZvcm1hdF9kZWZhdWx0LkRFRkFVTFQpOwogICAgdGhpcy5fbWluaW11bSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShtaW4zKTsKICAgIHRoaXMuX21heGltdW0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUobWF4Myk7CiAgICB0aGlzLl92ZXJ0ZXhGb3JtYXQgPSB2ZXJ0ZXhGb3JtYXQ7CiAgICB0aGlzLl9vZmZzZXRBdHRyaWJ1dGUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlQm94R2VvbWV0cnkiOwogIH0KICB2YXIgZGlmZlNjcmF0Y2gsIHNjcmF0Y2hNaW4sIHNjcmF0Y2hNYXgsIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQsIHNjcmF0Y2hPcHRpb25zLCB1bml0Qm94R2VvbWV0cnksIEJveEdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfQm94R2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0JveEdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5T2Zmc2V0QXR0cmlidXRlKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1ZlcnRleEZvcm1hdCgpOwogICAgICBkaWZmU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgQm94R2VvbWV0cnkuZnJvbURpbWVuc2lvbnMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICAgICAgY29uc3QgZGltZW5zaW9ucyA9IG9wdGlvbnMuZGltZW5zaW9uczsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImRpbWVuc2lvbnMiLCBkaW1lbnNpb25zKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiZGltZW5zaW9ucy54IiwgZGltZW5zaW9ucy54LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiZGltZW5zaW9ucy55IiwgZGltZW5zaW9ucy55LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiZGltZW5zaW9ucy56IiwgZGltZW5zaW9ucy56LCAwKTsKICAgICAgICBjb25zdCBjb3JuZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihkaW1lbnNpb25zLCAwLjUsIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSk7CiAgICAgICAgcmV0dXJuIG5ldyBCb3hHZW9tZXRyeSh7CiAgICAgICAgICBtaW5pbXVtOiBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGNvcm5lciwgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpKSwKICAgICAgICAgIG1heGltdW06IGNvcm5lciwKICAgICAgICAgIHZlcnRleEZvcm1hdDogb3B0aW9ucy52ZXJ0ZXhGb3JtYXQsCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEJveEdlb21ldHJ5LmZyb21BeGlzQWxpZ25lZEJvdW5kaW5nQm94ID0gZnVuY3Rpb24oYm91bmRpbmdCb3gpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImJvdW5kaW5nQm94IiwgYm91bmRpbmdCb3gpOwogICAgICAgIHJldHVybiBuZXcgQm94R2VvbWV0cnkoewogICAgICAgICAgbWluaW11bTogYm91bmRpbmdCb3gubWluaW11bSwKICAgICAgICAgIG1heGltdW06IGJvdW5kaW5nQm94Lm1heGltdW0KICAgICAgICB9KTsKICAgICAgfTsKICAgICAgQm94R2VvbWV0cnkucGFja2VkTGVuZ3RoID0gMiAqIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAxOwogICAgICBCb3hHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2YWx1ZS5fbWluaW11bSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKAogICAgICAgICAgdmFsdWUuX21heGltdW0sCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggKyBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoCiAgICAgICAgKTsKICAgICAgICBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrKAogICAgICAgICAgdmFsdWUuX3ZlcnRleEZvcm1hdCwKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCArIDIgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoCiAgICAgICAgKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4ICsgMiAqIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGhdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmFsdWUuX29mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaE1pbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE1heCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdCA9IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoT3B0aW9ucyA9IHsKICAgICAgICBtaW5pbXVtOiBzY3JhdGNoTWluLAogICAgICAgIG1heGltdW06IHNjcmF0Y2hNYXgsCiAgICAgICAgdmVydGV4Rm9ybWF0OiBzY3JhdGNoVmVydGV4Rm9ybWF0LAogICAgICAgIG9mZnNldEF0dHJpYnV0ZTogdm9pZCAwCiAgICAgIH07CiAgICAgIEJveEdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBtaW4zID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaE1pbik7CiAgICAgICAgY29uc3QgbWF4MyA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggKyBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoLAogICAgICAgICAgc2NyYXRjaE1heAogICAgICAgICk7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4ICsgMiAqIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgsCiAgICAgICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0CiAgICAgICAgKTsKICAgICAgICBjb25zdCBvZmZzZXRBdHRyaWJ1dGUgPSBhcnJheVtzdGFydGluZ0luZGV4ICsgMiAqIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGhdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgICByZXR1cm4gbmV3IEJveEdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9taW5pbXVtID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG1pbjMsIHJlc3VsdC5fbWluaW11bSk7CiAgICAgICAgcmVzdWx0Ll9tYXhpbXVtID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG1heDMsIHJlc3VsdC5fbWF4aW11bSk7CiAgICAgICAgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSh2ZXJ0ZXhGb3JtYXQsIHJlc3VsdC5fdmVydGV4Rm9ybWF0KTsKICAgICAgICByZXN1bHQuX29mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQm94R2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihib3hHZW9tZXRyeSkgewogICAgICAgIGNvbnN0IG1pbjMgPSBib3hHZW9tZXRyeS5fbWluaW11bTsKICAgICAgICBjb25zdCBtYXgzID0gYm94R2VvbWV0cnkuX21heGltdW07CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gYm94R2VvbWV0cnkuX3ZlcnRleEZvcm1hdDsKICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhtaW4zLCBtYXgzKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICAgICAgbGV0IGluZGljZXM7CiAgICAgICAgbGV0IHBvc2l0aW9uczsKICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnBvc2l0aW9uICYmICh2ZXJ0ZXhGb3JtYXQuc3QgfHwgdmVydGV4Rm9ybWF0Lm5vcm1hbCB8fCB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSkgewogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICAgICAgICBwb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KDYgKiA0ICogMyk7CiAgICAgICAgICAgIHBvc2l0aW9uc1swXSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzFdID0gbWluMy55OwogICAgICAgICAgICBwb3NpdGlvbnNbMl0gPSBtYXgzLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1szXSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzRdID0gbWluMy55OwogICAgICAgICAgICBwb3NpdGlvbnNbNV0gPSBtYXgzLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s2XSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzddID0gbWF4My55OwogICAgICAgICAgICBwb3NpdGlvbnNbOF0gPSBtYXgzLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s5XSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzEwXSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzExXSA9IG1heDMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzEyXSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzEzXSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzE0XSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzE1XSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzE2XSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzE3XSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzE4XSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzE5XSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzIwXSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzIxXSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzIyXSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzIzXSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzI0XSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzI1XSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzI2XSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzI3XSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzI4XSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzI5XSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzMwXSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzMxXSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzMyXSA9IG1heDMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzMzXSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzM0XSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzM1XSA9IG1heDMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzM2XSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzM3XSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzM4XSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzM5XSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzQwXSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzQxXSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzQyXSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzQzXSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzQ0XSA9IG1heDMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzQ1XSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzQ2XSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzQ3XSA9IG1heDMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzQ4XSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzQ5XSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzUwXSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzUxXSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzUyXSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzUzXSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzU0XSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzU1XSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzU2XSA9IG1heDMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzU3XSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzU4XSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzU5XSA9IG1heDMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzYwXSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzYxXSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzYyXSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzYzXSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzY0XSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzY1XSA9IG1pbjMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzY2XSA9IG1heDMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzY3XSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzY4XSA9IG1heDMuejsKICAgICAgICAgICAgcG9zaXRpb25zWzY5XSA9IG1pbjMueDsKICAgICAgICAgICAgcG9zaXRpb25zWzcwXSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzcxXSA9IG1heDMuejsKICAgICAgICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IHBvc2l0aW9ucwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICAgIGNvbnN0IG5vcm1hbHMgPSBuZXcgRmxvYXQzMkFycmF5KDYgKiA0ICogMyk7CiAgICAgICAgICAgIG5vcm1hbHNbMF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzFdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1syXSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbM10gPSAwOwogICAgICAgICAgICBub3JtYWxzWzRdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s1XSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbNl0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzddID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s4XSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbOV0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzEwXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMTFdID0gMTsKICAgICAgICAgICAgbm9ybWFsc1sxMl0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzEzXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMTRdID0gLTE7CiAgICAgICAgICAgIG5vcm1hbHNbMTVdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1sxNl0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzE3XSA9IC0xOwogICAgICAgICAgICBub3JtYWxzWzE4XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMTldID0gMDsKICAgICAgICAgICAgbm9ybWFsc1syMF0gPSAtMTsKICAgICAgICAgICAgbm9ybWFsc1syMV0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzIyXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMjNdID0gLTE7CiAgICAgICAgICAgIG5vcm1hbHNbMjRdID0gMTsKICAgICAgICAgICAgbm9ybWFsc1syNV0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzI2XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMjddID0gMTsKICAgICAgICAgICAgbm9ybWFsc1syOF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzI5XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMzBdID0gMTsKICAgICAgICAgICAgbm9ybWFsc1szMV0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzMyXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMzNdID0gMTsKICAgICAgICAgICAgbm9ybWFsc1szNF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzM1XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMzZdID0gLTE7CiAgICAgICAgICAgIG5vcm1hbHNbMzddID0gMDsKICAgICAgICAgICAgbm9ybWFsc1szOF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzM5XSA9IC0xOwogICAgICAgICAgICBub3JtYWxzWzQwXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNDFdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s0Ml0gPSAtMTsKICAgICAgICAgICAgbm9ybWFsc1s0M10gPSAwOwogICAgICAgICAgICBub3JtYWxzWzQ0XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNDVdID0gLTE7CiAgICAgICAgICAgIG5vcm1hbHNbNDZdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s0N10gPSAwOwogICAgICAgICAgICBub3JtYWxzWzQ4XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNDldID0gMTsKICAgICAgICAgICAgbm9ybWFsc1s1MF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzUxXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNTJdID0gMTsKICAgICAgICAgICAgbm9ybWFsc1s1M10gPSAwOwogICAgICAgICAgICBub3JtYWxzWzU0XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNTVdID0gMTsKICAgICAgICAgICAgbm9ybWFsc1s1Nl0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzU3XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNThdID0gMTsKICAgICAgICAgICAgbm9ybWFsc1s1OV0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzYwXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNjFdID0gLTE7CiAgICAgICAgICAgIG5vcm1hbHNbNjJdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s2M10gPSAwOwogICAgICAgICAgICBub3JtYWxzWzY0XSA9IC0xOwogICAgICAgICAgICBub3JtYWxzWzY1XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNjZdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s2N10gPSAtMTsKICAgICAgICAgICAgbm9ybWFsc1s2OF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzY5XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNzBdID0gLTE7CiAgICAgICAgICAgIG5vcm1hbHNbNzFdID0gMDsKICAgICAgICAgICAgYXR0cmlidXRlcy5ub3JtYWwgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IG5vcm1hbHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgICAgIGNvbnN0IHRleENvb3JkcyA9IG5ldyBGbG9hdDMyQXJyYXkoNiAqIDQgKiAyKTsKICAgICAgICAgICAgdGV4Q29vcmRzWzBdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzFdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzJdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzNdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzRdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzVdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzZdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzddID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzhdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzldID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzEwXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1sxMV0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMTJdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzEzXSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1sxNF0gPSAxOwogICAgICAgICAgICB0ZXhDb29yZHNbMTVdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzE2XSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1sxN10gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMThdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzE5XSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1syMF0gPSAxOwogICAgICAgICAgICB0ZXhDb29yZHNbMjFdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzIyXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1syM10gPSAxOwogICAgICAgICAgICB0ZXhDb29yZHNbMjRdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzI1XSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1syNl0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMjddID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzI4XSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1syOV0gPSAxOwogICAgICAgICAgICB0ZXhDb29yZHNbMzBdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzMxXSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1szMl0gPSAxOwogICAgICAgICAgICB0ZXhDb29yZHNbMzNdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzM0XSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1szNV0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMzZdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzM3XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1szOF0gPSAxOwogICAgICAgICAgICB0ZXhDb29yZHNbMzldID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzQwXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1s0MV0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbNDJdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzQzXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1s0NF0gPSAxOwogICAgICAgICAgICB0ZXhDb29yZHNbNDVdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzQ2XSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1s0N10gPSAxOwogICAgICAgICAgICBhdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgICAgICAgdmFsdWVzOiB0ZXhDb29yZHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICAgICAgY29uc3QgdGFuZ2VudHMgPSBuZXcgRmxvYXQzMkFycmF5KDYgKiA0ICogMyk7CiAgICAgICAgICAgIHRhbmdlbnRzWzBdID0gMTsKICAgICAgICAgICAgdGFuZ2VudHNbMV0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1syXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzNdID0gMTsKICAgICAgICAgICAgdGFuZ2VudHNbNF0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s1XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzZdID0gMTsKICAgICAgICAgICAgdGFuZ2VudHNbN10gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s4XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzldID0gMTsKICAgICAgICAgICAgdGFuZ2VudHNbMTBdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbMTFdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbMTJdID0gLTE7CiAgICAgICAgICAgIHRhbmdlbnRzWzEzXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzE0XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzE1XSA9IC0xOwogICAgICAgICAgICB0YW5nZW50c1sxNl0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1sxN10gPSAwOwogICAgICAgICAgICB0YW5nZW50c1sxOF0gPSAtMTsKICAgICAgICAgICAgdGFuZ2VudHNbMTldID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbMjBdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbMjFdID0gLTE7CiAgICAgICAgICAgIHRhbmdlbnRzWzIyXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzIzXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzI0XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzI1XSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzI2XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzI3XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzI4XSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzI5XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzMwXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzMxXSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzMyXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzMzXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzM0XSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzM1XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzM2XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzM3XSA9IC0xOwogICAgICAgICAgICB0YW5nZW50c1szOF0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1szOV0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s0MF0gPSAtMTsKICAgICAgICAgICAgdGFuZ2VudHNbNDFdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNDJdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNDNdID0gLTE7CiAgICAgICAgICAgIHRhbmdlbnRzWzQ0XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzQ1XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzQ2XSA9IC0xOwogICAgICAgICAgICB0YW5nZW50c1s0N10gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s0OF0gPSAtMTsKICAgICAgICAgICAgdGFuZ2VudHNbNDldID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNTBdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNTFdID0gLTE7CiAgICAgICAgICAgIHRhbmdlbnRzWzUyXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzUzXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzU0XSA9IC0xOwogICAgICAgICAgICB0YW5nZW50c1s1NV0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s1Nl0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s1N10gPSAtMTsKICAgICAgICAgICAgdGFuZ2VudHNbNThdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNTldID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNjBdID0gMTsKICAgICAgICAgICAgdGFuZ2VudHNbNjFdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNjJdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNjNdID0gMTsKICAgICAgICAgICAgdGFuZ2VudHNbNjRdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNjVdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNjZdID0gMTsKICAgICAgICAgICAgdGFuZ2VudHNbNjddID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNjhdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNjldID0gMTsKICAgICAgICAgICAgdGFuZ2VudHNbNzBdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNzFdID0gMDsKICAgICAgICAgICAgYXR0cmlidXRlcy50YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiB0YW5nZW50cwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgIGNvbnN0IGJpdGFuZ2VudHMgPSBuZXcgRmxvYXQzMkFycmF5KDYgKiA0ICogMyk7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzFdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1syXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbM10gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzRdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s1XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNl0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzddID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s4XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbOV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzEwXSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMTFdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1sxMl0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzEzXSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMTRdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1sxNV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzE2XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMTddID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1sxOF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzE5XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMjBdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1syMV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzIyXSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMjNdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1syNF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzI1XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMjZdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1syN10gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzI4XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMjldID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1szMF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzMxXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMzJdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1szM10gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzM0XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMzVdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1szNl0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzM3XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMzhdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1szOV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzQwXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNDFdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s0Ml0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzQzXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNDRdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s0NV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzQ2XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNDddID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s0OF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzQ5XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNTBdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s1MV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzUyXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNTNdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s1NF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzU1XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNTZdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s1N10gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzU4XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNTldID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s2MF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzYxXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNjJdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s2M10gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzY0XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNjVdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s2Nl0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzY3XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNjhdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s2OV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzcwXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNzFdID0gMTsKICAgICAgICAgICAgYXR0cmlidXRlcy5iaXRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IGJpdGFuZ2VudHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpbmRpY2VzID0gbmV3IFVpbnQxNkFycmF5KDYgKiAyICogMyk7CiAgICAgICAgICBpbmRpY2VzWzBdID0gMDsKICAgICAgICAgIGluZGljZXNbMV0gPSAxOwogICAgICAgICAgaW5kaWNlc1syXSA9IDI7CiAgICAgICAgICBpbmRpY2VzWzNdID0gMDsKICAgICAgICAgIGluZGljZXNbNF0gPSAyOwogICAgICAgICAgaW5kaWNlc1s1XSA9IDM7CiAgICAgICAgICBpbmRpY2VzWzZdID0gNCArIDI7CiAgICAgICAgICBpbmRpY2VzWzddID0gNCArIDE7CiAgICAgICAgICBpbmRpY2VzWzhdID0gNCArIDA7CiAgICAgICAgICBpbmRpY2VzWzldID0gNCArIDM7CiAgICAgICAgICBpbmRpY2VzWzEwXSA9IDQgKyAyOwogICAgICAgICAgaW5kaWNlc1sxMV0gPSA0ICsgMDsKICAgICAgICAgIGluZGljZXNbMTJdID0gOCArIDA7CiAgICAgICAgICBpbmRpY2VzWzEzXSA9IDggKyAxOwogICAgICAgICAgaW5kaWNlc1sxNF0gPSA4ICsgMjsKICAgICAgICAgIGluZGljZXNbMTVdID0gOCArIDA7CiAgICAgICAgICBpbmRpY2VzWzE2XSA9IDggKyAyOwogICAgICAgICAgaW5kaWNlc1sxN10gPSA4ICsgMzsKICAgICAgICAgIGluZGljZXNbMThdID0gMTIgKyAyOwogICAgICAgICAgaW5kaWNlc1sxOV0gPSAxMiArIDE7CiAgICAgICAgICBpbmRpY2VzWzIwXSA9IDEyICsgMDsKICAgICAgICAgIGluZGljZXNbMjFdID0gMTIgKyAzOwogICAgICAgICAgaW5kaWNlc1syMl0gPSAxMiArIDI7CiAgICAgICAgICBpbmRpY2VzWzIzXSA9IDEyICsgMDsKICAgICAgICAgIGluZGljZXNbMjRdID0gMTYgKyAyOwogICAgICAgICAgaW5kaWNlc1syNV0gPSAxNiArIDE7CiAgICAgICAgICBpbmRpY2VzWzI2XSA9IDE2ICsgMDsKICAgICAgICAgIGluZGljZXNbMjddID0gMTYgKyAzOwogICAgICAgICAgaW5kaWNlc1syOF0gPSAxNiArIDI7CiAgICAgICAgICBpbmRpY2VzWzI5XSA9IDE2ICsgMDsKICAgICAgICAgIGluZGljZXNbMzBdID0gMjAgKyAwOwogICAgICAgICAgaW5kaWNlc1szMV0gPSAyMCArIDE7CiAgICAgICAgICBpbmRpY2VzWzMyXSA9IDIwICsgMjsKICAgICAgICAgIGluZGljZXNbMzNdID0gMjAgKyAwOwogICAgICAgICAgaW5kaWNlc1szNF0gPSAyMCArIDI7CiAgICAgICAgICBpbmRpY2VzWzM1XSA9IDIwICsgMzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheSg4ICogMyk7CiAgICAgICAgICBwb3NpdGlvbnNbMF0gPSBtaW4zLng7CiAgICAgICAgICBwb3NpdGlvbnNbMV0gPSBtaW4zLnk7CiAgICAgICAgICBwb3NpdGlvbnNbMl0gPSBtaW4zLno7CiAgICAgICAgICBwb3NpdGlvbnNbM10gPSBtYXgzLng7CiAgICAgICAgICBwb3NpdGlvbnNbNF0gPSBtaW4zLnk7CiAgICAgICAgICBwb3NpdGlvbnNbNV0gPSBtaW4zLno7CiAgICAgICAgICBwb3NpdGlvbnNbNl0gPSBtYXgzLng7CiAgICAgICAgICBwb3NpdGlvbnNbN10gPSBtYXgzLnk7CiAgICAgICAgICBwb3NpdGlvbnNbOF0gPSBtaW4zLno7CiAgICAgICAgICBwb3NpdGlvbnNbOV0gPSBtaW4zLng7CiAgICAgICAgICBwb3NpdGlvbnNbMTBdID0gbWF4My55OwogICAgICAgICAgcG9zaXRpb25zWzExXSA9IG1pbjMuejsKICAgICAgICAgIHBvc2l0aW9uc1sxMl0gPSBtaW4zLng7CiAgICAgICAgICBwb3NpdGlvbnNbMTNdID0gbWluMy55OwogICAgICAgICAgcG9zaXRpb25zWzE0XSA9IG1heDMuejsKICAgICAgICAgIHBvc2l0aW9uc1sxNV0gPSBtYXgzLng7CiAgICAgICAgICBwb3NpdGlvbnNbMTZdID0gbWluMy55OwogICAgICAgICAgcG9zaXRpb25zWzE3XSA9IG1heDMuejsKICAgICAgICAgIHBvc2l0aW9uc1sxOF0gPSBtYXgzLng7CiAgICAgICAgICBwb3NpdGlvbnNbMTldID0gbWF4My55OwogICAgICAgICAgcG9zaXRpb25zWzIwXSA9IG1heDMuejsKICAgICAgICAgIHBvc2l0aW9uc1syMV0gPSBtaW4zLng7CiAgICAgICAgICBwb3NpdGlvbnNbMjJdID0gbWF4My55OwogICAgICAgICAgcG9zaXRpb25zWzIzXSA9IG1heDMuejsKICAgICAgICAgIGF0dHJpYnV0ZXMucG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgdmFsdWVzOiBwb3NpdGlvbnMKICAgICAgICAgIH0pOwogICAgICAgICAgaW5kaWNlcyA9IG5ldyBVaW50MTZBcnJheSg2ICogMiAqIDMpOwogICAgICAgICAgaW5kaWNlc1swXSA9IDQ7CiAgICAgICAgICBpbmRpY2VzWzFdID0gNTsKICAgICAgICAgIGluZGljZXNbMl0gPSA2OwogICAgICAgICAgaW5kaWNlc1szXSA9IDQ7CiAgICAgICAgICBpbmRpY2VzWzRdID0gNjsKICAgICAgICAgIGluZGljZXNbNV0gPSA3OwogICAgICAgICAgaW5kaWNlc1s2XSA9IDE7CiAgICAgICAgICBpbmRpY2VzWzddID0gMDsKICAgICAgICAgIGluZGljZXNbOF0gPSAzOwogICAgICAgICAgaW5kaWNlc1s5XSA9IDE7CiAgICAgICAgICBpbmRpY2VzWzEwXSA9IDM7CiAgICAgICAgICBpbmRpY2VzWzExXSA9IDI7CiAgICAgICAgICBpbmRpY2VzWzEyXSA9IDE7CiAgICAgICAgICBpbmRpY2VzWzEzXSA9IDY7CiAgICAgICAgICBpbmRpY2VzWzE0XSA9IDU7CiAgICAgICAgICBpbmRpY2VzWzE1XSA9IDE7CiAgICAgICAgICBpbmRpY2VzWzE2XSA9IDI7CiAgICAgICAgICBpbmRpY2VzWzE3XSA9IDY7CiAgICAgICAgICBpbmRpY2VzWzE4XSA9IDI7CiAgICAgICAgICBpbmRpY2VzWzE5XSA9IDM7CiAgICAgICAgICBpbmRpY2VzWzIwXSA9IDc7CiAgICAgICAgICBpbmRpY2VzWzIxXSA9IDI7CiAgICAgICAgICBpbmRpY2VzWzIyXSA9IDc7CiAgICAgICAgICBpbmRpY2VzWzIzXSA9IDY7CiAgICAgICAgICBpbmRpY2VzWzI0XSA9IDM7CiAgICAgICAgICBpbmRpY2VzWzI1XSA9IDA7CiAgICAgICAgICBpbmRpY2VzWzI2XSA9IDQ7CiAgICAgICAgICBpbmRpY2VzWzI3XSA9IDM7CiAgICAgICAgICBpbmRpY2VzWzI4XSA9IDQ7CiAgICAgICAgICBpbmRpY2VzWzI5XSA9IDc7CiAgICAgICAgICBpbmRpY2VzWzMwXSA9IDA7CiAgICAgICAgICBpbmRpY2VzWzMxXSA9IDE7CiAgICAgICAgICBpbmRpY2VzWzMyXSA9IDU7CiAgICAgICAgICBpbmRpY2VzWzMzXSA9IDA7CiAgICAgICAgICBpbmRpY2VzWzM0XSA9IDU7CiAgICAgICAgICBpbmRpY2VzWzM1XSA9IDQ7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGRpZmYgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QobWF4MywgbWluMywgZGlmZlNjcmF0Y2gpOwogICAgICAgIGNvbnN0IHJhZGl1cyA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoZGlmZikgKiAwLjU7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChib3hHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlKSkgewogICAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgIGNvbnN0IG9mZnNldFZhbHVlID0gYm94R2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5OT05FID8gMCA6IDE7CiAgICAgICAgICBjb25zdCBhcHBseU9mZnNldCA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCAvIDMpLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICAgICAgYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZTogbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIHJhZGl1cyksCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IGJveEdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgQm94R2VvbWV0cnkuZ2V0VW5pdEJveCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHVuaXRCb3hHZW9tZXRyeSkpIHsKICAgICAgICAgIHVuaXRCb3hHZW9tZXRyeSA9IEJveEdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5KAogICAgICAgICAgICBCb3hHZW9tZXRyeS5mcm9tRGltZW5zaW9ucyh7CiAgICAgICAgICAgICAgZGltZW5zaW9uczogbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgxLCAxLCAxKSwKICAgICAgICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IFZlcnRleEZvcm1hdF9kZWZhdWx0LlBPU0lUSU9OX09OTFkKICAgICAgICAgICAgfSkKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB1bml0Qm94R2VvbWV0cnk7CiAgICAgIH07CiAgICAgIEJveEdlb21ldHJ5X2RlZmF1bHQgPSBCb3hHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUJveEdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUJveEdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVCb3hHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVCb3hHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlQm94R2VvbWV0cnkoYm94R2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIGJveEdlb21ldHJ5ID0gQm94R2VvbWV0cnlfZGVmYXVsdC51bnBhY2soYm94R2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICByZXR1cm4gQm94R2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShib3hHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVCb3hHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUJveEdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVCb3hHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm94R2VvbWV0cnkoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGNyZWF0ZUJveEdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVCb3hHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0JveE91dGxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIEJveE91dGxpbmVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IG1pbjMgPSBvcHRpb25zLm1pbmltdW07CiAgICBjb25zdCBtYXgzID0gb3B0aW9ucy5tYXhpbXVtOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtaW4iLCBtaW4zKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF4IiwgbWF4Myk7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlKSAmJiBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5UT1ApIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIkdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlLlRPUCBpcyBub3QgYSBzdXBwb3J0ZWQgb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgZm9yIHRoaXMgZ2VvbWV0cnkuIgogICAgICApOwogICAgfQogICAgdGhpcy5fbWluID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG1pbjMpOwogICAgdGhpcy5fbWF4ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG1heDMpOwogICAgdGhpcy5fb2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUJveE91dGxpbmVHZW9tZXRyeSI7CiAgfQogIHZhciBkaWZmU2NyYXRjaDIsIHNjcmF0Y2hNaW4yLCBzY3JhdGNoTWF4Miwgc2NyYXRjaE9wdGlvbnMyLCBCb3hPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9Cb3hPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0JveE91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgZGlmZlNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBCb3hPdXRsaW5lR2VvbWV0cnkuZnJvbURpbWVuc2lvbnMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICAgICAgY29uc3QgZGltZW5zaW9ucyA9IG9wdGlvbnMuZGltZW5zaW9uczsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImRpbWVuc2lvbnMiLCBkaW1lbnNpb25zKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiZGltZW5zaW9ucy54IiwgZGltZW5zaW9ucy54LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiZGltZW5zaW9ucy55IiwgZGltZW5zaW9ucy55LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiZGltZW5zaW9ucy56IiwgZGltZW5zaW9ucy56LCAwKTsKICAgICAgICBjb25zdCBjb3JuZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihkaW1lbnNpb25zLCAwLjUsIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSk7CiAgICAgICAgcmV0dXJuIG5ldyBCb3hPdXRsaW5lR2VvbWV0cnkoewogICAgICAgICAgbWluaW11bTogQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShjb3JuZXIsIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSksCiAgICAgICAgICBtYXhpbXVtOiBjb3JuZXIsCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEJveE91dGxpbmVHZW9tZXRyeS5mcm9tQXhpc0FsaWduZWRCb3VuZGluZ0JveCA9IGZ1bmN0aW9uKGJvdW5kaW5nQm94KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJib3VuZGluZEJveCIsIGJvdW5kaW5nQm94KTsKICAgICAgICByZXR1cm4gbmV3IEJveE91dGxpbmVHZW9tZXRyeSh7CiAgICAgICAgICBtaW5pbXVtOiBib3VuZGluZ0JveC5taW5pbXVtLAogICAgICAgICAgbWF4aW11bTogYm91bmRpbmdCb3gubWF4aW11bQogICAgICAgIH0pOwogICAgICB9OwogICAgICBCb3hPdXRsaW5lR2VvbWV0cnkucGFja2VkTGVuZ3RoID0gMiAqIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAxOwogICAgICBCb3hPdXRsaW5lR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmFsdWUuX21pbiwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZhbHVlLl9tYXgsIGFycmF5LCBzdGFydGluZ0luZGV4ICsgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCArIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKiAyXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgdmFsdWUuX29mZnNldEF0dHJpYnV0ZSwKICAgICAgICAgIC0xCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hNaW4yID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTWF4MiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE9wdGlvbnMyID0gewogICAgICAgIG1pbmltdW06IHNjcmF0Y2hNaW4yLAogICAgICAgIG1heGltdW06IHNjcmF0Y2hNYXgyLAogICAgICAgIG9mZnNldEF0dHJpYnV0ZTogdm9pZCAwCiAgICAgIH07CiAgICAgIEJveE91dGxpbmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgbWluMyA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hNaW4yKTsKICAgICAgICBjb25zdCBtYXgzID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCArIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgsCiAgICAgICAgICBzY3JhdGNoTWF4MgogICAgICAgICk7CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleCArIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKiAyXTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIub2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIHJldHVybiBuZXcgQm94T3V0bGluZUdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zMik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fbWluID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG1pbjMsIHJlc3VsdC5fbWluKTsKICAgICAgICByZXN1bHQuX21heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShtYXgzLCByZXN1bHQuX21heCk7CiAgICAgICAgcmVzdWx0Ll9vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEJveE91dGxpbmVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKGJveEdlb21ldHJ5KSB7CiAgICAgICAgY29uc3QgbWluMyA9IGJveEdlb21ldHJ5Ll9taW47CiAgICAgICAgY29uc3QgbWF4MyA9IGJveEdlb21ldHJ5Ll9tYXg7CiAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMobWluMywgbWF4MykpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpOwogICAgICAgIGNvbnN0IGluZGljZXMgPSBuZXcgVWludDE2QXJyYXkoMTIgKiAyKTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KDggKiAzKTsKICAgICAgICBwb3NpdGlvbnNbMF0gPSBtaW4zLng7CiAgICAgICAgcG9zaXRpb25zWzFdID0gbWluMy55OwogICAgICAgIHBvc2l0aW9uc1syXSA9IG1pbjMuejsKICAgICAgICBwb3NpdGlvbnNbM10gPSBtYXgzLng7CiAgICAgICAgcG9zaXRpb25zWzRdID0gbWluMy55OwogICAgICAgIHBvc2l0aW9uc1s1XSA9IG1pbjMuejsKICAgICAgICBwb3NpdGlvbnNbNl0gPSBtYXgzLng7CiAgICAgICAgcG9zaXRpb25zWzddID0gbWF4My55OwogICAgICAgIHBvc2l0aW9uc1s4XSA9IG1pbjMuejsKICAgICAgICBwb3NpdGlvbnNbOV0gPSBtaW4zLng7CiAgICAgICAgcG9zaXRpb25zWzEwXSA9IG1heDMueTsKICAgICAgICBwb3NpdGlvbnNbMTFdID0gbWluMy56OwogICAgICAgIHBvc2l0aW9uc1sxMl0gPSBtaW4zLng7CiAgICAgICAgcG9zaXRpb25zWzEzXSA9IG1pbjMueTsKICAgICAgICBwb3NpdGlvbnNbMTRdID0gbWF4My56OwogICAgICAgIHBvc2l0aW9uc1sxNV0gPSBtYXgzLng7CiAgICAgICAgcG9zaXRpb25zWzE2XSA9IG1pbjMueTsKICAgICAgICBwb3NpdGlvbnNbMTddID0gbWF4My56OwogICAgICAgIHBvc2l0aW9uc1sxOF0gPSBtYXgzLng7CiAgICAgICAgcG9zaXRpb25zWzE5XSA9IG1heDMueTsKICAgICAgICBwb3NpdGlvbnNbMjBdID0gbWF4My56OwogICAgICAgIHBvc2l0aW9uc1syMV0gPSBtaW4zLng7CiAgICAgICAgcG9zaXRpb25zWzIyXSA9IG1heDMueTsKICAgICAgICBwb3NpdGlvbnNbMjNdID0gbWF4My56OwogICAgICAgIGF0dHJpYnV0ZXMucG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiBwb3NpdGlvbnMKICAgICAgICB9KTsKICAgICAgICBpbmRpY2VzWzBdID0gNDsKICAgICAgICBpbmRpY2VzWzFdID0gNTsKICAgICAgICBpbmRpY2VzWzJdID0gNTsKICAgICAgICBpbmRpY2VzWzNdID0gNjsKICAgICAgICBpbmRpY2VzWzRdID0gNjsKICAgICAgICBpbmRpY2VzWzVdID0gNzsKICAgICAgICBpbmRpY2VzWzZdID0gNzsKICAgICAgICBpbmRpY2VzWzddID0gNDsKICAgICAgICBpbmRpY2VzWzhdID0gMDsKICAgICAgICBpbmRpY2VzWzldID0gMTsKICAgICAgICBpbmRpY2VzWzEwXSA9IDE7CiAgICAgICAgaW5kaWNlc1sxMV0gPSAyOwogICAgICAgIGluZGljZXNbMTJdID0gMjsKICAgICAgICBpbmRpY2VzWzEzXSA9IDM7CiAgICAgICAgaW5kaWNlc1sxNF0gPSAzOwogICAgICAgIGluZGljZXNbMTVdID0gMDsKICAgICAgICBpbmRpY2VzWzE2XSA9IDA7CiAgICAgICAgaW5kaWNlc1sxN10gPSA0OwogICAgICAgIGluZGljZXNbMThdID0gMTsKICAgICAgICBpbmRpY2VzWzE5XSA9IDU7CiAgICAgICAgaW5kaWNlc1syMF0gPSAyOwogICAgICAgIGluZGljZXNbMjFdID0gNjsKICAgICAgICBpbmRpY2VzWzIyXSA9IDM7CiAgICAgICAgaW5kaWNlc1syM10gPSA3OwogICAgICAgIGNvbnN0IGRpZmYgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QobWF4MywgbWluMywgZGlmZlNjcmF0Y2gyKTsKICAgICAgICBjb25zdCByYWRpdXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKGRpZmYpICogMC41OwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYm94R2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IGJveEdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgY29uc3QgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGggLyAzKS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgICAgIGF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgIHZhbHVlczogYXBwbHlPZmZzZXQKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZTogbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIHJhZGl1cyksCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IGJveEdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgQm94T3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBCb3hPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlQm94T3V0bGluZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlQm94T3V0bGluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnkoYm94R2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIGJveEdlb21ldHJ5ID0gQm94T3V0bGluZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKGJveEdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgcmV0dXJuIEJveE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KGJveEdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZUJveE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUJveE91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQm94T3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Cb3hPdXRsaW5lR2VvbWV0cnkoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGNyZWF0ZUJveE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlQm94T3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzZUdlb21ldHJ5TGlicmFyeS5qcwogIGZ1bmN0aW9uIHBvaW50T25FbGxpcHNvaWQodGhldGEsIHJvdGF0aW9uLCBub3J0aFZlYywgZWFzdFZlYywgYVNxciwgYWIsIGJTcXIsIG1hZywgdW5pdFBvcywgcmVzdWx0KSB7CiAgICBjb25zdCBhemltdXRoID0gdGhldGEgKyByb3RhdGlvbjsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGVhc3RWZWMsIE1hdGguY29zKGF6aW11dGgpLCByb3RBeGlzKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG5vcnRoVmVjLCBNYXRoLnNpbihhemltdXRoKSwgdGVtcFZlYyk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJvdEF4aXMsIHRlbXBWZWMsIHJvdEF4aXMpOwogICAgbGV0IGNvc1RoZXRhU3F1YXJlZCA9IE1hdGguY29zKHRoZXRhKTsKICAgIGNvc1RoZXRhU3F1YXJlZCA9IGNvc1RoZXRhU3F1YXJlZCAqIGNvc1RoZXRhU3F1YXJlZDsKICAgIGxldCBzaW5UaGV0YVNxdWFyZWQgPSBNYXRoLnNpbih0aGV0YSk7CiAgICBzaW5UaGV0YVNxdWFyZWQgPSBzaW5UaGV0YVNxdWFyZWQgKiBzaW5UaGV0YVNxdWFyZWQ7CiAgICBjb25zdCByYWRpdXMgPSBhYiAvIE1hdGguc3FydChiU3FyICogY29zVGhldGFTcXVhcmVkICsgYVNxciAqIHNpblRoZXRhU3F1YXJlZCk7CiAgICBjb25zdCBhbmdsZSA9IHJhZGl1cyAvIG1hZzsKICAgIFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKHJvdEF4aXMsIGFuZ2xlLCB1bml0UXVhdCk7CiAgICBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24odW5pdFF1YXQsIHJvdE10eCk7CiAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3Rvcihyb3RNdHgsIHVuaXRQb3MsIHJlc3VsdCk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHJlc3VsdCwgcmVzdWx0KTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHJlc3VsdCwgbWFnLCByZXN1bHQpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdmFyIEVsbGlwc2VHZW9tZXRyeUxpYnJhcnksIHJvdEF4aXMsIHRlbXBWZWMsIHVuaXRRdWF0LCByb3RNdHgsIHNjcmF0Y2hDYXJ0ZXNpYW4xMiwgc2NyYXRjaENhcnRlc2lhbjIzLCBzY3JhdGNoQ2FydGVzaWFuMzQsIHNjcmF0Y2hOb3JtYWwyLCB1bml0UG9zU2NyYXRjaCwgZWFzdFZlY1NjcmF0Y2gsIG5vcnRoVmVjU2NyYXRjaCwgRWxsaXBzZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0OwogIHZhciBpbml0X0VsbGlwc2VHZW9tZXRyeUxpYnJhcnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc2VHZW9tZXRyeUxpYnJhcnkuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X1F1YXRlcm5pb24oKTsKICAgICAgRWxsaXBzZUdlb21ldHJ5TGlicmFyeSA9IHt9OwogICAgICByb3RBeGlzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB0ZW1wVmVjID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB1bml0UXVhdCA9IG5ldyBRdWF0ZXJuaW9uX2RlZmF1bHQoKTsKICAgICAgcm90TXR4ID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4yMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjM0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTm9ybWFsMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgRWxsaXBzZUdlb21ldHJ5TGlicmFyeS5yYWlzZVBvc2l0aW9uc1RvSGVpZ2h0ID0gZnVuY3Rpb24ocG9zaXRpb25zLCBvcHRpb25zLCBleHRydWRlKSB7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gb3B0aW9ucy5lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gb3B0aW9ucy5oZWlnaHQ7CiAgICAgICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBvcHRpb25zLmV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGNvbnN0IHNpemUgPSBleHRydWRlID8gcG9zaXRpb25zLmxlbmd0aCAvIDMgKiAyIDogcG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICAgICAgY29uc3QgZmluYWxQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHNpemUgKiAzKTsKICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGNvbnN0IGJvdHRvbU9mZnNldCA9IGV4dHJ1ZGUgPyBsZW5ndGggOiAwOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgIGNvbnN0IGkxID0gaSArIDE7CiAgICAgICAgICBjb25zdCBpMiA9IGkgKyAyOwogICAgICAgICAgY29uc3QgcG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaSwgc2NyYXRjaENhcnRlc2lhbjEyKTsKICAgICAgICAgIGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKHBvc2l0aW9uLCBwb3NpdGlvbik7CiAgICAgICAgICBjb25zdCBleHRydWRlZFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHBvc2l0aW9uLCBzY3JhdGNoQ2FydGVzaWFuMjMpOwogICAgICAgICAgY29uc3Qgbm9ybWFsMiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24sIHNjcmF0Y2hOb3JtYWwyKTsKICAgICAgICAgIGNvbnN0IHNjYWxlZE5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICBub3JtYWwyLAogICAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zNAogICAgICAgICAgKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24sIHNjYWxlZE5vcm1hbCwgcG9zaXRpb24pOwogICAgICAgICAgaWYgKGV4dHJ1ZGUpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobm9ybWFsMiwgZXh0cnVkZWRIZWlnaHQsIHNjYWxlZE5vcm1hbCk7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoZXh0cnVkZWRQb3NpdGlvbiwgc2NhbGVkTm9ybWFsLCBleHRydWRlZFBvc2l0aW9uKTsKICAgICAgICAgICAgZmluYWxQb3NpdGlvbnNbaSArIGJvdHRvbU9mZnNldF0gPSBleHRydWRlZFBvc2l0aW9uLng7CiAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zW2kxICsgYm90dG9tT2Zmc2V0XSA9IGV4dHJ1ZGVkUG9zaXRpb24ueTsKICAgICAgICAgICAgZmluYWxQb3NpdGlvbnNbaTIgKyBib3R0b21PZmZzZXRdID0gZXh0cnVkZWRQb3NpdGlvbi56OwogICAgICAgICAgfQogICAgICAgICAgZmluYWxQb3NpdGlvbnNbaV0gPSBwb3NpdGlvbi54OwogICAgICAgICAgZmluYWxQb3NpdGlvbnNbaTFdID0gcG9zaXRpb24ueTsKICAgICAgICAgIGZpbmFsUG9zaXRpb25zW2kyXSA9IHBvc2l0aW9uLno7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmaW5hbFBvc2l0aW9uczsKICAgICAgfTsKICAgICAgdW5pdFBvc1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGVhc3RWZWNTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBub3J0aFZlY1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEVsbGlwc2VHZW9tZXRyeUxpYnJhcnkuY29tcHV0ZUVsbGlwc2VQb3NpdGlvbnMgPSBmdW5jdGlvbihvcHRpb25zLCBhZGRGaWxsUG9zaXRpb25zLCBhZGRFZGdlUG9zaXRpb25zKSB7CiAgICAgICAgY29uc3Qgc2VtaU1pbm9yQXhpcyA9IG9wdGlvbnMuc2VtaU1pbm9yQXhpczsKICAgICAgICBjb25zdCBzZW1pTWFqb3JBeGlzID0gb3B0aW9ucy5zZW1pTWFqb3JBeGlzOwogICAgICAgIGNvbnN0IHJvdGF0aW9uID0gb3B0aW9ucy5yb3RhdGlvbjsKICAgICAgICBjb25zdCBjZW50ZXIgPSBvcHRpb25zLmNlbnRlcjsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IG9wdGlvbnMuZ3JhbnVsYXJpdHkgKiA4OwogICAgICAgIGNvbnN0IGFTcXIgPSBzZW1pTWlub3JBeGlzICogc2VtaU1pbm9yQXhpczsKICAgICAgICBjb25zdCBiU3FyID0gc2VtaU1ham9yQXhpcyAqIHNlbWlNYWpvckF4aXM7CiAgICAgICAgY29uc3QgYWIgPSBzZW1pTWFqb3JBeGlzICogc2VtaU1pbm9yQXhpczsKICAgICAgICBjb25zdCBtYWcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKGNlbnRlcik7CiAgICAgICAgY29uc3QgdW5pdFBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoY2VudGVyLCB1bml0UG9zU2NyYXRjaCk7CiAgICAgICAgbGV0IGVhc3RWZWMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWiwgY2VudGVyLCBlYXN0VmVjU2NyYXRjaCk7CiAgICAgICAgZWFzdFZlYyA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZWFzdFZlYywgZWFzdFZlYyk7CiAgICAgICAgY29uc3Qgbm9ydGhWZWMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3ModW5pdFBvcywgZWFzdFZlYywgbm9ydGhWZWNTY3JhdGNoKTsKICAgICAgICBsZXQgbnVtUHRzID0gMSArIE1hdGguY2VpbChNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gLyBncmFudWxhcml0eSk7CiAgICAgICAgY29uc3QgZGVsdGFUaGV0YSA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAvIChudW1QdHMgLSAxKTsKICAgICAgICBsZXQgdGhldGEgPSBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gLSBudW1QdHMgKiBkZWx0YVRoZXRhOwogICAgICAgIGlmICh0aGV0YSA8IDApIHsKICAgICAgICAgIG51bVB0cyAtPSBNYXRoLmNlaWwoTWF0aC5hYnModGhldGEpIC8gZGVsdGFUaGV0YSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNpemUgPSAyICogKG51bVB0cyAqIChudW1QdHMgKyAyKSk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gYWRkRmlsbFBvc2l0aW9ucyA/IG5ldyBBcnJheShzaXplICogMykgOiB2b2lkIDA7CiAgICAgICAgbGV0IHBvc2l0aW9uSW5kZXggPSAwOwogICAgICAgIGxldCBwb3NpdGlvbiA9IHNjcmF0Y2hDYXJ0ZXNpYW4xMjsKICAgICAgICBsZXQgcmVmbGVjdGVkUG9zaXRpb24gPSBzY3JhdGNoQ2FydGVzaWFuMjM7CiAgICAgICAgY29uc3Qgb3V0ZXJQb3NpdGlvbnNMZW5ndGggPSBudW1QdHMgKiA0ICogMzsKICAgICAgICBsZXQgb3V0ZXJSaWdodEluZGV4ID0gb3V0ZXJQb3NpdGlvbnNMZW5ndGggLSAxOwogICAgICAgIGxldCBvdXRlckxlZnRJbmRleCA9IDA7CiAgICAgICAgY29uc3Qgb3V0ZXJQb3NpdGlvbnMgPSBhZGRFZGdlUG9zaXRpb25zID8gbmV3IEFycmF5KG91dGVyUG9zaXRpb25zTGVuZ3RoKSA6IHZvaWQgMDsKICAgICAgICBsZXQgaTsKICAgICAgICBsZXQgajsKICAgICAgICBsZXQgbnVtSW50ZXJpb3I7CiAgICAgICAgbGV0IHQ7CiAgICAgICAgbGV0IGludGVyaW9yUG9zaXRpb247CiAgICAgICAgdGhldGEgPSBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV087CiAgICAgICAgcG9zaXRpb24gPSBwb2ludE9uRWxsaXBzb2lkKAogICAgICAgICAgdGhldGEsCiAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgIG5vcnRoVmVjLAogICAgICAgICAgZWFzdFZlYywKICAgICAgICAgIGFTcXIsCiAgICAgICAgICBhYiwKICAgICAgICAgIGJTcXIsCiAgICAgICAgICBtYWcsCiAgICAgICAgICB1bml0UG9zLAogICAgICAgICAgcG9zaXRpb24KICAgICAgICApOwogICAgICAgIGlmIChhZGRGaWxsUG9zaXRpb25zKSB7CiAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHBvc2l0aW9uLng7CiAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHBvc2l0aW9uLnk7CiAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHBvc2l0aW9uLno7CiAgICAgICAgfQogICAgICAgIGlmIChhZGRFZGdlUG9zaXRpb25zKSB7CiAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlclJpZ2h0SW5kZXgtLV0gPSBwb3NpdGlvbi56OwogICAgICAgICAgb3V0ZXJQb3NpdGlvbnNbb3V0ZXJSaWdodEluZGV4LS1dID0gcG9zaXRpb24ueTsKICAgICAgICAgIG91dGVyUG9zaXRpb25zW291dGVyUmlnaHRJbmRleC0tXSA9IHBvc2l0aW9uLng7CiAgICAgICAgfQogICAgICAgIHRoZXRhID0gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIC0gZGVsdGFUaGV0YTsKICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbnVtUHRzICsgMTsgKytpKSB7CiAgICAgICAgICBwb3NpdGlvbiA9IHBvaW50T25FbGxpcHNvaWQoCiAgICAgICAgICAgIHRoZXRhLAogICAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgICAgbm9ydGhWZWMsCiAgICAgICAgICAgIGVhc3RWZWMsCiAgICAgICAgICAgIGFTcXIsCiAgICAgICAgICAgIGFiLAogICAgICAgICAgICBiU3FyLAogICAgICAgICAgICBtYWcsCiAgICAgICAgICAgIHVuaXRQb3MsCiAgICAgICAgICAgIHBvc2l0aW9uCiAgICAgICAgICApOwogICAgICAgICAgcmVmbGVjdGVkUG9zaXRpb24gPSBwb2ludE9uRWxsaXBzb2lkKAogICAgICAgICAgICBNYXRoLlBJIC0gdGhldGEsCiAgICAgICAgICAgIHJvdGF0aW9uLAogICAgICAgICAgICBub3J0aFZlYywKICAgICAgICAgICAgZWFzdFZlYywKICAgICAgICAgICAgYVNxciwKICAgICAgICAgICAgYWIsCiAgICAgICAgICAgIGJTcXIsCiAgICAgICAgICAgIG1hZywKICAgICAgICAgICAgdW5pdFBvcywKICAgICAgICAgICAgcmVmbGVjdGVkUG9zaXRpb24KICAgICAgICAgICk7CiAgICAgICAgICBpZiAoYWRkRmlsbFBvc2l0aW9ucykgewogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHBvc2l0aW9uLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcG9zaXRpb24ueTsKICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi56OwogICAgICAgICAgICBudW1JbnRlcmlvciA9IDIgKiBpICsgMjsKICAgICAgICAgICAgZm9yIChqID0gMTsgaiA8IG51bUludGVyaW9yIC0gMTsgKytqKSB7CiAgICAgICAgICAgICAgdCA9IGogLyAobnVtSW50ZXJpb3IgLSAxKTsKICAgICAgICAgICAgICBpbnRlcmlvclBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmxlcnAoCiAgICAgICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgICAgIHJlZmxlY3RlZFBvc2l0aW9uLAogICAgICAgICAgICAgICAgdCwKICAgICAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zNAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBpbnRlcmlvclBvc2l0aW9uLng7CiAgICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBpbnRlcmlvclBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBpbnRlcmlvclBvc2l0aW9uLno7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSByZWZsZWN0ZWRQb3NpdGlvbi54OwogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHJlZmxlY3RlZFBvc2l0aW9uLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcmVmbGVjdGVkUG9zaXRpb24uejsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChhZGRFZGdlUG9zaXRpb25zKSB7CiAgICAgICAgICAgIG91dGVyUG9zaXRpb25zW291dGVyUmlnaHRJbmRleC0tXSA9IHBvc2l0aW9uLno7CiAgICAgICAgICAgIG91dGVyUG9zaXRpb25zW291dGVyUmlnaHRJbmRleC0tXSA9IHBvc2l0aW9uLnk7CiAgICAgICAgICAgIG91dGVyUG9zaXRpb25zW291dGVyUmlnaHRJbmRleC0tXSA9IHBvc2l0aW9uLng7CiAgICAgICAgICAgIG91dGVyUG9zaXRpb25zW291dGVyTGVmdEluZGV4KytdID0gcmVmbGVjdGVkUG9zaXRpb24ueDsKICAgICAgICAgICAgb3V0ZXJQb3NpdGlvbnNbb3V0ZXJMZWZ0SW5kZXgrK10gPSByZWZsZWN0ZWRQb3NpdGlvbi55OwogICAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlckxlZnRJbmRleCsrXSA9IHJlZmxlY3RlZFBvc2l0aW9uLno7CiAgICAgICAgICB9CiAgICAgICAgICB0aGV0YSA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAtIChpICsgMSkgKiBkZWx0YVRoZXRhOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSBudW1QdHM7IGkgPiAxOyAtLWkpIHsKICAgICAgICAgIHRoZXRhID0gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIC0gKGkgLSAxKSAqIGRlbHRhVGhldGE7CiAgICAgICAgICBwb3NpdGlvbiA9IHBvaW50T25FbGxpcHNvaWQoCiAgICAgICAgICAgIC10aGV0YSwKICAgICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICAgIG5vcnRoVmVjLAogICAgICAgICAgICBlYXN0VmVjLAogICAgICAgICAgICBhU3FyLAogICAgICAgICAgICBhYiwKICAgICAgICAgICAgYlNxciwKICAgICAgICAgICAgbWFnLAogICAgICAgICAgICB1bml0UG9zLAogICAgICAgICAgICBwb3NpdGlvbgogICAgICAgICAgKTsKICAgICAgICAgIHJlZmxlY3RlZFBvc2l0aW9uID0gcG9pbnRPbkVsbGlwc29pZCgKICAgICAgICAgICAgdGhldGEgKyBNYXRoLlBJLAogICAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgICAgbm9ydGhWZWMsCiAgICAgICAgICAgIGVhc3RWZWMsCiAgICAgICAgICAgIGFTcXIsCiAgICAgICAgICAgIGFiLAogICAgICAgICAgICBiU3FyLAogICAgICAgICAgICBtYWcsCiAgICAgICAgICAgIHVuaXRQb3MsCiAgICAgICAgICAgIHJlZmxlY3RlZFBvc2l0aW9uCiAgICAgICAgICApOwogICAgICAgICAgaWYgKGFkZEZpbGxQb3NpdGlvbnMpIHsKICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi54OwogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHBvc2l0aW9uLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcG9zaXRpb24uejsKICAgICAgICAgICAgbnVtSW50ZXJpb3IgPSAyICogKGkgLSAxKSArIDI7CiAgICAgICAgICAgIGZvciAoaiA9IDE7IGogPCBudW1JbnRlcmlvciAtIDE7ICsraikgewogICAgICAgICAgICAgIHQgPSBqIC8gKG51bUludGVyaW9yIC0gMSk7CiAgICAgICAgICAgICAgaW50ZXJpb3JQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5sZXJwKAogICAgICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgICAgICByZWZsZWN0ZWRQb3NpdGlvbiwKICAgICAgICAgICAgICAgIHQsCiAgICAgICAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuMzQKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gaW50ZXJpb3JQb3NpdGlvbi54OwogICAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gaW50ZXJpb3JQb3NpdGlvbi55OwogICAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gaW50ZXJpb3JQb3NpdGlvbi56OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcmVmbGVjdGVkUG9zaXRpb24ueDsKICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSByZWZsZWN0ZWRQb3NpdGlvbi55OwogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHJlZmxlY3RlZFBvc2l0aW9uLno7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYWRkRWRnZVBvc2l0aW9ucykgewogICAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlclJpZ2h0SW5kZXgtLV0gPSBwb3NpdGlvbi56OwogICAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlclJpZ2h0SW5kZXgtLV0gPSBwb3NpdGlvbi55OwogICAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlclJpZ2h0SW5kZXgtLV0gPSBwb3NpdGlvbi54OwogICAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlckxlZnRJbmRleCsrXSA9IHJlZmxlY3RlZFBvc2l0aW9uLng7CiAgICAgICAgICAgIG91dGVyUG9zaXRpb25zW291dGVyTGVmdEluZGV4KytdID0gcmVmbGVjdGVkUG9zaXRpb24ueTsKICAgICAgICAgICAgb3V0ZXJQb3NpdGlvbnNbb3V0ZXJMZWZ0SW5kZXgrK10gPSByZWZsZWN0ZWRQb3NpdGlvbi56OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGV0YSA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTzsKICAgICAgICBwb3NpdGlvbiA9IHBvaW50T25FbGxpcHNvaWQoCiAgICAgICAgICAtdGhldGEsCiAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgIG5vcnRoVmVjLAogICAgICAgICAgZWFzdFZlYywKICAgICAgICAgIGFTcXIsCiAgICAgICAgICBhYiwKICAgICAgICAgIGJTcXIsCiAgICAgICAgICBtYWcsCiAgICAgICAgICB1bml0UG9zLAogICAgICAgICAgcG9zaXRpb24KICAgICAgICApOwogICAgICAgIGNvbnN0IHIgPSB7fTsKICAgICAgICBpZiAoYWRkRmlsbFBvc2l0aW9ucykgewogICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi54OwogICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi55OwogICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi56OwogICAgICAgICAgci5wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgICByLm51bVB0cyA9IG51bVB0czsKICAgICAgICB9CiAgICAgICAgaWYgKGFkZEVkZ2VQb3NpdGlvbnMpIHsKICAgICAgICAgIG91dGVyUG9zaXRpb25zW291dGVyUmlnaHRJbmRleC0tXSA9IHBvc2l0aW9uLno7CiAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlclJpZ2h0SW5kZXgtLV0gPSBwb3NpdGlvbi55OwogICAgICAgICAgb3V0ZXJQb3NpdGlvbnNbb3V0ZXJSaWdodEluZGV4LS1dID0gcG9zaXRpb24ueDsKICAgICAgICAgIHIub3V0ZXJQb3NpdGlvbnMgPSBvdXRlclBvc2l0aW9uczsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHI7CiAgICAgIH07CiAgICAgIEVsbGlwc2VHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdCA9IEVsbGlwc2VHZW9tZXRyeUxpYnJhcnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9HZW9tZXRyeUluc3RhbmNlLmpzCiAgZnVuY3Rpb24gR2VvbWV0cnlJbnN0YW5jZShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuZ2VvbWV0cnkpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLmdlb21ldHJ5IGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgdGhpcy5nZW9tZXRyeSA9IG9wdGlvbnMuZ2VvbWV0cnk7CiAgICB0aGlzLm1vZGVsTWF0cml4ID0gTWF0cml4NF9kZWZhdWx0LmNsb25lKAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm1vZGVsTWF0cml4LCBNYXRyaXg0X2RlZmF1bHQuSURFTlRJVFkpCiAgICApOwogICAgdGhpcy5pZCA9IG9wdGlvbnMuaWQ7CiAgICB0aGlzLnBpY2tQcmltaXRpdmUgPSBvcHRpb25zLnBpY2tQcmltaXRpdmU7CiAgICB0aGlzLmF0dHJpYnV0ZXMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmF0dHJpYnV0ZXMsIHt9KTsKICAgIHRoaXMud2VzdEhlbWlzcGhlcmVHZW9tZXRyeSA9IHZvaWQgMDsKICAgIHRoaXMuZWFzdEhlbWlzcGhlcmVHZW9tZXRyeSA9IHZvaWQgMDsKICB9CiAgdmFyIEdlb21ldHJ5SW5zdGFuY2VfZGVmYXVsdDsKICB2YXIgaW5pdF9HZW9tZXRyeUluc3RhbmNlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9HZW9tZXRyeUluc3RhbmNlLmpzIigpIHsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIEdlb21ldHJ5SW5zdGFuY2VfZGVmYXVsdCA9IEdlb21ldHJ5SW5zdGFuY2U7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNlR2VvbWV0cnkuanMKICBmdW5jdGlvbiBjb21wdXRlVG9wQm90dG9tQXR0cmlidXRlcyhwb3NpdGlvbnMsIG9wdGlvbnMsIGV4dHJ1ZGUpIHsKICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IG9wdGlvbnMudmVydGV4Rm9ybWF0OwogICAgY29uc3QgY2VudGVyID0gb3B0aW9ucy5jZW50ZXI7CiAgICBjb25zdCBzZW1pTWFqb3JBeGlzID0gb3B0aW9ucy5zZW1pTWFqb3JBeGlzOwogICAgY29uc3Qgc2VtaU1pbm9yQXhpcyA9IG9wdGlvbnMuc2VtaU1pbm9yQXhpczsKICAgIGNvbnN0IGVsbGlwc29pZCA9IG9wdGlvbnMuZWxsaXBzb2lkOwogICAgY29uc3Qgc3RSb3RhdGlvbiA9IG9wdGlvbnMuc3RSb3RhdGlvbjsKICAgIGNvbnN0IHNpemUgPSBleHRydWRlID8gcG9zaXRpb25zLmxlbmd0aCAvIDMgKiAyIDogcG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICBjb25zdCBzaGFkb3dWb2x1bWUgPSBvcHRpb25zLnNoYWRvd1ZvbHVtZTsKICAgIGNvbnN0IHRleHR1cmVDb29yZGluYXRlcyA9IHZlcnRleEZvcm1hdC5zdCA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDIpIDogdm9pZCAwOwogICAgY29uc3Qgbm9ybWFscyA9IHZlcnRleEZvcm1hdC5ub3JtYWwgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUgKiAzKSA6IHZvaWQgMDsKICAgIGNvbnN0IHRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LnRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUgKiAzKSA6IHZvaWQgMDsKICAgIGNvbnN0IGJpdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShzaXplICogMykgOiB2b2lkIDA7CiAgICBjb25zdCBleHRydWRlTm9ybWFscyA9IHNoYWRvd1ZvbHVtZSA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDMpIDogdm9pZCAwOwogICAgbGV0IHRleHR1cmVDb29yZEluZGV4ID0gMDsKICAgIGxldCBub3JtYWwyID0gc2NyYXRjaE5vcm1hbDM7CiAgICBsZXQgdGFuZ2VudCA9IHNjcmF0Y2hUYW5nZW50OwogICAgbGV0IGJpdGFuZ2VudCA9IHNjcmF0Y2hCaXRhbmdlbnQ7CiAgICBjb25zdCBwcm9qZWN0aW9uID0gbmV3IEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQoZWxsaXBzb2lkKTsKICAgIGNvbnN0IHByb2plY3RlZENlbnRlciA9IHByb2plY3Rpb24ucHJvamVjdCgKICAgICAgZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKGNlbnRlciwgc2NyYXRjaENhcnRvZ3JhcGhpYzIpLAogICAgICBwcm9qZWN0ZWRDZW50ZXJTY3JhdGNoCiAgICApOwogICAgY29uc3QgZ2VvZGV0aWNOb3JtYWwgPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZSgKICAgICAgY2VudGVyLAogICAgICBzY3JhdGNoQ2FydGVzaWFuMTMKICAgICk7CiAgICBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKGdlb2RldGljTm9ybWFsLCBnZW9kZXRpY05vcm1hbCk7CiAgICBsZXQgdGV4dHVyZU1hdHJpeCA9IHRleHR1cmVNYXRyaXhTY3JhdGNoOwogICAgbGV0IHRhbmdlbnRNYXRyaXggPSB0YW5nZW50TWF0cml4U2NyYXRjaDsKICAgIGlmIChzdFJvdGF0aW9uICE9PSAwKSB7CiAgICAgIGxldCByb3RhdGlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKAogICAgICAgIGdlb2RldGljTm9ybWFsLAogICAgICAgIHN0Um90YXRpb24sCiAgICAgICAgcXVhdGVybmlvblNjcmF0Y2gKICAgICAgKTsKICAgICAgdGV4dHVyZU1hdHJpeCA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tUXVhdGVybmlvbihyb3RhdGlvbiwgdGV4dHVyZU1hdHJpeCk7CiAgICAgIHJvdGF0aW9uID0gUXVhdGVybmlvbl9kZWZhdWx0LmZyb21BeGlzQW5nbGUoCiAgICAgICAgZ2VvZGV0aWNOb3JtYWwsCiAgICAgICAgLXN0Um90YXRpb24sCiAgICAgICAgcXVhdGVybmlvblNjcmF0Y2gKICAgICAgKTsKICAgICAgdGFuZ2VudE1hdHJpeCA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tUXVhdGVybmlvbihyb3RhdGlvbiwgdGFuZ2VudE1hdHJpeCk7CiAgICB9IGVsc2UgewogICAgICB0ZXh0dXJlTWF0cml4ID0gTWF0cml4M19kZWZhdWx0LmNsb25lKE1hdHJpeDNfZGVmYXVsdC5JREVOVElUWSwgdGV4dHVyZU1hdHJpeCk7CiAgICAgIHRhbmdlbnRNYXRyaXggPSBNYXRyaXgzX2RlZmF1bHQuY2xvbmUoTWF0cml4M19kZWZhdWx0LklERU5USVRZLCB0YW5nZW50TWF0cml4KTsKICAgIH0KICAgIGNvbnN0IG1pblRleENvb3JkID0gQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21FbGVtZW50cygKICAgICAgTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLAogICAgICBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksCiAgICAgIHNjcmF0Y2hNaW5UZXhDb29yZAogICAgKTsKICAgIGNvbnN0IG1heFRleENvb3JkID0gQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21FbGVtZW50cygKICAgICAgTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZLAogICAgICBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFksCiAgICAgIHNjcmF0Y2hNYXhUZXhDb29yZAogICAgKTsKICAgIGxldCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgY29uc3QgYm90dG9tT2Zmc2V0ID0gZXh0cnVkZSA/IGxlbmd0aCA6IDA7CiAgICBjb25zdCBzdE9mZnNldCA9IGJvdHRvbU9mZnNldCAvIDMgKiAyOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMykgewogICAgICBjb25zdCBpMSA9IGkgKyAxOwogICAgICBjb25zdCBpMiA9IGkgKyAyOwogICAgICBjb25zdCBwb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpLCBzY3JhdGNoQ2FydGVzaWFuMTMpOwogICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgY29uc3Qgcm90YXRlZFBvaW50ID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoCiAgICAgICAgICB0ZXh0dXJlTWF0cml4LAogICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuMjQKICAgICAgICApOwogICAgICAgIGNvbnN0IHByb2plY3RlZFBvaW50ID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHJvdGF0ZWRQb2ludCwgc2NyYXRjaENhcnRvZ3JhcGhpYzIpLAogICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjM1CiAgICAgICAgKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocHJvamVjdGVkUG9pbnQsIHByb2plY3RlZENlbnRlciwgcHJvamVjdGVkUG9pbnQpOwogICAgICAgIHRleENvb3JkU2NyYXRjaC54ID0gKHByb2plY3RlZFBvaW50LnggKyBzZW1pTWFqb3JBeGlzKSAvICgyICogc2VtaU1ham9yQXhpcyk7CiAgICAgICAgdGV4Q29vcmRTY3JhdGNoLnkgPSAocHJvamVjdGVkUG9pbnQueSArIHNlbWlNaW5vckF4aXMpIC8gKDIgKiBzZW1pTWlub3JBeGlzKTsKICAgICAgICBtaW5UZXhDb29yZC54ID0gTWF0aC5taW4odGV4Q29vcmRTY3JhdGNoLngsIG1pblRleENvb3JkLngpOwogICAgICAgIG1pblRleENvb3JkLnkgPSBNYXRoLm1pbih0ZXhDb29yZFNjcmF0Y2gueSwgbWluVGV4Q29vcmQueSk7CiAgICAgICAgbWF4VGV4Q29vcmQueCA9IE1hdGgubWF4KHRleENvb3JkU2NyYXRjaC54LCBtYXhUZXhDb29yZC54KTsKICAgICAgICBtYXhUZXhDb29yZC55ID0gTWF0aC5tYXgodGV4Q29vcmRTY3JhdGNoLnksIG1heFRleENvb3JkLnkpOwogICAgICAgIGlmIChleHRydWRlKSB7CiAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbdGV4dHVyZUNvb3JkSW5kZXggKyBzdE9mZnNldF0gPSB0ZXhDb29yZFNjcmF0Y2gueDsKICAgICAgICAgIHRleHR1cmVDb29yZGluYXRlc1t0ZXh0dXJlQ29vcmRJbmRleCArIDEgKyBzdE9mZnNldF0gPSB0ZXhDb29yZFNjcmF0Y2gueTsKICAgICAgICB9CiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3RleHR1cmVDb29yZEluZGV4KytdID0gdGV4Q29vcmRTY3JhdGNoLng7CiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3RleHR1cmVDb29yZEluZGV4KytdID0gdGV4Q29vcmRTY3JhdGNoLnk7CiAgICAgIH0KICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwgfHwgdmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCB8fCBzaGFkb3dWb2x1bWUpIHsKICAgICAgICBub3JtYWwyID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbiwgbm9ybWFsMik7CiAgICAgICAgaWYgKHNoYWRvd1ZvbHVtZSkgewogICAgICAgICAgZXh0cnVkZU5vcm1hbHNbaSArIGJvdHRvbU9mZnNldF0gPSAtbm9ybWFsMi54OwogICAgICAgICAgZXh0cnVkZU5vcm1hbHNbaTEgKyBib3R0b21PZmZzZXRdID0gLW5vcm1hbDIueTsKICAgICAgICAgIGV4dHJ1ZGVOb3JtYWxzW2kyICsgYm90dG9tT2Zmc2V0XSA9IC1ub3JtYWwyLno7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsIHx8IHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgIHRhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9aLCBub3JtYWwyLCB0YW5nZW50KSwKICAgICAgICAgICAgICB0YW5nZW50CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKHRhbmdlbnRNYXRyaXgsIHRhbmdlbnQsIHRhbmdlbnQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICAgICAgbm9ybWFsc1tpXSA9IG5vcm1hbDIueDsKICAgICAgICAgICAgbm9ybWFsc1tpMV0gPSBub3JtYWwyLnk7CiAgICAgICAgICAgIG5vcm1hbHNbaTJdID0gbm9ybWFsMi56OwogICAgICAgICAgICBpZiAoZXh0cnVkZSkgewogICAgICAgICAgICAgIG5vcm1hbHNbaSArIGJvdHRvbU9mZnNldF0gPSAtbm9ybWFsMi54OwogICAgICAgICAgICAgIG5vcm1hbHNbaTEgKyBib3R0b21PZmZzZXRdID0gLW5vcm1hbDIueTsKICAgICAgICAgICAgICBub3JtYWxzW2kyICsgYm90dG9tT2Zmc2V0XSA9IC1ub3JtYWwyLno7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgICB0YW5nZW50c1tpXSA9IHRhbmdlbnQueDsKICAgICAgICAgICAgdGFuZ2VudHNbaTFdID0gdGFuZ2VudC55OwogICAgICAgICAgICB0YW5nZW50c1tpMl0gPSB0YW5nZW50Lno7CiAgICAgICAgICAgIGlmIChleHRydWRlKSB7CiAgICAgICAgICAgICAgdGFuZ2VudHNbaSArIGJvdHRvbU9mZnNldF0gPSAtdGFuZ2VudC54OwogICAgICAgICAgICAgIHRhbmdlbnRzW2kxICsgYm90dG9tT2Zmc2V0XSA9IC10YW5nZW50Lnk7CiAgICAgICAgICAgICAgdGFuZ2VudHNbaTIgKyBib3R0b21PZmZzZXRdID0gLXRhbmdlbnQuejsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgYml0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3Mobm9ybWFsMiwgdGFuZ2VudCwgYml0YW5nZW50KSwKICAgICAgICAgICAgICBiaXRhbmdlbnQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgYml0YW5nZW50c1tpXSA9IGJpdGFuZ2VudC54OwogICAgICAgICAgICBiaXRhbmdlbnRzW2kxXSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgICBiaXRhbmdlbnRzW2kyXSA9IGJpdGFuZ2VudC56OwogICAgICAgICAgICBpZiAoZXh0cnVkZSkgewogICAgICAgICAgICAgIGJpdGFuZ2VudHNbaSArIGJvdHRvbU9mZnNldF0gPSBiaXRhbmdlbnQueDsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2kxICsgYm90dG9tT2Zmc2V0XSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgICAgIGJpdGFuZ2VudHNbaTIgKyBib3R0b21PZmZzZXRdID0gYml0YW5nZW50Lno7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgbGVuZ3RoID0gdGV4dHVyZUNvb3JkaW5hdGVzLmxlbmd0aDsKICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBsZW5ndGg7IGsgKz0gMikgewogICAgICAgIHRleHR1cmVDb29yZGluYXRlc1trXSA9ICh0ZXh0dXJlQ29vcmRpbmF0ZXNba10gLSBtaW5UZXhDb29yZC54KSAvIChtYXhUZXhDb29yZC54IC0gbWluVGV4Q29vcmQueCk7CiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW2sgKyAxXSA9ICh0ZXh0dXJlQ29vcmRpbmF0ZXNbayArIDFdIC0gbWluVGV4Q29vcmQueSkgLyAobWF4VGV4Q29vcmQueSAtIG1pblRleENvb3JkLnkpOwogICAgICB9CiAgICB9CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICBpZiAodmVydGV4Rm9ybWF0LnBvc2l0aW9uKSB7CiAgICAgIGNvbnN0IGZpbmFsUG9zaXRpb25zID0gRWxsaXBzZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnJhaXNlUG9zaXRpb25zVG9IZWlnaHQoCiAgICAgICAgcG9zaXRpb25zLAogICAgICAgIG9wdGlvbnMsCiAgICAgICAgZXh0cnVkZQogICAgICApOwogICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogZmluYWxQb3NpdGlvbnMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgIGF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICB2YWx1ZXM6IHRleHR1cmVDb29yZGluYXRlcwogICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgIGF0dHJpYnV0ZXMubm9ybWFsID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBub3JtYWxzCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgIGF0dHJpYnV0ZXMudGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogdGFuZ2VudHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICBhdHRyaWJ1dGVzLmJpdGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogYml0YW5nZW50cwogICAgICB9KTsKICAgIH0KICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgYXR0cmlidXRlcy5leHRydWRlRGlyZWN0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBleHRydWRlTm9ybWFscwogICAgICB9KTsKICAgIH0KICAgIGlmIChleHRydWRlICYmIGRlZmluZWRfZGVmYXVsdChvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgbGV0IG9mZnNldEF0dHJpYnV0ZSA9IG5ldyBVaW50OEFycmF5KHNpemUpOwogICAgICBpZiAob3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuVE9QKSB7CiAgICAgICAgb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlLmZpbGwoMSwgMCwgc2l6ZSAvIDIpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IG9mZnNldFZhbHVlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgIG9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgfQogICAgICBhdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICB2YWx1ZXM6IG9mZnNldEF0dHJpYnV0ZQogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBhdHRyaWJ1dGVzOwogIH0KICBmdW5jdGlvbiB0b3BJbmRpY2VzKG51bVB0cykgewogICAgY29uc3QgaW5kaWNlcyA9IG5ldyBBcnJheSgxMiAqIChudW1QdHMgKiAobnVtUHRzICsgMSkpIC0gNik7CiAgICBsZXQgaW5kaWNlc0luZGV4ID0gMDsKICAgIGxldCBwcmV2SW5kZXg7CiAgICBsZXQgbnVtSW50ZXJpb3I7CiAgICBsZXQgcG9zaXRpb25JbmRleDsKICAgIGxldCBpOwogICAgbGV0IGo7CiAgICBwcmV2SW5kZXggPSAwOwogICAgcG9zaXRpb25JbmRleCA9IDE7CiAgICBmb3IgKGkgPSAwOyBpIDwgMzsgaSsrKSB7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleCsrOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleDsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwb3NpdGlvbkluZGV4OwogICAgfQogICAgZm9yIChpID0gMjsgaSA8IG51bVB0cyArIDE7ICsraSkgewogICAgICBwb3NpdGlvbkluZGV4ID0gaSAqIChpICsgMSkgLSAxOwogICAgICBwcmV2SW5kZXggPSAoaSAtIDEpICogaSAtIDE7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleCsrOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleDsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwb3NpdGlvbkluZGV4OwogICAgICBudW1JbnRlcmlvciA9IDIgKiBpOwogICAgICBmb3IgKGogPSAwOyBqIDwgbnVtSW50ZXJpb3IgLSAxOyArK2opIHsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXg7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXgrKzsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleDsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXgrKzsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleDsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXg7CiAgICAgIH0KICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwb3NpdGlvbkluZGV4Kys7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4OwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXg7CiAgICB9CiAgICBudW1JbnRlcmlvciA9IG51bVB0cyAqIDI7CiAgICArK3Bvc2l0aW9uSW5kZXg7CiAgICArK3ByZXZJbmRleDsKICAgIGZvciAoaSA9IDA7IGkgPCBudW1JbnRlcmlvciAtIDE7ICsraSkgewogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXg7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4Kys7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4OwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXgrKzsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXg7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleDsKICAgIH0KICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleDsKICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4Kys7CiAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleDsKICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleCsrOwogICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXgrKzsKICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4OwogICAgKytwcmV2SW5kZXg7CiAgICBmb3IgKGkgPSBudW1QdHMgLSAxOyBpID4gMTsgLS1pKSB7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4Kys7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4OwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXg7CiAgICAgIG51bUludGVyaW9yID0gMiAqIGk7CiAgICAgIGZvciAoaiA9IDA7IGogPCBudW1JbnRlcmlvciAtIDE7ICsraikgewogICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleDsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleCsrOwogICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4OwogICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleCsrOwogICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4OwogICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleDsKICAgICAgfQogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleCsrOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleCsrOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXgrKzsKICAgIH0KICAgIGZvciAoaSA9IDA7IGkgPCAzOyBpKyspIHsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXgrKzsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXg7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleDsKICAgIH0KICAgIHJldHVybiBpbmRpY2VzOwogIH0KICBmdW5jdGlvbiBjb21wdXRlRWxsaXBzZShvcHRpb25zKSB7CiAgICBjb25zdCBjZW50ZXIgPSBvcHRpb25zLmNlbnRlcjsKICAgIGJvdW5kaW5nU3BoZXJlQ2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgIG9wdGlvbnMuZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChjZW50ZXIsIGJvdW5kaW5nU3BoZXJlQ2VudGVyKSwKICAgICAgb3B0aW9ucy5oZWlnaHQsCiAgICAgIGJvdW5kaW5nU3BoZXJlQ2VudGVyCiAgICApOwogICAgYm91bmRpbmdTcGhlcmVDZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICBjZW50ZXIsCiAgICAgIGJvdW5kaW5nU3BoZXJlQ2VudGVyLAogICAgICBib3VuZGluZ1NwaGVyZUNlbnRlcgogICAgKTsKICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlID0gbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoCiAgICAgIGJvdW5kaW5nU3BoZXJlQ2VudGVyLAogICAgICBvcHRpb25zLnNlbWlNYWpvckF4aXMKICAgICk7CiAgICBjb25zdCBjZXAgPSBFbGxpcHNlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZUVsbGlwc2VQb3NpdGlvbnMoCiAgICAgIG9wdGlvbnMsCiAgICAgIHRydWUsCiAgICAgIGZhbHNlCiAgICApOwogICAgY29uc3QgcG9zaXRpb25zID0gY2VwLnBvc2l0aW9uczsKICAgIGNvbnN0IG51bVB0cyA9IGNlcC5udW1QdHM7CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gY29tcHV0ZVRvcEJvdHRvbUF0dHJpYnV0ZXMocG9zaXRpb25zLCBvcHRpb25zLCBmYWxzZSk7CiAgICBsZXQgaW5kaWNlcyA9IHRvcEluZGljZXMobnVtUHRzKTsKICAgIGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShwb3NpdGlvbnMubGVuZ3RoIC8gMywgaW5kaWNlcyk7CiAgICByZXR1cm4gewogICAgICBib3VuZGluZ1NwaGVyZSwKICAgICAgYXR0cmlidXRlcywKICAgICAgaW5kaWNlcwogICAgfTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVdhbGxBdHRyaWJ1dGVzKHBvc2l0aW9ucywgb3B0aW9ucykgewogICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gb3B0aW9ucy52ZXJ0ZXhGb3JtYXQ7CiAgICBjb25zdCBjZW50ZXIgPSBvcHRpb25zLmNlbnRlcjsKICAgIGNvbnN0IHNlbWlNYWpvckF4aXMgPSBvcHRpb25zLnNlbWlNYWpvckF4aXM7CiAgICBjb25zdCBzZW1pTWlub3JBeGlzID0gb3B0aW9ucy5zZW1pTWlub3JBeGlzOwogICAgY29uc3QgZWxsaXBzb2lkID0gb3B0aW9ucy5lbGxpcHNvaWQ7CiAgICBjb25zdCBoZWlnaHQgPSBvcHRpb25zLmhlaWdodDsKICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gb3B0aW9ucy5leHRydWRlZEhlaWdodDsKICAgIGNvbnN0IHN0Um90YXRpb24gPSBvcHRpb25zLnN0Um90YXRpb247CiAgICBjb25zdCBzaXplID0gcG9zaXRpb25zLmxlbmd0aCAvIDMgKiAyOwogICAgY29uc3QgZmluYWxQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHNpemUgKiAzKTsKICAgIGNvbnN0IHRleHR1cmVDb29yZGluYXRlcyA9IHZlcnRleEZvcm1hdC5zdCA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDIpIDogdm9pZCAwOwogICAgY29uc3Qgbm9ybWFscyA9IHZlcnRleEZvcm1hdC5ub3JtYWwgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUgKiAzKSA6IHZvaWQgMDsKICAgIGNvbnN0IHRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LnRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUgKiAzKSA6IHZvaWQgMDsKICAgIGNvbnN0IGJpdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShzaXplICogMykgOiB2b2lkIDA7CiAgICBjb25zdCBzaGFkb3dWb2x1bWUgPSBvcHRpb25zLnNoYWRvd1ZvbHVtZTsKICAgIGNvbnN0IGV4dHJ1ZGVOb3JtYWxzID0gc2hhZG93Vm9sdW1lID8gbmV3IEZsb2F0MzJBcnJheShzaXplICogMykgOiB2b2lkIDA7CiAgICBsZXQgdGV4dHVyZUNvb3JkSW5kZXggPSAwOwogICAgbGV0IG5vcm1hbDIgPSBzY3JhdGNoTm9ybWFsMzsKICAgIGxldCB0YW5nZW50ID0gc2NyYXRjaFRhbmdlbnQ7CiAgICBsZXQgYml0YW5nZW50ID0gc2NyYXRjaEJpdGFuZ2VudDsKICAgIGNvbnN0IHByb2plY3Rpb24gPSBuZXcgR2VvZ3JhcGhpY1Byb2plY3Rpb25fZGVmYXVsdChlbGxpcHNvaWQpOwogICAgY29uc3QgcHJvamVjdGVkQ2VudGVyID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoY2VudGVyLCBzY3JhdGNoQ2FydG9ncmFwaGljMiksCiAgICAgIHByb2plY3RlZENlbnRlclNjcmF0Y2gKICAgICk7CiAgICBjb25zdCBnZW9kZXRpY05vcm1hbCA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKAogICAgICBjZW50ZXIsCiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xMwogICAgKTsKICAgIGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoZ2VvZGV0aWNOb3JtYWwsIGdlb2RldGljTm9ybWFsKTsKICAgIGNvbnN0IHJvdGF0aW9uID0gUXVhdGVybmlvbl9kZWZhdWx0LmZyb21BeGlzQW5nbGUoCiAgICAgIGdlb2RldGljTm9ybWFsLAogICAgICBzdFJvdGF0aW9uLAogICAgICBxdWF0ZXJuaW9uU2NyYXRjaAogICAgKTsKICAgIGNvbnN0IHRleHR1cmVNYXRyaXggPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24ocm90YXRpb24sIHRleHR1cmVNYXRyaXhTY3JhdGNoKTsKICAgIGNvbnN0IG1pblRleENvb3JkID0gQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21FbGVtZW50cygKICAgICAgTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLAogICAgICBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksCiAgICAgIHNjcmF0Y2hNaW5UZXhDb29yZAogICAgKTsKICAgIGNvbnN0IG1heFRleENvb3JkID0gQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21FbGVtZW50cygKICAgICAgTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZLAogICAgICBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFksCiAgICAgIHNjcmF0Y2hNYXhUZXhDb29yZAogICAgKTsKICAgIGxldCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgY29uc3Qgc3RPZmZzZXQgPSBsZW5ndGggLyAzICogMjsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgY29uc3QgaTEgPSBpICsgMTsKICAgICAgY29uc3QgaTIgPSBpICsgMjsKICAgICAgbGV0IHBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGksIHNjcmF0Y2hDYXJ0ZXNpYW4xMyk7CiAgICAgIGxldCBleHRydWRlZFBvc2l0aW9uOwogICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgY29uc3Qgcm90YXRlZFBvaW50ID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoCiAgICAgICAgICB0ZXh0dXJlTWF0cml4LAogICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuMjQKICAgICAgICApOwogICAgICAgIGNvbnN0IHByb2plY3RlZFBvaW50ID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHJvdGF0ZWRQb2ludCwgc2NyYXRjaENhcnRvZ3JhcGhpYzIpLAogICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjM1CiAgICAgICAgKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocHJvamVjdGVkUG9pbnQsIHByb2plY3RlZENlbnRlciwgcHJvamVjdGVkUG9pbnQpOwogICAgICAgIHRleENvb3JkU2NyYXRjaC54ID0gKHByb2plY3RlZFBvaW50LnggKyBzZW1pTWFqb3JBeGlzKSAvICgyICogc2VtaU1ham9yQXhpcyk7CiAgICAgICAgdGV4Q29vcmRTY3JhdGNoLnkgPSAocHJvamVjdGVkUG9pbnQueSArIHNlbWlNaW5vckF4aXMpIC8gKDIgKiBzZW1pTWlub3JBeGlzKTsKICAgICAgICBtaW5UZXhDb29yZC54ID0gTWF0aC5taW4odGV4Q29vcmRTY3JhdGNoLngsIG1pblRleENvb3JkLngpOwogICAgICAgIG1pblRleENvb3JkLnkgPSBNYXRoLm1pbih0ZXhDb29yZFNjcmF0Y2gueSwgbWluVGV4Q29vcmQueSk7CiAgICAgICAgbWF4VGV4Q29vcmQueCA9IE1hdGgubWF4KHRleENvb3JkU2NyYXRjaC54LCBtYXhUZXhDb29yZC54KTsKICAgICAgICBtYXhUZXhDb29yZC55ID0gTWF0aC5tYXgodGV4Q29vcmRTY3JhdGNoLnksIG1heFRleENvb3JkLnkpOwogICAgICAgIHRleHR1cmVDb29yZGluYXRlc1t0ZXh0dXJlQ29vcmRJbmRleCArIHN0T2Zmc2V0XSA9IHRleENvb3JkU2NyYXRjaC54OwogICAgICAgIHRleHR1cmVDb29yZGluYXRlc1t0ZXh0dXJlQ29vcmRJbmRleCArIDEgKyBzdE9mZnNldF0gPSB0ZXhDb29yZFNjcmF0Y2gueTsKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbdGV4dHVyZUNvb3JkSW5kZXgrK10gPSB0ZXhDb29yZFNjcmF0Y2gueDsKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbdGV4dHVyZUNvb3JkSW5kZXgrK10gPSB0ZXhDb29yZFNjcmF0Y2gueTsKICAgICAgfQogICAgICBwb3NpdGlvbiA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKHBvc2l0aW9uLCBwb3NpdGlvbik7CiAgICAgIGV4dHJ1ZGVkUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocG9zaXRpb24sIHNjcmF0Y2hDYXJ0ZXNpYW4yNCk7CiAgICAgIG5vcm1hbDIgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHBvc2l0aW9uLCBub3JtYWwyKTsKICAgICAgaWYgKHNoYWRvd1ZvbHVtZSkgewogICAgICAgIGV4dHJ1ZGVOb3JtYWxzW2kgKyBsZW5ndGhdID0gLW5vcm1hbDIueDsKICAgICAgICBleHRydWRlTm9ybWFsc1tpMSArIGxlbmd0aF0gPSAtbm9ybWFsMi55OwogICAgICAgIGV4dHJ1ZGVOb3JtYWxzW2kyICsgbGVuZ3RoXSA9IC1ub3JtYWwyLno7CiAgICAgIH0KICAgICAgbGV0IHNjYWxlZE5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgIG5vcm1hbDIsCiAgICAgICAgaGVpZ2h0LAogICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW40CiAgICAgICk7CiAgICAgIHBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwb3NpdGlvbiwgc2NhbGVkTm9ybWFsLCBwb3NpdGlvbik7CiAgICAgIHNjYWxlZE5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgIG5vcm1hbDIsCiAgICAgICAgZXh0cnVkZWRIZWlnaHQsCiAgICAgICAgc2NhbGVkTm9ybWFsCiAgICAgICk7CiAgICAgIGV4dHJ1ZGVkUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgIGV4dHJ1ZGVkUG9zaXRpb24sCiAgICAgICAgc2NhbGVkTm9ybWFsLAogICAgICAgIGV4dHJ1ZGVkUG9zaXRpb24KICAgICAgKTsKICAgICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICAgIGZpbmFsUG9zaXRpb25zW2kgKyBsZW5ndGhdID0gZXh0cnVkZWRQb3NpdGlvbi54OwogICAgICAgIGZpbmFsUG9zaXRpb25zW2kxICsgbGVuZ3RoXSA9IGV4dHJ1ZGVkUG9zaXRpb24ueTsKICAgICAgICBmaW5hbFBvc2l0aW9uc1tpMiArIGxlbmd0aF0gPSBleHRydWRlZFBvc2l0aW9uLno7CiAgICAgICAgZmluYWxQb3NpdGlvbnNbaV0gPSBwb3NpdGlvbi54OwogICAgICAgIGZpbmFsUG9zaXRpb25zW2kxXSA9IHBvc2l0aW9uLnk7CiAgICAgICAgZmluYWxQb3NpdGlvbnNbaTJdID0gcG9zaXRpb24uejsKICAgICAgfQogICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCB8fCB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgYml0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG5vcm1hbDIsIGJpdGFuZ2VudCk7CiAgICAgICAgY29uc3QgbmV4dCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAoaSArIDMpICUgbGVuZ3RoLAogICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjQKICAgICAgICApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChuZXh0LCBwb3NpdGlvbiwgbmV4dCk7CiAgICAgICAgY29uc3QgYm90dG9tID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgZXh0cnVkZWRQb3NpdGlvbiwKICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjM1CiAgICAgICAgKTsKICAgICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhib3R0b20sIG5leHQsIG5vcm1hbDIpLAogICAgICAgICAgbm9ybWFsMgogICAgICAgICk7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICAgIG5vcm1hbHNbaV0gPSBub3JtYWwyLng7CiAgICAgICAgICBub3JtYWxzW2kxXSA9IG5vcm1hbDIueTsKICAgICAgICAgIG5vcm1hbHNbaTJdID0gbm9ybWFsMi56OwogICAgICAgICAgbm9ybWFsc1tpICsgbGVuZ3RoXSA9IG5vcm1hbDIueDsKICAgICAgICAgIG5vcm1hbHNbaTEgKyBsZW5ndGhdID0gbm9ybWFsMi55OwogICAgICAgICAgbm9ybWFsc1tpMiArIGxlbmd0aF0gPSBub3JtYWwyLno7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhiaXRhbmdlbnQsIG5vcm1hbDIsIHRhbmdlbnQpLAogICAgICAgICAgICB0YW5nZW50CiAgICAgICAgICApOwogICAgICAgICAgdGFuZ2VudHNbaV0gPSB0YW5nZW50Lng7CiAgICAgICAgICB0YW5nZW50c1tpMV0gPSB0YW5nZW50Lnk7CiAgICAgICAgICB0YW5nZW50c1tpMl0gPSB0YW5nZW50Lno7CiAgICAgICAgICB0YW5nZW50c1tpICsgbGVuZ3RoXSA9IHRhbmdlbnQueDsKICAgICAgICAgIHRhbmdlbnRzW2kgKyAxICsgbGVuZ3RoXSA9IHRhbmdlbnQueTsKICAgICAgICAgIHRhbmdlbnRzW2kgKyAyICsgbGVuZ3RoXSA9IHRhbmdlbnQuejsKICAgICAgICB9CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgIGJpdGFuZ2VudHNbaV0gPSBiaXRhbmdlbnQueDsKICAgICAgICAgIGJpdGFuZ2VudHNbaTFdID0gYml0YW5nZW50Lnk7CiAgICAgICAgICBiaXRhbmdlbnRzW2kyXSA9IGJpdGFuZ2VudC56OwogICAgICAgICAgYml0YW5nZW50c1tpICsgbGVuZ3RoXSA9IGJpdGFuZ2VudC54OwogICAgICAgICAgYml0YW5nZW50c1tpMSArIGxlbmd0aF0gPSBiaXRhbmdlbnQueTsKICAgICAgICAgIGJpdGFuZ2VudHNbaTIgKyBsZW5ndGhdID0gYml0YW5nZW50Lno7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgIGxlbmd0aCA9IHRleHR1cmVDb29yZGluYXRlcy5sZW5ndGg7CiAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgbGVuZ3RoOyBrICs9IDIpIHsKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNba10gPSAodGV4dHVyZUNvb3JkaW5hdGVzW2tdIC0gbWluVGV4Q29vcmQueCkgLyAobWF4VGV4Q29vcmQueCAtIG1pblRleENvb3JkLngpOwogICAgICAgIHRleHR1cmVDb29yZGluYXRlc1trICsgMV0gPSAodGV4dHVyZUNvb3JkaW5hdGVzW2sgKyAxXSAtIG1pblRleENvb3JkLnkpIC8gKG1heFRleENvb3JkLnkgLSBtaW5UZXhDb29yZC55KTsKICAgICAgfQogICAgfQogICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpOwogICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogZmluYWxQb3NpdGlvbnMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgIGF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICB2YWx1ZXM6IHRleHR1cmVDb29yZGluYXRlcwogICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgIGF0dHJpYnV0ZXMubm9ybWFsID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBub3JtYWxzCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgIGF0dHJpYnV0ZXMudGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogdGFuZ2VudHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICBhdHRyaWJ1dGVzLmJpdGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogYml0YW5nZW50cwogICAgICB9KTsKICAgIH0KICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgYXR0cmlidXRlcy5leHRydWRlRGlyZWN0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBleHRydWRlTm9ybWFscwogICAgICB9KTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgIGxldCBvZmZzZXRBdHRyaWJ1dGUgPSBuZXcgVWludDhBcnJheShzaXplKTsKICAgICAgaWYgKG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0LlRPUCkgewogICAgICAgIG9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZS5maWxsKDEsIDAsIHNpemUgLyAyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICBvZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgIH0KICAgICAgYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgdmFsdWVzOiBvZmZzZXRBdHRyaWJ1dGUKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gYXR0cmlidXRlczsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVdhbGxJbmRpY2VzKHBvc2l0aW9ucykgewogICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobGVuZ3RoLCBsZW5ndGggKiA2KTsKICAgIGxldCBpbmRleCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IFVMID0gaTsKICAgICAgY29uc3QgTEwgPSBpICsgbGVuZ3RoOwogICAgICBjb25zdCBVUiA9IChVTCArIDEpICUgbGVuZ3RoOwogICAgICBjb25zdCBMUiA9IFVSICsgbGVuZ3RoOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gVUw7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gVVI7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExSOwogICAgfQogICAgcmV0dXJuIGluZGljZXM7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVFeHRydWRlZEVsbGlwc2Uob3B0aW9ucykgewogICAgY29uc3QgY2VudGVyID0gb3B0aW9ucy5jZW50ZXI7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBvcHRpb25zLmVsbGlwc29pZDsKICAgIGNvbnN0IHNlbWlNYWpvckF4aXMgPSBvcHRpb25zLnNlbWlNYWpvckF4aXM7CiAgICBsZXQgc2NhbGVkTm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgIGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoY2VudGVyLCBzY3JhdGNoQ2FydGVzaWFuMTMpLAogICAgICBvcHRpb25zLmhlaWdodCwKICAgICAgc2NyYXRjaENhcnRlc2lhbjEzCiAgICApOwogICAgdG9wQm91bmRpbmdTcGhlcmUuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgY2VudGVyLAogICAgICBzY2FsZWROb3JtYWwsCiAgICAgIHRvcEJvdW5kaW5nU3BoZXJlLmNlbnRlcgogICAgKTsKICAgIHRvcEJvdW5kaW5nU3BoZXJlLnJhZGl1cyA9IHNlbWlNYWpvckF4aXM7CiAgICBzY2FsZWROb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChjZW50ZXIsIHNjYWxlZE5vcm1hbCksCiAgICAgIG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQsCiAgICAgIHNjYWxlZE5vcm1hbAogICAgKTsKICAgIGJvdHRvbUJvdW5kaW5nU3BoZXJlLmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgIGNlbnRlciwKICAgICAgc2NhbGVkTm9ybWFsLAogICAgICBib3R0b21Cb3VuZGluZ1NwaGVyZS5jZW50ZXIKICAgICk7CiAgICBib3R0b21Cb3VuZGluZ1NwaGVyZS5yYWRpdXMgPSBzZW1pTWFqb3JBeGlzOwogICAgY29uc3QgY2VwID0gRWxsaXBzZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVFbGxpcHNlUG9zaXRpb25zKAogICAgICBvcHRpb25zLAogICAgICB0cnVlLAogICAgICB0cnVlCiAgICApOwogICAgY29uc3QgcG9zaXRpb25zID0gY2VwLnBvc2l0aW9uczsKICAgIGNvbnN0IG51bVB0cyA9IGNlcC5udW1QdHM7CiAgICBjb25zdCBvdXRlclBvc2l0aW9ucyA9IGNlcC5vdXRlclBvc2l0aW9uczsKICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC51bmlvbigKICAgICAgdG9wQm91bmRpbmdTcGhlcmUsCiAgICAgIGJvdHRvbUJvdW5kaW5nU3BoZXJlCiAgICApOwogICAgY29uc3QgdG9wQm90dG9tQXR0cmlidXRlcyA9IGNvbXB1dGVUb3BCb3R0b21BdHRyaWJ1dGVzKAogICAgICBwb3NpdGlvbnMsCiAgICAgIG9wdGlvbnMsCiAgICAgIHRydWUKICAgICk7CiAgICBsZXQgaW5kaWNlcyA9IHRvcEluZGljZXMobnVtUHRzKTsKICAgIGNvbnN0IGxlbmd0aCA9IGluZGljZXMubGVuZ3RoOwogICAgaW5kaWNlcy5sZW5ndGggPSBsZW5ndGggKiAyOwogICAgY29uc3QgcG9zTGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAzKSB7CiAgICAgIGluZGljZXNbaSArIGxlbmd0aF0gPSBpbmRpY2VzW2kgKyAyXSArIHBvc0xlbmd0aDsKICAgICAgaW5kaWNlc1tpICsgMSArIGxlbmd0aF0gPSBpbmRpY2VzW2kgKyAxXSArIHBvc0xlbmd0aDsKICAgICAgaW5kaWNlc1tpICsgMiArIGxlbmd0aF0gPSBpbmRpY2VzW2ldICsgcG9zTGVuZ3RoOwogICAgfQogICAgY29uc3QgdG9wQm90dG9tSW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBwb3NMZW5ndGggKiAyIC8gMywKICAgICAgaW5kaWNlcwogICAgKTsKICAgIGNvbnN0IHRvcEJvdHRvbUdlbyA9IG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgYXR0cmlidXRlczogdG9wQm90dG9tQXR0cmlidXRlcywKICAgICAgaW5kaWNlczogdG9wQm90dG9tSW5kaWNlcywKICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUwogICAgfSk7CiAgICBjb25zdCB3YWxsQXR0cmlidXRlcyA9IGNvbXB1dGVXYWxsQXR0cmlidXRlcyhvdXRlclBvc2l0aW9ucywgb3B0aW9ucyk7CiAgICBpbmRpY2VzID0gY29tcHV0ZVdhbGxJbmRpY2VzKG91dGVyUG9zaXRpb25zKTsKICAgIGNvbnN0IHdhbGxJbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIG91dGVyUG9zaXRpb25zLmxlbmd0aCAqIDIgLyAzLAogICAgICBpbmRpY2VzCiAgICApOwogICAgY29uc3Qgd2FsbEdlbyA9IG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgYXR0cmlidXRlczogd2FsbEF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXM6IHdhbGxJbmRpY2VzLAogICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTCiAgICB9KTsKICAgIGNvbnN0IGdlbyA9IEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5jb21iaW5lSW5zdGFuY2VzKFsKICAgICAgbmV3IEdlb21ldHJ5SW5zdGFuY2VfZGVmYXVsdCh7CiAgICAgICAgZ2VvbWV0cnk6IHRvcEJvdHRvbUdlbwogICAgICB9KSwKICAgICAgbmV3IEdlb21ldHJ5SW5zdGFuY2VfZGVmYXVsdCh7CiAgICAgICAgZ2VvbWV0cnk6IHdhbGxHZW8KICAgICAgfSkKICAgIF0pOwogICAgcmV0dXJuIHsKICAgICAgYm91bmRpbmdTcGhlcmUsCiAgICAgIGF0dHJpYnV0ZXM6IGdlb1swXS5hdHRyaWJ1dGVzLAogICAgICBpbmRpY2VzOiBnZW9bMF0uaW5kaWNlcwogICAgfTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVJlY3RhbmdsZShjZW50ZXIsIHNlbWlNYWpvckF4aXMsIHNlbWlNaW5vckF4aXMsIHJvdGF0aW9uLCBncmFudWxhcml0eSwgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgIGNvbnN0IGNlcCA9IEVsbGlwc2VHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlRWxsaXBzZVBvc2l0aW9ucygKICAgICAgewogICAgICAgIGNlbnRlciwKICAgICAgICBzZW1pTWFqb3JBeGlzLAogICAgICAgIHNlbWlNaW5vckF4aXMsCiAgICAgICAgcm90YXRpb24sCiAgICAgICAgZ3JhbnVsYXJpdHkKICAgICAgfSwKICAgICAgZmFsc2UsCiAgICAgIHRydWUKICAgICk7CiAgICBjb25zdCBwb3NpdGlvbnNGbGF0ID0gY2VwLm91dGVyUG9zaXRpb25zOwogICAgY29uc3QgcG9zaXRpb25zQ291bnQgPSBwb3NpdGlvbnNGbGF0Lmxlbmd0aCAvIDM7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgQXJyYXkocG9zaXRpb25zQ291bnQpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnNDb3VudDsgKytpKSB7CiAgICAgIHBvc2l0aW9uc1tpXSA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zRmxhdCwgaSAqIDMpOwogICAgfQogICAgY29uc3QgcmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuZnJvbUNhcnRlc2lhbkFycmF5KHBvc2l0aW9ucywgZWxsaXBzb2lkLCByZXN1bHQpOwogICAgaWYgKHJlY3RhbmdsZS53aWR0aCA+IE1hdGhfZGVmYXVsdC5QSSkgewogICAgICByZWN0YW5nbGUubm9ydGggPSByZWN0YW5nbGUubm9ydGggPiAwID8gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIC0gTWF0aF9kZWZhdWx0LkVQU0lMT043IDogcmVjdGFuZ2xlLm5vcnRoOwogICAgICByZWN0YW5nbGUuc291dGggPSByZWN0YW5nbGUuc291dGggPCAwID8gTWF0aF9kZWZhdWx0LkVQU0lMT043IC0gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIDogcmVjdGFuZ2xlLnNvdXRoOwogICAgICByZWN0YW5nbGUuZWFzdCA9IE1hdGhfZGVmYXVsdC5QSTsKICAgICAgcmVjdGFuZ2xlLndlc3QgPSAtTWF0aF9kZWZhdWx0LlBJOwogICAgfQogICAgcmV0dXJuIHJlY3RhbmdsZTsKICB9CiAgZnVuY3Rpb24gRWxsaXBzZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgY2VudGVyID0gb3B0aW9ucy5jZW50ZXI7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgY29uc3Qgc2VtaU1ham9yQXhpcyA9IG9wdGlvbnMuc2VtaU1ham9yQXhpczsKICAgIGNvbnN0IHNlbWlNaW5vckF4aXMgPSBvcHRpb25zLnNlbWlNaW5vckF4aXM7CiAgICBjb25zdCBncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFCiAgICApOwogICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy52ZXJ0ZXhGb3JtYXQsIFZlcnRleEZvcm1hdF9kZWZhdWx0LkRFRkFVTFQpOwogICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvcHRpb25zLmNlbnRlciIsIGNlbnRlcik7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIm9wdGlvbnMuc2VtaU1ham9yQXhpcyIsIHNlbWlNYWpvckF4aXMpOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJvcHRpb25zLnNlbWlNaW5vckF4aXMiLCBzZW1pTWlub3JBeGlzKTsKICAgIGlmIChzZW1pTWFqb3JBeGlzIDwgc2VtaU1pbm9yQXhpcykgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAic2VtaU1ham9yQXhpcyBtdXN0IGJlIGdyZWF0ZXIgdGhhbiBvciBlcXVhbCB0byB0aGUgc2VtaU1pbm9yQXhpcy4iCiAgICAgICk7CiAgICB9CiAgICBpZiAoZ3JhbnVsYXJpdHkgPD0gMCkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZ3JhbnVsYXJpdHkgbXVzdCBiZSBncmVhdGVyIHRoYW4gemVyby4iKTsKICAgIH0KICAgIGNvbnN0IGhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuaGVpZ2h0LCAwKTsKICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5leHRydWRlZEhlaWdodCwgaGVpZ2h0KTsKICAgIHRoaXMuX2NlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjZW50ZXIpOwogICAgdGhpcy5fc2VtaU1ham9yQXhpcyA9IHNlbWlNYWpvckF4aXM7CiAgICB0aGlzLl9zZW1pTWlub3JBeGlzID0gc2VtaU1pbm9yQXhpczsKICAgIHRoaXMuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCk7CiAgICB0aGlzLl9yb3RhdGlvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMucm90YXRpb24sIDApOwogICAgdGhpcy5fc3RSb3RhdGlvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuc3RSb3RhdGlvbiwgMCk7CiAgICB0aGlzLl9oZWlnaHQgPSBNYXRoLm1heChleHRydWRlZEhlaWdodCwgaGVpZ2h0KTsKICAgIHRoaXMuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICB0aGlzLl92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSh2ZXJ0ZXhGb3JtYXQpOwogICAgdGhpcy5fZXh0cnVkZWRIZWlnaHQgPSBNYXRoLm1pbihleHRydWRlZEhlaWdodCwgaGVpZ2h0KTsKICAgIHRoaXMuX3NoYWRvd1ZvbHVtZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuc2hhZG93Vm9sdW1lLCBmYWxzZSk7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUVsbGlwc2VHZW9tZXRyeSI7CiAgICB0aGlzLl9vZmZzZXRBdHRyaWJ1dGUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZTsKICAgIHRoaXMuX3JlY3RhbmdsZSA9IHZvaWQgMDsKICAgIHRoaXMuX3RleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHMgPSB2b2lkIDA7CiAgfQogIGZ1bmN0aW9uIHRleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHMoZWxsaXBzZUdlb21ldHJ5KSB7CiAgICBjb25zdCBzdFJvdGF0aW9uID0gLWVsbGlwc2VHZW9tZXRyeS5fc3RSb3RhdGlvbjsKICAgIGlmIChzdFJvdGF0aW9uID09PSAwKSB7CiAgICAgIHJldHVybiBbMCwgMCwgMCwgMSwgMSwgMF07CiAgICB9CiAgICBjb25zdCBjZXAgPSBFbGxpcHNlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZUVsbGlwc2VQb3NpdGlvbnMoCiAgICAgIHsKICAgICAgICBjZW50ZXI6IGVsbGlwc2VHZW9tZXRyeS5fY2VudGVyLAogICAgICAgIHNlbWlNYWpvckF4aXM6IGVsbGlwc2VHZW9tZXRyeS5fc2VtaU1ham9yQXhpcywKICAgICAgICBzZW1pTWlub3JBeGlzOiBlbGxpcHNlR2VvbWV0cnkuX3NlbWlNaW5vckF4aXMsCiAgICAgICAgcm90YXRpb246IGVsbGlwc2VHZW9tZXRyeS5fcm90YXRpb24sCiAgICAgICAgZ3JhbnVsYXJpdHk6IGVsbGlwc2VHZW9tZXRyeS5fZ3JhbnVsYXJpdHkKICAgICAgfSwKICAgICAgZmFsc2UsCiAgICAgIHRydWUKICAgICk7CiAgICBjb25zdCBwb3NpdGlvbnNGbGF0ID0gY2VwLm91dGVyUG9zaXRpb25zOwogICAgY29uc3QgcG9zaXRpb25zQ291bnQgPSBwb3NpdGlvbnNGbGF0Lmxlbmd0aCAvIDM7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgQXJyYXkocG9zaXRpb25zQ291bnQpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnNDb3VudDsgKytpKSB7CiAgICAgIHBvc2l0aW9uc1tpXSA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zRmxhdCwgaSAqIDMpOwogICAgfQogICAgY29uc3QgZWxsaXBzb2lkID0gZWxsaXBzZUdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICBjb25zdCBib3VuZGluZ1JlY3RhbmdsZSA9IGVsbGlwc2VHZW9tZXRyeS5yZWN0YW5nbGU7CiAgICByZXR1cm4gR2VvbWV0cnlfZGVmYXVsdC5fdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50cygKICAgICAgcG9zaXRpb25zLAogICAgICBzdFJvdGF0aW9uLAogICAgICBlbGxpcHNvaWQsCiAgICAgIGJvdW5kaW5nUmVjdGFuZ2xlCiAgICApOwogIH0KICB2YXIgc2NyYXRjaENhcnRlc2lhbjEzLCBzY3JhdGNoQ2FydGVzaWFuMjQsIHNjcmF0Y2hDYXJ0ZXNpYW4zNSwgc2NyYXRjaENhcnRlc2lhbjQsIHRleENvb3JkU2NyYXRjaCwgdGV4dHVyZU1hdHJpeFNjcmF0Y2gsIHRhbmdlbnRNYXRyaXhTY3JhdGNoLCBxdWF0ZXJuaW9uU2NyYXRjaCwgc2NyYXRjaE5vcm1hbDMsIHNjcmF0Y2hUYW5nZW50LCBzY3JhdGNoQml0YW5nZW50LCBzY3JhdGNoQ2FydG9ncmFwaGljMiwgcHJvamVjdGVkQ2VudGVyU2NyYXRjaCwgc2NyYXRjaE1pblRleENvb3JkLCBzY3JhdGNoTWF4VGV4Q29vcmQsIGJvdW5kaW5nU3BoZXJlQ2VudGVyLCB0b3BCb3VuZGluZ1NwaGVyZSwgYm90dG9tQm91bmRpbmdTcGhlcmUsIHNjcmF0Y2hDZW50ZXIyLCBzY3JhdGNoRWxsaXBzb2lkLCBzY3JhdGNoVmVydGV4Rm9ybWF0Miwgc2NyYXRjaE9wdGlvbnMzLCBFbGxpcHNlR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9FbGxpcHNlR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc2VHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNlR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvZ3JhcGhpY1Byb2plY3Rpb24oKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlJbnN0YW5jZSgpOwogICAgICBpbml0X0dlb21ldHJ5T2Zmc2V0QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlQaXBlbGluZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9RdWF0ZXJuaW9uKCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfVmVydGV4Rm9ybWF0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjI0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMzUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW40ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB0ZXhDb29yZFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIHRleHR1cmVNYXRyaXhTY3JhdGNoID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICB0YW5nZW50TWF0cml4U2NyYXRjaCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgcXVhdGVybmlvblNjcmF0Y2ggPSBuZXcgUXVhdGVybmlvbl9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hOb3JtYWwzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVGFuZ2VudCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEJpdGFuZ2VudCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzIgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgcHJvamVjdGVkQ2VudGVyU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE1pblRleENvb3JkID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTWF4VGV4Q29vcmQgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIGJvdW5kaW5nU3BoZXJlQ2VudGVyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB0b3BCb3VuZGluZ1NwaGVyZSA9IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KCk7CiAgICAgIGJvdHRvbUJvdW5kaW5nU3BoZXJlID0gbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoKTsKICAgICAgRWxsaXBzZUdlb21ldHJ5LnBhY2tlZExlbmd0aCA9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyA5OwogICAgICBFbGxpcHNlR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmFsdWUuX2NlbnRlciwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrKHZhbHVlLl92ZXJ0ZXhGb3JtYXQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3NlbWlNYWpvckF4aXM7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zZW1pTWlub3JBeGlzOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fcm90YXRpb247CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zdFJvdGF0aW9uOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5faGVpZ2h0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9leHRydWRlZEhlaWdodDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3NoYWRvd1ZvbHVtZSA/IDEgOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmFsdWUuX29mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaENlbnRlcjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQgPSBuZXcgRWxsaXBzb2lkX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDIgPSBuZXcgVmVydGV4Rm9ybWF0X2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE9wdGlvbnMzID0gewogICAgICAgIGNlbnRlcjogc2NyYXRjaENlbnRlcjIsCiAgICAgICAgZWxsaXBzb2lkOiBzY3JhdGNoRWxsaXBzb2lkLAogICAgICAgIHZlcnRleEZvcm1hdDogc2NyYXRjaFZlcnRleEZvcm1hdDIsCiAgICAgICAgc2VtaU1ham9yQXhpczogdm9pZCAwLAogICAgICAgIHNlbWlNaW5vckF4aXM6IHZvaWQgMCwKICAgICAgICByb3RhdGlvbjogdm9pZCAwLAogICAgICAgIHN0Um90YXRpb246IHZvaWQgMCwKICAgICAgICBoZWlnaHQ6IHZvaWQgMCwKICAgICAgICBncmFudWxhcml0eTogdm9pZCAwLAogICAgICAgIGV4dHJ1ZGVkSGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgc2hhZG93Vm9sdW1lOiB2b2lkIDAsCiAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiB2b2lkIDAKICAgICAgfTsKICAgICAgRWxsaXBzZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBjZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoQ2VudGVyMik7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaEVsbGlwc29pZCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDIKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IHNlbWlNYWpvckF4aXMgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHNlbWlNaW5vckF4aXMgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHJvdGF0aW9uID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzdFJvdGF0aW9uID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBoZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgc2hhZG93Vm9sdW1lID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9PT0gMTsKICAgICAgICBjb25zdCBvZmZzZXRBdHRyaWJ1dGUgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczMuaGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMzLmV4dHJ1ZGVkSGVpZ2h0ID0gZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczMuZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMy5zdFJvdGF0aW9uID0gc3RSb3RhdGlvbjsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMy5yb3RhdGlvbiA9IHJvdGF0aW9uOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMzLnNlbWlNYWpvckF4aXMgPSBzZW1pTWFqb3JBeGlzOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMzLnNlbWlNaW5vckF4aXMgPSBzZW1pTWlub3JBeGlzOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMzLnNoYWRvd1ZvbHVtZSA9IHNoYWRvd1ZvbHVtZTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMy5vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgICAgcmV0dXJuIG5ldyBFbGxpcHNlR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnMzKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY2VudGVyLCByZXN1bHQuX2NlbnRlcik7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQsIHJlc3VsdC5fZWxsaXBzb2lkKTsKICAgICAgICByZXN1bHQuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCwgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQpOwogICAgICAgIHJlc3VsdC5fc2VtaU1ham9yQXhpcyA9IHNlbWlNYWpvckF4aXM7CiAgICAgICAgcmVzdWx0Ll9zZW1pTWlub3JBeGlzID0gc2VtaU1pbm9yQXhpczsKICAgICAgICByZXN1bHQuX3JvdGF0aW9uID0gcm90YXRpb247CiAgICAgICAgcmVzdWx0Ll9zdFJvdGF0aW9uID0gc3RSb3RhdGlvbjsKICAgICAgICByZXN1bHQuX2hlaWdodCA9IGhlaWdodDsKICAgICAgICByZXN1bHQuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgcmVzdWx0Ll9leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIHJlc3VsdC5fc2hhZG93Vm9sdW1lID0gc2hhZG93Vm9sdW1lOwogICAgICAgIHJlc3VsdC5fb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBFbGxpcHNlR2VvbWV0cnkuY29tcHV0ZVJlY3RhbmdsZSA9IGZ1bmN0aW9uKG9wdGlvbnMsIHJlc3VsdCkgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGNvbnN0IGNlbnRlciA9IG9wdGlvbnMuY2VudGVyOwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICAgICAgY29uc3Qgc2VtaU1ham9yQXhpcyA9IG9wdGlvbnMuc2VtaU1ham9yQXhpczsKICAgICAgICBjb25zdCBzZW1pTWlub3JBeGlzID0gb3B0aW9ucy5zZW1pTWlub3JBeGlzOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICAgICAgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRQogICAgICAgICk7CiAgICAgICAgY29uc3Qgcm90YXRpb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnJvdGF0aW9uLCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9wdGlvbnMuY2VudGVyIiwgY2VudGVyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIm9wdGlvbnMuc2VtaU1ham9yQXhpcyIsIHNlbWlNYWpvckF4aXMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigib3B0aW9ucy5zZW1pTWlub3JBeGlzIiwgc2VtaU1pbm9yQXhpcyk7CiAgICAgICAgaWYgKHNlbWlNYWpvckF4aXMgPCBzZW1pTWlub3JBeGlzKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgInNlbWlNYWpvckF4aXMgbXVzdCBiZSBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8gdGhlIHNlbWlNaW5vckF4aXMuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaWYgKGdyYW51bGFyaXR5IDw9IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJncmFudWxhcml0eSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvLiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29tcHV0ZVJlY3RhbmdsZSgKICAgICAgICAgIGNlbnRlciwKICAgICAgICAgIHNlbWlNYWpvckF4aXMsCiAgICAgICAgICBzZW1pTWlub3JBeGlzLAogICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIEVsbGlwc2VHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKGVsbGlwc2VHZW9tZXRyeSkgewogICAgICAgIGlmIChlbGxpcHNlR2VvbWV0cnkuX3NlbWlNYWpvckF4aXMgPD0gMCB8fCBlbGxpcHNlR2VvbWV0cnkuX3NlbWlNaW5vckF4aXMgPD0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBoZWlnaHQgPSBlbGxpcHNlR2VvbWV0cnkuX2hlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGVsbGlwc2VHZW9tZXRyeS5fZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgY29uc3QgZXh0cnVkZSA9ICFNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGhlaWdodCwKICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICAgICAgMCwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMgogICAgICAgICk7CiAgICAgICAgZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIgPSBlbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKAogICAgICAgICAgZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIsCiAgICAgICAgICBlbGxpcHNlR2VvbWV0cnkuX2NlbnRlcgogICAgICAgICk7CiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHsKICAgICAgICAgIGNlbnRlcjogZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIsCiAgICAgICAgICBzZW1pTWFqb3JBeGlzOiBlbGxpcHNlR2VvbWV0cnkuX3NlbWlNYWpvckF4aXMsCiAgICAgICAgICBzZW1pTWlub3JBeGlzOiBlbGxpcHNlR2VvbWV0cnkuX3NlbWlNaW5vckF4aXMsCiAgICAgICAgICBlbGxpcHNvaWQ6IGVsbGlwc2VHZW9tZXRyeS5fZWxsaXBzb2lkLAogICAgICAgICAgcm90YXRpb246IGVsbGlwc2VHZW9tZXRyeS5fcm90YXRpb24sCiAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICBncmFudWxhcml0eTogZWxsaXBzZUdlb21ldHJ5Ll9ncmFudWxhcml0eSwKICAgICAgICAgIHZlcnRleEZvcm1hdDogZWxsaXBzZUdlb21ldHJ5Ll92ZXJ0ZXhGb3JtYXQsCiAgICAgICAgICBzdFJvdGF0aW9uOiBlbGxpcHNlR2VvbWV0cnkuX3N0Um90YXRpb24KICAgICAgICB9OwogICAgICAgIGxldCBnZW9tZXRyeTsKICAgICAgICBpZiAoZXh0cnVkZSkgewogICAgICAgICAgb3B0aW9ucy5leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgICAgb3B0aW9ucy5zaGFkb3dWb2x1bWUgPSBlbGxpcHNlR2VvbWV0cnkuX3NoYWRvd1ZvbHVtZTsKICAgICAgICAgIG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlID0gZWxsaXBzZUdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgICBnZW9tZXRyeSA9IGNvbXB1dGVFeHRydWRlZEVsbGlwc2Uob3B0aW9ucyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGdlb21ldHJ5ID0gY29tcHV0ZUVsbGlwc2Uob3B0aW9ucyk7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGVsbGlwc2VHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlKSkgewogICAgICAgICAgICBjb25zdCBsZW5ndGggPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGg7CiAgICAgICAgICAgIGNvbnN0IG9mZnNldFZhbHVlID0gZWxsaXBzZUdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgICBjb25zdCBhcHBseU9mZnNldCA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCAvIDMpLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICAgICAgICB2YWx1ZXM6IGFwcGx5T2Zmc2V0CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlczogZ2VvbWV0cnkuYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXM6IGdlb21ldHJ5LmluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBlbGxpcHNlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBFbGxpcHNlR2VvbWV0cnkuY3JlYXRlU2hhZG93Vm9sdW1lID0gZnVuY3Rpb24oZWxsaXBzZUdlb21ldHJ5LCBtaW5IZWlnaHRGdW5jLCBtYXhIZWlnaHRGdW5jKSB7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBlbGxpcHNlR2VvbWV0cnkuX2dyYW51bGFyaXR5OwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IGVsbGlwc2VHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IG1pbkhlaWdodCA9IG1pbkhlaWdodEZ1bmMoZ3JhbnVsYXJpdHksIGVsbGlwc29pZCk7CiAgICAgICAgY29uc3QgbWF4SGVpZ2h0ID0gbWF4SGVpZ2h0RnVuYyhncmFudWxhcml0eSwgZWxsaXBzb2lkKTsKICAgICAgICByZXR1cm4gbmV3IEVsbGlwc2VHZW9tZXRyeSh7CiAgICAgICAgICBjZW50ZXI6IGVsbGlwc2VHZW9tZXRyeS5fY2VudGVyLAogICAgICAgICAgc2VtaU1ham9yQXhpczogZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWFqb3JBeGlzLAogICAgICAgICAgc2VtaU1pbm9yQXhpczogZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWlub3JBeGlzLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgcm90YXRpb246IGVsbGlwc2VHZW9tZXRyeS5fcm90YXRpb24sCiAgICAgICAgICBzdFJvdGF0aW9uOiBlbGxpcHNlR2VvbWV0cnkuX3N0Um90YXRpb24sCiAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0OiBtaW5IZWlnaHQsCiAgICAgICAgICBoZWlnaHQ6IG1heEhlaWdodCwKICAgICAgICAgIHZlcnRleEZvcm1hdDogVmVydGV4Rm9ybWF0X2RlZmF1bHQuUE9TSVRJT05fT05MWSwKICAgICAgICAgIHNoYWRvd1ZvbHVtZTogdHJ1ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhFbGxpcHNlR2VvbWV0cnkucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICByZWN0YW5nbGU6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHRoaXMuX3JlY3RhbmdsZSkpIHsKICAgICAgICAgICAgICB0aGlzLl9yZWN0YW5nbGUgPSBjb21wdXRlUmVjdGFuZ2xlKAogICAgICAgICAgICAgICAgdGhpcy5fY2VudGVyLAogICAgICAgICAgICAgICAgdGhpcy5fc2VtaU1ham9yQXhpcywKICAgICAgICAgICAgICAgIHRoaXMuX3NlbWlNaW5vckF4aXMsCiAgICAgICAgICAgICAgICB0aGlzLl9yb3RhdGlvbiwKICAgICAgICAgICAgICAgIHRoaXMuX2dyYW51bGFyaXR5LAogICAgICAgICAgICAgICAgdGhpcy5fZWxsaXBzb2lkCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5fcmVjdGFuZ2xlOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogRm9yIHJlbWFwcGluZyB0ZXh0dXJlIGNvb3JkaW5hdGVzIHdoZW4gcmVuZGVyaW5nIEVsbGlwc2VHZW9tZXRyaWVzIGFzIEdyb3VuZFByaW1pdGl2ZXMuCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0aGlzLl90ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzKSkgewogICAgICAgICAgICAgIHRoaXMuX3RleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHMgPSB0ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzKAogICAgICAgICAgICAgICAgdGhpcwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3RleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgRWxsaXBzZUdlb21ldHJ5X2RlZmF1bHQgPSBFbGxpcHNlR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DaXJjbGVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIENpcmNsZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgcmFkaXVzID0gb3B0aW9ucy5yYWRpdXM7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInJhZGl1cyIsIHJhZGl1cyk7CiAgICBjb25zdCBlbGxpcHNlR2VvbWV0cnlPcHRpb25zID0gewogICAgICBjZW50ZXI6IG9wdGlvbnMuY2VudGVyLAogICAgICBzZW1pTWFqb3JBeGlzOiByYWRpdXMsCiAgICAgIHNlbWlNaW5vckF4aXM6IHJhZGl1cywKICAgICAgZWxsaXBzb2lkOiBvcHRpb25zLmVsbGlwc29pZCwKICAgICAgaGVpZ2h0OiBvcHRpb25zLmhlaWdodCwKICAgICAgZXh0cnVkZWRIZWlnaHQ6IG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQsCiAgICAgIGdyYW51bGFyaXR5OiBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICB2ZXJ0ZXhGb3JtYXQ6IG9wdGlvbnMudmVydGV4Rm9ybWF0LAogICAgICBzdFJvdGF0aW9uOiBvcHRpb25zLnN0Um90YXRpb24sCiAgICAgIHNoYWRvd1ZvbHVtZTogb3B0aW9ucy5zaGFkb3dWb2x1bWUKICAgIH07CiAgICB0aGlzLl9lbGxpcHNlR2VvbWV0cnkgPSBuZXcgRWxsaXBzZUdlb21ldHJ5X2RlZmF1bHQoZWxsaXBzZUdlb21ldHJ5T3B0aW9ucyk7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUNpcmNsZUdlb21ldHJ5IjsKICB9CiAgdmFyIHNjcmF0Y2hFbGxpcHNlR2VvbWV0cnksIHNjcmF0Y2hPcHRpb25zNCwgQ2lyY2xlR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9DaXJjbGVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2lyY2xlR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNlR2VvbWV0cnkoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgQ2lyY2xlR2VvbWV0cnkucGFja2VkTGVuZ3RoID0gRWxsaXBzZUdlb21ldHJ5X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICBDaXJjbGVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICByZXR1cm4gRWxsaXBzZUdlb21ldHJ5X2RlZmF1bHQucGFjayh2YWx1ZS5fZWxsaXBzZUdlb21ldHJ5LCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNlR2VvbWV0cnkgPSBuZXcgRWxsaXBzZUdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgIGNlbnRlcjogbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgIHNlbWlNYWpvckF4aXM6IDEsCiAgICAgICAgc2VtaU1pbm9yQXhpczogMQogICAgICB9KTsKICAgICAgc2NyYXRjaE9wdGlvbnM0ID0gewogICAgICAgIGNlbnRlcjogbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgIHJhZGl1czogdm9pZCAwLAogICAgICAgIGVsbGlwc29pZDogRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoRWxsaXBzb2lkX2RlZmF1bHQuVU5JVF9TUEhFUkUpLAogICAgICAgIGhlaWdodDogdm9pZCAwLAogICAgICAgIGV4dHJ1ZGVkSGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgZ3JhbnVsYXJpdHk6IHZvaWQgMCwKICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCgpLAogICAgICAgIHN0Um90YXRpb246IHZvaWQgMCwKICAgICAgICBzZW1pTWFqb3JBeGlzOiB2b2lkIDAsCiAgICAgICAgc2VtaU1pbm9yQXhpczogdm9pZCAwLAogICAgICAgIHNoYWRvd1ZvbHVtZTogdm9pZCAwCiAgICAgIH07CiAgICAgIENpcmNsZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBjb25zdCBlbGxpcHNlR2VvbWV0cnkgPSBFbGxpcHNlR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoRWxsaXBzZUdlb21ldHJ5CiAgICAgICAgKTsKICAgICAgICBzY3JhdGNoT3B0aW9uczQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKAogICAgICAgICAgZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIsCiAgICAgICAgICBzY3JhdGNoT3B0aW9uczQuY2VudGVyCiAgICAgICAgKTsKICAgICAgICBzY3JhdGNoT3B0aW9uczQuZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoCiAgICAgICAgICBlbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZCwKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNC5lbGxpcHNvaWQKICAgICAgICApOwogICAgICAgIHNjcmF0Y2hPcHRpb25zNC5oZWlnaHQgPSBlbGxpcHNlR2VvbWV0cnkuX2hlaWdodDsKICAgICAgICBzY3JhdGNoT3B0aW9uczQuZXh0cnVkZWRIZWlnaHQgPSBlbGxpcHNlR2VvbWV0cnkuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIHNjcmF0Y2hPcHRpb25zNC5ncmFudWxhcml0eSA9IGVsbGlwc2VHZW9tZXRyeS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgc2NyYXRjaE9wdGlvbnM0LnZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKAogICAgICAgICAgZWxsaXBzZUdlb21ldHJ5Ll92ZXJ0ZXhGb3JtYXQsCiAgICAgICAgICBzY3JhdGNoT3B0aW9uczQudmVydGV4Rm9ybWF0CiAgICAgICAgKTsKICAgICAgICBzY3JhdGNoT3B0aW9uczQuc3RSb3RhdGlvbiA9IGVsbGlwc2VHZW9tZXRyeS5fc3RSb3RhdGlvbjsKICAgICAgICBzY3JhdGNoT3B0aW9uczQuc2hhZG93Vm9sdW1lID0gZWxsaXBzZUdlb21ldHJ5Ll9zaGFkb3dWb2x1bWU7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnM0LnJhZGl1cyA9IGVsbGlwc2VHZW9tZXRyeS5fc2VtaU1ham9yQXhpczsKICAgICAgICAgIHJldHVybiBuZXcgQ2lyY2xlR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnM0KTsKICAgICAgICB9CiAgICAgICAgc2NyYXRjaE9wdGlvbnM0LnNlbWlNYWpvckF4aXMgPSBlbGxpcHNlR2VvbWV0cnkuX3NlbWlNYWpvckF4aXM7CiAgICAgICAgc2NyYXRjaE9wdGlvbnM0LnNlbWlNaW5vckF4aXMgPSBlbGxpcHNlR2VvbWV0cnkuX3NlbWlNaW5vckF4aXM7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNlR2VvbWV0cnkgPSBuZXcgRWxsaXBzZUdlb21ldHJ5X2RlZmF1bHQoc2NyYXRjaE9wdGlvbnM0KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDaXJjbGVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKGNpcmNsZUdlb21ldHJ5KSB7CiAgICAgICAgcmV0dXJuIEVsbGlwc2VHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KGNpcmNsZUdlb21ldHJ5Ll9lbGxpcHNlR2VvbWV0cnkpOwogICAgICB9OwogICAgICBDaXJjbGVHZW9tZXRyeS5jcmVhdGVTaGFkb3dWb2x1bWUgPSBmdW5jdGlvbihjaXJjbGVHZW9tZXRyeSwgbWluSGVpZ2h0RnVuYywgbWF4SGVpZ2h0RnVuYykgewogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gY2lyY2xlR2VvbWV0cnkuX2VsbGlwc2VHZW9tZXRyeS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gY2lyY2xlR2VvbWV0cnkuX2VsbGlwc2VHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IG1pbkhlaWdodCA9IG1pbkhlaWdodEZ1bmMoZ3JhbnVsYXJpdHksIGVsbGlwc29pZCk7CiAgICAgICAgY29uc3QgbWF4SGVpZ2h0ID0gbWF4SGVpZ2h0RnVuYyhncmFudWxhcml0eSwgZWxsaXBzb2lkKTsKICAgICAgICByZXR1cm4gbmV3IENpcmNsZUdlb21ldHJ5KHsKICAgICAgICAgIGNlbnRlcjogY2lyY2xlR2VvbWV0cnkuX2VsbGlwc2VHZW9tZXRyeS5fY2VudGVyLAogICAgICAgICAgcmFkaXVzOiBjaXJjbGVHZW9tZXRyeS5fZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWFqb3JBeGlzLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgc3RSb3RhdGlvbjogY2lyY2xlR2VvbWV0cnkuX2VsbGlwc2VHZW9tZXRyeS5fc3RSb3RhdGlvbiwKICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgZXh0cnVkZWRIZWlnaHQ6IG1pbkhlaWdodCwKICAgICAgICAgIGhlaWdodDogbWF4SGVpZ2h0LAogICAgICAgICAgdmVydGV4Rm9ybWF0OiBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5QT1NJVElPTl9PTkxZLAogICAgICAgICAgc2hhZG93Vm9sdW1lOiB0cnVlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKENpcmNsZUdlb21ldHJ5LnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgcmVjdGFuZ2xlOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fZWxsaXBzZUdlb21ldHJ5LnJlY3RhbmdsZTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEZvciByZW1hcHBpbmcgdGV4dHVyZSBjb29yZGluYXRlcyB3aGVuIHJlbmRlcmluZyBDaXJjbGVHZW9tZXRyaWVzIGFzIEdyb3VuZFByaW1pdGl2ZXMuCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fZWxsaXBzZUdlb21ldHJ5LnRleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgQ2lyY2xlR2VvbWV0cnlfZGVmYXVsdCA9IENpcmNsZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ2lyY2xlR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlQ2lyY2xlR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZUNpcmNsZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUNpcmNsZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVDaXJjbGVHZW9tZXRyeShjaXJjbGVHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgY2lyY2xlR2VvbWV0cnkgPSBDaXJjbGVHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhjaXJjbGVHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIGNpcmNsZUdlb21ldHJ5Ll9lbGxpcHNlR2VvbWV0cnkuX2NlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZSgKICAgICAgY2lyY2xlR2VvbWV0cnkuX2VsbGlwc2VHZW9tZXRyeS5fY2VudGVyCiAgICApOwogICAgY2lyY2xlR2VvbWV0cnkuX2VsbGlwc2VHZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoCiAgICAgIGNpcmNsZUdlb21ldHJ5Ll9lbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZAogICAgKTsKICAgIHJldHVybiBDaXJjbGVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KGNpcmNsZUdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZUNpcmNsZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlQ2lyY2xlR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUNpcmNsZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2lyY2xlR2VvbWV0cnkoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGNyZWF0ZUNpcmNsZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVDaXJjbGVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc2VPdXRsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBjb21wdXRlRWxsaXBzZTIob3B0aW9ucykgewogICAgY29uc3QgY2VudGVyID0gb3B0aW9ucy5jZW50ZXI7CiAgICBib3VuZGluZ1NwaGVyZUNlbnRlcjIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgb3B0aW9ucy5lbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKGNlbnRlciwgYm91bmRpbmdTcGhlcmVDZW50ZXIyKSwKICAgICAgb3B0aW9ucy5oZWlnaHQsCiAgICAgIGJvdW5kaW5nU3BoZXJlQ2VudGVyMgogICAgKTsKICAgIGJvdW5kaW5nU3BoZXJlQ2VudGVyMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgIGNlbnRlciwKICAgICAgYm91bmRpbmdTcGhlcmVDZW50ZXIyLAogICAgICBib3VuZGluZ1NwaGVyZUNlbnRlcjIKICAgICk7CiAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KAogICAgICBib3VuZGluZ1NwaGVyZUNlbnRlcjIsCiAgICAgIG9wdGlvbnMuc2VtaU1ham9yQXhpcwogICAgKTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IEVsbGlwc2VHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlRWxsaXBzZVBvc2l0aW9ucygKICAgICAgb3B0aW9ucywKICAgICAgZmFsc2UsCiAgICAgIHRydWUKICAgICkub3V0ZXJQb3NpdGlvbnM7CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KHsKICAgICAgcG9zaXRpb246IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IEVsbGlwc2VHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5yYWlzZVBvc2l0aW9uc1RvSGVpZ2h0KAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgb3B0aW9ucywKICAgICAgICAgIGZhbHNlCiAgICAgICAgKQogICAgICB9KQogICAgfSk7CiAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShsZW5ndGgsIGxlbmd0aCAqIDIpOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGk7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSAoaSArIDEpICUgbGVuZ3RoOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgYm91bmRpbmdTcGhlcmUsCiAgICAgIGF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXMKICAgIH07CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVFeHRydWRlZEVsbGlwc2UyKG9wdGlvbnMpIHsKICAgIGNvbnN0IGNlbnRlciA9IG9wdGlvbnMuY2VudGVyOwogICAgY29uc3QgZWxsaXBzb2lkID0gb3B0aW9ucy5lbGxpcHNvaWQ7CiAgICBjb25zdCBzZW1pTWFqb3JBeGlzID0gb3B0aW9ucy5zZW1pTWFqb3JBeGlzOwogICAgbGV0IHNjYWxlZE5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKGNlbnRlciwgc2NyYXRjaENhcnRlc2lhbjE0KSwKICAgICAgb3B0aW9ucy5oZWlnaHQsCiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xNAogICAgKTsKICAgIHRvcEJvdW5kaW5nU3BoZXJlMi5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICBjZW50ZXIsCiAgICAgIHNjYWxlZE5vcm1hbCwKICAgICAgdG9wQm91bmRpbmdTcGhlcmUyLmNlbnRlcgogICAgKTsKICAgIHRvcEJvdW5kaW5nU3BoZXJlMi5yYWRpdXMgPSBzZW1pTWFqb3JBeGlzOwogICAgc2NhbGVkTm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgIGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoY2VudGVyLCBzY2FsZWROb3JtYWwpLAogICAgICBvcHRpb25zLmV4dHJ1ZGVkSGVpZ2h0LAogICAgICBzY2FsZWROb3JtYWwKICAgICk7CiAgICBib3R0b21Cb3VuZGluZ1NwaGVyZTIuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgY2VudGVyLAogICAgICBzY2FsZWROb3JtYWwsCiAgICAgIGJvdHRvbUJvdW5kaW5nU3BoZXJlMi5jZW50ZXIKICAgICk7CiAgICBib3R0b21Cb3VuZGluZ1NwaGVyZTIucmFkaXVzID0gc2VtaU1ham9yQXhpczsKICAgIGxldCBwb3NpdGlvbnMgPSBFbGxpcHNlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZUVsbGlwc2VQb3NpdGlvbnMoCiAgICAgIG9wdGlvbnMsCiAgICAgIGZhbHNlLAogICAgICB0cnVlCiAgICApLm91dGVyUG9zaXRpb25zOwogICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCh7CiAgICAgIHBvc2l0aW9uOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBFbGxpcHNlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQucmFpc2VQb3NpdGlvbnNUb0hlaWdodCgKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIG9wdGlvbnMsCiAgICAgICAgICB0cnVlCiAgICAgICAgKQogICAgICB9KQogICAgfSk7CiAgICBwb3NpdGlvbnMgPSBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC51bmlvbigKICAgICAgdG9wQm91bmRpbmdTcGhlcmUyLAogICAgICBib3R0b21Cb3VuZGluZ1NwaGVyZTIKICAgICk7CiAgICBsZXQgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlKSkgewogICAgICBsZXQgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGgpOwogICAgICBpZiAob3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuVE9QKSB7CiAgICAgICAgYXBwbHlPZmZzZXQgPSBhcHBseU9mZnNldC5maWxsKDEsIDAsIGxlbmd0aCAvIDIpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IG9mZnNldFZhbHVlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgIGFwcGx5T2Zmc2V0ID0gYXBwbHlPZmZzZXQuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgIH0KICAgICAgYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICB9KTsKICAgIH0KICAgIGxldCBudW1iZXJPZlZlcnRpY2FsTGluZXMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm51bWJlck9mVmVydGljYWxMaW5lcywgMTYpOwogICAgbnVtYmVyT2ZWZXJ0aWNhbExpbmVzID0gTWF0aF9kZWZhdWx0LmNsYW1wKAogICAgICBudW1iZXJPZlZlcnRpY2FsTGluZXMsCiAgICAgIDAsCiAgICAgIGxlbmd0aCAvIDIKICAgICk7CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIGxlbmd0aCwKICAgICAgbGVuZ3RoICogMiArIG51bWJlck9mVmVydGljYWxMaW5lcyAqIDIKICAgICk7CiAgICBsZW5ndGggLz0gMjsKICAgIGxldCBpbmRleCA9IDA7CiAgICBsZXQgaTsKICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBpbmRpY2VzW2luZGV4KytdID0gaTsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IChpICsgMSkgJSBsZW5ndGg7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpICsgbGVuZ3RoOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gKGkgKyAxKSAlIGxlbmd0aCArIGxlbmd0aDsKICAgIH0KICAgIGxldCBudW1TaWRlOwogICAgaWYgKG51bWJlck9mVmVydGljYWxMaW5lcyA+IDApIHsKICAgICAgY29uc3QgbnVtU2lkZUxpbmVzID0gTWF0aC5taW4obnVtYmVyT2ZWZXJ0aWNhbExpbmVzLCBsZW5ndGgpOwogICAgICBudW1TaWRlID0gTWF0aC5yb3VuZChsZW5ndGggLyBudW1TaWRlTGluZXMpOwogICAgICBjb25zdCBtYXhJID0gTWF0aC5taW4obnVtU2lkZSAqIG51bWJlck9mVmVydGljYWxMaW5lcywgbGVuZ3RoKTsKICAgICAgZm9yIChpID0gMDsgaSA8IG1heEk7IGkgKz0gbnVtU2lkZSkgewogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpICsgbGVuZ3RoOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gewogICAgICBib3VuZGluZ1NwaGVyZSwKICAgICAgYXR0cmlidXRlcywKICAgICAgaW5kaWNlcwogICAgfTsKICB9CiAgZnVuY3Rpb24gRWxsaXBzZU91dGxpbmVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IGNlbnRlciA9IG9wdGlvbnMuY2VudGVyOwogICAgY29uc3QgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgIGNvbnN0IHNlbWlNYWpvckF4aXMgPSBvcHRpb25zLnNlbWlNYWpvckF4aXM7CiAgICBjb25zdCBzZW1pTWlub3JBeGlzID0gb3B0aW9ucy5zZW1pTWlub3JBeGlzOwogICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRQogICAgKTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNlbnRlcikpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImNlbnRlciBpcyByZXF1aXJlZC4iKTsKICAgIH0KICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHNlbWlNYWpvckF4aXMpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJzZW1pTWFqb3JBeGlzIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc2VtaU1pbm9yQXhpcykpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInNlbWlNaW5vckF4aXMgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICBpZiAoc2VtaU1ham9yQXhpcyA8IHNlbWlNaW5vckF4aXMpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgInNlbWlNYWpvckF4aXMgbXVzdCBiZSBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8gdGhlIHNlbWlNaW5vckF4aXMuIgogICAgICApOwogICAgfQogICAgaWYgKGdyYW51bGFyaXR5IDw9IDApIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdyYW51bGFyaXR5IG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8uIik7CiAgICB9CiAgICBjb25zdCBoZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmhlaWdodCwgMCk7CiAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQsIGhlaWdodCk7CiAgICB0aGlzLl9jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY2VudGVyKTsKICAgIHRoaXMuX3NlbWlNYWpvckF4aXMgPSBzZW1pTWFqb3JBeGlzOwogICAgdGhpcy5fc2VtaU1pbm9yQXhpcyA9IHNlbWlNaW5vckF4aXM7CiAgICB0aGlzLl9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQpOwogICAgdGhpcy5fcm90YXRpb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnJvdGF0aW9uLCAwKTsKICAgIHRoaXMuX2hlaWdodCA9IE1hdGgubWF4KGV4dHJ1ZGVkSGVpZ2h0LCBoZWlnaHQpOwogICAgdGhpcy5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgIHRoaXMuX2V4dHJ1ZGVkSGVpZ2h0ID0gTWF0aC5taW4oZXh0cnVkZWRIZWlnaHQsIGhlaWdodCk7CiAgICB0aGlzLl9udW1iZXJPZlZlcnRpY2FsTGluZXMgPSBNYXRoLm1heCgKICAgICAgZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5udW1iZXJPZlZlcnRpY2FsTGluZXMsIDE2KSwKICAgICAgMAogICAgKTsKICAgIHRoaXMuX29mZnNldEF0dHJpYnV0ZSA9IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5IjsKICB9CiAgdmFyIHNjcmF0Y2hDYXJ0ZXNpYW4xNCwgYm91bmRpbmdTcGhlcmVDZW50ZXIyLCB0b3BCb3VuZGluZ1NwaGVyZTIsIGJvdHRvbUJvdW5kaW5nU3BoZXJlMiwgc2NyYXRjaENlbnRlcjMsIHNjcmF0Y2hFbGxpcHNvaWQyLCBzY3JhdGNoT3B0aW9uczUsIEVsbGlwc2VPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9FbGxpcHNlT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNlT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc2VHZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjE0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBib3VuZGluZ1NwaGVyZUNlbnRlcjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHRvcEJvdW5kaW5nU3BoZXJlMiA9IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KCk7CiAgICAgIGJvdHRvbUJvdW5kaW5nU3BoZXJlMiA9IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KCk7CiAgICAgIEVsbGlwc2VPdXRsaW5lR2VvbWV0cnkucGFja2VkTGVuZ3RoID0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCArIEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDg7CiAgICAgIEVsbGlwc2VPdXRsaW5lR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZhbHVlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInZhbHVlIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2YWx1ZS5fY2VudGVyLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIEVsbGlwc29pZF9kZWZhdWx0LnBhY2sodmFsdWUuX2VsbGlwc29pZCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc2VtaU1ham9yQXhpczsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3NlbWlNaW5vckF4aXM7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9yb3RhdGlvbjsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2hlaWdodDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2dyYW51bGFyaXR5OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9udW1iZXJPZlZlcnRpY2FsTGluZXM7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh2YWx1ZS5fb2Zmc2V0QXR0cmlidXRlLCAtMSk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoQ2VudGVyMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEVsbGlwc29pZDIgPSBuZXcgRWxsaXBzb2lkX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE9wdGlvbnM1ID0gewogICAgICAgIGNlbnRlcjogc2NyYXRjaENlbnRlcjMsCiAgICAgICAgZWxsaXBzb2lkOiBzY3JhdGNoRWxsaXBzb2lkMiwKICAgICAgICBzZW1pTWFqb3JBeGlzOiB2b2lkIDAsCiAgICAgICAgc2VtaU1pbm9yQXhpczogdm9pZCAwLAogICAgICAgIHJvdGF0aW9uOiB2b2lkIDAsCiAgICAgICAgaGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgZ3JhbnVsYXJpdHk6IHZvaWQgMCwKICAgICAgICBleHRydWRlZEhlaWdodDogdm9pZCAwLAogICAgICAgIG51bWJlck9mVmVydGljYWxMaW5lczogdm9pZCAwLAogICAgICAgIG9mZnNldEF0dHJpYnV0ZTogdm9pZCAwCiAgICAgIH07CiAgICAgIEVsbGlwc2VPdXRsaW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBjZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoQ2VudGVyMyk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaEVsbGlwc29pZDIpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IHNlbWlNYWpvckF4aXMgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHNlbWlNaW5vckF4aXMgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHJvdGF0aW9uID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBoZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgbnVtYmVyT2ZWZXJ0aWNhbExpbmVzID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBvZmZzZXRBdHRyaWJ1dGUgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczUuaGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnM1LmV4dHJ1ZGVkSGVpZ2h0ID0gZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczUuZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNS5yb3RhdGlvbiA9IHJvdGF0aW9uOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnM1LnNlbWlNYWpvckF4aXMgPSBzZW1pTWFqb3JBeGlzOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnM1LnNlbWlNaW5vckF4aXMgPSBzZW1pTWlub3JBeGlzOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnM1Lm51bWJlck9mVmVydGljYWxMaW5lcyA9IG51bWJlck9mVmVydGljYWxMaW5lczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNS5vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgICAgcmV0dXJuIG5ldyBFbGxpcHNlT3V0bGluZUdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zNSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlciwgcmVzdWx0Ll9jZW50ZXIpOwogICAgICAgIHJlc3VsdC5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkLCByZXN1bHQuX2VsbGlwc29pZCk7CiAgICAgICAgcmVzdWx0Ll9zZW1pTWFqb3JBeGlzID0gc2VtaU1ham9yQXhpczsKICAgICAgICByZXN1bHQuX3NlbWlNaW5vckF4aXMgPSBzZW1pTWlub3JBeGlzOwogICAgICAgIHJlc3VsdC5fcm90YXRpb24gPSByb3RhdGlvbjsKICAgICAgICByZXN1bHQuX2hlaWdodCA9IGhlaWdodDsKICAgICAgICByZXN1bHQuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgcmVzdWx0Ll9leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIHJlc3VsdC5fbnVtYmVyT2ZWZXJ0aWNhbExpbmVzID0gbnVtYmVyT2ZWZXJ0aWNhbExpbmVzOwogICAgICAgIHJlc3VsdC5fb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBFbGxpcHNlT3V0bGluZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oZWxsaXBzZUdlb21ldHJ5KSB7CiAgICAgICAgaWYgKGVsbGlwc2VHZW9tZXRyeS5fc2VtaU1ham9yQXhpcyA8PSAwIHx8IGVsbGlwc2VHZW9tZXRyeS5fc2VtaU1pbm9yQXhpcyA8PSAwKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGhlaWdodCA9IGVsbGlwc2VHZW9tZXRyeS5faGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gZWxsaXBzZUdlb21ldHJ5Ll9leHRydWRlZEhlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlID0gIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgZXh0cnVkZWRIZWlnaHQsCiAgICAgICAgICAwLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04yCiAgICAgICAgKTsKICAgICAgICBlbGxpcHNlR2VvbWV0cnkuX2NlbnRlciA9IGVsbGlwc2VHZW9tZXRyeS5fZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UoCiAgICAgICAgICBlbGxpcHNlR2VvbWV0cnkuX2NlbnRlciwKICAgICAgICAgIGVsbGlwc2VHZW9tZXRyeS5fY2VudGVyCiAgICAgICAgKTsKICAgICAgICBjb25zdCBvcHRpb25zID0gewogICAgICAgICAgY2VudGVyOiBlbGxpcHNlR2VvbWV0cnkuX2NlbnRlciwKICAgICAgICAgIHNlbWlNYWpvckF4aXM6IGVsbGlwc2VHZW9tZXRyeS5fc2VtaU1ham9yQXhpcywKICAgICAgICAgIHNlbWlNaW5vckF4aXM6IGVsbGlwc2VHZW9tZXRyeS5fc2VtaU1pbm9yQXhpcywKICAgICAgICAgIGVsbGlwc29pZDogZWxsaXBzZUdlb21ldHJ5Ll9lbGxpcHNvaWQsCiAgICAgICAgICByb3RhdGlvbjogZWxsaXBzZUdlb21ldHJ5Ll9yb3RhdGlvbiwKICAgICAgICAgIGhlaWdodCwKICAgICAgICAgIGdyYW51bGFyaXR5OiBlbGxpcHNlR2VvbWV0cnkuX2dyYW51bGFyaXR5LAogICAgICAgICAgbnVtYmVyT2ZWZXJ0aWNhbExpbmVzOiBlbGxpcHNlR2VvbWV0cnkuX251bWJlck9mVmVydGljYWxMaW5lcwogICAgICAgIH07CiAgICAgICAgbGV0IGdlb21ldHJ5OwogICAgICAgIGlmIChleHRydWRlKSB7CiAgICAgICAgICBvcHRpb25zLmV4dHJ1ZGVkSGVpZ2h0ID0gZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgICBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9IGVsbGlwc2VHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlOwogICAgICAgICAgZ2VvbWV0cnkgPSBjb21wdXRlRXh0cnVkZWRFbGxpcHNlMihvcHRpb25zKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZ2VvbWV0cnkgPSBjb21wdXRlRWxsaXBzZTIob3B0aW9ucyk7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGVsbGlwc2VHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlKSkgewogICAgICAgICAgICBjb25zdCBsZW5ndGggPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGg7CiAgICAgICAgICAgIGNvbnN0IG9mZnNldFZhbHVlID0gZWxsaXBzZUdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgICBjb25zdCBhcHBseU9mZnNldCA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCAvIDMpLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICAgICAgICB2YWx1ZXM6IGFwcGx5T2Zmc2V0CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlczogZ2VvbWV0cnkuYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXM6IGdlb21ldHJ5LmluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZTogZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmUsCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IGVsbGlwc2VHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEVsbGlwc2VPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IEVsbGlwc2VPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DaXJjbGVPdXRsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBDaXJjbGVPdXRsaW5lR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCByYWRpdXMgPSBvcHRpb25zLnJhZGl1czsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigicmFkaXVzIiwgcmFkaXVzKTsKICAgIGNvbnN0IGVsbGlwc2VHZW9tZXRyeU9wdGlvbnMgPSB7CiAgICAgIGNlbnRlcjogb3B0aW9ucy5jZW50ZXIsCiAgICAgIHNlbWlNYWpvckF4aXM6IHJhZGl1cywKICAgICAgc2VtaU1pbm9yQXhpczogcmFkaXVzLAogICAgICBlbGxpcHNvaWQ6IG9wdGlvbnMuZWxsaXBzb2lkLAogICAgICBoZWlnaHQ6IG9wdGlvbnMuaGVpZ2h0LAogICAgICBleHRydWRlZEhlaWdodDogb3B0aW9ucy5leHRydWRlZEhlaWdodCwKICAgICAgZ3JhbnVsYXJpdHk6IG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgIG51bWJlck9mVmVydGljYWxMaW5lczogb3B0aW9ucy5udW1iZXJPZlZlcnRpY2FsTGluZXMKICAgIH07CiAgICB0aGlzLl9lbGxpcHNlR2VvbWV0cnkgPSBuZXcgRWxsaXBzZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0KGVsbGlwc2VHZW9tZXRyeU9wdGlvbnMpOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVDaXJjbGVPdXRsaW5lR2VvbWV0cnkiOwogIH0KICB2YXIgc2NyYXRjaEVsbGlwc2VHZW9tZXRyeTIsIHNjcmF0Y2hPcHRpb25zNiwgQ2lyY2xlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfQ2lyY2xlT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DaXJjbGVPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNlT3V0bGluZUdlb21ldHJ5KCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIENpcmNsZU91dGxpbmVHZW9tZXRyeS5wYWNrZWRMZW5ndGggPSBFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICBDaXJjbGVPdXRsaW5lR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgcmV0dXJuIEVsbGlwc2VPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5wYWNrKAogICAgICAgICAgdmFsdWUuX2VsbGlwc2VHZW9tZXRyeSwKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleAogICAgICAgICk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNlR2VvbWV0cnkyID0gbmV3IEVsbGlwc2VPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgY2VudGVyOiBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgc2VtaU1ham9yQXhpczogMSwKICAgICAgICBzZW1pTWlub3JBeGlzOiAxCiAgICAgIH0pOwogICAgICBzY3JhdGNoT3B0aW9uczYgPSB7CiAgICAgICAgY2VudGVyOiBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgcmFkaXVzOiB2b2lkIDAsCiAgICAgICAgZWxsaXBzb2lkOiBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShFbGxpcHNvaWRfZGVmYXVsdC5VTklUX1NQSEVSRSksCiAgICAgICAgaGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgZXh0cnVkZWRIZWlnaHQ6IHZvaWQgMCwKICAgICAgICBncmFudWxhcml0eTogdm9pZCAwLAogICAgICAgIG51bWJlck9mVmVydGljYWxMaW5lczogdm9pZCAwLAogICAgICAgIHNlbWlNYWpvckF4aXM6IHZvaWQgMCwKICAgICAgICBzZW1pTWlub3JBeGlzOiB2b2lkIDAKICAgICAgfTsKICAgICAgQ2lyY2xlT3V0bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBjb25zdCBlbGxpcHNlR2VvbWV0cnkgPSBFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgc2NyYXRjaEVsbGlwc2VHZW9tZXRyeTIKICAgICAgICApOwogICAgICAgIHNjcmF0Y2hPcHRpb25zNi5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoCiAgICAgICAgICBlbGxpcHNlR2VvbWV0cnkuX2NlbnRlciwKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNi5jZW50ZXIKICAgICAgICApOwogICAgICAgIHNjcmF0Y2hPcHRpb25zNi5lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZSgKICAgICAgICAgIGVsbGlwc2VHZW9tZXRyeS5fZWxsaXBzb2lkLAogICAgICAgICAgc2NyYXRjaE9wdGlvbnM2LmVsbGlwc29pZAogICAgICAgICk7CiAgICAgICAgc2NyYXRjaE9wdGlvbnM2LmhlaWdodCA9IGVsbGlwc2VHZW9tZXRyeS5faGVpZ2h0OwogICAgICAgIHNjcmF0Y2hPcHRpb25zNi5leHRydWRlZEhlaWdodCA9IGVsbGlwc2VHZW9tZXRyeS5fZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgc2NyYXRjaE9wdGlvbnM2LmdyYW51bGFyaXR5ID0gZWxsaXBzZUdlb21ldHJ5Ll9ncmFudWxhcml0eTsKICAgICAgICBzY3JhdGNoT3B0aW9uczYubnVtYmVyT2ZWZXJ0aWNhbExpbmVzID0gZWxsaXBzZUdlb21ldHJ5Ll9udW1iZXJPZlZlcnRpY2FsTGluZXM7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnM2LnJhZGl1cyA9IGVsbGlwc2VHZW9tZXRyeS5fc2VtaU1ham9yQXhpczsKICAgICAgICAgIHJldHVybiBuZXcgQ2lyY2xlT3V0bGluZUdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zNik7CiAgICAgICAgfQogICAgICAgIHNjcmF0Y2hPcHRpb25zNi5zZW1pTWFqb3JBeGlzID0gZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWFqb3JBeGlzOwogICAgICAgIHNjcmF0Y2hPcHRpb25zNi5zZW1pTWlub3JBeGlzID0gZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWlub3JBeGlzOwogICAgICAgIHJlc3VsdC5fZWxsaXBzZUdlb21ldHJ5ID0gbmV3IEVsbGlwc2VPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdChzY3JhdGNoT3B0aW9uczYpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENpcmNsZU91dGxpbmVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKGNpcmNsZUdlb21ldHJ5KSB7CiAgICAgICAgcmV0dXJuIEVsbGlwc2VPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShjaXJjbGVHZW9tZXRyeS5fZWxsaXBzZUdlb21ldHJ5KTsKICAgICAgfTsKICAgICAgQ2lyY2xlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBDaXJjbGVPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVDaXJjbGVPdXRsaW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVDaXJjbGVPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVDaXJjbGVPdXRsaW5lR2VvbWV0cnkoY2lyY2xlR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIGNpcmNsZUdlb21ldHJ5ID0gQ2lyY2xlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKGNpcmNsZUdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgY2lyY2xlR2VvbWV0cnkuX2VsbGlwc2VHZW9tZXRyeS5fY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKAogICAgICBjaXJjbGVHZW9tZXRyeS5fZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIKICAgICk7CiAgICBjaXJjbGVHZW9tZXRyeS5fZWxsaXBzZUdlb21ldHJ5Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZSgKICAgICAgY2lyY2xlR2VvbWV0cnkuX2VsbGlwc2VHZW9tZXRyeS5fZWxsaXBzb2lkCiAgICApOwogICAgcmV0dXJuIENpcmNsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KGNpcmNsZUdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZUNpcmNsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUNpcmNsZU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2lyY2xlT3V0bGluZUdlb21ldHJ5KCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBjcmVhdGVDaXJjbGVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZUNpcmNsZU91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2FycmF5UmVtb3ZlRHVwbGljYXRlcy5qcwogIGZ1bmN0aW9uIGFycmF5UmVtb3ZlRHVwbGljYXRlcyh2YWx1ZXMsIGVxdWFsc0Vwc2lsb24sIHdyYXBBcm91bmQsIHJlbW92ZWRJbmRpY2VzKSB7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImVxdWFsc0Vwc2lsb24iLCBlcXVhbHNFcHNpbG9uKTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZhbHVlcykpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHdyYXBBcm91bmQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh3cmFwQXJvdW5kLCBmYWxzZSk7CiAgICBjb25zdCBzdG9yZVJlbW92ZWRJbmRpY2VzID0gZGVmaW5lZF9kZWZhdWx0KHJlbW92ZWRJbmRpY2VzKTsKICAgIGNvbnN0IGxlbmd0aCA9IHZhbHVlcy5sZW5ndGg7CiAgICBpZiAobGVuZ3RoIDwgMikgewogICAgICByZXR1cm4gdmFsdWVzOwogICAgfQogICAgbGV0IGk7CiAgICBsZXQgdjAyID0gdmFsdWVzWzBdOwogICAgbGV0IHYxMjsKICAgIGxldCBjbGVhbmVkVmFsdWVzOwogICAgbGV0IGxhc3RDbGVhbkluZGV4ID0gMDsKICAgIGxldCByZW1vdmVkSW5kZXhMQ0kgPSAtMTsKICAgIGZvciAoaSA9IDE7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICB2MTIgPSB2YWx1ZXNbaV07CiAgICAgIGlmIChlcXVhbHNFcHNpbG9uKHYwMiwgdjEyLCByZW1vdmVEdXBsaWNhdGVzRXBzaWxvbikpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjbGVhbmVkVmFsdWVzKSkgewogICAgICAgICAgY2xlYW5lZFZhbHVlcyA9IHZhbHVlcy5zbGljZSgwLCBpKTsKICAgICAgICAgIGxhc3RDbGVhbkluZGV4ID0gaSAtIDE7CiAgICAgICAgICByZW1vdmVkSW5kZXhMQ0kgPSAwOwogICAgICAgIH0KICAgICAgICBpZiAoc3RvcmVSZW1vdmVkSW5kaWNlcykgewogICAgICAgICAgcmVtb3ZlZEluZGljZXMucHVzaChpKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChjbGVhbmVkVmFsdWVzKSkgewogICAgICAgICAgY2xlYW5lZFZhbHVlcy5wdXNoKHYxMik7CiAgICAgICAgICBsYXN0Q2xlYW5JbmRleCA9IGk7CiAgICAgICAgICBpZiAoc3RvcmVSZW1vdmVkSW5kaWNlcykgewogICAgICAgICAgICByZW1vdmVkSW5kZXhMQ0kgPSByZW1vdmVkSW5kaWNlcy5sZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHYwMiA9IHYxMjsKICAgICAgfQogICAgfQogICAgaWYgKHdyYXBBcm91bmQgJiYgZXF1YWxzRXBzaWxvbih2YWx1ZXNbMF0sIHZhbHVlc1tsZW5ndGggLSAxXSwgcmVtb3ZlRHVwbGljYXRlc0Vwc2lsb24pKSB7CiAgICAgIGlmIChzdG9yZVJlbW92ZWRJbmRpY2VzKSB7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChjbGVhbmVkVmFsdWVzKSkgewogICAgICAgICAgcmVtb3ZlZEluZGljZXMuc3BsaWNlKHJlbW92ZWRJbmRleExDSSwgMCwgbGFzdENsZWFuSW5kZXgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZW1vdmVkSW5kaWNlcy5wdXNoKGxlbmd0aCAtIDEpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGNsZWFuZWRWYWx1ZXMpKSB7CiAgICAgICAgY2xlYW5lZFZhbHVlcy5sZW5ndGggLT0gMTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjbGVhbmVkVmFsdWVzID0gdmFsdWVzLnNsaWNlKDAsIC0xKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGRlZmluZWRfZGVmYXVsdChjbGVhbmVkVmFsdWVzKSA/IGNsZWFuZWRWYWx1ZXMgOiB2YWx1ZXM7CiAgfQogIHZhciByZW1vdmVEdXBsaWNhdGVzRXBzaWxvbiwgYXJyYXlSZW1vdmVEdXBsaWNhdGVzX2RlZmF1bHQ7CiAgdmFyIGluaXRfYXJyYXlSZW1vdmVEdXBsaWNhdGVzID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9hcnJheVJlbW92ZUR1cGxpY2F0ZXMuanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgcmVtb3ZlRHVwbGljYXRlc0Vwc2lsb24gPSBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwOwogICAgICBhcnJheVJlbW92ZUR1cGxpY2F0ZXNfZGVmYXVsdCA9IGFycmF5UmVtb3ZlRHVwbGljYXRlczsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0JvdW5kaW5nUmVjdGFuZ2xlLmpzCiAgZnVuY3Rpb24gQm91bmRpbmdSZWN0YW5nbGUoeCwgeSwgd2lkdGgsIGhlaWdodCkgewogICAgdGhpcy54ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeCwgMCk7CiAgICB0aGlzLnkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh5LCAwKTsKICAgIHRoaXMud2lkdGggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh3aWR0aCwgMCk7CiAgICB0aGlzLmhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGhlaWdodCwgMCk7CiAgfQogIHZhciBkZWZhdWx0UHJvamVjdGlvbjIsIGZyb21SZWN0YW5nbGVMb3dlckxlZnQsIGZyb21SZWN0YW5nbGVVcHBlclJpZ2h0LCBCb3VuZGluZ1JlY3RhbmdsZV9kZWZhdWx0OwogIHZhciBpbml0X0JvdW5kaW5nUmVjdGFuZ2xlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Cb3VuZGluZ1JlY3RhbmdsZS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0dlb2dyYXBoaWNQcm9qZWN0aW9uKCk7CiAgICAgIGluaXRfSW50ZXJzZWN0KCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIEJvdW5kaW5nUmVjdGFuZ2xlLnBhY2tlZExlbmd0aCA9IDQ7CiAgICAgIEJvdW5kaW5nUmVjdGFuZ2xlLnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS54OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS55OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS53aWR0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLmhlaWdodDsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nUmVjdGFuZ2xlLnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdSZWN0YW5nbGUoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC55ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQud2lkdGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC5oZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS5mcm9tUG9pbnRzID0gZnVuY3Rpb24ocG9zaXRpb25zLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdSZWN0YW5nbGUoKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSB8fCBwb3NpdGlvbnMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICByZXN1bHQueCA9IDA7CiAgICAgICAgICByZXN1bHQueSA9IDA7CiAgICAgICAgICByZXN1bHQud2lkdGggPSAwOwogICAgICAgICAgcmVzdWx0LmhlaWdodCA9IDA7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGxldCBtaW5pbXVtWCA9IHBvc2l0aW9uc1swXS54OwogICAgICAgIGxldCBtaW5pbXVtWSA9IHBvc2l0aW9uc1swXS55OwogICAgICAgIGxldCBtYXhpbXVtWCA9IHBvc2l0aW9uc1swXS54OwogICAgICAgIGxldCBtYXhpbXVtWSA9IHBvc2l0aW9uc1swXS55OwogICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHAgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICBjb25zdCB4ID0gcC54OwogICAgICAgICAgY29uc3QgeSA9IHAueTsKICAgICAgICAgIG1pbmltdW1YID0gTWF0aC5taW4oeCwgbWluaW11bVgpOwogICAgICAgICAgbWF4aW11bVggPSBNYXRoLm1heCh4LCBtYXhpbXVtWCk7CiAgICAgICAgICBtaW5pbXVtWSA9IE1hdGgubWluKHksIG1pbmltdW1ZKTsKICAgICAgICAgIG1heGltdW1ZID0gTWF0aC5tYXgoeSwgbWF4aW11bVkpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IG1pbmltdW1YOwogICAgICAgIHJlc3VsdC55ID0gbWluaW11bVk7CiAgICAgICAgcmVzdWx0LndpZHRoID0gbWF4aW11bVggLSBtaW5pbXVtWDsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gbWF4aW11bVkgLSBtaW5pbXVtWTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBkZWZhdWx0UHJvamVjdGlvbjIgPSBuZXcgR2VvZ3JhcGhpY1Byb2plY3Rpb25fZGVmYXVsdCgpOwogICAgICBmcm9tUmVjdGFuZ2xlTG93ZXJMZWZ0ID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIGZyb21SZWN0YW5nbGVVcHBlclJpZ2h0ID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIEJvdW5kaW5nUmVjdGFuZ2xlLmZyb21SZWN0YW5nbGUgPSBmdW5jdGlvbihyZWN0YW5nbGUsIHByb2plY3Rpb24sIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBCb3VuZGluZ1JlY3RhbmdsZSgpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZWN0YW5nbGUpKSB7CiAgICAgICAgICByZXN1bHQueCA9IDA7CiAgICAgICAgICByZXN1bHQueSA9IDA7CiAgICAgICAgICByZXN1bHQud2lkdGggPSAwOwogICAgICAgICAgcmVzdWx0LmhlaWdodCA9IDA7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBwcm9qZWN0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQocHJvamVjdGlvbiwgZGVmYXVsdFByb2plY3Rpb24yKTsKICAgICAgICBjb25zdCBsb3dlckxlZnQgPSBwcm9qZWN0aW9uLnByb2plY3QoCiAgICAgICAgICBSZWN0YW5nbGVfZGVmYXVsdC5zb3V0aHdlc3QocmVjdGFuZ2xlLCBmcm9tUmVjdGFuZ2xlTG93ZXJMZWZ0KQogICAgICAgICk7CiAgICAgICAgY29uc3QgdXBwZXJSaWdodCA9IHByb2plY3Rpb24ucHJvamVjdCgKICAgICAgICAgIFJlY3RhbmdsZV9kZWZhdWx0Lm5vcnRoZWFzdChyZWN0YW5nbGUsIGZyb21SZWN0YW5nbGVVcHBlclJpZ2h0KQogICAgICAgICk7CiAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0LnN1YnRyYWN0KHVwcGVyUmlnaHQsIGxvd2VyTGVmdCwgdXBwZXJSaWdodCk7CiAgICAgICAgcmVzdWx0LnggPSBsb3dlckxlZnQueDsKICAgICAgICByZXN1bHQueSA9IGxvd2VyTGVmdC55OwogICAgICAgIHJlc3VsdC53aWR0aCA9IHVwcGVyUmlnaHQueDsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gdXBwZXJSaWdodC55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nUmVjdGFuZ2xlLmNsb25lID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZWN0YW5nbGUpKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEJvdW5kaW5nUmVjdGFuZ2xlKAogICAgICAgICAgICByZWN0YW5nbGUueCwKICAgICAgICAgICAgcmVjdGFuZ2xlLnksCiAgICAgICAgICAgIHJlY3RhbmdsZS53aWR0aCwKICAgICAgICAgICAgcmVjdGFuZ2xlLmhlaWdodAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSByZWN0YW5nbGUueDsKICAgICAgICByZXN1bHQueSA9IHJlY3RhbmdsZS55OwogICAgICAgIHJlc3VsdC53aWR0aCA9IHJlY3RhbmdsZS53aWR0aDsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gcmVjdGFuZ2xlLmhlaWdodDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS51bmlvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBCb3VuZGluZ1JlY3RhbmdsZSgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBsb3dlckxlZnRYID0gTWF0aC5taW4obGVmdC54LCByaWdodC54KTsKICAgICAgICBjb25zdCBsb3dlckxlZnRZID0gTWF0aC5taW4obGVmdC55LCByaWdodC55KTsKICAgICAgICBjb25zdCB1cHBlclJpZ2h0WCA9IE1hdGgubWF4KGxlZnQueCArIGxlZnQud2lkdGgsIHJpZ2h0LnggKyByaWdodC53aWR0aCk7CiAgICAgICAgY29uc3QgdXBwZXJSaWdodFkgPSBNYXRoLm1heChsZWZ0LnkgKyBsZWZ0LmhlaWdodCwgcmlnaHQueSArIHJpZ2h0LmhlaWdodCk7CiAgICAgICAgcmVzdWx0LnggPSBsb3dlckxlZnRYOwogICAgICAgIHJlc3VsdC55ID0gbG93ZXJMZWZ0WTsKICAgICAgICByZXN1bHQud2lkdGggPSB1cHBlclJpZ2h0WCAtIGxvd2VyTGVmdFg7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IHVwcGVyUmlnaHRZIC0gbG93ZXJMZWZ0WTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS5leHBhbmQgPSBmdW5jdGlvbihyZWN0YW5nbGUsIHBvaW50LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJwb2ludCIsIHBvaW50KTsKICAgICAgICByZXN1bHQgPSBCb3VuZGluZ1JlY3RhbmdsZS5jbG9uZShyZWN0YW5nbGUsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgd2lkdGggPSBwb2ludC54IC0gcmVzdWx0Lng7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gcG9pbnQueSAtIHJlc3VsdC55OwogICAgICAgIGlmICh3aWR0aCA+IHJlc3VsdC53aWR0aCkgewogICAgICAgICAgcmVzdWx0LndpZHRoID0gd2lkdGg7CiAgICAgICAgfSBlbHNlIGlmICh3aWR0aCA8IDApIHsKICAgICAgICAgIHJlc3VsdC53aWR0aCAtPSB3aWR0aDsKICAgICAgICAgIHJlc3VsdC54ID0gcG9pbnQueDsKICAgICAgICB9CiAgICAgICAgaWYgKGhlaWdodCA+IHJlc3VsdC5oZWlnaHQpIHsKICAgICAgICAgIHJlc3VsdC5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgfSBlbHNlIGlmIChoZWlnaHQgPCAwKSB7CiAgICAgICAgICByZXN1bHQuaGVpZ2h0IC09IGhlaWdodDsKICAgICAgICAgIHJlc3VsdC55ID0gcG9pbnQueTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQm91bmRpbmdSZWN0YW5nbGUuaW50ZXJzZWN0ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIGNvbnN0IGxlZnRYID0gbGVmdC54OwogICAgICAgIGNvbnN0IGxlZnRZID0gbGVmdC55OwogICAgICAgIGNvbnN0IHJpZ2h0WCA9IHJpZ2h0Lng7CiAgICAgICAgY29uc3QgcmlnaHRZID0gcmlnaHQueTsKICAgICAgICBpZiAoIShsZWZ0WCA+IHJpZ2h0WCArIHJpZ2h0LndpZHRoIHx8IGxlZnRYICsgbGVmdC53aWR0aCA8IHJpZ2h0WCB8fCBsZWZ0WSArIGxlZnQuaGVpZ2h0IDwgcmlnaHRZIHx8IGxlZnRZID4gcmlnaHRZICsgcmlnaHQuaGVpZ2h0KSkgewogICAgICAgICAgcmV0dXJuIEludGVyc2VjdF9kZWZhdWx0LklOVEVSU0VDVElORzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIEludGVyc2VjdF9kZWZhdWx0Lk9VVFNJREU7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nUmVjdGFuZ2xlLmVxdWFscyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIGxlZnQgPT09IHJpZ2h0IHx8IGRlZmluZWRfZGVmYXVsdChsZWZ0KSAmJiBkZWZpbmVkX2RlZmF1bHQocmlnaHQpICYmIGxlZnQueCA9PT0gcmlnaHQueCAmJiBsZWZ0LnkgPT09IHJpZ2h0LnkgJiYgbGVmdC53aWR0aCA9PT0gcmlnaHQud2lkdGggJiYgbGVmdC5oZWlnaHQgPT09IHJpZ2h0LmhlaWdodDsKICAgICAgfTsKICAgICAgQm91bmRpbmdSZWN0YW5nbGUucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIEJvdW5kaW5nUmVjdGFuZ2xlLmNsb25lKHRoaXMsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nUmVjdGFuZ2xlLnByb3RvdHlwZS5pbnRlcnNlY3QgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiBCb3VuZGluZ1JlY3RhbmdsZS5pbnRlcnNlY3QodGhpcywgcmlnaHQpOwogICAgICB9OwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ocmlnaHQpIHsKICAgICAgICByZXR1cm4gQm91bmRpbmdSZWN0YW5nbGUuZXF1YWxzKHRoaXMsIHJpZ2h0KTsKICAgICAgfTsKICAgICAgQm91bmRpbmdSZWN0YW5nbGVfZGVmYXVsdCA9IEJvdW5kaW5nUmVjdGFuZ2xlOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQXhpc0FsaWduZWRCb3VuZGluZ0JveC5qcwogIGZ1bmN0aW9uIEF4aXNBbGlnbmVkQm91bmRpbmdCb3gobWluaW11bSwgbWF4aW11bSwgY2VudGVyKSB7CiAgICB0aGlzLm1pbmltdW0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZGVmYXVsdFZhbHVlX2RlZmF1bHQobWluaW11bSwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pKTsKICAgIHRoaXMubWF4aW11bSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShkZWZhdWx0VmFsdWVfZGVmYXVsdChtYXhpbXVtLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTykpOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY2VudGVyKSkgewogICAgICBjZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWlkcG9pbnQodGhpcy5taW5pbXVtLCB0aGlzLm1heGltdW0sIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSk7CiAgICB9IGVsc2UgewogICAgICBjZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY2VudGVyKTsKICAgIH0KICAgIHRoaXMuY2VudGVyID0gY2VudGVyOwogIH0KICB2YXIgaW50ZXJzZWN0U2NyYXRjaCwgQXhpc0FsaWduZWRCb3VuZGluZ0JveF9kZWZhdWx0OwogIHZhciBpbml0X0F4aXNBbGlnbmVkQm91bmRpbmdCb3ggPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0F4aXNBbGlnbmVkQm91bmRpbmdCb3guanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9JbnRlcnNlY3QoKTsKICAgICAgQXhpc0FsaWduZWRCb3VuZGluZ0JveC5mcm9tQ29ybmVycyA9IGZ1bmN0aW9uKG1pbmltdW0sIG1heGltdW0sIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgibWluaW11bSIsIG1pbmltdW0pOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgibWF4aW11bSIsIG1heGltdW0pOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBeGlzQWxpZ25lZEJvdW5kaW5nQm94KCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5taW5pbXVtID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG1pbmltdW0sIHJlc3VsdC5taW5pbXVtKTsKICAgICAgICByZXN1bHQubWF4aW11bSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShtYXhpbXVtLCByZXN1bHQubWF4aW11bSk7CiAgICAgICAgcmVzdWx0LmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5taWRwb2ludChtaW5pbXVtLCBtYXhpbXVtLCByZXN1bHQuY2VudGVyKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBBeGlzQWxpZ25lZEJvdW5kaW5nQm94LmZyb21Qb2ludHMgPSBmdW5jdGlvbihwb3NpdGlvbnMsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBeGlzQWxpZ25lZEJvdW5kaW5nQm94KCk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgfHwgcG9zaXRpb25zLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmVzdWx0Lm1pbmltdW0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIHJlc3VsdC5taW5pbXVtKTsKICAgICAgICAgIHJlc3VsdC5tYXhpbXVtID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCByZXN1bHQubWF4aW11bSk7CiAgICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCByZXN1bHQuY2VudGVyKTsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGxldCBtaW5pbXVtWCA9IHBvc2l0aW9uc1swXS54OwogICAgICAgIGxldCBtaW5pbXVtWSA9IHBvc2l0aW9uc1swXS55OwogICAgICAgIGxldCBtaW5pbXVtWiA9IHBvc2l0aW9uc1swXS56OwogICAgICAgIGxldCBtYXhpbXVtWCA9IHBvc2l0aW9uc1swXS54OwogICAgICAgIGxldCBtYXhpbXVtWSA9IHBvc2l0aW9uc1swXS55OwogICAgICAgIGxldCBtYXhpbXVtWiA9IHBvc2l0aW9uc1swXS56OwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgcCA9IHBvc2l0aW9uc1tpXTsKICAgICAgICAgIGNvbnN0IHggPSBwLng7CiAgICAgICAgICBjb25zdCB5ID0gcC55OwogICAgICAgICAgY29uc3QgeiA9IHAuejsKICAgICAgICAgIG1pbmltdW1YID0gTWF0aC5taW4oeCwgbWluaW11bVgpOwogICAgICAgICAgbWF4aW11bVggPSBNYXRoLm1heCh4LCBtYXhpbXVtWCk7CiAgICAgICAgICBtaW5pbXVtWSA9IE1hdGgubWluKHksIG1pbmltdW1ZKTsKICAgICAgICAgIG1heGltdW1ZID0gTWF0aC5tYXgoeSwgbWF4aW11bVkpOwogICAgICAgICAgbWluaW11bVogPSBNYXRoLm1pbih6LCBtaW5pbXVtWik7CiAgICAgICAgICBtYXhpbXVtWiA9IE1hdGgubWF4KHosIG1heGltdW1aKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbWluaW11bSA9IHJlc3VsdC5taW5pbXVtOwogICAgICAgIG1pbmltdW0ueCA9IG1pbmltdW1YOwogICAgICAgIG1pbmltdW0ueSA9IG1pbmltdW1ZOwogICAgICAgIG1pbmltdW0ueiA9IG1pbmltdW1aOwogICAgICAgIGNvbnN0IG1heGltdW0gPSByZXN1bHQubWF4aW11bTsKICAgICAgICBtYXhpbXVtLnggPSBtYXhpbXVtWDsKICAgICAgICBtYXhpbXVtLnkgPSBtYXhpbXVtWTsKICAgICAgICBtYXhpbXVtLnogPSBtYXhpbXVtWjsKICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1pZHBvaW50KG1pbmltdW0sIG1heGltdW0sIHJlc3VsdC5jZW50ZXIpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEF4aXNBbGlnbmVkQm91bmRpbmdCb3guY2xvbmUgPSBmdW5jdGlvbihib3gsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJveCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQXhpc0FsaWduZWRCb3VuZGluZ0JveChib3gubWluaW11bSwgYm94Lm1heGltdW0sIGJveC5jZW50ZXIpOwogICAgICAgIH0KICAgICAgICByZXN1bHQubWluaW11bSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShib3gubWluaW11bSwgcmVzdWx0Lm1pbmltdW0pOwogICAgICAgIHJlc3VsdC5tYXhpbXVtID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGJveC5tYXhpbXVtLCByZXN1bHQubWF4aW11bSk7CiAgICAgICAgcmVzdWx0LmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShib3guY2VudGVyLCByZXN1bHQuY2VudGVyKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBBeGlzQWxpZ25lZEJvdW5kaW5nQm94LmVxdWFscyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIGxlZnQgPT09IHJpZ2h0IHx8IGRlZmluZWRfZGVmYXVsdChsZWZ0KSAmJiBkZWZpbmVkX2RlZmF1bHQocmlnaHQpICYmIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMobGVmdC5jZW50ZXIsIHJpZ2h0LmNlbnRlcikgJiYgQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhsZWZ0Lm1pbmltdW0sIHJpZ2h0Lm1pbmltdW0pICYmIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMobGVmdC5tYXhpbXVtLCByaWdodC5tYXhpbXVtKTsKICAgICAgfTsKICAgICAgaW50ZXJzZWN0U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgQXhpc0FsaWduZWRCb3VuZGluZ0JveC5pbnRlcnNlY3RQbGFuZSA9IGZ1bmN0aW9uKGJveCwgcGxhbmUpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImJveCIsIGJveCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJwbGFuZSIsIHBsYW5lKTsKICAgICAgICBpbnRlcnNlY3RTY3JhdGNoID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgYm94Lm1heGltdW0sCiAgICAgICAgICBib3gubWluaW11bSwKICAgICAgICAgIGludGVyc2VjdFNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IGggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgIGludGVyc2VjdFNjcmF0Y2gsCiAgICAgICAgICAwLjUsCiAgICAgICAgICBpbnRlcnNlY3RTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBub3JtYWwyID0gcGxhbmUubm9ybWFsOwogICAgICAgIGNvbnN0IGUgPSBoLnggKiBNYXRoLmFicyhub3JtYWwyLngpICsgaC55ICogTWF0aC5hYnMobm9ybWFsMi55KSArIGgueiAqIE1hdGguYWJzKG5vcm1hbDIueik7CiAgICAgICAgY29uc3QgcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoYm94LmNlbnRlciwgbm9ybWFsMikgKyBwbGFuZS5kaXN0YW5jZTsKICAgICAgICBpZiAocyAtIGUgPiAwKSB7CiAgICAgICAgICByZXR1cm4gSW50ZXJzZWN0X2RlZmF1bHQuSU5TSURFOwogICAgICAgIH0KICAgICAgICBpZiAocyArIGUgPCAwKSB7CiAgICAgICAgICByZXR1cm4gSW50ZXJzZWN0X2RlZmF1bHQuT1VUU0lERTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIEludGVyc2VjdF9kZWZhdWx0LklOVEVSU0VDVElORzsKICAgICAgfTsKICAgICAgQXhpc0FsaWduZWRCb3VuZGluZ0JveC5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICByZXR1cm4gQXhpc0FsaWduZWRCb3VuZGluZ0JveC5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBBeGlzQWxpZ25lZEJvdW5kaW5nQm94LnByb3RvdHlwZS5pbnRlcnNlY3RQbGFuZSA9IGZ1bmN0aW9uKHBsYW5lKSB7CiAgICAgICAgcmV0dXJuIEF4aXNBbGlnbmVkQm91bmRpbmdCb3guaW50ZXJzZWN0UGxhbmUodGhpcywgcGxhbmUpOwogICAgICB9OwogICAgICBBeGlzQWxpZ25lZEJvdW5kaW5nQm94LnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiBBeGlzQWxpZ25lZEJvdW5kaW5nQm94LmVxdWFscyh0aGlzLCByaWdodCk7CiAgICAgIH07CiAgICAgIEF4aXNBbGlnbmVkQm91bmRpbmdCb3hfZGVmYXVsdCA9IEF4aXNBbGlnbmVkQm91bmRpbmdCb3g7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNvaWRUYW5nZW50UGxhbmUuanMKICBmdW5jdGlvbiBFbGxpcHNvaWRUYW5nZW50UGxhbmUob3JpZ2luLCBlbGxpcHNvaWQpIHsKICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib3JpZ2luIiwgb3JpZ2luKTsKICAgIGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgb3JpZ2luID0gZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2Uob3JpZ2luKTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG9yaWdpbikpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIm9yaWdpbiBtdXN0IG5vdCBiZSBhdCB0aGUgY2VudGVyIG9mIHRoZSBlbGxpcHNvaWQuIgogICAgICApOwogICAgfQogICAgY29uc3QgZWFzdE5vcnRoVXAgPSBUcmFuc2Zvcm1zX2RlZmF1bHQuZWFzdE5vcnRoVXBUb0ZpeGVkRnJhbWUob3JpZ2luLCBlbGxpcHNvaWQpOwogICAgdGhpcy5fZWxsaXBzb2lkID0gZWxsaXBzb2lkOwogICAgdGhpcy5fb3JpZ2luID0gb3JpZ2luOwogICAgdGhpcy5feEF4aXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUNhcnRlc2lhbjQoCiAgICAgIE1hdHJpeDRfZGVmYXVsdC5nZXRDb2x1bW4oZWFzdE5vcnRoVXAsIDAsIHNjcmF0Y2hDYXJ0NCkKICAgICk7CiAgICB0aGlzLl95QXhpcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQ2FydGVzaWFuNCgKICAgICAgTWF0cml4NF9kZWZhdWx0LmdldENvbHVtbihlYXN0Tm9ydGhVcCwgMSwgc2NyYXRjaENhcnQ0KQogICAgKTsKICAgIGNvbnN0IG5vcm1hbDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUNhcnRlc2lhbjQoCiAgICAgIE1hdHJpeDRfZGVmYXVsdC5nZXRDb2x1bW4oZWFzdE5vcnRoVXAsIDIsIHNjcmF0Y2hDYXJ0NCkKICAgICk7CiAgICB0aGlzLl9wbGFuZSA9IFBsYW5lX2RlZmF1bHQuZnJvbVBvaW50Tm9ybWFsKG9yaWdpbiwgbm9ybWFsMik7CiAgfQogIHZhciBzY3JhdGNoQ2FydDQsIHRtcCwgc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZVJheSwgc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZUNhcnRlc2lhbjMsIHByb2plY3RQb2ludHNPbnRvRWxsaXBzb2lkU2NyYXRjaCwgRWxsaXBzb2lkVGFuZ2VudFBsYW5lX2RlZmF1bHQ7CiAgdmFyIGluaXRfRWxsaXBzb2lkVGFuZ2VudFBsYW5lID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNvaWRUYW5nZW50UGxhbmUuanMiKCkgewogICAgICBpbml0X0F4aXNBbGlnbmVkQm91bmRpbmdCb3goKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRlc2lhbjQoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0ludGVyc2VjdGlvblRlc3RzKCk7CiAgICAgIGluaXRfTWF0cml4NCgpOwogICAgICBpbml0X1BsYW5lKCk7CiAgICAgIGluaXRfUmF5KCk7CiAgICAgIGluaXRfVHJhbnNmb3JtcygpOwogICAgICBzY3JhdGNoQ2FydDQgPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBlbGxpcHNvaWQuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7RWxsaXBzb2lkfQogICAgICAgICAqLwogICAgICAgIGVsbGlwc29pZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VsbGlwc29pZDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIG9yaWdpbi4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkVGFuZ2VudFBsYW5lLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDYXJ0ZXNpYW4zfQogICAgICAgICAqLwogICAgICAgIG9yaWdpbjogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX29yaWdpbjsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHBsYW5lIHdoaWNoIGlzIHRhbmdlbnQgdG8gdGhlIGVsbGlwc29pZC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkVGFuZ2VudFBsYW5lLnByb3RvdHlwZQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqIEB0eXBlIHtQbGFuZX0KICAgICAgICAgKi8KICAgICAgICBwbGFuZTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BsYW5lOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgbG9jYWwgWC1heGlzIChlYXN0KSBvZiB0aGUgdGFuZ2VudCBwbGFuZS4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkVGFuZ2VudFBsYW5lLnByb3RvdHlwZQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqIEB0eXBlIHtDYXJ0ZXNpYW4zfQogICAgICAgICAqLwogICAgICAgIHhBeGlzOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5feEF4aXM7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBsb2NhbCBZLWF4aXMgKG5vcnRoKSBvZiB0aGUgdGFuZ2VudCBwbGFuZS4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkVGFuZ2VudFBsYW5lLnByb3RvdHlwZQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqIEB0eXBlIHtDYXJ0ZXNpYW4zfQogICAgICAgICAqLwogICAgICAgIHlBeGlzOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5feUF4aXM7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBsb2NhbCBaLWF4aXMgKHVwKSBvZiB0aGUgdGFuZ2VudCBwbGFuZS4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkVGFuZ2VudFBsYW5lLnByb3RvdHlwZQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqIEB0eXBlIHtDYXJ0ZXNpYW4zfQogICAgICAgICAqLwogICAgICAgIHpBeGlzOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcGxhbmUubm9ybWFsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHRtcCA9IG5ldyBBeGlzQWxpZ25lZEJvdW5kaW5nQm94X2RlZmF1bHQoKTsKICAgICAgRWxsaXBzb2lkVGFuZ2VudFBsYW5lLmZyb21Qb2ludHMgPSBmdW5jdGlvbihjYXJ0ZXNpYW5zLCBlbGxpcHNvaWQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNhcnRlc2lhbnMiLCBjYXJ0ZXNpYW5zKTsKICAgICAgICBjb25zdCBib3ggPSBBeGlzQWxpZ25lZEJvdW5kaW5nQm94X2RlZmF1bHQuZnJvbVBvaW50cyhjYXJ0ZXNpYW5zLCB0bXApOwogICAgICAgIHJldHVybiBuZXcgRWxsaXBzb2lkVGFuZ2VudFBsYW5lKGJveC5jZW50ZXIsIGVsbGlwc29pZCk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVSYXkgPSBuZXcgUmF5X2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZUNhcnRlc2lhbjMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUucHJvamVjdFBvaW50T250b1BsYW5lID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIGNvbnN0IHJheSA9IHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVSYXk7CiAgICAgICAgcmF5Lm9yaWdpbiA9IGNhcnRlc2lhbjExOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoY2FydGVzaWFuMTEsIHJheS5kaXJlY3Rpb24pOwogICAgICAgIGxldCBpbnRlcnNlY3Rpb25Qb2ludCA9IEludGVyc2VjdGlvblRlc3RzX2RlZmF1bHQucmF5UGxhbmUoCiAgICAgICAgICByYXksCiAgICAgICAgICB0aGlzLl9wbGFuZSwKICAgICAgICAgIHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVDYXJ0ZXNpYW4zCiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbnRlcnNlY3Rpb25Qb2ludCkpIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUocmF5LmRpcmVjdGlvbiwgcmF5LmRpcmVjdGlvbik7CiAgICAgICAgICBpbnRlcnNlY3Rpb25Qb2ludCA9IEludGVyc2VjdGlvblRlc3RzX2RlZmF1bHQucmF5UGxhbmUoCiAgICAgICAgICAgIHJheSwKICAgICAgICAgICAgdGhpcy5fcGxhbmUsCiAgICAgICAgICAgIHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVDYXJ0ZXNpYW4zCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGludGVyc2VjdGlvblBvaW50KSkgewogICAgICAgICAgY29uc3QgdjMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICAgIGludGVyc2VjdGlvblBvaW50LAogICAgICAgICAgICB0aGlzLl9vcmlnaW4sCiAgICAgICAgICAgIGludGVyc2VjdGlvblBvaW50CiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgeCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodGhpcy5feEF4aXMsIHYzKTsKICAgICAgICAgIGNvbnN0IHkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHRoaXMuX3lBeGlzLCB2Myk7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KHgsIHkpOwogICAgICAgICAgfQogICAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkVGFuZ2VudFBsYW5lLnByb3RvdHlwZS5wcm9qZWN0UG9pbnRzT250b1BsYW5lID0gZnVuY3Rpb24oY2FydGVzaWFucywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjYXJ0ZXNpYW5zIiwgY2FydGVzaWFucyk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gW107CiAgICAgICAgfQogICAgICAgIGxldCBjb3VudCA9IDA7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gY2FydGVzaWFucy5sZW5ndGg7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgcCA9IHRoaXMucHJvamVjdFBvaW50T250b1BsYW5lKGNhcnRlc2lhbnNbaV0sIHJlc3VsdFtjb3VudF0pOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChwKSkgewogICAgICAgICAgICByZXN1bHRbY291bnRdID0gcDsKICAgICAgICAgICAgY291bnQrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IGNvdW50OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUucHJvamVjdFBvaW50VG9OZWFyZXN0T25QbGFuZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJheSA9IHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVSYXk7CiAgICAgICAgcmF5Lm9yaWdpbiA9IGNhcnRlc2lhbjExOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZSh0aGlzLl9wbGFuZS5ub3JtYWwsIHJheS5kaXJlY3Rpb24pOwogICAgICAgIGxldCBpbnRlcnNlY3Rpb25Qb2ludCA9IEludGVyc2VjdGlvblRlc3RzX2RlZmF1bHQucmF5UGxhbmUoCiAgICAgICAgICByYXksCiAgICAgICAgICB0aGlzLl9wbGFuZSwKICAgICAgICAgIHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVDYXJ0ZXNpYW4zCiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbnRlcnNlY3Rpb25Qb2ludCkpIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUocmF5LmRpcmVjdGlvbiwgcmF5LmRpcmVjdGlvbik7CiAgICAgICAgICBpbnRlcnNlY3Rpb25Qb2ludCA9IEludGVyc2VjdGlvblRlc3RzX2RlZmF1bHQucmF5UGxhbmUoCiAgICAgICAgICAgIHJheSwKICAgICAgICAgICAgdGhpcy5fcGxhbmUsCiAgICAgICAgICAgIHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVDYXJ0ZXNpYW4zCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCB2MyA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgIGludGVyc2VjdGlvblBvaW50LAogICAgICAgICAgdGhpcy5fb3JpZ2luLAogICAgICAgICAgaW50ZXJzZWN0aW9uUG9pbnQKICAgICAgICApOwogICAgICAgIGNvbnN0IHggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHRoaXMuX3hBeGlzLCB2Myk7CiAgICAgICAgY29uc3QgeSA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodGhpcy5feUF4aXMsIHYzKTsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUucHJvamVjdFBvaW50c1RvTmVhcmVzdE9uUGxhbmUgPSBmdW5jdGlvbihjYXJ0ZXNpYW5zLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNhcnRlc2lhbnMiLCBjYXJ0ZXNpYW5zKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBbXTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoID0gY2FydGVzaWFucy5sZW5ndGg7CiAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IGxlbmd0aDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICByZXN1bHRbaV0gPSB0aGlzLnByb2plY3RQb2ludFRvTmVhcmVzdE9uUGxhbmUoY2FydGVzaWFuc1tpXSwgcmVzdWx0W2ldKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgcHJvamVjdFBvaW50c09udG9FbGxpcHNvaWRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBFbGxpcHNvaWRUYW5nZW50UGxhbmUucHJvdG90eXBlLnByb2plY3RQb2ludE9udG9FbGxpcHNvaWQgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSB0aGlzLl9lbGxpcHNvaWQ7CiAgICAgICAgY29uc3Qgb3JpZ2luID0gdGhpcy5fb3JpZ2luOwogICAgICAgIGNvbnN0IHhBeGlzID0gdGhpcy5feEF4aXM7CiAgICAgICAgY29uc3QgeUF4aXMgPSB0aGlzLl95QXhpczsKICAgICAgICBjb25zdCB0bXAyID0gcHJvamVjdFBvaW50c09udG9FbGxpcHNvaWRTY3JhdGNoOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHhBeGlzLCBjYXJ0ZXNpYW4xMS54LCB0bXAyKTsKICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG9yaWdpbiwgdG1wMiwgcmVzdWx0KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcih5QXhpcywgY2FydGVzaWFuMTEueSwgdG1wMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyZXN1bHQsIHRtcDIsIHJlc3VsdCk7CiAgICAgICAgZWxsaXBzb2lkLnNjYWxlVG9HZW9jZW50cmljU3VyZmFjZShyZXN1bHQsIHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkVGFuZ2VudFBsYW5lLnByb3RvdHlwZS5wcm9qZWN0UG9pbnRzT250b0VsbGlwc29pZCA9IGZ1bmN0aW9uKGNhcnRlc2lhbnMsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2FydGVzaWFucyIsIGNhcnRlc2lhbnMpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNhcnRlc2lhbnMubGVuZ3RoOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICByZXN1bHRbaV0gPSB0aGlzLnByb2plY3RQb2ludE9udG9FbGxpcHNvaWQoY2FydGVzaWFuc1tpXSwgcmVzdWx0W2ldKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkVGFuZ2VudFBsYW5lX2RlZmF1bHQgPSBFbGxpcHNvaWRUYW5nZW50UGxhbmU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9PcmllbnRlZEJvdW5kaW5nQm94LmpzCiAgZnVuY3Rpb24gT3JpZW50ZWRCb3VuZGluZ0JveChjZW50ZXIsIGhhbGZBeGVzKSB7CiAgICB0aGlzLmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShkZWZhdWx0VmFsdWVfZGVmYXVsdChjZW50ZXIsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSk7CiAgICB0aGlzLmhhbGZBeGVzID0gTWF0cml4M19kZWZhdWx0LmNsb25lKGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGhhbGZBeGVzLCBNYXRyaXgzX2RlZmF1bHQuWkVSTykpOwogIH0KICBmdW5jdGlvbiBmcm9tUGxhbmVFeHRlbnRzKHBsYW5lT3JpZ2luLCBwbGFuZVhBeGlzLCBwbGFuZVlBeGlzLCBwbGFuZVpBeGlzLCBtaW5pbXVtWCwgbWF4aW11bVgsIG1pbmltdW1ZLCBtYXhpbXVtWSwgbWluaW11bVosIG1heGltdW1aLCByZXN1bHQpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1YKSB8fCAhZGVmaW5lZF9kZWZhdWx0KG1heGltdW1YKSB8fCAhZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1ZKSB8fCAhZGVmaW5lZF9kZWZhdWx0KG1heGltdW1ZKSB8fCAhZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1aKSB8fCAhZGVmaW5lZF9kZWZhdWx0KG1heGltdW1aKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAiYWxsIGV4dGVudHMgKG1pbmltdW0vbWF4aW11bSBYL1kvWikgYXJlIHJlcXVpcmVkLiIKICAgICAgKTsKICAgIH0KICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgcmVzdWx0ID0gbmV3IE9yaWVudGVkQm91bmRpbmdCb3goKTsKICAgIH0KICAgIGNvbnN0IGhhbGZBeGVzID0gcmVzdWx0LmhhbGZBeGVzOwogICAgTWF0cml4M19kZWZhdWx0LnNldENvbHVtbihoYWxmQXhlcywgMCwgcGxhbmVYQXhpcywgaGFsZkF4ZXMpOwogICAgTWF0cml4M19kZWZhdWx0LnNldENvbHVtbihoYWxmQXhlcywgMSwgcGxhbmVZQXhpcywgaGFsZkF4ZXMpOwogICAgTWF0cml4M19kZWZhdWx0LnNldENvbHVtbihoYWxmQXhlcywgMiwgcGxhbmVaQXhpcywgaGFsZkF4ZXMpOwogICAgbGV0IGNlbnRlck9mZnNldCA9IHNjcmF0Y2hPZmZzZXQ7CiAgICBjZW50ZXJPZmZzZXQueCA9IChtaW5pbXVtWCArIG1heGltdW1YKSAvIDI7CiAgICBjZW50ZXJPZmZzZXQueSA9IChtaW5pbXVtWSArIG1heGltdW1ZKSAvIDI7CiAgICBjZW50ZXJPZmZzZXQueiA9IChtaW5pbXVtWiArIG1heGltdW1aKSAvIDI7CiAgICBjb25zdCBzY2FsZSA9IHNjcmF0Y2hTY2FsZTI7CiAgICBzY2FsZS54ID0gKG1heGltdW1YIC0gbWluaW11bVgpIC8gMjsKICAgIHNjYWxlLnkgPSAobWF4aW11bVkgLSBtaW5pbXVtWSkgLyAyOwogICAgc2NhbGUueiA9IChtYXhpbXVtWiAtIG1pbmltdW1aKSAvIDI7CiAgICBjb25zdCBjZW50ZXIgPSByZXN1bHQuY2VudGVyOwogICAgY2VudGVyT2Zmc2V0ID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoaGFsZkF4ZXMsIGNlbnRlck9mZnNldCwgY2VudGVyT2Zmc2V0KTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocGxhbmVPcmlnaW4sIGNlbnRlck9mZnNldCwgY2VudGVyKTsKICAgIE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGUoaGFsZkF4ZXMsIHNjYWxlLCBoYWxmQXhlcyk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICB2YXIgc2NyYXRjaENhcnRlc2lhbjE1LCBzY3JhdGNoQ2FydGVzaWFuMjUsIHNjcmF0Y2hDYXJ0ZXNpYW4zNiwgc2NyYXRjaENhcnRlc2lhbjQyLCBzY3JhdGNoQ2FydGVzaWFuNSwgc2NyYXRjaENhcnRlc2lhbjYsIHNjcmF0Y2hDb3ZhcmlhbmNlUmVzdWx0LCBzY3JhdGNoRWlnZW5SZXN1bHQsIHNjcmF0Y2hPZmZzZXQsIHNjcmF0Y2hTY2FsZTIsIHNjcmF0Y2hSZWN0YW5nbGVDZW50ZXJDYXJ0b2dyYXBoaWMsIHNjcmF0Y2hSZWN0YW5nbGVDZW50ZXIsIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0b2dyYXBoaWNOQywgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY05XLCBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljQ1csIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0b2dyYXBoaWNTVywgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY1NDLCBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuTkMsIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5OVywgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhbkNXLCBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuU1csIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5TQywgc2NyYXRjaFBlcmltZXRlclByb2plY3RlZE5DLCBzY3JhdGNoUGVyaW1ldGVyUHJvamVjdGVkTlcsIHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWRDVywgc2NyYXRjaFBlcmltZXRlclByb2plY3RlZFNXLCBzY3JhdGNoUGVyaW1ldGVyUHJvamVjdGVkU0MsIHNjcmF0Y2hQbGFuZU9yaWdpbiwgc2NyYXRjaFBsYW5lTm9ybWFsLCBzY3JhdGNoUGxhbmVYQXhpcywgc2NyYXRjaEhvcml6b25DYXJ0ZXNpYW4sIHNjcmF0Y2hIb3Jpem9uUHJvamVjdGVkLCBzY3JhdGNoTWF4WSwgc2NyYXRjaE1pblksIHNjcmF0Y2haLCBzY3JhdGNoUGxhbmUsIHNjcmF0Y2hDYXJ0ZXNpYW5VLCBzY3JhdGNoQ2FydGVzaWFuViwgc2NyYXRjaENhcnRlc2lhblcsIHNjcmF0Y2hWYWxpZEF4aXMyLCBzY3JhdGNoVmFsaWRBeGlzMywgc2NyYXRjaFBQcmltZSwgc2NyYXRjaENvcm5lciwgc2NyYXRjaFRvQ2VudGVyLCBzY3JhdGNoWEF4aXMsIHNjcmF0Y2hZQXhpcywgc2NyYXRjaFpBeGlzLCBzY3JhdGNoUm90YXRpb25TY2FsZSwgc2NyYXRjaEJvdW5kaW5nU3BoZXJlLCBPcmllbnRlZEJvdW5kaW5nQm94X2RlZmF1bHQ7CiAgdmFyIGluaXRfT3JpZW50ZWRCb3VuZGluZ0JveCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvT3JpZW50ZWRCb3VuZGluZ0JveC5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkVGFuZ2VudFBsYW5lKCk7CiAgICAgIGluaXRfSW50ZXJzZWN0KCk7CiAgICAgIGluaXRfSW50ZXJ2YWwoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9QbGFuZSgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LnBhY2tlZExlbmd0aCA9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBNYXRyaXgzX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZhbHVlLmNlbnRlciwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIE1hdHJpeDNfZGVmYXVsdC5wYWNrKHZhbHVlLmhhbGZBeGVzLCBhcnJheSwgc3RhcnRpbmdJbmRleCArIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IE9yaWVudGVkQm91bmRpbmdCb3goKTsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgTWF0cml4M19kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCArIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgsCiAgICAgICAgICByZXN1bHQuaGFsZkF4ZXMKICAgICAgICApOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xNSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjI1ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMzYgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW40MiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW42ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ292YXJpYW5jZVJlc3VsdCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEVpZ2VuUmVzdWx0ID0gewogICAgICAgIHVuaXRhcnk6IG5ldyBNYXRyaXgzX2RlZmF1bHQoKSwKICAgICAgICBkaWFnb25hbDogbmV3IE1hdHJpeDNfZGVmYXVsdCgpCiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3guZnJvbVBvaW50cyA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IE9yaWVudGVkQm91bmRpbmdCb3goKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSB8fCBwb3NpdGlvbnMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICByZXN1bHQuaGFsZkF4ZXMgPSBNYXRyaXgzX2RlZmF1bHQuWkVSTzsKICAgICAgICAgIHJlc3VsdC5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTzsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGxldCBpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgY29uc3QgbWVhblBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHBvc2l0aW9uc1swXSwgc2NyYXRjaENhcnRlc2lhbjE1KTsKICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQobWVhblBvaW50LCBwb3NpdGlvbnNbaV0sIG1lYW5Qb2ludCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGludkxlbmd0aCA9IDEgLyBsZW5ndGg7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobWVhblBvaW50LCBpbnZMZW5ndGgsIG1lYW5Qb2ludCk7CiAgICAgICAgbGV0IGV4eCA9IDA7CiAgICAgICAgbGV0IGV4eSA9IDA7CiAgICAgICAgbGV0IGV4eiA9IDA7CiAgICAgICAgbGV0IGV5eSA9IDA7CiAgICAgICAgbGV0IGV5eiA9IDA7CiAgICAgICAgbGV0IGV6eiA9IDA7CiAgICAgICAgbGV0IHA7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBwID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHBvc2l0aW9uc1tpXSwgbWVhblBvaW50LCBzY3JhdGNoQ2FydGVzaWFuMjUpOwogICAgICAgICAgZXh4ICs9IHAueCAqIHAueDsKICAgICAgICAgIGV4eSArPSBwLnggKiBwLnk7CiAgICAgICAgICBleHogKz0gcC54ICogcC56OwogICAgICAgICAgZXl5ICs9IHAueSAqIHAueTsKICAgICAgICAgIGV5eiArPSBwLnkgKiBwLno7CiAgICAgICAgICBlenogKz0gcC56ICogcC56OwogICAgICAgIH0KICAgICAgICBleHggKj0gaW52TGVuZ3RoOwogICAgICAgIGV4eSAqPSBpbnZMZW5ndGg7CiAgICAgICAgZXh6ICo9IGludkxlbmd0aDsKICAgICAgICBleXkgKj0gaW52TGVuZ3RoOwogICAgICAgIGV5eiAqPSBpbnZMZW5ndGg7CiAgICAgICAgZXp6ICo9IGludkxlbmd0aDsKICAgICAgICBjb25zdCBjb3ZhcmlhbmNlTWF0cml4ID0gc2NyYXRjaENvdmFyaWFuY2VSZXN1bHQ7CiAgICAgICAgY292YXJpYW5jZU1hdHJpeFswXSA9IGV4eDsKICAgICAgICBjb3ZhcmlhbmNlTWF0cml4WzFdID0gZXh5OwogICAgICAgIGNvdmFyaWFuY2VNYXRyaXhbMl0gPSBleHo7CiAgICAgICAgY292YXJpYW5jZU1hdHJpeFszXSA9IGV4eTsKICAgICAgICBjb3ZhcmlhbmNlTWF0cml4WzRdID0gZXl5OwogICAgICAgIGNvdmFyaWFuY2VNYXRyaXhbNV0gPSBleXo7CiAgICAgICAgY292YXJpYW5jZU1hdHJpeFs2XSA9IGV4ejsKICAgICAgICBjb3ZhcmlhbmNlTWF0cml4WzddID0gZXl6OwogICAgICAgIGNvdmFyaWFuY2VNYXRyaXhbOF0gPSBleno7CiAgICAgICAgY29uc3QgZWlnZW5EZWNvbXBvc2l0aW9uID0gTWF0cml4M19kZWZhdWx0LmNvbXB1dGVFaWdlbkRlY29tcG9zaXRpb24oCiAgICAgICAgICBjb3ZhcmlhbmNlTWF0cml4LAogICAgICAgICAgc2NyYXRjaEVpZ2VuUmVzdWx0CiAgICAgICAgKTsKICAgICAgICBjb25zdCByb3RhdGlvbiA9IE1hdHJpeDNfZGVmYXVsdC5jbG9uZShlaWdlbkRlY29tcG9zaXRpb24udW5pdGFyeSwgcmVzdWx0LmhhbGZBeGVzKTsKICAgICAgICBsZXQgdjEyID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihyb3RhdGlvbiwgMCwgc2NyYXRjaENhcnRlc2lhbjQyKTsKICAgICAgICBsZXQgdjIyID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihyb3RhdGlvbiwgMSwgc2NyYXRjaENhcnRlc2lhbjUpOwogICAgICAgIGxldCB2MyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4ocm90YXRpb24sIDIsIHNjcmF0Y2hDYXJ0ZXNpYW42KTsKICAgICAgICBsZXQgdTEyID0gLU51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgbGV0IHUyMiA9IC1OdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGxldCB1MyA9IC1OdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGxldCBsMSA9IE51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgbGV0IGwyID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBsZXQgbDMgPSBOdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgcCA9IHBvc2l0aW9uc1tpXTsKICAgICAgICAgIHUxMiA9IE1hdGgubWF4KENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodjEyLCBwKSwgdTEyKTsKICAgICAgICAgIHUyMiA9IE1hdGgubWF4KENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodjIyLCBwKSwgdTIyKTsKICAgICAgICAgIHUzID0gTWF0aC5tYXgoQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh2MywgcCksIHUzKTsKICAgICAgICAgIGwxID0gTWF0aC5taW4oQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh2MTIsIHApLCBsMSk7CiAgICAgICAgICBsMiA9IE1hdGgubWluKENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodjIyLCBwKSwgbDIpOwogICAgICAgICAgbDMgPSBNYXRoLm1pbihDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHYzLCBwKSwgbDMpOwogICAgICAgIH0KICAgICAgICB2MTIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcih2MTIsIDAuNSAqIChsMSArIHUxMiksIHYxMik7CiAgICAgICAgdjIyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIodjIyLCAwLjUgKiAobDIgKyB1MjIpLCB2MjIpOwogICAgICAgIHYzID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIodjMsIDAuNSAqIChsMyArIHUzKSwgdjMpOwogICAgICAgIGNvbnN0IGNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQodjEyLCB2MjIsIHJlc3VsdC5jZW50ZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY2VudGVyLCB2MywgY2VudGVyKTsKICAgICAgICBjb25zdCBzY2FsZSA9IHNjcmF0Y2hDYXJ0ZXNpYW4zNjsKICAgICAgICBzY2FsZS54ID0gdTEyIC0gbDE7CiAgICAgICAgc2NhbGUueSA9IHUyMiAtIGwyOwogICAgICAgIHNjYWxlLnogPSB1MyAtIGwzOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHNjYWxlLCAwLjUsIHNjYWxlKTsKICAgICAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxlKHJlc3VsdC5oYWxmQXhlcywgc2NhbGUsIHJlc3VsdC5oYWxmQXhlcyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaE9mZnNldCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFNjYWxlMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFJlY3RhbmdsZUNlbnRlckNhcnRvZ3JhcGhpYyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUmVjdGFuZ2xlQ2VudGVyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljTkMgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY05XID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0b2dyYXBoaWNDVyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljU1cgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY1NDID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5OQyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhbk5XID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuQ1cgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5TVyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhblNDID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyaW1ldGVyUHJvamVjdGVkTkMgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWROVyA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlcmltZXRlclByb2plY3RlZENXID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyaW1ldGVyUHJvamVjdGVkU1cgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWRTQyA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBsYW5lT3JpZ2luID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGxhbmVOb3JtYWwgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQbGFuZVhBeGlzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoSG9yaXpvbkNhcnRlc2lhbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEhvcml6b25Qcm9qZWN0ZWQgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hNYXhZID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTWluWSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFogPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQbGFuZSA9IG5ldyBQbGFuZV9kZWZhdWx0KENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1gsIDApOwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LmZyb21SZWN0YW5nbGUgPSBmdW5jdGlvbihyZWN0YW5nbGUsIG1pbmltdW1IZWlnaHQsIG1heGltdW1IZWlnaHQsIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVjdGFuZ2xlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJlY3RhbmdsZSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAocmVjdGFuZ2xlLndpZHRoIDwgMCB8fCByZWN0YW5nbGUud2lkdGggPiBNYXRoX2RlZmF1bHQuVFdPX1BJKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiUmVjdGFuZ2xlIHdpZHRoIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAyICogcGkiKTsKICAgICAgICB9CiAgICAgICAgaWYgKHJlY3RhbmdsZS5oZWlnaHQgPCAwIHx8IHJlY3RhbmdsZS5oZWlnaHQgPiBNYXRoX2RlZmF1bHQuUEkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJSZWN0YW5nbGUgaGVpZ2h0IG11c3QgYmUgYmV0d2VlbiAwIGFuZCBwaSIpOwogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGVsbGlwc29pZCkgJiYgIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgZWxsaXBzb2lkLnJhZGlpLngsCiAgICAgICAgICBlbGxpcHNvaWQucmFkaWkueSwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTUKICAgICAgICApKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIkVsbGlwc29pZCBtdXN0IGJlIGFuIGVsbGlwc29pZCBvZiByZXZvbHV0aW9uIChyYWRpaS54ID09IHJhZGlpLnkpIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgbWluaW11bUhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG1pbmltdW1IZWlnaHQsIDApOwogICAgICAgIG1heGltdW1IZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChtYXhpbXVtSGVpZ2h0LCAwKTsKICAgICAgICBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgICAgICBsZXQgbWluWCwgbWF4WCwgbWluWSwgbWF4WSwgbWluWiwgbWF4WiwgcGxhbmU7CiAgICAgICAgaWYgKHJlY3RhbmdsZS53aWR0aCA8PSBNYXRoX2RlZmF1bHQuUEkpIHsKICAgICAgICAgIGNvbnN0IHRhbmdlbnRQb2ludENhcnRvZ3JhcGhpYyA9IFJlY3RhbmdsZV9kZWZhdWx0LmNlbnRlcigKICAgICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgICBzY3JhdGNoUmVjdGFuZ2xlQ2VudGVyQ2FydG9ncmFwaGljCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgdGFuZ2VudFBvaW50ID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgICAgICB0YW5nZW50UG9pbnRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICAgIHNjcmF0Y2hSZWN0YW5nbGVDZW50ZXIKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCB0YW5nZW50UGxhbmUgPSBuZXcgRWxsaXBzb2lkVGFuZ2VudFBsYW5lX2RlZmF1bHQodGFuZ2VudFBvaW50LCBlbGxpcHNvaWQpOwogICAgICAgICAgcGxhbmUgPSB0YW5nZW50UGxhbmUucGxhbmU7CiAgICAgICAgICBjb25zdCBsb25DZW50ZXIgPSB0YW5nZW50UG9pbnRDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlOwogICAgICAgICAgY29uc3QgbGF0Q2VudGVyID0gcmVjdGFuZ2xlLnNvdXRoIDwgMCAmJiByZWN0YW5nbGUubm9ydGggPiAwID8gMCA6IHRhbmdlbnRQb2ludENhcnRvZ3JhcGhpYy5sYXRpdHVkZTsKICAgICAgICAgIGNvbnN0IHBlcmltZXRlckNhcnRvZ3JhcGhpY05DID0gQ2FydG9ncmFwaGljX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgICAgICAgIGxvbkNlbnRlciwKICAgICAgICAgICAgcmVjdGFuZ2xlLm5vcnRoLAogICAgICAgICAgICBtYXhpbXVtSGVpZ2h0LAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljTkMKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNOVyA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICAgICAgICByZWN0YW5nbGUud2VzdCwKICAgICAgICAgICAgcmVjdGFuZ2xlLm5vcnRoLAogICAgICAgICAgICBtYXhpbXVtSGVpZ2h0LAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljTlcKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNDVyA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICAgICAgICByZWN0YW5nbGUud2VzdCwKICAgICAgICAgICAgbGF0Q2VudGVyLAogICAgICAgICAgICBtYXhpbXVtSGVpZ2h0LAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljQ1cKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNTVyA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICAgICAgICByZWN0YW5nbGUud2VzdCwKICAgICAgICAgICAgcmVjdGFuZ2xlLnNvdXRoLAogICAgICAgICAgICBtYXhpbXVtSGVpZ2h0LAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljU1cKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNTQyA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICAgICAgICBsb25DZW50ZXIsCiAgICAgICAgICAgIHJlY3RhbmdsZS5zb3V0aCwKICAgICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY1NDCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcGVyaW1ldGVyQ2FydGVzaWFuTkMgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgICAgIHBlcmltZXRlckNhcnRvZ3JhcGhpY05DLAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuTkMKICAgICAgICAgICk7CiAgICAgICAgICBsZXQgcGVyaW1ldGVyQ2FydGVzaWFuTlcgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgICAgIHBlcmltZXRlckNhcnRvZ3JhcGhpY05XLAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuTlcKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBwZXJpbWV0ZXJDYXJ0ZXNpYW5DVyA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICAgICAgcGVyaW1ldGVyQ2FydG9ncmFwaGljQ1csCiAgICAgICAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5DVwogICAgICAgICAgKTsKICAgICAgICAgIGxldCBwZXJpbWV0ZXJDYXJ0ZXNpYW5TVyA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICAgICAgcGVyaW1ldGVyQ2FydG9ncmFwaGljU1csCiAgICAgICAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5TVwogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHBlcmltZXRlckNhcnRlc2lhblNDID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgICAgICBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNTQywKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhblNDCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcGVyaW1ldGVyUHJvamVjdGVkTkMgPSB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50VG9OZWFyZXN0T25QbGFuZSgKICAgICAgICAgICAgcGVyaW1ldGVyQ2FydGVzaWFuTkMsCiAgICAgICAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWROQwogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHBlcmltZXRlclByb2plY3RlZE5XID0gdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludFRvTmVhcmVzdE9uUGxhbmUoCiAgICAgICAgICAgIHBlcmltZXRlckNhcnRlc2lhbk5XLAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyUHJvamVjdGVkTlcKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBwZXJpbWV0ZXJQcm9qZWN0ZWRDVyA9IHRhbmdlbnRQbGFuZS5wcm9qZWN0UG9pbnRUb05lYXJlc3RPblBsYW5lKAogICAgICAgICAgICBwZXJpbWV0ZXJDYXJ0ZXNpYW5DVywKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlclByb2plY3RlZENXCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcGVyaW1ldGVyUHJvamVjdGVkU1cgPSB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50VG9OZWFyZXN0T25QbGFuZSgKICAgICAgICAgICAgcGVyaW1ldGVyQ2FydGVzaWFuU1csCiAgICAgICAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWRTVwogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHBlcmltZXRlclByb2plY3RlZFNDID0gdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludFRvTmVhcmVzdE9uUGxhbmUoCiAgICAgICAgICAgIHBlcmltZXRlckNhcnRlc2lhblNDLAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyUHJvamVjdGVkU0MKICAgICAgICAgICk7CiAgICAgICAgICBtaW5YID0gTWF0aC5taW4oCiAgICAgICAgICAgIHBlcmltZXRlclByb2plY3RlZE5XLngsCiAgICAgICAgICAgIHBlcmltZXRlclByb2plY3RlZENXLngsCiAgICAgICAgICAgIHBlcmltZXRlclByb2plY3RlZFNXLngKICAgICAgICAgICk7CiAgICAgICAgICBtYXhYID0gLW1pblg7CiAgICAgICAgICBtYXhZID0gTWF0aC5tYXgocGVyaW1ldGVyUHJvamVjdGVkTlcueSwgcGVyaW1ldGVyUHJvamVjdGVkTkMueSk7CiAgICAgICAgICBtaW5ZID0gTWF0aC5taW4ocGVyaW1ldGVyUHJvamVjdGVkU1cueSwgcGVyaW1ldGVyUHJvamVjdGVkU0MueSk7CiAgICAgICAgICBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNOVy5oZWlnaHQgPSBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNTVy5oZWlnaHQgPSBtaW5pbXVtSGVpZ2h0OwogICAgICAgICAgcGVyaW1ldGVyQ2FydGVzaWFuTlcgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgICAgIHBlcmltZXRlckNhcnRvZ3JhcGhpY05XLAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuTlcKICAgICAgICAgICk7CiAgICAgICAgICBwZXJpbWV0ZXJDYXJ0ZXNpYW5TVyA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICAgICAgcGVyaW1ldGVyQ2FydG9ncmFwaGljU1csCiAgICAgICAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5TVwogICAgICAgICAgKTsKICAgICAgICAgIG1pblogPSBNYXRoLm1pbigKICAgICAgICAgICAgUGxhbmVfZGVmYXVsdC5nZXRQb2ludERpc3RhbmNlKHBsYW5lLCBwZXJpbWV0ZXJDYXJ0ZXNpYW5OVyksCiAgICAgICAgICAgIFBsYW5lX2RlZmF1bHQuZ2V0UG9pbnREaXN0YW5jZShwbGFuZSwgcGVyaW1ldGVyQ2FydGVzaWFuU1cpCiAgICAgICAgICApOwogICAgICAgICAgbWF4WiA9IG1heGltdW1IZWlnaHQ7CiAgICAgICAgICByZXR1cm4gZnJvbVBsYW5lRXh0ZW50cygKICAgICAgICAgICAgdGFuZ2VudFBsYW5lLm9yaWdpbiwKICAgICAgICAgICAgdGFuZ2VudFBsYW5lLnhBeGlzLAogICAgICAgICAgICB0YW5nZW50UGxhbmUueUF4aXMsCiAgICAgICAgICAgIHRhbmdlbnRQbGFuZS56QXhpcywKICAgICAgICAgICAgbWluWCwKICAgICAgICAgICAgbWF4WCwKICAgICAgICAgICAgbWluWSwKICAgICAgICAgICAgbWF4WSwKICAgICAgICAgICAgbWluWiwKICAgICAgICAgICAgbWF4WiwKICAgICAgICAgICAgcmVzdWx0CiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBmdWxseUFib3ZlRXF1YXRvciA9IHJlY3RhbmdsZS5zb3V0aCA+IDA7CiAgICAgICAgY29uc3QgZnVsbHlCZWxvd0VxdWF0b3IgPSByZWN0YW5nbGUubm9ydGggPCAwOwogICAgICAgIGNvbnN0IGxhdGl0dWRlTmVhcmVzdFRvRXF1YXRvciA9IGZ1bGx5QWJvdmVFcXVhdG9yID8gcmVjdGFuZ2xlLnNvdXRoIDogZnVsbHlCZWxvd0VxdWF0b3IgPyByZWN0YW5nbGUubm9ydGggOiAwOwogICAgICAgIGNvbnN0IGNlbnRlckxvbmdpdHVkZSA9IFJlY3RhbmdsZV9kZWZhdWx0LmNlbnRlcigKICAgICAgICAgIHJlY3RhbmdsZSwKICAgICAgICAgIHNjcmF0Y2hSZWN0YW5nbGVDZW50ZXJDYXJ0b2dyYXBoaWMKICAgICAgICApLmxvbmdpdHVkZTsKICAgICAgICBjb25zdCBwbGFuZU9yaWdpbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgIGNlbnRlckxvbmdpdHVkZSwKICAgICAgICAgIGxhdGl0dWRlTmVhcmVzdFRvRXF1YXRvciwKICAgICAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBzY3JhdGNoUGxhbmVPcmlnaW4KICAgICAgICApOwogICAgICAgIHBsYW5lT3JpZ2luLnogPSAwOwogICAgICAgIGNvbnN0IGlzUG9sZSA9IE1hdGguYWJzKHBsYW5lT3JpZ2luLngpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMCAmJiBNYXRoLmFicyhwbGFuZU9yaWdpbi55KSA8IE1hdGhfZGVmYXVsdC5FUFNJTE9OMTA7CiAgICAgICAgY29uc3QgcGxhbmVOb3JtYWwgPSAhaXNQb2xlID8gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShwbGFuZU9yaWdpbiwgc2NyYXRjaFBsYW5lTm9ybWFsKSA6IENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1g7CiAgICAgICAgY29uc3QgcGxhbmVZQXhpcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1o7CiAgICAgICAgY29uc3QgcGxhbmVYQXhpcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcygKICAgICAgICAgIHBsYW5lTm9ybWFsLAogICAgICAgICAgcGxhbmVZQXhpcywKICAgICAgICAgIHNjcmF0Y2hQbGFuZVhBeGlzCiAgICAgICAgKTsKICAgICAgICBwbGFuZSA9IFBsYW5lX2RlZmF1bHQuZnJvbVBvaW50Tm9ybWFsKHBsYW5lT3JpZ2luLCBwbGFuZU5vcm1hbCwgc2NyYXRjaFBsYW5lKTsKICAgICAgICBjb25zdCBob3Jpem9uQ2FydGVzaWFuID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICAgICAgY2VudGVyTG9uZ2l0dWRlICsgTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPLAogICAgICAgICAgbGF0aXR1ZGVOZWFyZXN0VG9FcXVhdG9yLAogICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHNjcmF0Y2hIb3Jpem9uQ2FydGVzaWFuCiAgICAgICAgKTsKICAgICAgICBtYXhYID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdCgKICAgICAgICAgIFBsYW5lX2RlZmF1bHQucHJvamVjdFBvaW50T250b1BsYW5lKAogICAgICAgICAgICBwbGFuZSwKICAgICAgICAgICAgaG9yaXpvbkNhcnRlc2lhbiwKICAgICAgICAgICAgc2NyYXRjaEhvcml6b25Qcm9qZWN0ZWQKICAgICAgICAgICksCiAgICAgICAgICBwbGFuZVhBeGlzCiAgICAgICAgKTsKICAgICAgICBtaW5YID0gLW1heFg7CiAgICAgICAgbWF4WSA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgIDAsCiAgICAgICAgICByZWN0YW5nbGUubm9ydGgsCiAgICAgICAgICBmdWxseUJlbG93RXF1YXRvciA/IG1pbmltdW1IZWlnaHQgOiBtYXhpbXVtSGVpZ2h0LAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgc2NyYXRjaE1heFkKICAgICAgICApLno7CiAgICAgICAgbWluWSA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgIDAsCiAgICAgICAgICByZWN0YW5nbGUuc291dGgsCiAgICAgICAgICBmdWxseUFib3ZlRXF1YXRvciA/IG1pbmltdW1IZWlnaHQgOiBtYXhpbXVtSGVpZ2h0LAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgc2NyYXRjaE1pblkKICAgICAgICApLno7CiAgICAgICAgY29uc3QgZmFyWiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgIHJlY3RhbmdsZS5lYXN0LAogICAgICAgICAgbGF0aXR1ZGVOZWFyZXN0VG9FcXVhdG9yLAogICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHNjcmF0Y2haCiAgICAgICAgKTsKICAgICAgICBtaW5aID0gUGxhbmVfZGVmYXVsdC5nZXRQb2ludERpc3RhbmNlKHBsYW5lLCBmYXJaKTsKICAgICAgICBtYXhaID0gMDsKICAgICAgICByZXR1cm4gZnJvbVBsYW5lRXh0ZW50cygKICAgICAgICAgIHBsYW5lT3JpZ2luLAogICAgICAgICAgcGxhbmVYQXhpcywKICAgICAgICAgIHBsYW5lWUF4aXMsCiAgICAgICAgICBwbGFuZU5vcm1hbCwKICAgICAgICAgIG1pblgsCiAgICAgICAgICBtYXhYLAogICAgICAgICAgbWluWSwKICAgICAgICAgIG1heFksCiAgICAgICAgICBtaW5aLAogICAgICAgICAgbWF4WiwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3guZnJvbVRyYW5zZm9ybWF0aW9uID0gZnVuY3Rpb24odHJhbnNmb3JtYXRpb24sIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidHJhbnNmb3JtYXRpb24iLCB0cmFuc2Zvcm1hdGlvbik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IE9yaWVudGVkQm91bmRpbmdCb3goKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmNlbnRlciA9IE1hdHJpeDRfZGVmYXVsdC5nZXRUcmFuc2xhdGlvbih0cmFuc2Zvcm1hdGlvbiwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgcmVzdWx0LmhhbGZBeGVzID0gTWF0cml4NF9kZWZhdWx0LmdldE1hdHJpeDModHJhbnNmb3JtYXRpb24sIHJlc3VsdC5oYWxmQXhlcyk7CiAgICAgICAgcmVzdWx0LmhhbGZBeGVzID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICByZXN1bHQuaGFsZkF4ZXMsCiAgICAgICAgICAwLjUsCiAgICAgICAgICByZXN1bHQuaGFsZkF4ZXMKICAgICAgICApOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3guY2xvbmUgPSBmdW5jdGlvbihib3gsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJveCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgT3JpZW50ZWRCb3VuZGluZ0JveChib3guY2VudGVyLCBib3guaGFsZkF4ZXMpOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoYm94LmNlbnRlciwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgTWF0cml4M19kZWZhdWx0LmNsb25lKGJveC5oYWxmQXhlcywgcmVzdWx0LmhhbGZBeGVzKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LmludGVyc2VjdFBsYW5lID0gZnVuY3Rpb24oYm94LCBwbGFuZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJveCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJib3ggaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBsYW5lKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInBsYW5lIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBjZW50ZXIgPSBib3guY2VudGVyOwogICAgICAgIGNvbnN0IG5vcm1hbDIgPSBwbGFuZS5ub3JtYWw7CiAgICAgICAgY29uc3QgaGFsZkF4ZXMgPSBib3guaGFsZkF4ZXM7CiAgICAgICAgY29uc3Qgbm9ybWFsWCA9IG5vcm1hbDIueCwgbm9ybWFsWSA9IG5vcm1hbDIueSwgbm9ybWFsWiA9IG5vcm1hbDIuejsKICAgICAgICBjb25zdCByYWRFZmZlY3RpdmUgPSBNYXRoLmFicygKICAgICAgICAgIG5vcm1hbFggKiBoYWxmQXhlc1tNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMFJPVzBdICsgbm9ybWFsWSAqIGhhbGZBeGVzW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4wUk9XMV0gKyBub3JtYWxaICogaGFsZkF4ZXNbTWF0cml4M19kZWZhdWx0LkNPTFVNTjBST1cyXQogICAgICAgICkgKyBNYXRoLmFicygKICAgICAgICAgIG5vcm1hbFggKiBoYWxmQXhlc1tNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMVJPVzBdICsgbm9ybWFsWSAqIGhhbGZBeGVzW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4xUk9XMV0gKyBub3JtYWxaICogaGFsZkF4ZXNbTWF0cml4M19kZWZhdWx0LkNPTFVNTjFST1cyXQogICAgICAgICkgKyBNYXRoLmFicygKICAgICAgICAgIG5vcm1hbFggKiBoYWxmQXhlc1tNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMlJPVzBdICsgbm9ybWFsWSAqIGhhbGZBeGVzW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4yUk9XMV0gKyBub3JtYWxaICogaGFsZkF4ZXNbTWF0cml4M19kZWZhdWx0LkNPTFVNTjJST1cyXQogICAgICAgICk7CiAgICAgICAgY29uc3QgZGlzdGFuY2VUb1BsYW5lID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChub3JtYWwyLCBjZW50ZXIpICsgcGxhbmUuZGlzdGFuY2U7CiAgICAgICAgaWYgKGRpc3RhbmNlVG9QbGFuZSA8PSAtcmFkRWZmZWN0aXZlKSB7CiAgICAgICAgICByZXR1cm4gSW50ZXJzZWN0X2RlZmF1bHQuT1VUU0lERTsKICAgICAgICB9IGVsc2UgaWYgKGRpc3RhbmNlVG9QbGFuZSA+PSByYWRFZmZlY3RpdmUpIHsKICAgICAgICAgIHJldHVybiBJbnRlcnNlY3RfZGVmYXVsdC5JTlNJREU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBJbnRlcnNlY3RfZGVmYXVsdC5JTlRFUlNFQ1RJTkc7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW5VID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuViA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhblcgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hWYWxpZEF4aXMyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVmFsaWRBeGlzMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBQcmltZSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5kaXN0YW5jZVNxdWFyZWRUbyA9IGZ1bmN0aW9uKGJveCwgY2FydGVzaWFuMTEpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChib3gpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYm94IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjYXJ0ZXNpYW4xMSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjYXJ0ZXNpYW4gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG9mZnNldCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjYXJ0ZXNpYW4xMSwgYm94LmNlbnRlciwgc2NyYXRjaE9mZnNldCk7CiAgICAgICAgY29uc3QgaGFsZkF4ZXMgPSBib3guaGFsZkF4ZXM7CiAgICAgICAgbGV0IHUzID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihoYWxmQXhlcywgMCwgc2NyYXRjaENhcnRlc2lhblUpOwogICAgICAgIGxldCB2MyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDEsIHNjcmF0Y2hDYXJ0ZXNpYW5WKTsKICAgICAgICBsZXQgdyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDIsIHNjcmF0Y2hDYXJ0ZXNpYW5XKTsKICAgICAgICBjb25zdCB1SGFsZiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUodTMpOwogICAgICAgIGNvbnN0IHZIYWxmID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSh2Myk7CiAgICAgICAgY29uc3Qgd0hhbGYgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKHcpOwogICAgICAgIGxldCB1VmFsaWQgPSB0cnVlOwogICAgICAgIGxldCB2VmFsaWQgPSB0cnVlOwogICAgICAgIGxldCB3VmFsaWQgPSB0cnVlOwogICAgICAgIGlmICh1SGFsZiA+IDApIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5kaXZpZGVCeVNjYWxhcih1MywgdUhhbGYsIHUzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdVZhbGlkID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmICh2SGFsZiA+IDApIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5kaXZpZGVCeVNjYWxhcih2MywgdkhhbGYsIHYzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdlZhbGlkID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmICh3SGFsZiA+IDApIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5kaXZpZGVCeVNjYWxhcih3LCB3SGFsZiwgdyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdWYWxpZCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBjb25zdCBudW1iZXJPZkRlZ2VuZXJhdGVBeGVzID0gIXVWYWxpZCArICF2VmFsaWQgKyAhd1ZhbGlkOwogICAgICAgIGxldCB2YWxpZEF4aXMxOwogICAgICAgIGxldCB2YWxpZEF4aXMyOwogICAgICAgIGxldCB2YWxpZEF4aXMzOwogICAgICAgIGlmIChudW1iZXJPZkRlZ2VuZXJhdGVBeGVzID09PSAxKSB7CiAgICAgICAgICBsZXQgZGVnZW5lcmF0ZUF4aXMgPSB1MzsKICAgICAgICAgIHZhbGlkQXhpczEgPSB2MzsKICAgICAgICAgIHZhbGlkQXhpczIgPSB3OwogICAgICAgICAgaWYgKCF2VmFsaWQpIHsKICAgICAgICAgICAgZGVnZW5lcmF0ZUF4aXMgPSB2MzsKICAgICAgICAgICAgdmFsaWRBeGlzMSA9IHUzOwogICAgICAgICAgfSBlbHNlIGlmICghd1ZhbGlkKSB7CiAgICAgICAgICAgIGRlZ2VuZXJhdGVBeGlzID0gdzsKICAgICAgICAgICAgdmFsaWRBeGlzMiA9IHUzOwogICAgICAgICAgfQogICAgICAgICAgdmFsaWRBeGlzMyA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyh2YWxpZEF4aXMxLCB2YWxpZEF4aXMyLCBzY3JhdGNoVmFsaWRBeGlzMyk7CiAgICAgICAgICBpZiAoZGVnZW5lcmF0ZUF4aXMgPT09IHUzKSB7CiAgICAgICAgICAgIHUzID0gdmFsaWRBeGlzMzsKICAgICAgICAgIH0gZWxzZSBpZiAoZGVnZW5lcmF0ZUF4aXMgPT09IHYzKSB7CiAgICAgICAgICAgIHYzID0gdmFsaWRBeGlzMzsKICAgICAgICAgIH0gZWxzZSBpZiAoZGVnZW5lcmF0ZUF4aXMgPT09IHcpIHsKICAgICAgICAgICAgdyA9IHZhbGlkQXhpczM7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChudW1iZXJPZkRlZ2VuZXJhdGVBeGVzID09PSAyKSB7CiAgICAgICAgICB2YWxpZEF4aXMxID0gdTM7CiAgICAgICAgICBpZiAodlZhbGlkKSB7CiAgICAgICAgICAgIHZhbGlkQXhpczEgPSB2MzsKICAgICAgICAgIH0gZWxzZSBpZiAod1ZhbGlkKSB7CiAgICAgICAgICAgIHZhbGlkQXhpczEgPSB3OwogICAgICAgICAgfQogICAgICAgICAgbGV0IGNyb3NzVmVjdG9yID0gQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWTsKICAgICAgICAgIGlmIChjcm9zc1ZlY3Rvci5lcXVhbHNFcHNpbG9uKHZhbGlkQXhpczEsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMykpIHsKICAgICAgICAgICAgY3Jvc3NWZWN0b3IgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YOwogICAgICAgICAgfQogICAgICAgICAgdmFsaWRBeGlzMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyh2YWxpZEF4aXMxLCBjcm9zc1ZlY3Rvciwgc2NyYXRjaFZhbGlkQXhpczIpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSh2YWxpZEF4aXMyLCB2YWxpZEF4aXMyKTsKICAgICAgICAgIHZhbGlkQXhpczMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3ModmFsaWRBeGlzMSwgdmFsaWRBeGlzMiwgc2NyYXRjaFZhbGlkQXhpczMpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSh2YWxpZEF4aXMzLCB2YWxpZEF4aXMzKTsKICAgICAgICAgIGlmICh2YWxpZEF4aXMxID09PSB1MykgewogICAgICAgICAgICB2MyA9IHZhbGlkQXhpczI7CiAgICAgICAgICAgIHcgPSB2YWxpZEF4aXMzOwogICAgICAgICAgfSBlbHNlIGlmICh2YWxpZEF4aXMxID09PSB2MykgewogICAgICAgICAgICB3ID0gdmFsaWRBeGlzMjsKICAgICAgICAgICAgdTMgPSB2YWxpZEF4aXMzOwogICAgICAgICAgfSBlbHNlIGlmICh2YWxpZEF4aXMxID09PSB3KSB7CiAgICAgICAgICAgIHUzID0gdmFsaWRBeGlzMjsKICAgICAgICAgICAgdjMgPSB2YWxpZEF4aXMzOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAobnVtYmVyT2ZEZWdlbmVyYXRlQXhlcyA9PT0gMykgewogICAgICAgICAgdTMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YOwogICAgICAgICAgdjMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9ZOwogICAgICAgICAgdyA9IENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1o7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBQcmltZSA9IHNjcmF0Y2hQUHJpbWU7CiAgICAgICAgcFByaW1lLnggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KG9mZnNldCwgdTMpOwogICAgICAgIHBQcmltZS55ID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChvZmZzZXQsIHYzKTsKICAgICAgICBwUHJpbWUueiA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3Qob2Zmc2V0LCB3KTsKICAgICAgICBsZXQgZGlzdGFuY2VTcXVhcmVkID0gMDsKICAgICAgICBsZXQgZDsKICAgICAgICBpZiAocFByaW1lLnggPCAtdUhhbGYpIHsKICAgICAgICAgIGQgPSBwUHJpbWUueCArIHVIYWxmOwogICAgICAgICAgZGlzdGFuY2VTcXVhcmVkICs9IGQgKiBkOwogICAgICAgIH0gZWxzZSBpZiAocFByaW1lLnggPiB1SGFsZikgewogICAgICAgICAgZCA9IHBQcmltZS54IC0gdUhhbGY7CiAgICAgICAgICBkaXN0YW5jZVNxdWFyZWQgKz0gZCAqIGQ7CiAgICAgICAgfQogICAgICAgIGlmIChwUHJpbWUueSA8IC12SGFsZikgewogICAgICAgICAgZCA9IHBQcmltZS55ICsgdkhhbGY7CiAgICAgICAgICBkaXN0YW5jZVNxdWFyZWQgKz0gZCAqIGQ7CiAgICAgICAgfSBlbHNlIGlmIChwUHJpbWUueSA+IHZIYWxmKSB7CiAgICAgICAgICBkID0gcFByaW1lLnkgLSB2SGFsZjsKICAgICAgICAgIGRpc3RhbmNlU3F1YXJlZCArPSBkICogZDsKICAgICAgICB9CiAgICAgICAgaWYgKHBQcmltZS56IDwgLXdIYWxmKSB7CiAgICAgICAgICBkID0gcFByaW1lLnogKyB3SGFsZjsKICAgICAgICAgIGRpc3RhbmNlU3F1YXJlZCArPSBkICogZDsKICAgICAgICB9IGVsc2UgaWYgKHBQcmltZS56ID4gd0hhbGYpIHsKICAgICAgICAgIGQgPSBwUHJpbWUueiAtIHdIYWxmOwogICAgICAgICAgZGlzdGFuY2VTcXVhcmVkICs9IGQgKiBkOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGlzdGFuY2VTcXVhcmVkOwogICAgICB9OwogICAgICBzY3JhdGNoQ29ybmVyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVG9DZW50ZXIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3guY29tcHV0ZVBsYW5lRGlzdGFuY2VzID0gZnVuY3Rpb24oYm94LCBwb3NpdGlvbiwgZGlyZWN0aW9uMiwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYm94KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImJveCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb24pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicG9zaXRpb24gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGRpcmVjdGlvbjIpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZGlyZWN0aW9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgSW50ZXJ2YWxfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBsZXQgbWluRGlzdCA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgICAgICBsZXQgbWF4RGlzdCA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgICAgICBjb25zdCBjZW50ZXIgPSBib3guY2VudGVyOwogICAgICAgIGNvbnN0IGhhbGZBeGVzID0gYm94LmhhbGZBeGVzOwogICAgICAgIGNvbnN0IHUzID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihoYWxmQXhlcywgMCwgc2NyYXRjaENhcnRlc2lhblUpOwogICAgICAgIGNvbnN0IHYzID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihoYWxmQXhlcywgMSwgc2NyYXRjaENhcnRlc2lhblYpOwogICAgICAgIGNvbnN0IHcgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAyLCBzY3JhdGNoQ2FydGVzaWFuVyk7CiAgICAgICAgY29uc3QgY29ybmVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCh1MywgdjMsIHNjcmF0Y2hDb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCB3LCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCBjZW50ZXIsIGNvcm5lcik7CiAgICAgICAgY29uc3QgdG9DZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCBwb3NpdGlvbiwgc2NyYXRjaFRvQ2VudGVyKTsKICAgICAgICBsZXQgbWFnID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChkaXJlY3Rpb24yLCB0b0NlbnRlcik7CiAgICAgICAgbWluRGlzdCA9IE1hdGgubWluKG1hZywgbWluRGlzdCk7CiAgICAgICAgbWF4RGlzdCA9IE1hdGgubWF4KG1hZywgbWF4RGlzdCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChjZW50ZXIsIHUzLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCB2MywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCB3LCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHBvc2l0aW9uLCB0b0NlbnRlcik7CiAgICAgICAgbWFnID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChkaXJlY3Rpb24yLCB0b0NlbnRlcik7CiAgICAgICAgbWluRGlzdCA9IE1hdGgubWluKG1hZywgbWluRGlzdCk7CiAgICAgICAgbWF4RGlzdCA9IE1hdGgubWF4KG1hZywgbWF4RGlzdCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChjZW50ZXIsIHUzLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHYzLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCB3LCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHBvc2l0aW9uLCB0b0NlbnRlcik7CiAgICAgICAgbWFnID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChkaXJlY3Rpb24yLCB0b0NlbnRlcik7CiAgICAgICAgbWluRGlzdCA9IE1hdGgubWluKG1hZywgbWluRGlzdCk7CiAgICAgICAgbWF4RGlzdCA9IE1hdGgubWF4KG1hZywgbWF4RGlzdCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChjZW50ZXIsIHUzLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHYzLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHcsIGNvcm5lcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNvcm5lciwgcG9zaXRpb24sIHRvQ2VudGVyKTsKICAgICAgICBtYWcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjIsIHRvQ2VudGVyKTsKICAgICAgICBtaW5EaXN0ID0gTWF0aC5taW4obWFnLCBtaW5EaXN0KTsKICAgICAgICBtYXhEaXN0ID0gTWF0aC5tYXgobWFnLCBtYXhEaXN0KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY2VudGVyLCB1MywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgdjMsIGNvcm5lcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChjb3JuZXIsIHcsIGNvcm5lcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNvcm5lciwgcG9zaXRpb24sIHRvQ2VudGVyKTsKICAgICAgICBtYWcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjIsIHRvQ2VudGVyKTsKICAgICAgICBtaW5EaXN0ID0gTWF0aC5taW4obWFnLCBtaW5EaXN0KTsKICAgICAgICBtYXhEaXN0ID0gTWF0aC5tYXgobWFnLCBtYXhEaXN0KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY2VudGVyLCB1MywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgdjMsIGNvcm5lcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNvcm5lciwgdywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCBwb3NpdGlvbiwgdG9DZW50ZXIpOwogICAgICAgIG1hZyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgdG9DZW50ZXIpOwogICAgICAgIG1pbkRpc3QgPSBNYXRoLm1pbihtYWcsIG1pbkRpc3QpOwogICAgICAgIG1heERpc3QgPSBNYXRoLm1heChtYWcsIG1heERpc3QpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjZW50ZXIsIHUzLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHYzLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCB3LCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHBvc2l0aW9uLCB0b0NlbnRlcik7CiAgICAgICAgbWFnID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChkaXJlY3Rpb24yLCB0b0NlbnRlcik7CiAgICAgICAgbWluRGlzdCA9IE1hdGgubWluKG1hZywgbWluRGlzdCk7CiAgICAgICAgbWF4RGlzdCA9IE1hdGgubWF4KG1hZywgbWF4RGlzdCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNlbnRlciwgdTMsIGNvcm5lcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNvcm5lciwgdjMsIGNvcm5lcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNvcm5lciwgdywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCBwb3NpdGlvbiwgdG9DZW50ZXIpOwogICAgICAgIG1hZyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgdG9DZW50ZXIpOwogICAgICAgIG1pbkRpc3QgPSBNYXRoLm1pbihtYWcsIG1pbkRpc3QpOwogICAgICAgIG1heERpc3QgPSBNYXRoLm1heChtYWcsIG1heERpc3QpOwogICAgICAgIHJlc3VsdC5zdGFydCA9IG1pbkRpc3Q7CiAgICAgICAgcmVzdWx0LnN0b3AgPSBtYXhEaXN0OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hYQXhpcyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFlBeGlzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoWkF4aXMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3guY29tcHV0ZUNvcm5lcnMgPSBmdW5jdGlvbihib3gsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiYm94IiwgYm94KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBbCiAgICAgICAgICAgIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICAgICAgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgICAgICBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgICAgIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICAgICAgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgICAgICBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgICAgIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICAgICAgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpCiAgICAgICAgICBdOwogICAgICAgIH0KICAgICAgICBjb25zdCBjZW50ZXIgPSBib3guY2VudGVyOwogICAgICAgIGNvbnN0IGhhbGZBeGVzID0gYm94LmhhbGZBeGVzOwogICAgICAgIGNvbnN0IHhBeGlzID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihoYWxmQXhlcywgMCwgc2NyYXRjaFhBeGlzKTsKICAgICAgICBjb25zdCB5QXhpcyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDEsIHNjcmF0Y2hZQXhpcyk7CiAgICAgICAgY29uc3QgekF4aXMgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAyLCBzY3JhdGNoWkF4aXMpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjZW50ZXIsIHJlc3VsdFswXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHJlc3VsdFswXSwgeEF4aXMsIHJlc3VsdFswXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHJlc3VsdFswXSwgeUF4aXMsIHJlc3VsdFswXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHJlc3VsdFswXSwgekF4aXMsIHJlc3VsdFswXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlciwgcmVzdWx0WzFdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocmVzdWx0WzFdLCB4QXhpcywgcmVzdWx0WzFdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocmVzdWx0WzFdLCB5QXhpcywgcmVzdWx0WzFdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJlc3VsdFsxXSwgekF4aXMsIHJlc3VsdFsxXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlciwgcmVzdWx0WzJdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocmVzdWx0WzJdLCB4QXhpcywgcmVzdWx0WzJdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJlc3VsdFsyXSwgeUF4aXMsIHJlc3VsdFsyXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHJlc3VsdFsyXSwgekF4aXMsIHJlc3VsdFsyXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlciwgcmVzdWx0WzNdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocmVzdWx0WzNdLCB4QXhpcywgcmVzdWx0WzNdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJlc3VsdFszXSwgeUF4aXMsIHJlc3VsdFszXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyZXN1bHRbM10sIHpBeGlzLCByZXN1bHRbM10pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjZW50ZXIsIHJlc3VsdFs0XSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyZXN1bHRbNF0sIHhBeGlzLCByZXN1bHRbNF0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChyZXN1bHRbNF0sIHlBeGlzLCByZXN1bHRbNF0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChyZXN1bHRbNF0sIHpBeGlzLCByZXN1bHRbNF0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjZW50ZXIsIHJlc3VsdFs1XSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyZXN1bHRbNV0sIHhBeGlzLCByZXN1bHRbNV0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChyZXN1bHRbNV0sIHlBeGlzLCByZXN1bHRbNV0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmVzdWx0WzVdLCB6QXhpcywgcmVzdWx0WzVdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY2VudGVyLCByZXN1bHRbNl0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmVzdWx0WzZdLCB4QXhpcywgcmVzdWx0WzZdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJlc3VsdFs2XSwgeUF4aXMsIHJlc3VsdFs2XSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHJlc3VsdFs2XSwgekF4aXMsIHJlc3VsdFs2XSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlciwgcmVzdWx0WzddKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJlc3VsdFs3XSwgeEF4aXMsIHJlc3VsdFs3XSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyZXN1bHRbN10sIHlBeGlzLCByZXN1bHRbN10pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmVzdWx0WzddLCB6QXhpcywgcmVzdWx0WzddKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoUm90YXRpb25TY2FsZSA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5jb21wdXRlVHJhbnNmb3JtYXRpb24gPSBmdW5jdGlvbihib3gsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiYm94IiwgYm94KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHRyYW5zbGF0aW9uMiA9IGJveC5jZW50ZXI7CiAgICAgICAgY29uc3Qgcm90YXRpb25TY2FsZSA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VW5pZm9ybVNjYWxlKAogICAgICAgICAgYm94LmhhbGZBeGVzLAogICAgICAgICAgMiwKICAgICAgICAgIHNjcmF0Y2hSb3RhdGlvblNjYWxlCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gTWF0cml4NF9kZWZhdWx0LmZyb21Sb3RhdGlvblRyYW5zbGF0aW9uKHJvdGF0aW9uU2NhbGUsIHRyYW5zbGF0aW9uMiwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgc2NyYXRjaEJvdW5kaW5nU3BoZXJlID0gbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoKTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5pc09jY2x1ZGVkID0gZnVuY3Rpb24oYm94LCBvY2NsdWRlcikgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJveCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJib3ggaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG9jY2x1ZGVyKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9jY2x1ZGVyIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBzcGhlcmUgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21PcmllbnRlZEJvdW5kaW5nQm94KAogICAgICAgICAgYm94LAogICAgICAgICAgc2NyYXRjaEJvdW5kaW5nU3BoZXJlCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gIW9jY2x1ZGVyLmlzQm91bmRpbmdTcGhlcmVWaXNpYmxlKHNwaGVyZSk7CiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3gucHJvdG90eXBlLmludGVyc2VjdFBsYW5lID0gZnVuY3Rpb24ocGxhbmUpIHsKICAgICAgICByZXR1cm4gT3JpZW50ZWRCb3VuZGluZ0JveC5pbnRlcnNlY3RQbGFuZSh0aGlzLCBwbGFuZSk7CiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3gucHJvdG90eXBlLmRpc3RhbmNlU3F1YXJlZFRvID0gZnVuY3Rpb24oY2FydGVzaWFuMTEpIHsKICAgICAgICByZXR1cm4gT3JpZW50ZWRCb3VuZGluZ0JveC5kaXN0YW5jZVNxdWFyZWRUbyh0aGlzLCBjYXJ0ZXNpYW4xMSk7CiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3gucHJvdG90eXBlLmNvbXB1dGVQbGFuZURpc3RhbmNlcyA9IGZ1bmN0aW9uKHBvc2l0aW9uLCBkaXJlY3Rpb24yLCByZXN1bHQpIHsKICAgICAgICByZXR1cm4gT3JpZW50ZWRCb3VuZGluZ0JveC5jb21wdXRlUGxhbmVEaXN0YW5jZXMoCiAgICAgICAgICB0aGlzLAogICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICBkaXJlY3Rpb24yLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5wcm90b3R5cGUuY29tcHV0ZUNvcm5lcnMgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICByZXR1cm4gT3JpZW50ZWRCb3VuZGluZ0JveC5jb21wdXRlQ29ybmVycyh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LnByb3RvdHlwZS5jb21wdXRlVHJhbnNmb3JtYXRpb24gPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICByZXR1cm4gT3JpZW50ZWRCb3VuZGluZ0JveC5jb21wdXRlVHJhbnNmb3JtYXRpb24odGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5wcm90b3R5cGUuaXNPY2NsdWRlZCA9IGZ1bmN0aW9uKG9jY2x1ZGVyKSB7CiAgICAgICAgcmV0dXJuIE9yaWVudGVkQm91bmRpbmdCb3guaXNPY2NsdWRlZCh0aGlzLCBvY2NsdWRlcik7CiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3guZXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhsZWZ0LmNlbnRlciwgcmlnaHQuY2VudGVyKSAmJiBNYXRyaXgzX2RlZmF1bHQuZXF1YWxzKGxlZnQuaGFsZkF4ZXMsIHJpZ2h0LmhhbGZBeGVzKTsKICAgICAgfTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICByZXR1cm4gT3JpZW50ZWRCb3VuZGluZ0JveC5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiBPcmllbnRlZEJvdW5kaW5nQm94LmVxdWFscyh0aGlzLCByaWdodCk7CiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3hfZGVmYXVsdCA9IE9yaWVudGVkQm91bmRpbmdCb3g7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnkuanMKICBmdW5jdGlvbiBwcm9qZWN0VG8yRChwb3NpdGlvbiwgY2VudGVyLCBheGlzMSwgYXhpczIsIHJlc3VsdCkgewogICAgY29uc3QgdjMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocG9zaXRpb24sIGNlbnRlciwgc2NyYXRjaEludGVyc2VjdGlvblBvaW50KTsKICAgIGNvbnN0IHggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGF4aXMxLCB2Myk7CiAgICBjb25zdCB5ID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChheGlzMiwgdjMpOwogICAgcmV0dXJuIENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tRWxlbWVudHMoeCwgeSwgcmVzdWx0KTsKICB9CiAgdmFyIENvcGxhbmFyUG9seWdvbkdlb21ldHJ5TGlicmFyeSwgc2NyYXRjaEludGVyc2VjdGlvblBvaW50LCBzY3JhdGNoWEF4aXMyLCBzY3JhdGNoWUF4aXMyLCBzY3JhdGNoWkF4aXMyLCBvYmJTY3JhdGNoLCBDb3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdDsKICB2YXIgaW5pdF9Db3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NvcGxhbmFyUG9seWdvbkdlb21ldHJ5TGlicmFyeS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9PcmllbnRlZEJvdW5kaW5nQm94KCk7CiAgICAgIENvcGxhbmFyUG9seWdvbkdlb21ldHJ5TGlicmFyeSA9IHt9OwogICAgICBzY3JhdGNoSW50ZXJzZWN0aW9uUG9pbnQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hYQXhpczIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hZQXhpczIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2haQXhpczIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIG9iYlNjcmF0Y2ggPSBuZXcgT3JpZW50ZWRCb3VuZGluZ0JveF9kZWZhdWx0KCk7CiAgICAgIENvcGxhbmFyUG9seWdvbkdlb21ldHJ5TGlicmFyeS52YWxpZE91dGxpbmUgPSBmdW5jdGlvbihwb3NpdGlvbnMpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInBvc2l0aW9ucyIsIHBvc2l0aW9ucyk7CiAgICAgICAgY29uc3Qgb3JpZW50ZWRCb3VuZGluZ0JveCA9IE9yaWVudGVkQm91bmRpbmdCb3hfZGVmYXVsdC5mcm9tUG9pbnRzKAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgb2JiU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3QgaGFsZkF4ZXMgPSBvcmllbnRlZEJvdW5kaW5nQm94LmhhbGZBeGVzOwogICAgICAgIGNvbnN0IHhBeGlzID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihoYWxmQXhlcywgMCwgc2NyYXRjaFhBeGlzMik7CiAgICAgICAgY29uc3QgeUF4aXMgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAxLCBzY3JhdGNoWUF4aXMyKTsKICAgICAgICBjb25zdCB6QXhpcyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDIsIHNjcmF0Y2haQXhpczIpOwogICAgICAgIGNvbnN0IHhNYWcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKHhBeGlzKTsKICAgICAgICBjb25zdCB5TWFnID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSh5QXhpcyk7CiAgICAgICAgY29uc3Qgek1hZyA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoekF4aXMpOwogICAgICAgIHJldHVybiAhKHhNYWcgPT09IDAgJiYgKHlNYWcgPT09IDAgfHwgek1hZyA9PT0gMCkgfHwgeU1hZyA9PT0gMCAmJiB6TWFnID09PSAwKTsKICAgICAgfTsKICAgICAgQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LmNvbXB1dGVQcm9qZWN0VG8yREFyZ3VtZW50cyA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgY2VudGVyUmVzdWx0LCBwbGFuZUF4aXMxUmVzdWx0LCBwbGFuZUF4aXMyUmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJwb3NpdGlvbnMiLCBwb3NpdGlvbnMpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2VudGVyUmVzdWx0IiwgY2VudGVyUmVzdWx0KTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInBsYW5lQXhpczFSZXN1bHQiLCBwbGFuZUF4aXMxUmVzdWx0KTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInBsYW5lQXhpczJSZXN1bHQiLCBwbGFuZUF4aXMyUmVzdWx0KTsKICAgICAgICBjb25zdCBvcmllbnRlZEJvdW5kaW5nQm94ID0gT3JpZW50ZWRCb3VuZGluZ0JveF9kZWZhdWx0LmZyb21Qb2ludHMoCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBvYmJTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBoYWxmQXhlcyA9IG9yaWVudGVkQm91bmRpbmdCb3guaGFsZkF4ZXM7CiAgICAgICAgY29uc3QgeEF4aXMgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAwLCBzY3JhdGNoWEF4aXMyKTsKICAgICAgICBjb25zdCB5QXhpcyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDEsIHNjcmF0Y2hZQXhpczIpOwogICAgICAgIGNvbnN0IHpBeGlzID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihoYWxmQXhlcywgMiwgc2NyYXRjaFpBeGlzMik7CiAgICAgICAgY29uc3QgeE1hZyA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoeEF4aXMpOwogICAgICAgIGNvbnN0IHlNYWcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKHlBeGlzKTsKICAgICAgICBjb25zdCB6TWFnID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSh6QXhpcyk7CiAgICAgICAgY29uc3QgbWluMyA9IE1hdGgubWluKHhNYWcsIHlNYWcsIHpNYWcpOwogICAgICAgIGlmICh4TWFnID09PSAwICYmICh5TWFnID09PSAwIHx8IHpNYWcgPT09IDApIHx8IHlNYWcgPT09IDAgJiYgek1hZyA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBsZXQgcGxhbmVBeGlzMTsKICAgICAgICBsZXQgcGxhbmVBeGlzMjsKICAgICAgICBpZiAobWluMyA9PT0geU1hZyB8fCBtaW4zID09PSB6TWFnKSB7CiAgICAgICAgICBwbGFuZUF4aXMxID0geEF4aXM7CiAgICAgICAgfQogICAgICAgIGlmIChtaW4zID09PSB4TWFnKSB7CiAgICAgICAgICBwbGFuZUF4aXMxID0geUF4aXM7CiAgICAgICAgfSBlbHNlIGlmIChtaW4zID09PSB6TWFnKSB7CiAgICAgICAgICBwbGFuZUF4aXMyID0geUF4aXM7CiAgICAgICAgfQogICAgICAgIGlmIChtaW4zID09PSB4TWFnIHx8IG1pbjMgPT09IHlNYWcpIHsKICAgICAgICAgIHBsYW5lQXhpczIgPSB6QXhpczsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShwbGFuZUF4aXMxLCBwbGFuZUF4aXMxUmVzdWx0KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHBsYW5lQXhpczIsIHBsYW5lQXhpczJSZXN1bHQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShvcmllbnRlZEJvdW5kaW5nQm94LmNlbnRlciwgY2VudGVyUmVzdWx0KTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfTsKICAgICAgQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LmNyZWF0ZVByb2plY3RQb2ludHNUbzJERnVuY3Rpb24gPSBmdW5jdGlvbihjZW50ZXIsIGF4aXMxLCBheGlzMikgewogICAgICAgIHJldHVybiBmdW5jdGlvbihwb3NpdGlvbnMpIHsKICAgICAgICAgIGNvbnN0IHBvc2l0aW9uUmVzdWx0cyA9IG5ldyBBcnJheShwb3NpdGlvbnMubGVuZ3RoKTsKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHBvc2l0aW9uUmVzdWx0c1tpXSA9IHByb2plY3RUbzJEKHBvc2l0aW9uc1tpXSwgY2VudGVyLCBheGlzMSwgYXhpczIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHBvc2l0aW9uUmVzdWx0czsKICAgICAgICB9OwogICAgICB9OwogICAgICBDb3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnkuY3JlYXRlUHJvamVjdFBvaW50VG8yREZ1bmN0aW9uID0gZnVuY3Rpb24oY2VudGVyLCBheGlzMSwgYXhpczIpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24ocG9zaXRpb24sIHJlc3VsdCkgewogICAgICAgICAgcmV0dXJuIHByb2plY3RUbzJEKHBvc2l0aW9uLCBjZW50ZXIsIGF4aXMxLCBheGlzMiwgcmVzdWx0KTsKICAgICAgICB9OwogICAgICB9OwogICAgICBDb3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdCA9IENvcGxhbmFyUG9seWdvbkdlb21ldHJ5TGlicmFyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0FyY1R5cGUuanMKICB2YXIgQXJjVHlwZSwgQXJjVHlwZV9kZWZhdWx0OwogIHZhciBpbml0X0FyY1R5cGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0FyY1R5cGUuanMiKCkgewogICAgICBBcmNUeXBlID0gewogICAgICAgIC8qKgogICAgICAgICAqIFN0cmFpZ2h0IGxpbmUgdGhhdCBkb2VzIG5vdCBjb25mb3JtIHRvIHRoZSBzdXJmYWNlIG9mIHRoZSBlbGxpcHNvaWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIE5PTkU6IDAsCiAgICAgICAgLyoqCiAgICAgICAgICogRm9sbG93IGdlb2Rlc2ljIHBhdGguCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIEdFT0RFU0lDOiAxLAogICAgICAgIC8qKgogICAgICAgICAqIEZvbGxvdyByaHVtYiBvciBsb3hvZHJvbWUgcGF0aC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUkhVTUI6IDIKICAgICAgfTsKICAgICAgQXJjVHlwZV9kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShBcmNUeXBlKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc29pZFJodW1iTGluZS5qcwogIGZ1bmN0aW9uIGNhbGN1bGF0ZU0oZWxsaXB0aWNpdHksIG1ham9yLCBsYXRpdHVkZSkgewogICAgaWYgKGVsbGlwdGljaXR5ID09PSAwKSB7CiAgICAgIHJldHVybiBtYWpvciAqIGxhdGl0dWRlOwogICAgfQogICAgY29uc3QgZTIgPSBlbGxpcHRpY2l0eSAqIGVsbGlwdGljaXR5OwogICAgY29uc3QgZTQgPSBlMiAqIGUyOwogICAgY29uc3QgZTYgPSBlNCAqIGUyOwogICAgY29uc3QgZTggPSBlNiAqIGUyOwogICAgY29uc3QgZTEwID0gZTggKiBlMjsKICAgIGNvbnN0IGUxMiA9IGUxMCAqIGUyOwogICAgY29uc3QgcGhpID0gbGF0aXR1ZGU7CiAgICBjb25zdCBzaW4yUGhpID0gTWF0aC5zaW4oMiAqIHBoaSk7CiAgICBjb25zdCBzaW40UGhpID0gTWF0aC5zaW4oNCAqIHBoaSk7CiAgICBjb25zdCBzaW42UGhpID0gTWF0aC5zaW4oNiAqIHBoaSk7CiAgICBjb25zdCBzaW44UGhpID0gTWF0aC5zaW4oOCAqIHBoaSk7CiAgICBjb25zdCBzaW4xMFBoaSA9IE1hdGguc2luKDEwICogcGhpKTsKICAgIGNvbnN0IHNpbjEyUGhpID0gTWF0aC5zaW4oMTIgKiBwaGkpOwogICAgcmV0dXJuIG1ham9yICogKCgxIC0gZTIgLyA0IC0gMyAqIGU0IC8gNjQgLSA1ICogZTYgLyAyNTYgLSAxNzUgKiBlOCAvIDE2Mzg0IC0gNDQxICogZTEwIC8gNjU1MzYgLSA0ODUxICogZTEyIC8gMTA0ODU3NikgKiBwaGkgLSAoMyAqIGUyIC8gOCArIDMgKiBlNCAvIDMyICsgNDUgKiBlNiAvIDEwMjQgKyAxMDUgKiBlOCAvIDQwOTYgKyAyMjA1ICogZTEwIC8gMTMxMDcyICsgNjIzNyAqIGUxMiAvIDUyNDI4OCkgKiBzaW4yUGhpICsgKDE1ICogZTQgLyAyNTYgKyA0NSAqIGU2IC8gMTAyNCArIDUyNSAqIGU4IC8gMTYzODQgKyAxNTc1ICogZTEwIC8gNjU1MzYgKyAxNTU5MjUgKiBlMTIgLyA4Mzg4NjA4KSAqIHNpbjRQaGkgLSAoMzUgKiBlNiAvIDMwNzIgKyAxNzUgKiBlOCAvIDEyMjg4ICsgMzY3NSAqIGUxMCAvIDI2MjE0NCArIDEzNDc1ICogZTEyIC8gMTA0ODU3NikgKiBzaW42UGhpICsgKDMxNSAqIGU4IC8gMTMxMDcyICsgMjIwNSAqIGUxMCAvIDUyNDI4OCArIDQzNjU5ICogZTEyIC8gODM4ODYwOCkgKiBzaW44UGhpIC0gKDY5MyAqIGUxMCAvIDEzMTA3MjAgKyA2MjM3ICogZTEyIC8gNTI0Mjg4MCkgKiBzaW4xMFBoaSArIDEwMDEgKiBlMTIgLyA4Mzg4NjA4ICogc2luMTJQaGkpOwogIH0KICBmdW5jdGlvbiBjYWxjdWxhdGVJbnZlcnNlTShNLCBlbGxpcHRpY2l0eSwgbWFqb3IpIHsKICAgIGNvbnN0IGQgPSBNIC8gbWFqb3I7CiAgICBpZiAoZWxsaXB0aWNpdHkgPT09IDApIHsKICAgICAgcmV0dXJuIGQ7CiAgICB9CiAgICBjb25zdCBkMiA9IGQgKiBkOwogICAgY29uc3QgZDMgPSBkMiAqIGQ7CiAgICBjb25zdCBkNCA9IGQzICogZDsKICAgIGNvbnN0IGUgPSBlbGxpcHRpY2l0eTsKICAgIGNvbnN0IGUyID0gZSAqIGU7CiAgICBjb25zdCBlNCA9IGUyICogZTI7CiAgICBjb25zdCBlNiA9IGU0ICogZTI7CiAgICBjb25zdCBlOCA9IGU2ICogZTI7CiAgICBjb25zdCBlMTAgPSBlOCAqIGUyOwogICAgY29uc3QgZTEyID0gZTEwICogZTI7CiAgICBjb25zdCBzaW4yRCA9IE1hdGguc2luKDIgKiBkKTsKICAgIGNvbnN0IGNvczJEID0gTWF0aC5jb3MoMiAqIGQpOwogICAgY29uc3Qgc2luNEQgPSBNYXRoLnNpbig0ICogZCk7CiAgICBjb25zdCBjb3M0RCA9IE1hdGguY29zKDQgKiBkKTsKICAgIGNvbnN0IHNpbjZEID0gTWF0aC5zaW4oNiAqIGQpOwogICAgY29uc3QgY29zNkQgPSBNYXRoLmNvcyg2ICogZCk7CiAgICBjb25zdCBzaW44RCA9IE1hdGguc2luKDggKiBkKTsKICAgIGNvbnN0IGNvczhEID0gTWF0aC5jb3MoOCAqIGQpOwogICAgY29uc3Qgc2luMTBEID0gTWF0aC5zaW4oMTAgKiBkKTsKICAgIGNvbnN0IGNvczEwRCA9IE1hdGguY29zKDEwICogZCk7CiAgICBjb25zdCBzaW4xMkQgPSBNYXRoLnNpbigxMiAqIGQpOwogICAgcmV0dXJuIGQgKyBkICogZTIgLyA0ICsgNyAqIGQgKiBlNCAvIDY0ICsgMTUgKiBkICogZTYgLyAyNTYgKyA1NzkgKiBkICogZTggLyAxNjM4NCArIDE1MTUgKiBkICogZTEwIC8gNjU1MzYgKyAxNjgzNyAqIGQgKiBlMTIgLyAxMDQ4NTc2ICsgKDMgKiBkICogZTQgLyAxNiArIDQ1ICogZCAqIGU2IC8gMjU2IC0gZCAqICgzMiAqIGQyIC0gNTYxKSAqIGU4IC8gNDA5NiAtIGQgKiAoMjMyICogZDIgLSAxNjc3KSAqIGUxMCAvIDE2Mzg0ICsgZCAqICgzOTk5ODUgLSA5MDU2MCAqIGQyICsgNTEyICogZDQpICogZTEyIC8gNTI0Mjg4MCkgKiBjb3MyRCArICgyMSAqIGQgKiBlNiAvIDI1NiArIDQ4MyAqIGQgKiBlOCAvIDQwOTYgLSBkICogKDIyNCAqIGQyIC0gMTk2OSkgKiBlMTAgLyAxNjM4NCAtIGQgKiAoMzMxNTIgKiBkMiAtIDExMjU5OSkgKiBlMTIgLyAxMDQ4NTc2KSAqIGNvczREICsgKDE1MSAqIGQgKiBlOCAvIDQwOTYgKyA0NjgxICogZCAqIGUxMCAvIDY1NTM2ICsgMTQ3OSAqIGQgKiBlMTIgLyAxNjM4NCAtIDQ1MyAqIGQzICogZTEyIC8gMzI3NjgpICogY29zNkQgKyAoMTA5NyAqIGQgKiBlMTAgLyA2NTUzNiArIDQyNzgzICogZCAqIGUxMiAvIDEwNDg1NzYpICogY29zOEQgKyA4MDExICogZCAqIGUxMiAvIDEwNDg1NzYgKiBjb3MxMEQgKyAoMyAqIGUyIC8gOCArIDMgKiBlNCAvIDE2ICsgMjEzICogZTYgLyAyMDQ4IC0gMyAqIGQyICogZTYgLyA2NCArIDI1NSAqIGU4IC8gNDA5NiAtIDMzICogZDIgKiBlOCAvIDUxMiArIDIwODYxICogZTEwIC8gNTI0Mjg4IC0gMzMgKiBkMiAqIGUxMCAvIDUxMiArIGQ0ICogZTEwIC8gMTAyNCArIDI4MjczICogZTEyIC8gMTA0ODU3NiAtIDQ3MSAqIGQyICogZTEyIC8gODE5MiArIDkgKiBkNCAqIGUxMiAvIDQwOTYpICogc2luMkQgKyAoMjEgKiBlNCAvIDI1NiArIDIxICogZTYgLyAyNTYgKyA1MzMgKiBlOCAvIDgxOTIgLSAyMSAqIGQyICogZTggLyA1MTIgKyAxOTcgKiBlMTAgLyA0MDk2IC0gMzE1ICogZDIgKiBlMTAgLyA0MDk2ICsgNTg0MDM5ICogZTEyIC8gMTY3NzcyMTYgLSAxMjUxNyAqIGQyICogZTEyIC8gMTMxMDcyICsgNyAqIGQ0ICogZTEyIC8gMjA0OCkgKiBzaW40RCArICgxNTEgKiBlNiAvIDYxNDQgKyAxNTEgKiBlOCAvIDQwOTYgKyA1MDE5ICogZTEwIC8gMTMxMDcyIC0gNDUzICogZDIgKiBlMTAgLyAxNjM4NCArIDI2OTY1ICogZTEyIC8gNzg2NDMyIC0gODYwNyAqIGQyICogZTEyIC8gMTMxMDcyKSAqIHNpbjZEICsgKDEwOTcgKiBlOCAvIDEzMTA3MiArIDEwOTcgKiBlMTAgLyA2NTUzNiArIDIyNTc5NyAqIGUxMiAvIDEwNDg1NzYwIC0gMTA5NyAqIGQyICogZTEyIC8gNjU1MzYpICogc2luOEQgKyAoODAxMSAqIGUxMCAvIDI2MjE0NDAgKyA4MDExICogZTEyIC8gMTA0ODU3NikgKiBzaW4xMEQgKyAyOTMzOTMgKiBlMTIgLyAyNTE2NTgyNDAgKiBzaW4xMkQ7CiAgfQogIGZ1bmN0aW9uIGNhbGN1bGF0ZVNpZ21hKGVsbGlwdGljaXR5LCBsYXRpdHVkZSkgewogICAgaWYgKGVsbGlwdGljaXR5ID09PSAwKSB7CiAgICAgIHJldHVybiBNYXRoLmxvZyhNYXRoLnRhbigwLjUgKiAoTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPICsgbGF0aXR1ZGUpKSk7CiAgICB9CiAgICBjb25zdCBlU2luTCA9IGVsbGlwdGljaXR5ICogTWF0aC5zaW4obGF0aXR1ZGUpOwogICAgcmV0dXJuIE1hdGgubG9nKE1hdGgudGFuKDAuNSAqIChNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gKyBsYXRpdHVkZSkpKSAtIGVsbGlwdGljaXR5IC8gMiAqIE1hdGgubG9nKCgxICsgZVNpbkwpIC8gKDEgLSBlU2luTCkpOwogIH0KICBmdW5jdGlvbiBjYWxjdWxhdGVIZWFkaW5nKGVsbGlwc29pZFJodW1iTGluZSwgZmlyc3RMb25naXR1ZGUsIGZpcnN0TGF0aXR1ZGUsIHNlY29uZExvbmdpdHVkZSwgc2Vjb25kTGF0aXR1ZGUpIHsKICAgIGNvbnN0IHNpZ21hMSA9IGNhbGN1bGF0ZVNpZ21hKGVsbGlwc29pZFJodW1iTGluZS5fZWxsaXB0aWNpdHksIGZpcnN0TGF0aXR1ZGUpOwogICAgY29uc3Qgc2lnbWEyID0gY2FsY3VsYXRlU2lnbWEoCiAgICAgIGVsbGlwc29pZFJodW1iTGluZS5fZWxsaXB0aWNpdHksCiAgICAgIHNlY29uZExhdGl0dWRlCiAgICApOwogICAgcmV0dXJuIE1hdGguYXRhbjIoCiAgICAgIE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaShzZWNvbmRMb25naXR1ZGUgLSBmaXJzdExvbmdpdHVkZSksCiAgICAgIHNpZ21hMiAtIHNpZ21hMQogICAgKTsKICB9CiAgZnVuY3Rpb24gY2FsY3VsYXRlQXJjTGVuZ3RoKGVsbGlwc29pZFJodW1iTGluZSwgbWFqb3IsIG1pbm9yLCBmaXJzdExvbmdpdHVkZSwgZmlyc3RMYXRpdHVkZSwgc2Vjb25kTG9uZ2l0dWRlLCBzZWNvbmRMYXRpdHVkZSkgewogICAgY29uc3QgaGVhZGluZyA9IGVsbGlwc29pZFJodW1iTGluZS5faGVhZGluZzsKICAgIGNvbnN0IGRlbHRhTG9uZ2l0dWRlID0gc2Vjb25kTG9uZ2l0dWRlIC0gZmlyc3RMb25naXR1ZGU7CiAgICBsZXQgZGlzdGFuY2UgPSAwOwogICAgaWYgKE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICBNYXRoLmFicyhoZWFkaW5nKSwKICAgICAgTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPLAogICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjgKICAgICkpIHsKICAgICAgaWYgKG1ham9yID09PSBtaW5vcikgewogICAgICAgIGRpc3RhbmNlID0gbWFqb3IgKiBNYXRoLmNvcyhmaXJzdExhdGl0dWRlKSAqIE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaShkZWx0YUxvbmdpdHVkZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgc2luUGhpID0gTWF0aC5zaW4oZmlyc3RMYXRpdHVkZSk7CiAgICAgICAgZGlzdGFuY2UgPSBtYWpvciAqIE1hdGguY29zKGZpcnN0TGF0aXR1ZGUpICogTWF0aF9kZWZhdWx0Lm5lZ2F0aXZlUGlUb1BpKGRlbHRhTG9uZ2l0dWRlKSAvIE1hdGguc3FydCgxIC0gZWxsaXBzb2lkUmh1bWJMaW5lLl9lbGxpcHRpY2l0eVNxdWFyZWQgKiBzaW5QaGkgKiBzaW5QaGkpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBjb25zdCBNMSA9IGNhbGN1bGF0ZU0oCiAgICAgICAgZWxsaXBzb2lkUmh1bWJMaW5lLl9lbGxpcHRpY2l0eSwKICAgICAgICBtYWpvciwKICAgICAgICBmaXJzdExhdGl0dWRlCiAgICAgICk7CiAgICAgIGNvbnN0IE0yID0gY2FsY3VsYXRlTSgKICAgICAgICBlbGxpcHNvaWRSaHVtYkxpbmUuX2VsbGlwdGljaXR5LAogICAgICAgIG1ham9yLAogICAgICAgIHNlY29uZExhdGl0dWRlCiAgICAgICk7CiAgICAgIGRpc3RhbmNlID0gKE0yIC0gTTEpIC8gTWF0aC5jb3MoaGVhZGluZyk7CiAgICB9CiAgICByZXR1cm4gTWF0aC5hYnMoZGlzdGFuY2UpOwogIH0KICBmdW5jdGlvbiBjb21wdXRlUHJvcGVydGllcyhlbGxpcHNvaWRSaHVtYkxpbmUsIHN0YXJ0LCBlbmQsIGVsbGlwc29pZCkgewogICAgY29uc3QgZmlyc3RDYXJ0ZXNpYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oc3RhcnQsIHNjcmF0Y2hDYXJ0MiksCiAgICAgIHNjcmF0Y2hDYXJ0MQogICAgKTsKICAgIGNvbnN0IGxhc3RDYXJ0ZXNpYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oZW5kLCBzY3JhdGNoQ2FydDIpLAogICAgICBzY3JhdGNoQ2FydDIKICAgICk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygKICAgICAgInZhbHVlIiwKICAgICAgTWF0aC5hYnMoCiAgICAgICAgTWF0aC5hYnMoQ2FydGVzaWFuM19kZWZhdWx0LmFuZ2xlQmV0d2VlbihmaXJzdENhcnRlc2lhbiwgbGFzdENhcnRlc2lhbikpIC0gTWF0aC5QSQogICAgICApLAogICAgICAwLjAxMjUKICAgICk7CiAgICBjb25zdCBtYWpvciA9IGVsbGlwc29pZC5tYXhpbXVtUmFkaXVzOwogICAgY29uc3QgbWlub3IgPSBlbGxpcHNvaWQubWluaW11bVJhZGl1czsKICAgIGNvbnN0IG1ham9yU3F1YXJlZCA9IG1ham9yICogbWFqb3I7CiAgICBjb25zdCBtaW5vclNxdWFyZWQgPSBtaW5vciAqIG1pbm9yOwogICAgZWxsaXBzb2lkUmh1bWJMaW5lLl9lbGxpcHRpY2l0eVNxdWFyZWQgPSAobWFqb3JTcXVhcmVkIC0gbWlub3JTcXVhcmVkKSAvIG1ham9yU3F1YXJlZDsKICAgIGVsbGlwc29pZFJodW1iTGluZS5fZWxsaXB0aWNpdHkgPSBNYXRoLnNxcnQoCiAgICAgIGVsbGlwc29pZFJodW1iTGluZS5fZWxsaXB0aWNpdHlTcXVhcmVkCiAgICApOwogICAgZWxsaXBzb2lkUmh1bWJMaW5lLl9zdGFydCA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmNsb25lKAogICAgICBzdGFydCwKICAgICAgZWxsaXBzb2lkUmh1bWJMaW5lLl9zdGFydAogICAgKTsKICAgIGVsbGlwc29pZFJodW1iTGluZS5fc3RhcnQuaGVpZ2h0ID0gMDsKICAgIGVsbGlwc29pZFJodW1iTGluZS5fZW5kID0gQ2FydG9ncmFwaGljX2RlZmF1bHQuY2xvbmUoZW5kLCBlbGxpcHNvaWRSaHVtYkxpbmUuX2VuZCk7CiAgICBlbGxpcHNvaWRSaHVtYkxpbmUuX2VuZC5oZWlnaHQgPSAwOwogICAgZWxsaXBzb2lkUmh1bWJMaW5lLl9oZWFkaW5nID0gY2FsY3VsYXRlSGVhZGluZygKICAgICAgZWxsaXBzb2lkUmh1bWJMaW5lLAogICAgICBzdGFydC5sb25naXR1ZGUsCiAgICAgIHN0YXJ0LmxhdGl0dWRlLAogICAgICBlbmQubG9uZ2l0dWRlLAogICAgICBlbmQubGF0aXR1ZGUKICAgICk7CiAgICBlbGxpcHNvaWRSaHVtYkxpbmUuX2Rpc3RhbmNlID0gY2FsY3VsYXRlQXJjTGVuZ3RoKAogICAgICBlbGxpcHNvaWRSaHVtYkxpbmUsCiAgICAgIGVsbGlwc29pZC5tYXhpbXVtUmFkaXVzLAogICAgICBlbGxpcHNvaWQubWluaW11bVJhZGl1cywKICAgICAgc3RhcnQubG9uZ2l0dWRlLAogICAgICBzdGFydC5sYXRpdHVkZSwKICAgICAgZW5kLmxvbmdpdHVkZSwKICAgICAgZW5kLmxhdGl0dWRlCiAgICApOwogIH0KICBmdW5jdGlvbiBpbnRlcnBvbGF0ZVVzaW5nU3VyZmFjZURpc3RhbmNlKHN0YXJ0LCBoZWFkaW5nLCBkaXN0YW5jZSwgbWFqb3IsIGVsbGlwdGljaXR5LCByZXN1bHQpIHsKICAgIGlmIChkaXN0YW5jZSA9PT0gMCkgewogICAgICByZXR1cm4gQ2FydG9ncmFwaGljX2RlZmF1bHQuY2xvbmUoc3RhcnQsIHJlc3VsdCk7CiAgICB9CiAgICBjb25zdCBlbGxpcHRpY2l0eVNxdWFyZWQgPSBlbGxpcHRpY2l0eSAqIGVsbGlwdGljaXR5OwogICAgbGV0IGxvbmdpdHVkZTsKICAgIGxldCBsYXRpdHVkZTsKICAgIGxldCBkZWx0YUxvbmdpdHVkZTsKICAgIGlmIChNYXRoLmFicyhNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gLSBNYXRoLmFicyhoZWFkaW5nKSkgPiBNYXRoX2RlZmF1bHQuRVBTSUxPTjgpIHsKICAgICAgY29uc3QgTTEgPSBjYWxjdWxhdGVNKGVsbGlwdGljaXR5LCBtYWpvciwgc3RhcnQubGF0aXR1ZGUpOwogICAgICBjb25zdCBkZWx0YU0gPSBkaXN0YW5jZSAqIE1hdGguY29zKGhlYWRpbmcpOwogICAgICBjb25zdCBNMiA9IE0xICsgZGVsdGFNOwogICAgICBsYXRpdHVkZSA9IGNhbGN1bGF0ZUludmVyc2VNKE0yLCBlbGxpcHRpY2l0eSwgbWFqb3IpOwogICAgICBpZiAoTWF0aC5hYnMoaGVhZGluZykgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwKSB7CiAgICAgICAgbG9uZ2l0dWRlID0gTWF0aF9kZWZhdWx0Lm5lZ2F0aXZlUGlUb1BpKHN0YXJ0LmxvbmdpdHVkZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgc2lnbWExID0gY2FsY3VsYXRlU2lnbWEoZWxsaXB0aWNpdHksIHN0YXJ0LmxhdGl0dWRlKTsKICAgICAgICBjb25zdCBzaWdtYTIgPSBjYWxjdWxhdGVTaWdtYShlbGxpcHRpY2l0eSwgbGF0aXR1ZGUpOwogICAgICAgIGRlbHRhTG9uZ2l0dWRlID0gTWF0aC50YW4oaGVhZGluZykgKiAoc2lnbWEyIC0gc2lnbWExKTsKICAgICAgICBsb25naXR1ZGUgPSBNYXRoX2RlZmF1bHQubmVnYXRpdmVQaVRvUGkoc3RhcnQubG9uZ2l0dWRlICsgZGVsdGFMb25naXR1ZGUpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBsYXRpdHVkZSA9IHN0YXJ0LmxhdGl0dWRlOwogICAgICBsZXQgbG9jYWxSYWQ7CiAgICAgIGlmIChlbGxpcHRpY2l0eSA9PT0gMCkgewogICAgICAgIGxvY2FsUmFkID0gbWFqb3IgKiBNYXRoLmNvcyhzdGFydC5sYXRpdHVkZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgc2luUGhpID0gTWF0aC5zaW4oc3RhcnQubGF0aXR1ZGUpOwogICAgICAgIGxvY2FsUmFkID0gbWFqb3IgKiBNYXRoLmNvcyhzdGFydC5sYXRpdHVkZSkgLyBNYXRoLnNxcnQoMSAtIGVsbGlwdGljaXR5U3F1YXJlZCAqIHNpblBoaSAqIHNpblBoaSk7CiAgICAgIH0KICAgICAgZGVsdGFMb25naXR1ZGUgPSBkaXN0YW5jZSAvIGxvY2FsUmFkOwogICAgICBpZiAoaGVhZGluZyA+IDApIHsKICAgICAgICBsb25naXR1ZGUgPSBNYXRoX2RlZmF1bHQubmVnYXRpdmVQaVRvUGkoc3RhcnQubG9uZ2l0dWRlICsgZGVsdGFMb25naXR1ZGUpOwogICAgICB9IGVsc2UgewogICAgICAgIGxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaShzdGFydC5sb25naXR1ZGUgLSBkZWx0YUxvbmdpdHVkZSk7CiAgICAgIH0KICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICByZXN1bHQubG9uZ2l0dWRlID0gbG9uZ2l0dWRlOwogICAgICByZXN1bHQubGF0aXR1ZGUgPSBsYXRpdHVkZTsKICAgICAgcmVzdWx0LmhlaWdodCA9IDA7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICByZXR1cm4gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KGxvbmdpdHVkZSwgbGF0aXR1ZGUsIDApOwogIH0KICBmdW5jdGlvbiBFbGxpcHNvaWRSaHVtYkxpbmUoc3RhcnQsIGVuZCwgZWxsaXBzb2lkKSB7CiAgICBjb25zdCBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICB0aGlzLl9lbGxpcHNvaWQgPSBlOwogICAgdGhpcy5fc3RhcnQgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgIHRoaXMuX2VuZCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgdGhpcy5faGVhZGluZyA9IHZvaWQgMDsKICAgIHRoaXMuX2Rpc3RhbmNlID0gdm9pZCAwOwogICAgdGhpcy5fZWxsaXB0aWNpdHkgPSB2b2lkIDA7CiAgICB0aGlzLl9lbGxpcHRpY2l0eVNxdWFyZWQgPSB2b2lkIDA7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHN0YXJ0KSAmJiBkZWZpbmVkX2RlZmF1bHQoZW5kKSkgewogICAgICBjb21wdXRlUHJvcGVydGllcyh0aGlzLCBzdGFydCwgZW5kLCBlKTsKICAgIH0KICB9CiAgdmFyIHNjcmF0Y2hDYXJ0MSwgc2NyYXRjaENhcnQyLCBFbGxpcHNvaWRSaHVtYkxpbmVfZGVmYXVsdDsKICB2YXIgaW5pdF9FbGxpcHNvaWRSaHVtYkxpbmUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc29pZFJodW1iTGluZS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBzY3JhdGNoQ2FydDEgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0MiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoRWxsaXBzb2lkUmh1bWJMaW5lLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGVsbGlwc29pZC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkUmh1bWJMaW5lLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtFbGxpcHNvaWR9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgZWxsaXBzb2lkOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fZWxsaXBzb2lkOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgc3VyZmFjZSBkaXN0YW5jZSBiZXR3ZWVuIHRoZSBzdGFydCBhbmQgZW5kIHBvaW50CiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZFJodW1iTGluZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIHN1cmZhY2VEaXN0YW5jZTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJkaXN0YW5jZSIsIHRoaXMuX2Rpc3RhbmNlKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2Rpc3RhbmNlOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgaW5pdGlhbCBwbGFuZXRvZGV0aWMgcG9pbnQgb24gdGhlIHBhdGguCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZFJodW1iTGluZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7Q2FydG9ncmFwaGljfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIHN0YXJ0OiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fc3RhcnQ7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBmaW5hbCBwbGFuZXRvZGV0aWMgcG9pbnQgb24gdGhlIHBhdGguCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZFJodW1iTGluZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7Q2FydG9ncmFwaGljfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGVuZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VuZDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGhlYWRpbmcgZnJvbSB0aGUgc3RhcnQgcG9pbnQgdG8gdGhlIGVuZCBwb2ludC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkUmh1bWJMaW5lLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgaGVhZGluZzogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJkaXN0YW5jZSIsIHRoaXMuX2Rpc3RhbmNlKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2hlYWRpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgRWxsaXBzb2lkUmh1bWJMaW5lLmZyb21TdGFydEhlYWRpbmdEaXN0YW5jZSA9IGZ1bmN0aW9uKHN0YXJ0LCBoZWFkaW5nLCBkaXN0YW5jZSwgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInN0YXJ0Iiwgc3RhcnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiaGVhZGluZyIsIGhlYWRpbmcpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiZGlzdGFuY2UiLCBkaXN0YW5jZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuKCJkaXN0YW5jZSIsIGRpc3RhbmNlLCAwKTsKICAgICAgICBjb25zdCBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICAgICAgY29uc3QgbWFqb3IgPSBlLm1heGltdW1SYWRpdXM7CiAgICAgICAgY29uc3QgbWlub3IgPSBlLm1pbmltdW1SYWRpdXM7CiAgICAgICAgY29uc3QgbWFqb3JTcXVhcmVkID0gbWFqb3IgKiBtYWpvcjsKICAgICAgICBjb25zdCBtaW5vclNxdWFyZWQgPSBtaW5vciAqIG1pbm9yOwogICAgICAgIGNvbnN0IGVsbGlwdGljaXR5ID0gTWF0aC5zcXJ0KChtYWpvclNxdWFyZWQgLSBtaW5vclNxdWFyZWQpIC8gbWFqb3JTcXVhcmVkKTsKICAgICAgICBoZWFkaW5nID0gTWF0aF9kZWZhdWx0Lm5lZ2F0aXZlUGlUb1BpKGhlYWRpbmcpOwogICAgICAgIGNvbnN0IGVuZCA9IGludGVycG9sYXRlVXNpbmdTdXJmYWNlRGlzdGFuY2UoCiAgICAgICAgICBzdGFydCwKICAgICAgICAgIGhlYWRpbmcsCiAgICAgICAgICBkaXN0YW5jZSwKICAgICAgICAgIGUubWF4aW11bVJhZGl1cywKICAgICAgICAgIGVsbGlwdGljaXR5CiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpIHx8IGRlZmluZWRfZGVmYXVsdChlbGxpcHNvaWQpICYmICFlbGxpcHNvaWQuZXF1YWxzKHJlc3VsdC5lbGxpcHNvaWQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEVsbGlwc29pZFJodW1iTGluZShzdGFydCwgZW5kLCBlKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnNldEVuZFBvaW50cyhzdGFydCwgZW5kKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBFbGxpcHNvaWRSaHVtYkxpbmUucHJvdG90eXBlLnNldEVuZFBvaW50cyA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInN0YXJ0Iiwgc3RhcnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiZW5kIiwgZW5kKTsKICAgICAgICBjb21wdXRlUHJvcGVydGllcyh0aGlzLCBzdGFydCwgZW5kLCB0aGlzLl9lbGxpcHNvaWQpOwogICAgICB9OwogICAgICBFbGxpcHNvaWRSaHVtYkxpbmUucHJvdG90eXBlLmludGVycG9sYXRlVXNpbmdGcmFjdGlvbiA9IGZ1bmN0aW9uKGZyYWN0aW9uLCByZXN1bHQpIHsKICAgICAgICByZXR1cm4gdGhpcy5pbnRlcnBvbGF0ZVVzaW5nU3VyZmFjZURpc3RhbmNlKAogICAgICAgICAgZnJhY3Rpb24gKiB0aGlzLl9kaXN0YW5jZSwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZFJodW1iTGluZS5wcm90b3R5cGUuaW50ZXJwb2xhdGVVc2luZ1N1cmZhY2VEaXN0YW5jZSA9IGZ1bmN0aW9uKGRpc3RhbmNlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImRpc3RhbmNlIiwgZGlzdGFuY2UpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHRoaXMuX2Rpc3RhbmNlKSB8fCB0aGlzLl9kaXN0YW5jZSA9PT0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJFbGxpcHNvaWRSaHVtYkxpbmUgbXVzdCBoYXZlIGRpc3RpbmN0IHN0YXJ0IGFuZCBlbmQgc2V0LiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpbnRlcnBvbGF0ZVVzaW5nU3VyZmFjZURpc3RhbmNlKAogICAgICAgICAgdGhpcy5fc3RhcnQsCiAgICAgICAgICB0aGlzLl9oZWFkaW5nLAogICAgICAgICAgZGlzdGFuY2UsCiAgICAgICAgICB0aGlzLl9lbGxpcHNvaWQubWF4aW11bVJhZGl1cywKICAgICAgICAgIHRoaXMuX2VsbGlwdGljaXR5LAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkUmh1bWJMaW5lLnByb3RvdHlwZS5maW5kSW50ZXJzZWN0aW9uV2l0aExvbmdpdHVkZSA9IGZ1bmN0aW9uKGludGVyc2VjdGlvbkxvbmdpdHVkZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJpbnRlcnNlY3Rpb25Mb25naXR1ZGUiLCBpbnRlcnNlY3Rpb25Mb25naXR1ZGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHRoaXMuX2Rpc3RhbmNlKSB8fCB0aGlzLl9kaXN0YW5jZSA9PT0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJFbGxpcHNvaWRSaHVtYkxpbmUgbXVzdCBoYXZlIGRpc3RpbmN0IHN0YXJ0IGFuZCBlbmQgc2V0LiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVsbGlwdGljaXR5ID0gdGhpcy5fZWxsaXB0aWNpdHk7CiAgICAgICAgY29uc3QgaGVhZGluZyA9IHRoaXMuX2hlYWRpbmc7CiAgICAgICAgY29uc3QgYWJzSGVhZGluZyA9IE1hdGguYWJzKGhlYWRpbmcpOwogICAgICAgIGNvbnN0IHN0YXJ0ID0gdGhpcy5fc3RhcnQ7CiAgICAgICAgaW50ZXJzZWN0aW9uTG9uZ2l0dWRlID0gTWF0aF9kZWZhdWx0Lm5lZ2F0aXZlUGlUb1BpKGludGVyc2VjdGlvbkxvbmdpdHVkZSk7CiAgICAgICAgaWYgKE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgTWF0aC5hYnMoaW50ZXJzZWN0aW9uTG9uZ2l0dWRlKSwKICAgICAgICAgIE1hdGguUEksCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjE0CiAgICAgICAgKSkgewogICAgICAgICAgaW50ZXJzZWN0aW9uTG9uZ2l0dWRlID0gTWF0aF9kZWZhdWx0LnNpZ24oc3RhcnQubG9uZ2l0dWRlKSAqIE1hdGguUEk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBpZiAoTWF0aC5hYnMoTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIC0gYWJzSGVhZGluZykgPD0gTWF0aF9kZWZhdWx0LkVQU0lMT044KSB7CiAgICAgICAgICByZXN1bHQubG9uZ2l0dWRlID0gaW50ZXJzZWN0aW9uTG9uZ2l0dWRlOwogICAgICAgICAgcmVzdWx0LmxhdGl0dWRlID0gc3RhcnQubGF0aXR1ZGU7CiAgICAgICAgICByZXN1bHQuaGVpZ2h0ID0gMDsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSBlbHNlIGlmIChNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIE1hdGguYWJzKE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAtIGFic0hlYWRpbmcpLAogICAgICAgICAgTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT044CiAgICAgICAgKSkgewogICAgICAgICAgaWYgKE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgICBpbnRlcnNlY3Rpb25Mb25naXR1ZGUsCiAgICAgICAgICAgIHN0YXJ0LmxvbmdpdHVkZSwKICAgICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04xMgogICAgICAgICAgKSkgewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IGludGVyc2VjdGlvbkxvbmdpdHVkZTsKICAgICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAqIE1hdGhfZGVmYXVsdC5zaWduKE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAtIGhlYWRpbmcpOwogICAgICAgICAgcmVzdWx0LmhlaWdodCA9IDA7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBjb25zdCBwaGkxID0gc3RhcnQubGF0aXR1ZGU7CiAgICAgICAgY29uc3QgZVNpblBoaTEgPSBlbGxpcHRpY2l0eSAqIE1hdGguc2luKHBoaTEpOwogICAgICAgIGNvbnN0IGxlZnRDb21wb25lbnQgPSBNYXRoLnRhbigwLjUgKiAoTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPICsgcGhpMSkpICogTWF0aC5leHAoKGludGVyc2VjdGlvbkxvbmdpdHVkZSAtIHN0YXJ0LmxvbmdpdHVkZSkgLyBNYXRoLnRhbihoZWFkaW5nKSk7CiAgICAgICAgY29uc3QgZGVub21pbmF0b3IgPSAoMSArIGVTaW5QaGkxKSAvICgxIC0gZVNpblBoaTEpOwogICAgICAgIGxldCBuZXdQaGkgPSBzdGFydC5sYXRpdHVkZTsKICAgICAgICBsZXQgcGhpOwogICAgICAgIGRvIHsKICAgICAgICAgIHBoaSA9IG5ld1BoaTsKICAgICAgICAgIGNvbnN0IGVTaW5QaGkgPSBlbGxpcHRpY2l0eSAqIE1hdGguc2luKHBoaSk7CiAgICAgICAgICBjb25zdCBudW1lcmF0b3IgPSAoMSArIGVTaW5QaGkpIC8gKDEgLSBlU2luUGhpKTsKICAgICAgICAgIG5ld1BoaSA9IDIgKiBNYXRoLmF0YW4oCiAgICAgICAgICAgIGxlZnRDb21wb25lbnQgKiBNYXRoLnBvdyhudW1lcmF0b3IgLyBkZW5vbWluYXRvciwgZWxsaXB0aWNpdHkgLyAyKQogICAgICAgICAgKSAtIE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTzsKICAgICAgICB9IHdoaWxlICghTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24obmV3UGhpLCBwaGksIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTIpKTsKICAgICAgICByZXN1bHQubG9uZ2l0dWRlID0gaW50ZXJzZWN0aW9uTG9uZ2l0dWRlOwogICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IG5ld1BoaTsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBFbGxpcHNvaWRSaHVtYkxpbmUucHJvdG90eXBlLmZpbmRJbnRlcnNlY3Rpb25XaXRoTGF0aXR1ZGUgPSBmdW5jdGlvbihpbnRlcnNlY3Rpb25MYXRpdHVkZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJpbnRlcnNlY3Rpb25MYXRpdHVkZSIsIGludGVyc2VjdGlvbkxhdGl0dWRlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0aGlzLl9kaXN0YW5jZSkgfHwgdGhpcy5fZGlzdGFuY2UgPT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiRWxsaXBzb2lkUmh1bWJMaW5lIG11c3QgaGF2ZSBkaXN0aW5jdCBzdGFydCBhbmQgZW5kIHNldC4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBlbGxpcHRpY2l0eSA9IHRoaXMuX2VsbGlwdGljaXR5OwogICAgICAgIGNvbnN0IGhlYWRpbmcgPSB0aGlzLl9oZWFkaW5nOwogICAgICAgIGNvbnN0IHN0YXJ0ID0gdGhpcy5fc3RhcnQ7CiAgICAgICAgaWYgKE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgTWF0aC5hYnMoaGVhZGluZyksCiAgICAgICAgICBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08sCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjgKICAgICAgICApKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNpZ21hMSA9IGNhbGN1bGF0ZVNpZ21hKGVsbGlwdGljaXR5LCBzdGFydC5sYXRpdHVkZSk7CiAgICAgICAgY29uc3Qgc2lnbWEyID0gY2FsY3VsYXRlU2lnbWEoZWxsaXB0aWNpdHksIGludGVyc2VjdGlvbkxhdGl0dWRlKTsKICAgICAgICBjb25zdCBkZWx0YUxvbmdpdHVkZSA9IE1hdGgudGFuKGhlYWRpbmcpICogKHNpZ21hMiAtIHNpZ21hMSk7CiAgICAgICAgY29uc3QgbG9uZ2l0dWRlID0gTWF0aF9kZWZhdWx0Lm5lZ2F0aXZlUGlUb1BpKHN0YXJ0LmxvbmdpdHVkZSArIGRlbHRhTG9uZ2l0dWRlKTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSBsb25naXR1ZGU7CiAgICAgICAgICByZXN1bHQubGF0aXR1ZGUgPSBpbnRlcnNlY3Rpb25MYXRpdHVkZTsKICAgICAgICAgIHJlc3VsdC5oZWlnaHQgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdChsb25naXR1ZGUsIGludGVyc2VjdGlvbkxhdGl0dWRlLCAwKTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkUmh1bWJMaW5lX2RlZmF1bHQgPSBFbGxpcHNvaWRSaHVtYkxpbmU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5Z29uSGllcmFyY2h5LmpzCiAgZnVuY3Rpb24gUG9seWdvbkhpZXJhcmNoeShwb3NpdGlvbnMsIGhvbGVzKSB7CiAgICB0aGlzLnBvc2l0aW9ucyA9IGRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMpID8gcG9zaXRpb25zIDogW107CiAgICB0aGlzLmhvbGVzID0gZGVmaW5lZF9kZWZhdWx0KGhvbGVzKSA/IGhvbGVzIDogW107CiAgfQogIHZhciBQb2x5Z29uSGllcmFyY2h5X2RlZmF1bHQ7CiAgdmFyIGluaXRfUG9seWdvbkhpZXJhcmNoeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWdvbkhpZXJhcmNoeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBQb2x5Z29uSGllcmFyY2h5X2RlZmF1bHQgPSBQb2x5Z29uSGllcmFyY2h5OwogICAgfQogIH0pOwoKICAvLyBub2RlX21vZHVsZXMvZWFyY3V0L3NyYy9lYXJjdXQuanMKICB2YXIgcmVxdWlyZV9lYXJjdXQgPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvZWFyY3V0L3NyYy9lYXJjdXQuanMiKGV4cG9ydHMyLCBtb2R1bGUpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICBtb2R1bGUuZXhwb3J0cyA9IGVhcmN1dDI7CiAgICAgIG1vZHVsZS5leHBvcnRzLmRlZmF1bHQgPSBlYXJjdXQyOwogICAgICBmdW5jdGlvbiBlYXJjdXQyKGRhdGEsIGhvbGVJbmRpY2VzLCBkaW0pIHsKICAgICAgICBkaW0gPSBkaW0gfHwgMjsKICAgICAgICB2YXIgaGFzSG9sZXMgPSBob2xlSW5kaWNlcyAmJiBob2xlSW5kaWNlcy5sZW5ndGgsIG91dGVyTGVuID0gaGFzSG9sZXMgPyBob2xlSW5kaWNlc1swXSAqIGRpbSA6IGRhdGEubGVuZ3RoLCBvdXRlck5vZGUgPSBsaW5rZWRMaXN0KGRhdGEsIDAsIG91dGVyTGVuLCBkaW0sIHRydWUpLCB0cmlhbmdsZXMgPSBbXTsKICAgICAgICBpZiAoIW91dGVyTm9kZSB8fCBvdXRlck5vZGUubmV4dCA9PT0gb3V0ZXJOb2RlLnByZXYpCiAgICAgICAgICByZXR1cm4gdHJpYW5nbGVzOwogICAgICAgIHZhciBtaW5YLCBtaW5ZLCBtYXhYLCBtYXhZLCB4LCB5LCBpbnZTaXplOwogICAgICAgIGlmIChoYXNIb2xlcykKICAgICAgICAgIG91dGVyTm9kZSA9IGVsaW1pbmF0ZUhvbGVzKGRhdGEsIGhvbGVJbmRpY2VzLCBvdXRlck5vZGUsIGRpbSk7CiAgICAgICAgaWYgKGRhdGEubGVuZ3RoID4gODAgKiBkaW0pIHsKICAgICAgICAgIG1pblggPSBtYXhYID0gZGF0YVswXTsKICAgICAgICAgIG1pblkgPSBtYXhZID0gZGF0YVsxXTsKICAgICAgICAgIGZvciAodmFyIGkgPSBkaW07IGkgPCBvdXRlckxlbjsgaSArPSBkaW0pIHsKICAgICAgICAgICAgeCA9IGRhdGFbaV07CiAgICAgICAgICAgIHkgPSBkYXRhW2kgKyAxXTsKICAgICAgICAgICAgaWYgKHggPCBtaW5YKQogICAgICAgICAgICAgIG1pblggPSB4OwogICAgICAgICAgICBpZiAoeSA8IG1pblkpCiAgICAgICAgICAgICAgbWluWSA9IHk7CiAgICAgICAgICAgIGlmICh4ID4gbWF4WCkKICAgICAgICAgICAgICBtYXhYID0geDsKICAgICAgICAgICAgaWYgKHkgPiBtYXhZKQogICAgICAgICAgICAgIG1heFkgPSB5OwogICAgICAgICAgfQogICAgICAgICAgaW52U2l6ZSA9IE1hdGgubWF4KG1heFggLSBtaW5YLCBtYXhZIC0gbWluWSk7CiAgICAgICAgICBpbnZTaXplID0gaW52U2l6ZSAhPT0gMCA/IDMyNzY3IC8gaW52U2l6ZSA6IDA7CiAgICAgICAgfQogICAgICAgIGVhcmN1dExpbmtlZChvdXRlck5vZGUsIHRyaWFuZ2xlcywgZGltLCBtaW5YLCBtaW5ZLCBpbnZTaXplLCAwKTsKICAgICAgICByZXR1cm4gdHJpYW5nbGVzOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGxpbmtlZExpc3QoZGF0YSwgc3RhcnQsIGVuZCwgZGltLCBjbG9ja3dpc2UpIHsKICAgICAgICB2YXIgaSwgbGFzdDsKICAgICAgICBpZiAoY2xvY2t3aXNlID09PSBzaWduZWRBcmVhKGRhdGEsIHN0YXJ0LCBlbmQsIGRpbSkgPiAwKSB7CiAgICAgICAgICBmb3IgKGkgPSBzdGFydDsgaSA8IGVuZDsgaSArPSBkaW0pCiAgICAgICAgICAgIGxhc3QgPSBpbnNlcnROb2RlKGksIGRhdGFbaV0sIGRhdGFbaSArIDFdLCBsYXN0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yIChpID0gZW5kIC0gZGltOyBpID49IHN0YXJ0OyBpIC09IGRpbSkKICAgICAgICAgICAgbGFzdCA9IGluc2VydE5vZGUoaSwgZGF0YVtpXSwgZGF0YVtpICsgMV0sIGxhc3QpOwogICAgICAgIH0KICAgICAgICBpZiAobGFzdCAmJiBlcXVhbHMobGFzdCwgbGFzdC5uZXh0KSkgewogICAgICAgICAgcmVtb3ZlTm9kZShsYXN0KTsKICAgICAgICAgIGxhc3QgPSBsYXN0Lm5leHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBsYXN0OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGZpbHRlclBvaW50cyhzdGFydCwgZW5kKSB7CiAgICAgICAgaWYgKCFzdGFydCkKICAgICAgICAgIHJldHVybiBzdGFydDsKICAgICAgICBpZiAoIWVuZCkKICAgICAgICAgIGVuZCA9IHN0YXJ0OwogICAgICAgIHZhciBwID0gc3RhcnQsIGFnYWluOwogICAgICAgIGRvIHsKICAgICAgICAgIGFnYWluID0gZmFsc2U7CiAgICAgICAgICBpZiAoIXAuc3RlaW5lciAmJiAoZXF1YWxzKHAsIHAubmV4dCkgfHwgYXJlYShwLnByZXYsIHAsIHAubmV4dCkgPT09IDApKSB7CiAgICAgICAgICAgIHJlbW92ZU5vZGUocCk7CiAgICAgICAgICAgIHAgPSBlbmQgPSBwLnByZXY7CiAgICAgICAgICAgIGlmIChwID09PSBwLm5leHQpCiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGFnYWluID0gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHAgPSBwLm5leHQ7CiAgICAgICAgICB9CiAgICAgICAgfSB3aGlsZSAoYWdhaW4gfHwgcCAhPT0gZW5kKTsKICAgICAgICByZXR1cm4gZW5kOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGVhcmN1dExpbmtlZChlYXIsIHRyaWFuZ2xlcywgZGltLCBtaW5YLCBtaW5ZLCBpbnZTaXplLCBwYXNzKSB7CiAgICAgICAgaWYgKCFlYXIpCiAgICAgICAgICByZXR1cm47CiAgICAgICAgaWYgKCFwYXNzICYmIGludlNpemUpCiAgICAgICAgICBpbmRleEN1cnZlKGVhciwgbWluWCwgbWluWSwgaW52U2l6ZSk7CiAgICAgICAgdmFyIHN0b3AgPSBlYXIsIHByZXYsIG5leHQ7CiAgICAgICAgd2hpbGUgKGVhci5wcmV2ICE9PSBlYXIubmV4dCkgewogICAgICAgICAgcHJldiA9IGVhci5wcmV2OwogICAgICAgICAgbmV4dCA9IGVhci5uZXh0OwogICAgICAgICAgaWYgKGludlNpemUgPyBpc0Vhckhhc2hlZChlYXIsIG1pblgsIG1pblksIGludlNpemUpIDogaXNFYXIoZWFyKSkgewogICAgICAgICAgICB0cmlhbmdsZXMucHVzaChwcmV2LmkgLyBkaW0gfCAwKTsKICAgICAgICAgICAgdHJpYW5nbGVzLnB1c2goZWFyLmkgLyBkaW0gfCAwKTsKICAgICAgICAgICAgdHJpYW5nbGVzLnB1c2gobmV4dC5pIC8gZGltIHwgMCk7CiAgICAgICAgICAgIHJlbW92ZU5vZGUoZWFyKTsKICAgICAgICAgICAgZWFyID0gbmV4dC5uZXh0OwogICAgICAgICAgICBzdG9wID0gbmV4dC5uZXh0OwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGVhciA9IG5leHQ7CiAgICAgICAgICBpZiAoZWFyID09PSBzdG9wKSB7CiAgICAgICAgICAgIGlmICghcGFzcykgewogICAgICAgICAgICAgIGVhcmN1dExpbmtlZChmaWx0ZXJQb2ludHMoZWFyKSwgdHJpYW5nbGVzLCBkaW0sIG1pblgsIG1pblksIGludlNpemUsIDEpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHBhc3MgPT09IDEpIHsKICAgICAgICAgICAgICBlYXIgPSBjdXJlTG9jYWxJbnRlcnNlY3Rpb25zKGZpbHRlclBvaW50cyhlYXIpLCB0cmlhbmdsZXMsIGRpbSk7CiAgICAgICAgICAgICAgZWFyY3V0TGlua2VkKGVhciwgdHJpYW5nbGVzLCBkaW0sIG1pblgsIG1pblksIGludlNpemUsIDIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHBhc3MgPT09IDIpIHsKICAgICAgICAgICAgICBzcGxpdEVhcmN1dChlYXIsIHRyaWFuZ2xlcywgZGltLCBtaW5YLCBtaW5ZLCBpbnZTaXplKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaXNFYXIoZWFyKSB7CiAgICAgICAgdmFyIGEzID0gZWFyLnByZXYsIGIgPSBlYXIsIGMgPSBlYXIubmV4dDsKICAgICAgICBpZiAoYXJlYShhMywgYiwgYykgPj0gMCkKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB2YXIgYXggPSBhMy54LCBieCA9IGIueCwgY3ggPSBjLngsIGF5ID0gYTMueSwgYnkgPSBiLnksIGN5ID0gYy55OwogICAgICAgIHZhciB4MCA9IGF4IDwgYnggPyBheCA8IGN4ID8gYXggOiBjeCA6IGJ4IDwgY3ggPyBieCA6IGN4LCB5MCA9IGF5IDwgYnkgPyBheSA8IGN5ID8gYXkgOiBjeSA6IGJ5IDwgY3kgPyBieSA6IGN5LCB4MSA9IGF4ID4gYnggPyBheCA+IGN4ID8gYXggOiBjeCA6IGJ4ID4gY3ggPyBieCA6IGN4LCB5MSA9IGF5ID4gYnkgPyBheSA+IGN5ID8gYXkgOiBjeSA6IGJ5ID4gY3kgPyBieSA6IGN5OwogICAgICAgIHZhciBwID0gYy5uZXh0OwogICAgICAgIHdoaWxlIChwICE9PSBhMykgewogICAgICAgICAgaWYgKHAueCA+PSB4MCAmJiBwLnggPD0geDEgJiYgcC55ID49IHkwICYmIHAueSA8PSB5MSAmJiBwb2ludEluVHJpYW5nbGUoYXgsIGF5LCBieCwgYnksIGN4LCBjeSwgcC54LCBwLnkpICYmIGFyZWEocC5wcmV2LCBwLCBwLm5leHQpID49IDApCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIHAgPSBwLm5leHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGlzRWFySGFzaGVkKGVhciwgbWluWCwgbWluWSwgaW52U2l6ZSkgewogICAgICAgIHZhciBhMyA9IGVhci5wcmV2LCBiID0gZWFyLCBjID0gZWFyLm5leHQ7CiAgICAgICAgaWYgKGFyZWEoYTMsIGIsIGMpID49IDApCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgdmFyIGF4ID0gYTMueCwgYnggPSBiLngsIGN4ID0gYy54LCBheSA9IGEzLnksIGJ5ID0gYi55LCBjeSA9IGMueTsKICAgICAgICB2YXIgeDAgPSBheCA8IGJ4ID8gYXggPCBjeCA/IGF4IDogY3ggOiBieCA8IGN4ID8gYnggOiBjeCwgeTAgPSBheSA8IGJ5ID8gYXkgPCBjeSA/IGF5IDogY3kgOiBieSA8IGN5ID8gYnkgOiBjeSwgeDEgPSBheCA+IGJ4ID8gYXggPiBjeCA/IGF4IDogY3ggOiBieCA+IGN4ID8gYnggOiBjeCwgeTEgPSBheSA+IGJ5ID8gYXkgPiBjeSA/IGF5IDogY3kgOiBieSA+IGN5ID8gYnkgOiBjeTsKICAgICAgICB2YXIgbWluWiA9IHpPcmRlcih4MCwgeTAsIG1pblgsIG1pblksIGludlNpemUpLCBtYXhaID0gek9yZGVyKHgxLCB5MSwgbWluWCwgbWluWSwgaW52U2l6ZSk7CiAgICAgICAgdmFyIHAgPSBlYXIucHJldlosIG4gPSBlYXIubmV4dFo7CiAgICAgICAgd2hpbGUgKHAgJiYgcC56ID49IG1pblogJiYgbiAmJiBuLnogPD0gbWF4WikgewogICAgICAgICAgaWYgKHAueCA+PSB4MCAmJiBwLnggPD0geDEgJiYgcC55ID49IHkwICYmIHAueSA8PSB5MSAmJiBwICE9PSBhMyAmJiBwICE9PSBjICYmIHBvaW50SW5UcmlhbmdsZShheCwgYXksIGJ4LCBieSwgY3gsIGN5LCBwLngsIHAueSkgJiYgYXJlYShwLnByZXYsIHAsIHAubmV4dCkgPj0gMCkKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgcCA9IHAucHJldlo7CiAgICAgICAgICBpZiAobi54ID49IHgwICYmIG4ueCA8PSB4MSAmJiBuLnkgPj0geTAgJiYgbi55IDw9IHkxICYmIG4gIT09IGEzICYmIG4gIT09IGMgJiYgcG9pbnRJblRyaWFuZ2xlKGF4LCBheSwgYngsIGJ5LCBjeCwgY3ksIG4ueCwgbi55KSAmJiBhcmVhKG4ucHJldiwgbiwgbi5uZXh0KSA+PSAwKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICBuID0gbi5uZXh0WjsKICAgICAgICB9CiAgICAgICAgd2hpbGUgKHAgJiYgcC56ID49IG1pblopIHsKICAgICAgICAgIGlmIChwLnggPj0geDAgJiYgcC54IDw9IHgxICYmIHAueSA+PSB5MCAmJiBwLnkgPD0geTEgJiYgcCAhPT0gYTMgJiYgcCAhPT0gYyAmJiBwb2ludEluVHJpYW5nbGUoYXgsIGF5LCBieCwgYnksIGN4LCBjeSwgcC54LCBwLnkpICYmIGFyZWEocC5wcmV2LCBwLCBwLm5leHQpID49IDApCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIHAgPSBwLnByZXZaOwogICAgICAgIH0KICAgICAgICB3aGlsZSAobiAmJiBuLnogPD0gbWF4WikgewogICAgICAgICAgaWYgKG4ueCA+PSB4MCAmJiBuLnggPD0geDEgJiYgbi55ID49IHkwICYmIG4ueSA8PSB5MSAmJiBuICE9PSBhMyAmJiBuICE9PSBjICYmIHBvaW50SW5UcmlhbmdsZShheCwgYXksIGJ4LCBieSwgY3gsIGN5LCBuLngsIG4ueSkgJiYgYXJlYShuLnByZXYsIG4sIG4ubmV4dCkgPj0gMCkKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgbiA9IG4ubmV4dFo7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGN1cmVMb2NhbEludGVyc2VjdGlvbnMoc3RhcnQsIHRyaWFuZ2xlcywgZGltKSB7CiAgICAgICAgdmFyIHAgPSBzdGFydDsKICAgICAgICBkbyB7CiAgICAgICAgICB2YXIgYTMgPSBwLnByZXYsIGIgPSBwLm5leHQubmV4dDsKICAgICAgICAgIGlmICghZXF1YWxzKGEzLCBiKSAmJiBpbnRlcnNlY3RzKGEzLCBwLCBwLm5leHQsIGIpICYmIGxvY2FsbHlJbnNpZGUoYTMsIGIpICYmIGxvY2FsbHlJbnNpZGUoYiwgYTMpKSB7CiAgICAgICAgICAgIHRyaWFuZ2xlcy5wdXNoKGEzLmkgLyBkaW0gfCAwKTsKICAgICAgICAgICAgdHJpYW5nbGVzLnB1c2gocC5pIC8gZGltIHwgMCk7CiAgICAgICAgICAgIHRyaWFuZ2xlcy5wdXNoKGIuaSAvIGRpbSB8IDApOwogICAgICAgICAgICByZW1vdmVOb2RlKHApOwogICAgICAgICAgICByZW1vdmVOb2RlKHAubmV4dCk7CiAgICAgICAgICAgIHAgPSBzdGFydCA9IGI7CiAgICAgICAgICB9CiAgICAgICAgICBwID0gcC5uZXh0OwogICAgICAgIH0gd2hpbGUgKHAgIT09IHN0YXJ0KTsKICAgICAgICByZXR1cm4gZmlsdGVyUG9pbnRzKHApOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHNwbGl0RWFyY3V0KHN0YXJ0LCB0cmlhbmdsZXMsIGRpbSwgbWluWCwgbWluWSwgaW52U2l6ZSkgewogICAgICAgIHZhciBhMyA9IHN0YXJ0OwogICAgICAgIGRvIHsKICAgICAgICAgIHZhciBiID0gYTMubmV4dC5uZXh0OwogICAgICAgICAgd2hpbGUgKGIgIT09IGEzLnByZXYpIHsKICAgICAgICAgICAgaWYgKGEzLmkgIT09IGIuaSAmJiBpc1ZhbGlkRGlhZ29uYWwoYTMsIGIpKSB7CiAgICAgICAgICAgICAgdmFyIGMgPSBzcGxpdFBvbHlnb24oYTMsIGIpOwogICAgICAgICAgICAgIGEzID0gZmlsdGVyUG9pbnRzKGEzLCBhMy5uZXh0KTsKICAgICAgICAgICAgICBjID0gZmlsdGVyUG9pbnRzKGMsIGMubmV4dCk7CiAgICAgICAgICAgICAgZWFyY3V0TGlua2VkKGEzLCB0cmlhbmdsZXMsIGRpbSwgbWluWCwgbWluWSwgaW52U2l6ZSwgMCk7CiAgICAgICAgICAgICAgZWFyY3V0TGlua2VkKGMsIHRyaWFuZ2xlcywgZGltLCBtaW5YLCBtaW5ZLCBpbnZTaXplLCAwKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYiA9IGIubmV4dDsKICAgICAgICAgIH0KICAgICAgICAgIGEzID0gYTMubmV4dDsKICAgICAgICB9IHdoaWxlIChhMyAhPT0gc3RhcnQpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGVsaW1pbmF0ZUhvbGVzKGRhdGEsIGhvbGVJbmRpY2VzLCBvdXRlck5vZGUsIGRpbSkgewogICAgICAgIHZhciBxdWV1ZSA9IFtdLCBpLCBsZW4sIHN0YXJ0LCBlbmQsIGxpc3Q7CiAgICAgICAgZm9yIChpID0gMCwgbGVuID0gaG9sZUluZGljZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIHN0YXJ0ID0gaG9sZUluZGljZXNbaV0gKiBkaW07CiAgICAgICAgICBlbmQgPSBpIDwgbGVuIC0gMSA/IGhvbGVJbmRpY2VzW2kgKyAxXSAqIGRpbSA6IGRhdGEubGVuZ3RoOwogICAgICAgICAgbGlzdCA9IGxpbmtlZExpc3QoZGF0YSwgc3RhcnQsIGVuZCwgZGltLCBmYWxzZSk7CiAgICAgICAgICBpZiAobGlzdCA9PT0gbGlzdC5uZXh0KQogICAgICAgICAgICBsaXN0LnN0ZWluZXIgPSB0cnVlOwogICAgICAgICAgcXVldWUucHVzaChnZXRMZWZ0bW9zdChsaXN0KSk7CiAgICAgICAgfQogICAgICAgIHF1ZXVlLnNvcnQoY29tcGFyZVgpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBxdWV1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgb3V0ZXJOb2RlID0gZWxpbWluYXRlSG9sZShxdWV1ZVtpXSwgb3V0ZXJOb2RlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG91dGVyTm9kZTsKICAgICAgfQogICAgICBmdW5jdGlvbiBjb21wYXJlWChhMywgYikgewogICAgICAgIHJldHVybiBhMy54IC0gYi54OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGVsaW1pbmF0ZUhvbGUoaG9sZSwgb3V0ZXJOb2RlKSB7CiAgICAgICAgdmFyIGJyaWRnZSA9IGZpbmRIb2xlQnJpZGdlKGhvbGUsIG91dGVyTm9kZSk7CiAgICAgICAgaWYgKCFicmlkZ2UpIHsKICAgICAgICAgIHJldHVybiBvdXRlck5vZGU7CiAgICAgICAgfQogICAgICAgIHZhciBicmlkZ2VSZXZlcnNlID0gc3BsaXRQb2x5Z29uKGJyaWRnZSwgaG9sZSk7CiAgICAgICAgZmlsdGVyUG9pbnRzKGJyaWRnZVJldmVyc2UsIGJyaWRnZVJldmVyc2UubmV4dCk7CiAgICAgICAgcmV0dXJuIGZpbHRlclBvaW50cyhicmlkZ2UsIGJyaWRnZS5uZXh0KTsKICAgICAgfQogICAgICBmdW5jdGlvbiBmaW5kSG9sZUJyaWRnZShob2xlLCBvdXRlck5vZGUpIHsKICAgICAgICB2YXIgcCA9IG91dGVyTm9kZSwgaHggPSBob2xlLngsIGh5ID0gaG9sZS55LCBxeCA9IC1JbmZpbml0eSwgbTsKICAgICAgICBkbyB7CiAgICAgICAgICBpZiAoaHkgPD0gcC55ICYmIGh5ID49IHAubmV4dC55ICYmIHAubmV4dC55ICE9PSBwLnkpIHsKICAgICAgICAgICAgdmFyIHggPSBwLnggKyAoaHkgLSBwLnkpICogKHAubmV4dC54IC0gcC54KSAvIChwLm5leHQueSAtIHAueSk7CiAgICAgICAgICAgIGlmICh4IDw9IGh4ICYmIHggPiBxeCkgewogICAgICAgICAgICAgIHF4ID0geDsKICAgICAgICAgICAgICBtID0gcC54IDwgcC5uZXh0LnggPyBwIDogcC5uZXh0OwogICAgICAgICAgICAgIGlmICh4ID09PSBoeCkKICAgICAgICAgICAgICAgIHJldHVybiBtOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBwID0gcC5uZXh0OwogICAgICAgIH0gd2hpbGUgKHAgIT09IG91dGVyTm9kZSk7CiAgICAgICAgaWYgKCFtKQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgdmFyIHN0b3AgPSBtLCBteCA9IG0ueCwgbXkgPSBtLnksIHRhbk1pbiA9IEluZmluaXR5LCB0YW47CiAgICAgICAgcCA9IG07CiAgICAgICAgZG8gewogICAgICAgICAgaWYgKGh4ID49IHAueCAmJiBwLnggPj0gbXggJiYgaHggIT09IHAueCAmJiBwb2ludEluVHJpYW5nbGUoaHkgPCBteSA/IGh4IDogcXgsIGh5LCBteCwgbXksIGh5IDwgbXkgPyBxeCA6IGh4LCBoeSwgcC54LCBwLnkpKSB7CiAgICAgICAgICAgIHRhbiA9IE1hdGguYWJzKGh5IC0gcC55KSAvIChoeCAtIHAueCk7CiAgICAgICAgICAgIGlmIChsb2NhbGx5SW5zaWRlKHAsIGhvbGUpICYmICh0YW4gPCB0YW5NaW4gfHwgdGFuID09PSB0YW5NaW4gJiYgKHAueCA+IG0ueCB8fCBwLnggPT09IG0ueCAmJiBzZWN0b3JDb250YWluc1NlY3RvcihtLCBwKSkpKSB7CiAgICAgICAgICAgICAgbSA9IHA7CiAgICAgICAgICAgICAgdGFuTWluID0gdGFuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBwID0gcC5uZXh0OwogICAgICAgIH0gd2hpbGUgKHAgIT09IHN0b3ApOwogICAgICAgIHJldHVybiBtOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHNlY3RvckNvbnRhaW5zU2VjdG9yKG0sIHApIHsKICAgICAgICByZXR1cm4gYXJlYShtLnByZXYsIG0sIHAucHJldikgPCAwICYmIGFyZWEocC5uZXh0LCBtLCBtLm5leHQpIDwgMDsKICAgICAgfQogICAgICBmdW5jdGlvbiBpbmRleEN1cnZlKHN0YXJ0LCBtaW5YLCBtaW5ZLCBpbnZTaXplKSB7CiAgICAgICAgdmFyIHAgPSBzdGFydDsKICAgICAgICBkbyB7CiAgICAgICAgICBpZiAocC56ID09PSAwKQogICAgICAgICAgICBwLnogPSB6T3JkZXIocC54LCBwLnksIG1pblgsIG1pblksIGludlNpemUpOwogICAgICAgICAgcC5wcmV2WiA9IHAucHJldjsKICAgICAgICAgIHAubmV4dFogPSBwLm5leHQ7CiAgICAgICAgICBwID0gcC5uZXh0OwogICAgICAgIH0gd2hpbGUgKHAgIT09IHN0YXJ0KTsKICAgICAgICBwLnByZXZaLm5leHRaID0gbnVsbDsKICAgICAgICBwLnByZXZaID0gbnVsbDsKICAgICAgICBzb3J0TGlua2VkKHApOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHNvcnRMaW5rZWQobGlzdCkgewogICAgICAgIHZhciBpLCBwLCBxLCBlLCB0YWlsLCBudW1NZXJnZXMsIHBTaXplLCBxU2l6ZSwgaW5TaXplID0gMTsKICAgICAgICBkbyB7CiAgICAgICAgICBwID0gbGlzdDsKICAgICAgICAgIGxpc3QgPSBudWxsOwogICAgICAgICAgdGFpbCA9IG51bGw7CiAgICAgICAgICBudW1NZXJnZXMgPSAwOwogICAgICAgICAgd2hpbGUgKHApIHsKICAgICAgICAgICAgbnVtTWVyZ2VzKys7CiAgICAgICAgICAgIHEgPSBwOwogICAgICAgICAgICBwU2l6ZSA9IDA7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBpblNpemU7IGkrKykgewogICAgICAgICAgICAgIHBTaXplKys7CiAgICAgICAgICAgICAgcSA9IHEubmV4dFo7CiAgICAgICAgICAgICAgaWYgKCFxKQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcVNpemUgPSBpblNpemU7CiAgICAgICAgICAgIHdoaWxlIChwU2l6ZSA+IDAgfHwgcVNpemUgPiAwICYmIHEpIHsKICAgICAgICAgICAgICBpZiAocFNpemUgIT09IDAgJiYgKHFTaXplID09PSAwIHx8ICFxIHx8IHAueiA8PSBxLnopKSB7CiAgICAgICAgICAgICAgICBlID0gcDsKICAgICAgICAgICAgICAgIHAgPSBwLm5leHRaOwogICAgICAgICAgICAgICAgcFNpemUtLTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZSA9IHE7CiAgICAgICAgICAgICAgICBxID0gcS5uZXh0WjsKICAgICAgICAgICAgICAgIHFTaXplLS07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0YWlsKQogICAgICAgICAgICAgICAgdGFpbC5uZXh0WiA9IGU7CiAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgbGlzdCA9IGU7CiAgICAgICAgICAgICAgZS5wcmV2WiA9IHRhaWw7CiAgICAgICAgICAgICAgdGFpbCA9IGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcCA9IHE7CiAgICAgICAgICB9CiAgICAgICAgICB0YWlsLm5leHRaID0gbnVsbDsKICAgICAgICAgIGluU2l6ZSAqPSAyOwogICAgICAgIH0gd2hpbGUgKG51bU1lcmdlcyA+IDEpOwogICAgICAgIHJldHVybiBsaXN0OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHpPcmRlcih4LCB5LCBtaW5YLCBtaW5ZLCBpbnZTaXplKSB7CiAgICAgICAgeCA9ICh4IC0gbWluWCkgKiBpbnZTaXplIHwgMDsKICAgICAgICB5ID0gKHkgLSBtaW5ZKSAqIGludlNpemUgfCAwOwogICAgICAgIHggPSAoeCB8IHggPDwgOCkgJiAxNjcxMTkzNTsKICAgICAgICB4ID0gKHggfCB4IDw8IDQpICYgMjUyNjQ1MTM1OwogICAgICAgIHggPSAoeCB8IHggPDwgMikgJiA4NTg5OTM0NTk7CiAgICAgICAgeCA9ICh4IHwgeCA8PCAxKSAmIDE0MzE2NTU3NjU7CiAgICAgICAgeSA9ICh5IHwgeSA8PCA4KSAmIDE2NzExOTM1OwogICAgICAgIHkgPSAoeSB8IHkgPDwgNCkgJiAyNTI2NDUxMzU7CiAgICAgICAgeSA9ICh5IHwgeSA8PCAyKSAmIDg1ODk5MzQ1OTsKICAgICAgICB5ID0gKHkgfCB5IDw8IDEpICYgMTQzMTY1NTc2NTsKICAgICAgICByZXR1cm4geCB8IHkgPDwgMTsKICAgICAgfQogICAgICBmdW5jdGlvbiBnZXRMZWZ0bW9zdChzdGFydCkgewogICAgICAgIHZhciBwID0gc3RhcnQsIGxlZnRtb3N0ID0gc3RhcnQ7CiAgICAgICAgZG8gewogICAgICAgICAgaWYgKHAueCA8IGxlZnRtb3N0LnggfHwgcC54ID09PSBsZWZ0bW9zdC54ICYmIHAueSA8IGxlZnRtb3N0LnkpCiAgICAgICAgICAgIGxlZnRtb3N0ID0gcDsKICAgICAgICAgIHAgPSBwLm5leHQ7CiAgICAgICAgfSB3aGlsZSAocCAhPT0gc3RhcnQpOwogICAgICAgIHJldHVybiBsZWZ0bW9zdDsKICAgICAgfQogICAgICBmdW5jdGlvbiBwb2ludEluVHJpYW5nbGUoYXgsIGF5LCBieCwgYnksIGN4LCBjeSwgcHgsIHB5KSB7CiAgICAgICAgcmV0dXJuIChjeCAtIHB4KSAqIChheSAtIHB5KSA+PSAoYXggLSBweCkgKiAoY3kgLSBweSkgJiYgKGF4IC0gcHgpICogKGJ5IC0gcHkpID49IChieCAtIHB4KSAqIChheSAtIHB5KSAmJiAoYnggLSBweCkgKiAoY3kgLSBweSkgPj0gKGN4IC0gcHgpICogKGJ5IC0gcHkpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGlzVmFsaWREaWFnb25hbChhMywgYikgewogICAgICAgIHJldHVybiBhMy5uZXh0LmkgIT09IGIuaSAmJiBhMy5wcmV2LmkgIT09IGIuaSAmJiAhaW50ZXJzZWN0c1BvbHlnb24oYTMsIGIpICYmIC8vIGRvbmVzJ3QgaW50ZXJzZWN0IG90aGVyIGVkZ2VzCiAgICAgICAgKGxvY2FsbHlJbnNpZGUoYTMsIGIpICYmIGxvY2FsbHlJbnNpZGUoYiwgYTMpICYmIG1pZGRsZUluc2lkZShhMywgYikgJiYgLy8gbG9jYWxseSB2aXNpYmxlCiAgICAgICAgKGFyZWEoYTMucHJldiwgYTMsIGIucHJldikgfHwgYXJlYShhMywgYi5wcmV2LCBiKSkgfHwgLy8gZG9lcyBub3QgY3JlYXRlIG9wcG9zaXRlLWZhY2luZyBzZWN0b3JzCiAgICAgICAgZXF1YWxzKGEzLCBiKSAmJiBhcmVhKGEzLnByZXYsIGEzLCBhMy5uZXh0KSA+IDAgJiYgYXJlYShiLnByZXYsIGIsIGIubmV4dCkgPiAwKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBhcmVhKHAsIHEsIHIpIHsKICAgICAgICByZXR1cm4gKHEueSAtIHAueSkgKiAoci54IC0gcS54KSAtIChxLnggLSBwLngpICogKHIueSAtIHEueSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZXF1YWxzKHAxLCBwMikgewogICAgICAgIHJldHVybiBwMS54ID09PSBwMi54ICYmIHAxLnkgPT09IHAyLnk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaW50ZXJzZWN0cyhwMSwgcTEyLCBwMiwgcTIyKSB7CiAgICAgICAgdmFyIG8xID0gc2lnbjIoYXJlYShwMSwgcTEyLCBwMikpOwogICAgICAgIHZhciBvMiA9IHNpZ24yKGFyZWEocDEsIHExMiwgcTIyKSk7CiAgICAgICAgdmFyIG8zID0gc2lnbjIoYXJlYShwMiwgcTIyLCBwMSkpOwogICAgICAgIHZhciBvNCA9IHNpZ24yKGFyZWEocDIsIHEyMiwgcTEyKSk7CiAgICAgICAgaWYgKG8xICE9PSBvMiAmJiBvMyAhPT0gbzQpCiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICBpZiAobzEgPT09IDAgJiYgb25TZWdtZW50KHAxLCBwMiwgcTEyKSkKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIGlmIChvMiA9PT0gMCAmJiBvblNlZ21lbnQocDEsIHEyMiwgcTEyKSkKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIGlmIChvMyA9PT0gMCAmJiBvblNlZ21lbnQocDIsIHAxLCBxMjIpKQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgaWYgKG80ID09PSAwICYmIG9uU2VnbWVudChwMiwgcTEyLCBxMjIpKQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIG9uU2VnbWVudChwLCBxLCByKSB7CiAgICAgICAgcmV0dXJuIHEueCA8PSBNYXRoLm1heChwLngsIHIueCkgJiYgcS54ID49IE1hdGgubWluKHAueCwgci54KSAmJiBxLnkgPD0gTWF0aC5tYXgocC55LCByLnkpICYmIHEueSA+PSBNYXRoLm1pbihwLnksIHIueSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc2lnbjIobnVtKSB7CiAgICAgICAgcmV0dXJuIG51bSA+IDAgPyAxIDogbnVtIDwgMCA/IC0xIDogMDsKICAgICAgfQogICAgICBmdW5jdGlvbiBpbnRlcnNlY3RzUG9seWdvbihhMywgYikgewogICAgICAgIHZhciBwID0gYTM7CiAgICAgICAgZG8gewogICAgICAgICAgaWYgKHAuaSAhPT0gYTMuaSAmJiBwLm5leHQuaSAhPT0gYTMuaSAmJiBwLmkgIT09IGIuaSAmJiBwLm5leHQuaSAhPT0gYi5pICYmIGludGVyc2VjdHMocCwgcC5uZXh0LCBhMywgYikpCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgcCA9IHAubmV4dDsKICAgICAgICB9IHdoaWxlIChwICE9PSBhMyk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGxvY2FsbHlJbnNpZGUoYTMsIGIpIHsKICAgICAgICByZXR1cm4gYXJlYShhMy5wcmV2LCBhMywgYTMubmV4dCkgPCAwID8gYXJlYShhMywgYiwgYTMubmV4dCkgPj0gMCAmJiBhcmVhKGEzLCBhMy5wcmV2LCBiKSA+PSAwIDogYXJlYShhMywgYiwgYTMucHJldikgPCAwIHx8IGFyZWEoYTMsIGEzLm5leHQsIGIpIDwgMDsKICAgICAgfQogICAgICBmdW5jdGlvbiBtaWRkbGVJbnNpZGUoYTMsIGIpIHsKICAgICAgICB2YXIgcCA9IGEzLCBpbnNpZGUgPSBmYWxzZSwgcHggPSAoYTMueCArIGIueCkgLyAyLCBweSA9IChhMy55ICsgYi55KSAvIDI7CiAgICAgICAgZG8gewogICAgICAgICAgaWYgKHAueSA+IHB5ICE9PSBwLm5leHQueSA+IHB5ICYmIHAubmV4dC55ICE9PSBwLnkgJiYgcHggPCAocC5uZXh0LnggLSBwLngpICogKHB5IC0gcC55KSAvIChwLm5leHQueSAtIHAueSkgKyBwLngpCiAgICAgICAgICAgIGluc2lkZSA9ICFpbnNpZGU7CiAgICAgICAgICBwID0gcC5uZXh0OwogICAgICAgIH0gd2hpbGUgKHAgIT09IGEzKTsKICAgICAgICByZXR1cm4gaW5zaWRlOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHNwbGl0UG9seWdvbihhMywgYikgewogICAgICAgIHZhciBhMjIgPSBuZXcgTm9kZShhMy5pLCBhMy54LCBhMy55KSwgYjIgPSBuZXcgTm9kZShiLmksIGIueCwgYi55KSwgYW4gPSBhMy5uZXh0LCBicCA9IGIucHJldjsKICAgICAgICBhMy5uZXh0ID0gYjsKICAgICAgICBiLnByZXYgPSBhMzsKICAgICAgICBhMjIubmV4dCA9IGFuOwogICAgICAgIGFuLnByZXYgPSBhMjI7CiAgICAgICAgYjIubmV4dCA9IGEyMjsKICAgICAgICBhMjIucHJldiA9IGIyOwogICAgICAgIGJwLm5leHQgPSBiMjsKICAgICAgICBiMi5wcmV2ID0gYnA7CiAgICAgICAgcmV0dXJuIGIyOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGluc2VydE5vZGUoaSwgeCwgeSwgbGFzdCkgewogICAgICAgIHZhciBwID0gbmV3IE5vZGUoaSwgeCwgeSk7CiAgICAgICAgaWYgKCFsYXN0KSB7CiAgICAgICAgICBwLnByZXYgPSBwOwogICAgICAgICAgcC5uZXh0ID0gcDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcC5uZXh0ID0gbGFzdC5uZXh0OwogICAgICAgICAgcC5wcmV2ID0gbGFzdDsKICAgICAgICAgIGxhc3QubmV4dC5wcmV2ID0gcDsKICAgICAgICAgIGxhc3QubmV4dCA9IHA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHJlbW92ZU5vZGUocCkgewogICAgICAgIHAubmV4dC5wcmV2ID0gcC5wcmV2OwogICAgICAgIHAucHJldi5uZXh0ID0gcC5uZXh0OwogICAgICAgIGlmIChwLnByZXZaKQogICAgICAgICAgcC5wcmV2Wi5uZXh0WiA9IHAubmV4dFo7CiAgICAgICAgaWYgKHAubmV4dFopCiAgICAgICAgICBwLm5leHRaLnByZXZaID0gcC5wcmV2WjsKICAgICAgfQogICAgICBmdW5jdGlvbiBOb2RlKGksIHgsIHkpIHsKICAgICAgICB0aGlzLmkgPSBpOwogICAgICAgIHRoaXMueCA9IHg7CiAgICAgICAgdGhpcy55ID0geTsKICAgICAgICB0aGlzLnByZXYgPSBudWxsOwogICAgICAgIHRoaXMubmV4dCA9IG51bGw7CiAgICAgICAgdGhpcy56ID0gMDsKICAgICAgICB0aGlzLnByZXZaID0gbnVsbDsKICAgICAgICB0aGlzLm5leHRaID0gbnVsbDsKICAgICAgICB0aGlzLnN0ZWluZXIgPSBmYWxzZTsKICAgICAgfQogICAgICBlYXJjdXQyLmRldmlhdGlvbiA9IGZ1bmN0aW9uKGRhdGEsIGhvbGVJbmRpY2VzLCBkaW0sIHRyaWFuZ2xlcykgewogICAgICAgIHZhciBoYXNIb2xlcyA9IGhvbGVJbmRpY2VzICYmIGhvbGVJbmRpY2VzLmxlbmd0aDsKICAgICAgICB2YXIgb3V0ZXJMZW4gPSBoYXNIb2xlcyA/IGhvbGVJbmRpY2VzWzBdICogZGltIDogZGF0YS5sZW5ndGg7CiAgICAgICAgdmFyIHBvbHlnb25BcmVhID0gTWF0aC5hYnMoc2lnbmVkQXJlYShkYXRhLCAwLCBvdXRlckxlbiwgZGltKSk7CiAgICAgICAgaWYgKGhhc0hvbGVzKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gaG9sZUluZGljZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gaG9sZUluZGljZXNbaV0gKiBkaW07CiAgICAgICAgICAgIHZhciBlbmQgPSBpIDwgbGVuIC0gMSA/IGhvbGVJbmRpY2VzW2kgKyAxXSAqIGRpbSA6IGRhdGEubGVuZ3RoOwogICAgICAgICAgICBwb2x5Z29uQXJlYSAtPSBNYXRoLmFicyhzaWduZWRBcmVhKGRhdGEsIHN0YXJ0LCBlbmQsIGRpbSkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgdHJpYW5nbGVzQXJlYSA9IDA7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHRyaWFuZ2xlcy5sZW5ndGg7IGkgKz0gMykgewogICAgICAgICAgdmFyIGEzID0gdHJpYW5nbGVzW2ldICogZGltOwogICAgICAgICAgdmFyIGIgPSB0cmlhbmdsZXNbaSArIDFdICogZGltOwogICAgICAgICAgdmFyIGMgPSB0cmlhbmdsZXNbaSArIDJdICogZGltOwogICAgICAgICAgdHJpYW5nbGVzQXJlYSArPSBNYXRoLmFicygKICAgICAgICAgICAgKGRhdGFbYTNdIC0gZGF0YVtjXSkgKiAoZGF0YVtiICsgMV0gLSBkYXRhW2EzICsgMV0pIC0gKGRhdGFbYTNdIC0gZGF0YVtiXSkgKiAoZGF0YVtjICsgMV0gLSBkYXRhW2EzICsgMV0pCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcG9seWdvbkFyZWEgPT09IDAgJiYgdHJpYW5nbGVzQXJlYSA9PT0gMCA/IDAgOiBNYXRoLmFicygodHJpYW5nbGVzQXJlYSAtIHBvbHlnb25BcmVhKSAvIHBvbHlnb25BcmVhKTsKICAgICAgfTsKICAgICAgZnVuY3Rpb24gc2lnbmVkQXJlYShkYXRhLCBzdGFydCwgZW5kLCBkaW0pIHsKICAgICAgICB2YXIgc3VtID0gMDsKICAgICAgICBmb3IgKHZhciBpID0gc3RhcnQsIGogPSBlbmQgLSBkaW07IGkgPCBlbmQ7IGkgKz0gZGltKSB7CiAgICAgICAgICBzdW0gKz0gKGRhdGFbal0gLSBkYXRhW2ldKSAqIChkYXRhW2kgKyAxXSArIGRhdGFbaiArIDFdKTsKICAgICAgICAgIGogPSBpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3VtOwogICAgICB9CiAgICAgIGVhcmN1dDIuZmxhdHRlbiA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICB2YXIgZGltID0gZGF0YVswXVswXS5sZW5ndGgsIHJlc3VsdCA9IHsgdmVydGljZXM6IFtdLCBob2xlczogW10sIGRpbWVuc2lvbnM6IGRpbSB9LCBob2xlSW5kZXggPSAwOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBkYXRhW2ldLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgIGZvciAodmFyIGQgPSAwOyBkIDwgZGltOyBkKyspCiAgICAgICAgICAgICAgcmVzdWx0LnZlcnRpY2VzLnB1c2goZGF0YVtpXVtqXVtkXSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaSA+IDApIHsKICAgICAgICAgICAgaG9sZUluZGV4ICs9IGRhdGFbaSAtIDFdLmxlbmd0aDsKICAgICAgICAgICAgcmVzdWx0LmhvbGVzLnB1c2goaG9sZUluZGV4KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1dpbmRpbmdPcmRlci5qcwogIHZhciBXaW5kaW5nT3JkZXIsIFdpbmRpbmdPcmRlcl9kZWZhdWx0OwogIHZhciBpbml0X1dpbmRpbmdPcmRlciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvV2luZGluZ09yZGVyLmpzIigpIHsKICAgICAgaW5pdF9XZWJHTENvbnN0YW50cygpOwogICAgICBXaW5kaW5nT3JkZXIgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogVmVydGljZXMgYXJlIGluIGNsb2Nrd2lzZSBvcmRlci4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgQ0xPQ0tXSVNFOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkNXLAogICAgICAgIC8qKgogICAgICAgICAqIFZlcnRpY2VzIGFyZSBpbiBjb3VudGVyLWNsb2Nrd2lzZSBvcmRlci4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgQ09VTlRFUl9DTE9DS1dJU0U6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ0NXCiAgICAgIH07CiAgICAgIFdpbmRpbmdPcmRlci52YWxpZGF0ZSA9IGZ1bmN0aW9uKHdpbmRpbmdPcmRlcikgewogICAgICAgIHJldHVybiB3aW5kaW5nT3JkZXIgPT09IFdpbmRpbmdPcmRlci5DTE9DS1dJU0UgfHwgd2luZGluZ09yZGVyID09PSBXaW5kaW5nT3JkZXIuQ09VTlRFUl9DTE9DS1dJU0U7CiAgICAgIH07CiAgICAgIFdpbmRpbmdPcmRlcl9kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShXaW5kaW5nT3JkZXIpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWdvblBpcGVsaW5lLmpzCiAgdmFyIGltcG9ydF9lYXJjdXQsIHNjYWxlVG9HZW9kZXRpY0hlaWdodE4sIHNjYWxlVG9HZW9kZXRpY0hlaWdodFAsIFBvbHlnb25QaXBlbGluZSwgc3ViZGl2aXNpb25WMFNjcmF0Y2gsIHN1YmRpdmlzaW9uVjFTY3JhdGNoLCBzdWJkaXZpc2lvblYyU2NyYXRjaCwgc3ViZGl2aXNpb25TMFNjcmF0Y2gsIHN1YmRpdmlzaW9uUzFTY3JhdGNoLCBzdWJkaXZpc2lvblMyU2NyYXRjaCwgc3ViZGl2aXNpb25NaWRTY3JhdGNoLCBzdWJkaXZpc2lvblQwU2NyYXRjaCwgc3ViZGl2aXNpb25UMVNjcmF0Y2gsIHN1YmRpdmlzaW9uVDJTY3JhdGNoLCBzdWJkaXZpc2lvblRleGNvb3JkTWlkU2NyYXRjaCwgc3ViZGl2aXNpb25DMFNjcmF0Y2gsIHN1YmRpdmlzaW9uQzFTY3JhdGNoLCBzdWJkaXZpc2lvbkMyU2NyYXRjaCwgc3ViZGl2aXNpb25DYXJ0b2dyYXBoaWNTY3JhdGNoLCBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdDsKICB2YXIgaW5pdF9Qb2x5Z29uUGlwZWxpbmUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlnb25QaXBlbGluZS5qcyIoKSB7CiAgICAgIGltcG9ydF9lYXJjdXQgPSBfX3RvRVNNKHJlcXVpcmVfZWFyY3V0KCksIDEpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRSaHVtYkxpbmUoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9XaW5kaW5nT3JkZXIoKTsKICAgICAgc2NhbGVUb0dlb2RldGljSGVpZ2h0TiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NhbGVUb0dlb2RldGljSGVpZ2h0UCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgUG9seWdvblBpcGVsaW5lID0ge307CiAgICAgIFBvbHlnb25QaXBlbGluZS5jb21wdXRlQXJlYTJEID0gZnVuY3Rpb24ocG9zaXRpb25zKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJwb3NpdGlvbnMiLCBwb3NpdGlvbnMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKAogICAgICAgICAgInBvc2l0aW9ucy5sZW5ndGgiLAogICAgICAgICAgcG9zaXRpb25zLmxlbmd0aCwKICAgICAgICAgIDMKICAgICAgICApOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgbGV0IGFyZWEgPSAwOwogICAgICAgIGZvciAobGV0IGkwID0gbGVuZ3RoIC0gMSwgaTEgPSAwOyBpMSA8IGxlbmd0aDsgaTAgPSBpMSsrKSB7CiAgICAgICAgICBjb25zdCB2MDIgPSBwb3NpdGlvbnNbaTBdOwogICAgICAgICAgY29uc3QgdjEyID0gcG9zaXRpb25zW2kxXTsKICAgICAgICAgIGFyZWEgKz0gdjAyLnggKiB2MTIueSAtIHYxMi54ICogdjAyLnk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhcmVhICogMC41OwogICAgICB9OwogICAgICBQb2x5Z29uUGlwZWxpbmUuY29tcHV0ZVdpbmRpbmdPcmRlcjJEID0gZnVuY3Rpb24ocG9zaXRpb25zKSB7CiAgICAgICAgY29uc3QgYXJlYSA9IFBvbHlnb25QaXBlbGluZS5jb21wdXRlQXJlYTJEKHBvc2l0aW9ucyk7CiAgICAgICAgcmV0dXJuIGFyZWEgPiAwID8gV2luZGluZ09yZGVyX2RlZmF1bHQuQ09VTlRFUl9DTE9DS1dJU0UgOiBXaW5kaW5nT3JkZXJfZGVmYXVsdC5DTE9DS1dJU0U7CiAgICAgIH07CiAgICAgIFBvbHlnb25QaXBlbGluZS50cmlhbmd1bGF0ZSA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgaG9sZXMpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInBvc2l0aW9ucyIsIHBvc2l0aW9ucyk7CiAgICAgICAgY29uc3QgZmxhdHRlbmVkUG9zaXRpb25zID0gQ2FydGVzaWFuMl9kZWZhdWx0LnBhY2tBcnJheShwb3NpdGlvbnMpOwogICAgICAgIHJldHVybiAoMCwgaW1wb3J0X2VhcmN1dC5kZWZhdWx0KShmbGF0dGVuZWRQb3NpdGlvbnMsIGhvbGVzLCAyKTsKICAgICAgfTsKICAgICAgc3ViZGl2aXNpb25WMFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHN1YmRpdmlzaW9uVjFTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzdWJkaXZpc2lvblYyU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc3ViZGl2aXNpb25TMFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHN1YmRpdmlzaW9uUzFTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzdWJkaXZpc2lvblMyU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc3ViZGl2aXNpb25NaWRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzdWJkaXZpc2lvblQwU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgc3ViZGl2aXNpb25UMVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIHN1YmRpdmlzaW9uVDJTY3JhdGNoID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBzdWJkaXZpc2lvblRleGNvb3JkTWlkU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgUG9seWdvblBpcGVsaW5lLmNvbXB1dGVTdWJkaXZpc2lvbiA9IGZ1bmN0aW9uKGVsbGlwc29pZCwgcG9zaXRpb25zLCBpbmRpY2VzLCB0ZXhjb29yZHMsIGdyYW51bGFyaXR5KSB7CiAgICAgICAgZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChncmFudWxhcml0eSwgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRSk7CiAgICAgICAgY29uc3QgaGFzVGV4Y29vcmRzID0gZGVmaW5lZF9kZWZhdWx0KHRleGNvb3Jkcyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJlbGxpcHNvaWQiLCBlbGxpcHNvaWQpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicG9zaXRpb25zIiwgcG9zaXRpb25zKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImluZGljZXMiLCBpbmRpY2VzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiaW5kaWNlcy5sZW5ndGgiLCBpbmRpY2VzLmxlbmd0aCwgMyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmVxdWFscygiaW5kaWNlcy5sZW5ndGggJSAzIiwgIjAiLCBpbmRpY2VzLmxlbmd0aCAlIDMsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbigiZ3JhbnVsYXJpdHkiLCBncmFudWxhcml0eSwgMCk7CiAgICAgICAgY29uc3QgdHJpYW5nbGVzID0gaW5kaWNlcy5zbGljZSgwKTsKICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGNvbnN0IHN1YmRpdmlkZWRQb3NpdGlvbnMgPSBuZXcgQXJyYXkobGVuZ3RoICogMyk7CiAgICAgICAgY29uc3Qgc3ViZGl2aWRlZFRleGNvb3JkcyA9IG5ldyBBcnJheShsZW5ndGggKiAyKTsKICAgICAgICBsZXQgcSA9IDA7CiAgICAgICAgbGV0IHAgPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgaXRlbSA9IHBvc2l0aW9uc1tpXTsKICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbcSsrXSA9IGl0ZW0ueDsKICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbcSsrXSA9IGl0ZW0ueTsKICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbcSsrXSA9IGl0ZW0uejsKICAgICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgICAgY29uc3QgdGV4Y29vcmRJdGVtID0gdGV4Y29vcmRzW2ldOwogICAgICAgICAgICBzdWJkaXZpZGVkVGV4Y29vcmRzW3ArK10gPSB0ZXhjb29yZEl0ZW0ueDsKICAgICAgICAgICAgc3ViZGl2aWRlZFRleGNvb3Jkc1twKytdID0gdGV4Y29vcmRJdGVtLnk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IHN1YmRpdmlkZWRJbmRpY2VzID0gW107CiAgICAgICAgY29uc3QgZWRnZXMgPSB7fTsKICAgICAgICBjb25zdCByYWRpdXMgPSBlbGxpcHNvaWQubWF4aW11bVJhZGl1czsKICAgICAgICBjb25zdCBtaW5EaXN0YW5jZSA9IE1hdGhfZGVmYXVsdC5jaG9yZExlbmd0aChncmFudWxhcml0eSwgcmFkaXVzKTsKICAgICAgICBjb25zdCBtaW5EaXN0YW5jZVNxcmQgPSBtaW5EaXN0YW5jZSAqIG1pbkRpc3RhbmNlOwogICAgICAgIHdoaWxlICh0cmlhbmdsZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgY29uc3QgaTIgPSB0cmlhbmdsZXMucG9wKCk7CiAgICAgICAgICBjb25zdCBpMSA9IHRyaWFuZ2xlcy5wb3AoKTsKICAgICAgICAgIGNvbnN0IGkwID0gdHJpYW5nbGVzLnBvcCgpOwogICAgICAgICAgY29uc3QgdjAyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucywKICAgICAgICAgICAgaTAgKiAzLAogICAgICAgICAgICBzdWJkaXZpc2lvblYwU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHYxMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMsCiAgICAgICAgICAgIGkxICogMywKICAgICAgICAgICAgc3ViZGl2aXNpb25WMVNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCB2MjIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLAogICAgICAgICAgICBpMiAqIDMsCiAgICAgICAgICAgIHN1YmRpdmlzaW9uVjJTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgbGV0IHQwLCB0MSwgdDI7CiAgICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICAgIHQwID0gQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgICBzdWJkaXZpZGVkVGV4Y29vcmRzLAogICAgICAgICAgICAgIGkwICogMiwKICAgICAgICAgICAgICBzdWJkaXZpc2lvblQwU2NyYXRjaAogICAgICAgICAgICApOwogICAgICAgICAgICB0MSA9IENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgICAgc3ViZGl2aWRlZFRleGNvb3JkcywKICAgICAgICAgICAgICBpMSAqIDIsCiAgICAgICAgICAgICAgc3ViZGl2aXNpb25UMVNjcmF0Y2gKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdDIgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHMsCiAgICAgICAgICAgICAgaTIgKiAyLAogICAgICAgICAgICAgIHN1YmRpdmlzaW9uVDJTY3JhdGNoCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBzMCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHYwMiwgc3ViZGl2aXNpb25TMFNjcmF0Y2gpLAogICAgICAgICAgICByYWRpdXMsCiAgICAgICAgICAgIHN1YmRpdmlzaW9uUzBTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgczEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSh2MTIsIHN1YmRpdmlzaW9uUzFTY3JhdGNoKSwKICAgICAgICAgICAgcmFkaXVzLAogICAgICAgICAgICBzdWJkaXZpc2lvblMxU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHMyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUodjIyLCBzdWJkaXZpc2lvblMyU2NyYXRjaCksCiAgICAgICAgICAgIHJhZGl1cywKICAgICAgICAgICAgc3ViZGl2aXNpb25TMlNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBnMCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoczAsIHMxLCBzdWJkaXZpc2lvbk1pZFNjcmF0Y2gpCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgZzEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCgKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHMxLCBzMiwgc3ViZGl2aXNpb25NaWRTY3JhdGNoKQogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IGcyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChzMiwgczAsIHN1YmRpdmlzaW9uTWlkU2NyYXRjaCkKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBtYXgzID0gTWF0aC5tYXgoZzAsIGcxLCBnMik7CiAgICAgICAgICBsZXQgZWRnZTsKICAgICAgICAgIGxldCBtaWQ7CiAgICAgICAgICBsZXQgbWlkVGV4Y29vcmQ7CiAgICAgICAgICBpZiAobWF4MyA+IG1pbkRpc3RhbmNlU3FyZCkgewogICAgICAgICAgICBpZiAoZzAgPT09IG1heDMpIHsKICAgICAgICAgICAgICBlZGdlID0gYCR7TWF0aC5taW4oaTAsIGkxKX0gJHtNYXRoLm1heChpMCwgaTEpfWA7CiAgICAgICAgICAgICAgaSA9IGVkZ2VzW2VkZ2VdOwogICAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGkpKSB7CiAgICAgICAgICAgICAgICBtaWQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHYwMiwgdjEyLCBzdWJkaXZpc2lvbk1pZFNjcmF0Y2gpOwogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobWlkLCAwLjUsIG1pZCk7CiAgICAgICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLnB1c2gobWlkLngsIG1pZC55LCBtaWQueik7CiAgICAgICAgICAgICAgICBpID0gc3ViZGl2aWRlZFBvc2l0aW9ucy5sZW5ndGggLyAzIC0gMTsKICAgICAgICAgICAgICAgIGVkZ2VzW2VkZ2VdID0gaTsKICAgICAgICAgICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgICAgICAgICAgbWlkVGV4Y29vcmQgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuYWRkKHQwLCB0MSwgc3ViZGl2aXNpb25UZXhjb29yZE1pZFNjcmF0Y2gpOwogICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihtaWRUZXhjb29yZCwgMC41LCBtaWRUZXhjb29yZCk7CiAgICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHMucHVzaChtaWRUZXhjb29yZC54LCBtaWRUZXhjb29yZC55KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdHJpYW5nbGVzLnB1c2goaTAsIGksIGkyKTsKICAgICAgICAgICAgICB0cmlhbmdsZXMucHVzaChpLCBpMSwgaTIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGcxID09PSBtYXgzKSB7CiAgICAgICAgICAgICAgZWRnZSA9IGAke01hdGgubWluKGkxLCBpMil9ICR7TWF0aC5tYXgoaTEsIGkyKX1gOwogICAgICAgICAgICAgIGkgPSBlZGdlc1tlZGdlXTsKICAgICAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpKSkgewogICAgICAgICAgICAgICAgbWlkID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCh2MTIsIHYyMiwgc3ViZGl2aXNpb25NaWRTY3JhdGNoKTsKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG1pZCwgMC41LCBtaWQpOwogICAgICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucy5wdXNoKG1pZC54LCBtaWQueSwgbWlkLnopOwogICAgICAgICAgICAgICAgaSA9IHN1YmRpdmlkZWRQb3NpdGlvbnMubGVuZ3RoIC8gMyAtIDE7CiAgICAgICAgICAgICAgICBlZGdlc1tlZGdlXSA9IGk7CiAgICAgICAgICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICAgICAgICAgIG1pZFRleGNvb3JkID0gQ2FydGVzaWFuMl9kZWZhdWx0LmFkZCh0MSwgdDIsIHN1YmRpdmlzaW9uVGV4Y29vcmRNaWRTY3JhdGNoKTsKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobWlkVGV4Y29vcmQsIDAuNSwgbWlkVGV4Y29vcmQpOwogICAgICAgICAgICAgICAgICBzdWJkaXZpZGVkVGV4Y29vcmRzLnB1c2gobWlkVGV4Y29vcmQueCwgbWlkVGV4Y29vcmQueSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRyaWFuZ2xlcy5wdXNoKGkxLCBpLCBpMCk7CiAgICAgICAgICAgICAgdHJpYW5nbGVzLnB1c2goaSwgaTIsIGkwKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChnMiA9PT0gbWF4MykgewogICAgICAgICAgICAgIGVkZ2UgPSBgJHtNYXRoLm1pbihpMiwgaTApfSAke01hdGgubWF4KGkyLCBpMCl9YDsKICAgICAgICAgICAgICBpID0gZWRnZXNbZWRnZV07CiAgICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaSkpIHsKICAgICAgICAgICAgICAgIG1pZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQodjIyLCB2MDIsIHN1YmRpdmlzaW9uTWlkU2NyYXRjaCk7CiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihtaWQsIDAuNSwgbWlkKTsKICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMucHVzaChtaWQueCwgbWlkLnksIG1pZC56KTsKICAgICAgICAgICAgICAgIGkgPSBzdWJkaXZpZGVkUG9zaXRpb25zLmxlbmd0aCAvIDMgLSAxOwogICAgICAgICAgICAgICAgZWRnZXNbZWRnZV0gPSBpOwogICAgICAgICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICAgICAgICBtaWRUZXhjb29yZCA9IENhcnRlc2lhbjJfZGVmYXVsdC5hZGQodDIsIHQwLCBzdWJkaXZpc2lvblRleGNvb3JkTWlkU2NyYXRjaCk7CiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG1pZFRleGNvb3JkLCAwLjUsIG1pZFRleGNvb3JkKTsKICAgICAgICAgICAgICAgICAgc3ViZGl2aWRlZFRleGNvb3Jkcy5wdXNoKG1pZFRleGNvb3JkLngsIG1pZFRleGNvb3JkLnkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0cmlhbmdsZXMucHVzaChpMiwgaSwgaTEpOwogICAgICAgICAgICAgIHRyaWFuZ2xlcy5wdXNoKGksIGkwLCBpMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN1YmRpdmlkZWRJbmRpY2VzLnB1c2goaTApOwogICAgICAgICAgICBzdWJkaXZpZGVkSW5kaWNlcy5wdXNoKGkxKTsKICAgICAgICAgICAgc3ViZGl2aWRlZEluZGljZXMucHVzaChpMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGdlb21ldHJ5T3B0aW9ucyA9IHsKICAgICAgICAgIGF0dHJpYnV0ZXM6IHsKICAgICAgICAgICAgcG9zaXRpb246IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IHN1YmRpdmlkZWRQb3NpdGlvbnMKICAgICAgICAgICAgfSkKICAgICAgICAgIH0sCiAgICAgICAgICBpbmRpY2VzOiBzdWJkaXZpZGVkSW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMKICAgICAgICB9OwogICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgIGdlb21ldHJ5T3B0aW9ucy5hdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICAgICAgdmFsdWVzOiBzdWJkaXZpZGVkVGV4Y29vcmRzCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KGdlb21ldHJ5T3B0aW9ucyk7CiAgICAgIH07CiAgICAgIHN1YmRpdmlzaW9uQzBTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHN1YmRpdmlzaW9uQzFTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHN1YmRpdmlzaW9uQzJTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHN1YmRpdmlzaW9uQ2FydG9ncmFwaGljU2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBQb2x5Z29uUGlwZWxpbmUuY29tcHV0ZVJodW1iTGluZVN1YmRpdmlzaW9uID0gZnVuY3Rpb24oZWxsaXBzb2lkLCBwb3NpdGlvbnMsIGluZGljZXMsIHRleGNvb3JkcywgZ3JhbnVsYXJpdHkpIHsKICAgICAgICBncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGdyYW51bGFyaXR5LCBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFKTsKICAgICAgICBjb25zdCBoYXNUZXhjb29yZHMgPSBkZWZpbmVkX2RlZmF1bHQodGV4Y29vcmRzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImVsbGlwc29pZCIsIGVsbGlwc29pZCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJwb3NpdGlvbnMiLCBwb3NpdGlvbnMpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiaW5kaWNlcyIsIGluZGljZXMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJpbmRpY2VzLmxlbmd0aCIsIGluZGljZXMubGVuZ3RoLCAzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZXF1YWxzKCJpbmRpY2VzLmxlbmd0aCAlIDMiLCAiMCIsIGluZGljZXMubGVuZ3RoICUgMywgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuKCJncmFudWxhcml0eSIsIGdyYW51bGFyaXR5LCAwKTsKICAgICAgICBjb25zdCB0cmlhbmdsZXMgPSBpbmRpY2VzLnNsaWNlKDApOwogICAgICAgIGxldCBpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgY29uc3Qgc3ViZGl2aWRlZFBvc2l0aW9ucyA9IG5ldyBBcnJheShsZW5ndGggKiAzKTsKICAgICAgICBjb25zdCBzdWJkaXZpZGVkVGV4Y29vcmRzID0gbmV3IEFycmF5KGxlbmd0aCAqIDIpOwogICAgICAgIGxldCBxID0gMDsKICAgICAgICBsZXQgcCA9IDA7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBpdGVtID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1txKytdID0gaXRlbS54OwogICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1txKytdID0gaXRlbS55OwogICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1txKytdID0gaXRlbS56OwogICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICBjb25zdCB0ZXhjb29yZEl0ZW0gPSB0ZXhjb29yZHNbaV07CiAgICAgICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHNbcCsrXSA9IHRleGNvb3JkSXRlbS54OwogICAgICAgICAgICBzdWJkaXZpZGVkVGV4Y29vcmRzW3ArK10gPSB0ZXhjb29yZEl0ZW0ueTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3Qgc3ViZGl2aWRlZEluZGljZXMgPSBbXTsKICAgICAgICBjb25zdCBlZGdlcyA9IHt9OwogICAgICAgIGNvbnN0IHJhZGl1cyA9IGVsbGlwc29pZC5tYXhpbXVtUmFkaXVzOwogICAgICAgIGNvbnN0IG1pbkRpc3RhbmNlID0gTWF0aF9kZWZhdWx0LmNob3JkTGVuZ3RoKGdyYW51bGFyaXR5LCByYWRpdXMpOwogICAgICAgIGNvbnN0IHJodW1iMCA9IG5ldyBFbGxpcHNvaWRSaHVtYkxpbmVfZGVmYXVsdCh2b2lkIDAsIHZvaWQgMCwgZWxsaXBzb2lkKTsKICAgICAgICBjb25zdCByaHVtYjEgPSBuZXcgRWxsaXBzb2lkUmh1bWJMaW5lX2RlZmF1bHQodm9pZCAwLCB2b2lkIDAsIGVsbGlwc29pZCk7CiAgICAgICAgY29uc3Qgcmh1bWIyID0gbmV3IEVsbGlwc29pZFJodW1iTGluZV9kZWZhdWx0KHZvaWQgMCwgdm9pZCAwLCBlbGxpcHNvaWQpOwogICAgICAgIHdoaWxlICh0cmlhbmdsZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgY29uc3QgaTIgPSB0cmlhbmdsZXMucG9wKCk7CiAgICAgICAgICBjb25zdCBpMSA9IHRyaWFuZ2xlcy5wb3AoKTsKICAgICAgICAgIGNvbnN0IGkwID0gdHJpYW5nbGVzLnBvcCgpOwogICAgICAgICAgY29uc3QgdjAyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucywKICAgICAgICAgICAgaTAgKiAzLAogICAgICAgICAgICBzdWJkaXZpc2lvblYwU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHYxMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMsCiAgICAgICAgICAgIGkxICogMywKICAgICAgICAgICAgc3ViZGl2aXNpb25WMVNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCB2MjIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLAogICAgICAgICAgICBpMiAqIDMsCiAgICAgICAgICAgIHN1YmRpdmlzaW9uVjJTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgbGV0IHQwLCB0MSwgdDI7CiAgICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICAgIHQwID0gQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgICBzdWJkaXZpZGVkVGV4Y29vcmRzLAogICAgICAgICAgICAgIGkwICogMiwKICAgICAgICAgICAgICBzdWJkaXZpc2lvblQwU2NyYXRjaAogICAgICAgICAgICApOwogICAgICAgICAgICB0MSA9IENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgICAgc3ViZGl2aWRlZFRleGNvb3JkcywKICAgICAgICAgICAgICBpMSAqIDIsCiAgICAgICAgICAgICAgc3ViZGl2aXNpb25UMVNjcmF0Y2gKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdDIgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHMsCiAgICAgICAgICAgICAgaTIgKiAyLAogICAgICAgICAgICAgIHN1YmRpdmlzaW9uVDJTY3JhdGNoCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBjMCA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyh2MDIsIHN1YmRpdmlzaW9uQzBTY3JhdGNoKTsKICAgICAgICAgIGNvbnN0IGMxID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHYxMiwgc3ViZGl2aXNpb25DMVNjcmF0Y2gpOwogICAgICAgICAgY29uc3QgYzIgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWModjIyLCBzdWJkaXZpc2lvbkMyU2NyYXRjaCk7CiAgICAgICAgICByaHVtYjAuc2V0RW5kUG9pbnRzKGMwLCBjMSk7CiAgICAgICAgICBjb25zdCBnMCA9IHJodW1iMC5zdXJmYWNlRGlzdGFuY2U7CiAgICAgICAgICByaHVtYjEuc2V0RW5kUG9pbnRzKGMxLCBjMik7CiAgICAgICAgICBjb25zdCBnMSA9IHJodW1iMS5zdXJmYWNlRGlzdGFuY2U7CiAgICAgICAgICByaHVtYjIuc2V0RW5kUG9pbnRzKGMyLCBjMCk7CiAgICAgICAgICBjb25zdCBnMiA9IHJodW1iMi5zdXJmYWNlRGlzdGFuY2U7CiAgICAgICAgICBjb25zdCBtYXgzID0gTWF0aC5tYXgoZzAsIGcxLCBnMik7CiAgICAgICAgICBsZXQgZWRnZTsKICAgICAgICAgIGxldCBtaWQ7CiAgICAgICAgICBsZXQgbWlkSGVpZ2h0OwogICAgICAgICAgbGV0IG1pZENhcnRlc2lhbjM7CiAgICAgICAgICBsZXQgbWlkVGV4Y29vcmQ7CiAgICAgICAgICBpZiAobWF4MyA+IG1pbkRpc3RhbmNlKSB7CiAgICAgICAgICAgIGlmIChnMCA9PT0gbWF4MykgewogICAgICAgICAgICAgIGVkZ2UgPSBgJHtNYXRoLm1pbihpMCwgaTEpfSAke01hdGgubWF4KGkwLCBpMSl9YDsKICAgICAgICAgICAgICBpID0gZWRnZXNbZWRnZV07CiAgICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaSkpIHsKICAgICAgICAgICAgICAgIG1pZCA9IHJodW1iMC5pbnRlcnBvbGF0ZVVzaW5nRnJhY3Rpb24oCiAgICAgICAgICAgICAgICAgIDAuNSwKICAgICAgICAgICAgICAgICAgc3ViZGl2aXNpb25DYXJ0b2dyYXBoaWNTY3JhdGNoCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgbWlkSGVpZ2h0ID0gKGMwLmhlaWdodCArIGMxLmhlaWdodCkgKiAwLjU7CiAgICAgICAgICAgICAgICBtaWRDYXJ0ZXNpYW4zID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICAgICAgICAgICAgICBtaWQubG9uZ2l0dWRlLAogICAgICAgICAgICAgICAgICBtaWQubGF0aXR1ZGUsCiAgICAgICAgICAgICAgICAgIG1pZEhlaWdodCwKICAgICAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgICBzdWJkaXZpc2lvbk1pZFNjcmF0Y2gKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLnB1c2goCiAgICAgICAgICAgICAgICAgIG1pZENhcnRlc2lhbjMueCwKICAgICAgICAgICAgICAgICAgbWlkQ2FydGVzaWFuMy55LAogICAgICAgICAgICAgICAgICBtaWRDYXJ0ZXNpYW4zLnoKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBpID0gc3ViZGl2aWRlZFBvc2l0aW9ucy5sZW5ndGggLyAzIC0gMTsKICAgICAgICAgICAgICAgIGVkZ2VzW2VkZ2VdID0gaTsKICAgICAgICAgICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgICAgICAgICAgbWlkVGV4Y29vcmQgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuYWRkKHQwLCB0MSwgc3ViZGl2aXNpb25UZXhjb29yZE1pZFNjcmF0Y2gpOwogICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihtaWRUZXhjb29yZCwgMC41LCBtaWRUZXhjb29yZCk7CiAgICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHMucHVzaChtaWRUZXhjb29yZC54LCBtaWRUZXhjb29yZC55KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdHJpYW5nbGVzLnB1c2goaTAsIGksIGkyKTsKICAgICAgICAgICAgICB0cmlhbmdsZXMucHVzaChpLCBpMSwgaTIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGcxID09PSBtYXgzKSB7CiAgICAgICAgICAgICAgZWRnZSA9IGAke01hdGgubWluKGkxLCBpMil9ICR7TWF0aC5tYXgoaTEsIGkyKX1gOwogICAgICAgICAgICAgIGkgPSBlZGdlc1tlZGdlXTsKICAgICAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpKSkgewogICAgICAgICAgICAgICAgbWlkID0gcmh1bWIxLmludGVycG9sYXRlVXNpbmdGcmFjdGlvbigKICAgICAgICAgICAgICAgICAgMC41LAogICAgICAgICAgICAgICAgICBzdWJkaXZpc2lvbkNhcnRvZ3JhcGhpY1NjcmF0Y2gKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBtaWRIZWlnaHQgPSAoYzEuaGVpZ2h0ICsgYzIuaGVpZ2h0KSAqIDAuNTsKICAgICAgICAgICAgICAgIG1pZENhcnRlc2lhbjMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgICAgICAgICAgICAgIG1pZC5sb25naXR1ZGUsCiAgICAgICAgICAgICAgICAgIG1pZC5sYXRpdHVkZSwKICAgICAgICAgICAgICAgICAgbWlkSGVpZ2h0LAogICAgICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgICAgIHN1YmRpdmlzaW9uTWlkU2NyYXRjaAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMucHVzaCgKICAgICAgICAgICAgICAgICAgbWlkQ2FydGVzaWFuMy54LAogICAgICAgICAgICAgICAgICBtaWRDYXJ0ZXNpYW4zLnksCiAgICAgICAgICAgICAgICAgIG1pZENhcnRlc2lhbjMuegogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGkgPSBzdWJkaXZpZGVkUG9zaXRpb25zLmxlbmd0aCAvIDMgLSAxOwogICAgICAgICAgICAgICAgZWRnZXNbZWRnZV0gPSBpOwogICAgICAgICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICAgICAgICBtaWRUZXhjb29yZCA9IENhcnRlc2lhbjJfZGVmYXVsdC5hZGQodDEsIHQyLCBzdWJkaXZpc2lvblRleGNvb3JkTWlkU2NyYXRjaCk7CiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG1pZFRleGNvb3JkLCAwLjUsIG1pZFRleGNvb3JkKTsKICAgICAgICAgICAgICAgICAgc3ViZGl2aWRlZFRleGNvb3Jkcy5wdXNoKG1pZFRleGNvb3JkLngsIG1pZFRleGNvb3JkLnkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0cmlhbmdsZXMucHVzaChpMSwgaSwgaTApOwogICAgICAgICAgICAgIHRyaWFuZ2xlcy5wdXNoKGksIGkyLCBpMCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZzIgPT09IG1heDMpIHsKICAgICAgICAgICAgICBlZGdlID0gYCR7TWF0aC5taW4oaTIsIGkwKX0gJHtNYXRoLm1heChpMiwgaTApfWA7CiAgICAgICAgICAgICAgaSA9IGVkZ2VzW2VkZ2VdOwogICAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGkpKSB7CiAgICAgICAgICAgICAgICBtaWQgPSByaHVtYjIuaW50ZXJwb2xhdGVVc2luZ0ZyYWN0aW9uKAogICAgICAgICAgICAgICAgICAwLjUsCiAgICAgICAgICAgICAgICAgIHN1YmRpdmlzaW9uQ2FydG9ncmFwaGljU2NyYXRjaAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIG1pZEhlaWdodCA9IChjMi5oZWlnaHQgKyBjMC5oZWlnaHQpICogMC41OwogICAgICAgICAgICAgICAgbWlkQ2FydGVzaWFuMyA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgICAgICAgICAgbWlkLmxvbmdpdHVkZSwKICAgICAgICAgICAgICAgICAgbWlkLmxhdGl0dWRlLAogICAgICAgICAgICAgICAgICBtaWRIZWlnaHQsCiAgICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgICAgc3ViZGl2aXNpb25NaWRTY3JhdGNoCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucy5wdXNoKAogICAgICAgICAgICAgICAgICBtaWRDYXJ0ZXNpYW4zLngsCiAgICAgICAgICAgICAgICAgIG1pZENhcnRlc2lhbjMueSwKICAgICAgICAgICAgICAgICAgbWlkQ2FydGVzaWFuMy56CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgaSA9IHN1YmRpdmlkZWRQb3NpdGlvbnMubGVuZ3RoIC8gMyAtIDE7CiAgICAgICAgICAgICAgICBlZGdlc1tlZGdlXSA9IGk7CiAgICAgICAgICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICAgICAgICAgIG1pZFRleGNvb3JkID0gQ2FydGVzaWFuMl9kZWZhdWx0LmFkZCh0MiwgdDAsIHN1YmRpdmlzaW9uVGV4Y29vcmRNaWRTY3JhdGNoKTsKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobWlkVGV4Y29vcmQsIDAuNSwgbWlkVGV4Y29vcmQpOwogICAgICAgICAgICAgICAgICBzdWJkaXZpZGVkVGV4Y29vcmRzLnB1c2gobWlkVGV4Y29vcmQueCwgbWlkVGV4Y29vcmQueSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRyaWFuZ2xlcy5wdXNoKGkyLCBpLCBpMSk7CiAgICAgICAgICAgICAgdHJpYW5nbGVzLnB1c2goaSwgaTAsIGkxKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3ViZGl2aWRlZEluZGljZXMucHVzaChpMCk7CiAgICAgICAgICAgIHN1YmRpdmlkZWRJbmRpY2VzLnB1c2goaTEpOwogICAgICAgICAgICBzdWJkaXZpZGVkSW5kaWNlcy5wdXNoKGkyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgZ2VvbWV0cnlPcHRpb25zID0gewogICAgICAgICAgYXR0cmlidXRlczogewogICAgICAgICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICAgIHZhbHVlczogc3ViZGl2aWRlZFBvc2l0aW9ucwogICAgICAgICAgICB9KQogICAgICAgICAgfSwKICAgICAgICAgIGluZGljZXM6IHN1YmRpdmlkZWRJbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUwogICAgICAgIH07CiAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgZ2VvbWV0cnlPcHRpb25zLmF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgICAgICB2YWx1ZXM6IHN1YmRpdmlkZWRUZXhjb29yZHMKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoZ2VvbWV0cnlPcHRpb25zKTsKICAgICAgfTsKICAgICAgUG9seWdvblBpcGVsaW5lLnNjYWxlVG9HZW9kZXRpY0hlaWdodCA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgaGVpZ2h0LCBlbGxpcHNvaWQsIHNjYWxlVG9TdXJmYWNlNCkgewogICAgICAgIGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgICAgIGxldCBuID0gc2NhbGVUb0dlb2RldGljSGVpZ2h0TjsKICAgICAgICBsZXQgcCA9IHNjYWxlVG9HZW9kZXRpY0hlaWdodFA7CiAgICAgICAgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoaGVpZ2h0LCAwKTsKICAgICAgICBzY2FsZVRvU3VyZmFjZTQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzY2FsZVRvU3VyZmFjZTQsIHRydWUpOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSkgewogICAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGksIHApOwogICAgICAgICAgICBpZiAoc2NhbGVUb1N1cmZhY2U0KSB7CiAgICAgICAgICAgICAgcCA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKHAsIHApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChoZWlnaHQgIT09IDApIHsKICAgICAgICAgICAgICBuID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwLCBuKTsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihuLCBoZWlnaHQsIG4pOwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocCwgbiwgcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcG9zaXRpb25zW2ldID0gcC54OwogICAgICAgICAgICBwb3NpdGlvbnNbaSArIDFdID0gcC55OwogICAgICAgICAgICBwb3NpdGlvbnNbaSArIDJdID0gcC56OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcG9zaXRpb25zOwogICAgICB9OwogICAgICBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdCA9IFBvbHlnb25QaXBlbGluZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1F1ZXVlLmpzCiAgZnVuY3Rpb24gUXVldWUoKSB7CiAgICB0aGlzLl9hcnJheSA9IFtdOwogICAgdGhpcy5fb2Zmc2V0ID0gMDsKICAgIHRoaXMuX2xlbmd0aCA9IDA7CiAgfQogIHZhciBRdWV1ZV9kZWZhdWx0OwogIHZhciBpbml0X1F1ZXVlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9RdWV1ZS5qcyIoKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFF1ZXVlLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBsZW5ndGggb2YgdGhlIHF1ZXVlLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIFF1ZXVlLnByb3RvdHlwZQogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBsZW5ndGg6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9sZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgUXVldWUucHJvdG90eXBlLmVucXVldWUgPSBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgdGhpcy5fYXJyYXkucHVzaChpdGVtKTsKICAgICAgICB0aGlzLl9sZW5ndGgrKzsKICAgICAgfTsKICAgICAgUXVldWUucHJvdG90eXBlLmRlcXVldWUgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5fbGVuZ3RoID09PSAwKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBjb25zdCBhcnJheSA9IHRoaXMuX2FycmF5OwogICAgICAgIGxldCBvZmZzZXQgPSB0aGlzLl9vZmZzZXQ7CiAgICAgICAgY29uc3QgaXRlbSA9IGFycmF5W29mZnNldF07CiAgICAgICAgYXJyYXlbb2Zmc2V0XSA9IHZvaWQgMDsKICAgICAgICBvZmZzZXQrKzsKICAgICAgICBpZiAob2Zmc2V0ID4gMTAgJiYgb2Zmc2V0ICogMiA+IGFycmF5Lmxlbmd0aCkgewogICAgICAgICAgdGhpcy5fYXJyYXkgPSBhcnJheS5zbGljZShvZmZzZXQpOwogICAgICAgICAgb2Zmc2V0ID0gMDsKICAgICAgICB9CiAgICAgICAgdGhpcy5fb2Zmc2V0ID0gb2Zmc2V0OwogICAgICAgIHRoaXMuX2xlbmd0aC0tOwogICAgICAgIHJldHVybiBpdGVtOwogICAgICB9OwogICAgICBRdWV1ZS5wcm90b3R5cGUucGVlayA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLl9sZW5ndGggPT09IDApIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLl9hcnJheVt0aGlzLl9vZmZzZXRdOwogICAgICB9OwogICAgICBRdWV1ZS5wcm90b3R5cGUuY29udGFpbnMgPSBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2FycmF5LmluZGV4T2YoaXRlbSkgIT09IC0xOwogICAgICB9OwogICAgICBRdWV1ZS5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLl9hcnJheS5sZW5ndGggPSB0aGlzLl9vZmZzZXQgPSB0aGlzLl9sZW5ndGggPSAwOwogICAgICB9OwogICAgICBRdWV1ZS5wcm90b3R5cGUuc29ydCA9IGZ1bmN0aW9uKGNvbXBhcmVGdW5jdGlvbikgewogICAgICAgIGlmICh0aGlzLl9vZmZzZXQgPiAwKSB7CiAgICAgICAgICB0aGlzLl9hcnJheSA9IHRoaXMuX2FycmF5LnNsaWNlKHRoaXMuX29mZnNldCk7CiAgICAgICAgICB0aGlzLl9vZmZzZXQgPSAwOwogICAgICAgIH0KICAgICAgICB0aGlzLl9hcnJheS5zb3J0KGNvbXBhcmVGdW5jdGlvbik7CiAgICAgIH07CiAgICAgIFF1ZXVlX2RlZmF1bHQgPSBRdWV1ZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlnb25HZW9tZXRyeUxpYnJhcnkuanMKICBmdW5jdGlvbiBnZXRQb2ludEF0RGlzdGFuY2UyRChwMCwgcDEsIGRpc3RhbmNlLCBsZW5ndGgpIHsKICAgIENhcnRlc2lhbjJfZGVmYXVsdC5zdWJ0cmFjdChwMSwgcDAsIGRpc3RhbmNlMkRTY3JhdGNoKTsKICAgIENhcnRlc2lhbjJfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICBkaXN0YW5jZTJEU2NyYXRjaCwKICAgICAgZGlzdGFuY2UgLyBsZW5ndGgsCiAgICAgIGRpc3RhbmNlMkRTY3JhdGNoCiAgICApOwogICAgQ2FydGVzaWFuMl9kZWZhdWx0LmFkZChwMCwgZGlzdGFuY2UyRFNjcmF0Y2gsIGRpc3RhbmNlMkRTY3JhdGNoKTsKICAgIHJldHVybiBbZGlzdGFuY2UyRFNjcmF0Y2gueCwgZGlzdGFuY2UyRFNjcmF0Y2gueV07CiAgfQogIGZ1bmN0aW9uIGdldFBvaW50QXREaXN0YW5jZShwMCwgcDEsIGRpc3RhbmNlLCBsZW5ndGgpIHsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwMSwgcDAsIGRpc3RhbmNlU2NyYXRjaDQpOwogICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgIGRpc3RhbmNlU2NyYXRjaDQsCiAgICAgIGRpc3RhbmNlIC8gbGVuZ3RoLAogICAgICBkaXN0YW5jZVNjcmF0Y2g0CiAgICApOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwMCwgZGlzdGFuY2VTY3JhdGNoNCwgZGlzdGFuY2VTY3JhdGNoNCk7CiAgICByZXR1cm4gW2Rpc3RhbmNlU2NyYXRjaDQueCwgZGlzdGFuY2VTY3JhdGNoNC55LCBkaXN0YW5jZVNjcmF0Y2g0LnpdOwogIH0KICBmdW5jdGlvbiBjb21wdXRlRXF1YXRvckludGVyc2VjdGlvblJodW1iKHN0YXJ0LCBlbmQsIGVsbGlwc29pZCkgewogICAgY29uc3QgYzAgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoc3RhcnQsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMwKTsKICAgIGNvbnN0IGMxID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKGVuZCwgc2NyYXRjaENhcnRvZ3JhcGhpYzEpOwogICAgaWYgKE1hdGguc2lnbihjMC5sYXRpdHVkZSkgPT09IE1hdGguc2lnbihjMS5sYXRpdHVkZSkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgc2NyYXRjaFJodW1iTGluZS5zZXRFbmRQb2ludHMoYzAsIGMxKTsKICAgIGNvbnN0IGludGVyc2VjdGlvbiA9IHNjcmF0Y2hSaHVtYkxpbmUuZmluZEludGVyc2VjdGlvbldpdGhMYXRpdHVkZSgKICAgICAgMCwKICAgICAgc2NyYXRjaFJodW1iSW50ZXJzZWN0aW9uCiAgICApOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaW50ZXJzZWN0aW9uKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBsZXQgbWluTG9uZ2l0dWRlID0gTWF0aC5taW4oYzAubG9uZ2l0dWRlLCBjMS5sb25naXR1ZGUpOwogICAgbGV0IG1heExvbmdpdHVkZSA9IE1hdGgubWF4KGMwLmxvbmdpdHVkZSwgYzEubG9uZ2l0dWRlKTsKICAgIGlmIChNYXRoLmFicyhtYXhMb25naXR1ZGUgLSBtaW5Mb25naXR1ZGUpID4gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgIGNvbnN0IHN3YXAyID0gbWluTG9uZ2l0dWRlOwogICAgICBtaW5Mb25naXR1ZGUgPSBtYXhMb25naXR1ZGU7CiAgICAgIG1heExvbmdpdHVkZSA9IHN3YXAyOwogICAgfQogICAgaWYgKGludGVyc2VjdGlvbi5sb25naXR1ZGUgPCBtaW5Mb25naXR1ZGUgfHwgaW50ZXJzZWN0aW9uLmxvbmdpdHVkZSA+IG1heExvbmdpdHVkZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICByZXR1cm4gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKGludGVyc2VjdGlvbik7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVFcXVhdG9ySW50ZXJzZWN0aW9uKHN0YXJ0LCBlbmQsIGVsbGlwc29pZCwgYXJjVHlwZSkgewogICAgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5SSFVNQikgewogICAgICByZXR1cm4gY29tcHV0ZUVxdWF0b3JJbnRlcnNlY3Rpb25SaHVtYihzdGFydCwgZW5kLCBlbGxpcHNvaWQpOwogICAgfQogICAgY29uc3QgaW50ZXJzZWN0aW9uID0gSW50ZXJzZWN0aW9uVGVzdHNfZGVmYXVsdC5saW5lU2VnbWVudFBsYW5lKAogICAgICBzdGFydCwKICAgICAgZW5kLAogICAgICBQbGFuZV9kZWZhdWx0Lk9SSUdJTl9YWV9QTEFORQogICAgKTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGludGVyc2VjdGlvbikpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgcmV0dXJuIGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKGludGVyc2VjdGlvbiwgaW50ZXJzZWN0aW9uKTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZUVkZ2VzT25QbGFuZShwb3NpdGlvbnMsIGVsbGlwc29pZCwgYXJjVHlwZSkgewogICAgY29uc3QgZWRnZXNPblBsYW5lID0gW107CiAgICBsZXQgc3RhcnRQb2ludCwgZW5kUG9pbnQsIHR5cGUsIG5leHQsIGludGVyc2VjdGlvbiwgaSA9IDA7CiAgICB3aGlsZSAoaSA8IHBvc2l0aW9ucy5sZW5ndGgpIHsKICAgICAgc3RhcnRQb2ludCA9IHBvc2l0aW9uc1tpXTsKICAgICAgZW5kUG9pbnQgPSBwb3NpdGlvbnNbKGkgKyAxKSAlIHBvc2l0aW9ucy5sZW5ndGhdOwogICAgICB0eXBlID0gTWF0aF9kZWZhdWx0LnNpZ24oc3RhcnRQb2ludC56KTsKICAgICAgbmV4dCA9IE1hdGhfZGVmYXVsdC5zaWduKGVuZFBvaW50LnopOwogICAgICBjb25zdCBnZXRMb25naXR1ZGUgPSAocG9zaXRpb24pID0+IHsKICAgICAgICBjb25zdCBjYXJ0b2dyYXBoaWMyID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljMwogICAgICAgICk7CiAgICAgICAgcmV0dXJuIGNhcnRvZ3JhcGhpYzIubG9uZ2l0dWRlOwogICAgICB9OwogICAgICBpZiAodHlwZSA9PT0gMCkgewogICAgICAgIGVkZ2VzT25QbGFuZS5wdXNoKHsKICAgICAgICAgIHBvc2l0aW9uOiBpLAogICAgICAgICAgdHlwZSwKICAgICAgICAgIHZpc2l0ZWQ6IGZhbHNlLAogICAgICAgICAgbmV4dCwKICAgICAgICAgIHRoZXRhOiBnZXRMb25naXR1ZGUoc3RhcnRQb2ludCkKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmIChuZXh0ICE9PSAwKSB7CiAgICAgICAgaW50ZXJzZWN0aW9uID0gY29tcHV0ZUVxdWF0b3JJbnRlcnNlY3Rpb24oCiAgICAgICAgICBzdGFydFBvaW50LAogICAgICAgICAgZW5kUG9pbnQsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBhcmNUeXBlCiAgICAgICAgKTsKICAgICAgICArK2k7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaW50ZXJzZWN0aW9uKSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIHBvc2l0aW9ucy5zcGxpY2UoaSwgMCwgaW50ZXJzZWN0aW9uKTsKICAgICAgICBlZGdlc09uUGxhbmUucHVzaCh7CiAgICAgICAgICBwb3NpdGlvbjogaSwKICAgICAgICAgIHR5cGUsCiAgICAgICAgICB2aXNpdGVkOiBmYWxzZSwKICAgICAgICAgIG5leHQsCiAgICAgICAgICB0aGV0YTogZ2V0TG9uZ2l0dWRlKGludGVyc2VjdGlvbikKICAgICAgICB9KTsKICAgICAgfQogICAgICArK2k7CiAgICB9CiAgICByZXR1cm4gZWRnZXNPblBsYW5lOwogIH0KICBmdW5jdGlvbiB3aXJlUG9seWdvbihwb2x5Z29ucywgcG9seWdvbkluZGV4LCBwb3NpdGlvbnMsIGVkZ2VzT25QbGFuZSwgdG9EZWxldGUsIHN0YXJ0SW5kZXgsIGFib3ZlUGxhbmUpIHsKICAgIGNvbnN0IHBvbHlnb24yID0gW107CiAgICBsZXQgaSA9IHN0YXJ0SW5kZXg7CiAgICBjb25zdCBnZXRNYXRjaGluZ0VkZ2UgPSAoaTIpID0+IChlZGdlKSA9PiBlZGdlLnBvc2l0aW9uID09PSBpMjsKICAgIGNvbnN0IHBvbHlnb25zVG9XaXJlID0gW107CiAgICBkbyB7CiAgICAgIGNvbnN0IHBvc2l0aW9uID0gcG9zaXRpb25zW2ldOwogICAgICBwb2x5Z29uMi5wdXNoKHBvc2l0aW9uKTsKICAgICAgY29uc3QgZWRnZUluZGV4ID0gZWRnZXNPblBsYW5lLmZpbmRJbmRleChnZXRNYXRjaGluZ0VkZ2UoaSkpOwogICAgICBjb25zdCBlZGdlID0gZWRnZXNPblBsYW5lW2VkZ2VJbmRleF07CiAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGVkZ2UpKSB7CiAgICAgICAgKytpOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbnN0IHsgdmlzaXRlZDogaGFzQmVlblZpc2l0ZWQsIHR5cGUsIG5leHQgfSA9IGVkZ2U7CiAgICAgIGVkZ2UudmlzaXRlZCA9IHRydWU7CiAgICAgIGlmICh0eXBlID09PSAwKSB7CiAgICAgICAgaWYgKG5leHQgPT09IDApIHsKICAgICAgICAgIGNvbnN0IHByZXZpb3VzRWRnZSA9IGVkZ2VzT25QbGFuZVtlZGdlSW5kZXggLSAoYWJvdmVQbGFuZSA/IDEgOiAtMSldOwogICAgICAgICAgaWYgKHByZXZpb3VzRWRnZT8ucG9zaXRpb24gPT09IGkgKyAxKSB7CiAgICAgICAgICAgIHByZXZpb3VzRWRnZS52aXNpdGVkID0gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICsraTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghaGFzQmVlblZpc2l0ZWQgJiYgYWJvdmVQbGFuZSAmJiBuZXh0ID4gMCB8fCBzdGFydEluZGV4ID09PSBpICYmICFhYm92ZVBsYW5lICYmIG5leHQgPCAwKSB7CiAgICAgICAgICArK2k7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgZm9sbG93RWRnZSA9IGFib3ZlUGxhbmUgPyB0eXBlID49IDAgOiB0eXBlIDw9IDA7CiAgICAgIGlmICghZm9sbG93RWRnZSkgewogICAgICAgICsraTsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBpZiAoIWhhc0JlZW5WaXNpdGVkKSB7CiAgICAgICAgcG9seWdvbnNUb1dpcmUucHVzaChpKTsKICAgICAgfQogICAgICBjb25zdCBuZXh0RWRnZUluZGV4ID0gZWRnZUluZGV4ICsgKGFib3ZlUGxhbmUgPyAxIDogLTEpOwogICAgICBjb25zdCBuZXh0RWRnZSA9IGVkZ2VzT25QbGFuZVtuZXh0RWRnZUluZGV4XTsKICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobmV4dEVkZ2UpKSB7CiAgICAgICAgKytpOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGkgPSBuZXh0RWRnZS5wb3NpdGlvbjsKICAgIH0gd2hpbGUgKGkgPCBwb3NpdGlvbnMubGVuZ3RoICYmIGkgPj0gMCAmJiBpICE9PSBzdGFydEluZGV4ICYmIHBvbHlnb24yLmxlbmd0aCA8IHBvc2l0aW9ucy5sZW5ndGgpOwogICAgcG9seWdvbnMuc3BsaWNlKHBvbHlnb25JbmRleCwgdG9EZWxldGUsIHBvbHlnb24yKTsKICAgIGZvciAoY29uc3QgaW5kZXggb2YgcG9seWdvbnNUb1dpcmUpIHsKICAgICAgcG9seWdvbkluZGV4ID0gd2lyZVBvbHlnb24oCiAgICAgICAgcG9seWdvbnMsCiAgICAgICAgKytwb2x5Z29uSW5kZXgsCiAgICAgICAgcG9zaXRpb25zLAogICAgICAgIGVkZ2VzT25QbGFuZSwKICAgICAgICAwLAogICAgICAgIGluZGV4LAogICAgICAgICFhYm92ZVBsYW5lCiAgICAgICk7CiAgICB9CiAgICByZXR1cm4gcG9seWdvbkluZGV4OwogIH0KICB2YXIgUG9seWdvbkdlb21ldHJ5TGlicmFyeSwgZGlzdGFuY2UyRFNjcmF0Y2gsIGRpc3RhbmNlU2NyYXRjaDQsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMwLCBzY3JhdGNoQ2FydG9ncmFwaGljMSwgc2NyYXRjaENhcnRvZ3JhcGhpYzIyLCBzY3JhdGNoQ2FydGVzaWFuMCwgc2NyYXRjaFJodW1iTGluZSwgc2NhbGVUb0dlb2RldGljSGVpZ2h0TjEsIHNjYWxlVG9HZW9kZXRpY0hlaWdodE4yLCBzY2FsZVRvR2VvZGV0aWNIZWlnaHRQMSwgc2NhbGVUb0dlb2RldGljSGVpZ2h0UDIsIHNjcmF0Y2hSaHVtYkludGVyc2VjdGlvbiwgc2NyYXRjaENhcnRvZ3JhcGhpYzMsIGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZUNhcnRlc2lhbjIsIGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZUNhcnRlc2lhbjMsIGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZVF1YXRlcm5pb24sIGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZU1hdHJpeDMsIGNvbXB1dGVXYWxsVGV4Y29vcmRzU3ViZGl2aWRlZCwgY29tcHV0ZVdhbGxJbmRpY2VzU3ViZGl2aWRlZCwgcDFTY3JhdGNoMiwgcDJTY3JhdGNoMiwgUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0OwogIHZhciBpbml0X1BvbHlnb25HZW9tZXRyeUxpYnJhcnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlnb25HZW9tZXRyeUxpYnJhcnkuanMiKCkgewogICAgICBpbml0X0FyY1R5cGUoKTsKICAgICAgaW5pdF9hcnJheVJlbW92ZUR1cGxpY2F0ZXMoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0VsbGlwc29pZFJodW1iTGluZSgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeVBpcGVsaW5lKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X0ludGVyc2VjdGlvblRlc3RzKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9QbGFuZSgpOwogICAgICBpbml0X1BvbHlnb25IaWVyYXJjaHkoKTsKICAgICAgaW5pdF9Qb2x5Z29uUGlwZWxpbmUoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfUXVhdGVybmlvbigpOwogICAgICBpbml0X1F1ZXVlKCk7CiAgICAgIGluaXRfV2luZGluZ09yZGVyKCk7CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkgPSB7fTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeS5jb21wdXRlSGllcmFyY2h5UGFja2VkTGVuZ3RoID0gZnVuY3Rpb24ocG9seWdvbkhpZXJhcmNoeSwgQ2FydGVzaWFuWCkgewogICAgICAgIGxldCBudW1Db21wb25lbnRzID0gMDsKICAgICAgICBjb25zdCBzdGFjayA9IFtwb2x5Z29uSGllcmFyY2h5XTsKICAgICAgICB3aGlsZSAoc3RhY2subGVuZ3RoID4gMCkgewogICAgICAgICAgY29uc3QgaGllcmFyY2h5ID0gc3RhY2sucG9wKCk7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChoaWVyYXJjaHkpKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgbnVtQ29tcG9uZW50cyArPSAyOwogICAgICAgICAgY29uc3QgcG9zaXRpb25zID0gaGllcmFyY2h5LnBvc2l0aW9uczsKICAgICAgICAgIGNvbnN0IGhvbGVzID0gaGllcmFyY2h5LmhvbGVzOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMpICYmIHBvc2l0aW9ucy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIG51bUNvbXBvbmVudHMgKz0gcG9zaXRpb25zLmxlbmd0aCAqIENhcnRlc2lhblgucGFja2VkTGVuZ3RoOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChob2xlcykpIHsKICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gaG9sZXMubGVuZ3RoOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgc3RhY2sucHVzaChob2xlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bUNvbXBvbmVudHM7CiAgICAgIH07CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkucGFja1BvbHlnb25IaWVyYXJjaHkgPSBmdW5jdGlvbihwb2x5Z29uSGllcmFyY2h5LCBhcnJheSwgc3RhcnRpbmdJbmRleCwgQ2FydGVzaWFuWCkgewogICAgICAgIGNvbnN0IHN0YWNrID0gW3BvbHlnb25IaWVyYXJjaHldOwogICAgICAgIHdoaWxlIChzdGFjay5sZW5ndGggPiAwKSB7CiAgICAgICAgICBjb25zdCBoaWVyYXJjaHkgPSBzdGFjay5wb3AoKTsKICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGhpZXJhcmNoeSkpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBoaWVyYXJjaHkucG9zaXRpb25zOwogICAgICAgICAgY29uc3QgaG9sZXMgPSBoaWVyYXJjaHkuaG9sZXM7CiAgICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgPyBwb3NpdGlvbnMubGVuZ3RoIDogMDsKICAgICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBkZWZpbmVkX2RlZmF1bHQoaG9sZXMpID8gaG9sZXMubGVuZ3RoIDogMDsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSkgewogICAgICAgICAgICBjb25zdCBwb3NpdGlvbnNMZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9uc0xlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhblgucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICAgICAgQ2FydGVzaWFuWC5wYWNrKHBvc2l0aW9uc1tpXSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGhvbGVzKSkgewogICAgICAgICAgICBjb25zdCBob2xlc0xlbmd0aCA9IGhvbGVzLmxlbmd0aDsKICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBob2xlc0xlbmd0aDsgKytqKSB7CiAgICAgICAgICAgICAgc3RhY2sucHVzaChob2xlc1tqXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0YXJ0aW5nSW5kZXg7CiAgICAgIH07CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkudW5wYWNrUG9seWdvbkhpZXJhcmNoeSA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCBDYXJ0ZXNpYW5YKSB7CiAgICAgICAgY29uc3QgcG9zaXRpb25zTGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBob2xlc0xlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEFycmF5KHBvc2l0aW9uc0xlbmd0aCk7CiAgICAgICAgY29uc3QgaG9sZXMgPSBob2xlc0xlbmd0aCA+IDAgPyBuZXcgQXJyYXkoaG9sZXNMZW5ndGgpIDogdm9pZCAwOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb25zTGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuWC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIHBvc2l0aW9uc1tpXSA9IENhcnRlc2lhblgudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBob2xlc0xlbmd0aDsgKytqKSB7CiAgICAgICAgICBob2xlc1tqXSA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnkudW5wYWNrUG9seWdvbkhpZXJhcmNoeSgKICAgICAgICAgICAgYXJyYXksCiAgICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICAgIENhcnRlc2lhblgKICAgICAgICAgICk7CiAgICAgICAgICBzdGFydGluZ0luZGV4ID0gaG9sZXNbal0uc3RhcnRpbmdJbmRleDsKICAgICAgICAgIGRlbGV0ZSBob2xlc1tqXS5zdGFydGluZ0luZGV4OwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgaG9sZXMsCiAgICAgICAgICBzdGFydGluZ0luZGV4CiAgICAgICAgfTsKICAgICAgfTsKICAgICAgZGlzdGFuY2UyRFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIGRpc3RhbmNlU2NyYXRjaDQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuc3ViZGl2aWRlTGluZUNvdW50ID0gZnVuY3Rpb24ocDAsIHAxLCBtaW5EaXN0YW5jZSkgewogICAgICAgIGNvbnN0IGRpc3RhbmNlID0gQ2FydGVzaWFuM19kZWZhdWx0LmRpc3RhbmNlKHAwLCBwMSk7CiAgICAgICAgY29uc3QgbiA9IGRpc3RhbmNlIC8gbWluRGlzdGFuY2U7CiAgICAgICAgY29uc3QgY291bnREaXZpZGUgPSBNYXRoLm1heCgwLCBNYXRoLmNlaWwoTWF0aF9kZWZhdWx0LmxvZzIobikpKTsKICAgICAgICByZXR1cm4gTWF0aC5wb3coMiwgY291bnREaXZpZGUpOwogICAgICB9OwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljMCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljMSA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljMjIgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjAgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hSaHVtYkxpbmUgPSBuZXcgRWxsaXBzb2lkUmh1bWJMaW5lX2RlZmF1bHQoKTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeS5zdWJkaXZpZGVSaHVtYkxpbmVDb3VudCA9IGZ1bmN0aW9uKGVsbGlwc29pZCwgcDAsIHAxLCBtaW5EaXN0YW5jZSkgewogICAgICAgIGNvbnN0IGMwID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHAwLCBzY3JhdGNoQ2FydG9ncmFwaGljMCk7CiAgICAgICAgY29uc3QgYzEgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocDEsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMxKTsKICAgICAgICBjb25zdCByaHVtYiA9IG5ldyBFbGxpcHNvaWRSaHVtYkxpbmVfZGVmYXVsdChjMCwgYzEsIGVsbGlwc29pZCk7CiAgICAgICAgY29uc3QgbiA9IHJodW1iLnN1cmZhY2VEaXN0YW5jZSAvIG1pbkRpc3RhbmNlOwogICAgICAgIGNvbnN0IGNvdW50RGl2aWRlID0gTWF0aC5tYXgoMCwgTWF0aC5jZWlsKE1hdGhfZGVmYXVsdC5sb2cyKG4pKSk7CiAgICAgICAgcmV0dXJuIE1hdGgucG93KDIsIGNvdW50RGl2aWRlKTsKICAgICAgfTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeS5zdWJkaXZpZGVUZXhjb29yZExpbmUgPSBmdW5jdGlvbih0MCwgdDEsIHAwLCBwMSwgbWluRGlzdGFuY2UsIHJlc3VsdCkgewogICAgICAgIGNvbnN0IHN1YmRpdmlzaW9ucyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuc3ViZGl2aWRlTGluZUNvdW50KAogICAgICAgICAgcDAsCiAgICAgICAgICBwMSwKICAgICAgICAgIG1pbkRpc3RhbmNlCiAgICAgICAgKTsKICAgICAgICBjb25zdCBsZW5ndGgyRCA9IENhcnRlc2lhbjJfZGVmYXVsdC5kaXN0YW5jZSh0MCwgdDEpOwogICAgICAgIGNvbnN0IGRpc3RhbmNlQmV0d2VlbkNvb3JkcyA9IGxlbmd0aDJEIC8gc3ViZGl2aXNpb25zOwogICAgICAgIGNvbnN0IHRleGNvb3JkcyA9IHJlc3VsdDsKICAgICAgICB0ZXhjb29yZHMubGVuZ3RoID0gc3ViZGl2aXNpb25zICogMjsKICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3ViZGl2aXNpb25zOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHQgPSBnZXRQb2ludEF0RGlzdGFuY2UyRCh0MCwgdDEsIGkgKiBkaXN0YW5jZUJldHdlZW5Db29yZHMsIGxlbmd0aDJEKTsKICAgICAgICAgIHRleGNvb3Jkc1tpbmRleCsrXSA9IHRbMF07CiAgICAgICAgICB0ZXhjb29yZHNbaW5kZXgrK10gPSB0WzFdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGV4Y29vcmRzOwogICAgICB9OwogICAgICBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnN1YmRpdmlkZUxpbmUgPSBmdW5jdGlvbihwMCwgcDEsIG1pbkRpc3RhbmNlLCByZXN1bHQpIHsKICAgICAgICBjb25zdCBudW1WZXJ0aWNlcyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuc3ViZGl2aWRlTGluZUNvdW50KAogICAgICAgICAgcDAsCiAgICAgICAgICBwMSwKICAgICAgICAgIG1pbkRpc3RhbmNlCiAgICAgICAgKTsKICAgICAgICBjb25zdCBsZW5ndGggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZGlzdGFuY2UocDAsIHAxKTsKICAgICAgICBjb25zdCBkaXN0YW5jZUJldHdlZW5WZXJ0aWNlcyA9IGxlbmd0aCAvIG51bVZlcnRpY2VzOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IFtdOwogICAgICAgIH0KICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSByZXN1bHQ7CiAgICAgICAgcG9zaXRpb25zLmxlbmd0aCA9IG51bVZlcnRpY2VzICogMzsKICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtVmVydGljZXM7IGkrKykgewogICAgICAgICAgY29uc3QgcCA9IGdldFBvaW50QXREaXN0YW5jZShwMCwgcDEsIGkgKiBkaXN0YW5jZUJldHdlZW5WZXJ0aWNlcywgbGVuZ3RoKTsKICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IHBbMF07CiAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBwWzFdOwogICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gcFsyXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBvc2l0aW9uczsKICAgICAgfTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeS5zdWJkaXZpZGVUZXhjb29yZFJodW1iTGluZSA9IGZ1bmN0aW9uKHQwLCB0MSwgZWxsaXBzb2lkLCBwMCwgcDEsIG1pbkRpc3RhbmNlLCByZXN1bHQpIHsKICAgICAgICBjb25zdCBjMCA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhwMCwgc2NyYXRjaENhcnRvZ3JhcGhpYzApOwogICAgICAgIGNvbnN0IGMxID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHAxLCBzY3JhdGNoQ2FydG9ncmFwaGljMSk7CiAgICAgICAgc2NyYXRjaFJodW1iTGluZS5zZXRFbmRQb2ludHMoYzAsIGMxKTsKICAgICAgICBjb25zdCBuID0gc2NyYXRjaFJodW1iTGluZS5zdXJmYWNlRGlzdGFuY2UgLyBtaW5EaXN0YW5jZTsKICAgICAgICBjb25zdCBjb3VudERpdmlkZSA9IE1hdGgubWF4KDAsIE1hdGguY2VpbChNYXRoX2RlZmF1bHQubG9nMihuKSkpOwogICAgICAgIGNvbnN0IHN1YmRpdmlzaW9ucyA9IE1hdGgucG93KDIsIGNvdW50RGl2aWRlKTsKICAgICAgICBjb25zdCBsZW5ndGgyRCA9IENhcnRlc2lhbjJfZGVmYXVsdC5kaXN0YW5jZSh0MCwgdDEpOwogICAgICAgIGNvbnN0IGRpc3RhbmNlQmV0d2VlbkNvb3JkcyA9IGxlbmd0aDJEIC8gc3ViZGl2aXNpb25zOwogICAgICAgIGNvbnN0IHRleGNvb3JkcyA9IHJlc3VsdDsKICAgICAgICB0ZXhjb29yZHMubGVuZ3RoID0gc3ViZGl2aXNpb25zICogMjsKICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3ViZGl2aXNpb25zOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHQgPSBnZXRQb2ludEF0RGlzdGFuY2UyRCh0MCwgdDEsIGkgKiBkaXN0YW5jZUJldHdlZW5Db29yZHMsIGxlbmd0aDJEKTsKICAgICAgICAgIHRleGNvb3Jkc1tpbmRleCsrXSA9IHRbMF07CiAgICAgICAgICB0ZXhjb29yZHNbaW5kZXgrK10gPSB0WzFdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGV4Y29vcmRzOwogICAgICB9OwogICAgICBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnN1YmRpdmlkZVJodW1iTGluZSA9IGZ1bmN0aW9uKGVsbGlwc29pZCwgcDAsIHAxLCBtaW5EaXN0YW5jZSwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgYzAgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocDAsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMwKTsKICAgICAgICBjb25zdCBjMSA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhwMSwgc2NyYXRjaENhcnRvZ3JhcGhpYzEpOwogICAgICAgIGNvbnN0IHJodW1iID0gbmV3IEVsbGlwc29pZFJodW1iTGluZV9kZWZhdWx0KGMwLCBjMSwgZWxsaXBzb2lkKTsKICAgICAgICBjb25zdCBuID0gcmh1bWIuc3VyZmFjZURpc3RhbmNlIC8gbWluRGlzdGFuY2U7CiAgICAgICAgY29uc3QgY291bnREaXZpZGUgPSBNYXRoLm1heCgwLCBNYXRoLmNlaWwoTWF0aF9kZWZhdWx0LmxvZzIobikpKTsKICAgICAgICBjb25zdCBudW1WZXJ0aWNlcyA9IE1hdGgucG93KDIsIGNvdW50RGl2aWRlKTsKICAgICAgICBjb25zdCBkaXN0YW5jZUJldHdlZW5WZXJ0aWNlcyA9IHJodW1iLnN1cmZhY2VEaXN0YW5jZSAvIG51bVZlcnRpY2VzOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IFtdOwogICAgICAgIH0KICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSByZXN1bHQ7CiAgICAgICAgcG9zaXRpb25zLmxlbmd0aCA9IG51bVZlcnRpY2VzICogMzsKICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtVmVydGljZXM7IGkrKykgewogICAgICAgICAgY29uc3QgYyA9IHJodW1iLmludGVycG9sYXRlVXNpbmdTdXJmYWNlRGlzdGFuY2UoCiAgICAgICAgICAgIGkgKiBkaXN0YW5jZUJldHdlZW5WZXJ0aWNlcywKICAgICAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzIyCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcCA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihjLCBzY3JhdGNoQ2FydGVzaWFuMCk7CiAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBwLng7CiAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBwLnk7CiAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBwLno7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwb3NpdGlvbnM7CiAgICAgIH07CiAgICAgIHNjYWxlVG9HZW9kZXRpY0hlaWdodE4xID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY2FsZVRvR2VvZGV0aWNIZWlnaHROMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NhbGVUb0dlb2RldGljSGVpZ2h0UDEgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjYWxlVG9HZW9kZXRpY0hlaWdodFAyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnNjYWxlVG9HZW9kZXRpY0hlaWdodEV4dHJ1ZGVkID0gZnVuY3Rpb24oZ2VvbWV0cnksIG1heEhlaWdodCwgbWluSGVpZ2h0LCBlbGxpcHNvaWQsIHBlclBvc2l0aW9uSGVpZ2h0KSB7CiAgICAgICAgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICAgICAgY29uc3QgbjEgPSBzY2FsZVRvR2VvZGV0aWNIZWlnaHROMTsKICAgICAgICBsZXQgbjIgPSBzY2FsZVRvR2VvZGV0aWNIZWlnaHROMjsKICAgICAgICBjb25zdCBwID0gc2NhbGVUb0dlb2RldGljSGVpZ2h0UDE7CiAgICAgICAgbGV0IHAyID0gc2NhbGVUb0dlb2RldGljSGVpZ2h0UDI7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeSkgJiYgZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmF0dHJpYnV0ZXMpICYmIGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uKSkgewogICAgICAgICAgY29uc3QgcG9zaXRpb25zID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXM7CiAgICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoIC8gMjsKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGksIHApOwogICAgICAgICAgICBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHAsIG4xKTsKICAgICAgICAgICAgcDIgPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShwLCBwMik7CiAgICAgICAgICAgIG4yID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobjEsIG1pbkhlaWdodCwgbjIpOwogICAgICAgICAgICBuMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocDIsIG4yLCBuMik7CiAgICAgICAgICAgIHBvc2l0aW9uc1tpICsgbGVuZ3RoXSA9IG4yLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1tpICsgMSArIGxlbmd0aF0gPSBuMi55OwogICAgICAgICAgICBwb3NpdGlvbnNbaSArIDIgKyBsZW5ndGhdID0gbjIuejsKICAgICAgICAgICAgaWYgKHBlclBvc2l0aW9uSGVpZ2h0KSB7CiAgICAgICAgICAgICAgcDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocCwgcDIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG4yID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobjEsIG1heEhlaWdodCwgbjIpOwogICAgICAgICAgICBuMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocDIsIG4yLCBuMik7CiAgICAgICAgICAgIHBvc2l0aW9uc1tpXSA9IG4yLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1tpICsgMV0gPSBuMi55OwogICAgICAgICAgICBwb3NpdGlvbnNbaSArIDJdID0gbjIuejsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGdlb21ldHJ5OwogICAgICB9OwogICAgICBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnBvbHlnb25PdXRsaW5lc0Zyb21IaWVyYXJjaHkgPSBmdW5jdGlvbihwb2x5Z29uSGllcmFyY2h5LCBzY2FsZVRvRWxsaXBzb2lkU3VyZmFjZSwgZWxsaXBzb2lkKSB7CiAgICAgICAgY29uc3QgcG9seWdvbnMgPSBbXTsKICAgICAgICBjb25zdCBxdWV1ZSA9IG5ldyBRdWV1ZV9kZWZhdWx0KCk7CiAgICAgICAgcXVldWUuZW5xdWV1ZShwb2x5Z29uSGllcmFyY2h5KTsKICAgICAgICBsZXQgaTsKICAgICAgICBsZXQgajsKICAgICAgICBsZXQgbGVuZ3RoOwogICAgICAgIHdoaWxlIChxdWV1ZS5sZW5ndGggIT09IDApIHsKICAgICAgICAgIGNvbnN0IG91dGVyTm9kZSA9IHF1ZXVlLmRlcXVldWUoKTsKICAgICAgICAgIGxldCBvdXRlclJpbmcgPSBvdXRlck5vZGUucG9zaXRpb25zOwogICAgICAgICAgaWYgKHNjYWxlVG9FbGxpcHNvaWRTdXJmYWNlKSB7CiAgICAgICAgICAgIGxlbmd0aCA9IG91dGVyUmluZy5sZW5ndGg7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKG91dGVyUmluZ1tpXSwgb3V0ZXJSaW5nW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgb3V0ZXJSaW5nID0gYXJyYXlSZW1vdmVEdXBsaWNhdGVzX2RlZmF1bHQoCiAgICAgICAgICAgIG91dGVyUmluZywKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24sCiAgICAgICAgICAgIHRydWUKICAgICAgICAgICk7CiAgICAgICAgICBpZiAob3V0ZXJSaW5nLmxlbmd0aCA8IDMpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBudW1DaGlsZHJlbiA9IG91dGVyTm9kZS5ob2xlcyA/IG91dGVyTm9kZS5ob2xlcy5sZW5ndGggOiAwOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IG51bUNoaWxkcmVuOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgaG9sZSA9IG91dGVyTm9kZS5ob2xlc1tpXTsKICAgICAgICAgICAgbGV0IGhvbGVQb3NpdGlvbnMgPSBob2xlLnBvc2l0aW9uczsKICAgICAgICAgICAgaWYgKHNjYWxlVG9FbGxpcHNvaWRTdXJmYWNlKSB7CiAgICAgICAgICAgICAgbGVuZ3RoID0gaG9sZVBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IGxlbmd0aDsgKytqKSB7CiAgICAgICAgICAgICAgICBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShob2xlUG9zaXRpb25zW2pdLCBob2xlUG9zaXRpb25zW2pdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaG9sZVBvc2l0aW9ucyA9IGFycmF5UmVtb3ZlRHVwbGljYXRlc19kZWZhdWx0KAogICAgICAgICAgICAgIGhvbGVQb3NpdGlvbnMsCiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24sCiAgICAgICAgICAgICAgdHJ1ZQogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoaG9sZVBvc2l0aW9ucy5sZW5ndGggPCAzKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcG9seWdvbnMucHVzaChob2xlUG9zaXRpb25zKTsKICAgICAgICAgICAgbGV0IG51bUdyYW5kY2hpbGRyZW4gPSAwOwogICAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGhvbGUuaG9sZXMpKSB7CiAgICAgICAgICAgICAgbnVtR3JhbmRjaGlsZHJlbiA9IGhvbGUuaG9sZXMubGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBudW1HcmFuZGNoaWxkcmVuOyBqKyspIHsKICAgICAgICAgICAgICBxdWV1ZS5lbnF1ZXVlKGhvbGUuaG9sZXNbal0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBwb2x5Z29ucy5wdXNoKG91dGVyUmluZyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwb2x5Z29uczsKICAgICAgfTsKICAgICAgc2NyYXRjaFJodW1iSW50ZXJzZWN0aW9uID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWMzID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuc3BsaXRQb2x5Z29uc09uRXF1YXRvciA9IGZ1bmN0aW9uKG91dGVyUmluZ3MsIGVsbGlwc29pZCwgYXJjVHlwZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gW107CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5zcGxpY2UoMCwgMCwgLi4ub3V0ZXJSaW5ncyk7CiAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IG91dGVyUmluZ3MubGVuZ3RoOwogICAgICAgIGxldCBjdXJyZW50UG9seWdvbiA9IDA7CiAgICAgICAgd2hpbGUgKGN1cnJlbnRQb2x5Z29uIDwgcmVzdWx0Lmxlbmd0aCkgewogICAgICAgICAgY29uc3Qgb3V0ZXJSaW5nID0gcmVzdWx0W2N1cnJlbnRQb2x5Z29uXTsKICAgICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG91dGVyUmluZy5zbGljZSgpOwogICAgICAgICAgaWYgKG91dGVyUmluZy5sZW5ndGggPCAzKSB7CiAgICAgICAgICAgIHJlc3VsdFtjdXJyZW50UG9seWdvbl0gPSBwb3NpdGlvbnM7CiAgICAgICAgICAgICsrY3VycmVudFBvbHlnb247CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgZWRnZXNPblBsYW5lID0gY29tcHV0ZUVkZ2VzT25QbGFuZShwb3NpdGlvbnMsIGVsbGlwc29pZCwgYXJjVHlwZSk7CiAgICAgICAgICBpZiAocG9zaXRpb25zLmxlbmd0aCA9PT0gb3V0ZXJSaW5nLmxlbmd0aCB8fCBlZGdlc09uUGxhbmUubGVuZ3RoIDw9IDEpIHsKICAgICAgICAgICAgcmVzdWx0W2N1cnJlbnRQb2x5Z29uXSA9IHBvc2l0aW9uczsKICAgICAgICAgICAgKytjdXJyZW50UG9seWdvbjsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBlZGdlc09uUGxhbmUuc29ydCgoYTMsIGIpID0+IHsKICAgICAgICAgICAgcmV0dXJuIGEzLnRoZXRhIC0gYi50aGV0YTsKICAgICAgICAgIH0pOwogICAgICAgICAgY29uc3Qgbm9ydGggPSBwb3NpdGlvbnNbMF0ueiA+PSAwOwogICAgICAgICAgY3VycmVudFBvbHlnb24gPSB3aXJlUG9seWdvbigKICAgICAgICAgICAgcmVzdWx0LAogICAgICAgICAgICBjdXJyZW50UG9seWdvbiwKICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICBlZGdlc09uUGxhbmUsCiAgICAgICAgICAgIDEsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIG5vcnRoCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnBvbHlnb25zRnJvbUhpZXJhcmNoeSA9IGZ1bmN0aW9uKHBvbHlnb25IaWVyYXJjaHksIGtlZXBEdXBsaWNhdGVzLCBwcm9qZWN0UG9pbnRzVG8yRCwgc2NhbGVUb0VsbGlwc29pZFN1cmZhY2UsIGVsbGlwc29pZCwgc3BsaXRQb2x5Z29ucykgewogICAgICAgIGNvbnN0IGhpZXJhcmNoeSA9IFtdOwogICAgICAgIGNvbnN0IHBvbHlnb25zID0gW107CiAgICAgICAgY29uc3QgcXVldWUgPSBuZXcgUXVldWVfZGVmYXVsdCgpOwogICAgICAgIHF1ZXVlLmVucXVldWUocG9seWdvbkhpZXJhcmNoeSk7CiAgICAgICAgbGV0IHNwbGl0ID0gZGVmaW5lZF9kZWZhdWx0KHNwbGl0UG9seWdvbnMpOwogICAgICAgIHdoaWxlIChxdWV1ZS5sZW5ndGggIT09IDApIHsKICAgICAgICAgIGNvbnN0IG91dGVyTm9kZSA9IHF1ZXVlLmRlcXVldWUoKTsKICAgICAgICAgIGxldCBvdXRlclJpbmcgPSBvdXRlck5vZGUucG9zaXRpb25zOwogICAgICAgICAgY29uc3QgaG9sZXMgPSBvdXRlck5vZGUuaG9sZXM7CiAgICAgICAgICBsZXQgaTsKICAgICAgICAgIGxldCBsZW5ndGg7CiAgICAgICAgICBpZiAoc2NhbGVUb0VsbGlwc29pZFN1cmZhY2UpIHsKICAgICAgICAgICAgbGVuZ3RoID0gb3V0ZXJSaW5nLmxlbmd0aDsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2Uob3V0ZXJSaW5nW2ldLCBvdXRlclJpbmdbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWtlZXBEdXBsaWNhdGVzKSB7CiAgICAgICAgICAgIG91dGVyUmluZyA9IGFycmF5UmVtb3ZlRHVwbGljYXRlc19kZWZhdWx0KAogICAgICAgICAgICAgIG91dGVyUmluZywKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbiwKICAgICAgICAgICAgICB0cnVlCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob3V0ZXJSaW5nLmxlbmd0aCA8IDMpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBsZXQgcG9zaXRpb25zMkQgPSBwcm9qZWN0UG9pbnRzVG8yRChvdXRlclJpbmcpOwogICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zMkQpKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgaG9sZUluZGljZXMgPSBbXTsKICAgICAgICAgIGxldCBvcmlnaW5hbFdpbmRpbmdPcmRlciA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LmNvbXB1dGVXaW5kaW5nT3JkZXIyRCgKICAgICAgICAgICAgcG9zaXRpb25zMkQKICAgICAgICAgICk7CiAgICAgICAgICBpZiAob3JpZ2luYWxXaW5kaW5nT3JkZXIgPT09IFdpbmRpbmdPcmRlcl9kZWZhdWx0LkNMT0NLV0lTRSkgewogICAgICAgICAgICBwb3NpdGlvbnMyRC5yZXZlcnNlKCk7CiAgICAgICAgICAgIG91dGVyUmluZyA9IG91dGVyUmluZy5zbGljZSgpLnJldmVyc2UoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzcGxpdCkgewogICAgICAgICAgICBzcGxpdCA9IGZhbHNlOwogICAgICAgICAgICBsZXQgcG9seWdvbnMyID0gW291dGVyUmluZ107CiAgICAgICAgICAgIHBvbHlnb25zMiA9IHNwbGl0UG9seWdvbnMocG9seWdvbnMyLCBwb2x5Z29uczIpOwogICAgICAgICAgICBpZiAocG9seWdvbnMyLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICBmb3IgKGNvbnN0IHBvc2l0aW9uczIgb2YgcG9seWdvbnMyKSB7CiAgICAgICAgICAgICAgICBxdWV1ZS5lbnF1ZXVlKG5ldyBQb2x5Z29uSGllcmFyY2h5X2RlZmF1bHQocG9zaXRpb25zMiwgaG9sZXMpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGxldCBwb3NpdGlvbnMgPSBvdXRlclJpbmcuc2xpY2UoKTsKICAgICAgICAgIGNvbnN0IG51bUNoaWxkcmVuID0gZGVmaW5lZF9kZWZhdWx0KGhvbGVzKSA/IGhvbGVzLmxlbmd0aCA6IDA7CiAgICAgICAgICBjb25zdCBwb2x5Z29uSG9sZXMgPSBbXTsKICAgICAgICAgIGxldCBqOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IG51bUNoaWxkcmVuOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgaG9sZSA9IGhvbGVzW2ldOwogICAgICAgICAgICBsZXQgaG9sZVBvc2l0aW9ucyA9IGhvbGUucG9zaXRpb25zOwogICAgICAgICAgICBpZiAoc2NhbGVUb0VsbGlwc29pZFN1cmZhY2UpIHsKICAgICAgICAgICAgICBsZW5ndGggPSBob2xlUG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgbGVuZ3RoOyArK2opIHsKICAgICAgICAgICAgICAgIGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKGhvbGVQb3NpdGlvbnNbal0sIGhvbGVQb3NpdGlvbnNbal0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWtlZXBEdXBsaWNhdGVzKSB7CiAgICAgICAgICAgICAgaG9sZVBvc2l0aW9ucyA9IGFycmF5UmVtb3ZlRHVwbGljYXRlc19kZWZhdWx0KAogICAgICAgICAgICAgICAgaG9sZVBvc2l0aW9ucywKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uLAogICAgICAgICAgICAgICAgdHJ1ZQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhvbGVQb3NpdGlvbnMubGVuZ3RoIDwgMykgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IGhvbGVQb3NpdGlvbnMyRCA9IHByb2plY3RQb2ludHNUbzJEKGhvbGVQb3NpdGlvbnMpOwogICAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChob2xlUG9zaXRpb25zMkQpKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3JpZ2luYWxXaW5kaW5nT3JkZXIgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5jb21wdXRlV2luZGluZ09yZGVyMkQoCiAgICAgICAgICAgICAgaG9sZVBvc2l0aW9uczJECiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmIChvcmlnaW5hbFdpbmRpbmdPcmRlciA9PT0gV2luZGluZ09yZGVyX2RlZmF1bHQuQ0xPQ0tXSVNFKSB7CiAgICAgICAgICAgICAgaG9sZVBvc2l0aW9uczJELnJldmVyc2UoKTsKICAgICAgICAgICAgICBob2xlUG9zaXRpb25zID0gaG9sZVBvc2l0aW9ucy5zbGljZSgpLnJldmVyc2UoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwb2x5Z29uSG9sZXMucHVzaChob2xlUG9zaXRpb25zKTsKICAgICAgICAgICAgaG9sZUluZGljZXMucHVzaChwb3NpdGlvbnMubGVuZ3RoKTsKICAgICAgICAgICAgcG9zaXRpb25zID0gcG9zaXRpb25zLmNvbmNhdChob2xlUG9zaXRpb25zKTsKICAgICAgICAgICAgcG9zaXRpb25zMkQgPSBwb3NpdGlvbnMyRC5jb25jYXQoaG9sZVBvc2l0aW9uczJEKTsKICAgICAgICAgICAgbGV0IG51bUdyYW5kY2hpbGRyZW4gPSAwOwogICAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGhvbGUuaG9sZXMpKSB7CiAgICAgICAgICAgICAgbnVtR3JhbmRjaGlsZHJlbiA9IGhvbGUuaG9sZXMubGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBudW1HcmFuZGNoaWxkcmVuOyBqKyspIHsKICAgICAgICAgICAgICBxdWV1ZS5lbnF1ZXVlKGhvbGUuaG9sZXNbal0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBoaWVyYXJjaHkucHVzaCh7CiAgICAgICAgICAgIG91dGVyUmluZywKICAgICAgICAgICAgaG9sZXM6IHBvbHlnb25Ib2xlcwogICAgICAgICAgfSk7CiAgICAgICAgICBwb2x5Z29ucy5wdXNoKHsKICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICBwb3NpdGlvbnMyRCwKICAgICAgICAgICAgaG9sZXM6IGhvbGVJbmRpY2VzCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGhpZXJhcmNoeSwKICAgICAgICAgIHBvbHlnb25zCiAgICAgICAgfTsKICAgICAgfTsKICAgICAgY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlQ2FydGVzaWFuMiA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlQ2FydGVzaWFuMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlUXVhdGVybmlvbiA9IG5ldyBRdWF0ZXJuaW9uX2RlZmF1bHQoKTsKICAgICAgY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlTWF0cml4MyA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeS5jb21wdXRlQm91bmRpbmdSZWN0YW5nbGUgPSBmdW5jdGlvbihwbGFuZU5vcm1hbCwgcHJvamVjdFBvaW50VG8yRCwgcG9zaXRpb25zLCBhbmdsZSwgcmVzdWx0KSB7CiAgICAgICAgY29uc3Qgcm90YXRpb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbUF4aXNBbmdsZSgKICAgICAgICAgIHBsYW5lTm9ybWFsLAogICAgICAgICAgYW5nbGUsCiAgICAgICAgICBjb21wdXRlQm91bmRpbmdSZWN0YW5nbGVRdWF0ZXJuaW9uCiAgICAgICAgKTsKICAgICAgICBjb25zdCB0ZXh0dXJlTWF0cml4ID0gTWF0cml4M19kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKAogICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICBjb21wdXRlQm91bmRpbmdSZWN0YW5nbGVNYXRyaXgzCiAgICAgICAgKTsKICAgICAgICBsZXQgbWluWCA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgICAgICBsZXQgbWF4WCA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgICAgICBsZXQgbWluWSA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgICAgICBsZXQgbWF4WSA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGNvbnN0IHAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoCiAgICAgICAgICAgIHBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlQ2FydGVzaWFuMwogICAgICAgICAgKTsKICAgICAgICAgIE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKHRleHR1cmVNYXRyaXgsIHAsIHApOwogICAgICAgICAgY29uc3Qgc3QgPSBwcm9qZWN0UG9pbnRUbzJEKHAsIGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZUNhcnRlc2lhbjIpOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChzdCkpIHsKICAgICAgICAgICAgbWluWCA9IE1hdGgubWluKG1pblgsIHN0LngpOwogICAgICAgICAgICBtYXhYID0gTWF0aC5tYXgobWF4WCwgc3QueCk7CiAgICAgICAgICAgIG1pblkgPSBNYXRoLm1pbihtaW5ZLCBzdC55KTsKICAgICAgICAgICAgbWF4WSA9IE1hdGgubWF4KG1heFksIHN0LnkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IG1pblg7CiAgICAgICAgcmVzdWx0LnkgPSBtaW5ZOwogICAgICAgIHJlc3VsdC53aWR0aCA9IG1heFggLSBtaW5YOwogICAgICAgIHJlc3VsdC5oZWlnaHQgPSBtYXhZIC0gbWluWTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LmNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9ucyA9IGZ1bmN0aW9uKGVsbGlwc29pZCwgcG9seWdvbjIsIHRleHR1cmVDb29yZGluYXRlcywgZ3JhbnVsYXJpdHksIHBlclBvc2l0aW9uSGVpZ2h0LCB2ZXJ0ZXhGb3JtYXQsIGFyY1R5cGUpIHsKICAgICAgICBsZXQgaW5kaWNlcyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnRyaWFuZ3VsYXRlKHBvbHlnb24yLnBvc2l0aW9uczJELCBwb2x5Z29uMi5ob2xlcyk7CiAgICAgICAgaWYgKGluZGljZXMubGVuZ3RoIDwgMykgewogICAgICAgICAgaW5kaWNlcyA9IFswLCAxLCAyXTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gcG9seWdvbjIucG9zaXRpb25zOwogICAgICAgIGNvbnN0IGhhc1RleGNvb3JkcyA9IGRlZmluZWRfZGVmYXVsdCh0ZXh0dXJlQ29vcmRpbmF0ZXMpOwogICAgICAgIGNvbnN0IHRleGNvb3JkcyA9IGhhc1RleGNvb3JkcyA/IHRleHR1cmVDb29yZGluYXRlcy5wb3NpdGlvbnMgOiB2b2lkIDA7CiAgICAgICAgaWYgKHBlclBvc2l0aW9uSGVpZ2h0KSB7CiAgICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgICAgY29uc3QgZmxhdHRlbmVkUG9zaXRpb25zID0gbmV3IEFycmF5KGxlbmd0aCAqIDMpOwogICAgICAgICAgbGV0IGluZGV4ID0gMDsKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgcCA9IHBvc2l0aW9uc1tpXTsKICAgICAgICAgICAgZmxhdHRlbmVkUG9zaXRpb25zW2luZGV4KytdID0gcC54OwogICAgICAgICAgICBmbGF0dGVuZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwLnk7CiAgICAgICAgICAgIGZsYXR0ZW5lZFBvc2l0aW9uc1tpbmRleCsrXSA9IHAuejsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGdlb21ldHJ5T3B0aW9ucyA9IHsKICAgICAgICAgICAgYXR0cmlidXRlczogewogICAgICAgICAgICAgIHBvc2l0aW9uOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICAgICAgdmFsdWVzOiBmbGF0dGVuZWRQb3NpdGlvbnMKICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9LAogICAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTCiAgICAgICAgICB9OwogICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICBnZW9tZXRyeU9wdGlvbnMuYXR0cmlidXRlcy5zdCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgICAgICAgIHZhbHVlczogQ2FydGVzaWFuMl9kZWZhdWx0LnBhY2tBcnJheSh0ZXhjb29yZHMpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgR2VvbWV0cnlfZGVmYXVsdChnZW9tZXRyeU9wdGlvbnMpOwogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICAgICAgcmV0dXJuIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5jb21wdXRlTm9ybWFsKGdlb21ldHJ5KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZW9tZXRyeTsKICAgICAgICB9CiAgICAgICAgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQykgewogICAgICAgICAgcmV0dXJuIFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LmNvbXB1dGVTdWJkaXZpc2lvbigKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICAgIHRleGNvb3JkcywKICAgICAgICAgICAgZ3JhbnVsYXJpdHkKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgICAgIHJldHVybiBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5jb21wdXRlUmh1bWJMaW5lU3ViZGl2aXNpb24oCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgICB0ZXhjb29yZHMsCiAgICAgICAgICAgIGdyYW51bGFyaXR5CiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgY29tcHV0ZVdhbGxUZXhjb29yZHNTdWJkaXZpZGVkID0gW107CiAgICAgIGNvbXB1dGVXYWxsSW5kaWNlc1N1YmRpdmlkZWQgPSBbXTsKICAgICAgcDFTY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcDJTY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeS5jb21wdXRlV2FsbEdlb21ldHJ5ID0gZnVuY3Rpb24ocG9zaXRpb25zLCB0ZXh0dXJlQ29vcmRpbmF0ZXMsIGVsbGlwc29pZCwgZ3JhbnVsYXJpdHksIHBlclBvc2l0aW9uSGVpZ2h0LCBhcmNUeXBlKSB7CiAgICAgICAgbGV0IGVkZ2VQb3NpdGlvbnM7CiAgICAgICAgbGV0IHRvcEVkZ2VMZW5ndGg7CiAgICAgICAgbGV0IGk7CiAgICAgICAgbGV0IHAxOwogICAgICAgIGxldCBwMjsKICAgICAgICBsZXQgdDE7CiAgICAgICAgbGV0IHQyOwogICAgICAgIGxldCBlZGdlVGV4Y29vcmRzOwogICAgICAgIGxldCB0b3BFZGdlVGV4Y29vcmRMZW5ndGg7CiAgICAgICAgbGV0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgbGV0IGluZGV4ID0gMDsKICAgICAgICBsZXQgdGV4dHVyZUluZGV4ID0gMDsKICAgICAgICBjb25zdCBoYXNUZXhjb29yZHMgPSBkZWZpbmVkX2RlZmF1bHQodGV4dHVyZUNvb3JkaW5hdGVzKTsKICAgICAgICBjb25zdCB0ZXhjb29yZHMgPSBoYXNUZXhjb29yZHMgPyB0ZXh0dXJlQ29vcmRpbmF0ZXMucG9zaXRpb25zIDogdm9pZCAwOwogICAgICAgIGlmICghcGVyUG9zaXRpb25IZWlnaHQpIHsKICAgICAgICAgIGNvbnN0IG1pbkRpc3RhbmNlID0gTWF0aF9kZWZhdWx0LmNob3JkTGVuZ3RoKAogICAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgICAgZWxsaXBzb2lkLm1heGltdW1SYWRpdXMKICAgICAgICAgICk7CiAgICAgICAgICBsZXQgbnVtVmVydGljZXMgPSAwOwogICAgICAgICAgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQykgewogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBudW1WZXJ0aWNlcyArPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnN1YmRpdmlkZUxpbmVDb3VudCgKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1soaSArIDEpICUgbGVuZ3RoXSwKICAgICAgICAgICAgICAgIG1pbkRpc3RhbmNlCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgbnVtVmVydGljZXMgKz0gUG9seWdvbkdlb21ldHJ5TGlicmFyeS5zdWJkaXZpZGVSaHVtYkxpbmVDb3VudCgKICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1soaSArIDEpICUgbGVuZ3RoXSwKICAgICAgICAgICAgICAgIG1pbkRpc3RhbmNlCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdG9wRWRnZUxlbmd0aCA9IChudW1WZXJ0aWNlcyArIGxlbmd0aCkgKiAzOwogICAgICAgICAgZWRnZVBvc2l0aW9ucyA9IG5ldyBBcnJheSh0b3BFZGdlTGVuZ3RoICogMik7CiAgICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICAgIHRvcEVkZ2VUZXhjb29yZExlbmd0aCA9IChudW1WZXJ0aWNlcyArIGxlbmd0aCkgKiAyOwogICAgICAgICAgICBlZGdlVGV4Y29vcmRzID0gbmV3IEFycmF5KHRvcEVkZ2VUZXhjb29yZExlbmd0aCAqIDIpOwogICAgICAgICAgfQogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHAxID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgICBwMiA9IHBvc2l0aW9uc1soaSArIDEpICUgbGVuZ3RoXTsKICAgICAgICAgICAgbGV0IHRlbXBQb3NpdGlvbnM7CiAgICAgICAgICAgIGxldCB0ZW1wVGV4Y29vcmRzOwogICAgICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICAgICAgdDEgPSB0ZXhjb29yZHNbaV07CiAgICAgICAgICAgICAgdDIgPSB0ZXhjb29yZHNbKGkgKyAxKSAlIGxlbmd0aF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQykgewogICAgICAgICAgICAgIHRlbXBQb3NpdGlvbnMgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnN1YmRpdmlkZUxpbmUoCiAgICAgICAgICAgICAgICBwMSwKICAgICAgICAgICAgICAgIHAyLAogICAgICAgICAgICAgICAgbWluRGlzdGFuY2UsCiAgICAgICAgICAgICAgICBjb21wdXRlV2FsbEluZGljZXNTdWJkaXZpZGVkCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICAgICAgICB0ZW1wVGV4Y29vcmRzID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeS5zdWJkaXZpZGVUZXhjb29yZExpbmUoCiAgICAgICAgICAgICAgICAgIHQxLAogICAgICAgICAgICAgICAgICB0MiwKICAgICAgICAgICAgICAgICAgcDEsCiAgICAgICAgICAgICAgICAgIHAyLAogICAgICAgICAgICAgICAgICBtaW5EaXN0YW5jZSwKICAgICAgICAgICAgICAgICAgY29tcHV0ZVdhbGxUZXhjb29yZHNTdWJkaXZpZGVkCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgICAgICAgICB0ZW1wUG9zaXRpb25zID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeS5zdWJkaXZpZGVSaHVtYkxpbmUoCiAgICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgICBwMSwKICAgICAgICAgICAgICAgIHAyLAogICAgICAgICAgICAgICAgbWluRGlzdGFuY2UsCiAgICAgICAgICAgICAgICBjb21wdXRlV2FsbEluZGljZXNTdWJkaXZpZGVkCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICAgICAgICB0ZW1wVGV4Y29vcmRzID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeS5zdWJkaXZpZGVUZXhjb29yZFJodW1iTGluZSgKICAgICAgICAgICAgICAgICAgdDEsCiAgICAgICAgICAgICAgICAgIHQyLAogICAgICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgICAgIHAxLAogICAgICAgICAgICAgICAgICBwMiwKICAgICAgICAgICAgICAgICAgbWluRGlzdGFuY2UsCiAgICAgICAgICAgICAgICAgIGNvbXB1dGVXYWxsVGV4Y29vcmRzU3ViZGl2aWRlZAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgdGVtcFBvc2l0aW9uc0xlbmd0aCA9IHRlbXBQb3NpdGlvbnMubGVuZ3RoOwogICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHRlbXBQb3NpdGlvbnNMZW5ndGg7ICsraiwgKytpbmRleCkgewogICAgICAgICAgICAgIGVkZ2VQb3NpdGlvbnNbaW5kZXhdID0gdGVtcFBvc2l0aW9uc1tqXTsKICAgICAgICAgICAgICBlZGdlUG9zaXRpb25zW2luZGV4ICsgdG9wRWRnZUxlbmd0aF0gPSB0ZW1wUG9zaXRpb25zW2pdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVkZ2VQb3NpdGlvbnNbaW5kZXhdID0gcDIueDsKICAgICAgICAgICAgZWRnZVBvc2l0aW9uc1tpbmRleCArIHRvcEVkZ2VMZW5ndGhdID0gcDIueDsKICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgZWRnZVBvc2l0aW9uc1tpbmRleF0gPSBwMi55OwogICAgICAgICAgICBlZGdlUG9zaXRpb25zW2luZGV4ICsgdG9wRWRnZUxlbmd0aF0gPSBwMi55OwogICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICBlZGdlUG9zaXRpb25zW2luZGV4XSA9IHAyLno7CiAgICAgICAgICAgIGVkZ2VQb3NpdGlvbnNbaW5kZXggKyB0b3BFZGdlTGVuZ3RoXSA9IHAyLno7CiAgICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgICAgICBjb25zdCB0ZW1wVGV4Y29vcmRzTGVuZ3RoID0gdGVtcFRleGNvb3Jkcy5sZW5ndGg7CiAgICAgICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCB0ZW1wVGV4Y29vcmRzTGVuZ3RoOyArK2ssICsrdGV4dHVyZUluZGV4KSB7CiAgICAgICAgICAgICAgICBlZGdlVGV4Y29vcmRzW3RleHR1cmVJbmRleF0gPSB0ZW1wVGV4Y29vcmRzW2tdOwogICAgICAgICAgICAgICAgZWRnZVRleGNvb3Jkc1t0ZXh0dXJlSW5kZXggKyB0b3BFZGdlVGV4Y29vcmRMZW5ndGhdID0gdGVtcFRleGNvb3Jkc1trXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWRnZVRleGNvb3Jkc1t0ZXh0dXJlSW5kZXhdID0gdDIueDsKICAgICAgICAgICAgICBlZGdlVGV4Y29vcmRzW3RleHR1cmVJbmRleCArIHRvcEVkZ2VUZXhjb29yZExlbmd0aF0gPSB0Mi54OwogICAgICAgICAgICAgICsrdGV4dHVyZUluZGV4OwogICAgICAgICAgICAgIGVkZ2VUZXhjb29yZHNbdGV4dHVyZUluZGV4XSA9IHQyLnk7CiAgICAgICAgICAgICAgZWRnZVRleGNvb3Jkc1t0ZXh0dXJlSW5kZXggKyB0b3BFZGdlVGV4Y29vcmRMZW5ndGhdID0gdDIueTsKICAgICAgICAgICAgICArK3RleHR1cmVJbmRleDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0b3BFZGdlTGVuZ3RoID0gbGVuZ3RoICogMyAqIDI7CiAgICAgICAgICBlZGdlUG9zaXRpb25zID0gbmV3IEFycmF5KHRvcEVkZ2VMZW5ndGggKiAyKTsKICAgICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgICAgdG9wRWRnZVRleGNvb3JkTGVuZ3RoID0gbGVuZ3RoICogMiAqIDI7CiAgICAgICAgICAgIGVkZ2VUZXhjb29yZHMgPSBuZXcgQXJyYXkodG9wRWRnZVRleGNvb3JkTGVuZ3RoICogMik7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgcDEgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICAgIHAyID0gcG9zaXRpb25zWyhpICsgMSkgJSBsZW5ndGhdOwogICAgICAgICAgICBlZGdlUG9zaXRpb25zW2luZGV4XSA9IGVkZ2VQb3NpdGlvbnNbaW5kZXggKyB0b3BFZGdlTGVuZ3RoXSA9IHAxLng7CiAgICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICAgIGVkZ2VQb3NpdGlvbnNbaW5kZXhdID0gZWRnZVBvc2l0aW9uc1tpbmRleCArIHRvcEVkZ2VMZW5ndGhdID0gcDEueTsKICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgZWRnZVBvc2l0aW9uc1tpbmRleF0gPSBlZGdlUG9zaXRpb25zW2luZGV4ICsgdG9wRWRnZUxlbmd0aF0gPSBwMS56OwogICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICBlZGdlUG9zaXRpb25zW2luZGV4XSA9IGVkZ2VQb3NpdGlvbnNbaW5kZXggKyB0b3BFZGdlTGVuZ3RoXSA9IHAyLng7CiAgICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICAgIGVkZ2VQb3NpdGlvbnNbaW5kZXhdID0gZWRnZVBvc2l0aW9uc1tpbmRleCArIHRvcEVkZ2VMZW5ndGhdID0gcDIueTsKICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgZWRnZVBvc2l0aW9uc1tpbmRleF0gPSBlZGdlUG9zaXRpb25zW2luZGV4ICsgdG9wRWRnZUxlbmd0aF0gPSBwMi56OwogICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICAgICAgdDEgPSB0ZXhjb29yZHNbaV07CiAgICAgICAgICAgICAgdDIgPSB0ZXhjb29yZHNbKGkgKyAxKSAlIGxlbmd0aF07CiAgICAgICAgICAgICAgZWRnZVRleGNvb3Jkc1t0ZXh0dXJlSW5kZXhdID0gZWRnZVRleGNvb3Jkc1t0ZXh0dXJlSW5kZXggKyB0b3BFZGdlVGV4Y29vcmRMZW5ndGhdID0gdDEueDsKICAgICAgICAgICAgICArK3RleHR1cmVJbmRleDsKICAgICAgICAgICAgICBlZGdlVGV4Y29vcmRzW3RleHR1cmVJbmRleF0gPSBlZGdlVGV4Y29vcmRzW3RleHR1cmVJbmRleCArIHRvcEVkZ2VUZXhjb29yZExlbmd0aF0gPSB0MS55OwogICAgICAgICAgICAgICsrdGV4dHVyZUluZGV4OwogICAgICAgICAgICAgIGVkZ2VUZXhjb29yZHNbdGV4dHVyZUluZGV4XSA9IGVkZ2VUZXhjb29yZHNbdGV4dHVyZUluZGV4ICsgdG9wRWRnZVRleGNvb3JkTGVuZ3RoXSA9IHQyLng7CiAgICAgICAgICAgICAgKyt0ZXh0dXJlSW5kZXg7CiAgICAgICAgICAgICAgZWRnZVRleGNvb3Jkc1t0ZXh0dXJlSW5kZXhdID0gZWRnZVRleGNvb3Jkc1t0ZXh0dXJlSW5kZXggKyB0b3BFZGdlVGV4Y29vcmRMZW5ndGhdID0gdDIueTsKICAgICAgICAgICAgICArK3RleHR1cmVJbmRleDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBsZW5ndGggPSBlZGdlUG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgICAgICBsZW5ndGggLyAzLAogICAgICAgICAgbGVuZ3RoIC0gcG9zaXRpb25zLmxlbmd0aCAqIDYKICAgICAgICApOwogICAgICAgIGxldCBlZGdlSW5kZXggPSAwOwogICAgICAgIGxlbmd0aCAvPSA2OwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgVUwgPSBpOwogICAgICAgICAgY29uc3QgVVIgPSBVTCArIDE7CiAgICAgICAgICBjb25zdCBMTCA9IFVMICsgbGVuZ3RoOwogICAgICAgICAgY29uc3QgTFIgPSBMTCArIDE7CiAgICAgICAgICBwMSA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoZWRnZVBvc2l0aW9ucywgVUwgKiAzLCBwMVNjcmF0Y2gyKTsKICAgICAgICAgIHAyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShlZGdlUG9zaXRpb25zLCBVUiAqIDMsIHAyU2NyYXRjaDIpOwogICAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgICBwMSwKICAgICAgICAgICAgcDIsCiAgICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTAsCiAgICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTAKICAgICAgICAgICkpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IFVMOwogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBMTDsKICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gVVI7CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IFVSOwogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBMTDsKICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gTFI7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGdlb21ldHJ5T3B0aW9ucyA9IHsKICAgICAgICAgIGF0dHJpYnV0ZXM6IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCh7CiAgICAgICAgICAgIHBvc2l0aW9uOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiBlZGdlUG9zaXRpb25zCiAgICAgICAgICAgIH0pCiAgICAgICAgICB9KSwKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTCiAgICAgICAgfTsKICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICBnZW9tZXRyeU9wdGlvbnMuYXR0cmlidXRlcy5zdCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgICAgIHZhbHVlczogZWRnZVRleGNvb3JkcwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IEdlb21ldHJ5X2RlZmF1bHQoZ2VvbWV0cnlPcHRpb25zKTsKICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgIH07CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdCA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db3BsYW5hclBvbHlnb25HZW9tZXRyeS5qcwogIGZ1bmN0aW9uIGNyZWF0ZUdlb21ldHJ5RnJvbVBvbHlnb24ocG9seWdvbjIsIHZlcnRleEZvcm1hdCwgYm91bmRpbmdSZWN0YW5nbGUsIHN0Um90YXRpb24sIGhhcmRjb2RlZFRleHR1cmVDb29yZGluYXRlcywgcHJvamVjdFBvaW50VG8yRCwgbm9ybWFsMiwgdGFuZ2VudCwgYml0YW5nZW50KSB7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBwb2x5Z29uMi5wb3NpdGlvbnM7CiAgICBsZXQgaW5kaWNlcyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnRyaWFuZ3VsYXRlKHBvbHlnb24yLnBvc2l0aW9uczJELCBwb2x5Z29uMi5ob2xlcyk7CiAgICBpZiAoaW5kaWNlcy5sZW5ndGggPCAzKSB7CiAgICAgIGluZGljZXMgPSBbMCwgMSwgMl07CiAgICB9CiAgICBjb25zdCBuZXdJbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIHBvc2l0aW9ucy5sZW5ndGgsCiAgICAgIGluZGljZXMubGVuZ3RoCiAgICApOwogICAgbmV3SW5kaWNlcy5zZXQoaW5kaWNlcyk7CiAgICBsZXQgdGV4dHVyZU1hdHJpeCA9IHRleHR1cmVNYXRyaXhTY3JhdGNoMjsKICAgIGlmIChzdFJvdGF0aW9uICE9PSAwKSB7CiAgICAgIGxldCByb3RhdGlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKAogICAgICAgIG5vcm1hbDIsCiAgICAgICAgc3RSb3RhdGlvbiwKICAgICAgICBxdWF0ZXJuaW9uU2NyYXRjaDIKICAgICAgKTsKICAgICAgdGV4dHVyZU1hdHJpeCA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tUXVhdGVybmlvbihyb3RhdGlvbiwgdGV4dHVyZU1hdHJpeCk7CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgcm90YXRpb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbUF4aXNBbmdsZSgKICAgICAgICAgIG5vcm1hbDIsCiAgICAgICAgICAtc3RSb3RhdGlvbiwKICAgICAgICAgIHF1YXRlcm5pb25TY3JhdGNoMgogICAgICAgICk7CiAgICAgICAgY29uc3QgdGFuZ2VudFJvdGF0aW9uID0gTWF0cml4M19kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKAogICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICB0YW5nZW50Um90YXRpb25TY3JhdGNoCiAgICAgICAgKTsKICAgICAgICB0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgIE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKHRhbmdlbnRSb3RhdGlvbiwgdGFuZ2VudCwgdGFuZ2VudCksCiAgICAgICAgICB0YW5nZW50CiAgICAgICAgKTsKICAgICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgYml0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKG5vcm1hbDIsIHRhbmdlbnQsIGJpdGFuZ2VudCksCiAgICAgICAgICAgIGJpdGFuZ2VudAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHRleHR1cmVNYXRyaXggPSBNYXRyaXgzX2RlZmF1bHQuY2xvbmUoTWF0cml4M19kZWZhdWx0LklERU5USVRZLCB0ZXh0dXJlTWF0cml4KTsKICAgIH0KICAgIGNvbnN0IHN0T3JpZ2luID0gdGV4dHVyZUNvb3JkaW5hdGVzT3JpZ2luOwogICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICBzdE9yaWdpbi54ID0gYm91bmRpbmdSZWN0YW5nbGUueDsKICAgICAgc3RPcmlnaW4ueSA9IGJvdW5kaW5nUmVjdGFuZ2xlLnk7CiAgICB9CiAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgY29uc3Qgc2l6ZSA9IGxlbmd0aCAqIDM7CiAgICBjb25zdCBmbGF0UG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShzaXplKTsKICAgIGNvbnN0IG5vcm1hbHMgPSB2ZXJ0ZXhGb3JtYXQubm9ybWFsID8gbmV3IEZsb2F0MzJBcnJheShzaXplKSA6IHZvaWQgMDsKICAgIGNvbnN0IHRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LnRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUpIDogdm9pZCAwOwogICAgY29uc3QgYml0YW5nZW50cyA9IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUpIDogdm9pZCAwOwogICAgY29uc3QgdGV4dHVyZUNvb3JkaW5hdGVzID0gdmVydGV4Rm9ybWF0LnN0ID8gbmV3IEZsb2F0MzJBcnJheShsZW5ndGggKiAyKSA6IHZvaWQgMDsKICAgIGxldCBwb3NpdGlvbkluZGV4ID0gMDsKICAgIGxldCBub3JtYWxJbmRleCA9IDA7CiAgICBsZXQgYml0YW5nZW50SW5kZXggPSAwOwogICAgbGV0IHRhbmdlbnRJbmRleCA9IDA7CiAgICBsZXQgc3RJbmRleCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHBvc2l0aW9uID0gcG9zaXRpb25zW2ldOwogICAgICBmbGF0UG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi54OwogICAgICBmbGF0UG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi55OwogICAgICBmbGF0UG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi56OwogICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChoYXJkY29kZWRUZXh0dXJlQ29vcmRpbmF0ZXMpICYmIGhhcmRjb2RlZFRleHR1cmVDb29yZGluYXRlcy5wb3NpdGlvbnMubGVuZ3RoID09PSBsZW5ndGgpIHsKICAgICAgICAgIHRleHR1cmVDb29yZGluYXRlc1tzdEluZGV4KytdID0gaGFyZGNvZGVkVGV4dHVyZUNvb3JkaW5hdGVzLnBvc2l0aW9uc1tpXS54OwogICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3N0SW5kZXgrK10gPSBoYXJkY29kZWRUZXh0dXJlQ29vcmRpbmF0ZXMucG9zaXRpb25zW2ldLnk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IHAgPSBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3RvcigKICAgICAgICAgICAgdGV4dHVyZU1hdHJpeCwKICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgIHNjcmF0Y2hQb3NpdGlvbgogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHN0ID0gcHJvamVjdFBvaW50VG8yRChwLCBzdFNjcmF0Y2gpOwogICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0LnN1YnRyYWN0KHN0LCBzdE9yaWdpbiwgc3QpOwogICAgICAgICAgY29uc3Qgc3R4ID0gTWF0aF9kZWZhdWx0LmNsYW1wKHN0LnggLyBib3VuZGluZ1JlY3RhbmdsZS53aWR0aCwgMCwgMSk7CiAgICAgICAgICBjb25zdCBzdHkgPSBNYXRoX2RlZmF1bHQuY2xhbXAoc3QueSAvIGJvdW5kaW5nUmVjdGFuZ2xlLmhlaWdodCwgMCwgMSk7CiAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbc3RJbmRleCsrXSA9IHN0eDsKICAgICAgICAgIHRleHR1cmVDb29yZGluYXRlc1tzdEluZGV4KytdID0gc3R5OwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLng7CiAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueTsKICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi56OwogICAgICB9CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueDsKICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lnk7CiAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC56OwogICAgICB9CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC54OwogICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQueTsKICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lno7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoKTsKICAgIGlmICh2ZXJ0ZXhGb3JtYXQucG9zaXRpb24pIHsKICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IGZsYXRQb3NpdGlvbnMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICBhdHRyaWJ1dGVzLm5vcm1hbCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogbm9ybWFscwogICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICBhdHRyaWJ1dGVzLnRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IHRhbmdlbnRzCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgYXR0cmlidXRlcy5iaXRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IGJpdGFuZ2VudHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgIGF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICB2YWx1ZXM6IHRleHR1cmVDb29yZGluYXRlcwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgIGF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXM6IG5ld0luZGljZXMsCiAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMKICAgIH0pOwogIH0KICBmdW5jdGlvbiBDb3BsYW5hclBvbHlnb25HZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHBvbHlnb25IaWVyYXJjaHkgPSBvcHRpb25zLnBvbHlnb25IaWVyYXJjaHk7CiAgICBjb25zdCB0ZXh0dXJlQ29vcmRpbmF0ZXMgPSBvcHRpb25zLnRleHR1cmVDb29yZGluYXRlczsKICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib3B0aW9ucy5wb2x5Z29uSGllcmFyY2h5IiwgcG9seWdvbkhpZXJhcmNoeSk7CiAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnZlcnRleEZvcm1hdCwgVmVydGV4Rm9ybWF0X2RlZmF1bHQuREVGQVVMVCk7CiAgICB0aGlzLl92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSh2ZXJ0ZXhGb3JtYXQpOwogICAgdGhpcy5fcG9seWdvbkhpZXJhcmNoeSA9IHBvbHlnb25IaWVyYXJjaHk7CiAgICB0aGlzLl9zdFJvdGF0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zdFJvdGF0aW9uLCAwKTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpCiAgICApOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeSI7CiAgICB0aGlzLl90ZXh0dXJlQ29vcmRpbmF0ZXMgPSB0ZXh0dXJlQ29vcmRpbmF0ZXM7CiAgICB0aGlzLnBhY2tlZExlbmd0aCA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlSGllcmFyY2h5UGFja2VkTGVuZ3RoKAogICAgICBwb2x5Z29uSGllcmFyY2h5LAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQKICAgICkgKyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAoZGVmaW5lZF9kZWZhdWx0KHRleHR1cmVDb29yZGluYXRlcykgPyBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZUhpZXJhcmNoeVBhY2tlZExlbmd0aCgKICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzLAogICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQKICAgICkgOiAxKSArIDI7CiAgfQogIHZhciBzY3JhdGNoUG9zaXRpb24sIHNjcmF0Y2hCUiwgc3RTY3JhdGNoLCB0ZXh0dXJlQ29vcmRpbmF0ZXNPcmlnaW4sIHNjcmF0Y2hOb3JtYWw0LCBzY3JhdGNoVGFuZ2VudDIsIHNjcmF0Y2hCaXRhbmdlbnQyLCBjZW50ZXJTY3JhdGNoLCBheGlzMVNjcmF0Y2gsIGF4aXMyU2NyYXRjaCwgcXVhdGVybmlvblNjcmF0Y2gyLCB0ZXh0dXJlTWF0cml4U2NyYXRjaDIsIHRhbmdlbnRSb3RhdGlvblNjcmF0Y2gsIHN1cmZhY2VOb3JtYWxTY3JhdGNoLCBzY3JhdGNoRWxsaXBzb2lkMywgc2NyYXRjaFZlcnRleEZvcm1hdDMsIHNjcmF0Y2hPcHRpb25zNywgQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9Db3BsYW5hclBvbHlnb25HZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2FycmF5UmVtb3ZlRHVwbGljYXRlcygpOwogICAgICBpbml0X0JvdW5kaW5nUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9Db3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5SW5zdGFuY2UoKTsKICAgICAgaW5pdF9HZW9tZXRyeVBpcGVsaW5lKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfUG9seWdvbkdlb21ldHJ5TGlicmFyeSgpOwogICAgICBpbml0X1BvbHlnb25QaXBlbGluZSgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9RdWF0ZXJuaW9uKCk7CiAgICAgIGluaXRfVmVydGV4Rm9ybWF0KCk7CiAgICAgIHNjcmF0Y2hQb3NpdGlvbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEJSID0gbmV3IEJvdW5kaW5nUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgc3RTY3JhdGNoID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNPcmlnaW4gPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hOb3JtYWw0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVGFuZ2VudDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hCaXRhbmdlbnQyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjZW50ZXJTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBheGlzMVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGF4aXMyU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcXVhdGVybmlvblNjcmF0Y2gyID0gbmV3IFF1YXRlcm5pb25fZGVmYXVsdCgpOwogICAgICB0ZXh0dXJlTWF0cml4U2NyYXRjaDIgPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIHRhbmdlbnRSb3RhdGlvblNjcmF0Y2ggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIHN1cmZhY2VOb3JtYWxTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBDb3BsYW5hclBvbHlnb25HZW9tZXRyeS5mcm9tUG9zaXRpb25zID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib3B0aW9ucy5wb3NpdGlvbnMiLCBvcHRpb25zLnBvc2l0aW9ucyk7CiAgICAgICAgY29uc3QgbmV3T3B0aW9ucyA9IHsKICAgICAgICAgIHBvbHlnb25IaWVyYXJjaHk6IHsKICAgICAgICAgICAgcG9zaXRpb25zOiBvcHRpb25zLnBvc2l0aW9ucwogICAgICAgICAgfSwKICAgICAgICAgIHZlcnRleEZvcm1hdDogb3B0aW9ucy52ZXJ0ZXhGb3JtYXQsCiAgICAgICAgICBzdFJvdGF0aW9uOiBvcHRpb25zLnN0Um90YXRpb24sCiAgICAgICAgICBlbGxpcHNvaWQ6IG9wdGlvbnMuZWxsaXBzb2lkLAogICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzOiBvcHRpb25zLnRleHR1cmVDb29yZGluYXRlcwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIG5ldyBDb3BsYW5hclBvbHlnb25HZW9tZXRyeShuZXdPcHRpb25zKTsKICAgICAgfTsKICAgICAgQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5wYWNrUG9seWdvbkhpZXJhcmNoeSgKICAgICAgICAgIHZhbHVlLl9wb2x5Z29uSGllcmFyY2h5LAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0CiAgICAgICAgKTsKICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrKHZhbHVlLl92ZXJ0ZXhGb3JtYXQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3N0Um90YXRpb247CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh2YWx1ZS5fdGV4dHVyZUNvb3JkaW5hdGVzKSkgewogICAgICAgICAgc3RhcnRpbmdJbmRleCA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5wYWNrUG9seWdvbkhpZXJhcmNoeSgKICAgICAgICAgICAgdmFsdWUuX3RleHR1cmVDb29yZGluYXRlcywKICAgICAgICAgICAgYXJyYXksCiAgICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdAogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IC0xOwogICAgICAgIH0KICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUucGFja2VkTGVuZ3RoOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaEVsbGlwc29pZDMgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShFbGxpcHNvaWRfZGVmYXVsdC5VTklUX1NQSEVSRSk7CiAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQzID0gbmV3IFZlcnRleEZvcm1hdF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hPcHRpb25zNyA9IHsKICAgICAgICBwb2x5Z29uSGllcmFyY2h5OiB7fQogICAgICB9OwogICAgICBDb3BsYW5hclBvbHlnb25HZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgcG9seWdvbkhpZXJhcmNoeSA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC51bnBhY2tQb2x5Z29uSGllcmFyY2h5KAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0CiAgICAgICAgKTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gcG9seWdvbkhpZXJhcmNoeS5zdGFydGluZ0luZGV4OwogICAgICAgIGRlbGV0ZSBwb2x5Z29uSGllcmFyY2h5LnN0YXJ0aW5nSW5kZXg7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoRWxsaXBzb2lkMyk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDMKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IHN0Um90YXRpb24gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHRleHR1cmVDb29yZGluYXRlcyA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdID09PSAtMSA/IHZvaWQgMCA6IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC51bnBhY2tQb2x5Z29uSGllcmFyY2h5KAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0CiAgICAgICAgKTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHRleHR1cmVDb29yZGluYXRlcykpIHsKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggPSB0ZXh0dXJlQ29vcmRpbmF0ZXMuc3RhcnRpbmdJbmRleDsKICAgICAgICAgIGRlbGV0ZSB0ZXh0dXJlQ29vcmRpbmF0ZXMuc3RhcnRpbmdJbmRleDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RhcnRpbmdJbmRleCsrOwogICAgICAgIH0KICAgICAgICBjb25zdCBwYWNrZWRMZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDb3BsYW5hclBvbHlnb25HZW9tZXRyeShzY3JhdGNoT3B0aW9uczcpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX3BvbHlnb25IaWVyYXJjaHkgPSBwb2x5Z29uSGllcmFyY2h5OwogICAgICAgIHJlc3VsdC5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkLCByZXN1bHQuX2VsbGlwc29pZCk7CiAgICAgICAgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSh2ZXJ0ZXhGb3JtYXQsIHJlc3VsdC5fdmVydGV4Rm9ybWF0KTsKICAgICAgICByZXN1bHQuX3N0Um90YXRpb24gPSBzdFJvdGF0aW9uOwogICAgICAgIHJlc3VsdC5fdGV4dHVyZUNvb3JkaW5hdGVzID0gdGV4dHVyZUNvb3JkaW5hdGVzOwogICAgICAgIHJlc3VsdC5wYWNrZWRMZW5ndGggPSBwYWNrZWRMZW5ndGg7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihwb2x5Z29uR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBwb2x5Z29uR2VvbWV0cnkuX3ZlcnRleEZvcm1hdDsKICAgICAgICBjb25zdCBwb2x5Z29uSGllcmFyY2h5ID0gcG9seWdvbkdlb21ldHJ5Ll9wb2x5Z29uSGllcmFyY2h5OwogICAgICAgIGNvbnN0IHN0Um90YXRpb24gPSBwb2x5Z29uR2VvbWV0cnkuX3N0Um90YXRpb247CiAgICAgICAgY29uc3QgdGV4dHVyZUNvb3JkaW5hdGVzID0gcG9seWdvbkdlb21ldHJ5Ll90ZXh0dXJlQ29vcmRpbmF0ZXM7CiAgICAgICAgY29uc3QgaGFzVGV4dHVyZUNvb3JkaW5hdGVzID0gZGVmaW5lZF9kZWZhdWx0KHRleHR1cmVDb29yZGluYXRlcyk7CiAgICAgICAgbGV0IG91dGVyUG9zaXRpb25zID0gcG9seWdvbkhpZXJhcmNoeS5wb3NpdGlvbnM7CiAgICAgICAgb3V0ZXJQb3NpdGlvbnMgPSBhcnJheVJlbW92ZUR1cGxpY2F0ZXNfZGVmYXVsdCgKICAgICAgICAgIG91dGVyUG9zaXRpb25zLAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24sCiAgICAgICAgICB0cnVlCiAgICAgICAgKTsKICAgICAgICBpZiAob3V0ZXJQb3NpdGlvbnMubGVuZ3RoIDwgMykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBsZXQgbm9ybWFsMiA9IHNjcmF0Y2hOb3JtYWw0OwogICAgICAgIGxldCB0YW5nZW50ID0gc2NyYXRjaFRhbmdlbnQyOwogICAgICAgIGxldCBiaXRhbmdlbnQgPSBzY3JhdGNoQml0YW5nZW50MjsKICAgICAgICBsZXQgYXhpczEgPSBheGlzMVNjcmF0Y2g7CiAgICAgICAgY29uc3QgYXhpczIgPSBheGlzMlNjcmF0Y2g7CiAgICAgICAgY29uc3QgdmFsaWRHZW9tZXRyeSA9IENvcGxhbmFyUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQcm9qZWN0VG8yREFyZ3VtZW50cygKICAgICAgICAgIG91dGVyUG9zaXRpb25zLAogICAgICAgICAgY2VudGVyU2NyYXRjaCwKICAgICAgICAgIGF4aXMxLAogICAgICAgICAgYXhpczIKICAgICAgICApOwogICAgICAgIGlmICghdmFsaWRHZW9tZXRyeSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgbm9ybWFsMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhheGlzMSwgYXhpczIsIG5vcm1hbDIpOwogICAgICAgIG5vcm1hbDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgIGlmICghQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBjZW50ZXJTY3JhdGNoLAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjYKICAgICAgICApKSB7CiAgICAgICAgICBjb25zdCBzdXJmYWNlTm9ybWFsID0gcG9seWdvbkdlb21ldHJ5Ll9lbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKAogICAgICAgICAgICBjZW50ZXJTY3JhdGNoLAogICAgICAgICAgICBzdXJmYWNlTm9ybWFsU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KG5vcm1hbDIsIHN1cmZhY2VOb3JtYWwpIDwgMCkgewogICAgICAgICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShub3JtYWwyLCBub3JtYWwyKTsKICAgICAgICAgICAgYXhpczEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGF4aXMxLCBheGlzMSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IHByb2plY3RQb2ludHMgPSBDb3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jcmVhdGVQcm9qZWN0UG9pbnRzVG8yREZ1bmN0aW9uKAogICAgICAgICAgY2VudGVyU2NyYXRjaCwKICAgICAgICAgIGF4aXMxLAogICAgICAgICAgYXhpczIKICAgICAgICApOwogICAgICAgIGNvbnN0IHByb2plY3RQb2ludCA9IENvcGxhbmFyUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNyZWF0ZVByb2plY3RQb2ludFRvMkRGdW5jdGlvbigKICAgICAgICAgIGNlbnRlclNjcmF0Y2gsCiAgICAgICAgICBheGlzMSwKICAgICAgICAgIGF4aXMyCiAgICAgICAgKTsKICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICAgIHRhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoYXhpczEsIHRhbmdlbnQpOwogICAgICAgIH0KICAgICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgYml0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGF4aXMyLCBiaXRhbmdlbnQpOwogICAgICAgIH0KICAgICAgICBjb25zdCByZXN1bHRzID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnBvbHlnb25zRnJvbUhpZXJhcmNoeSgKICAgICAgICAgIHBvbHlnb25IaWVyYXJjaHksCiAgICAgICAgICBoYXNUZXh0dXJlQ29vcmRpbmF0ZXMsCiAgICAgICAgICBwcm9qZWN0UG9pbnRzLAogICAgICAgICAgZmFsc2UKICAgICAgICApOwogICAgICAgIGNvbnN0IGhpZXJhcmNoeSA9IHJlc3VsdHMuaGllcmFyY2h5OwogICAgICAgIGNvbnN0IHBvbHlnb25zID0gcmVzdWx0cy5wb2x5Z29uczsKICAgICAgICBjb25zdCBkdW1teUZ1bmN0aW9uID0gZnVuY3Rpb24oaWRlbnRpdHkpIHsKICAgICAgICAgIHJldHVybiBpZGVudGl0eTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IHRleHR1cmVDb29yZGluYXRlUG9seWdvbnMgPSBoYXNUZXh0dXJlQ29vcmRpbmF0ZXMgPyBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQucG9seWdvbnNGcm9tSGllcmFyY2h5KAogICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzLAogICAgICAgICAgdHJ1ZSwKICAgICAgICAgIGR1bW15RnVuY3Rpb24sCiAgICAgICAgICBmYWxzZQogICAgICAgICkucG9seWdvbnMgOiB2b2lkIDA7CiAgICAgICAgaWYgKGhpZXJhcmNoeS5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgb3V0ZXJQb3NpdGlvbnMgPSBoaWVyYXJjaHlbMF0ub3V0ZXJSaW5nOwogICAgICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tUG9pbnRzKG91dGVyUG9zaXRpb25zKTsKICAgICAgICBjb25zdCBib3VuZGluZ1JlY3RhbmdsZSA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlQm91bmRpbmdSZWN0YW5nbGUoCiAgICAgICAgICBub3JtYWwyLAogICAgICAgICAgcHJvamVjdFBvaW50LAogICAgICAgICAgb3V0ZXJQb3NpdGlvbnMsCiAgICAgICAgICBzdFJvdGF0aW9uLAogICAgICAgICAgc2NyYXRjaEJSCiAgICAgICAgKTsKICAgICAgICBjb25zdCBnZW9tZXRyaWVzID0gW107CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb2x5Z29ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgZ2VvbWV0cnlJbnN0YW5jZSA9IG5ldyBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQoewogICAgICAgICAgICBnZW9tZXRyeTogY3JlYXRlR2VvbWV0cnlGcm9tUG9seWdvbigKICAgICAgICAgICAgICBwb2x5Z29uc1tpXSwKICAgICAgICAgICAgICB2ZXJ0ZXhGb3JtYXQsCiAgICAgICAgICAgICAgYm91bmRpbmdSZWN0YW5nbGUsCiAgICAgICAgICAgICAgc3RSb3RhdGlvbiwKICAgICAgICAgICAgICBoYXNUZXh0dXJlQ29vcmRpbmF0ZXMgPyB0ZXh0dXJlQ29vcmRpbmF0ZVBvbHlnb25zW2ldIDogdm9pZCAwLAogICAgICAgICAgICAgIHByb2plY3RQb2ludCwKICAgICAgICAgICAgICBub3JtYWwyLAogICAgICAgICAgICAgIHRhbmdlbnQsCiAgICAgICAgICAgICAgYml0YW5nZW50CiAgICAgICAgICAgICkKICAgICAgICAgIH0pOwogICAgICAgICAgZ2VvbWV0cmllcy5wdXNoKGdlb21ldHJ5SW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBjb25zdCBnZW9tZXRyeSA9IEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5jb21iaW5lSW5zdGFuY2VzKGdlb21ldHJpZXMpWzBdOwogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzID0gbmV3IEZsb2F0NjRBcnJheSgKICAgICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzCiAgICAgICAgKTsKICAgICAgICBnZW9tZXRyeS5pbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGggLyAzLAogICAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcwogICAgICAgICk7CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgaWYgKCF2ZXJ0ZXhGb3JtYXQucG9zaXRpb24pIHsKICAgICAgICAgIGRlbGV0ZSBhdHRyaWJ1dGVzLnBvc2l0aW9uOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXM6IGdlb21ldHJ5LmluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBnZW9tZXRyeS5wcmltaXRpdmVUeXBlLAogICAgICAgICAgYm91bmRpbmdTcGhlcmUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlfZGVmYXVsdCA9IENvcGxhbmFyUG9seWdvbkdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeShwb2x5Z29uR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIHBvbHlnb25HZW9tZXRyeSA9IENvcGxhbmFyUG9seWdvbkdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKHBvbHlnb25HZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHJldHVybiBDb3BsYW5hclBvbHlnb25HZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KHBvbHlnb25HZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGNyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9ucyhwb3NpdGlvbnMpIHsKICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICBjb25zdCBmbGF0UG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShsZW5ndGggKiAzKTsKICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShsZW5ndGgsIGxlbmd0aCAqIDIpOwogICAgbGV0IHBvc2l0aW9uSW5kZXggPSAwOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcG9zaXRpb24gPSBwb3NpdGlvbnNbaV07CiAgICAgIGZsYXRQb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHBvc2l0aW9uLng7CiAgICAgIGZsYXRQb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHBvc2l0aW9uLnk7CiAgICAgIGZsYXRQb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHBvc2l0aW9uLno7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gKGkgKyAxKSAlIGxlbmd0aDsKICAgIH0KICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoewogICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogZmxhdFBvc2l0aW9ucwogICAgICB9KQogICAgfSk7CiAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICBhdHRyaWJ1dGVzLAogICAgICBpbmRpY2VzLAogICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMKICAgIH0pOwogIH0KICBmdW5jdGlvbiBDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCBwb2x5Z29uSGllcmFyY2h5ID0gb3B0aW9ucy5wb2x5Z29uSGllcmFyY2h5OwogICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvcHRpb25zLnBvbHlnb25IaWVyYXJjaHkiLCBwb2x5Z29uSGllcmFyY2h5KTsKICAgIHRoaXMuX3BvbHlnb25IaWVyYXJjaHkgPSBwb2x5Z29uSGllcmFyY2h5OwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkiOwogICAgdGhpcy5wYWNrZWRMZW5ndGggPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZUhpZXJhcmNoeVBhY2tlZExlbmd0aCgKICAgICAgcG9seWdvbkhpZXJhcmNoeSwKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0CiAgICApICsgMTsKICB9CiAgdmFyIHNjcmF0Y2hPcHRpb25zOCwgQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2FycmF5UmVtb3ZlRHVwbGljYXRlcygpOwogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9Db3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5SW5zdGFuY2UoKTsKICAgICAgaW5pdF9HZW9tZXRyeVBpcGVsaW5lKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X1BvbHlnb25HZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIENvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeS5mcm9tUG9zaXRpb25zID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib3B0aW9ucy5wb3NpdGlvbnMiLCBvcHRpb25zLnBvc2l0aW9ucyk7CiAgICAgICAgY29uc3QgbmV3T3B0aW9ucyA9IHsKICAgICAgICAgIHBvbHlnb25IaWVyYXJjaHk6IHsKICAgICAgICAgICAgcG9zaXRpb25zOiBvcHRpb25zLnBvc2l0aW9ucwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcmV0dXJuIG5ldyBDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkobmV3T3B0aW9ucyk7CiAgICAgIH07CiAgICAgIENvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnBhY2tQb2x5Z29uSGllcmFyY2h5KAogICAgICAgICAgdmFsdWUuX3BvbHlnb25IaWVyYXJjaHksCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQKICAgICAgICApOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gdmFsdWUucGFja2VkTGVuZ3RoOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaE9wdGlvbnM4ID0gewogICAgICAgIHBvbHlnb25IaWVyYXJjaHk6IHt9CiAgICAgIH07CiAgICAgIENvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgcG9seWdvbkhpZXJhcmNoeSA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC51bnBhY2tQb2x5Z29uSGllcmFyY2h5KAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0CiAgICAgICAgKTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gcG9seWdvbkhpZXJhcmNoeS5zdGFydGluZ0luZGV4OwogICAgICAgIGRlbGV0ZSBwb2x5Z29uSGllcmFyY2h5LnN0YXJ0aW5nSW5kZXg7CiAgICAgICAgY29uc3QgcGFja2VkTGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX3BvbHlnb25IaWVyYXJjaHkgPSBwb2x5Z29uSGllcmFyY2h5OwogICAgICAgIHJlc3VsdC5wYWNrZWRMZW5ndGggPSBwYWNrZWRMZW5ndGg7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24ocG9seWdvbkdlb21ldHJ5KSB7CiAgICAgICAgY29uc3QgcG9seWdvbkhpZXJhcmNoeSA9IHBvbHlnb25HZW9tZXRyeS5fcG9seWdvbkhpZXJhcmNoeTsKICAgICAgICBsZXQgb3V0ZXJQb3NpdGlvbnMgPSBwb2x5Z29uSGllcmFyY2h5LnBvc2l0aW9uczsKICAgICAgICBvdXRlclBvc2l0aW9ucyA9IGFycmF5UmVtb3ZlRHVwbGljYXRlc19kZWZhdWx0KAogICAgICAgICAgb3V0ZXJQb3NpdGlvbnMsCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbiwKICAgICAgICAgIHRydWUKICAgICAgICApOwogICAgICAgIGlmIChvdXRlclBvc2l0aW9ucy5sZW5ndGggPCAzKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGlzVmFsaWQgPSBDb3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC52YWxpZE91dGxpbmUob3V0ZXJQb3NpdGlvbnMpOwogICAgICAgIGlmICghaXNWYWxpZCkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgY29uc3QgcG9seWdvbnMgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQucG9seWdvbk91dGxpbmVzRnJvbUhpZXJhcmNoeSgKICAgICAgICAgIHBvbHlnb25IaWVyYXJjaHksCiAgICAgICAgICBmYWxzZQogICAgICAgICk7CiAgICAgICAgaWYgKHBvbHlnb25zLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgY29uc3QgZ2VvbWV0cmllcyA9IFtdOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9seWdvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGdlb21ldHJ5SW5zdGFuY2UgPSBuZXcgR2VvbWV0cnlJbnN0YW5jZV9kZWZhdWx0KHsKICAgICAgICAgICAgZ2VvbWV0cnk6IGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9ucyhwb2x5Z29uc1tpXSkKICAgICAgICAgIH0pOwogICAgICAgICAgZ2VvbWV0cmllcy5wdXNoKGdlb21ldHJ5SW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBjb25zdCBnZW9tZXRyeSA9IEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5jb21iaW5lSW5zdGFuY2VzKGdlb21ldHJpZXMpWzBdOwogICAgICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tUG9pbnRzKHBvbHlnb25IaWVyYXJjaHkucG9zaXRpb25zKTsKICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlczogZ2VvbWV0cnkuYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXM6IGdlb21ldHJ5LmluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBnZW9tZXRyeS5wcmltaXRpdmVUeXBlLAogICAgICAgICAgYm91bmRpbmdTcGhlcmUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkocG9seWdvbkdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBwb2x5Z29uR2VvbWV0cnkgPSBDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soCiAgICAgICAgcG9seWdvbkdlb21ldHJ5LAogICAgICAgIG9mZnNldAogICAgICApOwogICAgfQogICAgcG9seWdvbkdlb21ldHJ5Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShwb2x5Z29uR2VvbWV0cnkuX2VsbGlwc29pZCk7CiAgICByZXR1cm4gQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkocG9seWdvbkdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Db3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGNyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29ybmVyVHlwZS5qcwogIHZhciBDb3JuZXJUeXBlLCBDb3JuZXJUeXBlX2RlZmF1bHQ7CiAgdmFyIGluaXRfQ29ybmVyVHlwZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29ybmVyVHlwZS5qcyIoKSB7CiAgICAgIENvcm5lclR5cGUgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogPGltZyBzcmM9IkltYWdlcy9Db3JuZXJUeXBlUm91bmRlZC5wbmciIHN0eWxlPSJ2ZXJ0aWNhbC1hbGlnbjogbWlkZGxlOyIgd2lkdGg9IjE4NiIgaGVpZ2h0PSIxODkiIC8+CiAgICAgICAgICoKICAgICAgICAgKiBDb3JuZXIgaGFzIGEgc21vb3RoIGVkZ2UuCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBST1VOREVEOiAwLAogICAgICAgIC8qKgogICAgICAgICAqIDxpbWcgc3JjPSJJbWFnZXMvQ29ybmVyVHlwZU1pdGVyZWQucG5nIiBzdHlsZT0idmVydGljYWwtYWxpZ246IG1pZGRsZTsiIHdpZHRoPSIxODYiIGhlaWdodD0iMTg5IiAvPgogICAgICAgICAqCiAgICAgICAgICogQ29ybmVyIHBvaW50IGlzIHRoZSBpbnRlcnNlY3Rpb24gb2YgYWRqYWNlbnQgZWRnZXMuCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBNSVRFUkVEOiAxLAogICAgICAgIC8qKgogICAgICAgICAqIDxpbWcgc3JjPSJJbWFnZXMvQ29ybmVyVHlwZUJldmVsZWQucG5nIiBzdHlsZT0idmVydGljYWwtYWxpZ246IG1pZGRsZTsiIHdpZHRoPSIxODYiIGhlaWdodD0iMTg5IiAvPgogICAgICAgICAqCiAgICAgICAgICogQ29ybmVyIGlzIGNsaXBwZWQuCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBCRVZFTEVEOiAyCiAgICAgIH07CiAgICAgIENvcm5lclR5cGVfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoQ29ybmVyVHlwZSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNvaWRHZW9kZXNpYy5qcwogIGZ1bmN0aW9uIHNldENvbnN0YW50cyhlbGxpcHNvaWRHZW9kZXNpYzIpIHsKICAgIGNvbnN0IHVTcXVhcmVkID0gZWxsaXBzb2lkR2VvZGVzaWMyLl91U3F1YXJlZDsKICAgIGNvbnN0IGEzID0gZWxsaXBzb2lkR2VvZGVzaWMyLl9lbGxpcHNvaWQubWF4aW11bVJhZGl1czsKICAgIGNvbnN0IGIgPSBlbGxpcHNvaWRHZW9kZXNpYzIuX2VsbGlwc29pZC5taW5pbXVtUmFkaXVzOwogICAgY29uc3QgZiA9IChhMyAtIGIpIC8gYTM7CiAgICBjb25zdCBjb3NpbmVIZWFkaW5nID0gTWF0aC5jb3MoZWxsaXBzb2lkR2VvZGVzaWMyLl9zdGFydEhlYWRpbmcpOwogICAgY29uc3Qgc2luZUhlYWRpbmcgPSBNYXRoLnNpbihlbGxpcHNvaWRHZW9kZXNpYzIuX3N0YXJ0SGVhZGluZyk7CiAgICBjb25zdCB0YW5VID0gKDEgLSBmKSAqIE1hdGgudGFuKGVsbGlwc29pZEdlb2Rlc2ljMi5fc3RhcnQubGF0aXR1ZGUpOwogICAgY29uc3QgY29zaW5lVSA9IDEgLyBNYXRoLnNxcnQoMSArIHRhblUgKiB0YW5VKTsKICAgIGNvbnN0IHNpbmVVID0gY29zaW5lVSAqIHRhblU7CiAgICBjb25zdCBzaWdtYSA9IE1hdGguYXRhbjIodGFuVSwgY29zaW5lSGVhZGluZyk7CiAgICBjb25zdCBzaW5lQWxwaGEgPSBjb3NpbmVVICogc2luZUhlYWRpbmc7CiAgICBjb25zdCBzaW5lU3F1YXJlZEFscGhhID0gc2luZUFscGhhICogc2luZUFscGhhOwogICAgY29uc3QgY29zaW5lU3F1YXJlZEFscGhhID0gMSAtIHNpbmVTcXVhcmVkQWxwaGE7CiAgICBjb25zdCBjb3NpbmVBbHBoYSA9IE1hdGguc3FydChjb3NpbmVTcXVhcmVkQWxwaGEpOwogICAgY29uc3QgdTJPdmVyNCA9IHVTcXVhcmVkIC8gNDsKICAgIGNvbnN0IHU0T3ZlcjE2ID0gdTJPdmVyNCAqIHUyT3ZlcjQ7CiAgICBjb25zdCB1Nk92ZXI2NCA9IHU0T3ZlcjE2ICogdTJPdmVyNDsKICAgIGNvbnN0IHU4T3ZlcjI1NiA9IHU0T3ZlcjE2ICogdTRPdmVyMTY7CiAgICBjb25zdCBhMCA9IDEgKyB1Mk92ZXI0IC0gMyAqIHU0T3ZlcjE2IC8gNCArIDUgKiB1Nk92ZXI2NCAvIDQgLSAxNzUgKiB1OE92ZXIyNTYgLyA2NDsKICAgIGNvbnN0IGExID0gMSAtIHUyT3ZlcjQgKyAxNSAqIHU0T3ZlcjE2IC8gOCAtIDM1ICogdTZPdmVyNjQgLyA4OwogICAgY29uc3QgYTIyID0gMSAtIDMgKiB1Mk92ZXI0ICsgMzUgKiB1NE92ZXIxNiAvIDQ7CiAgICBjb25zdCBhMzIgPSAxIC0gNSAqIHUyT3ZlcjQ7CiAgICBjb25zdCBkaXN0YW5jZVJhdGlvID0gYTAgKiBzaWdtYSAtIGExICogTWF0aC5zaW4oMiAqIHNpZ21hKSAqIHUyT3ZlcjQgLyAyIC0gYTIyICogTWF0aC5zaW4oNCAqIHNpZ21hKSAqIHU0T3ZlcjE2IC8gMTYgLSBhMzIgKiBNYXRoLnNpbig2ICogc2lnbWEpICogdTZPdmVyNjQgLyA0OCAtIE1hdGguc2luKDggKiBzaWdtYSkgKiA1ICogdThPdmVyMjU2IC8gNTEyOwogICAgY29uc3QgY29uc3RhbnRzID0gZWxsaXBzb2lkR2VvZGVzaWMyLl9jb25zdGFudHM7CiAgICBjb25zdGFudHMuYSA9IGEzOwogICAgY29uc3RhbnRzLmIgPSBiOwogICAgY29uc3RhbnRzLmYgPSBmOwogICAgY29uc3RhbnRzLmNvc2luZUhlYWRpbmcgPSBjb3NpbmVIZWFkaW5nOwogICAgY29uc3RhbnRzLnNpbmVIZWFkaW5nID0gc2luZUhlYWRpbmc7CiAgICBjb25zdGFudHMudGFuVSA9IHRhblU7CiAgICBjb25zdGFudHMuY29zaW5lVSA9IGNvc2luZVU7CiAgICBjb25zdGFudHMuc2luZVUgPSBzaW5lVTsKICAgIGNvbnN0YW50cy5zaWdtYSA9IHNpZ21hOwogICAgY29uc3RhbnRzLnNpbmVBbHBoYSA9IHNpbmVBbHBoYTsKICAgIGNvbnN0YW50cy5zaW5lU3F1YXJlZEFscGhhID0gc2luZVNxdWFyZWRBbHBoYTsKICAgIGNvbnN0YW50cy5jb3NpbmVTcXVhcmVkQWxwaGEgPSBjb3NpbmVTcXVhcmVkQWxwaGE7CiAgICBjb25zdGFudHMuY29zaW5lQWxwaGEgPSBjb3NpbmVBbHBoYTsKICAgIGNvbnN0YW50cy51Mk92ZXI0ID0gdTJPdmVyNDsKICAgIGNvbnN0YW50cy51NE92ZXIxNiA9IHU0T3ZlcjE2OwogICAgY29uc3RhbnRzLnU2T3ZlcjY0ID0gdTZPdmVyNjQ7CiAgICBjb25zdGFudHMudThPdmVyMjU2ID0gdThPdmVyMjU2OwogICAgY29uc3RhbnRzLmEwID0gYTA7CiAgICBjb25zdGFudHMuYTEgPSBhMTsKICAgIGNvbnN0YW50cy5hMiA9IGEyMjsKICAgIGNvbnN0YW50cy5hMyA9IGEzMjsKICAgIGNvbnN0YW50cy5kaXN0YW5jZVJhdGlvID0gZGlzdGFuY2VSYXRpbzsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZUMoZiwgY29zaW5lU3F1YXJlZEFscGhhKSB7CiAgICByZXR1cm4gZiAqIGNvc2luZVNxdWFyZWRBbHBoYSAqICg0ICsgZiAqICg0IC0gMyAqIGNvc2luZVNxdWFyZWRBbHBoYSkpIC8gMTY7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVEZWx0YUxhbWJkYShmLCBzaW5lQWxwaGEsIGNvc2luZVNxdWFyZWRBbHBoYSwgc2lnbWEsIHNpbmVTaWdtYSwgY29zaW5lU2lnbWEsIGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludCkgewogICAgY29uc3QgQyA9IGNvbXB1dGVDKGYsIGNvc2luZVNxdWFyZWRBbHBoYSk7CiAgICByZXR1cm4gKDEgLSBDKSAqIGYgKiBzaW5lQWxwaGEgKiAoc2lnbWEgKyBDICogc2luZVNpZ21hICogKGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludCArIEMgKiBjb3NpbmVTaWdtYSAqICgyICogY29zaW5lVHdpY2VTaWdtYU1pZHBvaW50ICogY29zaW5lVHdpY2VTaWdtYU1pZHBvaW50IC0gMSkpKTsKICB9CiAgZnVuY3Rpb24gdmluY2VudHlJbnZlcnNlRm9ybXVsYShlbGxpcHNvaWRHZW9kZXNpYzIsIG1ham9yLCBtaW5vciwgZmlyc3RMb25naXR1ZGUsIGZpcnN0TGF0aXR1ZGUsIHNlY29uZExvbmdpdHVkZSwgc2Vjb25kTGF0aXR1ZGUpIHsKICAgIGNvbnN0IGVmZiA9IChtYWpvciAtIG1pbm9yKSAvIG1ham9yOwogICAgY29uc3QgbCA9IHNlY29uZExvbmdpdHVkZSAtIGZpcnN0TG9uZ2l0dWRlOwogICAgY29uc3QgdTEyID0gTWF0aC5hdGFuKCgxIC0gZWZmKSAqIE1hdGgudGFuKGZpcnN0TGF0aXR1ZGUpKTsKICAgIGNvbnN0IHUyMiA9IE1hdGguYXRhbigoMSAtIGVmZikgKiBNYXRoLnRhbihzZWNvbmRMYXRpdHVkZSkpOwogICAgY29uc3QgY29zaW5lVTEgPSBNYXRoLmNvcyh1MTIpOwogICAgY29uc3Qgc2luZVUxID0gTWF0aC5zaW4odTEyKTsKICAgIGNvbnN0IGNvc2luZVUyID0gTWF0aC5jb3ModTIyKTsKICAgIGNvbnN0IHNpbmVVMiA9IE1hdGguc2luKHUyMik7CiAgICBjb25zdCBjYyA9IGNvc2luZVUxICogY29zaW5lVTI7CiAgICBjb25zdCBjcyA9IGNvc2luZVUxICogc2luZVUyOwogICAgY29uc3Qgc3MgPSBzaW5lVTEgKiBzaW5lVTI7CiAgICBjb25zdCBzYyA9IHNpbmVVMSAqIGNvc2luZVUyOwogICAgbGV0IGxhbWJkYSA9IGw7CiAgICBsZXQgbGFtYmRhRG90ID0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgIGxldCBjb3NpbmVMYW1iZGEgPSBNYXRoLmNvcyhsYW1iZGEpOwogICAgbGV0IHNpbmVMYW1iZGEgPSBNYXRoLnNpbihsYW1iZGEpOwogICAgbGV0IHNpZ21hOwogICAgbGV0IGNvc2luZVNpZ21hOwogICAgbGV0IHNpbmVTaWdtYTsKICAgIGxldCBjb3NpbmVTcXVhcmVkQWxwaGE7CiAgICBsZXQgY29zaW5lVHdpY2VTaWdtYU1pZHBvaW50OwogICAgZG8gewogICAgICBjb3NpbmVMYW1iZGEgPSBNYXRoLmNvcyhsYW1iZGEpOwogICAgICBzaW5lTGFtYmRhID0gTWF0aC5zaW4obGFtYmRhKTsKICAgICAgY29uc3QgdGVtcCA9IGNzIC0gc2MgKiBjb3NpbmVMYW1iZGE7CiAgICAgIHNpbmVTaWdtYSA9IE1hdGguc3FydCgKICAgICAgICBjb3NpbmVVMiAqIGNvc2luZVUyICogc2luZUxhbWJkYSAqIHNpbmVMYW1iZGEgKyB0ZW1wICogdGVtcAogICAgICApOwogICAgICBjb3NpbmVTaWdtYSA9IHNzICsgY2MgKiBjb3NpbmVMYW1iZGE7CiAgICAgIHNpZ21hID0gTWF0aC5hdGFuMihzaW5lU2lnbWEsIGNvc2luZVNpZ21hKTsKICAgICAgbGV0IHNpbmVBbHBoYTsKICAgICAgaWYgKHNpbmVTaWdtYSA9PT0gMCkgewogICAgICAgIHNpbmVBbHBoYSA9IDA7CiAgICAgICAgY29zaW5lU3F1YXJlZEFscGhhID0gMTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzaW5lQWxwaGEgPSBjYyAqIHNpbmVMYW1iZGEgLyBzaW5lU2lnbWE7CiAgICAgICAgY29zaW5lU3F1YXJlZEFscGhhID0gMSAtIHNpbmVBbHBoYSAqIHNpbmVBbHBoYTsKICAgICAgfQogICAgICBsYW1iZGFEb3QgPSBsYW1iZGE7CiAgICAgIGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludCA9IGNvc2luZVNpZ21hIC0gMiAqIHNzIC8gY29zaW5lU3F1YXJlZEFscGhhOwogICAgICBpZiAoIWlzRmluaXRlKGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludCkpIHsKICAgICAgICBjb3NpbmVUd2ljZVNpZ21hTWlkcG9pbnQgPSAwOwogICAgICB9CiAgICAgIGxhbWJkYSA9IGwgKyBjb21wdXRlRGVsdGFMYW1iZGEoCiAgICAgICAgZWZmLAogICAgICAgIHNpbmVBbHBoYSwKICAgICAgICBjb3NpbmVTcXVhcmVkQWxwaGEsCiAgICAgICAgc2lnbWEsCiAgICAgICAgc2luZVNpZ21hLAogICAgICAgIGNvc2luZVNpZ21hLAogICAgICAgIGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludAogICAgICApOwogICAgfSB3aGlsZSAoTWF0aC5hYnMobGFtYmRhIC0gbGFtYmRhRG90KSA+IE1hdGhfZGVmYXVsdC5FUFNJTE9OMTIpOwogICAgY29uc3QgdVNxdWFyZWQgPSBjb3NpbmVTcXVhcmVkQWxwaGEgKiAobWFqb3IgKiBtYWpvciAtIG1pbm9yICogbWlub3IpIC8gKG1pbm9yICogbWlub3IpOwogICAgY29uc3QgQSA9IDEgKyB1U3F1YXJlZCAqICg0MDk2ICsgdVNxdWFyZWQgKiAodVNxdWFyZWQgKiAoMzIwIC0gMTc1ICogdVNxdWFyZWQpIC0gNzY4KSkgLyAxNjM4NDsKICAgIGNvbnN0IEIgPSB1U3F1YXJlZCAqICgyNTYgKyB1U3F1YXJlZCAqICh1U3F1YXJlZCAqICg3NCAtIDQ3ICogdVNxdWFyZWQpIC0gMTI4KSkgLyAxMDI0OwogICAgY29uc3QgY29zaW5lU3F1YXJlZFR3aWNlU2lnbWFNaWRwb2ludCA9IGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludCAqIGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludDsKICAgIGNvbnN0IGRlbHRhU2lnbWEgPSBCICogc2luZVNpZ21hICogKGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludCArIEIgKiAoY29zaW5lU2lnbWEgKiAoMiAqIGNvc2luZVNxdWFyZWRUd2ljZVNpZ21hTWlkcG9pbnQgLSAxKSAtIEIgKiBjb3NpbmVUd2ljZVNpZ21hTWlkcG9pbnQgKiAoNCAqIHNpbmVTaWdtYSAqIHNpbmVTaWdtYSAtIDMpICogKDQgKiBjb3NpbmVTcXVhcmVkVHdpY2VTaWdtYU1pZHBvaW50IC0gMykgLyA2KSAvIDQpOwogICAgY29uc3QgZGlzdGFuY2UgPSBtaW5vciAqIEEgKiAoc2lnbWEgLSBkZWx0YVNpZ21hKTsKICAgIGNvbnN0IHN0YXJ0SGVhZGluZyA9IE1hdGguYXRhbjIoCiAgICAgIGNvc2luZVUyICogc2luZUxhbWJkYSwKICAgICAgY3MgLSBzYyAqIGNvc2luZUxhbWJkYQogICAgKTsKICAgIGNvbnN0IGVuZEhlYWRpbmcgPSBNYXRoLmF0YW4yKGNvc2luZVUxICogc2luZUxhbWJkYSwgY3MgKiBjb3NpbmVMYW1iZGEgLSBzYyk7CiAgICBlbGxpcHNvaWRHZW9kZXNpYzIuX2Rpc3RhbmNlID0gZGlzdGFuY2U7CiAgICBlbGxpcHNvaWRHZW9kZXNpYzIuX3N0YXJ0SGVhZGluZyA9IHN0YXJ0SGVhZGluZzsKICAgIGVsbGlwc29pZEdlb2Rlc2ljMi5fZW5kSGVhZGluZyA9IGVuZEhlYWRpbmc7CiAgICBlbGxpcHNvaWRHZW9kZXNpYzIuX3VTcXVhcmVkID0gdVNxdWFyZWQ7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVQcm9wZXJ0aWVzMihlbGxpcHNvaWRHZW9kZXNpYzIsIHN0YXJ0LCBlbmQsIGVsbGlwc29pZCkgewogICAgY29uc3QgZmlyc3RDYXJ0ZXNpYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oc3RhcnQsIHNjcmF0Y2hDYXJ0MjIpLAogICAgICBzY3JhdGNoQ2FydDEyCiAgICApOwogICAgY29uc3QgbGFzdENhcnRlc2lhbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgIGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihlbmQsIHNjcmF0Y2hDYXJ0MjIpLAogICAgICBzY3JhdGNoQ2FydDIyCiAgICApOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoCiAgICAgICJ2YWx1ZSIsCiAgICAgIE1hdGguYWJzKAogICAgICAgIE1hdGguYWJzKENhcnRlc2lhbjNfZGVmYXVsdC5hbmdsZUJldHdlZW4oZmlyc3RDYXJ0ZXNpYW4sIGxhc3RDYXJ0ZXNpYW4pKSAtIE1hdGguUEkKICAgICAgKSwKICAgICAgMC4wMTI1CiAgICApOwogICAgdmluY2VudHlJbnZlcnNlRm9ybXVsYSgKICAgICAgZWxsaXBzb2lkR2VvZGVzaWMyLAogICAgICBlbGxpcHNvaWQubWF4aW11bVJhZGl1cywKICAgICAgZWxsaXBzb2lkLm1pbmltdW1SYWRpdXMsCiAgICAgIHN0YXJ0LmxvbmdpdHVkZSwKICAgICAgc3RhcnQubGF0aXR1ZGUsCiAgICAgIGVuZC5sb25naXR1ZGUsCiAgICAgIGVuZC5sYXRpdHVkZQogICAgKTsKICAgIGVsbGlwc29pZEdlb2Rlc2ljMi5fc3RhcnQgPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5jbG9uZSgKICAgICAgc3RhcnQsCiAgICAgIGVsbGlwc29pZEdlb2Rlc2ljMi5fc3RhcnQKICAgICk7CiAgICBlbGxpcHNvaWRHZW9kZXNpYzIuX2VuZCA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmNsb25lKGVuZCwgZWxsaXBzb2lkR2VvZGVzaWMyLl9lbmQpOwogICAgZWxsaXBzb2lkR2VvZGVzaWMyLl9zdGFydC5oZWlnaHQgPSAwOwogICAgZWxsaXBzb2lkR2VvZGVzaWMyLl9lbmQuaGVpZ2h0ID0gMDsKICAgIHNldENvbnN0YW50cyhlbGxpcHNvaWRHZW9kZXNpYzIpOwogIH0KICBmdW5jdGlvbiBFbGxpcHNvaWRHZW9kZXNpYyhzdGFydCwgZW5kLCBlbGxpcHNvaWQpIHsKICAgIGNvbnN0IGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IGU7CiAgICB0aGlzLl9zdGFydCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgdGhpcy5fZW5kID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICB0aGlzLl9jb25zdGFudHMgPSB7fTsKICAgIHRoaXMuX3N0YXJ0SGVhZGluZyA9IHZvaWQgMDsKICAgIHRoaXMuX2VuZEhlYWRpbmcgPSB2b2lkIDA7CiAgICB0aGlzLl9kaXN0YW5jZSA9IHZvaWQgMDsKICAgIHRoaXMuX3VTcXVhcmVkID0gdm9pZCAwOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChzdGFydCkgJiYgZGVmaW5lZF9kZWZhdWx0KGVuZCkpIHsKICAgICAgY29tcHV0ZVByb3BlcnRpZXMyKHRoaXMsIHN0YXJ0LCBlbmQsIGUpOwogICAgfQogIH0KICB2YXIgc2NyYXRjaENhcnQxMiwgc2NyYXRjaENhcnQyMiwgRWxsaXBzb2lkR2VvZGVzaWNfZGVmYXVsdDsKICB2YXIgaW5pdF9FbGxpcHNvaWRHZW9kZXNpYyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzb2lkR2VvZGVzaWMuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIHNjcmF0Y2hDYXJ0MTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0MjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEVsbGlwc29pZEdlb2Rlc2ljLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGVsbGlwc29pZC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkR2VvZGVzaWMucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0VsbGlwc29pZH0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBlbGxpcHNvaWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbGxpcHNvaWQ7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBzdXJmYWNlIGRpc3RhbmNlIGJldHdlZW4gdGhlIHN0YXJ0IGFuZCBlbmQgcG9pbnQKICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkR2VvZGVzaWMucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBzdXJmYWNlRGlzdGFuY2U6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiZGlzdGFuY2UiLCB0aGlzLl9kaXN0YW5jZSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9kaXN0YW5jZTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGluaXRpYWwgcGxhbmV0b2RldGljIHBvaW50IG9uIHRoZSBwYXRoLgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWRHZW9kZXNpYy5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7Q2FydG9ncmFwaGljfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIHN0YXJ0OiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fc3RhcnQ7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBmaW5hbCBwbGFuZXRvZGV0aWMgcG9pbnQgb24gdGhlIHBhdGguCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZEdlb2Rlc2ljLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDYXJ0b2dyYXBoaWN9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgZW5kOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fZW5kOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgaGVhZGluZyBhdCB0aGUgaW5pdGlhbCBwb2ludC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkR2VvZGVzaWMucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBzdGFydEhlYWRpbmc6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiZGlzdGFuY2UiLCB0aGlzLl9kaXN0YW5jZSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zdGFydEhlYWRpbmc7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBoZWFkaW5nIGF0IHRoZSBmaW5hbCBwb2ludC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkR2VvZGVzaWMucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBlbmRIZWFkaW5nOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImRpc3RhbmNlIiwgdGhpcy5fZGlzdGFuY2UpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fZW5kSGVhZGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBFbGxpcHNvaWRHZW9kZXNpYy5wcm90b3R5cGUuc2V0RW5kUG9pbnRzID0gZnVuY3Rpb24oc3RhcnQsIGVuZCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgic3RhcnQiLCBzdGFydCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJlbmQiLCBlbmQpOwogICAgICAgIGNvbXB1dGVQcm9wZXJ0aWVzMih0aGlzLCBzdGFydCwgZW5kLCB0aGlzLl9lbGxpcHNvaWQpOwogICAgICB9OwogICAgICBFbGxpcHNvaWRHZW9kZXNpYy5wcm90b3R5cGUuaW50ZXJwb2xhdGVVc2luZ0ZyYWN0aW9uID0gZnVuY3Rpb24oZnJhY3Rpb24sIHJlc3VsdCkgewogICAgICAgIHJldHVybiB0aGlzLmludGVycG9sYXRlVXNpbmdTdXJmYWNlRGlzdGFuY2UoCiAgICAgICAgICB0aGlzLl9kaXN0YW5jZSAqIGZyYWN0aW9uLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkR2VvZGVzaWMucHJvdG90eXBlLmludGVycG9sYXRlVXNpbmdTdXJmYWNlRGlzdGFuY2UgPSBmdW5jdGlvbihkaXN0YW5jZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJkaXN0YW5jZSIsIHRoaXMuX2Rpc3RhbmNlKTsKICAgICAgICBjb25zdCBjb25zdGFudHMgPSB0aGlzLl9jb25zdGFudHM7CiAgICAgICAgY29uc3QgcyA9IGNvbnN0YW50cy5kaXN0YW5jZVJhdGlvICsgZGlzdGFuY2UgLyBjb25zdGFudHMuYjsKICAgICAgICBjb25zdCBjb3NpbmUyUyA9IE1hdGguY29zKDIgKiBzKTsKICAgICAgICBjb25zdCBjb3NpbmU0UyA9IE1hdGguY29zKDQgKiBzKTsKICAgICAgICBjb25zdCBjb3NpbmU2UyA9IE1hdGguY29zKDYgKiBzKTsKICAgICAgICBjb25zdCBzaW5lMlMgPSBNYXRoLnNpbigyICogcyk7CiAgICAgICAgY29uc3Qgc2luZTRTID0gTWF0aC5zaW4oNCAqIHMpOwogICAgICAgIGNvbnN0IHNpbmU2UyA9IE1hdGguc2luKDYgKiBzKTsKICAgICAgICBjb25zdCBzaW5lOFMgPSBNYXRoLnNpbig4ICogcyk7CiAgICAgICAgY29uc3QgczIgPSBzICogczsKICAgICAgICBjb25zdCBzMyA9IHMgKiBzMjsKICAgICAgICBjb25zdCB1OE92ZXIyNTYgPSBjb25zdGFudHMudThPdmVyMjU2OwogICAgICAgIGNvbnN0IHUyT3ZlcjQgPSBjb25zdGFudHMudTJPdmVyNDsKICAgICAgICBjb25zdCB1Nk92ZXI2NCA9IGNvbnN0YW50cy51Nk92ZXI2NDsKICAgICAgICBjb25zdCB1NE92ZXIxNiA9IGNvbnN0YW50cy51NE92ZXIxNjsKICAgICAgICBsZXQgc2lnbWEgPSAyICogczMgKiB1OE92ZXIyNTYgKiBjb3NpbmUyUyAvIDMgKyBzICogKDEgLSB1Mk92ZXI0ICsgNyAqIHU0T3ZlcjE2IC8gNCAtIDE1ICogdTZPdmVyNjQgLyA0ICsgNTc5ICogdThPdmVyMjU2IC8gNjQgLSAodTRPdmVyMTYgLSAxNSAqIHU2T3ZlcjY0IC8gNCArIDE4NyAqIHU4T3ZlcjI1NiAvIDE2KSAqIGNvc2luZTJTIC0gKDUgKiB1Nk92ZXI2NCAvIDQgLSAxMTUgKiB1OE92ZXIyNTYgLyAxNikgKiBjb3NpbmU0UyAtIDI5ICogdThPdmVyMjU2ICogY29zaW5lNlMgLyAxNikgKyAodTJPdmVyNCAvIDIgLSB1NE92ZXIxNiArIDcxICogdTZPdmVyNjQgLyAzMiAtIDg1ICogdThPdmVyMjU2IC8gMTYpICogc2luZTJTICsgKDUgKiB1NE92ZXIxNiAvIDE2IC0gNSAqIHU2T3ZlcjY0IC8gNCArIDM4MyAqIHU4T3ZlcjI1NiAvIDk2KSAqIHNpbmU0UyAtIHMyICogKCh1Nk92ZXI2NCAtIDExICogdThPdmVyMjU2IC8gMikgKiBzaW5lMlMgKyA1ICogdThPdmVyMjU2ICogc2luZTRTIC8gMikgKyAoMjkgKiB1Nk92ZXI2NCAvIDk2IC0gMjkgKiB1OE92ZXIyNTYgLyAxNikgKiBzaW5lNlMgKyA1MzkgKiB1OE92ZXIyNTYgKiBzaW5lOFMgLyAxNTM2OwogICAgICAgIGNvbnN0IHRoZXRhID0gTWF0aC5hc2luKE1hdGguc2luKHNpZ21hKSAqIGNvbnN0YW50cy5jb3NpbmVBbHBoYSk7CiAgICAgICAgY29uc3QgbGF0aXR1ZGUgPSBNYXRoLmF0YW4oY29uc3RhbnRzLmEgLyBjb25zdGFudHMuYiAqIE1hdGgudGFuKHRoZXRhKSk7CiAgICAgICAgc2lnbWEgPSBzaWdtYSAtIGNvbnN0YW50cy5zaWdtYTsKICAgICAgICBjb25zdCBjb3NpbmVUd2ljZVNpZ21hTWlkcG9pbnQgPSBNYXRoLmNvcygyICogY29uc3RhbnRzLnNpZ21hICsgc2lnbWEpOwogICAgICAgIGNvbnN0IHNpbmVTaWdtYSA9IE1hdGguc2luKHNpZ21hKTsKICAgICAgICBjb25zdCBjb3NpbmVTaWdtYSA9IE1hdGguY29zKHNpZ21hKTsKICAgICAgICBjb25zdCBjYyA9IGNvbnN0YW50cy5jb3NpbmVVICogY29zaW5lU2lnbWE7CiAgICAgICAgY29uc3Qgc3MgPSBjb25zdGFudHMuc2luZVUgKiBzaW5lU2lnbWE7CiAgICAgICAgY29uc3QgbGFtYmRhID0gTWF0aC5hdGFuMigKICAgICAgICAgIHNpbmVTaWdtYSAqIGNvbnN0YW50cy5zaW5lSGVhZGluZywKICAgICAgICAgIGNjIC0gc3MgKiBjb25zdGFudHMuY29zaW5lSGVhZGluZwogICAgICAgICk7CiAgICAgICAgY29uc3QgbCA9IGxhbWJkYSAtIGNvbXB1dGVEZWx0YUxhbWJkYSgKICAgICAgICAgIGNvbnN0YW50cy5mLAogICAgICAgICAgY29uc3RhbnRzLnNpbmVBbHBoYSwKICAgICAgICAgIGNvbnN0YW50cy5jb3NpbmVTcXVhcmVkQWxwaGEsCiAgICAgICAgICBzaWdtYSwKICAgICAgICAgIHNpbmVTaWdtYSwKICAgICAgICAgIGNvc2luZVNpZ21hLAogICAgICAgICAgY29zaW5lVHdpY2VTaWdtYU1pZHBvaW50CiAgICAgICAgKTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSB0aGlzLl9zdGFydC5sb25naXR1ZGUgKyBsOwogICAgICAgICAgcmVzdWx0LmxhdGl0dWRlID0gbGF0aXR1ZGU7CiAgICAgICAgICByZXN1bHQuaGVpZ2h0ID0gMDsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQodGhpcy5fc3RhcnQubG9uZ2l0dWRlICsgbCwgbGF0aXR1ZGUsIDApOwogICAgICB9OwogICAgICBFbGxpcHNvaWRHZW9kZXNpY19kZWZhdWx0ID0gRWxsaXBzb2lkR2VvZGVzaWM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5bGluZVBpcGVsaW5lLmpzCiAgZnVuY3Rpb24gc3ViZGl2aWRlSGVpZ2h0cyhudW1Qb2ludHMsIGgwLCBoMSkgewogICAgY29uc3QgaGVpZ2h0cyA9IHN1YmRpdmlkZUhlaWdodHNTY3JhdGNoQXJyYXk7CiAgICBoZWlnaHRzLmxlbmd0aCA9IG51bVBvaW50czsKICAgIGxldCBpOwogICAgaWYgKGgwID09PSBoMSkgewogICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtUG9pbnRzOyBpKyspIHsKICAgICAgICBoZWlnaHRzW2ldID0gaDA7CiAgICAgIH0KICAgICAgcmV0dXJuIGhlaWdodHM7CiAgICB9CiAgICBjb25zdCBkSGVpZ2h0ID0gaDEgLSBoMDsKICAgIGNvbnN0IGhlaWdodFBlclZlcnRleCA9IGRIZWlnaHQgLyBudW1Qb2ludHM7CiAgICBmb3IgKGkgPSAwOyBpIDwgbnVtUG9pbnRzOyBpKyspIHsKICAgICAgY29uc3QgaCA9IGgwICsgaSAqIGhlaWdodFBlclZlcnRleDsKICAgICAgaGVpZ2h0c1tpXSA9IGg7CiAgICB9CiAgICByZXR1cm4gaGVpZ2h0czsKICB9CiAgZnVuY3Rpb24gZ2VuZXJhdGVDYXJ0ZXNpYW5BcmMocDAsIHAxLCBtaW5EaXN0YW5jZSwgZWxsaXBzb2lkLCBoMCwgaDEsIGFycmF5LCBvZmZzZXQpIHsKICAgIGNvbnN0IGZpcnN0ID0gZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UocDAsIHNjYWxlRmlyc3QpOwogICAgY29uc3QgbGFzdCA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKHAxLCBzY2FsZUxhc3QpOwogICAgY29uc3QgbnVtUG9pbnRzID0gUG9seWxpbmVQaXBlbGluZS5udW1iZXJPZlBvaW50cyhwMCwgcDEsIG1pbkRpc3RhbmNlKTsKICAgIGNvbnN0IHN0YXJ0ID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKGZpcnN0LCBjYXJ0bzEpOwogICAgY29uc3QgZW5kID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKGxhc3QsIGNhcnRvMik7CiAgICBjb25zdCBoZWlnaHRzID0gc3ViZGl2aWRlSGVpZ2h0cyhudW1Qb2ludHMsIGgwLCBoMSk7CiAgICBlbGxpcHNvaWRHZW9kZXNpYy5zZXRFbmRQb2ludHMoc3RhcnQsIGVuZCk7CiAgICBjb25zdCBzdXJmYWNlRGlzdGFuY2VCZXR3ZWVuUG9pbnRzID0gZWxsaXBzb2lkR2VvZGVzaWMuc3VyZmFjZURpc3RhbmNlIC8gbnVtUG9pbnRzOwogICAgbGV0IGluZGV4ID0gb2Zmc2V0OwogICAgc3RhcnQuaGVpZ2h0ID0gaDA7CiAgICBsZXQgY2FydCA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihzdGFydCwgY2FydGVzaWFuKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGNhcnQsIGFycmF5LCBpbmRleCk7CiAgICBpbmRleCArPSAzOwogICAgZm9yIChsZXQgaSA9IDE7IGkgPCBudW1Qb2ludHM7IGkrKykgewogICAgICBjb25zdCBjYXJ0byA9IGVsbGlwc29pZEdlb2Rlc2ljLmludGVycG9sYXRlVXNpbmdTdXJmYWNlRGlzdGFuY2UoCiAgICAgICAgaSAqIHN1cmZhY2VEaXN0YW5jZUJldHdlZW5Qb2ludHMsCiAgICAgICAgY2FydG8yCiAgICAgICk7CiAgICAgIGNhcnRvLmhlaWdodCA9IGhlaWdodHNbaV07CiAgICAgIGNhcnQgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oY2FydG8sIGNhcnRlc2lhbik7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGNhcnQsIGFycmF5LCBpbmRleCk7CiAgICAgIGluZGV4ICs9IDM7CiAgICB9CiAgICByZXR1cm4gaW5kZXg7CiAgfQogIGZ1bmN0aW9uIGdlbmVyYXRlQ2FydGVzaWFuUmh1bWJBcmMocDAsIHAxLCBncmFudWxhcml0eSwgZWxsaXBzb2lkLCBoMCwgaDEsIGFycmF5LCBvZmZzZXQpIHsKICAgIGNvbnN0IHN0YXJ0ID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHAwLCBjYXJ0bzEpOwogICAgY29uc3QgZW5kID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHAxLCBjYXJ0bzIpOwogICAgY29uc3QgbnVtUG9pbnRzID0gUG9seWxpbmVQaXBlbGluZS5udW1iZXJPZlBvaW50c1JodW1iTGluZSgKICAgICAgc3RhcnQsCiAgICAgIGVuZCwKICAgICAgZ3JhbnVsYXJpdHkKICAgICk7CiAgICBzdGFydC5oZWlnaHQgPSAwOwogICAgZW5kLmhlaWdodCA9IDA7CiAgICBjb25zdCBoZWlnaHRzID0gc3ViZGl2aWRlSGVpZ2h0cyhudW1Qb2ludHMsIGgwLCBoMSk7CiAgICBpZiAoIWVsbGlwc29pZFJodW1iLmVsbGlwc29pZC5lcXVhbHMoZWxsaXBzb2lkKSkgewogICAgICBlbGxpcHNvaWRSaHVtYiA9IG5ldyBFbGxpcHNvaWRSaHVtYkxpbmVfZGVmYXVsdCh2b2lkIDAsIHZvaWQgMCwgZWxsaXBzb2lkKTsKICAgIH0KICAgIGVsbGlwc29pZFJodW1iLnNldEVuZFBvaW50cyhzdGFydCwgZW5kKTsKICAgIGNvbnN0IHN1cmZhY2VEaXN0YW5jZUJldHdlZW5Qb2ludHMgPSBlbGxpcHNvaWRSaHVtYi5zdXJmYWNlRGlzdGFuY2UgLyBudW1Qb2ludHM7CiAgICBsZXQgaW5kZXggPSBvZmZzZXQ7CiAgICBzdGFydC5oZWlnaHQgPSBoMDsKICAgIGxldCBjYXJ0ID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKHN0YXJ0LCBjYXJ0ZXNpYW4pOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soY2FydCwgYXJyYXksIGluZGV4KTsKICAgIGluZGV4ICs9IDM7CiAgICBmb3IgKGxldCBpID0gMTsgaSA8IG51bVBvaW50czsgaSsrKSB7CiAgICAgIGNvbnN0IGNhcnRvID0gZWxsaXBzb2lkUmh1bWIuaW50ZXJwb2xhdGVVc2luZ1N1cmZhY2VEaXN0YW5jZSgKICAgICAgICBpICogc3VyZmFjZURpc3RhbmNlQmV0d2VlblBvaW50cywKICAgICAgICBjYXJ0bzIKICAgICAgKTsKICAgICAgY2FydG8uaGVpZ2h0ID0gaGVpZ2h0c1tpXTsKICAgICAgY2FydCA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihjYXJ0bywgY2FydGVzaWFuKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soY2FydCwgYXJyYXksIGluZGV4KTsKICAgICAgaW5kZXggKz0gMzsKICAgIH0KICAgIHJldHVybiBpbmRleDsKICB9CiAgdmFyIFBvbHlsaW5lUGlwZWxpbmUsIGNhcnRvU2NyYXRjaCwgd3JhcExvbmdpdHVkZUludmVyc01hdHJpeCwgd3JhcExvbmdpdHVkZU9yaWdpbiwgd3JhcExvbmdpdHVkZVhaTm9ybWFsLCB3cmFwTG9uZ2l0dWRlWFpQbGFuZSwgd3JhcExvbmdpdHVkZVlaTm9ybWFsLCB3cmFwTG9uZ2l0dWRlWVpQbGFuZSwgd3JhcExvbmdpdHVkZUludGVyc2VjdGlvbiwgd3JhcExvbmdpdHVkZU9mZnNldCwgc3ViZGl2aWRlSGVpZ2h0c1NjcmF0Y2hBcnJheSwgY2FydG8xLCBjYXJ0bzIsIGNhcnRlc2lhbiwgc2NhbGVGaXJzdCwgc2NhbGVMYXN0LCBlbGxpcHNvaWRHZW9kZXNpYywgZWxsaXBzb2lkUmh1bWIsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMwMiwgc2NyYXRjaENhcnRvZ3JhcGhpYzEyLCBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQ7CiAgdmFyIGluaXRfUG9seWxpbmVQaXBlbGluZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWxpbmVQaXBlbGluZS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0VsbGlwc29pZEdlb2Rlc2ljKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkUmh1bWJMaW5lKCk7CiAgICAgIGluaXRfSW50ZXJzZWN0aW9uVGVzdHMoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4NCgpOwogICAgICBpbml0X1BsYW5lKCk7CiAgICAgIFBvbHlsaW5lUGlwZWxpbmUgPSB7fTsKICAgICAgUG9seWxpbmVQaXBlbGluZS5udW1iZXJPZlBvaW50cyA9IGZ1bmN0aW9uKHAwLCBwMSwgbWluRGlzdGFuY2UpIHsKICAgICAgICBjb25zdCBkaXN0YW5jZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5kaXN0YW5jZShwMCwgcDEpOwogICAgICAgIHJldHVybiBNYXRoLmNlaWwoZGlzdGFuY2UgLyBtaW5EaXN0YW5jZSk7CiAgICAgIH07CiAgICAgIFBvbHlsaW5lUGlwZWxpbmUubnVtYmVyT2ZQb2ludHNSaHVtYkxpbmUgPSBmdW5jdGlvbihwMCwgcDEsIGdyYW51bGFyaXR5KSB7CiAgICAgICAgY29uc3QgcmFkaWFuc0Rpc3RhbmNlU3F1YXJlZCA9IE1hdGgucG93KHAwLmxvbmdpdHVkZSAtIHAxLmxvbmdpdHVkZSwgMikgKyBNYXRoLnBvdyhwMC5sYXRpdHVkZSAtIHAxLmxhdGl0dWRlLCAyKTsKICAgICAgICByZXR1cm4gTWF0aC5tYXgoCiAgICAgICAgICAxLAogICAgICAgICAgTWF0aC5jZWlsKE1hdGguc3FydChyYWRpYW5zRGlzdGFuY2VTcXVhcmVkIC8gKGdyYW51bGFyaXR5ICogZ3JhbnVsYXJpdHkpKSkKICAgICAgICApOwogICAgICB9OwogICAgICBjYXJ0b1NjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgUG9seWxpbmVQaXBlbGluZS5leHRyYWN0SGVpZ2h0cyA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgZWxsaXBzb2lkKSB7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBjb25zdCBoZWlnaHRzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgcCA9IHBvc2l0aW9uc1tpXTsKICAgICAgICAgIGhlaWdodHNbaV0gPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocCwgY2FydG9TY3JhdGNoKS5oZWlnaHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBoZWlnaHRzOwogICAgICB9OwogICAgICB3cmFwTG9uZ2l0dWRlSW52ZXJzTWF0cml4ID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICB3cmFwTG9uZ2l0dWRlT3JpZ2luID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB3cmFwTG9uZ2l0dWRlWFpOb3JtYWwgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHdyYXBMb25naXR1ZGVYWlBsYW5lID0gbmV3IFBsYW5lX2RlZmF1bHQoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWCwgMCk7CiAgICAgIHdyYXBMb25naXR1ZGVZWk5vcm1hbCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgd3JhcExvbmdpdHVkZVlaUGxhbmUgPSBuZXcgUGxhbmVfZGVmYXVsdChDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YLCAwKTsKICAgICAgd3JhcExvbmdpdHVkZUludGVyc2VjdGlvbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgd3JhcExvbmdpdHVkZU9mZnNldCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc3ViZGl2aWRlSGVpZ2h0c1NjcmF0Y2hBcnJheSA9IFtdOwogICAgICBjYXJ0bzEgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgY2FydG8yID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NhbGVGaXJzdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NhbGVMYXN0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBlbGxpcHNvaWRHZW9kZXNpYyA9IG5ldyBFbGxpcHNvaWRHZW9kZXNpY19kZWZhdWx0KCk7CiAgICAgIGVsbGlwc29pZFJodW1iID0gbmV3IEVsbGlwc29pZFJodW1iTGluZV9kZWZhdWx0KCk7CiAgICAgIFBvbHlsaW5lUGlwZWxpbmUud3JhcExvbmdpdHVkZSA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgbW9kZWxNYXRyaXgpIHsKICAgICAgICBjb25zdCBjYXJ0ZXNpYW5zID0gW107CiAgICAgICAgY29uc3Qgc2VnbWVudHMgPSBbXTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgJiYgcG9zaXRpb25zLmxlbmd0aCA+IDApIHsKICAgICAgICAgIG1vZGVsTWF0cml4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQobW9kZWxNYXRyaXgsIE1hdHJpeDRfZGVmYXVsdC5JREVOVElUWSk7CiAgICAgICAgICBjb25zdCBpbnZlcnNlTW9kZWxNYXRyaXggPSBNYXRyaXg0X2RlZmF1bHQuaW52ZXJzZVRyYW5zZm9ybWF0aW9uKAogICAgICAgICAgICBtb2RlbE1hdHJpeCwKICAgICAgICAgICAgd3JhcExvbmdpdHVkZUludmVyc01hdHJpeAogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IG9yaWdpbiA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnQoCiAgICAgICAgICAgIGludmVyc2VNb2RlbE1hdHJpeCwKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sCiAgICAgICAgICAgIHdyYXBMb25naXR1ZGVPcmlnaW4KICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCB4ek5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnRBc1ZlY3RvcigKICAgICAgICAgICAgICBpbnZlcnNlTW9kZWxNYXRyaXgsCiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWSwKICAgICAgICAgICAgICB3cmFwTG9uZ2l0dWRlWFpOb3JtYWwKICAgICAgICAgICAgKSwKICAgICAgICAgICAgd3JhcExvbmdpdHVkZVhaTm9ybWFsCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgeHpQbGFuZTIgPSBQbGFuZV9kZWZhdWx0LmZyb21Qb2ludE5vcm1hbCgKICAgICAgICAgICAgb3JpZ2luLAogICAgICAgICAgICB4ek5vcm1hbCwKICAgICAgICAgICAgd3JhcExvbmdpdHVkZVhaUGxhbmUKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCB5ek5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnRBc1ZlY3RvcigKICAgICAgICAgICAgICBpbnZlcnNlTW9kZWxNYXRyaXgsCiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWCwKICAgICAgICAgICAgICB3cmFwTG9uZ2l0dWRlWVpOb3JtYWwKICAgICAgICAgICAgKSwKICAgICAgICAgICAgd3JhcExvbmdpdHVkZVlaTm9ybWFsCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgeXpQbGFuZSA9IFBsYW5lX2RlZmF1bHQuZnJvbVBvaW50Tm9ybWFsKAogICAgICAgICAgICBvcmlnaW4sCiAgICAgICAgICAgIHl6Tm9ybWFsLAogICAgICAgICAgICB3cmFwTG9uZ2l0dWRlWVpQbGFuZQogICAgICAgICAgKTsKICAgICAgICAgIGxldCBjb3VudCA9IDE7CiAgICAgICAgICBjYXJ0ZXNpYW5zLnB1c2goQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHBvc2l0aW9uc1swXSkpOwogICAgICAgICAgbGV0IHByZXYgPSBjYXJ0ZXNpYW5zWzBdOwogICAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgY29uc3QgY3VyID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgICBpZiAoUGxhbmVfZGVmYXVsdC5nZXRQb2ludERpc3RhbmNlKHl6UGxhbmUsIHByZXYpIDwgMCB8fCBQbGFuZV9kZWZhdWx0LmdldFBvaW50RGlzdGFuY2UoeXpQbGFuZSwgY3VyKSA8IDApIHsKICAgICAgICAgICAgICBjb25zdCBpbnRlcnNlY3Rpb24gPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LmxpbmVTZWdtZW50UGxhbmUoCiAgICAgICAgICAgICAgICBwcmV2LAogICAgICAgICAgICAgICAgY3VyLAogICAgICAgICAgICAgICAgeHpQbGFuZTIsCiAgICAgICAgICAgICAgICB3cmFwTG9uZ2l0dWRlSW50ZXJzZWN0aW9uCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGludGVyc2VjdGlvbikpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICAgICAgICB4ek5vcm1hbCwKICAgICAgICAgICAgICAgICAgNWUtOSwKICAgICAgICAgICAgICAgICAgd3JhcExvbmdpdHVkZU9mZnNldAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGlmIChQbGFuZV9kZWZhdWx0LmdldFBvaW50RGlzdGFuY2UoeHpQbGFuZTIsIHByZXYpIDwgMCkgewogICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKG9mZnNldCwgb2Zmc2V0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhcnRlc2lhbnMucHVzaCgKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChpbnRlcnNlY3Rpb24sIG9mZnNldCwgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIHNlZ21lbnRzLnB1c2goY291bnQgKyAxKTsKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUob2Zmc2V0LCBvZmZzZXQpOwogICAgICAgICAgICAgICAgY2FydGVzaWFucy5wdXNoKAogICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGludGVyc2VjdGlvbiwgb2Zmc2V0LCBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCkpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgY291bnQgPSAxOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjYXJ0ZXNpYW5zLnB1c2goQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHBvc2l0aW9uc1tpXSkpOwogICAgICAgICAgICBjb3VudCsrOwogICAgICAgICAgICBwcmV2ID0gY3VyOwogICAgICAgICAgfQogICAgICAgICAgc2VnbWVudHMucHVzaChjb3VudCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICBwb3NpdGlvbnM6IGNhcnRlc2lhbnMsCiAgICAgICAgICBsZW5ndGhzOiBzZWdtZW50cwogICAgICAgIH07CiAgICAgIH07CiAgICAgIFBvbHlsaW5lUGlwZWxpbmUuZ2VuZXJhdGVBcmMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob3B0aW9ucykpIHsKICAgICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gb3B0aW9ucy5wb3NpdGlvbnM7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMucG9zaXRpb25zIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICAgICAgbGV0IGhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuaGVpZ2h0LCAwKTsKICAgICAgICBjb25zdCBoYXNIZWlnaHRBcnJheSA9IEFycmF5LmlzQXJyYXkoaGVpZ2h0KTsKICAgICAgICBpZiAobGVuZ3RoIDwgMSkgewogICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgIH0gZWxzZSBpZiAobGVuZ3RoID09PSAxKSB7CiAgICAgICAgICBjb25zdCBwID0gZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UocG9zaXRpb25zWzBdLCBzY2FsZUZpcnN0KTsKICAgICAgICAgIGhlaWdodCA9IGhhc0hlaWdodEFycmF5ID8gaGVpZ2h0WzBdIDogaGVpZ2h0OwogICAgICAgICAgaWYgKGhlaWdodCAhPT0gMCkgewogICAgICAgICAgICBjb25zdCBuID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwLCBjYXJ0ZXNpYW4pOwogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihuLCBoZWlnaHQsIG4pOwogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHAsIG4sIHApOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIFtwLngsIHAueSwgcC56XTsKICAgICAgICB9CiAgICAgICAgbGV0IG1pbkRpc3RhbmNlID0gb3B0aW9ucy5taW5EaXN0YW5jZTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChtaW5EaXN0YW5jZSkpIHsKICAgICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgICAgICAgIG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgICAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICAgICAgICk7CiAgICAgICAgICBtaW5EaXN0YW5jZSA9IE1hdGhfZGVmYXVsdC5jaG9yZExlbmd0aChncmFudWxhcml0eSwgZWxsaXBzb2lkLm1heGltdW1SYWRpdXMpOwogICAgICAgIH0KICAgICAgICBsZXQgbnVtUG9pbnRzID0gMDsKICAgICAgICBsZXQgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgICBudW1Qb2ludHMgKz0gUG9seWxpbmVQaXBlbGluZS5udW1iZXJPZlBvaW50cygKICAgICAgICAgICAgcG9zaXRpb25zW2ldLAogICAgICAgICAgICBwb3NpdGlvbnNbaSArIDFdLAogICAgICAgICAgICBtaW5EaXN0YW5jZQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXJyYXlMZW5ndGggPSAobnVtUG9pbnRzICsgMSkgKiAzOwogICAgICAgIGNvbnN0IG5ld1Bvc2l0aW9ucyA9IG5ldyBBcnJheShhcnJheUxlbmd0aCk7CiAgICAgICAgbGV0IG9mZnNldCA9IDA7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgY29uc3QgcDAgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICBjb25zdCBwMSA9IHBvc2l0aW9uc1tpICsgMV07CiAgICAgICAgICBjb25zdCBoMCA9IGhhc0hlaWdodEFycmF5ID8gaGVpZ2h0W2ldIDogaGVpZ2h0OwogICAgICAgICAgY29uc3QgaDEgPSBoYXNIZWlnaHRBcnJheSA/IGhlaWdodFtpICsgMV0gOiBoZWlnaHQ7CiAgICAgICAgICBvZmZzZXQgPSBnZW5lcmF0ZUNhcnRlc2lhbkFyYygKICAgICAgICAgICAgcDAsCiAgICAgICAgICAgIHAxLAogICAgICAgICAgICBtaW5EaXN0YW5jZSwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBoMCwKICAgICAgICAgICAgaDEsCiAgICAgICAgICAgIG5ld1Bvc2l0aW9ucywKICAgICAgICAgICAgb2Zmc2V0CiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBzdWJkaXZpZGVIZWlnaHRzU2NyYXRjaEFycmF5Lmxlbmd0aCA9IDA7CiAgICAgICAgY29uc3QgbGFzdFBvaW50ID0gcG9zaXRpb25zW2xlbmd0aCAtIDFdOwogICAgICAgIGNvbnN0IGNhcnRvID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKGxhc3RQb2ludCwgY2FydG8xKTsKICAgICAgICBjYXJ0by5oZWlnaHQgPSBoYXNIZWlnaHRBcnJheSA/IGhlaWdodFtsZW5ndGggLSAxXSA6IGhlaWdodDsKICAgICAgICBjb25zdCBjYXJ0ID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKGNhcnRvLCBjYXJ0ZXNpYW4pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGNhcnQsIG5ld1Bvc2l0aW9ucywgYXJyYXlMZW5ndGggLSAzKTsKICAgICAgICByZXR1cm4gbmV3UG9zaXRpb25zOwogICAgICB9OwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljMDIgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzEyID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIFBvbHlsaW5lUGlwZWxpbmUuZ2VuZXJhdGVSaHVtYkFyYyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvcHRpb25zKSkgewogICAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICAgIH0KICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBvcHRpb25zLnBvc2l0aW9uczsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5wb3NpdGlvbnMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgICAgICBsZXQgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5oZWlnaHQsIDApOwogICAgICAgIGNvbnN0IGhhc0hlaWdodEFycmF5ID0gQXJyYXkuaXNBcnJheShoZWlnaHQpOwogICAgICAgIGlmIChsZW5ndGggPCAxKSB7CiAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgfSBlbHNlIGlmIChsZW5ndGggPT09IDEpIHsKICAgICAgICAgIGNvbnN0IHAgPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShwb3NpdGlvbnNbMF0sIHNjYWxlRmlyc3QpOwogICAgICAgICAgaGVpZ2h0ID0gaGFzSGVpZ2h0QXJyYXkgPyBoZWlnaHRbMF0gOiBoZWlnaHQ7CiAgICAgICAgICBpZiAoaGVpZ2h0ICE9PSAwKSB7CiAgICAgICAgICAgIGNvbnN0IG4gPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHAsIGNhcnRlc2lhbik7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG4sIGhlaWdodCwgbik7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocCwgbiwgcCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gW3AueCwgcC55LCBwLnpdOwogICAgICAgIH0KICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICAgICApOwogICAgICAgIGxldCBudW1Qb2ludHMgPSAwOwogICAgICAgIGxldCBpOwogICAgICAgIGxldCBjMCA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgICAgIHBvc2l0aW9uc1swXSwKICAgICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWMwMgogICAgICAgICk7CiAgICAgICAgbGV0IGMxOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgIGMxID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICAgICAgICBwb3NpdGlvbnNbaSArIDFdLAogICAgICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljMTIKICAgICAgICAgICk7CiAgICAgICAgICBudW1Qb2ludHMgKz0gUG9seWxpbmVQaXBlbGluZS5udW1iZXJPZlBvaW50c1JodW1iTGluZShjMCwgYzEsIGdyYW51bGFyaXR5KTsKICAgICAgICAgIGMwID0gQ2FydG9ncmFwaGljX2RlZmF1bHQuY2xvbmUoYzEsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMwMik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGFycmF5TGVuZ3RoID0gKG51bVBvaW50cyArIDEpICogMzsKICAgICAgICBjb25zdCBuZXdQb3NpdGlvbnMgPSBuZXcgQXJyYXkoYXJyYXlMZW5ndGgpOwogICAgICAgIGxldCBvZmZzZXQgPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHAwID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgY29uc3QgcDEgPSBwb3NpdGlvbnNbaSArIDFdOwogICAgICAgICAgY29uc3QgaDAgPSBoYXNIZWlnaHRBcnJheSA/IGhlaWdodFtpXSA6IGhlaWdodDsKICAgICAgICAgIGNvbnN0IGgxID0gaGFzSGVpZ2h0QXJyYXkgPyBoZWlnaHRbaSArIDFdIDogaGVpZ2h0OwogICAgICAgICAgb2Zmc2V0ID0gZ2VuZXJhdGVDYXJ0ZXNpYW5SaHVtYkFyYygKICAgICAgICAgICAgcDAsCiAgICAgICAgICAgIHAxLAogICAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBoMCwKICAgICAgICAgICAgaDEsCiAgICAgICAgICAgIG5ld1Bvc2l0aW9ucywKICAgICAgICAgICAgb2Zmc2V0CiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBzdWJkaXZpZGVIZWlnaHRzU2NyYXRjaEFycmF5Lmxlbmd0aCA9IDA7CiAgICAgICAgY29uc3QgbGFzdFBvaW50ID0gcG9zaXRpb25zW2xlbmd0aCAtIDFdOwogICAgICAgIGNvbnN0IGNhcnRvID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKGxhc3RQb2ludCwgY2FydG8xKTsKICAgICAgICBjYXJ0by5oZWlnaHQgPSBoYXNIZWlnaHRBcnJheSA/IGhlaWdodFtsZW5ndGggLSAxXSA6IGhlaWdodDsKICAgICAgICBjb25zdCBjYXJ0ID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKGNhcnRvLCBjYXJ0ZXNpYW4pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGNhcnQsIG5ld1Bvc2l0aW9ucywgYXJyYXlMZW5ndGggLSAzKTsKICAgICAgICByZXR1cm4gbmV3UG9zaXRpb25zOwogICAgICB9OwogICAgICBQb2x5bGluZVBpcGVsaW5lLmdlbmVyYXRlQ2FydGVzaWFuQXJjID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGNvbnN0IG51bWJlckFycmF5ID0gUG9seWxpbmVQaXBlbGluZS5nZW5lcmF0ZUFyYyhvcHRpb25zKTsKICAgICAgICBjb25zdCBzaXplID0gbnVtYmVyQXJyYXkubGVuZ3RoIC8gMzsKICAgICAgICBjb25zdCBuZXdQb3NpdGlvbnMgPSBuZXcgQXJyYXkoc2l6ZSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaXplOyBpKyspIHsKICAgICAgICAgIG5ld1Bvc2l0aW9uc1tpXSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2sobnVtYmVyQXJyYXksIGkgKiAzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ld1Bvc2l0aW9uczsKICAgICAgfTsKICAgICAgUG9seWxpbmVQaXBlbGluZS5nZW5lcmF0ZUNhcnRlc2lhblJodW1iQXJjID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGNvbnN0IG51bWJlckFycmF5ID0gUG9seWxpbmVQaXBlbGluZS5nZW5lcmF0ZVJodW1iQXJjKG9wdGlvbnMpOwogICAgICAgIGNvbnN0IHNpemUgPSBudW1iZXJBcnJheS5sZW5ndGggLyAzOwogICAgICAgIGNvbnN0IG5ld1Bvc2l0aW9ucyA9IG5ldyBBcnJheShzaXplKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNpemU7IGkrKykgewogICAgICAgICAgbmV3UG9zaXRpb25zW2ldID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhudW1iZXJBcnJheSwgaSAqIDMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3UG9zaXRpb25zOwogICAgICB9OwogICAgICBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQgPSBQb2x5bGluZVBpcGVsaW5lOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvb25lVGltZVdhcm5pbmcuanMKICBmdW5jdGlvbiBvbmVUaW1lV2FybmluZyhpZGVudGlmaWVyLCBtZXNzYWdlKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpZGVudGlmaWVyKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiaWRlbnRpZmllciBpcyByZXF1aXJlZC4iKTsKICAgIH0KICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHdhcm5pbmdzW2lkZW50aWZpZXJdKSkgewogICAgICB3YXJuaW5nc1tpZGVudGlmaWVyXSA9IHRydWU7CiAgICAgIGNvbnNvbGUud2FybihkZWZhdWx0VmFsdWVfZGVmYXVsdChtZXNzYWdlLCBpZGVudGlmaWVyKSk7CiAgICB9CiAgfQogIHZhciB3YXJuaW5ncywgb25lVGltZVdhcm5pbmdfZGVmYXVsdDsKICB2YXIgaW5pdF9vbmVUaW1lV2FybmluZyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvb25lVGltZVdhcm5pbmcuanMiKCkgewogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICB3YXJuaW5ncyA9IHt9OwogICAgICBvbmVUaW1lV2FybmluZy5nZW9tZXRyeU91dGxpbmVzID0gIkVudGl0eSBnZW9tZXRyeSBvdXRsaW5lcyBhcmUgdW5zdXBwb3J0ZWQgb24gdGVycmFpbi4gT3V0bGluZXMgd2lsbCBiZSBkaXNhYmxlZC4gVG8gZW5hYmxlIG91dGxpbmVzLCBkaXNhYmxlIGdlb21ldHJ5IHRlcnJhaW4gY2xhbXBpbmcgYnkgZXhwbGljaXRseSBzZXR0aW5nIGhlaWdodCB0byAwLiI7CiAgICAgIG9uZVRpbWVXYXJuaW5nLmdlb21ldHJ5WkluZGV4ID0gIkVudGl0eSBnZW9tZXRyeSB3aXRoIHpJbmRleCBhcmUgdW5zdXBwb3J0ZWQgd2hlbiBoZWlnaHQgb3IgZXh0cnVkZWRIZWlnaHQgYXJlIGRlZmluZWQuICB6SW5kZXggd2lsbCBiZSBpZ25vcmVkIjsKICAgICAgb25lVGltZVdhcm5pbmcuZ2VvbWV0cnlIZWlnaHRSZWZlcmVuY2UgPSAiRW50aXR5IGNvcnJpZG9yLCBlbGxpcHNlLCBwb2x5Z29uIG9yIHJlY3RhbmdsZSB3aXRoIGhlaWdodFJlZmVyZW5jZSBtdXN0IGFsc28gaGF2ZSBhIGRlZmluZWQgaGVpZ2h0LiAgaGVpZ2h0UmVmZXJlbmNlIHdpbGwgYmUgaWdub3JlZCI7CiAgICAgIG9uZVRpbWVXYXJuaW5nLmdlb21ldHJ5RXh0cnVkZWRIZWlnaHRSZWZlcmVuY2UgPSAiRW50aXR5IGNvcnJpZG9yLCBlbGxpcHNlLCBwb2x5Z29uIG9yIHJlY3RhbmdsZSB3aXRoIGV4dHJ1ZGVkSGVpZ2h0UmVmZXJlbmNlIG11c3QgYWxzbyBoYXZlIGEgZGVmaW5lZCBleHRydWRlZEhlaWdodC4gIGV4dHJ1ZGVkSGVpZ2h0UmVmZXJlbmNlIHdpbGwgYmUgaWdub3JlZCI7CiAgICAgIG9uZVRpbWVXYXJuaW5nX2RlZmF1bHQgPSBvbmVUaW1lV2FybmluZzsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5LmpzCiAgZnVuY3Rpb24gc2NhbGVUb1N1cmZhY2UocG9zaXRpb25zLCBlbGxpcHNvaWQpIHsKICAgIGNvbnN0IGhlaWdodHMgPSBuZXcgQXJyYXkocG9zaXRpb25zLmxlbmd0aCk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBwb3MgPSBwb3NpdGlvbnNbaV07CiAgICAgIGNhcnRvZ3JhcGhpYyA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhwb3MsIGNhcnRvZ3JhcGhpYyk7CiAgICAgIGhlaWdodHNbaV0gPSBjYXJ0b2dyYXBoaWMuaGVpZ2h0OwogICAgICBwb3NpdGlvbnNbaV0gPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShwb3MsIHBvcyk7CiAgICB9CiAgICByZXR1cm4gaGVpZ2h0czsKICB9CiAgZnVuY3Rpb24gc3ViZGl2aWRlSGVpZ2h0czIocG9pbnRzLCBoMCwgaDEsIGdyYW51bGFyaXR5KSB7CiAgICBjb25zdCBwMCA9IHBvaW50c1swXTsKICAgIGNvbnN0IHAxID0gcG9pbnRzWzFdOwogICAgY29uc3QgYW5nbGVCZXR3ZWVuID0gQ2FydGVzaWFuM19kZWZhdWx0LmFuZ2xlQmV0d2VlbihwMCwgcDEpOwogICAgY29uc3QgbnVtUG9pbnRzID0gTWF0aC5jZWlsKGFuZ2xlQmV0d2VlbiAvIGdyYW51bGFyaXR5KTsKICAgIGNvbnN0IGhlaWdodHMgPSBuZXcgQXJyYXkobnVtUG9pbnRzKTsKICAgIGxldCBpOwogICAgaWYgKGgwID09PSBoMSkgewogICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtUG9pbnRzOyBpKyspIHsKICAgICAgICBoZWlnaHRzW2ldID0gaDA7CiAgICAgIH0KICAgICAgaGVpZ2h0cy5wdXNoKGgxKTsKICAgICAgcmV0dXJuIGhlaWdodHM7CiAgICB9CiAgICBjb25zdCBkSGVpZ2h0ID0gaDEgLSBoMDsKICAgIGNvbnN0IGhlaWdodFBlclZlcnRleCA9IGRIZWlnaHQgLyBudW1Qb2ludHM7CiAgICBmb3IgKGkgPSAxOyBpIDwgbnVtUG9pbnRzOyBpKyspIHsKICAgICAgY29uc3QgaCA9IGgwICsgaSAqIGhlaWdodFBlclZlcnRleDsKICAgICAgaGVpZ2h0c1tpXSA9IGg7CiAgICB9CiAgICBoZWlnaHRzWzBdID0gaDA7CiAgICBoZWlnaHRzLnB1c2goaDEpOwogICAgcmV0dXJuIGhlaWdodHM7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVSb3RhdGlvbkFuZ2xlKHN0YXJ0LCBlbmQsIHBvc2l0aW9uLCBlbGxpcHNvaWQpIHsKICAgIGNvbnN0IHRhbmdlbnRQbGFuZSA9IG5ldyBFbGxpcHNvaWRUYW5nZW50UGxhbmVfZGVmYXVsdChwb3NpdGlvbiwgZWxsaXBzb2lkKTsKICAgIGNvbnN0IG5leHQgPSB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50T250b1BsYW5lKAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uLCBzdGFydCwgbmV4dFNjcmF0Y2gpLAogICAgICBuZXh0U2NyYXRjaAogICAgKTsKICAgIGNvbnN0IHByZXYgPSB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50T250b1BsYW5lKAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uLCBlbmQsIHByZXZTY3JhdGNoKSwKICAgICAgcHJldlNjcmF0Y2gKICAgICk7CiAgICBjb25zdCBhbmdsZSA9IENhcnRlc2lhbjJfZGVmYXVsdC5hbmdsZUJldHdlZW4obmV4dCwgcHJldik7CiAgICByZXR1cm4gcHJldi54ICogbmV4dC55IC0gcHJldi55ICogbmV4dC54ID49IDAgPyAtYW5nbGUgOiBhbmdsZTsKICB9CiAgZnVuY3Rpb24gYWRkUG9zaXRpb24oY2VudGVyLCBsZWZ0LCBzaGFwZSwgZmluYWxQb3NpdGlvbnMsIGVsbGlwc29pZCwgaGVpZ2h0LCB4U2NhbGFyLCByZXBlYXQpIHsKICAgIGxldCB3ZXN0ID0gd2VzdFNjcmF0Y2g7CiAgICBsZXQgZmluYWxQb3NpdGlvbiA9IGZpbmFsUG9zU2NyYXRjaDsKICAgIHRyYW5zZm9ybSA9IFRyYW5zZm9ybXNfZGVmYXVsdC5lYXN0Tm9ydGhVcFRvRml4ZWRGcmFtZShjZW50ZXIsIGVsbGlwc29pZCwgdHJhbnNmb3JtKTsKICAgIHdlc3QgPSBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50QXNWZWN0b3IodHJhbnNmb3JtLCBuZWdhdGl2ZVgsIHdlc3QpOwogICAgd2VzdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUod2VzdCwgd2VzdCk7CiAgICBjb25zdCBhbmdsZSA9IGNvbXB1dGVSb3RhdGlvbkFuZ2xlKHdlc3QsIGxlZnQsIGNlbnRlciwgZWxsaXBzb2lkKTsKICAgIHJvdGF0aW9uWiA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tUm90YXRpb25aKGFuZ2xlLCByb3RhdGlvblopOwogICAgaGVpZ2h0Q2FydGVzaWFuLnogPSBoZWlnaHQ7CiAgICB0cmFuc2Zvcm0gPSBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlUcmFuc2Zvcm1hdGlvbigKICAgICAgdHJhbnNmb3JtLAogICAgICBNYXRyaXg0X2RlZmF1bHQuZnJvbVJvdGF0aW9uVHJhbnNsYXRpb24ocm90YXRpb25aLCBoZWlnaHRDYXJ0ZXNpYW4sIHRyYW5zbGF0aW9uKSwKICAgICAgdHJhbnNmb3JtCiAgICApOwogICAgY29uc3Qgc2NhbGUgPSBzY2FsZU1hdHJpeDsKICAgIHNjYWxlWzBdID0geFNjYWxhcjsKICAgIGZvciAobGV0IGogPSAwOyBqIDwgcmVwZWF0OyBqKyspIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaGFwZS5sZW5ndGg7IGkgKz0gMykgewogICAgICAgIGZpbmFsUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHNoYXBlLCBpLCBmaW5hbFBvc2l0aW9uKTsKICAgICAgICBmaW5hbFBvc2l0aW9uID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoCiAgICAgICAgICBzY2FsZSwKICAgICAgICAgIGZpbmFsUG9zaXRpb24sCiAgICAgICAgICBmaW5hbFBvc2l0aW9uCiAgICAgICAgKTsKICAgICAgICBmaW5hbFBvc2l0aW9uID0gTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludCgKICAgICAgICAgIHRyYW5zZm9ybSwKICAgICAgICAgIGZpbmFsUG9zaXRpb24sCiAgICAgICAgICBmaW5hbFBvc2l0aW9uCiAgICAgICAgKTsKICAgICAgICBmaW5hbFBvc2l0aW9ucy5wdXNoKGZpbmFsUG9zaXRpb24ueCwgZmluYWxQb3NpdGlvbi55LCBmaW5hbFBvc2l0aW9uLnopOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmluYWxQb3NpdGlvbnM7CiAgfQogIGZ1bmN0aW9uIGFkZFBvc2l0aW9ucyhjZW50ZXJzLCBsZWZ0LCBzaGFwZSwgZmluYWxQb3NpdGlvbnMsIGVsbGlwc29pZCwgaGVpZ2h0cywgeFNjYWxhcikgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjZW50ZXJzLmxlbmd0aDsgaSArPSAzKSB7CiAgICAgIGNvbnN0IGNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoY2VudGVycywgaSwgY2VudGVyU2NyYXRjaDIpOwogICAgICBmaW5hbFBvc2l0aW9ucyA9IGFkZFBvc2l0aW9uKAogICAgICAgIGNlbnRlciwKICAgICAgICBsZWZ0LAogICAgICAgIHNoYXBlLAogICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICBoZWlnaHRzW2kgLyAzXSwKICAgICAgICB4U2NhbGFyLAogICAgICAgIDEKICAgICAgKTsKICAgIH0KICAgIHJldHVybiBmaW5hbFBvc2l0aW9uczsKICB9CiAgZnVuY3Rpb24gY29udmVydFNoYXBlVG8zRER1cGxpY2F0ZShzaGFwZTJELCBib3VuZGluZ1JlY3RhbmdsZSkgewogICAgY29uc3QgbGVuZ3RoID0gc2hhcGUyRC5sZW5ndGg7CiAgICBjb25zdCBzaGFwZSA9IG5ldyBBcnJheShsZW5ndGggKiA2KTsKICAgIGxldCBpbmRleCA9IDA7CiAgICBjb25zdCB4T2Zmc2V0ID0gYm91bmRpbmdSZWN0YW5nbGUueCArIGJvdW5kaW5nUmVjdGFuZ2xlLndpZHRoIC8gMjsKICAgIGNvbnN0IHlPZmZzZXQgPSBib3VuZGluZ1JlY3RhbmdsZS55ICsgYm91bmRpbmdSZWN0YW5nbGUuaGVpZ2h0IC8gMjsKICAgIGxldCBwb2ludCA9IHNoYXBlMkRbMF07CiAgICBzaGFwZVtpbmRleCsrXSA9IHBvaW50LnggLSB4T2Zmc2V0OwogICAgc2hhcGVbaW5kZXgrK10gPSAwOwogICAgc2hhcGVbaW5kZXgrK10gPSBwb2ludC55IC0geU9mZnNldDsKICAgIGZvciAobGV0IGkgPSAxOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgcG9pbnQgPSBzaGFwZTJEW2ldOwogICAgICBjb25zdCB4ID0gcG9pbnQueCAtIHhPZmZzZXQ7CiAgICAgIGNvbnN0IHogPSBwb2ludC55IC0geU9mZnNldDsKICAgICAgc2hhcGVbaW5kZXgrK10gPSB4OwogICAgICBzaGFwZVtpbmRleCsrXSA9IDA7CiAgICAgIHNoYXBlW2luZGV4KytdID0gejsKICAgICAgc2hhcGVbaW5kZXgrK10gPSB4OwogICAgICBzaGFwZVtpbmRleCsrXSA9IDA7CiAgICAgIHNoYXBlW2luZGV4KytdID0gejsKICAgIH0KICAgIHBvaW50ID0gc2hhcGUyRFswXTsKICAgIHNoYXBlW2luZGV4KytdID0gcG9pbnQueCAtIHhPZmZzZXQ7CiAgICBzaGFwZVtpbmRleCsrXSA9IDA7CiAgICBzaGFwZVtpbmRleCsrXSA9IHBvaW50LnkgLSB5T2Zmc2V0OwogICAgcmV0dXJuIHNoYXBlOwogIH0KICBmdW5jdGlvbiBjb252ZXJ0U2hhcGVUbzNEKHNoYXBlMkQsIGJvdW5kaW5nUmVjdGFuZ2xlKSB7CiAgICBjb25zdCBsZW5ndGggPSBzaGFwZTJELmxlbmd0aDsKICAgIGNvbnN0IHNoYXBlID0gbmV3IEFycmF5KGxlbmd0aCAqIDMpOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGNvbnN0IHhPZmZzZXQgPSBib3VuZGluZ1JlY3RhbmdsZS54ICsgYm91bmRpbmdSZWN0YW5nbGUud2lkdGggLyAyOwogICAgY29uc3QgeU9mZnNldCA9IGJvdW5kaW5nUmVjdGFuZ2xlLnkgKyBib3VuZGluZ1JlY3RhbmdsZS5oZWlnaHQgLyAyOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBzaGFwZVtpbmRleCsrXSA9IHNoYXBlMkRbaV0ueCAtIHhPZmZzZXQ7CiAgICAgIHNoYXBlW2luZGV4KytdID0gMDsKICAgICAgc2hhcGVbaW5kZXgrK10gPSBzaGFwZTJEW2ldLnkgLSB5T2Zmc2V0OwogICAgfQogICAgcmV0dXJuIHNoYXBlOwogIH0KICBmdW5jdGlvbiBjb21wdXRlUm91bmRDb3JuZXIocGl2b3QsIHN0YXJ0UG9pbnQsIGVuZFBvaW50LCBjb3JuZXJUeXBlLCBsZWZ0SXNPdXRzaWRlLCBlbGxpcHNvaWQsIGZpbmFsUG9zaXRpb25zLCBzaGFwZSwgaGVpZ2h0LCBkdXBsaWNhdGVQb2ludHMpIHsKICAgIGNvbnN0IGFuZ2xlID0gQ2FydGVzaWFuM19kZWZhdWx0LmFuZ2xlQmV0d2VlbigKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHN0YXJ0UG9pbnQsIHBpdm90LCBzY3JhdGNoMSksCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChlbmRQb2ludCwgcGl2b3QsIHNjcmF0Y2gyKQogICAgKTsKICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gY29ybmVyVHlwZSA9PT0gQ29ybmVyVHlwZV9kZWZhdWx0LkJFVkVMRUQgPyAwIDogTWF0aC5jZWlsKGFuZ2xlIC8gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyg1KSk7CiAgICBsZXQgbTsKICAgIGlmIChsZWZ0SXNPdXRzaWRlKSB7CiAgICAgIG0gPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24oCiAgICAgICAgUXVhdGVybmlvbl9kZWZhdWx0LmZyb21BeGlzQW5nbGUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKHBpdm90LCBzY3JhdGNoMSksCiAgICAgICAgICBhbmdsZSAvIChncmFudWxhcml0eSArIDEpLAogICAgICAgICAgcXVhdGVyaW9uCiAgICAgICAgKSwKICAgICAgICByb3RNYXRyaXgKICAgICAgKTsKICAgIH0gZWxzZSB7CiAgICAgIG0gPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24oCiAgICAgICAgUXVhdGVybmlvbl9kZWZhdWx0LmZyb21BeGlzQW5nbGUocGl2b3QsIGFuZ2xlIC8gKGdyYW51bGFyaXR5ICsgMSksIHF1YXRlcmlvbiksCiAgICAgICAgcm90TWF0cml4CiAgICAgICk7CiAgICB9CiAgICBsZXQgbGVmdDsKICAgIGxldCBzdXJmYWNlUG9pbnQ7CiAgICBzdGFydFBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHN0YXJ0UG9pbnQsIHN0YXJ0UG9pbnRTY3JhdGNoKTsKICAgIGlmIChncmFudWxhcml0eSA+IDApIHsKICAgICAgY29uc3QgcmVwZWF0ID0gZHVwbGljYXRlUG9pbnRzID8gMiA6IDE7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZ3JhbnVsYXJpdHk7IGkrKykgewogICAgICAgIHN0YXJ0UG9pbnQgPSBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3RvcihtLCBzdGFydFBvaW50LCBzdGFydFBvaW50KTsKICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHN0YXJ0UG9pbnQsIHBpdm90LCBzY3JhdGNoMSk7CiAgICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUobGVmdCwgbGVmdCk7CiAgICAgICAgaWYgKCFsZWZ0SXNPdXRzaWRlKSB7CiAgICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShsZWZ0LCBsZWZ0KTsKICAgICAgICB9CiAgICAgICAgc3VyZmFjZVBvaW50ID0gZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2Uoc3RhcnRQb2ludCwgc2NyYXRjaDIpOwogICAgICAgIGZpbmFsUG9zaXRpb25zID0gYWRkUG9zaXRpb24oCiAgICAgICAgICBzdXJmYWNlUG9pbnQsCiAgICAgICAgICBsZWZ0LAogICAgICAgICAgc2hhcGUsCiAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIGhlaWdodCwKICAgICAgICAgIDEsCiAgICAgICAgICByZXBlYXQKICAgICAgICApOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHN0YXJ0UG9pbnQsIHBpdm90LCBzY3JhdGNoMSk7CiAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGxlZnQsIGxlZnQpOwogICAgICBpZiAoIWxlZnRJc091dHNpZGUpIHsKICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShsZWZ0LCBsZWZ0KTsKICAgICAgfQogICAgICBzdXJmYWNlUG9pbnQgPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShzdGFydFBvaW50LCBzY3JhdGNoMik7CiAgICAgIGZpbmFsUG9zaXRpb25zID0gYWRkUG9zaXRpb24oCiAgICAgICAgc3VyZmFjZVBvaW50LAogICAgICAgIGxlZnQsCiAgICAgICAgc2hhcGUsCiAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgZWxsaXBzb2lkLAogICAgICAgIGhlaWdodCwKICAgICAgICAxLAogICAgICAgIDEKICAgICAgKTsKICAgICAgZW5kUG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZW5kUG9pbnQsIHN0YXJ0UG9pbnRTY3JhdGNoKTsKICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChlbmRQb2ludCwgcGl2b3QsIHNjcmF0Y2gxKTsKICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUobGVmdCwgbGVmdCk7CiAgICAgIGlmICghbGVmdElzT3V0c2lkZSkgewogICAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGxlZnQsIGxlZnQpOwogICAgICB9CiAgICAgIHN1cmZhY2VQb2ludCA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKGVuZFBvaW50LCBzY3JhdGNoMik7CiAgICAgIGZpbmFsUG9zaXRpb25zID0gYWRkUG9zaXRpb24oCiAgICAgICAgc3VyZmFjZVBvaW50LAogICAgICAgIGxlZnQsCiAgICAgICAgc2hhcGUsCiAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgZWxsaXBzb2lkLAogICAgICAgIGhlaWdodCwKICAgICAgICAxLAogICAgICAgIDEKICAgICAgKTsKICAgIH0KICAgIHJldHVybiBmaW5hbFBvc2l0aW9uczsKICB9CiAgdmFyIHNjcmF0Y2gyQXJyYXksIHNjcmF0Y2hDYXJ0ZXNpYW4xNiwgc2NyYXRjaENhcnRlc2lhbjI2LCBzY3JhdGNoQ2FydGVzaWFuMzcsIHNjcmF0Y2hDYXJ0ZXNpYW40Mywgc2NyYXRjaENhcnRlc2lhbjUyLCBzY3JhdGNoQ2FydGVzaWFuNjIsIHNjcmF0Y2hDYXJ0ZXNpYW43LCBzY3JhdGNoQ2FydGVzaWFuOCwgc2NyYXRjaENhcnRlc2lhbjksIHNjcmF0Y2gxLCBzY3JhdGNoMiwgUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnksIGNhcnRvZ3JhcGhpYywgbmV4dFNjcmF0Y2gsIHByZXZTY3JhdGNoLCBuZWdhdGl2ZVgsIHRyYW5zZm9ybSwgdHJhbnNsYXRpb24sIHJvdGF0aW9uWiwgc2NhbGVNYXRyaXgsIHdlc3RTY3JhdGNoLCBmaW5hbFBvc1NjcmF0Y2gsIGhlaWdodENhcnRlc2lhbiwgY2VudGVyU2NyYXRjaDIsIHF1YXRlcmlvbiwgc3RhcnRQb2ludFNjcmF0Y2gsIHJvdE1hdHJpeCwgc2NyYXRjaEZvcndhcmRQcm9qZWN0aW9uLCBzY3JhdGNoQmFja3dhcmRQcm9qZWN0aW9uLCBQb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0OwogIHZhciBpbml0X1BvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW40KCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfQ29ybmVyVHlwZSgpOwogICAgICBpbml0X0VsbGlwc29pZFRhbmdlbnRQbGFuZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfTWF0cml4NCgpOwogICAgICBpbml0X1BvbHlsaW5lUGlwZWxpbmUoKTsKICAgICAgaW5pdF9RdWF0ZXJuaW9uKCk7CiAgICAgIGluaXRfVHJhbnNmb3JtcygpOwogICAgICBpbml0X29uZVRpbWVXYXJuaW5nKCk7CiAgICAgIHNjcmF0Y2gyQXJyYXkgPSBbbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLCBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCldOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMTYgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4yNiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjM3ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuNDMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW41MiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjYyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuNyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW45ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoMSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFBvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5ID0ge307CiAgICAgIGNhcnRvZ3JhcGhpYyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBuZXh0U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcHJldlNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIG5lZ2F0aXZlWCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoLTEsIDAsIDApOwogICAgICB0cmFuc2Zvcm0gPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIHRyYW5zbGF0aW9uID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICByb3RhdGlvblogPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIHNjYWxlTWF0cml4ID0gTWF0cml4M19kZWZhdWx0LklERU5USVRZLmNsb25lKCk7CiAgICAgIHdlc3RTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmaW5hbFBvc1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgIGhlaWdodENhcnRlc2lhbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2VudGVyU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHF1YXRlcmlvbiA9IG5ldyBRdWF0ZXJuaW9uX2RlZmF1bHQoKTsKICAgICAgc3RhcnRQb2ludFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHJvdE1hdHJpeCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnkucmVtb3ZlRHVwbGljYXRlc0Zyb21TaGFwZSA9IGZ1bmN0aW9uKHNoYXBlUG9zaXRpb25zKSB7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gc2hhcGVQb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGNvbnN0IGNsZWFuZWRQb3NpdGlvbnMgPSBbXTsKICAgICAgICBmb3IgKGxldCBpMCA9IGxlbmd0aCAtIDEsIGkxID0gMDsgaTEgPCBsZW5ndGg7IGkwID0gaTErKykgewogICAgICAgICAgY29uc3QgdjAyID0gc2hhcGVQb3NpdGlvbnNbaTBdOwogICAgICAgICAgY29uc3QgdjEyID0gc2hhcGVQb3NpdGlvbnNbaTFdOwogICAgICAgICAgaWYgKCFDYXJ0ZXNpYW4yX2RlZmF1bHQuZXF1YWxzKHYwMiwgdjEyKSkgewogICAgICAgICAgICBjbGVhbmVkUG9zaXRpb25zLnB1c2godjEyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNsZWFuZWRQb3NpdGlvbnM7CiAgICAgIH07CiAgICAgIFBvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5LmFuZ2xlSXNHcmVhdGVyVGhhblBpID0gZnVuY3Rpb24oZm9yd2FyZCwgYmFja3dhcmQsIHBvc2l0aW9uLCBlbGxpcHNvaWQpIHsKICAgICAgICBjb25zdCB0YW5nZW50UGxhbmUgPSBuZXcgRWxsaXBzb2lkVGFuZ2VudFBsYW5lX2RlZmF1bHQocG9zaXRpb24sIGVsbGlwc29pZCk7CiAgICAgICAgY29uc3QgbmV4dCA9IHRhbmdlbnRQbGFuZS5wcm9qZWN0UG9pbnRPbnRvUGxhbmUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uLCBmb3J3YXJkLCBuZXh0U2NyYXRjaCksCiAgICAgICAgICBuZXh0U2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3QgcHJldiA9IHRhbmdlbnRQbGFuZS5wcm9qZWN0UG9pbnRPbnRvUGxhbmUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uLCBiYWNrd2FyZCwgcHJldlNjcmF0Y2gpLAogICAgICAgICAgcHJldlNjcmF0Y2gKICAgICAgICApOwogICAgICAgIHJldHVybiBwcmV2LnggKiBuZXh0LnkgLSBwcmV2LnkgKiBuZXh0LnggPj0gMDsKICAgICAgfTsKICAgICAgc2NyYXRjaEZvcndhcmRQcm9qZWN0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQmFja3dhcmRQcm9qZWN0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBQb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeS5jb21wdXRlUG9zaXRpb25zID0gZnVuY3Rpb24ocG9zaXRpb25zLCBzaGFwZTJELCBib3VuZGluZ1JlY3RhbmdsZSwgZ2VvbWV0cnksIGR1cGxpY2F0ZVBvaW50cykgewogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IGdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgaGVpZ2h0cyA9IHNjYWxlVG9TdXJmYWNlKHBvc2l0aW9ucywgZWxsaXBzb2lkKTsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGdlb21ldHJ5Ll9ncmFudWxhcml0eTsKICAgICAgICBjb25zdCBjb3JuZXJUeXBlID0gZ2VvbWV0cnkuX2Nvcm5lclR5cGU7CiAgICAgICAgY29uc3Qgc2hhcGVGb3JTaWRlcyA9IGR1cGxpY2F0ZVBvaW50cyA/IGNvbnZlcnRTaGFwZVRvM0REdXBsaWNhdGUoc2hhcGUyRCwgYm91bmRpbmdSZWN0YW5nbGUpIDogY29udmVydFNoYXBlVG8zRChzaGFwZTJELCBib3VuZGluZ1JlY3RhbmdsZSk7CiAgICAgICAgY29uc3Qgc2hhcGVGb3JFbmRzID0gZHVwbGljYXRlUG9pbnRzID8gY29udmVydFNoYXBlVG8zRChzaGFwZTJELCBib3VuZGluZ1JlY3RhbmdsZSkgOiB2b2lkIDA7CiAgICAgICAgY29uc3QgaGVpZ2h0T2Zmc2V0ID0gYm91bmRpbmdSZWN0YW5nbGUuaGVpZ2h0IC8gMjsKICAgICAgICBjb25zdCB3aWR0aCA9IGJvdW5kaW5nUmVjdGFuZ2xlLndpZHRoIC8gMjsKICAgICAgICBsZXQgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBsZXQgZmluYWxQb3NpdGlvbnMgPSBbXTsKICAgICAgICBsZXQgZW5kcyA9IGR1cGxpY2F0ZVBvaW50cyA/IFtdIDogdm9pZCAwOwogICAgICAgIGxldCBmb3J3YXJkID0gc2NyYXRjaENhcnRlc2lhbjE2OwogICAgICAgIGxldCBiYWNrd2FyZCA9IHNjcmF0Y2hDYXJ0ZXNpYW4yNjsKICAgICAgICBsZXQgY29ybmVyRGlyZWN0aW9uID0gc2NyYXRjaENhcnRlc2lhbjM3OwogICAgICAgIGxldCBzdXJmYWNlTm9ybWFsID0gc2NyYXRjaENhcnRlc2lhbjQzOwogICAgICAgIGxldCBwaXZvdCA9IHNjcmF0Y2hDYXJ0ZXNpYW41MjsKICAgICAgICBsZXQgc3RhcnQgPSBzY3JhdGNoQ2FydGVzaWFuNjI7CiAgICAgICAgbGV0IGVuZCA9IHNjcmF0Y2hDYXJ0ZXNpYW43OwogICAgICAgIGxldCBsZWZ0ID0gc2NyYXRjaENhcnRlc2lhbjg7CiAgICAgICAgbGV0IHByZXZpb3VzUG9zaXRpb24gPSBzY3JhdGNoQ2FydGVzaWFuOTsKICAgICAgICBsZXQgcG9zaXRpb24gPSBwb3NpdGlvbnNbMF07CiAgICAgICAgbGV0IG5leHRQb3NpdGlvbiA9IHBvc2l0aW9uc1sxXTsKICAgICAgICBzdXJmYWNlTm9ybWFsID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbiwgc3VyZmFjZU5vcm1hbCk7CiAgICAgICAgZm9yd2FyZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChuZXh0UG9zaXRpb24sIHBvc2l0aW9uLCBmb3J3YXJkKTsKICAgICAgICBmb3J3YXJkID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShmb3J3YXJkLCBmb3J3YXJkKTsKICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHN1cmZhY2VOb3JtYWwsIGZvcndhcmQsIGxlZnQpOwogICAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGxlZnQsIGxlZnQpOwogICAgICAgIGxldCBoMCA9IGhlaWdodHNbMF07CiAgICAgICAgbGV0IGgxID0gaGVpZ2h0c1sxXTsKICAgICAgICBpZiAoZHVwbGljYXRlUG9pbnRzKSB7CiAgICAgICAgICBlbmRzID0gYWRkUG9zaXRpb24oCiAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICBsZWZ0LAogICAgICAgICAgICBzaGFwZUZvckVuZHMsCiAgICAgICAgICAgIGVuZHMsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgaDAgKyBoZWlnaHRPZmZzZXQsCiAgICAgICAgICAgIDEsCiAgICAgICAgICAgIDEKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHByZXZpb3VzUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocG9zaXRpb24sIHByZXZpb3VzUG9zaXRpb24pOwogICAgICAgIHBvc2l0aW9uID0gbmV4dFBvc2l0aW9uOwogICAgICAgIGJhY2t3YXJkID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShmb3J3YXJkLCBiYWNrd2FyZCk7CiAgICAgICAgbGV0IHN1YmRpdmlkZWRIZWlnaHRzOwogICAgICAgIGxldCBzdWJkaXZpZGVkUG9zaXRpb25zOwogICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgbGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgICBjb25zdCByZXBlYXQgPSBkdXBsaWNhdGVQb2ludHMgPyAyIDogMTsKICAgICAgICAgIG5leHRQb3NpdGlvbiA9IHBvc2l0aW9uc1tpICsgMV07CiAgICAgICAgICBpZiAocG9zaXRpb24uZXF1YWxzKG5leHRQb3NpdGlvbikpIHsKICAgICAgICAgICAgb25lVGltZVdhcm5pbmdfZGVmYXVsdCgKICAgICAgICAgICAgICAiUG9zaXRpb25zIGFyZSB0b28gY2xvc2UgYW5kIGFyZSBjb25zaWRlcmVkIGVxdWl2YWxlbnQgd2l0aCByb3VuZGluZyBlcnJvci4iCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgZm9yd2FyZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChuZXh0UG9zaXRpb24sIHBvc2l0aW9uLCBmb3J3YXJkKTsKICAgICAgICAgIGZvcndhcmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGZvcndhcmQsIGZvcndhcmQpOwogICAgICAgICAgY29ybmVyRGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChmb3J3YXJkLCBiYWNrd2FyZCwgY29ybmVyRGlyZWN0aW9uKTsKICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoY29ybmVyRGlyZWN0aW9uLCBjb3JuZXJEaXJlY3Rpb24pOwogICAgICAgICAgc3VyZmFjZU5vcm1hbCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24sIHN1cmZhY2VOb3JtYWwpOwogICAgICAgICAgY29uc3QgZm9yd2FyZFByb2plY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgICAgc3VyZmFjZU5vcm1hbCwKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmRvdChmb3J3YXJkLCBzdXJmYWNlTm9ybWFsKSwKICAgICAgICAgICAgc2NyYXRjaEZvcndhcmRQcm9qZWN0aW9uCiAgICAgICAgICApOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGZvcndhcmQsIGZvcndhcmRQcm9qZWN0aW9uLCBmb3J3YXJkUHJvamVjdGlvbik7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGZvcndhcmRQcm9qZWN0aW9uLCBmb3J3YXJkUHJvamVjdGlvbik7CiAgICAgICAgICBjb25zdCBiYWNrd2FyZFByb2plY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgICAgc3VyZmFjZU5vcm1hbCwKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmRvdChiYWNrd2FyZCwgc3VyZmFjZU5vcm1hbCksCiAgICAgICAgICAgIHNjcmF0Y2hCYWNrd2FyZFByb2plY3Rpb24KICAgICAgICAgICk7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoYmFja3dhcmQsIGJhY2t3YXJkUHJvamVjdGlvbiwgYmFja3dhcmRQcm9qZWN0aW9uKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoYmFja3dhcmRQcm9qZWN0aW9uLCBiYWNrd2FyZFByb2plY3Rpb24pOwogICAgICAgICAgY29uc3QgZG9Db3JuZXIgPSAhTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICAgIE1hdGguYWJzKENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZm9yd2FyZFByb2plY3Rpb24sIGJhY2t3YXJkUHJvamVjdGlvbikpLAogICAgICAgICAgICAxLAogICAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjcKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoZG9Db3JuZXIpIHsKICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKAogICAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiwKICAgICAgICAgICAgICBzdXJmYWNlTm9ybWFsLAogICAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbgogICAgICAgICAgICApOwogICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoCiAgICAgICAgICAgICAgc3VyZmFjZU5vcm1hbCwKICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24sCiAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoY29ybmVyRGlyZWN0aW9uLCBjb3JuZXJEaXJlY3Rpb24pOwogICAgICAgICAgICBjb25zdCBzY2FsYXIgPSAxIC8gTWF0aC5tYXgoCiAgICAgICAgICAgICAgMC4yNSwKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKGNvcm5lckRpcmVjdGlvbiwgYmFja3dhcmQsIHNjcmF0Y2gxKQogICAgICAgICAgICAgICkKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29uc3QgbGVmdElzT3V0c2lkZSA9IFBvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5LmFuZ2xlSXNHcmVhdGVyVGhhblBpKAogICAgICAgICAgICAgIGZvcndhcmQsCiAgICAgICAgICAgICAgYmFja3dhcmQsCiAgICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmIChsZWZ0SXNPdXRzaWRlKSB7CiAgICAgICAgICAgICAgcGl2b3QgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uLAogICAgICAgICAgICAgICAgICBzY2FsYXIgKiB3aWR0aCwKICAgICAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uCiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgcGl2b3QKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHN0YXJ0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICAgICAgICAgIHBpdm90LAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobGVmdCwgd2lkdGgsIHN0YXJ0KSwKICAgICAgICAgICAgICAgIHN0YXJ0CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBzY3JhdGNoMkFycmF5WzBdID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHByZXZpb3VzUG9zaXRpb24sIHNjcmF0Y2gyQXJyYXlbMF0pOwogICAgICAgICAgICAgIHNjcmF0Y2gyQXJyYXlbMV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoc3RhcnQsIHNjcmF0Y2gyQXJyYXlbMV0pOwogICAgICAgICAgICAgIHN1YmRpdmlkZWRIZWlnaHRzID0gc3ViZGl2aWRlSGVpZ2h0czIoCiAgICAgICAgICAgICAgICBzY3JhdGNoMkFycmF5LAogICAgICAgICAgICAgICAgaDAgKyBoZWlnaHRPZmZzZXQsCiAgICAgICAgICAgICAgICBoMSArIGhlaWdodE9mZnNldCwKICAgICAgICAgICAgICAgIGdyYW51bGFyaXR5CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmdlbmVyYXRlQXJjKHsKICAgICAgICAgICAgICAgIHBvc2l0aW9uczogc2NyYXRjaDJBcnJheSwKICAgICAgICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMgPSBhZGRQb3NpdGlvbnMoCiAgICAgICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLAogICAgICAgICAgICAgICAgbGVmdCwKICAgICAgICAgICAgICAgIHNoYXBlRm9yU2lkZXMsCiAgICAgICAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRIZWlnaHRzLAogICAgICAgICAgICAgICAgMQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhzdXJmYWNlTm9ybWFsLCBmb3J3YXJkLCBsZWZ0KTsKICAgICAgICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShsZWZ0LCBsZWZ0KTsKICAgICAgICAgICAgICBlbmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgICAgICAgcGl2b3QsCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihsZWZ0LCB3aWR0aCwgZW5kKSwKICAgICAgICAgICAgICAgIGVuZAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKGNvcm5lclR5cGUgPT09IENvcm5lclR5cGVfZGVmYXVsdC5ST1VOREVEIHx8IGNvcm5lclR5cGUgPT09IENvcm5lclR5cGVfZGVmYXVsdC5CRVZFTEVEKSB7CiAgICAgICAgICAgICAgICBjb21wdXRlUm91bmRDb3JuZXIoCiAgICAgICAgICAgICAgICAgIHBpdm90LAogICAgICAgICAgICAgICAgICBzdGFydCwKICAgICAgICAgICAgICAgICAgZW5kLAogICAgICAgICAgICAgICAgICBjb3JuZXJUeXBlLAogICAgICAgICAgICAgICAgICBsZWZ0SXNPdXRzaWRlLAogICAgICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgICAgICAgICBzaGFwZUZvclNpZGVzLAogICAgICAgICAgICAgICAgICBoMSArIGhlaWdodE9mZnNldCwKICAgICAgICAgICAgICAgICAgZHVwbGljYXRlUG9pbnRzCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGNvcm5lckRpcmVjdGlvbiwgY29ybmVyRGlyZWN0aW9uKTsKICAgICAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zID0gYWRkUG9zaXRpb24oCiAgICAgICAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24sCiAgICAgICAgICAgICAgICAgIHNoYXBlRm9yU2lkZXMsCiAgICAgICAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgICAgIGgxICsgaGVpZ2h0T2Zmc2V0LAogICAgICAgICAgICAgICAgICBzY2FsYXIsCiAgICAgICAgICAgICAgICAgIHJlcGVhdAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJldmlvdXNQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShlbmQsIHByZXZpb3VzUG9zaXRpb24pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBpdm90ID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiwKICAgICAgICAgICAgICAgICAgc2NhbGFyICogd2lkdGgsCiAgICAgICAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbgogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIHBpdm90CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBzdGFydCA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICAgICAgICBwaXZvdCwKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGxlZnQsIC13aWR0aCwgc3RhcnQpLAogICAgICAgICAgICAgICAgc3RhcnQKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHNjcmF0Y2gyQXJyYXlbMF0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocHJldmlvdXNQb3NpdGlvbiwgc2NyYXRjaDJBcnJheVswXSk7CiAgICAgICAgICAgICAgc2NyYXRjaDJBcnJheVsxXSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShzdGFydCwgc2NyYXRjaDJBcnJheVsxXSk7CiAgICAgICAgICAgICAgc3ViZGl2aWRlZEhlaWdodHMgPSBzdWJkaXZpZGVIZWlnaHRzMigKICAgICAgICAgICAgICAgIHNjcmF0Y2gyQXJyYXksCiAgICAgICAgICAgICAgICBoMCArIGhlaWdodE9mZnNldCwKICAgICAgICAgICAgICAgIGgxICsgaGVpZ2h0T2Zmc2V0LAogICAgICAgICAgICAgICAgZ3JhbnVsYXJpdHkKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMgPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQuZ2VuZXJhdGVBcmMoewogICAgICAgICAgICAgICAgcG9zaXRpb25zOiBzY3JhdGNoMkFycmF5LAogICAgICAgICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICAgICAgICBlbGxpcHNvaWQKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBmaW5hbFBvc2l0aW9ucyA9IGFkZFBvc2l0aW9ucygKICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMsCiAgICAgICAgICAgICAgICBsZWZ0LAogICAgICAgICAgICAgICAgc2hhcGVGb3JTaWRlcywKICAgICAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgc3ViZGl2aWRlZEhlaWdodHMsCiAgICAgICAgICAgICAgICAxCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHN1cmZhY2VOb3JtYWwsIGZvcndhcmQsIGxlZnQpOwogICAgICAgICAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGxlZnQsIGxlZnQpOwogICAgICAgICAgICAgIGVuZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICAgICAgICBwaXZvdCwKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGxlZnQsIC13aWR0aCwgZW5kKSwKICAgICAgICAgICAgICAgIGVuZAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKGNvcm5lclR5cGUgPT09IENvcm5lclR5cGVfZGVmYXVsdC5ST1VOREVEIHx8IGNvcm5lclR5cGUgPT09IENvcm5lclR5cGVfZGVmYXVsdC5CRVZFTEVEKSB7CiAgICAgICAgICAgICAgICBjb21wdXRlUm91bmRDb3JuZXIoCiAgICAgICAgICAgICAgICAgIHBpdm90LAogICAgICAgICAgICAgICAgICBzdGFydCwKICAgICAgICAgICAgICAgICAgZW5kLAogICAgICAgICAgICAgICAgICBjb3JuZXJUeXBlLAogICAgICAgICAgICAgICAgICBsZWZ0SXNPdXRzaWRlLAogICAgICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgICAgICAgICBzaGFwZUZvclNpZGVzLAogICAgICAgICAgICAgICAgICBoMSArIGhlaWdodE9mZnNldCwKICAgICAgICAgICAgICAgICAgZHVwbGljYXRlUG9pbnRzCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmaW5hbFBvc2l0aW9ucyA9IGFkZFBvc2l0aW9uKAogICAgICAgICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uLAogICAgICAgICAgICAgICAgICBzaGFwZUZvclNpZGVzLAogICAgICAgICAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgICBoMSArIGhlaWdodE9mZnNldCwKICAgICAgICAgICAgICAgICAgc2NhbGFyLAogICAgICAgICAgICAgICAgICByZXBlYXQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXZpb3VzUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZW5kLCBwcmV2aW91c1Bvc2l0aW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBiYWNrd2FyZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoZm9yd2FyZCwgYmFja3dhcmQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMgPSBhZGRQb3NpdGlvbigKICAgICAgICAgICAgICBwcmV2aW91c1Bvc2l0aW9uLAogICAgICAgICAgICAgIGxlZnQsCiAgICAgICAgICAgICAgc2hhcGVGb3JTaWRlcywKICAgICAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgaDAgKyBoZWlnaHRPZmZzZXQsCiAgICAgICAgICAgICAgMSwKICAgICAgICAgICAgICAxCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHByZXZpb3VzUG9zaXRpb24gPSBwb3NpdGlvbjsKICAgICAgICAgIH0KICAgICAgICAgIGgwID0gaDE7CiAgICAgICAgICBoMSA9IGhlaWdodHNbaSArIDFdOwogICAgICAgICAgcG9zaXRpb24gPSBuZXh0UG9zaXRpb247CiAgICAgICAgfQogICAgICAgIHNjcmF0Y2gyQXJyYXlbMF0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocHJldmlvdXNQb3NpdGlvbiwgc2NyYXRjaDJBcnJheVswXSk7CiAgICAgICAgc2NyYXRjaDJBcnJheVsxXSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwb3NpdGlvbiwgc2NyYXRjaDJBcnJheVsxXSk7CiAgICAgICAgc3ViZGl2aWRlZEhlaWdodHMgPSBzdWJkaXZpZGVIZWlnaHRzMigKICAgICAgICAgIHNjcmF0Y2gyQXJyYXksCiAgICAgICAgICBoMCArIGhlaWdodE9mZnNldCwKICAgICAgICAgIGgxICsgaGVpZ2h0T2Zmc2V0LAogICAgICAgICAgZ3JhbnVsYXJpdHkKICAgICAgICApOwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMgPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQuZ2VuZXJhdGVBcmMoewogICAgICAgICAgcG9zaXRpb25zOiBzY3JhdGNoMkFycmF5LAogICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICBlbGxpcHNvaWQKICAgICAgICB9KTsKICAgICAgICBmaW5hbFBvc2l0aW9ucyA9IGFkZFBvc2l0aW9ucygKICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMsCiAgICAgICAgICBsZWZ0LAogICAgICAgICAgc2hhcGVGb3JTaWRlcywKICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgc3ViZGl2aWRlZEhlaWdodHMsCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICBpZiAoZHVwbGljYXRlUG9pbnRzKSB7CiAgICAgICAgICBlbmRzID0gYWRkUG9zaXRpb24oCiAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICBsZWZ0LAogICAgICAgICAgICBzaGFwZUZvckVuZHMsCiAgICAgICAgICAgIGVuZHMsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgaDEgKyBoZWlnaHRPZmZzZXQsCiAgICAgICAgICAgIDEsCiAgICAgICAgICAgIDEKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGxlbmd0aCA9IGZpbmFsUG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBjb25zdCBwb3NMZW5ndGggPSBkdXBsaWNhdGVQb2ludHMgPyBsZW5ndGggKyBlbmRzLmxlbmd0aCA6IGxlbmd0aDsKICAgICAgICBjb25zdCBjb21iaW5lZFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkocG9zTGVuZ3RoKTsKICAgICAgICBjb21iaW5lZFBvc2l0aW9ucy5zZXQoZmluYWxQb3NpdGlvbnMpOwogICAgICAgIGlmIChkdXBsaWNhdGVQb2ludHMpIHsKICAgICAgICAgIGNvbWJpbmVkUG9zaXRpb25zLnNldChlbmRzLCBsZW5ndGgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29tYmluZWRQb3NpdGlvbnM7CiAgICAgIH07CiAgICAgIFBvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQgPSBQb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5LmpzCiAgZnVuY3Rpb24gY29tcHV0ZVJvdW5kQ29ybmVyMihjb3JuZXJQb2ludCwgc3RhcnRQb2ludCwgZW5kUG9pbnQsIGNvcm5lclR5cGUsIGxlZnRJc091dHNpZGUpIHsKICAgIGNvbnN0IGFuZ2xlID0gQ2FydGVzaWFuM19kZWZhdWx0LmFuZ2xlQmV0d2VlbigKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHN0YXJ0UG9pbnQsIGNvcm5lclBvaW50LCBzY3JhdGNoMTIpLAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoZW5kUG9pbnQsIGNvcm5lclBvaW50LCBzY3JhdGNoMjIpCiAgICApOwogICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBjb3JuZXJUeXBlID09PSBDb3JuZXJUeXBlX2RlZmF1bHQuQkVWRUxFRCA/IDEgOiBNYXRoLmNlaWwoYW5nbGUgLyBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKDUpKSArIDE7CiAgICBjb25zdCBzaXplID0gZ3JhbnVsYXJpdHkgKiAzOwogICAgY29uc3QgYXJyYXkgPSBuZXcgQXJyYXkoc2l6ZSk7CiAgICBhcnJheVtzaXplIC0gM10gPSBlbmRQb2ludC54OwogICAgYXJyYXlbc2l6ZSAtIDJdID0gZW5kUG9pbnQueTsKICAgIGFycmF5W3NpemUgLSAxXSA9IGVuZFBvaW50Lno7CiAgICBsZXQgbTsKICAgIGlmIChsZWZ0SXNPdXRzaWRlKSB7CiAgICAgIG0gPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24oCiAgICAgICAgUXVhdGVybmlvbl9kZWZhdWx0LmZyb21BeGlzQW5nbGUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGNvcm5lclBvaW50LCBzY3JhdGNoMTIpLAogICAgICAgICAgYW5nbGUgLyBncmFudWxhcml0eSwKICAgICAgICAgIHF1YXRlcmlvbjIKICAgICAgICApLAogICAgICAgIHJvdE1hdHJpeDIKICAgICAgKTsKICAgIH0gZWxzZSB7CiAgICAgIG0gPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24oCiAgICAgICAgUXVhdGVybmlvbl9kZWZhdWx0LmZyb21BeGlzQW5nbGUoY29ybmVyUG9pbnQsIGFuZ2xlIC8gZ3JhbnVsYXJpdHksIHF1YXRlcmlvbjIpLAogICAgICAgIHJvdE1hdHJpeDIKICAgICAgKTsKICAgIH0KICAgIGxldCBpbmRleCA9IDA7CiAgICBzdGFydFBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHN0YXJ0UG9pbnQsIHNjcmF0Y2gxMik7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGdyYW51bGFyaXR5OyBpKyspIHsKICAgICAgc3RhcnRQb2ludCA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKG0sIHN0YXJ0UG9pbnQsIHN0YXJ0UG9pbnQpOwogICAgICBhcnJheVtpbmRleCsrXSA9IHN0YXJ0UG9pbnQueDsKICAgICAgYXJyYXlbaW5kZXgrK10gPSBzdGFydFBvaW50Lnk7CiAgICAgIGFycmF5W2luZGV4KytdID0gc3RhcnRQb2ludC56OwogICAgfQogICAgcmV0dXJuIGFycmF5OwogIH0KICBmdW5jdGlvbiBhZGRFbmRDYXBzKGNhbGN1bGF0ZWRQb3NpdGlvbnMpIHsKICAgIGxldCBjb3JuZXJQb2ludCA9IGNhcnRlc2lhbjE7CiAgICBsZXQgc3RhcnRQb2ludCA9IGNhcnRlc2lhbjI7CiAgICBsZXQgZW5kUG9pbnQgPSBjYXJ0ZXNpYW4zOwogICAgbGV0IGxlZnRFZGdlID0gY2FsY3VsYXRlZFBvc2l0aW9uc1sxXTsKICAgIHN0YXJ0UG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICBjYWxjdWxhdGVkUG9zaXRpb25zWzFdLAogICAgICBsZWZ0RWRnZS5sZW5ndGggLSAzLAogICAgICBzdGFydFBvaW50CiAgICApOwogICAgZW5kUG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGNhbGN1bGF0ZWRQb3NpdGlvbnNbMF0sIDAsIGVuZFBvaW50KTsKICAgIGNvcm5lclBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1pZHBvaW50KHN0YXJ0UG9pbnQsIGVuZFBvaW50LCBjb3JuZXJQb2ludCk7CiAgICBjb25zdCBmaXJzdEVuZENhcCA9IGNvbXB1dGVSb3VuZENvcm5lcjIoCiAgICAgIGNvcm5lclBvaW50LAogICAgICBzdGFydFBvaW50LAogICAgICBlbmRQb2ludCwKICAgICAgQ29ybmVyVHlwZV9kZWZhdWx0LlJPVU5ERUQsCiAgICAgIGZhbHNlCiAgICApOwogICAgY29uc3QgbGVuZ3RoID0gY2FsY3VsYXRlZFBvc2l0aW9ucy5sZW5ndGggLSAxOwogICAgY29uc3QgcmlnaHRFZGdlID0gY2FsY3VsYXRlZFBvc2l0aW9uc1tsZW5ndGggLSAxXTsKICAgIGxlZnRFZGdlID0gY2FsY3VsYXRlZFBvc2l0aW9uc1tsZW5ndGhdOwogICAgc3RhcnRQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgIHJpZ2h0RWRnZSwKICAgICAgcmlnaHRFZGdlLmxlbmd0aCAtIDMsCiAgICAgIHN0YXJ0UG9pbnQKICAgICk7CiAgICBlbmRQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkobGVmdEVkZ2UsIDAsIGVuZFBvaW50KTsKICAgIGNvcm5lclBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1pZHBvaW50KHN0YXJ0UG9pbnQsIGVuZFBvaW50LCBjb3JuZXJQb2ludCk7CiAgICBjb25zdCBsYXN0RW5kQ2FwID0gY29tcHV0ZVJvdW5kQ29ybmVyMigKICAgICAgY29ybmVyUG9pbnQsCiAgICAgIHN0YXJ0UG9pbnQsCiAgICAgIGVuZFBvaW50LAogICAgICBDb3JuZXJUeXBlX2RlZmF1bHQuUk9VTkRFRCwKICAgICAgZmFsc2UKICAgICk7CiAgICByZXR1cm4gW2ZpcnN0RW5kQ2FwLCBsYXN0RW5kQ2FwXTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZU1pdGVyZWRDb3JuZXIocG9zaXRpb24sIGxlZnRDb3JuZXJEaXJlY3Rpb24sIGxhc3RQb2ludCwgbGVmdElzT3V0c2lkZSkgewogICAgbGV0IGNvcm5lclBvaW50ID0gc2NyYXRjaDEyOwogICAgaWYgKGxlZnRJc091dHNpZGUpIHsKICAgICAgY29ybmVyUG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uLCBsZWZ0Q29ybmVyRGlyZWN0aW9uLCBjb3JuZXJQb2ludCk7CiAgICB9IGVsc2UgewogICAgICBsZWZ0Q29ybmVyRGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZSgKICAgICAgICBsZWZ0Q29ybmVyRGlyZWN0aW9uLAogICAgICAgIGxlZnRDb3JuZXJEaXJlY3Rpb24KICAgICAgKTsKICAgICAgY29ybmVyUG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uLCBsZWZ0Q29ybmVyRGlyZWN0aW9uLCBjb3JuZXJQb2ludCk7CiAgICB9CiAgICByZXR1cm4gWwogICAgICBjb3JuZXJQb2ludC54LAogICAgICBjb3JuZXJQb2ludC55LAogICAgICBjb3JuZXJQb2ludC56LAogICAgICBsYXN0UG9pbnQueCwKICAgICAgbGFzdFBvaW50LnksCiAgICAgIGxhc3RQb2ludC56CiAgICBdOwogIH0KICBmdW5jdGlvbiBhZGRTaGlmdGVkUG9zaXRpb25zKHBvc2l0aW9ucywgbGVmdCwgc2NhbGFyLCBjYWxjdWxhdGVkUG9zaXRpb25zKSB7CiAgICBjb25zdCByaWdodFBvc2l0aW9ucyA9IG5ldyBBcnJheShwb3NpdGlvbnMubGVuZ3RoKTsKICAgIGNvbnN0IGxlZnRQb3NpdGlvbnMgPSBuZXcgQXJyYXkocG9zaXRpb25zLmxlbmd0aCk7CiAgICBjb25zdCBzY2FsZWRMZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobGVmdCwgc2NhbGFyLCBzY3JhdGNoMTIpOwogICAgY29uc3Qgc2NhbGVkUmlnaHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKHNjYWxlZExlZnQsIHNjcmF0Y2gyMik7CiAgICBsZXQgcmlnaHRJbmRleCA9IDA7CiAgICBsZXQgbGVmdEluZGV4ID0gcG9zaXRpb25zLmxlbmd0aCAtIDE7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9ucy5sZW5ndGg7IGkgKz0gMykgewogICAgICBjb25zdCBwb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaSwgc2NyYXRjaDMpOwogICAgICBjb25zdCByaWdodFBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zLCBzY2FsZWRSaWdodCwgc2NyYXRjaDQpOwogICAgICByaWdodFBvc2l0aW9uc1tyaWdodEluZGV4KytdID0gcmlnaHRQb3MueDsKICAgICAgcmlnaHRQb3NpdGlvbnNbcmlnaHRJbmRleCsrXSA9IHJpZ2h0UG9zLnk7CiAgICAgIHJpZ2h0UG9zaXRpb25zW3JpZ2h0SW5kZXgrK10gPSByaWdodFBvcy56OwogICAgICBjb25zdCBsZWZ0UG9zID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwb3MsIHNjYWxlZExlZnQsIHNjcmF0Y2g0KTsKICAgICAgbGVmdFBvc2l0aW9uc1tsZWZ0SW5kZXgtLV0gPSBsZWZ0UG9zLno7CiAgICAgIGxlZnRQb3NpdGlvbnNbbGVmdEluZGV4LS1dID0gbGVmdFBvcy55OwogICAgICBsZWZ0UG9zaXRpb25zW2xlZnRJbmRleC0tXSA9IGxlZnRQb3MueDsKICAgIH0KICAgIGNhbGN1bGF0ZWRQb3NpdGlvbnMucHVzaChyaWdodFBvc2l0aW9ucywgbGVmdFBvc2l0aW9ucyk7CiAgICByZXR1cm4gY2FsY3VsYXRlZFBvc2l0aW9uczsKICB9CiAgdmFyIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5LCBzY3JhdGNoMTIsIHNjcmF0Y2gyMiwgc2NyYXRjaDMsIHNjcmF0Y2g0LCBzY2FsZUFycmF5MiwgY2FydGVzaWFuMSwgY2FydGVzaWFuMiwgY2FydGVzaWFuMywgY2FydGVzaWFuNCwgY2FydGVzaWFuNSwgY2FydGVzaWFuNiwgY2FydGVzaWFuNywgY2FydGVzaWFuOCwgY2FydGVzaWFuOSwgY2FydGVzaWFuMTAsIHF1YXRlcmlvbjIsIHJvdE1hdHJpeDIsIHNjcmF0Y2hGb3J3YXJkUHJvamVjdGlvbjIsIHNjcmF0Y2hCYWNrd2FyZFByb2plY3Rpb24yLCBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0OwogIHZhciBpbml0X0NvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db3JyaWRvckdlb21ldHJ5TGlicmFyeS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0Nvcm5lclR5cGUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9Qb2x5bGluZVBpcGVsaW5lKCk7CiAgICAgIGluaXRfUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgaW5pdF9RdWF0ZXJuaW9uKCk7CiAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5ID0ge307CiAgICAgIHNjcmF0Y2gxMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaDIyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaDQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjYWxlQXJyYXkyID0gW25ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpXTsKICAgICAgY2FydGVzaWFuMSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuNCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuNSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuNiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuNyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuOCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuOSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuMTAgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHF1YXRlcmlvbjIgPSBuZXcgUXVhdGVybmlvbl9kZWZhdWx0KCk7CiAgICAgIHJvdE1hdHJpeDIgPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5LmFkZEF0dHJpYnV0ZSA9IGZ1bmN0aW9uKGF0dHJpYnV0ZSwgdmFsdWUsIGZyb250LCBiYWNrKSB7CiAgICAgICAgY29uc3QgeCA9IHZhbHVlLng7CiAgICAgICAgY29uc3QgeSA9IHZhbHVlLnk7CiAgICAgICAgY29uc3QgeiA9IHZhbHVlLno7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChmcm9udCkpIHsKICAgICAgICAgIGF0dHJpYnV0ZVtmcm9udF0gPSB4OwogICAgICAgICAgYXR0cmlidXRlW2Zyb250ICsgMV0gPSB5OwogICAgICAgICAgYXR0cmlidXRlW2Zyb250ICsgMl0gPSB6OwogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGJhY2spKSB7CiAgICAgICAgICBhdHRyaWJ1dGVbYmFja10gPSB6OwogICAgICAgICAgYXR0cmlidXRlW2JhY2sgLSAxXSA9IHk7CiAgICAgICAgICBhdHRyaWJ1dGVbYmFjayAtIDJdID0geDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIHNjcmF0Y2hGb3J3YXJkUHJvamVjdGlvbjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hCYWNrd2FyZFByb2plY3Rpb24yID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeS5jb21wdXRlUG9zaXRpb25zID0gZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBwYXJhbXMuZ3JhbnVsYXJpdHk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gcGFyYW1zLnBvc2l0aW9uczsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBwYXJhbXMuZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IHdpZHRoID0gcGFyYW1zLndpZHRoIC8gMjsKICAgICAgICBjb25zdCBjb3JuZXJUeXBlID0gcGFyYW1zLmNvcm5lclR5cGU7CiAgICAgICAgY29uc3Qgc2F2ZUF0dHJpYnV0ZXMgPSBwYXJhbXMuc2F2ZUF0dHJpYnV0ZXM7CiAgICAgICAgbGV0IG5vcm1hbDIgPSBjYXJ0ZXNpYW4xOwogICAgICAgIGxldCBmb3J3YXJkID0gY2FydGVzaWFuMjsKICAgICAgICBsZXQgYmFja3dhcmQgPSBjYXJ0ZXNpYW4zOwogICAgICAgIGxldCBsZWZ0ID0gY2FydGVzaWFuNDsKICAgICAgICBsZXQgY29ybmVyRGlyZWN0aW9uID0gY2FydGVzaWFuNTsKICAgICAgICBsZXQgc3RhcnRQb2ludCA9IGNhcnRlc2lhbjY7CiAgICAgICAgbGV0IHByZXZpb3VzUG9zID0gY2FydGVzaWFuNzsKICAgICAgICBsZXQgcmlnaHRQb3MgPSBjYXJ0ZXNpYW44OwogICAgICAgIGxldCBsZWZ0UG9zID0gY2FydGVzaWFuOTsKICAgICAgICBsZXQgY2VudGVyID0gY2FydGVzaWFuMTA7CiAgICAgICAgbGV0IGNhbGN1bGF0ZWRQb3NpdGlvbnMgPSBbXTsKICAgICAgICBjb25zdCBjYWxjdWxhdGVkTGVmdHMgPSBzYXZlQXR0cmlidXRlcyA/IFtdIDogdm9pZCAwOwogICAgICAgIGNvbnN0IGNhbGN1bGF0ZWROb3JtYWxzID0gc2F2ZUF0dHJpYnV0ZXMgPyBbXSA6IHZvaWQgMDsKICAgICAgICBsZXQgcG9zaXRpb24gPSBwb3NpdGlvbnNbMF07CiAgICAgICAgbGV0IG5leHRQb3NpdGlvbiA9IHBvc2l0aW9uc1sxXTsKICAgICAgICBmb3J3YXJkID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChuZXh0UG9zaXRpb24sIHBvc2l0aW9uLCBmb3J3YXJkKSwKICAgICAgICAgIGZvcndhcmQKICAgICAgICApOwogICAgICAgIG5vcm1hbDIgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHBvc2l0aW9uLCBub3JtYWwyKTsKICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3Mobm9ybWFsMiwgZm9yd2FyZCwgbGVmdCksIGxlZnQpOwogICAgICAgIGlmIChzYXZlQXR0cmlidXRlcykgewogICAgICAgICAgY2FsY3VsYXRlZExlZnRzLnB1c2gobGVmdC54LCBsZWZ0LnksIGxlZnQueik7CiAgICAgICAgICBjYWxjdWxhdGVkTm9ybWFscy5wdXNoKG5vcm1hbDIueCwgbm9ybWFsMi55LCBub3JtYWwyLnopOwogICAgICAgIH0KICAgICAgICBwcmV2aW91c1BvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwb3NpdGlvbiwgcHJldmlvdXNQb3MpOwogICAgICAgIHBvc2l0aW9uID0gbmV4dFBvc2l0aW9uOwogICAgICAgIGJhY2t3YXJkID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShmb3J3YXJkLCBiYWNrd2FyZCk7CiAgICAgICAgbGV0IHN1YmRpdmlkZWRQb3NpdGlvbnM7CiAgICAgICAgY29uc3QgY29ybmVycyA9IFtdOwogICAgICAgIGxldCBpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgZm9yIChpID0gMTsgaSA8IGxlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgbm9ybWFsMiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24sIG5vcm1hbDIpOwogICAgICAgICAgbmV4dFBvc2l0aW9uID0gcG9zaXRpb25zW2kgKyAxXTsKICAgICAgICAgIGZvcndhcmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QobmV4dFBvc2l0aW9uLCBwb3NpdGlvbiwgZm9yd2FyZCksCiAgICAgICAgICAgIGZvcndhcmQKICAgICAgICAgICk7CiAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGZvcndhcmQsIGJhY2t3YXJkLCBjb3JuZXJEaXJlY3Rpb24pLAogICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24KICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBmb3J3YXJkUHJvamVjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICBub3JtYWwyLAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGZvcndhcmQsIG5vcm1hbDIpLAogICAgICAgICAgICBzY3JhdGNoRm9yd2FyZFByb2plY3Rpb24yCiAgICAgICAgICApOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGZvcndhcmQsIGZvcndhcmRQcm9qZWN0aW9uLCBmb3J3YXJkUHJvamVjdGlvbik7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGZvcndhcmRQcm9qZWN0aW9uLCBmb3J3YXJkUHJvamVjdGlvbik7CiAgICAgICAgICBjb25zdCBiYWNrd2FyZFByb2plY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgICAgbm9ybWFsMiwKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmRvdChiYWNrd2FyZCwgbm9ybWFsMiksCiAgICAgICAgICAgIHNjcmF0Y2hCYWNrd2FyZFByb2plY3Rpb24yCiAgICAgICAgICApOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGJhY2t3YXJkLCBiYWNrd2FyZFByb2plY3Rpb24sIGJhY2t3YXJkUHJvamVjdGlvbik7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGJhY2t3YXJkUHJvamVjdGlvbiwgYmFja3dhcmRQcm9qZWN0aW9uKTsKICAgICAgICAgIGNvbnN0IGRvQ29ybmVyID0gIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgICBNYXRoLmFicyhDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGZvcndhcmRQcm9qZWN0aW9uLCBiYWNrd2FyZFByb2plY3Rpb24pKSwKICAgICAgICAgICAgMSwKICAgICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT043CiAgICAgICAgICApOwogICAgICAgICAgaWYgKGRvQ29ybmVyKSB7CiAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcygKICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24sCiAgICAgICAgICAgICAgbm9ybWFsMiwKICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24KICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKAogICAgICAgICAgICAgIG5vcm1hbDIsCiAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uLAogICAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbgogICAgICAgICAgICApOwogICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGNvcm5lckRpcmVjdGlvbiwgY29ybmVyRGlyZWN0aW9uKTsKICAgICAgICAgICAgY29uc3Qgc2NhbGFyID0gd2lkdGggLyBNYXRoLm1heCgKICAgICAgICAgICAgICAwLjI1LAogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoY29ybmVyRGlyZWN0aW9uLCBiYWNrd2FyZCwgc2NyYXRjaDEyKQogICAgICAgICAgICAgICkKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29uc3QgbGVmdElzT3V0c2lkZSA9IFBvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYW5nbGVJc0dyZWF0ZXJUaGFuUGkoCiAgICAgICAgICAgICAgZm9yd2FyZCwKICAgICAgICAgICAgICBiYWNrd2FyZCwKICAgICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgICBlbGxpcHNvaWQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uLAogICAgICAgICAgICAgIHNjYWxhciwKICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24KICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKGxlZnRJc091dHNpZGUpIHsKICAgICAgICAgICAgICByaWdodFBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24sIGNvcm5lckRpcmVjdGlvbiwgcmlnaHRQb3MpOwogICAgICAgICAgICAgIGNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICAgICAgICByaWdodFBvcywKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGxlZnQsIHdpZHRoLCBjZW50ZXIpLAogICAgICAgICAgICAgICAgY2VudGVyCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBsZWZ0UG9zID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICAgICAgICAgIHJpZ2h0UG9zLAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobGVmdCwgd2lkdGggKiAyLCBsZWZ0UG9zKSwKICAgICAgICAgICAgICAgIGxlZnRQb3MKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHNjYWxlQXJyYXkyWzBdID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHByZXZpb3VzUG9zLCBzY2FsZUFycmF5MlswXSk7CiAgICAgICAgICAgICAgc2NhbGVBcnJheTJbMV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY2VudGVyLCBzY2FsZUFycmF5MlsxXSk7CiAgICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucyA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5nZW5lcmF0ZUFyYyh7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnM6IHNjYWxlQXJyYXkyLAogICAgICAgICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICAgICAgICBlbGxpcHNvaWQKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBjYWxjdWxhdGVkUG9zaXRpb25zID0gYWRkU2hpZnRlZFBvc2l0aW9ucygKICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMsCiAgICAgICAgICAgICAgICBsZWZ0LAogICAgICAgICAgICAgICAgd2lkdGgsCiAgICAgICAgICAgICAgICBjYWxjdWxhdGVkUG9zaXRpb25zCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAoc2F2ZUF0dHJpYnV0ZXMpIHsKICAgICAgICAgICAgICAgIGNhbGN1bGF0ZWRMZWZ0cy5wdXNoKGxlZnQueCwgbGVmdC55LCBsZWZ0LnopOwogICAgICAgICAgICAgICAgY2FsY3VsYXRlZE5vcm1hbHMucHVzaChub3JtYWwyLngsIG5vcm1hbDIueSwgbm9ybWFsMi56KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3RhcnRQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShsZWZ0UG9zLCBzdGFydFBvaW50KTsKICAgICAgICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhub3JtYWwyLCBmb3J3YXJkLCBsZWZ0KSwKICAgICAgICAgICAgICAgIGxlZnQKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGxlZnRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgICAgICAgcmlnaHRQb3MsCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihsZWZ0LCB3aWR0aCAqIDIsIGxlZnRQb3MpLAogICAgICAgICAgICAgICAgbGVmdFBvcwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgcHJldmlvdXNQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgICAgICAgcmlnaHRQb3MsCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihsZWZ0LCB3aWR0aCwgcHJldmlvdXNQb3MpLAogICAgICAgICAgICAgICAgcHJldmlvdXNQb3MKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChjb3JuZXJUeXBlID09PSBDb3JuZXJUeXBlX2RlZmF1bHQuUk9VTkRFRCB8fCBjb3JuZXJUeXBlID09PSBDb3JuZXJUeXBlX2RlZmF1bHQuQkVWRUxFRCkgewogICAgICAgICAgICAgICAgY29ybmVycy5wdXNoKHsKICAgICAgICAgICAgICAgICAgbGVmdFBvc2l0aW9uczogY29tcHV0ZVJvdW5kQ29ybmVyMigKICAgICAgICAgICAgICAgICAgICByaWdodFBvcywKICAgICAgICAgICAgICAgICAgICBzdGFydFBvaW50LAogICAgICAgICAgICAgICAgICAgIGxlZnRQb3MsCiAgICAgICAgICAgICAgICAgICAgY29ybmVyVHlwZSwKICAgICAgICAgICAgICAgICAgICBsZWZ0SXNPdXRzaWRlCiAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb3JuZXJzLnB1c2goewogICAgICAgICAgICAgICAgICBsZWZ0UG9zaXRpb25zOiBjb21wdXRlTWl0ZXJlZENvcm5lcigKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGNvcm5lckRpcmVjdGlvbiwgY29ybmVyRGlyZWN0aW9uKSwKICAgICAgICAgICAgICAgICAgICBsZWZ0UG9zLAogICAgICAgICAgICAgICAgICAgIGxlZnRJc091dHNpZGUKICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxlZnRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uLCBjb3JuZXJEaXJlY3Rpb24sIGxlZnRQb3MpOwogICAgICAgICAgICAgIGNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICAgICAgICBsZWZ0UG9zLAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZSgKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobGVmdCwgd2lkdGgsIGNlbnRlciksCiAgICAgICAgICAgICAgICAgIGNlbnRlcgogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIGNlbnRlcgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgcmlnaHRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgICAgICAgbGVmdFBvcywKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoCiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGxlZnQsIHdpZHRoICogMiwgcmlnaHRQb3MpLAogICAgICAgICAgICAgICAgICByaWdodFBvcwogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIHJpZ2h0UG9zCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBzY2FsZUFycmF5MlswXSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwcmV2aW91c1Bvcywgc2NhbGVBcnJheTJbMF0pOwogICAgICAgICAgICAgIHNjYWxlQXJyYXkyWzFdID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlciwgc2NhbGVBcnJheTJbMV0pOwogICAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMgPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQuZ2VuZXJhdGVBcmMoewogICAgICAgICAgICAgICAgcG9zaXRpb25zOiBzY2FsZUFycmF5MiwKICAgICAgICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgY2FsY3VsYXRlZFBvc2l0aW9ucyA9IGFkZFNoaWZ0ZWRQb3NpdGlvbnMoCiAgICAgICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLAogICAgICAgICAgICAgICAgbGVmdCwKICAgICAgICAgICAgICAgIHdpZHRoLAogICAgICAgICAgICAgICAgY2FsY3VsYXRlZFBvc2l0aW9ucwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKHNhdmVBdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgICAgICBjYWxjdWxhdGVkTGVmdHMucHVzaChsZWZ0LngsIGxlZnQueSwgbGVmdC56KTsKICAgICAgICAgICAgICAgIGNhbGN1bGF0ZWROb3JtYWxzLnB1c2gobm9ybWFsMi54LCBub3JtYWwyLnksIG5vcm1hbDIueik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHN0YXJ0UG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocmlnaHRQb3MsIHN0YXJ0UG9pbnQpOwogICAgICAgICAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKG5vcm1hbDIsIGZvcndhcmQsIGxlZnQpLAogICAgICAgICAgICAgICAgbGVmdAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgcmlnaHRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgICAgICAgbGVmdFBvcywKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoCiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGxlZnQsIHdpZHRoICogMiwgcmlnaHRQb3MpLAogICAgICAgICAgICAgICAgICByaWdodFBvcwogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIHJpZ2h0UG9zCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBwcmV2aW91c1BvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICAgICAgICBsZWZ0UG9zLAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZSgKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobGVmdCwgd2lkdGgsIHByZXZpb3VzUG9zKSwKICAgICAgICAgICAgICAgICAgcHJldmlvdXNQb3MKICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICBwcmV2aW91c1BvcwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKGNvcm5lclR5cGUgPT09IENvcm5lclR5cGVfZGVmYXVsdC5ST1VOREVEIHx8IGNvcm5lclR5cGUgPT09IENvcm5lclR5cGVfZGVmYXVsdC5CRVZFTEVEKSB7CiAgICAgICAgICAgICAgICBjb3JuZXJzLnB1c2goewogICAgICAgICAgICAgICAgICByaWdodFBvc2l0aW9uczogY29tcHV0ZVJvdW5kQ29ybmVyMigKICAgICAgICAgICAgICAgICAgICBsZWZ0UG9zLAogICAgICAgICAgICAgICAgICAgIHN0YXJ0UG9pbnQsCiAgICAgICAgICAgICAgICAgICAgcmlnaHRQb3MsCiAgICAgICAgICAgICAgICAgICAgY29ybmVyVHlwZSwKICAgICAgICAgICAgICAgICAgICBsZWZ0SXNPdXRzaWRlCiAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb3JuZXJzLnB1c2goewogICAgICAgICAgICAgICAgICByaWdodFBvc2l0aW9uczogY29tcHV0ZU1pdGVyZWRDb3JuZXIoCiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uLAogICAgICAgICAgICAgICAgICAgIHJpZ2h0UG9zLAogICAgICAgICAgICAgICAgICAgIGxlZnRJc091dHNpZGUKICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGJhY2t3YXJkID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShmb3J3YXJkLCBiYWNrd2FyZCk7CiAgICAgICAgICB9CiAgICAgICAgICBwb3NpdGlvbiA9IG5leHRQb3NpdGlvbjsKICAgICAgICB9CiAgICAgICAgbm9ybWFsMiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24sIG5vcm1hbDIpOwogICAgICAgIHNjYWxlQXJyYXkyWzBdID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHByZXZpb3VzUG9zLCBzY2FsZUFycmF5MlswXSk7CiAgICAgICAgc2NhbGVBcnJheTJbMV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocG9zaXRpb24sIHNjYWxlQXJyYXkyWzFdKTsKICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmdlbmVyYXRlQXJjKHsKICAgICAgICAgIHBvc2l0aW9uczogc2NhbGVBcnJheTIsCiAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgIGVsbGlwc29pZAogICAgICAgIH0pOwogICAgICAgIGNhbGN1bGF0ZWRQb3NpdGlvbnMgPSBhZGRTaGlmdGVkUG9zaXRpb25zKAogICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucywKICAgICAgICAgIGxlZnQsCiAgICAgICAgICB3aWR0aCwKICAgICAgICAgIGNhbGN1bGF0ZWRQb3NpdGlvbnMKICAgICAgICApOwogICAgICAgIGlmIChzYXZlQXR0cmlidXRlcykgewogICAgICAgICAgY2FsY3VsYXRlZExlZnRzLnB1c2gobGVmdC54LCBsZWZ0LnksIGxlZnQueik7CiAgICAgICAgICBjYWxjdWxhdGVkTm9ybWFscy5wdXNoKG5vcm1hbDIueCwgbm9ybWFsMi55LCBub3JtYWwyLnopOwogICAgICAgIH0KICAgICAgICBsZXQgZW5kUG9zaXRpb25zOwogICAgICAgIGlmIChjb3JuZXJUeXBlID09PSBDb3JuZXJUeXBlX2RlZmF1bHQuUk9VTkRFRCkgewogICAgICAgICAgZW5kUG9zaXRpb25zID0gYWRkRW5kQ2FwcyhjYWxjdWxhdGVkUG9zaXRpb25zKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHBvc2l0aW9uczogY2FsY3VsYXRlZFBvc2l0aW9ucywKICAgICAgICAgIGNvcm5lcnMsCiAgICAgICAgICBsZWZ0czogY2FsY3VsYXRlZExlZnRzLAogICAgICAgICAgbm9ybWFsczogY2FsY3VsYXRlZE5vcm1hbHMsCiAgICAgICAgICBlbmRQb3NpdGlvbnMKICAgICAgICB9OwogICAgICB9OwogICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0ID0gQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db3JyaWRvckdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gc2NhbGVUb1N1cmZhY2UyKHBvc2l0aW9ucywgZWxsaXBzb2lkKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICBwb3NpdGlvbnNbaV0gPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShwb3NpdGlvbnNbaV0sIHBvc2l0aW9uc1tpXSk7CiAgICB9CiAgICByZXR1cm4gcG9zaXRpb25zOwogIH0KICBmdW5jdGlvbiBhZGROb3JtYWxzKGF0dHIsIG5vcm1hbDIsIGxlZnQsIGZyb250LCBiYWNrLCB2ZXJ0ZXhGb3JtYXQpIHsKICAgIGNvbnN0IG5vcm1hbHMgPSBhdHRyLm5vcm1hbHM7CiAgICBjb25zdCB0YW5nZW50cyA9IGF0dHIudGFuZ2VudHM7CiAgICBjb25zdCBiaXRhbmdlbnRzID0gYXR0ci5iaXRhbmdlbnRzOwogICAgY29uc3QgZm9yd2FyZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhsZWZ0LCBub3JtYWwyLCBzY3JhdGNoMTMpLAogICAgICBzY3JhdGNoMTMKICAgICk7CiAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZShub3JtYWxzLCBub3JtYWwyLCBmcm9udCwgYmFjayk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUodGFuZ2VudHMsIGZvcndhcmQsIGZyb250LCBiYWNrKTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKGJpdGFuZ2VudHMsIGxlZnQsIGZyb250LCBiYWNrKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gY29tYmluZTIoY29tcHV0ZWRQb3NpdGlvbnMsIHZlcnRleEZvcm1hdCwgZWxsaXBzb2lkKSB7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBjb21wdXRlZFBvc2l0aW9ucy5wb3NpdGlvbnM7CiAgICBjb25zdCBjb3JuZXJzID0gY29tcHV0ZWRQb3NpdGlvbnMuY29ybmVyczsKICAgIGNvbnN0IGVuZFBvc2l0aW9ucyA9IGNvbXB1dGVkUG9zaXRpb25zLmVuZFBvc2l0aW9uczsKICAgIGNvbnN0IGNvbXB1dGVkTGVmdHMgPSBjb21wdXRlZFBvc2l0aW9ucy5sZWZ0czsKICAgIGNvbnN0IGNvbXB1dGVkTm9ybWFscyA9IGNvbXB1dGVkUG9zaXRpb25zLm5vcm1hbHM7CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICBsZXQgY29ybmVyOwogICAgbGV0IGxlZnRDb3VudCA9IDA7CiAgICBsZXQgcmlnaHRDb3VudCA9IDA7CiAgICBsZXQgaTsKICAgIGxldCBpbmRpY2VzTGVuZ3RoID0gMDsKICAgIGxldCBsZW5ndGg7CiAgICBmb3IgKGkgPSAwOyBpIDwgcG9zaXRpb25zLmxlbmd0aDsgaSArPSAyKSB7CiAgICAgIGxlbmd0aCA9IHBvc2l0aW9uc1tpXS5sZW5ndGggLSAzOwogICAgICBsZWZ0Q291bnQgKz0gbGVuZ3RoOwogICAgICBpbmRpY2VzTGVuZ3RoICs9IGxlbmd0aCAqIDI7CiAgICAgIHJpZ2h0Q291bnQgKz0gcG9zaXRpb25zW2kgKyAxXS5sZW5ndGggLSAzOwogICAgfQogICAgbGVmdENvdW50ICs9IDM7CiAgICByaWdodENvdW50ICs9IDM7CiAgICBmb3IgKGkgPSAwOyBpIDwgY29ybmVycy5sZW5ndGg7IGkrKykgewogICAgICBjb3JuZXIgPSBjb3JuZXJzW2ldOwogICAgICBjb25zdCBsZWZ0U2lkZSA9IGNvcm5lcnNbaV0ubGVmdFBvc2l0aW9uczsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChsZWZ0U2lkZSkpIHsKICAgICAgICBsZW5ndGggPSBsZWZ0U2lkZS5sZW5ndGg7CiAgICAgICAgbGVmdENvdW50ICs9IGxlbmd0aDsKICAgICAgICBpbmRpY2VzTGVuZ3RoICs9IGxlbmd0aDsKICAgICAgfSBlbHNlIHsKICAgICAgICBsZW5ndGggPSBjb3JuZXJzW2ldLnJpZ2h0UG9zaXRpb25zLmxlbmd0aDsKICAgICAgICByaWdodENvdW50ICs9IGxlbmd0aDsKICAgICAgICBpbmRpY2VzTGVuZ3RoICs9IGxlbmd0aDsKICAgICAgfQogICAgfQogICAgY29uc3QgYWRkRW5kUG9zaXRpb25zID0gZGVmaW5lZF9kZWZhdWx0KGVuZFBvc2l0aW9ucyk7CiAgICBsZXQgZW5kUG9zaXRpb25MZW5ndGg7CiAgICBpZiAoYWRkRW5kUG9zaXRpb25zKSB7CiAgICAgIGVuZFBvc2l0aW9uTGVuZ3RoID0gZW5kUG9zaXRpb25zWzBdLmxlbmd0aCAtIDM7CiAgICAgIGxlZnRDb3VudCArPSBlbmRQb3NpdGlvbkxlbmd0aDsKICAgICAgcmlnaHRDb3VudCArPSBlbmRQb3NpdGlvbkxlbmd0aDsKICAgICAgZW5kUG9zaXRpb25MZW5ndGggLz0gMzsKICAgICAgaW5kaWNlc0xlbmd0aCArPSBlbmRQb3NpdGlvbkxlbmd0aCAqIDY7CiAgICB9CiAgICBjb25zdCBzaXplID0gbGVmdENvdW50ICsgcmlnaHRDb3VudDsKICAgIGNvbnN0IGZpbmFsUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShzaXplKTsKICAgIGNvbnN0IG5vcm1hbHMgPSB2ZXJ0ZXhGb3JtYXQubm9ybWFsID8gbmV3IEZsb2F0MzJBcnJheShzaXplKSA6IHZvaWQgMDsKICAgIGNvbnN0IHRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LnRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUpIDogdm9pZCAwOwogICAgY29uc3QgYml0YW5nZW50cyA9IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUpIDogdm9pZCAwOwogICAgY29uc3QgYXR0ciA9IHsKICAgICAgbm9ybWFscywKICAgICAgdGFuZ2VudHMsCiAgICAgIGJpdGFuZ2VudHMKICAgIH07CiAgICBsZXQgZnJvbnQgPSAwOwogICAgbGV0IGJhY2sgPSBzaXplIC0gMTsKICAgIGxldCBVTCwgTEwsIFVSLCBMUjsKICAgIGxldCBub3JtYWwyID0gY2FydGVzaWFuMTI7CiAgICBsZXQgbGVmdCA9IGNhcnRlc2lhbjIyOwogICAgbGV0IHJpZ2h0UG9zLCBsZWZ0UG9zOwogICAgY29uc3QgaGFsZkxlbmd0aCA9IGVuZFBvc2l0aW9uTGVuZ3RoIC8gMjsKICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShzaXplIC8gMywgaW5kaWNlc0xlbmd0aCk7CiAgICBsZXQgaW5kZXggPSAwOwogICAgaWYgKGFkZEVuZFBvc2l0aW9ucykgewogICAgICBsZWZ0UG9zID0gY2FydGVzaWFuMzI7CiAgICAgIHJpZ2h0UG9zID0gY2FydGVzaWFuNDI7CiAgICAgIGNvbnN0IGZpcnN0RW5kUG9zaXRpb25zID0gZW5kUG9zaXRpb25zWzBdOwogICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShjb21wdXRlZE5vcm1hbHMsIDAsIG5vcm1hbDIpOwogICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShjb21wdXRlZExlZnRzLCAwLCBsZWZ0KTsKICAgICAgZm9yIChpID0gMDsgaSA8IGhhbGZMZW5ndGg7IGkrKykgewogICAgICAgIGxlZnRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgZmlyc3RFbmRQb3NpdGlvbnMsCiAgICAgICAgICAoaGFsZkxlbmd0aCAtIDEgLSBpKSAqIDMsCiAgICAgICAgICBsZWZ0UG9zCiAgICAgICAgKTsKICAgICAgICByaWdodFBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICBmaXJzdEVuZFBvc2l0aW9ucywKICAgICAgICAgIChoYWxmTGVuZ3RoICsgaSkgKiAzLAogICAgICAgICAgcmlnaHRQb3MKICAgICAgICApOwogICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKGZpbmFsUG9zaXRpb25zLCByaWdodFBvcywgZnJvbnQpOwogICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICBsZWZ0UG9zLAogICAgICAgICAgdm9pZCAwLAogICAgICAgICAgYmFjawogICAgICAgICk7CiAgICAgICAgYWRkTm9ybWFscyhhdHRyLCBub3JtYWwyLCBsZWZ0LCBmcm9udCwgYmFjaywgdmVydGV4Rm9ybWF0KTsKICAgICAgICBMTCA9IGZyb250IC8gMzsKICAgICAgICBMUiA9IExMICsgMTsKICAgICAgICBVTCA9IChiYWNrIC0gMikgLyAzOwogICAgICAgIFVSID0gVUwgLSAxOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVTDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVUjsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExSOwogICAgICAgIGZyb250ICs9IDM7CiAgICAgICAgYmFjayAtPSAzOwogICAgICB9CiAgICB9CiAgICBsZXQgcG9zSW5kZXggPSAwOwogICAgbGV0IGNvbXBJbmRleCA9IDA7CiAgICBsZXQgcmlnaHRFZGdlID0gcG9zaXRpb25zW3Bvc0luZGV4KytdOwogICAgbGV0IGxlZnRFZGdlID0gcG9zaXRpb25zW3Bvc0luZGV4KytdOwogICAgZmluYWxQb3NpdGlvbnMuc2V0KHJpZ2h0RWRnZSwgZnJvbnQpOwogICAgZmluYWxQb3NpdGlvbnMuc2V0KGxlZnRFZGdlLCBiYWNrIC0gbGVmdEVkZ2UubGVuZ3RoICsgMSk7CiAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShjb21wdXRlZExlZnRzLCBjb21wSW5kZXgsIGxlZnQpOwogICAgbGV0IHJpZ2h0Tm9ybWFsOwogICAgbGV0IGxlZnROb3JtYWw7CiAgICBsZW5ndGggPSBsZWZ0RWRnZS5sZW5ndGggLSAzOwogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAzKSB7CiAgICAgIHJpZ2h0Tm9ybWFsID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbCgKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHJpZ2h0RWRnZSwgaSwgc2NyYXRjaDEzKSwKICAgICAgICBzY3JhdGNoMTMKICAgICAgKTsKICAgICAgbGVmdE5vcm1hbCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoCiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShsZWZ0RWRnZSwgbGVuZ3RoIC0gaSwgc2NyYXRjaDIzKSwKICAgICAgICBzY3JhdGNoMjMKICAgICAgKTsKICAgICAgbm9ybWFsMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyaWdodE5vcm1hbCwgbGVmdE5vcm1hbCwgbm9ybWFsMiksCiAgICAgICAgbm9ybWFsMgogICAgICApOwogICAgICBhZGROb3JtYWxzKGF0dHIsIG5vcm1hbDIsIGxlZnQsIGZyb250LCBiYWNrLCB2ZXJ0ZXhGb3JtYXQpOwogICAgICBMTCA9IGZyb250IC8gMzsKICAgICAgTFIgPSBMTCArIDE7CiAgICAgIFVMID0gKGJhY2sgLSAyKSAvIDM7CiAgICAgIFVSID0gVUwgLSAxOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gVUw7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gVVI7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExSOwogICAgICBmcm9udCArPSAzOwogICAgICBiYWNrIC09IDM7CiAgICB9CiAgICByaWdodE5vcm1hbCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocmlnaHRFZGdlLCBsZW5ndGgsIHNjcmF0Y2gxMyksCiAgICAgIHNjcmF0Y2gxMwogICAgKTsKICAgIGxlZnROb3JtYWwgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGxlZnRFZGdlLCBsZW5ndGgsIHNjcmF0Y2gyMyksCiAgICAgIHNjcmF0Y2gyMwogICAgKTsKICAgIG5vcm1hbDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJpZ2h0Tm9ybWFsLCBsZWZ0Tm9ybWFsLCBub3JtYWwyKSwKICAgICAgbm9ybWFsMgogICAgKTsKICAgIGNvbXBJbmRleCArPSAzOwogICAgZm9yIChpID0gMDsgaSA8IGNvcm5lcnMubGVuZ3RoOyBpKyspIHsKICAgICAgbGV0IGo7CiAgICAgIGNvcm5lciA9IGNvcm5lcnNbaV07CiAgICAgIGNvbnN0IGwgPSBjb3JuZXIubGVmdFBvc2l0aW9uczsKICAgICAgY29uc3QgciA9IGNvcm5lci5yaWdodFBvc2l0aW9uczsKICAgICAgbGV0IHBpdm90OwogICAgICBsZXQgc3RhcnQ7CiAgICAgIGxldCBvdXRzaWRlUG9pbnQgPSBjYXJ0ZXNpYW42MjsKICAgICAgbGV0IHByZXZpb3VzUG9pbnQgPSBjYXJ0ZXNpYW4zMjsKICAgICAgbGV0IG5leHRQb2ludCA9IGNhcnRlc2lhbjQyOwogICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShjb21wdXRlZE5vcm1hbHMsIGNvbXBJbmRleCwgbm9ybWFsMik7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobCkpIHsKICAgICAgICBhZGROb3JtYWxzKGF0dHIsIG5vcm1hbDIsIGxlZnQsIHZvaWQgMCwgYmFjaywgdmVydGV4Rm9ybWF0KTsKICAgICAgICBiYWNrIC09IDM7CiAgICAgICAgcGl2b3QgPSBMUjsKICAgICAgICBzdGFydCA9IFVSOwogICAgICAgIGZvciAoaiA9IDA7IGogPCBsLmxlbmd0aCAvIDM7IGorKykgewogICAgICAgICAgb3V0c2lkZVBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShsLCBqICogMywgb3V0c2lkZVBvaW50KTsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBwaXZvdDsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBzdGFydCAtIGogLSAxOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHN0YXJ0IC0gajsKICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgICAgb3V0c2lkZVBvaW50LAogICAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICAgIGJhY2sKICAgICAgICAgICk7CiAgICAgICAgICBwcmV2aW91c1BvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICAgIChzdGFydCAtIGogLSAxKSAqIDMsCiAgICAgICAgICAgIHByZXZpb3VzUG9pbnQKICAgICAgICAgICk7CiAgICAgICAgICBuZXh0UG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGZpbmFsUG9zaXRpb25zLCBwaXZvdCAqIDMsIG5leHRQb2ludCk7CiAgICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHByZXZpb3VzUG9pbnQsIG5leHRQb2ludCwgbGVmdCksCiAgICAgICAgICAgIGxlZnQKICAgICAgICAgICk7CiAgICAgICAgICBhZGROb3JtYWxzKGF0dHIsIG5vcm1hbDIsIGxlZnQsIHZvaWQgMCwgYmFjaywgdmVydGV4Rm9ybWF0KTsKICAgICAgICAgIGJhY2sgLT0gMzsKICAgICAgICB9CiAgICAgICAgb3V0c2lkZVBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgcGl2b3QgKiAzLAogICAgICAgICAgb3V0c2lkZVBvaW50CiAgICAgICAgKTsKICAgICAgICBwcmV2aW91c1BvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShmaW5hbFBvc2l0aW9ucywgc3RhcnQgKiAzLCBwcmV2aW91c1BvaW50KSwKICAgICAgICAgIG91dHNpZGVQb2ludCwKICAgICAgICAgIHByZXZpb3VzUG9pbnQKICAgICAgICApOwogICAgICAgIG5leHRQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoZmluYWxQb3NpdGlvbnMsIChzdGFydCAtIGopICogMywgbmV4dFBvaW50KSwKICAgICAgICAgIG91dHNpZGVQb2ludCwKICAgICAgICAgIG5leHRQb2ludAogICAgICAgICk7CiAgICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHByZXZpb3VzUG9pbnQsIG5leHRQb2ludCwgbGVmdCksCiAgICAgICAgICBsZWZ0CiAgICAgICAgKTsKICAgICAgICBhZGROb3JtYWxzKGF0dHIsIG5vcm1hbDIsIGxlZnQsIGZyb250LCB2b2lkIDAsIHZlcnRleEZvcm1hdCk7CiAgICAgICAgZnJvbnQgKz0gMzsKICAgICAgfSBlbHNlIHsKICAgICAgICBhZGROb3JtYWxzKGF0dHIsIG5vcm1hbDIsIGxlZnQsIGZyb250LCB2b2lkIDAsIHZlcnRleEZvcm1hdCk7CiAgICAgICAgZnJvbnQgKz0gMzsKICAgICAgICBwaXZvdCA9IFVSOwogICAgICAgIHN0YXJ0ID0gTFI7CiAgICAgICAgZm9yIChqID0gMDsgaiA8IHIubGVuZ3RoIC8gMzsgaisrKSB7CiAgICAgICAgICBvdXRzaWRlUG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHIsIGogKiAzLCBvdXRzaWRlUG9pbnQpOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHBpdm90OwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHN0YXJ0ICsgajsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBzdGFydCArIGogKyAxOwogICAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoCiAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgICBvdXRzaWRlUG9pbnQsCiAgICAgICAgICAgIGZyb250CiAgICAgICAgICApOwogICAgICAgICAgcHJldmlvdXNQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgICBwaXZvdCAqIDMsCiAgICAgICAgICAgIHByZXZpb3VzUG9pbnQKICAgICAgICAgICk7CiAgICAgICAgICBuZXh0UG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgICAgKHN0YXJ0ICsgaikgKiAzLAogICAgICAgICAgICBuZXh0UG9pbnQKICAgICAgICAgICk7CiAgICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHByZXZpb3VzUG9pbnQsIG5leHRQb2ludCwgbGVmdCksCiAgICAgICAgICAgIGxlZnQKICAgICAgICAgICk7CiAgICAgICAgICBhZGROb3JtYWxzKGF0dHIsIG5vcm1hbDIsIGxlZnQsIGZyb250LCB2b2lkIDAsIHZlcnRleEZvcm1hdCk7CiAgICAgICAgICBmcm9udCArPSAzOwogICAgICAgIH0KICAgICAgICBvdXRzaWRlUG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICBwaXZvdCAqIDMsCiAgICAgICAgICBvdXRzaWRlUG9pbnQKICAgICAgICApOwogICAgICAgIHByZXZpb3VzUG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGZpbmFsUG9zaXRpb25zLCAoc3RhcnQgKyBqKSAqIDMsIHByZXZpb3VzUG9pbnQpLAogICAgICAgICAgb3V0c2lkZVBvaW50LAogICAgICAgICAgcHJldmlvdXNQb2ludAogICAgICAgICk7CiAgICAgICAgbmV4dFBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShmaW5hbFBvc2l0aW9ucywgc3RhcnQgKiAzLCBuZXh0UG9pbnQpLAogICAgICAgICAgb3V0c2lkZVBvaW50LAogICAgICAgICAgbmV4dFBvaW50CiAgICAgICAgKTsKICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoQ2FydGVzaWFuM19kZWZhdWx0LmFkZChuZXh0UG9pbnQsIHByZXZpb3VzUG9pbnQsIGxlZnQpLCBsZWZ0KSwKICAgICAgICAgIGxlZnQKICAgICAgICApOwogICAgICAgIGFkZE5vcm1hbHMoYXR0ciwgbm9ybWFsMiwgbGVmdCwgdm9pZCAwLCBiYWNrLCB2ZXJ0ZXhGb3JtYXQpOwogICAgICAgIGJhY2sgLT0gMzsKICAgICAgfQogICAgICByaWdodEVkZ2UgPSBwb3NpdGlvbnNbcG9zSW5kZXgrK107CiAgICAgIGxlZnRFZGdlID0gcG9zaXRpb25zW3Bvc0luZGV4KytdOwogICAgICByaWdodEVkZ2Uuc3BsaWNlKDAsIDMpOwogICAgICBsZWZ0RWRnZS5zcGxpY2UobGVmdEVkZ2UubGVuZ3RoIC0gMywgMyk7CiAgICAgIGZpbmFsUG9zaXRpb25zLnNldChyaWdodEVkZ2UsIGZyb250KTsKICAgICAgZmluYWxQb3NpdGlvbnMuc2V0KGxlZnRFZGdlLCBiYWNrIC0gbGVmdEVkZ2UubGVuZ3RoICsgMSk7CiAgICAgIGxlbmd0aCA9IGxlZnRFZGdlLmxlbmd0aCAtIDM7CiAgICAgIGNvbXBJbmRleCArPSAzOwogICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShjb21wdXRlZExlZnRzLCBjb21wSW5kZXgsIGxlZnQpOwogICAgICBmb3IgKGogPSAwOyBqIDwgbGVmdEVkZ2UubGVuZ3RoOyBqICs9IDMpIHsKICAgICAgICByaWdodE5vcm1hbCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHJpZ2h0RWRnZSwgaiwgc2NyYXRjaDEzKSwKICAgICAgICAgIHNjcmF0Y2gxMwogICAgICAgICk7CiAgICAgICAgbGVmdE5vcm1hbCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGxlZnRFZGdlLCBsZW5ndGggLSBqLCBzY3JhdGNoMjMpLAogICAgICAgICAgc2NyYXRjaDIzCiAgICAgICAgKTsKICAgICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmlnaHROb3JtYWwsIGxlZnROb3JtYWwsIG5vcm1hbDIpLAogICAgICAgICAgbm9ybWFsMgogICAgICAgICk7CiAgICAgICAgYWRkTm9ybWFscyhhdHRyLCBub3JtYWwyLCBsZWZ0LCBmcm9udCwgYmFjaywgdmVydGV4Rm9ybWF0KTsKICAgICAgICBMUiA9IGZyb250IC8gMzsKICAgICAgICBMTCA9IExSIC0gMTsKICAgICAgICBVUiA9IChiYWNrIC0gMikgLyAzOwogICAgICAgIFVMID0gVVIgKyAxOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVTDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVUjsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExSOwogICAgICAgIGZyb250ICs9IDM7CiAgICAgICAgYmFjayAtPSAzOwogICAgICB9CiAgICAgIGZyb250IC09IDM7CiAgICAgIGJhY2sgKz0gMzsKICAgIH0KICAgIG5vcm1hbDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICBjb21wdXRlZE5vcm1hbHMsCiAgICAgIGNvbXB1dGVkTm9ybWFscy5sZW5ndGggLSAzLAogICAgICBub3JtYWwyCiAgICApOwogICAgYWRkTm9ybWFscyhhdHRyLCBub3JtYWwyLCBsZWZ0LCBmcm9udCwgYmFjaywgdmVydGV4Rm9ybWF0KTsKICAgIGlmIChhZGRFbmRQb3NpdGlvbnMpIHsKICAgICAgZnJvbnQgKz0gMzsKICAgICAgYmFjayAtPSAzOwogICAgICBsZWZ0UG9zID0gY2FydGVzaWFuMzI7CiAgICAgIHJpZ2h0UG9zID0gY2FydGVzaWFuNDI7CiAgICAgIGNvbnN0IGxhc3RFbmRQb3NpdGlvbnMgPSBlbmRQb3NpdGlvbnNbMV07CiAgICAgIGZvciAoaSA9IDA7IGkgPCBoYWxmTGVuZ3RoOyBpKyspIHsKICAgICAgICBsZWZ0UG9zID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgIGxhc3RFbmRQb3NpdGlvbnMsCiAgICAgICAgICAoZW5kUG9zaXRpb25MZW5ndGggLSBpIC0gMSkgKiAzLAogICAgICAgICAgbGVmdFBvcwogICAgICAgICk7CiAgICAgICAgcmlnaHRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGxhc3RFbmRQb3NpdGlvbnMsIGkgKiAzLCByaWdodFBvcyk7CiAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoCiAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgIGxlZnRQb3MsCiAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICBiYWNrCiAgICAgICAgKTsKICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZShmaW5hbFBvc2l0aW9ucywgcmlnaHRQb3MsIGZyb250KTsKICAgICAgICBhZGROb3JtYWxzKGF0dHIsIG5vcm1hbDIsIGxlZnQsIGZyb250LCBiYWNrLCB2ZXJ0ZXhGb3JtYXQpOwogICAgICAgIExSID0gZnJvbnQgLyAzOwogICAgICAgIExMID0gTFIgLSAxOwogICAgICAgIFVSID0gKGJhY2sgLSAyKSAvIDM7CiAgICAgICAgVUwgPSBVUiArIDE7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVMOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gVVI7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gTFI7CiAgICAgICAgZnJvbnQgKz0gMzsKICAgICAgICBiYWNrIC09IDM7CiAgICAgIH0KICAgIH0KICAgIGF0dHJpYnV0ZXMucG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgdmFsdWVzOiBmaW5hbFBvc2l0aW9ucwogICAgfSk7CiAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgIGNvbnN0IHN0ID0gbmV3IEZsb2F0MzJBcnJheShzaXplIC8gMyAqIDIpOwogICAgICBsZXQgcmlnaHRTdDsKICAgICAgbGV0IGxlZnRTdDsKICAgICAgbGV0IHN0SW5kZXggPSAwOwogICAgICBpZiAoYWRkRW5kUG9zaXRpb25zKSB7CiAgICAgICAgbGVmdENvdW50IC89IDM7CiAgICAgICAgcmlnaHRDb3VudCAvPSAzOwogICAgICAgIGNvbnN0IHRoZXRhID0gTWF0aC5QSSAvIChlbmRQb3NpdGlvbkxlbmd0aCArIDEpOwogICAgICAgIGxlZnRTdCA9IDEgLyAobGVmdENvdW50IC0gZW5kUG9zaXRpb25MZW5ndGggKyAxKTsKICAgICAgICByaWdodFN0ID0gMSAvIChyaWdodENvdW50IC0gZW5kUG9zaXRpb25MZW5ndGggKyAxKTsKICAgICAgICBsZXQgYTM7CiAgICAgICAgY29uc3QgaGFsZkVuZFBvcyA9IGVuZFBvc2l0aW9uTGVuZ3RoIC8gMjsKICAgICAgICBmb3IgKGkgPSBoYWxmRW5kUG9zICsgMTsgaSA8IGVuZFBvc2l0aW9uTGVuZ3RoICsgMTsgaSsrKSB7CiAgICAgICAgICBhMyA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyArIHRoZXRhICogaTsKICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSByaWdodFN0ICogKDEgKyBNYXRoLmNvcyhhMykpOwogICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IDAuNSAqICgxICsgTWF0aC5zaW4oYTMpKTsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gMTsgaSA8IHJpZ2h0Q291bnQgLSBlbmRQb3NpdGlvbkxlbmd0aCArIDE7IGkrKykgewogICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IGkgKiByaWdodFN0OwogICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IDA7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IGVuZFBvc2l0aW9uTGVuZ3RoOyBpID4gaGFsZkVuZFBvczsgaS0tKSB7CiAgICAgICAgICBhMyA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAtIGkgKiB0aGV0YTsKICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSAxIC0gcmlnaHRTdCAqICgxICsgTWF0aC5jb3MoYTMpKTsKICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSAwLjUgKiAoMSArIE1hdGguc2luKGEzKSk7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IGhhbGZFbmRQb3M7IGkgPiAwOyBpLS0pIHsKICAgICAgICAgIGEzID0gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIC0gdGhldGEgKiBpOwogICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IDEgLSBsZWZ0U3QgKiAoMSArIE1hdGguY29zKGEzKSk7CiAgICAgICAgICBzdFtzdEluZGV4KytdID0gMC41ICogKDEgKyBNYXRoLnNpbihhMykpOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSBsZWZ0Q291bnQgLSBlbmRQb3NpdGlvbkxlbmd0aDsgaSA+IDA7IGktLSkgewogICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IGkgKiBsZWZ0U3Q7CiAgICAgICAgICBzdFtzdEluZGV4KytdID0gMTsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gMTsgaSA8IGhhbGZFbmRQb3MgKyAxOyBpKyspIHsKICAgICAgICAgIGEzID0gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPICsgdGhldGEgKiBpOwogICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IGxlZnRTdCAqICgxICsgTWF0aC5jb3MoYTMpKTsKICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSAwLjUgKiAoMSArIE1hdGguc2luKGEzKSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGxlZnRDb3VudCAvPSAzOwogICAgICAgIHJpZ2h0Q291bnQgLz0gMzsKICAgICAgICBsZWZ0U3QgPSAxIC8gKGxlZnRDb3VudCAtIDEpOwogICAgICAgIHJpZ2h0U3QgPSAxIC8gKHJpZ2h0Q291bnQgLSAxKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcmlnaHRDb3VudDsgaSsrKSB7CiAgICAgICAgICBzdFtzdEluZGV4KytdID0gaSAqIHJpZ2h0U3Q7CiAgICAgICAgICBzdFtzdEluZGV4KytdID0gMDsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gbGVmdENvdW50OyBpID4gMDsgaS0tKSB7CiAgICAgICAgICBzdFtzdEluZGV4KytdID0gKGkgLSAxKSAqIGxlZnRTdDsKICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSAxOwogICAgICAgIH0KICAgICAgfQogICAgICBhdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgdmFsdWVzOiBzdAogICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgIGF0dHJpYnV0ZXMubm9ybWFsID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBhdHRyLm5vcm1hbHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgYXR0cmlidXRlcy50YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBhdHRyLnRhbmdlbnRzCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgYXR0cmlidXRlcy5iaXRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IGF0dHIuYml0YW5nZW50cwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIGF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXMKICAgIH07CiAgfQogIGZ1bmN0aW9uIGV4dHJ1ZGVkQXR0cmlidXRlcyhhdHRyaWJ1dGVzLCB2ZXJ0ZXhGb3JtYXQpIHsKICAgIGlmICghdmVydGV4Rm9ybWF0Lm5vcm1hbCAmJiAhdmVydGV4Rm9ybWF0LnRhbmdlbnQgJiYgIXZlcnRleEZvcm1hdC5iaXRhbmdlbnQgJiYgIXZlcnRleEZvcm1hdC5zdCkgewogICAgICByZXR1cm4gYXR0cmlidXRlczsKICAgIH0KICAgIGNvbnN0IHBvc2l0aW9ucyA9IGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgbGV0IHRvcE5vcm1hbHM7CiAgICBsZXQgdG9wQml0YW5nZW50czsKICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsIHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgdG9wTm9ybWFscyA9IGF0dHJpYnV0ZXMubm9ybWFsLnZhbHVlczsKICAgICAgdG9wQml0YW5nZW50cyA9IGF0dHJpYnV0ZXMuYml0YW5nZW50LnZhbHVlczsKICAgIH0KICAgIGNvbnN0IHNpemUgPSBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGggLyAxODsKICAgIGNvbnN0IHRocmVlU2l6ZSA9IHNpemUgKiAzOwogICAgY29uc3QgdHdvU2l6ZSA9IHNpemUgKiAyOwogICAgY29uc3Qgc2l4U2l6ZSA9IHRocmVlU2l6ZSAqIDI7CiAgICBsZXQgaTsKICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsIHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgY29uc3Qgbm9ybWFscyA9IHZlcnRleEZvcm1hdC5ub3JtYWwgPyBuZXcgRmxvYXQzMkFycmF5KHRocmVlU2l6ZSAqIDYpIDogdm9pZCAwOwogICAgICBjb25zdCB0YW5nZW50cyA9IHZlcnRleEZvcm1hdC50YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheSh0aHJlZVNpemUgKiA2KSA6IHZvaWQgMDsKICAgICAgY29uc3QgYml0YW5nZW50cyA9IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KHRocmVlU2l6ZSAqIDYpIDogdm9pZCAwOwogICAgICBsZXQgdG9wUG9zaXRpb24gPSBjYXJ0ZXNpYW4xMjsKICAgICAgbGV0IGJvdHRvbVBvc2l0aW9uID0gY2FydGVzaWFuMjI7CiAgICAgIGxldCBwcmV2aW91c1Bvc2l0aW9uID0gY2FydGVzaWFuMzI7CiAgICAgIGxldCBub3JtYWwyID0gY2FydGVzaWFuNDI7CiAgICAgIGxldCB0YW5nZW50ID0gY2FydGVzaWFuNTI7CiAgICAgIGxldCBiaXRhbmdlbnQgPSBjYXJ0ZXNpYW42MjsKICAgICAgbGV0IGF0dHJJbmRleCA9IHNpeFNpemU7CiAgICAgIGZvciAoaSA9IDA7IGkgPCB0aHJlZVNpemU7IGkgKz0gMykgewogICAgICAgIGNvbnN0IGF0dHJJbmRleE9mZnNldCA9IGF0dHJJbmRleCArIHNpeFNpemU7CiAgICAgICAgdG9wUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaSwgdG9wUG9zaXRpb24pOwogICAgICAgIGJvdHRvbVBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIGkgKyB0aHJlZVNpemUsCiAgICAgICAgICBib3R0b21Qb3NpdGlvbgogICAgICAgICk7CiAgICAgICAgcHJldmlvdXNQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAoaSArIDMpICUgdGhyZWVTaXplLAogICAgICAgICAgcHJldmlvdXNQb3NpdGlvbgogICAgICAgICk7CiAgICAgICAgYm90dG9tUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICBib3R0b21Qb3NpdGlvbiwKICAgICAgICAgIHRvcFBvc2l0aW9uLAogICAgICAgICAgYm90dG9tUG9zaXRpb24KICAgICAgICApOwogICAgICAgIHByZXZpb3VzUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICBwcmV2aW91c1Bvc2l0aW9uLAogICAgICAgICAgdG9wUG9zaXRpb24sCiAgICAgICAgICBwcmV2aW91c1Bvc2l0aW9uCiAgICAgICAgKTsKICAgICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhib3R0b21Qb3NpdGlvbiwgcHJldmlvdXNQb3NpdGlvbiwgbm9ybWFsMiksCiAgICAgICAgICBub3JtYWwyCiAgICAgICAgKTsKICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUobm9ybWFscywgbm9ybWFsMiwgYXR0ckluZGV4T2Zmc2V0KTsKICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgICBub3JtYWxzLAogICAgICAgICAgICBub3JtYWwyLAogICAgICAgICAgICBhdHRySW5kZXhPZmZzZXQgKyAzCiAgICAgICAgICApOwogICAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUobm9ybWFscywgbm9ybWFsMiwgYXR0ckluZGV4KTsKICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKG5vcm1hbHMsIG5vcm1hbDIsIGF0dHJJbmRleCArIDMpOwogICAgICAgIH0KICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgYml0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSh0b3BOb3JtYWxzLCBpLCBiaXRhbmdlbnQpOwogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoCiAgICAgICAgICAgICAgYml0YW5nZW50cywKICAgICAgICAgICAgICBiaXRhbmdlbnQsCiAgICAgICAgICAgICAgYXR0ckluZGV4T2Zmc2V0CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgICAgIGJpdGFuZ2VudHMsCiAgICAgICAgICAgICAgYml0YW5nZW50LAogICAgICAgICAgICAgIGF0dHJJbmRleE9mZnNldCArIDMKICAgICAgICAgICAgKTsKICAgICAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoCiAgICAgICAgICAgICAgYml0YW5nZW50cywKICAgICAgICAgICAgICBiaXRhbmdlbnQsCiAgICAgICAgICAgICAgYXR0ckluZGV4CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgICAgIGJpdGFuZ2VudHMsCiAgICAgICAgICAgICAgYml0YW5nZW50LAogICAgICAgICAgICAgIGF0dHJJbmRleCArIDMKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgICB0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoYml0YW5nZW50LCBub3JtYWwyLCB0YW5nZW50KSwKICAgICAgICAgICAgICB0YW5nZW50CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgICAgIHRhbmdlbnRzLAogICAgICAgICAgICAgIHRhbmdlbnQsCiAgICAgICAgICAgICAgYXR0ckluZGV4T2Zmc2V0CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgICAgIHRhbmdlbnRzLAogICAgICAgICAgICAgIHRhbmdlbnQsCiAgICAgICAgICAgICAgYXR0ckluZGV4T2Zmc2V0ICsgMwogICAgICAgICAgICApOwogICAgICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZSh0YW5nZW50cywgdGFuZ2VudCwgYXR0ckluZGV4KTsKICAgICAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoCiAgICAgICAgICAgICAgdGFuZ2VudHMsCiAgICAgICAgICAgICAgdGFuZ2VudCwKICAgICAgICAgICAgICBhdHRySW5kZXggKyAzCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGF0dHJJbmRleCArPSA2OwogICAgICB9CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgbm9ybWFscy5zZXQodG9wTm9ybWFscyk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHRocmVlU2l6ZTsgaSArPSAzKSB7CiAgICAgICAgICBub3JtYWxzW2kgKyB0aHJlZVNpemVdID0gLXRvcE5vcm1hbHNbaV07CiAgICAgICAgICBub3JtYWxzW2kgKyB0aHJlZVNpemUgKyAxXSA9IC10b3BOb3JtYWxzW2kgKyAxXTsKICAgICAgICAgIG5vcm1hbHNbaSArIHRocmVlU2l6ZSArIDJdID0gLXRvcE5vcm1hbHNbaSArIDJdOwogICAgICAgIH0KICAgICAgICBhdHRyaWJ1dGVzLm5vcm1hbC52YWx1ZXMgPSBub3JtYWxzOwogICAgICB9IGVsc2UgewogICAgICAgIGF0dHJpYnV0ZXMubm9ybWFsID0gdm9pZCAwOwogICAgICB9CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgYml0YW5nZW50cy5zZXQodG9wQml0YW5nZW50cyk7CiAgICAgICAgYml0YW5nZW50cy5zZXQodG9wQml0YW5nZW50cywgdGhyZWVTaXplKTsKICAgICAgICBhdHRyaWJ1dGVzLmJpdGFuZ2VudC52YWx1ZXMgPSBiaXRhbmdlbnRzOwogICAgICB9IGVsc2UgewogICAgICAgIGF0dHJpYnV0ZXMuYml0YW5nZW50ID0gdm9pZCAwOwogICAgICB9CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgIGNvbnN0IHRvcFRhbmdlbnRzID0gYXR0cmlidXRlcy50YW5nZW50LnZhbHVlczsKICAgICAgICB0YW5nZW50cy5zZXQodG9wVGFuZ2VudHMpOwogICAgICAgIHRhbmdlbnRzLnNldCh0b3BUYW5nZW50cywgdGhyZWVTaXplKTsKICAgICAgICBhdHRyaWJ1dGVzLnRhbmdlbnQudmFsdWVzID0gdGFuZ2VudHM7CiAgICAgIH0KICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgY29uc3QgdG9wU3QgPSBhdHRyaWJ1dGVzLnN0LnZhbHVlczsKICAgICAgY29uc3Qgc3QgPSBuZXcgRmxvYXQzMkFycmF5KHR3b1NpemUgKiA2KTsKICAgICAgc3Quc2V0KHRvcFN0KTsKICAgICAgc3Quc2V0KHRvcFN0LCB0d29TaXplKTsKICAgICAgbGV0IGluZGV4ID0gdHdvU2l6ZSAqIDI7CiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgMjsgaisrKSB7CiAgICAgICAgc3RbaW5kZXgrK10gPSB0b3BTdFswXTsKICAgICAgICBzdFtpbmRleCsrXSA9IHRvcFN0WzFdOwogICAgICAgIGZvciAoaSA9IDI7IGkgPCB0d29TaXplOyBpICs9IDIpIHsKICAgICAgICAgIGNvbnN0IHMgPSB0b3BTdFtpXTsKICAgICAgICAgIGNvbnN0IHQgPSB0b3BTdFtpICsgMV07CiAgICAgICAgICBzdFtpbmRleCsrXSA9IHM7CiAgICAgICAgICBzdFtpbmRleCsrXSA9IHQ7CiAgICAgICAgICBzdFtpbmRleCsrXSA9IHM7CiAgICAgICAgICBzdFtpbmRleCsrXSA9IHQ7CiAgICAgICAgfQogICAgICAgIHN0W2luZGV4KytdID0gdG9wU3RbMF07CiAgICAgICAgc3RbaW5kZXgrK10gPSB0b3BTdFsxXTsKICAgICAgfQogICAgICBhdHRyaWJ1dGVzLnN0LnZhbHVlcyA9IHN0OwogICAgfQogICAgcmV0dXJuIGF0dHJpYnV0ZXM7CiAgfQogIGZ1bmN0aW9uIGFkZFdhbGxQb3NpdGlvbnMocG9zaXRpb25zLCBpbmRleCwgd2FsbFBvc2l0aW9ucykgewogICAgd2FsbFBvc2l0aW9uc1tpbmRleCsrXSA9IHBvc2l0aW9uc1swXTsKICAgIHdhbGxQb3NpdGlvbnNbaW5kZXgrK10gPSBwb3NpdGlvbnNbMV07CiAgICB3YWxsUG9zaXRpb25zW2luZGV4KytdID0gcG9zaXRpb25zWzJdOwogICAgZm9yIChsZXQgaSA9IDM7IGkgPCBwb3NpdGlvbnMubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgY29uc3QgeCA9IHBvc2l0aW9uc1tpXTsKICAgICAgY29uc3QgeSA9IHBvc2l0aW9uc1tpICsgMV07CiAgICAgIGNvbnN0IHogPSBwb3NpdGlvbnNbaSArIDJdOwogICAgICB3YWxsUG9zaXRpb25zW2luZGV4KytdID0geDsKICAgICAgd2FsbFBvc2l0aW9uc1tpbmRleCsrXSA9IHk7CiAgICAgIHdhbGxQb3NpdGlvbnNbaW5kZXgrK10gPSB6OwogICAgICB3YWxsUG9zaXRpb25zW2luZGV4KytdID0geDsKICAgICAgd2FsbFBvc2l0aW9uc1tpbmRleCsrXSA9IHk7CiAgICAgIHdhbGxQb3NpdGlvbnNbaW5kZXgrK10gPSB6OwogICAgfQogICAgd2FsbFBvc2l0aW9uc1tpbmRleCsrXSA9IHBvc2l0aW9uc1swXTsKICAgIHdhbGxQb3NpdGlvbnNbaW5kZXgrK10gPSBwb3NpdGlvbnNbMV07CiAgICB3YWxsUG9zaXRpb25zW2luZGV4KytdID0gcG9zaXRpb25zWzJdOwogICAgcmV0dXJuIHdhbGxQb3NpdGlvbnM7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVQb3NpdGlvbnNFeHRydWRlZChwYXJhbXMsIHZlcnRleEZvcm1hdCkgewogICAgY29uc3QgdG9wVmVydGV4Rm9ybWF0ID0gbmV3IFZlcnRleEZvcm1hdF9kZWZhdWx0KHsKICAgICAgcG9zaXRpb246IHZlcnRleEZvcm1hdC5wb3NpdGlvbiwKICAgICAgbm9ybWFsOiB2ZXJ0ZXhGb3JtYXQubm9ybWFsIHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgfHwgcGFyYW1zLnNoYWRvd1ZvbHVtZSwKICAgICAgdGFuZ2VudDogdmVydGV4Rm9ybWF0LnRhbmdlbnQsCiAgICAgIGJpdGFuZ2VudDogdmVydGV4Rm9ybWF0Lm5vcm1hbCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50LAogICAgICBzdDogdmVydGV4Rm9ybWF0LnN0CiAgICB9KTsKICAgIGNvbnN0IGVsbGlwc29pZCA9IHBhcmFtcy5lbGxpcHNvaWQ7CiAgICBjb25zdCBjb21wdXRlZFBvc2l0aW9ucyA9IENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9ucyhwYXJhbXMpOwogICAgY29uc3QgYXR0ciA9IGNvbWJpbmUyKGNvbXB1dGVkUG9zaXRpb25zLCB0b3BWZXJ0ZXhGb3JtYXQsIGVsbGlwc29pZCk7CiAgICBjb25zdCBoZWlnaHQgPSBwYXJhbXMuaGVpZ2h0OwogICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBwYXJhbXMuZXh0cnVkZWRIZWlnaHQ7CiAgICBsZXQgYXR0cmlidXRlcyA9IGF0dHIuYXR0cmlidXRlczsKICAgIGNvbnN0IGluZGljZXMgPSBhdHRyLmluZGljZXM7CiAgICBsZXQgcG9zaXRpb25zID0gYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXM7CiAgICBsZXQgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgIGNvbnN0IG5ld1Bvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkobGVuZ3RoICogNik7CiAgICBsZXQgZXh0cnVkZWRQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KGxlbmd0aCk7CiAgICBleHRydWRlZFBvc2l0aW9ucy5zZXQocG9zaXRpb25zKTsKICAgIGxldCB3YWxsUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShsZW5ndGggKiA0KTsKICAgIHBvc2l0aW9ucyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodCgKICAgICAgcG9zaXRpb25zLAogICAgICBoZWlnaHQsCiAgICAgIGVsbGlwc29pZAogICAgKTsKICAgIHdhbGxQb3NpdGlvbnMgPSBhZGRXYWxsUG9zaXRpb25zKHBvc2l0aW9ucywgMCwgd2FsbFBvc2l0aW9ucyk7CiAgICBleHRydWRlZFBvc2l0aW9ucyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodCgKICAgICAgZXh0cnVkZWRQb3NpdGlvbnMsCiAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICBlbGxpcHNvaWQKICAgICk7CiAgICB3YWxsUG9zaXRpb25zID0gYWRkV2FsbFBvc2l0aW9ucygKICAgICAgZXh0cnVkZWRQb3NpdGlvbnMsCiAgICAgIGxlbmd0aCAqIDIsCiAgICAgIHdhbGxQb3NpdGlvbnMKICAgICk7CiAgICBuZXdQb3NpdGlvbnMuc2V0KHBvc2l0aW9ucyk7CiAgICBuZXdQb3NpdGlvbnMuc2V0KGV4dHJ1ZGVkUG9zaXRpb25zLCBsZW5ndGgpOwogICAgbmV3UG9zaXRpb25zLnNldCh3YWxsUG9zaXRpb25zLCBsZW5ndGggKiAyKTsKICAgIGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzID0gbmV3UG9zaXRpb25zOwogICAgYXR0cmlidXRlcyA9IGV4dHJ1ZGVkQXR0cmlidXRlcyhhdHRyaWJ1dGVzLCB2ZXJ0ZXhGb3JtYXQpOwogICAgbGV0IGk7CiAgICBjb25zdCBzaXplID0gbGVuZ3RoIC8gMzsKICAgIGlmIChwYXJhbXMuc2hhZG93Vm9sdW1lKSB7CiAgICAgIGNvbnN0IHRvcE5vcm1hbHMgPSBhdHRyaWJ1dGVzLm5vcm1hbC52YWx1ZXM7CiAgICAgIGxlbmd0aCA9IHRvcE5vcm1hbHMubGVuZ3RoOwogICAgICBsZXQgZXh0cnVkZU5vcm1hbHMgPSBuZXcgRmxvYXQzMkFycmF5KGxlbmd0aCAqIDYpOwogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICB0b3BOb3JtYWxzW2ldID0gLXRvcE5vcm1hbHNbaV07CiAgICAgIH0KICAgICAgZXh0cnVkZU5vcm1hbHMuc2V0KHRvcE5vcm1hbHMsIGxlbmd0aCk7CiAgICAgIGV4dHJ1ZGVOb3JtYWxzID0gYWRkV2FsbFBvc2l0aW9ucyh0b3BOb3JtYWxzLCBsZW5ndGggKiA0LCBleHRydWRlTm9ybWFscyk7CiAgICAgIGF0dHJpYnV0ZXMuZXh0cnVkZURpcmVjdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogZXh0cnVkZU5vcm1hbHMKICAgICAgfSk7CiAgICAgIGlmICghdmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgIGF0dHJpYnV0ZXMubm9ybWFsID0gdm9pZCAwOwogICAgICB9CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHBhcmFtcy5vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgIGxldCBhcHBseU9mZnNldCA9IG5ldyBVaW50OEFycmF5KHNpemUgKiA2KTsKICAgICAgaWYgKHBhcmFtcy5vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuVE9QKSB7CiAgICAgICAgYXBwbHlPZmZzZXQgPSBhcHBseU9mZnNldC5maWxsKDEsIDAsIHNpemUpLmZpbGwoMSwgc2l6ZSAqIDIsIHNpemUgKiA0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBhcHBseU9mZnNldFZhbHVlID0gcGFyYW1zLm9mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5OT05FID8gMCA6IDE7CiAgICAgICAgYXBwbHlPZmZzZXQgPSBhcHBseU9mZnNldC5maWxsKGFwcGx5T2Zmc2V0VmFsdWUpOwogICAgICB9CiAgICAgIGF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgIHZhbHVlczogYXBwbHlPZmZzZXQKICAgICAgfSk7CiAgICB9CiAgICBjb25zdCBpTGVuZ3RoID0gaW5kaWNlcy5sZW5ndGg7CiAgICBjb25zdCB0d29TaXplID0gc2l6ZSArIHNpemU7CiAgICBjb25zdCBuZXdJbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIG5ld1Bvc2l0aW9ucy5sZW5ndGggLyAzLAogICAgICBpTGVuZ3RoICogMiArIHR3b1NpemUgKiAzCiAgICApOwogICAgbmV3SW5kaWNlcy5zZXQoaW5kaWNlcyk7CiAgICBsZXQgaW5kZXggPSBpTGVuZ3RoOwogICAgZm9yIChpID0gMDsgaSA8IGlMZW5ndGg7IGkgKz0gMykgewogICAgICBjb25zdCB2MDIgPSBpbmRpY2VzW2ldOwogICAgICBjb25zdCB2MTIgPSBpbmRpY2VzW2kgKyAxXTsKICAgICAgY29uc3QgdjIyID0gaW5kaWNlc1tpICsgMl07CiAgICAgIG5ld0luZGljZXNbaW5kZXgrK10gPSB2MjIgKyBzaXplOwogICAgICBuZXdJbmRpY2VzW2luZGV4KytdID0gdjEyICsgc2l6ZTsKICAgICAgbmV3SW5kaWNlc1tpbmRleCsrXSA9IHYwMiArIHNpemU7CiAgICB9CiAgICBsZXQgVUwsIExMLCBVUiwgTFI7CiAgICBmb3IgKGkgPSAwOyBpIDwgdHdvU2l6ZTsgaSArPSAyKSB7CiAgICAgIFVMID0gaSArIHR3b1NpemU7CiAgICAgIExMID0gVUwgKyB0d29TaXplOwogICAgICBVUiA9IFVMICsgMTsKICAgICAgTFIgPSBMTCArIDE7CiAgICAgIG5ld0luZGljZXNbaW5kZXgrK10gPSBVTDsKICAgICAgbmV3SW5kaWNlc1tpbmRleCsrXSA9IExMOwogICAgICBuZXdJbmRpY2VzW2luZGV4KytdID0gVVI7CiAgICAgIG5ld0luZGljZXNbaW5kZXgrK10gPSBVUjsKICAgICAgbmV3SW5kaWNlc1tpbmRleCsrXSA9IExMOwogICAgICBuZXdJbmRpY2VzW2luZGV4KytdID0gTFI7CiAgICB9CiAgICByZXR1cm4gewogICAgICBhdHRyaWJ1dGVzLAogICAgICBpbmRpY2VzOiBuZXdJbmRpY2VzCiAgICB9OwogIH0KICBmdW5jdGlvbiBjb21wdXRlT2Zmc2V0UG9pbnRzKHBvc2l0aW9uMSwgcG9zaXRpb24yLCBlbGxpcHNvaWQsIGhhbGZXaWR0aCwgbWluMywgbWF4MykgewogICAgY29uc3QgZGlyZWN0aW9uMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgcG9zaXRpb24yLAogICAgICBwb3NpdGlvbjEsCiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xNwogICAgKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZGlyZWN0aW9uMiwgZGlyZWN0aW9uMik7CiAgICBjb25zdCBub3JtYWwyID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbjEsIHNjcmF0Y2hDYXJ0ZXNpYW4yNyk7CiAgICBjb25zdCBvZmZzZXREaXJlY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoCiAgICAgIGRpcmVjdGlvbjIsCiAgICAgIG5vcm1hbDIsCiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xNwogICAgKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG9mZnNldERpcmVjdGlvbiwgaGFsZldpZHRoLCBvZmZzZXREaXJlY3Rpb24pOwogICAgbGV0IG1pbkxhdCA9IG1pbjMubGF0aXR1ZGU7CiAgICBsZXQgbWluTG9uID0gbWluMy5sb25naXR1ZGU7CiAgICBsZXQgbWF4TGF0ID0gbWF4My5sYXRpdHVkZTsKICAgIGxldCBtYXhMb24gPSBtYXgzLmxvbmdpdHVkZTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24xLCBvZmZzZXREaXJlY3Rpb24sIHNjcmF0Y2hDYXJ0ZXNpYW4yNyk7CiAgICBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoc2NyYXRjaENhcnRlc2lhbjI3LCBzY3JhdGNoQ2FydG9ncmFwaGljNCk7CiAgICBsZXQgbGF0ID0gc2NyYXRjaENhcnRvZ3JhcGhpYzQubGF0aXR1ZGU7CiAgICBsZXQgbG9uID0gc2NyYXRjaENhcnRvZ3JhcGhpYzQubG9uZ2l0dWRlOwogICAgbWluTGF0ID0gTWF0aC5taW4obWluTGF0LCBsYXQpOwogICAgbWluTG9uID0gTWF0aC5taW4obWluTG9uLCBsb24pOwogICAgbWF4TGF0ID0gTWF0aC5tYXgobWF4TGF0LCBsYXQpOwogICAgbWF4TG9uID0gTWF0aC5tYXgobWF4TG9uLCBsb24pOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHBvc2l0aW9uMSwgb2Zmc2V0RGlyZWN0aW9uLCBzY3JhdGNoQ2FydGVzaWFuMjcpOwogICAgZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHNjcmF0Y2hDYXJ0ZXNpYW4yNywgc2NyYXRjaENhcnRvZ3JhcGhpYzQpOwogICAgbGF0ID0gc2NyYXRjaENhcnRvZ3JhcGhpYzQubGF0aXR1ZGU7CiAgICBsb24gPSBzY3JhdGNoQ2FydG9ncmFwaGljNC5sb25naXR1ZGU7CiAgICBtaW5MYXQgPSBNYXRoLm1pbihtaW5MYXQsIGxhdCk7CiAgICBtaW5Mb24gPSBNYXRoLm1pbihtaW5Mb24sIGxvbik7CiAgICBtYXhMYXQgPSBNYXRoLm1heChtYXhMYXQsIGxhdCk7CiAgICBtYXhMb24gPSBNYXRoLm1heChtYXhMb24sIGxvbik7CiAgICBtaW4zLmxhdGl0dWRlID0gbWluTGF0OwogICAgbWluMy5sb25naXR1ZGUgPSBtaW5Mb247CiAgICBtYXgzLmxhdGl0dWRlID0gbWF4TGF0OwogICAgbWF4My5sb25naXR1ZGUgPSBtYXhMb247CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVSZWN0YW5nbGUyKHBvc2l0aW9ucywgZWxsaXBzb2lkLCB3aWR0aCwgY29ybmVyVHlwZSwgcmVzdWx0KSB7CiAgICBwb3NpdGlvbnMgPSBzY2FsZVRvU3VyZmFjZTIocG9zaXRpb25zLCBlbGxpcHNvaWQpOwogICAgY29uc3QgY2xlYW5Qb3NpdGlvbnMgPSBhcnJheVJlbW92ZUR1cGxpY2F0ZXNfZGVmYXVsdCgKICAgICAgcG9zaXRpb25zLAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbgogICAgKTsKICAgIGNvbnN0IGxlbmd0aCA9IGNsZWFuUG9zaXRpb25zLmxlbmd0aDsKICAgIGlmIChsZW5ndGggPCAyIHx8IHdpZHRoIDw9IDApIHsKICAgICAgcmV0dXJuIG5ldyBSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgfQogICAgY29uc3QgaGFsZldpZHRoID0gd2lkdGggKiAwLjU7CiAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWluLmxhdGl0dWRlID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgc2NyYXRjaENhcnRvZ3JhcGhpY01pbi5sb25naXR1ZGUgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWF4LmxhdGl0dWRlID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgc2NyYXRjaENhcnRvZ3JhcGhpY01heC5sb25naXR1ZGUgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICBsZXQgbGF0LCBsb247CiAgICBpZiAoY29ybmVyVHlwZSA9PT0gQ29ybmVyVHlwZV9kZWZhdWx0LlJPVU5ERUQpIHsKICAgICAgY29uc3QgZmlyc3QgPSBjbGVhblBvc2l0aW9uc1swXTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGZpcnN0LCBjbGVhblBvc2l0aW9uc1sxXSwgc2NyYXRjaENhcnRlc2lhbk9mZnNldCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoc2NyYXRjaENhcnRlc2lhbk9mZnNldCwgc2NyYXRjaENhcnRlc2lhbk9mZnNldCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW5PZmZzZXQsCiAgICAgICAgaGFsZldpZHRoLAogICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW5PZmZzZXQKICAgICAgKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChmaXJzdCwgc2NyYXRjaENhcnRlc2lhbk9mZnNldCwgc2NyYXRjaENhcnRlc2lhbkVuZHMpOwogICAgICBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgc2NyYXRjaENhcnRlc2lhbkVuZHMsCiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzQKICAgICAgKTsKICAgICAgbGF0ID0gc2NyYXRjaENhcnRvZ3JhcGhpYzQubGF0aXR1ZGU7CiAgICAgIGxvbiA9IHNjcmF0Y2hDYXJ0b2dyYXBoaWM0LmxvbmdpdHVkZTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01pbi5sYXRpdHVkZSA9IE1hdGgubWluKAogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNaW4ubGF0aXR1ZGUsCiAgICAgICAgbGF0CiAgICAgICk7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNaW4ubG9uZ2l0dWRlID0gTWF0aC5taW4oCiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01pbi5sb25naXR1ZGUsCiAgICAgICAgbG9uCiAgICAgICk7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNYXgubGF0aXR1ZGUgPSBNYXRoLm1heCgKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWF4LmxhdGl0dWRlLAogICAgICAgIGxhdAogICAgICApOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWF4LmxvbmdpdHVkZSA9IE1hdGgubWF4KAogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNYXgubG9uZ2l0dWRlLAogICAgICAgIGxvbgogICAgICApOwogICAgfQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGggLSAxOyArK2kpIHsKICAgICAgY29tcHV0ZU9mZnNldFBvaW50cygKICAgICAgICBjbGVhblBvc2l0aW9uc1tpXSwKICAgICAgICBjbGVhblBvc2l0aW9uc1tpICsgMV0sCiAgICAgICAgZWxsaXBzb2lkLAogICAgICAgIGhhbGZXaWR0aCwKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWluLAogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNYXgKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGxhc3QgPSBjbGVhblBvc2l0aW9uc1tsZW5ndGggLSAxXTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChsYXN0LCBjbGVhblBvc2l0aW9uc1tsZW5ndGggLSAyXSwgc2NyYXRjaENhcnRlc2lhbk9mZnNldCk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHNjcmF0Y2hDYXJ0ZXNpYW5PZmZzZXQsIHNjcmF0Y2hDYXJ0ZXNpYW5PZmZzZXQpOwogICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW5PZmZzZXQsCiAgICAgIGhhbGZXaWR0aCwKICAgICAgc2NyYXRjaENhcnRlc2lhbk9mZnNldAogICAgKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQobGFzdCwgc2NyYXRjaENhcnRlc2lhbk9mZnNldCwgc2NyYXRjaENhcnRlc2lhbkVuZHMpOwogICAgY29tcHV0ZU9mZnNldFBvaW50cygKICAgICAgbGFzdCwKICAgICAgc2NyYXRjaENhcnRlc2lhbkVuZHMsCiAgICAgIGVsbGlwc29pZCwKICAgICAgaGFsZldpZHRoLAogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWluLAogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWF4CiAgICApOwogICAgaWYgKGNvcm5lclR5cGUgPT09IENvcm5lclR5cGVfZGVmYXVsdC5ST1VOREVEKSB7CiAgICAgIGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgICBzY3JhdGNoQ2FydGVzaWFuRW5kcywKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNAogICAgICApOwogICAgICBsYXQgPSBzY3JhdGNoQ2FydG9ncmFwaGljNC5sYXRpdHVkZTsKICAgICAgbG9uID0gc2NyYXRjaENhcnRvZ3JhcGhpYzQubG9uZ2l0dWRlOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWluLmxhdGl0dWRlID0gTWF0aC5taW4oCiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01pbi5sYXRpdHVkZSwKICAgICAgICBsYXQKICAgICAgKTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01pbi5sb25naXR1ZGUgPSBNYXRoLm1pbigKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWluLmxvbmdpdHVkZSwKICAgICAgICBsb24KICAgICAgKTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01heC5sYXRpdHVkZSA9IE1hdGgubWF4KAogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNYXgubGF0aXR1ZGUsCiAgICAgICAgbGF0CiAgICAgICk7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNYXgubG9uZ2l0dWRlID0gTWF0aC5tYXgoCiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01heC5sb25naXR1ZGUsCiAgICAgICAgbG9uCiAgICAgICk7CiAgICB9CiAgICBjb25zdCByZWN0YW5nbGUgPSBkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSA/IHJlc3VsdCA6IG5ldyBSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgcmVjdGFuZ2xlLm5vcnRoID0gc2NyYXRjaENhcnRvZ3JhcGhpY01heC5sYXRpdHVkZTsKICAgIHJlY3RhbmdsZS5zb3V0aCA9IHNjcmF0Y2hDYXJ0b2dyYXBoaWNNaW4ubGF0aXR1ZGU7CiAgICByZWN0YW5nbGUuZWFzdCA9IHNjcmF0Y2hDYXJ0b2dyYXBoaWNNYXgubG9uZ2l0dWRlOwogICAgcmVjdGFuZ2xlLndlc3QgPSBzY3JhdGNoQ2FydG9ncmFwaGljTWluLmxvbmdpdHVkZTsKICAgIHJldHVybiByZWN0YW5nbGU7CiAgfQogIGZ1bmN0aW9uIENvcnJpZG9yR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBvcHRpb25zLnBvc2l0aW9uczsKICAgIGNvbnN0IHdpZHRoID0gb3B0aW9ucy53aWR0aDsKICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib3B0aW9ucy5wb3NpdGlvbnMiLCBwb3NpdGlvbnMpOwogICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvcHRpb25zLndpZHRoIiwgd2lkdGgpOwogICAgY29uc3QgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5oZWlnaHQsIDApOwogICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmV4dHJ1ZGVkSGVpZ2h0LCBoZWlnaHQpOwogICAgdGhpcy5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgdGhpcy5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoCiAgICAgIGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCkKICAgICk7CiAgICB0aGlzLl92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSgKICAgICAgZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy52ZXJ0ZXhGb3JtYXQsIFZlcnRleEZvcm1hdF9kZWZhdWx0LkRFRkFVTFQpCiAgICApOwogICAgdGhpcy5fd2lkdGggPSB3aWR0aDsKICAgIHRoaXMuX2hlaWdodCA9IE1hdGgubWF4KGhlaWdodCwgZXh0cnVkZWRIZWlnaHQpOwogICAgdGhpcy5fZXh0cnVkZWRIZWlnaHQgPSBNYXRoLm1pbihoZWlnaHQsIGV4dHJ1ZGVkSGVpZ2h0KTsKICAgIHRoaXMuX2Nvcm5lclR5cGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmNvcm5lclR5cGUsIENvcm5lclR5cGVfZGVmYXVsdC5ST1VOREVEKTsKICAgIHRoaXMuX2dyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICk7CiAgICB0aGlzLl9zaGFkb3dWb2x1bWUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnNoYWRvd1ZvbHVtZSwgZmFsc2UpOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVDb3JyaWRvckdlb21ldHJ5IjsKICAgIHRoaXMuX29mZnNldEF0dHJpYnV0ZSA9IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlOwogICAgdGhpcy5fcmVjdGFuZ2xlID0gdm9pZCAwOwogICAgdGhpcy5wYWNrZWRMZW5ndGggPSAxICsgcG9zaXRpb25zLmxlbmd0aCAqIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyA3OwogIH0KICB2YXIgY2FydGVzaWFuMTIsIGNhcnRlc2lhbjIyLCBjYXJ0ZXNpYW4zMiwgY2FydGVzaWFuNDIsIGNhcnRlc2lhbjUyLCBjYXJ0ZXNpYW42Miwgc2NyYXRjaDEzLCBzY3JhdGNoMjMsIHNjcmF0Y2hDYXJ0ZXNpYW4xNywgc2NyYXRjaENhcnRlc2lhbjI3LCBzY3JhdGNoQ2FydG9ncmFwaGljNCwgc2NyYXRjaENhcnRlc2lhbk9mZnNldCwgc2NyYXRjaENhcnRlc2lhbkVuZHMsIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNaW4sIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNYXgsIHNjcmF0Y2hFbGxpcHNvaWQ0LCBzY3JhdGNoVmVydGV4Rm9ybWF0NCwgc2NyYXRjaE9wdGlvbnM5LCBDb3JyaWRvckdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfQ29ycmlkb3JHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29ycmlkb3JHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfYXJyYXlSZW1vdmVEdXBsaWNhdGVzKCk7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X0Nvcm5lclR5cGUoKTsKICAgICAgaW5pdF9Db3JyaWRvckdlb21ldHJ5TGlicmFyeSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1BvbHlnb25QaXBlbGluZSgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgY2FydGVzaWFuMTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjIyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4zMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuNDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjUyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW42MiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaDEzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoMjMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xNyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjI3ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuT2Zmc2V0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuRW5kcyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01pbiA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWF4ID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIENvcnJpZG9yR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gdmFsdWUuX3Bvc2l0aW9uczsKICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBsZW5ndGg7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhwb3NpdGlvbnNbaV0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgRWxsaXBzb2lkX2RlZmF1bHQucGFjayh2YWx1ZS5fZWxsaXBzb2lkLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFjayh2YWx1ZS5fdmVydGV4Rm9ybWF0LCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl93aWR0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2hlaWdodDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fY29ybmVyVHlwZTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2dyYW51bGFyaXR5OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc2hhZG93Vm9sdW1lID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh2YWx1ZS5fb2Zmc2V0QXR0cmlidXRlLCAtMSk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoRWxsaXBzb2lkNCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKEVsbGlwc29pZF9kZWZhdWx0LlVOSVRfU1BIRVJFKTsKICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDQgPSBuZXcgVmVydGV4Rm9ybWF0X2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE9wdGlvbnM5ID0gewogICAgICAgIHBvc2l0aW9uczogdm9pZCAwLAogICAgICAgIGVsbGlwc29pZDogc2NyYXRjaEVsbGlwc29pZDQsCiAgICAgICAgdmVydGV4Rm9ybWF0OiBzY3JhdGNoVmVydGV4Rm9ybWF0NCwKICAgICAgICB3aWR0aDogdm9pZCAwLAogICAgICAgIGhlaWdodDogdm9pZCAwLAogICAgICAgIGV4dHJ1ZGVkSGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgY29ybmVyVHlwZTogdm9pZCAwLAogICAgICAgIGdyYW51bGFyaXR5OiB2b2lkIDAsCiAgICAgICAgc2hhZG93Vm9sdW1lOiB2b2lkIDAsCiAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiB2b2lkIDAKICAgICAgfTsKICAgICAgQ29ycmlkb3JHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIHBvc2l0aW9uc1tpXSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hFbGxpcHNvaWQ0KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0NAogICAgICAgICk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3Qgd2lkdGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGhlaWdodCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGNvcm5lclR5cGUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzaGFkb3dWb2x1bWUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIGNvbnN0IG9mZnNldEF0dHJpYnV0ZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zOS5wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczkud2lkdGggPSB3aWR0aDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zOS5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczkuZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zOS5jb3JuZXJUeXBlID0gY29ybmVyVHlwZTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zOS5ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnM5LnNoYWRvd1ZvbHVtZSA9IHNoYWRvd1ZvbHVtZTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zOS5vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgICAgcmV0dXJuIG5ldyBDb3JyaWRvckdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zOSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgICAgIHJlc3VsdC5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkLCByZXN1bHQuX2VsbGlwc29pZCk7CiAgICAgICAgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSh2ZXJ0ZXhGb3JtYXQsIHJlc3VsdC5fdmVydGV4Rm9ybWF0KTsKICAgICAgICByZXN1bHQuX3dpZHRoID0gd2lkdGg7CiAgICAgICAgcmVzdWx0Ll9oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgcmVzdWx0Ll9leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIHJlc3VsdC5fY29ybmVyVHlwZSA9IGNvcm5lclR5cGU7CiAgICAgICAgcmVzdWx0Ll9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgIHJlc3VsdC5fc2hhZG93Vm9sdW1lID0gc2hhZG93Vm9sdW1lOwogICAgICAgIHJlc3VsdC5fb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb3JyaWRvckdlb21ldHJ5LmNvbXB1dGVSZWN0YW5nbGUgPSBmdW5jdGlvbihvcHRpb25zLCByZXN1bHQpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBvcHRpb25zLnBvc2l0aW9uczsKICAgICAgICBjb25zdCB3aWR0aCA9IG9wdGlvbnMud2lkdGg7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvcHRpb25zLnBvc2l0aW9ucyIsIHBvc2l0aW9ucyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvcHRpb25zLndpZHRoIiwgd2lkdGgpOwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICAgICAgY29uc3QgY29ybmVyVHlwZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuY29ybmVyVHlwZSwgQ29ybmVyVHlwZV9kZWZhdWx0LlJPVU5ERUQpOwogICAgICAgIHJldHVybiBjb21wdXRlUmVjdGFuZ2xlMihwb3NpdGlvbnMsIGVsbGlwc29pZCwgd2lkdGgsIGNvcm5lclR5cGUsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIENvcnJpZG9yR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihjb3JyaWRvckdlb21ldHJ5KSB7CiAgICAgICAgbGV0IHBvc2l0aW9ucyA9IGNvcnJpZG9yR2VvbWV0cnkuX3Bvc2l0aW9uczsKICAgICAgICBjb25zdCB3aWR0aCA9IGNvcnJpZG9yR2VvbWV0cnkuX3dpZHRoOwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IGNvcnJpZG9yR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgICAgICBwb3NpdGlvbnMgPSBzY2FsZVRvU3VyZmFjZTIocG9zaXRpb25zLCBlbGxpcHNvaWQpOwogICAgICAgIGNvbnN0IGNsZWFuUG9zaXRpb25zID0gYXJyYXlSZW1vdmVEdXBsaWNhdGVzX2RlZmF1bHQoCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbgogICAgICAgICk7CiAgICAgICAgaWYgKGNsZWFuUG9zaXRpb25zLmxlbmd0aCA8IDIgfHwgd2lkdGggPD0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBoZWlnaHQgPSBjb3JyaWRvckdlb21ldHJ5Ll9oZWlnaHQ7CiAgICAgICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBjb3JyaWRvckdlb21ldHJ5Ll9leHRydWRlZEhlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlID0gIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgZXh0cnVkZWRIZWlnaHQsCiAgICAgICAgICAwLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04yCiAgICAgICAgKTsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBjb3JyaWRvckdlb21ldHJ5Ll92ZXJ0ZXhGb3JtYXQ7CiAgICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgcG9zaXRpb25zOiBjbGVhblBvc2l0aW9ucywKICAgICAgICAgIHdpZHRoLAogICAgICAgICAgY29ybmVyVHlwZTogY29ycmlkb3JHZW9tZXRyeS5fY29ybmVyVHlwZSwKICAgICAgICAgIGdyYW51bGFyaXR5OiBjb3JyaWRvckdlb21ldHJ5Ll9ncmFudWxhcml0eSwKICAgICAgICAgIHNhdmVBdHRyaWJ1dGVzOiB0cnVlCiAgICAgICAgfTsKICAgICAgICBsZXQgYXR0cjsKICAgICAgICBpZiAoZXh0cnVkZSkgewogICAgICAgICAgcGFyYW1zLmhlaWdodCA9IGhlaWdodDsKICAgICAgICAgIHBhcmFtcy5leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgICAgcGFyYW1zLnNoYWRvd1ZvbHVtZSA9IGNvcnJpZG9yR2VvbWV0cnkuX3NoYWRvd1ZvbHVtZTsKICAgICAgICAgIHBhcmFtcy5vZmZzZXRBdHRyaWJ1dGUgPSBjb3JyaWRvckdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgICBhdHRyID0gY29tcHV0ZVBvc2l0aW9uc0V4dHJ1ZGVkKHBhcmFtcywgdmVydGV4Rm9ybWF0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3QgY29tcHV0ZWRQb3NpdGlvbnMgPSBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbnMocGFyYW1zKTsKICAgICAgICAgIGF0dHIgPSBjb21iaW5lMihjb21wdXRlZFBvc2l0aW9ucywgdmVydGV4Rm9ybWF0LCBlbGxpcHNvaWQpOwogICAgICAgICAgYXR0ci5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodCgKICAgICAgICAgICAgYXR0ci5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgICBlbGxpcHNvaWQKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGNvcnJpZG9yR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgICAgY29uc3QgYXBwbHlPZmZzZXRWYWx1ZSA9IGNvcnJpZG9yR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5OT05FID8gMCA6IDE7CiAgICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IGF0dHIuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoOwogICAgICAgICAgICBjb25zdCBhcHBseU9mZnNldCA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCAvIDMpLmZpbGwoYXBwbHlPZmZzZXRWYWx1ZSk7CiAgICAgICAgICAgIGF0dHIuYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IGF0dHIuYXR0cmlidXRlczsKICAgICAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVZlcnRpY2VzKAogICAgICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMsCiAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICAzCiAgICAgICAgKTsKICAgICAgICBpZiAoIXZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICAgICAgYXR0ci5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyA9IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzOiBhdHRyLmluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmUsCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IGNvcnJpZG9yR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBDb3JyaWRvckdlb21ldHJ5LmNyZWF0ZVNoYWRvd1ZvbHVtZSA9IGZ1bmN0aW9uKGNvcnJpZG9yR2VvbWV0cnksIG1pbkhlaWdodEZ1bmMsIG1heEhlaWdodEZ1bmMpIHsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGNvcnJpZG9yR2VvbWV0cnkuX2dyYW51bGFyaXR5OwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IGNvcnJpZG9yR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgICAgICBjb25zdCBtaW5IZWlnaHQgPSBtaW5IZWlnaHRGdW5jKGdyYW51bGFyaXR5LCBlbGxpcHNvaWQpOwogICAgICAgIGNvbnN0IG1heEhlaWdodCA9IG1heEhlaWdodEZ1bmMoZ3JhbnVsYXJpdHksIGVsbGlwc29pZCk7CiAgICAgICAgcmV0dXJuIG5ldyBDb3JyaWRvckdlb21ldHJ5KHsKICAgICAgICAgIHBvc2l0aW9uczogY29ycmlkb3JHZW9tZXRyeS5fcG9zaXRpb25zLAogICAgICAgICAgd2lkdGg6IGNvcnJpZG9yR2VvbWV0cnkuX3dpZHRoLAogICAgICAgICAgY29ybmVyVHlwZTogY29ycmlkb3JHZW9tZXRyeS5fY29ybmVyVHlwZSwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgZXh0cnVkZWRIZWlnaHQ6IG1pbkhlaWdodCwKICAgICAgICAgIGhlaWdodDogbWF4SGVpZ2h0LAogICAgICAgICAgdmVydGV4Rm9ybWF0OiBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5QT1NJVElPTl9PTkxZLAogICAgICAgICAgc2hhZG93Vm9sdW1lOiB0cnVlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKENvcnJpZG9yR2VvbWV0cnkucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICByZWN0YW5nbGU6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHRoaXMuX3JlY3RhbmdsZSkpIHsKICAgICAgICAgICAgICB0aGlzLl9yZWN0YW5nbGUgPSBjb21wdXRlUmVjdGFuZ2xlMigKICAgICAgICAgICAgICAgIHRoaXMuX3Bvc2l0aW9ucywKICAgICAgICAgICAgICAgIHRoaXMuX2VsbGlwc29pZCwKICAgICAgICAgICAgICAgIHRoaXMuX3dpZHRoLAogICAgICAgICAgICAgICAgdGhpcy5fY29ybmVyVHlwZQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JlY3RhbmdsZTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEZvciByZW1hcHBpbmcgdGV4dHVyZSBjb29yZGluYXRlcyB3aGVuIHJlbmRlcmluZyBDb3JyaWRvckdlb21ldHJpZXMgYXMgR3JvdW5kUHJpbWl0aXZlcy4KICAgICAgICAgKgogICAgICAgICAqIENvcnJpZG9ycyBkb24ndCBzdXBwb3J0IHN0Um90YXRpb24sCiAgICAgICAgICogc28ganVzdCByZXR1cm4gdGhlIGNvcm5lcnMgb2YgdGhlIG9yaWdpbmFsIHN5c3RlbS4KICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHRleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHM6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBbMCwgMCwgMCwgMSwgMSwgMF07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgQ29ycmlkb3JHZW9tZXRyeV9kZWZhdWx0ID0gQ29ycmlkb3JHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUNvcnJpZG9yR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlQ29ycmlkb3JHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlQ29ycmlkb3JHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVDb3JyaWRvckdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVDb3JyaWRvckdlb21ldHJ5KGNvcnJpZG9yR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIGNvcnJpZG9yR2VvbWV0cnkgPSBDb3JyaWRvckdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKGNvcnJpZG9yR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICBjb3JyaWRvckdlb21ldHJ5Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShjb3JyaWRvckdlb21ldHJ5Ll9lbGxpcHNvaWQpOwogICAgcmV0dXJuIENvcnJpZG9yR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShjb3JyaWRvckdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZUNvcnJpZG9yR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVDb3JyaWRvckdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVDb3JyaWRvckdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Db3JyaWRvckdlb21ldHJ5KCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBjcmVhdGVDb3JyaWRvckdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVDb3JyaWRvckdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBzY2FsZVRvU3VyZmFjZTMocG9zaXRpb25zLCBlbGxpcHNvaWQpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgIHBvc2l0aW9uc1tpXSA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKHBvc2l0aW9uc1tpXSwgcG9zaXRpb25zW2ldKTsKICAgIH0KICAgIHJldHVybiBwb3NpdGlvbnM7CiAgfQogIGZ1bmN0aW9uIGNvbWJpbmUzKGNvbXB1dGVkUG9zaXRpb25zLCBjb3JuZXJUeXBlKSB7CiAgICBjb25zdCB3YWxsSW5kaWNlcyA9IFtdOwogICAgY29uc3QgcG9zaXRpb25zID0gY29tcHV0ZWRQb3NpdGlvbnMucG9zaXRpb25zOwogICAgY29uc3QgY29ybmVycyA9IGNvbXB1dGVkUG9zaXRpb25zLmNvcm5lcnM7CiAgICBjb25zdCBlbmRQb3NpdGlvbnMgPSBjb21wdXRlZFBvc2l0aW9ucy5lbmRQb3NpdGlvbnM7CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICBsZXQgY29ybmVyOwogICAgbGV0IGxlZnRDb3VudCA9IDA7CiAgICBsZXQgcmlnaHRDb3VudCA9IDA7CiAgICBsZXQgaTsKICAgIGxldCBpbmRpY2VzTGVuZ3RoID0gMDsKICAgIGxldCBsZW5ndGg7CiAgICBmb3IgKGkgPSAwOyBpIDwgcG9zaXRpb25zLmxlbmd0aDsgaSArPSAyKSB7CiAgICAgIGxlbmd0aCA9IHBvc2l0aW9uc1tpXS5sZW5ndGggLSAzOwogICAgICBsZWZ0Q291bnQgKz0gbGVuZ3RoOwogICAgICBpbmRpY2VzTGVuZ3RoICs9IGxlbmd0aCAvIDMgKiA0OwogICAgICByaWdodENvdW50ICs9IHBvc2l0aW9uc1tpICsgMV0ubGVuZ3RoIC0gMzsKICAgIH0KICAgIGxlZnRDb3VudCArPSAzOwogICAgcmlnaHRDb3VudCArPSAzOwogICAgZm9yIChpID0gMDsgaSA8IGNvcm5lcnMubGVuZ3RoOyBpKyspIHsKICAgICAgY29ybmVyID0gY29ybmVyc1tpXTsKICAgICAgY29uc3QgbGVmdFNpZGUgPSBjb3JuZXJzW2ldLmxlZnRQb3NpdGlvbnM7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobGVmdFNpZGUpKSB7CiAgICAgICAgbGVuZ3RoID0gbGVmdFNpZGUubGVuZ3RoOwogICAgICAgIGxlZnRDb3VudCArPSBsZW5ndGg7CiAgICAgICAgaW5kaWNlc0xlbmd0aCArPSBsZW5ndGggLyAzICogMjsKICAgICAgfSBlbHNlIHsKICAgICAgICBsZW5ndGggPSBjb3JuZXJzW2ldLnJpZ2h0UG9zaXRpb25zLmxlbmd0aDsKICAgICAgICByaWdodENvdW50ICs9IGxlbmd0aDsKICAgICAgICBpbmRpY2VzTGVuZ3RoICs9IGxlbmd0aCAvIDMgKiAyOwogICAgICB9CiAgICB9CiAgICBjb25zdCBhZGRFbmRQb3NpdGlvbnMgPSBkZWZpbmVkX2RlZmF1bHQoZW5kUG9zaXRpb25zKTsKICAgIGxldCBlbmRQb3NpdGlvbkxlbmd0aDsKICAgIGlmIChhZGRFbmRQb3NpdGlvbnMpIHsKICAgICAgZW5kUG9zaXRpb25MZW5ndGggPSBlbmRQb3NpdGlvbnNbMF0ubGVuZ3RoIC0gMzsKICAgICAgbGVmdENvdW50ICs9IGVuZFBvc2l0aW9uTGVuZ3RoOwogICAgICByaWdodENvdW50ICs9IGVuZFBvc2l0aW9uTGVuZ3RoOwogICAgICBlbmRQb3NpdGlvbkxlbmd0aCAvPSAzOwogICAgICBpbmRpY2VzTGVuZ3RoICs9IGVuZFBvc2l0aW9uTGVuZ3RoICogNDsKICAgIH0KICAgIGNvbnN0IHNpemUgPSBsZWZ0Q291bnQgKyByaWdodENvdW50OwogICAgY29uc3QgZmluYWxQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHNpemUpOwogICAgbGV0IGZyb250ID0gMDsKICAgIGxldCBiYWNrID0gc2l6ZSAtIDE7CiAgICBsZXQgVUwsIExMLCBVUiwgTFI7CiAgICBsZXQgcmlnaHRQb3MsIGxlZnRQb3M7CiAgICBjb25zdCBoYWxmTGVuZ3RoID0gZW5kUG9zaXRpb25MZW5ndGggLyAyOwogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KHNpemUgLyAzLCBpbmRpY2VzTGVuZ3RoICsgNCk7CiAgICBsZXQgaW5kZXggPSAwOwogICAgaW5kaWNlc1tpbmRleCsrXSA9IGZyb250IC8gMzsKICAgIGluZGljZXNbaW5kZXgrK10gPSAoYmFjayAtIDIpIC8gMzsKICAgIGlmIChhZGRFbmRQb3NpdGlvbnMpIHsKICAgICAgd2FsbEluZGljZXMucHVzaChmcm9udCAvIDMpOwogICAgICBsZWZ0UG9zID0gY2FydGVzaWFuMTM7CiAgICAgIHJpZ2h0UG9zID0gY2FydGVzaWFuMjM7CiAgICAgIGNvbnN0IGZpcnN0RW5kUG9zaXRpb25zID0gZW5kUG9zaXRpb25zWzBdOwogICAgICBmb3IgKGkgPSAwOyBpIDwgaGFsZkxlbmd0aDsgaSsrKSB7CiAgICAgICAgbGVmdFBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICBmaXJzdEVuZFBvc2l0aW9ucywKICAgICAgICAgIChoYWxmTGVuZ3RoIC0gMSAtIGkpICogMywKICAgICAgICAgIGxlZnRQb3MKICAgICAgICApOwogICAgICAgIHJpZ2h0UG9zID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgIGZpcnN0RW5kUG9zaXRpb25zLAogICAgICAgICAgKGhhbGZMZW5ndGggKyBpKSAqIDMsCiAgICAgICAgICByaWdodFBvcwogICAgICAgICk7CiAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoZmluYWxQb3NpdGlvbnMsIHJpZ2h0UG9zLCBmcm9udCk7CiAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoCiAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgIGxlZnRQb3MsCiAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICBiYWNrCiAgICAgICAgKTsKICAgICAgICBMTCA9IGZyb250IC8gMzsKICAgICAgICBMUiA9IExMICsgMTsKICAgICAgICBVTCA9IChiYWNrIC0gMikgLyAzOwogICAgICAgIFVSID0gVUwgLSAxOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVTDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gVVI7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExMOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMUjsKICAgICAgICBmcm9udCArPSAzOwogICAgICAgIGJhY2sgLT0gMzsKICAgICAgfQogICAgfQogICAgbGV0IHBvc0luZGV4ID0gMDsKICAgIGxldCByaWdodEVkZ2UgPSBwb3NpdGlvbnNbcG9zSW5kZXgrK107CiAgICBsZXQgbGVmdEVkZ2UgPSBwb3NpdGlvbnNbcG9zSW5kZXgrK107CiAgICBmaW5hbFBvc2l0aW9ucy5zZXQocmlnaHRFZGdlLCBmcm9udCk7CiAgICBmaW5hbFBvc2l0aW9ucy5zZXQobGVmdEVkZ2UsIGJhY2sgLSBsZWZ0RWRnZS5sZW5ndGggKyAxKTsKICAgIGxlbmd0aCA9IGxlZnRFZGdlLmxlbmd0aCAtIDM7CiAgICB3YWxsSW5kaWNlcy5wdXNoKGZyb250IC8gMywgKGJhY2sgLSAyKSAvIDMpOwogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAzKSB7CiAgICAgIExMID0gZnJvbnQgLyAzOwogICAgICBMUiA9IExMICsgMTsKICAgICAgVUwgPSAoYmFjayAtIDIpIC8gMzsKICAgICAgVVIgPSBVTCAtIDE7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVTDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMUjsKICAgICAgZnJvbnQgKz0gMzsKICAgICAgYmFjayAtPSAzOwogICAgfQogICAgZm9yIChpID0gMDsgaSA8IGNvcm5lcnMubGVuZ3RoOyBpKyspIHsKICAgICAgbGV0IGo7CiAgICAgIGNvcm5lciA9IGNvcm5lcnNbaV07CiAgICAgIGNvbnN0IGwgPSBjb3JuZXIubGVmdFBvc2l0aW9uczsKICAgICAgY29uc3QgciA9IGNvcm5lci5yaWdodFBvc2l0aW9uczsKICAgICAgbGV0IHN0YXJ0OwogICAgICBsZXQgb3V0c2lkZVBvaW50ID0gY2FydGVzaWFuMzM7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobCkpIHsKICAgICAgICBiYWNrIC09IDM7CiAgICAgICAgc3RhcnQgPSBVUjsKICAgICAgICB3YWxsSW5kaWNlcy5wdXNoKExSKTsKICAgICAgICBmb3IgKGogPSAwOyBqIDwgbC5sZW5ndGggLyAzOyBqKyspIHsKICAgICAgICAgIG91dHNpZGVQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkobCwgaiAqIDMsIG91dHNpZGVQb2ludCk7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gc3RhcnQgLSBqIC0gMTsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBzdGFydCAtIGo7CiAgICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZSgKICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICAgIG91dHNpZGVQb2ludCwKICAgICAgICAgICAgdm9pZCAwLAogICAgICAgICAgICBiYWNrCiAgICAgICAgICApOwogICAgICAgICAgYmFjayAtPSAzOwogICAgICAgIH0KICAgICAgICB3YWxsSW5kaWNlcy5wdXNoKHN0YXJ0IC0gTWF0aC5mbG9vcihsLmxlbmd0aCAvIDYpKTsKICAgICAgICBpZiAoY29ybmVyVHlwZSA9PT0gQ29ybmVyVHlwZV9kZWZhdWx0LkJFVkVMRUQpIHsKICAgICAgICAgIHdhbGxJbmRpY2VzLnB1c2goKGJhY2sgLSAyKSAvIDMgKyAxKTsKICAgICAgICB9CiAgICAgICAgZnJvbnQgKz0gMzsKICAgICAgfSBlbHNlIHsKICAgICAgICBmcm9udCArPSAzOwogICAgICAgIHN0YXJ0ID0gTFI7CiAgICAgICAgd2FsbEluZGljZXMucHVzaChVUik7CiAgICAgICAgZm9yIChqID0gMDsgaiA8IHIubGVuZ3RoIC8gMzsgaisrKSB7CiAgICAgICAgICBvdXRzaWRlUG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHIsIGogKiAzLCBvdXRzaWRlUG9pbnQpOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHN0YXJ0ICsgajsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBzdGFydCArIGogKyAxOwogICAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoCiAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgICBvdXRzaWRlUG9pbnQsCiAgICAgICAgICAgIGZyb250CiAgICAgICAgICApOwogICAgICAgICAgZnJvbnQgKz0gMzsKICAgICAgICB9CiAgICAgICAgd2FsbEluZGljZXMucHVzaChzdGFydCArIE1hdGguZmxvb3Ioci5sZW5ndGggLyA2KSk7CiAgICAgICAgaWYgKGNvcm5lclR5cGUgPT09IENvcm5lclR5cGVfZGVmYXVsdC5CRVZFTEVEKSB7CiAgICAgICAgICB3YWxsSW5kaWNlcy5wdXNoKGZyb250IC8gMyAtIDEpOwogICAgICAgIH0KICAgICAgICBiYWNrIC09IDM7CiAgICAgIH0KICAgICAgcmlnaHRFZGdlID0gcG9zaXRpb25zW3Bvc0luZGV4KytdOwogICAgICBsZWZ0RWRnZSA9IHBvc2l0aW9uc1twb3NJbmRleCsrXTsKICAgICAgcmlnaHRFZGdlLnNwbGljZSgwLCAzKTsKICAgICAgbGVmdEVkZ2Uuc3BsaWNlKGxlZnRFZGdlLmxlbmd0aCAtIDMsIDMpOwogICAgICBmaW5hbFBvc2l0aW9ucy5zZXQocmlnaHRFZGdlLCBmcm9udCk7CiAgICAgIGZpbmFsUG9zaXRpb25zLnNldChsZWZ0RWRnZSwgYmFjayAtIGxlZnRFZGdlLmxlbmd0aCArIDEpOwogICAgICBsZW5ndGggPSBsZWZ0RWRnZS5sZW5ndGggLSAzOwogICAgICBmb3IgKGogPSAwOyBqIDwgbGVmdEVkZ2UubGVuZ3RoOyBqICs9IDMpIHsKICAgICAgICBMUiA9IGZyb250IC8gMzsKICAgICAgICBMTCA9IExSIC0gMTsKICAgICAgICBVUiA9IChiYWNrIC0gMikgLyAzOwogICAgICAgIFVMID0gVVIgKyAxOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVTDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gVVI7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExMOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMUjsKICAgICAgICBmcm9udCArPSAzOwogICAgICAgIGJhY2sgLT0gMzsKICAgICAgfQogICAgICBmcm9udCAtPSAzOwogICAgICBiYWNrICs9IDM7CiAgICAgIHdhbGxJbmRpY2VzLnB1c2goZnJvbnQgLyAzLCAoYmFjayAtIDIpIC8gMyk7CiAgICB9CiAgICBpZiAoYWRkRW5kUG9zaXRpb25zKSB7CiAgICAgIGZyb250ICs9IDM7CiAgICAgIGJhY2sgLT0gMzsKICAgICAgbGVmdFBvcyA9IGNhcnRlc2lhbjEzOwogICAgICByaWdodFBvcyA9IGNhcnRlc2lhbjIzOwogICAgICBjb25zdCBsYXN0RW5kUG9zaXRpb25zID0gZW5kUG9zaXRpb25zWzFdOwogICAgICBmb3IgKGkgPSAwOyBpIDwgaGFsZkxlbmd0aDsgaSsrKSB7CiAgICAgICAgbGVmdFBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICBsYXN0RW5kUG9zaXRpb25zLAogICAgICAgICAgKGVuZFBvc2l0aW9uTGVuZ3RoIC0gaSAtIDEpICogMywKICAgICAgICAgIGxlZnRQb3MKICAgICAgICApOwogICAgICAgIHJpZ2h0UG9zID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShsYXN0RW5kUG9zaXRpb25zLCBpICogMywgcmlnaHRQb3MpOwogICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICBsZWZ0UG9zLAogICAgICAgICAgdm9pZCAwLAogICAgICAgICAgYmFjawogICAgICAgICk7CiAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoZmluYWxQb3NpdGlvbnMsIHJpZ2h0UG9zLCBmcm9udCk7CiAgICAgICAgTFIgPSBmcm9udCAvIDM7CiAgICAgICAgTEwgPSBMUiAtIDE7CiAgICAgICAgVVIgPSAoYmFjayAtIDIpIC8gMzsKICAgICAgICBVTCA9IFVSICsgMTsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gVUw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gTFI7CiAgICAgICAgZnJvbnQgKz0gMzsKICAgICAgICBiYWNrIC09IDM7CiAgICAgIH0KICAgICAgd2FsbEluZGljZXMucHVzaChmcm9udCAvIDMpOwogICAgfSBlbHNlIHsKICAgICAgd2FsbEluZGljZXMucHVzaChmcm9udCAvIDMsIChiYWNrIC0gMikgLyAzKTsKICAgIH0KICAgIGluZGljZXNbaW5kZXgrK10gPSBmcm9udCAvIDM7CiAgICBpbmRpY2VzW2luZGV4KytdID0gKGJhY2sgLSAyKSAvIDM7CiAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgIHZhbHVlczogZmluYWxQb3NpdGlvbnMKICAgIH0pOwogICAgcmV0dXJuIHsKICAgICAgYXR0cmlidXRlcywKICAgICAgaW5kaWNlcywKICAgICAgd2FsbEluZGljZXMKICAgIH07CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVQb3NpdGlvbnNFeHRydWRlZDIocGFyYW1zKSB7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBwYXJhbXMuZWxsaXBzb2lkOwogICAgY29uc3QgY29tcHV0ZWRQb3NpdGlvbnMgPSBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbnMocGFyYW1zKTsKICAgIGNvbnN0IGF0dHIgPSBjb21iaW5lMyhjb21wdXRlZFBvc2l0aW9ucywgcGFyYW1zLmNvcm5lclR5cGUpOwogICAgY29uc3Qgd2FsbEluZGljZXMgPSBhdHRyLndhbGxJbmRpY2VzOwogICAgY29uc3QgaGVpZ2h0ID0gcGFyYW1zLmhlaWdodDsKICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gcGFyYW1zLmV4dHJ1ZGVkSGVpZ2h0OwogICAgY29uc3QgYXR0cmlidXRlcyA9IGF0dHIuYXR0cmlidXRlczsKICAgIGNvbnN0IGluZGljZXMgPSBhdHRyLmluZGljZXM7CiAgICBsZXQgcG9zaXRpb25zID0gYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXM7CiAgICBsZXQgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgIGxldCBleHRydWRlZFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkobGVuZ3RoKTsKICAgIGV4dHJ1ZGVkUG9zaXRpb25zLnNldChwb3NpdGlvbnMpOwogICAgY29uc3QgbmV3UG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShsZW5ndGggKiAyKTsKICAgIHBvc2l0aW9ucyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodCgKICAgICAgcG9zaXRpb25zLAogICAgICBoZWlnaHQsCiAgICAgIGVsbGlwc29pZAogICAgKTsKICAgIGV4dHJ1ZGVkUG9zaXRpb25zID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuc2NhbGVUb0dlb2RldGljSGVpZ2h0KAogICAgICBleHRydWRlZFBvc2l0aW9ucywKICAgICAgZXh0cnVkZWRIZWlnaHQsCiAgICAgIGVsbGlwc29pZAogICAgKTsKICAgIG5ld1Bvc2l0aW9ucy5zZXQocG9zaXRpb25zKTsKICAgIG5ld1Bvc2l0aW9ucy5zZXQoZXh0cnVkZWRQb3NpdGlvbnMsIGxlbmd0aCk7CiAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyA9IG5ld1Bvc2l0aW9uczsKICAgIGxlbmd0aCAvPSAzOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChwYXJhbXMub2Zmc2V0QXR0cmlidXRlKSkgewogICAgICBsZXQgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGggKiAyKTsKICAgICAgaWYgKHBhcmFtcy5vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuVE9QKSB7CiAgICAgICAgYXBwbHlPZmZzZXQgPSBhcHBseU9mZnNldC5maWxsKDEsIDAsIGxlbmd0aCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgYXBwbHlPZmZzZXRWYWx1ZSA9IHBhcmFtcy5vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgIGFwcGx5T2Zmc2V0ID0gYXBwbHlPZmZzZXQuZmlsbChhcHBseU9mZnNldFZhbHVlKTsKICAgICAgfQogICAgICBhdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICB2YWx1ZXM6IGFwcGx5T2Zmc2V0CiAgICAgIH0pOwogICAgfQogICAgbGV0IGk7CiAgICBjb25zdCBpTGVuZ3RoID0gaW5kaWNlcy5sZW5ndGg7CiAgICBjb25zdCBuZXdJbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIG5ld1Bvc2l0aW9ucy5sZW5ndGggLyAzLAogICAgICAoaUxlbmd0aCArIHdhbGxJbmRpY2VzLmxlbmd0aCkgKiAyCiAgICApOwogICAgbmV3SW5kaWNlcy5zZXQoaW5kaWNlcyk7CiAgICBsZXQgaW5kZXggPSBpTGVuZ3RoOwogICAgZm9yIChpID0gMDsgaSA8IGlMZW5ndGg7IGkgKz0gMikgewogICAgICBjb25zdCB2MDIgPSBpbmRpY2VzW2ldOwogICAgICBjb25zdCB2MTIgPSBpbmRpY2VzW2kgKyAxXTsKICAgICAgbmV3SW5kaWNlc1tpbmRleCsrXSA9IHYwMiArIGxlbmd0aDsKICAgICAgbmV3SW5kaWNlc1tpbmRleCsrXSA9IHYxMiArIGxlbmd0aDsKICAgIH0KICAgIGxldCBVTCwgTEw7CiAgICBmb3IgKGkgPSAwOyBpIDwgd2FsbEluZGljZXMubGVuZ3RoOyBpKyspIHsKICAgICAgVUwgPSB3YWxsSW5kaWNlc1tpXTsKICAgICAgTEwgPSBVTCArIGxlbmd0aDsKICAgICAgbmV3SW5kaWNlc1tpbmRleCsrXSA9IFVMOwogICAgICBuZXdJbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICB9CiAgICByZXR1cm4gewogICAgICBhdHRyaWJ1dGVzLAogICAgICBpbmRpY2VzOiBuZXdJbmRpY2VzCiAgICB9OwogIH0KICBmdW5jdGlvbiBDb3JyaWRvck91dGxpbmVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG9wdGlvbnMucG9zaXRpb25zOwogICAgY29uc3Qgd2lkdGggPSBvcHRpb25zLndpZHRoOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvcHRpb25zLnBvc2l0aW9ucyIsIHBvc2l0aW9ucyk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIm9wdGlvbnMud2lkdGgiLCB3aWR0aCk7CiAgICBjb25zdCBoZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmhlaWdodCwgMCk7CiAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQsIGhlaWdodCk7CiAgICB0aGlzLl9wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICB0aGlzLl9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZSgKICAgICAgZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KQogICAgKTsKICAgIHRoaXMuX3dpZHRoID0gd2lkdGg7CiAgICB0aGlzLl9oZWlnaHQgPSBNYXRoLm1heChoZWlnaHQsIGV4dHJ1ZGVkSGVpZ2h0KTsKICAgIHRoaXMuX2V4dHJ1ZGVkSGVpZ2h0ID0gTWF0aC5taW4oaGVpZ2h0LCBleHRydWRlZEhlaWdodCk7CiAgICB0aGlzLl9jb3JuZXJUeXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5jb3JuZXJUeXBlLCBDb3JuZXJUeXBlX2RlZmF1bHQuUk9VTkRFRCk7CiAgICB0aGlzLl9ncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFCiAgICApOwogICAgdGhpcy5fb2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5IjsKICAgIHRoaXMucGFja2VkTGVuZ3RoID0gMSArIHBvc2l0aW9ucy5sZW5ndGggKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgNjsKICB9CiAgdmFyIGNhcnRlc2lhbjEzLCBjYXJ0ZXNpYW4yMywgY2FydGVzaWFuMzMsIHNjcmF0Y2hFbGxpcHNvaWQ1LCBzY3JhdGNoT3B0aW9uczEwLCBDb3JyaWRvck91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0NvcnJpZG9yT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db3JyaWRvck91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfYXJyYXlSZW1vdmVEdXBsaWNhdGVzKCk7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X0Nvcm5lclR5cGUoKTsKICAgICAgaW5pdF9Db3JyaWRvckdlb21ldHJ5TGlicmFyeSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1BvbHlnb25QaXBlbGluZSgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgY2FydGVzaWFuMTMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjIzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4zMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gdmFsdWUuX3Bvc2l0aW9uczsKICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBsZW5ndGg7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhwb3NpdGlvbnNbaV0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgRWxsaXBzb2lkX2RlZmF1bHQucGFjayh2YWx1ZS5fZWxsaXBzb2lkLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl93aWR0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2hlaWdodDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fY29ybmVyVHlwZTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2dyYW51bGFyaXR5OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmFsdWUuX29mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaEVsbGlwc29pZDUgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShFbGxpcHNvaWRfZGVmYXVsdC5VTklUX1NQSEVSRSk7CiAgICAgIHNjcmF0Y2hPcHRpb25zMTAgPSB7CiAgICAgICAgcG9zaXRpb25zOiB2b2lkIDAsCiAgICAgICAgZWxsaXBzb2lkOiBzY3JhdGNoRWxsaXBzb2lkNSwKICAgICAgICB3aWR0aDogdm9pZCAwLAogICAgICAgIGhlaWdodDogdm9pZCAwLAogICAgICAgIGV4dHJ1ZGVkSGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgY29ybmVyVHlwZTogdm9pZCAwLAogICAgICAgIGdyYW51bGFyaXR5OiB2b2lkIDAsCiAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiB2b2lkIDAKICAgICAgfTsKICAgICAgQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBwb3NpdGlvbnNbaV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoRWxsaXBzb2lkNSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3Qgd2lkdGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGhlaWdodCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGNvcm5lclR5cGUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBvZmZzZXRBdHRyaWJ1dGUgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEwLnBvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTAud2lkdGggPSB3aWR0aDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTAuaGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMC5leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMC5jb3JuZXJUeXBlID0gY29ybmVyVHlwZTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTAuZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTAub2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIHJldHVybiBuZXcgQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnMxMCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgICAgIHJlc3VsdC5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkLCByZXN1bHQuX2VsbGlwc29pZCk7CiAgICAgICAgcmVzdWx0Ll93aWR0aCA9IHdpZHRoOwogICAgICAgIHJlc3VsdC5faGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgIHJlc3VsdC5fZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICByZXN1bHQuX2Nvcm5lclR5cGUgPSBjb3JuZXJUeXBlOwogICAgICAgIHJlc3VsdC5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICByZXN1bHQuX29mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihjb3JyaWRvck91dGxpbmVHZW9tZXRyeSkgewogICAgICAgIGxldCBwb3NpdGlvbnMgPSBjb3JyaWRvck91dGxpbmVHZW9tZXRyeS5fcG9zaXRpb25zOwogICAgICAgIGNvbnN0IHdpZHRoID0gY29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuX3dpZHRoOwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IGNvcnJpZG9yT3V0bGluZUdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgcG9zaXRpb25zID0gc2NhbGVUb1N1cmZhY2UzKHBvc2l0aW9ucywgZWxsaXBzb2lkKTsKICAgICAgICBjb25zdCBjbGVhblBvc2l0aW9ucyA9IGFycmF5UmVtb3ZlRHVwbGljYXRlc19kZWZhdWx0KAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24KICAgICAgICApOwogICAgICAgIGlmIChjbGVhblBvc2l0aW9ucy5sZW5ndGggPCAyIHx8IHdpZHRoIDw9IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gY29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuX2hlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGNvcnJpZG9yT3V0bGluZUdlb21ldHJ5Ll9leHRydWRlZEhlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlID0gIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgZXh0cnVkZWRIZWlnaHQsCiAgICAgICAgICAwLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04yCiAgICAgICAgKTsKICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBwb3NpdGlvbnM6IGNsZWFuUG9zaXRpb25zLAogICAgICAgICAgd2lkdGgsCiAgICAgICAgICBjb3JuZXJUeXBlOiBjb3JyaWRvck91dGxpbmVHZW9tZXRyeS5fY29ybmVyVHlwZSwKICAgICAgICAgIGdyYW51bGFyaXR5OiBjb3JyaWRvck91dGxpbmVHZW9tZXRyeS5fZ3JhbnVsYXJpdHksCiAgICAgICAgICBzYXZlQXR0cmlidXRlczogZmFsc2UKICAgICAgICB9OwogICAgICAgIGxldCBhdHRyOwogICAgICAgIGlmIChleHRydWRlKSB7CiAgICAgICAgICBwYXJhbXMuaGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgICAgcGFyYW1zLmV4dHJ1ZGVkSGVpZ2h0ID0gZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgICBwYXJhbXMub2Zmc2V0QXR0cmlidXRlID0gY29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIGF0dHIgPSBjb21wdXRlUG9zaXRpb25zRXh0cnVkZWQyKHBhcmFtcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IGNvbXB1dGVkUG9zaXRpb25zID0gQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb25zKHBhcmFtcyk7CiAgICAgICAgICBhdHRyID0gY29tYmluZTMoY29tcHV0ZWRQb3NpdGlvbnMsIHBhcmFtcy5jb3JuZXJUeXBlKTsKICAgICAgICAgIGF0dHIuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgICAgICAgIGF0dHIuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMsCiAgICAgICAgICAgIGhlaWdodCwKICAgICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgICApOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChjb3JyaWRvck91dGxpbmVHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlKSkgewogICAgICAgICAgICBjb25zdCBsZW5ndGggPSBhdHRyLmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aDsKICAgICAgICAgICAgY29uc3Qgb2Zmc2V0VmFsdWUgPSBjb3JyaWRvck91dGxpbmVHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgICAgY29uc3QgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGggLyAzKS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgICAgICAgYXR0ci5hdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICAgICAgICB2YWx1ZXM6IGFwcGx5T2Zmc2V0CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gYXR0ci5hdHRyaWJ1dGVzOwogICAgICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tVmVydGljZXMoCiAgICAgICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgIDMKICAgICAgICApOwogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlczogYXR0ci5pbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmUsCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IGNvcnJpZG9yT3V0bGluZUdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IENvcnJpZG9yT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVDb3JyaWRvck91dGxpbmVHZW9tZXRyeShjb3JyaWRvck91dGxpbmVHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgY29ycmlkb3JPdXRsaW5lR2VvbWV0cnkgPSBDb3JyaWRvck91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjaygKICAgICAgICBjb3JyaWRvck91dGxpbmVHZW9tZXRyeSwKICAgICAgICBvZmZzZXQKICAgICAgKTsKICAgIH0KICAgIGNvcnJpZG9yT3V0bGluZUdlb21ldHJ5Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZSgKICAgICAgY29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuX2VsbGlwc29pZAogICAgKTsKICAgIHJldHVybiBDb3JyaWRvck91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KGNvcnJpZG9yT3V0bGluZUdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Db3JyaWRvck91dGxpbmVHZW9tZXRyeSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ3lsaW5kZXJHZW9tZXRyeUxpYnJhcnkuanMKICB2YXIgQ3lsaW5kZXJHZW9tZXRyeUxpYnJhcnksIEN5bGluZGVyR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfQ3lsaW5kZXJHZW9tZXRyeUxpYnJhcnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0N5bGluZGVyR2VvbWV0cnlMaWJyYXJ5LmpzIigpIHsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIEN5bGluZGVyR2VvbWV0cnlMaWJyYXJ5ID0ge307CiAgICAgIEN5bGluZGVyR2VvbWV0cnlMaWJyYXJ5LmNvbXB1dGVQb3NpdGlvbnMgPSBmdW5jdGlvbihsZW5ndGgsIHRvcFJhZGl1cywgYm90dG9tUmFkaXVzLCBzbGljZXMsIGZpbGwpIHsKICAgICAgICBjb25zdCB0b3BaID0gbGVuZ3RoICogMC41OwogICAgICAgIGNvbnN0IGJvdHRvbVogPSAtdG9wWjsKICAgICAgICBjb25zdCB0d29TbGljZSA9IHNsaWNlcyArIHNsaWNlczsKICAgICAgICBjb25zdCBzaXplID0gZmlsbCA/IDIgKiB0d29TbGljZSA6IHR3b1NsaWNlOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoc2l6ZSAqIDMpOwogICAgICAgIGxldCBpOwogICAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgICAgbGV0IHRiSW5kZXggPSAwOwogICAgICAgIGNvbnN0IGJvdHRvbU9mZnNldCA9IGZpbGwgPyB0d29TbGljZSAqIDMgOiAwOwogICAgICAgIGNvbnN0IHRvcE9mZnNldCA9IGZpbGwgPyAodHdvU2xpY2UgKyBzbGljZXMpICogMyA6IHNsaWNlcyAqIDM7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHNsaWNlczsgaSsrKSB7CiAgICAgICAgICBjb25zdCBhbmdsZSA9IGkgLyBzbGljZXMgKiBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgICAgY29uc3QgeCA9IE1hdGguY29zKGFuZ2xlKTsKICAgICAgICAgIGNvbnN0IHkgPSBNYXRoLnNpbihhbmdsZSk7CiAgICAgICAgICBjb25zdCBib3R0b21YID0geCAqIGJvdHRvbVJhZGl1czsKICAgICAgICAgIGNvbnN0IGJvdHRvbVkgPSB5ICogYm90dG9tUmFkaXVzOwogICAgICAgICAgY29uc3QgdG9wWCA9IHggKiB0b3BSYWRpdXM7CiAgICAgICAgICBjb25zdCB0b3BZID0geSAqIHRvcFJhZGl1czsKICAgICAgICAgIHBvc2l0aW9uc1t0YkluZGV4ICsgYm90dG9tT2Zmc2V0XSA9IGJvdHRvbVg7CiAgICAgICAgICBwb3NpdGlvbnNbdGJJbmRleCArIGJvdHRvbU9mZnNldCArIDFdID0gYm90dG9tWTsKICAgICAgICAgIHBvc2l0aW9uc1t0YkluZGV4ICsgYm90dG9tT2Zmc2V0ICsgMl0gPSBib3R0b21aOwogICAgICAgICAgcG9zaXRpb25zW3RiSW5kZXggKyB0b3BPZmZzZXRdID0gdG9wWDsKICAgICAgICAgIHBvc2l0aW9uc1t0YkluZGV4ICsgdG9wT2Zmc2V0ICsgMV0gPSB0b3BZOwogICAgICAgICAgcG9zaXRpb25zW3RiSW5kZXggKyB0b3BPZmZzZXQgKyAyXSA9IHRvcFo7CiAgICAgICAgICB0YkluZGV4ICs9IDM7CiAgICAgICAgICBpZiAoZmlsbCkgewogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBib3R0b21YOwogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBib3R0b21ZOwogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBib3R0b21aOwogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSB0b3BYOwogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSB0b3BZOwogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSB0b3BaOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcG9zaXRpb25zOwogICAgICB9OwogICAgICBDeWxpbmRlckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0ID0gQ3lsaW5kZXJHZW9tZXRyeUxpYnJhcnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DeWxpbmRlckdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gQ3lsaW5kZXJHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IGxlbmd0aCA9IG9wdGlvbnMubGVuZ3RoOwogICAgY29uc3QgdG9wUmFkaXVzID0gb3B0aW9ucy50b3BSYWRpdXM7CiAgICBjb25zdCBib3R0b21SYWRpdXMgPSBvcHRpb25zLmJvdHRvbVJhZGl1czsKICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMudmVydGV4Rm9ybWF0LCBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5ERUZBVUxUKTsKICAgIGNvbnN0IHNsaWNlcyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuc2xpY2VzLCAxMjgpOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobGVuZ3RoKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5sZW5ndGggbXVzdCBiZSBkZWZpbmVkLiIpOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodG9wUmFkaXVzKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy50b3BSYWRpdXMgbXVzdCBiZSBkZWZpbmVkLiIpOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYm90dG9tUmFkaXVzKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5ib3R0b21SYWRpdXMgbXVzdCBiZSBkZWZpbmVkLiIpOwogICAgfQogICAgaWYgKHNsaWNlcyA8IDMpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIm9wdGlvbnMuc2xpY2VzIG11c3QgYmUgZ3JlYXRlciB0aGFuIG9yIGVxdWFsIHRvIDMuIgogICAgICApOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSkgJiYgb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuVE9QKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZS5UT1AgaXMgbm90IGEgc3VwcG9ydGVkIG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlIGZvciB0aGlzIGdlb21ldHJ5LiIKICAgICAgKTsKICAgIH0KICAgIHRoaXMuX2xlbmd0aCA9IGxlbmd0aDsKICAgIHRoaXMuX3RvcFJhZGl1cyA9IHRvcFJhZGl1czsKICAgIHRoaXMuX2JvdHRvbVJhZGl1cyA9IGJvdHRvbVJhZGl1czsKICAgIHRoaXMuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCk7CiAgICB0aGlzLl9zbGljZXMgPSBzbGljZXM7CiAgICB0aGlzLl9vZmZzZXRBdHRyaWJ1dGUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlQ3lsaW5kZXJHZW9tZXRyeSI7CiAgfQogIHZhciByYWRpdXNTY3JhdGNoLCBub3JtYWxTY3JhdGNoMywgYml0YW5nZW50U2NyYXRjaCwgdGFuZ2VudFNjcmF0Y2gsIHBvc2l0aW9uU2NyYXRjaCwgc2NyYXRjaFZlcnRleEZvcm1hdDUsIHNjcmF0Y2hPcHRpb25zMTEsIHVuaXRDeWxpbmRlckdlb21ldHJ5LCBDeWxpbmRlckdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfQ3lsaW5kZXJHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ3lsaW5kZXJHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfQ3lsaW5kZXJHZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgcmFkaXVzU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgbm9ybWFsU2NyYXRjaDMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGJpdGFuZ2VudFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHRhbmdlbnRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwb3NpdGlvblNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEN5bGluZGVyR2VvbWV0cnkucGFja2VkTGVuZ3RoID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgNTsKICAgICAgQ3lsaW5kZXJHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWUgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2sodmFsdWUuX3ZlcnRleEZvcm1hdCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fbGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fdG9wUmFkaXVzOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fYm90dG9tUmFkaXVzOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc2xpY2VzOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmFsdWUuX29mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDUgPSBuZXcgVmVydGV4Rm9ybWF0X2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE9wdGlvbnMxMSA9IHsKICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ1LAogICAgICAgIGxlbmd0aDogdm9pZCAwLAogICAgICAgIHRvcFJhZGl1czogdm9pZCAwLAogICAgICAgIGJvdHRvbVJhZGl1czogdm9pZCAwLAogICAgICAgIHNsaWNlczogdm9pZCAwLAogICAgICAgIG9mZnNldEF0dHJpYnV0ZTogdm9pZCAwCiAgICAgIH07CiAgICAgIEN5bGluZGVyR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0NQogICAgICAgICk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCB0b3BSYWRpdXMgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGJvdHRvbVJhZGl1cyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgc2xpY2VzID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBvZmZzZXRBdHRyaWJ1dGUgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczExLmxlbmd0aCA9IGxlbmd0aDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTEudG9wUmFkaXVzID0gdG9wUmFkaXVzOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMS5ib3R0b21SYWRpdXMgPSBib3R0b21SYWRpdXM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczExLnNsaWNlcyA9IHNsaWNlczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTEub2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIHJldHVybiBuZXcgQ3lsaW5kZXJHZW9tZXRyeShzY3JhdGNoT3B0aW9uczExKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSh2ZXJ0ZXhGb3JtYXQsIHJlc3VsdC5fdmVydGV4Rm9ybWF0KTsKICAgICAgICByZXN1bHQuX2xlbmd0aCA9IGxlbmd0aDsKICAgICAgICByZXN1bHQuX3RvcFJhZGl1cyA9IHRvcFJhZGl1czsKICAgICAgICByZXN1bHQuX2JvdHRvbVJhZGl1cyA9IGJvdHRvbVJhZGl1czsKICAgICAgICByZXN1bHQuX3NsaWNlcyA9IHNsaWNlczsKICAgICAgICByZXN1bHQuX29mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ3lsaW5kZXJHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKGN5bGluZGVyR2VvbWV0cnkpIHsKICAgICAgICBsZXQgbGVuZ3RoID0gY3lsaW5kZXJHZW9tZXRyeS5fbGVuZ3RoOwogICAgICAgIGNvbnN0IHRvcFJhZGl1cyA9IGN5bGluZGVyR2VvbWV0cnkuX3RvcFJhZGl1czsKICAgICAgICBjb25zdCBib3R0b21SYWRpdXMgPSBjeWxpbmRlckdlb21ldHJ5Ll9ib3R0b21SYWRpdXM7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gY3lsaW5kZXJHZW9tZXRyeS5fdmVydGV4Rm9ybWF0OwogICAgICAgIGNvbnN0IHNsaWNlcyA9IGN5bGluZGVyR2VvbWV0cnkuX3NsaWNlczsKICAgICAgICBpZiAobGVuZ3RoIDw9IDAgfHwgdG9wUmFkaXVzIDwgMCB8fCBib3R0b21SYWRpdXMgPCAwIHx8IHRvcFJhZGl1cyA9PT0gMCAmJiBib3R0b21SYWRpdXMgPT09IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgdHdvU2xpY2VzID0gc2xpY2VzICsgc2xpY2VzOwogICAgICAgIGNvbnN0IHRocmVlU2xpY2VzID0gc2xpY2VzICsgdHdvU2xpY2VzOwogICAgICAgIGNvbnN0IG51bVZlcnRpY2VzID0gdHdvU2xpY2VzICsgdHdvU2xpY2VzOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IEN5bGluZGVyR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9ucygKICAgICAgICAgIGxlbmd0aCwKICAgICAgICAgIHRvcFJhZGl1cywKICAgICAgICAgIGJvdHRvbVJhZGl1cywKICAgICAgICAgIHNsaWNlcywKICAgICAgICAgIHRydWUKICAgICAgICApOwogICAgICAgIGNvbnN0IHN0ID0gdmVydGV4Rm9ybWF0LnN0ID8gbmV3IEZsb2F0MzJBcnJheShudW1WZXJ0aWNlcyAqIDIpIDogdm9pZCAwOwogICAgICAgIGNvbnN0IG5vcm1hbHMgPSB2ZXJ0ZXhGb3JtYXQubm9ybWFsID8gbmV3IEZsb2F0MzJBcnJheShudW1WZXJ0aWNlcyAqIDMpIDogdm9pZCAwOwogICAgICAgIGNvbnN0IHRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LnRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KG51bVZlcnRpY2VzICogMykgOiB2b2lkIDA7CiAgICAgICAgY29uc3QgYml0YW5nZW50cyA9IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KG51bVZlcnRpY2VzICogMykgOiB2b2lkIDA7CiAgICAgICAgbGV0IGk7CiAgICAgICAgY29uc3QgY29tcHV0ZU5vcm1hbCA9IHZlcnRleEZvcm1hdC5ub3JtYWwgfHwgdmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudDsKICAgICAgICBpZiAoY29tcHV0ZU5vcm1hbCkgewogICAgICAgICAgY29uc3QgY29tcHV0ZVRhbmdlbnQgPSB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50OwogICAgICAgICAgbGV0IG5vcm1hbEluZGV4ID0gMDsKICAgICAgICAgIGxldCB0YW5nZW50SW5kZXggPSAwOwogICAgICAgICAgbGV0IGJpdGFuZ2VudEluZGV4ID0gMDsKICAgICAgICAgIGNvbnN0IHRoZXRhID0gTWF0aC5hdGFuMihib3R0b21SYWRpdXMgLSB0b3BSYWRpdXMsIGxlbmd0aCk7CiAgICAgICAgICBjb25zdCBub3JtYWwyID0gbm9ybWFsU2NyYXRjaDM7CiAgICAgICAgICBub3JtYWwyLnogPSBNYXRoLnNpbih0aGV0YSk7CiAgICAgICAgICBjb25zdCBub3JtYWxTY2FsZTIgPSBNYXRoLmNvcyh0aGV0YSk7CiAgICAgICAgICBsZXQgdGFuZ2VudCA9IHRhbmdlbnRTY3JhdGNoOwogICAgICAgICAgbGV0IGJpdGFuZ2VudCA9IGJpdGFuZ2VudFNjcmF0Y2g7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2xpY2VzOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBpIC8gc2xpY2VzICogTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICAgICAgY29uc3QgeCA9IG5vcm1hbFNjYWxlMiAqIE1hdGguY29zKGFuZ2xlKTsKICAgICAgICAgICAgY29uc3QgeSA9IG5vcm1hbFNjYWxlMiAqIE1hdGguc2luKGFuZ2xlKTsKICAgICAgICAgICAgaWYgKGNvbXB1dGVOb3JtYWwpIHsKICAgICAgICAgICAgICBub3JtYWwyLnggPSB4OwogICAgICAgICAgICAgIG5vcm1hbDIueSA9IHk7CiAgICAgICAgICAgICAgaWYgKGNvbXB1dGVUYW5nZW50KSB7CiAgICAgICAgICAgICAgICB0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1osIG5vcm1hbDIsIHRhbmdlbnQpLAogICAgICAgICAgICAgICAgICB0YW5nZW50CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueDsKICAgICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLnk7CiAgICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi56OwogICAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueDsKICAgICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLnk7CiAgICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi56OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueDsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueTsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQuejsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueDsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueTsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQuejsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhub3JtYWwyLCB0YW5nZW50LCBiaXRhbmdlbnQpLAogICAgICAgICAgICAgICAgICBiaXRhbmdlbnQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lng7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lnk7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lno7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lng7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lnk7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lno7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2xpY2VzOyBpKyspIHsKICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gMDsKICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gMDsKICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gLTE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gMTsKICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSAwOwogICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gMDsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gLTE7CiAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzbGljZXM7IGkrKykgewogICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSAwOwogICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSAwOwogICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IDE7CiAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gMDsKICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IDA7CiAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IDE7CiAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgbnVtSW5kaWNlcyA9IDEyICogc2xpY2VzIC0gMTI7CiAgICAgICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KG51bVZlcnRpY2VzLCBudW1JbmRpY2VzKTsKICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGxldCBqID0gMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2xpY2VzIC0gMTsgaSsrKSB7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gajsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBqICsgMjsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBqICsgMzsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBqOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGogKyAzOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGogKyAxOwogICAgICAgICAgaiArPSAyOwogICAgICAgIH0KICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdHdvU2xpY2VzIC0gMjsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gMDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gMTsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdHdvU2xpY2VzIC0gMjsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gMTsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdHdvU2xpY2VzIC0gMTsKICAgICAgICBmb3IgKGkgPSAxOyBpIDwgc2xpY2VzIC0gMTsgaSsrKSB7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdHdvU2xpY2VzICsgaSArIDE7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdHdvU2xpY2VzICsgaTsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB0d29TbGljZXM7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IDE7IGkgPCBzbGljZXMgLSAxOyBpKyspIHsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB0aHJlZVNsaWNlczsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB0aHJlZVNsaWNlcyArIGk7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdGhyZWVTbGljZXMgKyBpICsgMTsKICAgICAgICB9CiAgICAgICAgbGV0IHRleHR1cmVDb29yZEluZGV4ID0gMDsKICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgICBjb25zdCByYWQgPSBNYXRoLm1heCh0b3BSYWRpdXMsIGJvdHRvbVJhZGl1cyk7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtVmVydGljZXM7IGkrKykgewogICAgICAgICAgICBjb25zdCBwb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpICogMywgcG9zaXRpb25TY3JhdGNoKTsKICAgICAgICAgICAgc3RbdGV4dHVyZUNvb3JkSW5kZXgrK10gPSAocG9zaXRpb24ueCArIHJhZCkgLyAoMiAqIHJhZCk7CiAgICAgICAgICAgIHN0W3RleHR1cmVDb29yZEluZGV4KytdID0gKHBvc2l0aW9uLnkgKyByYWQpIC8gKDIgKiByYWQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICB2YWx1ZXM6IHBvc2l0aW9ucwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLm5vcm1hbCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogbm9ybWFscwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgYXR0cmlidXRlcy50YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgdmFsdWVzOiB0YW5nZW50cwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLmJpdGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogYml0YW5nZW50cwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgIGF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgICAgICB2YWx1ZXM6IHN0CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmFkaXVzU2NyYXRjaC54ID0gbGVuZ3RoICogMC41OwogICAgICAgIHJhZGl1c1NjcmF0Y2gueSA9IE1hdGgubWF4KGJvdHRvbVJhZGl1cywgdG9wUmFkaXVzKTsKICAgICAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sCiAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQubWFnbml0dWRlKHJhZGl1c1NjcmF0Y2gpCiAgICAgICAgKTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGN5bGluZGVyR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgIGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IGN5bGluZGVyR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5OT05FID8gMCA6IDE7CiAgICAgICAgICBjb25zdCBhcHBseU9mZnNldCA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCAvIDMpLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICAgICAgYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZSwKICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZTogY3lsaW5kZXJHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEN5bGluZGVyR2VvbWV0cnkuZ2V0VW5pdEN5bGluZGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodW5pdEN5bGluZGVyR2VvbWV0cnkpKSB7CiAgICAgICAgICB1bml0Q3lsaW5kZXJHZW9tZXRyeSA9IEN5bGluZGVyR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkoCiAgICAgICAgICAgIG5ldyBDeWxpbmRlckdlb21ldHJ5KHsKICAgICAgICAgICAgICB0b3BSYWRpdXM6IDEsCiAgICAgICAgICAgICAgYm90dG9tUmFkaXVzOiAxLAogICAgICAgICAgICAgIGxlbmd0aDogMSwKICAgICAgICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IFZlcnRleEZvcm1hdF9kZWZhdWx0LlBPU0lUSU9OX09OTFkKICAgICAgICAgICAgfSkKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB1bml0Q3lsaW5kZXJHZW9tZXRyeTsKICAgICAgfTsKICAgICAgQ3lsaW5kZXJHZW9tZXRyeV9kZWZhdWx0ID0gQ3lsaW5kZXJHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUN5bGluZGVyR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlQ3lsaW5kZXJHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlQ3lsaW5kZXJHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVDeWxpbmRlckdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVDeWxpbmRlckdlb21ldHJ5KGN5bGluZGVyR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIGN5bGluZGVyR2VvbWV0cnkgPSBDeWxpbmRlckdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKGN5bGluZGVyR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICByZXR1cm4gQ3lsaW5kZXJHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KGN5bGluZGVyR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlQ3lsaW5kZXJHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUN5bGluZGVyR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUN5bGluZGVyR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0N5bGluZGVyR2VvbWV0cnkoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGNyZWF0ZUN5bGluZGVyR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZUN5bGluZGVyR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DeWxpbmRlck91dGxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIEN5bGluZGVyT3V0bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgbGVuZ3RoID0gb3B0aW9ucy5sZW5ndGg7CiAgICBjb25zdCB0b3BSYWRpdXMgPSBvcHRpb25zLnRvcFJhZGl1czsKICAgIGNvbnN0IGJvdHRvbVJhZGl1cyA9IG9wdGlvbnMuYm90dG9tUmFkaXVzOwogICAgY29uc3Qgc2xpY2VzID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zbGljZXMsIDEyOCk7CiAgICBjb25zdCBudW1iZXJPZlZlcnRpY2FsTGluZXMgPSBNYXRoLm1heCgKICAgICAgZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5udW1iZXJPZlZlcnRpY2FsTGluZXMsIDE2KSwKICAgICAgMAogICAgKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigib3B0aW9ucy5wb3NpdGlvbnMiLCBsZW5ndGgpOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJvcHRpb25zLnRvcFJhZGl1cyIsIHRvcFJhZGl1cyk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIm9wdGlvbnMuYm90dG9tUmFkaXVzIiwgYm90dG9tUmFkaXVzKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJvcHRpb25zLnNsaWNlcyIsIHNsaWNlcywgMyk7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlKSAmJiBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5UT1ApIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIkdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlLlRPUCBpcyBub3QgYSBzdXBwb3J0ZWQgb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgZm9yIHRoaXMgZ2VvbWV0cnkuIgogICAgICApOwogICAgfQogICAgdGhpcy5fbGVuZ3RoID0gbGVuZ3RoOwogICAgdGhpcy5fdG9wUmFkaXVzID0gdG9wUmFkaXVzOwogICAgdGhpcy5fYm90dG9tUmFkaXVzID0gYm90dG9tUmFkaXVzOwogICAgdGhpcy5fc2xpY2VzID0gc2xpY2VzOwogICAgdGhpcy5fbnVtYmVyT2ZWZXJ0aWNhbExpbmVzID0gbnVtYmVyT2ZWZXJ0aWNhbExpbmVzOwogICAgdGhpcy5fb2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5IjsKICB9CiAgdmFyIHJhZGl1c1NjcmF0Y2gyLCBzY3JhdGNoT3B0aW9uczEyLCBDeWxpbmRlck91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0N5bGluZGVyT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DeWxpbmRlck91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9DeWxpbmRlckdlb21ldHJ5TGlicmFyeSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIHJhZGl1c1NjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBDeWxpbmRlck91dGxpbmVHZW9tZXRyeS5wYWNrZWRMZW5ndGggPSA2OwogICAgICBDeWxpbmRlck91dGxpbmVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2xlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3RvcFJhZGl1czsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2JvdHRvbVJhZGl1czsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3NsaWNlczsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX251bWJlck9mVmVydGljYWxMaW5lczsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHZhbHVlLl9vZmZzZXRBdHRyaWJ1dGUsIC0xKTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hPcHRpb25zMTIgPSB7CiAgICAgICAgbGVuZ3RoOiB2b2lkIDAsCiAgICAgICAgdG9wUmFkaXVzOiB2b2lkIDAsCiAgICAgICAgYm90dG9tUmFkaXVzOiB2b2lkIDAsCiAgICAgICAgc2xpY2VzOiB2b2lkIDAsCiAgICAgICAgbnVtYmVyT2ZWZXJ0aWNhbExpbmVzOiB2b2lkIDAsCiAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiB2b2lkIDAKICAgICAgfTsKICAgICAgQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgdG9wUmFkaXVzID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBib3R0b21SYWRpdXMgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHNsaWNlcyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgbnVtYmVyT2ZWZXJ0aWNhbExpbmVzID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBvZmZzZXRBdHRyaWJ1dGUgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEyLmxlbmd0aCA9IGxlbmd0aDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTIudG9wUmFkaXVzID0gdG9wUmFkaXVzOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMi5ib3R0b21SYWRpdXMgPSBib3R0b21SYWRpdXM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEyLnNsaWNlcyA9IHNsaWNlczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTIubnVtYmVyT2ZWZXJ0aWNhbExpbmVzID0gbnVtYmVyT2ZWZXJ0aWNhbExpbmVzOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMi5vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgICAgcmV0dXJuIG5ldyBDeWxpbmRlck91dGxpbmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczEyKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9sZW5ndGggPSBsZW5ndGg7CiAgICAgICAgcmVzdWx0Ll90b3BSYWRpdXMgPSB0b3BSYWRpdXM7CiAgICAgICAgcmVzdWx0Ll9ib3R0b21SYWRpdXMgPSBib3R0b21SYWRpdXM7CiAgICAgICAgcmVzdWx0Ll9zbGljZXMgPSBzbGljZXM7CiAgICAgICAgcmVzdWx0Ll9udW1iZXJPZlZlcnRpY2FsTGluZXMgPSBudW1iZXJPZlZlcnRpY2FsTGluZXM7CiAgICAgICAgcmVzdWx0Ll9vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEN5bGluZGVyT3V0bGluZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oY3lsaW5kZXJHZW9tZXRyeSkgewogICAgICAgIGxldCBsZW5ndGggPSBjeWxpbmRlckdlb21ldHJ5Ll9sZW5ndGg7CiAgICAgICAgY29uc3QgdG9wUmFkaXVzID0gY3lsaW5kZXJHZW9tZXRyeS5fdG9wUmFkaXVzOwogICAgICAgIGNvbnN0IGJvdHRvbVJhZGl1cyA9IGN5bGluZGVyR2VvbWV0cnkuX2JvdHRvbVJhZGl1czsKICAgICAgICBjb25zdCBzbGljZXMgPSBjeWxpbmRlckdlb21ldHJ5Ll9zbGljZXM7CiAgICAgICAgY29uc3QgbnVtYmVyT2ZWZXJ0aWNhbExpbmVzID0gY3lsaW5kZXJHZW9tZXRyeS5fbnVtYmVyT2ZWZXJ0aWNhbExpbmVzOwogICAgICAgIGlmIChsZW5ndGggPD0gMCB8fCB0b3BSYWRpdXMgPCAwIHx8IGJvdHRvbVJhZGl1cyA8IDAgfHwgdG9wUmFkaXVzID09PSAwICYmIGJvdHRvbVJhZGl1cyA9PT0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBudW1WZXJ0aWNlcyA9IHNsaWNlcyAqIDI7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gQ3lsaW5kZXJHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb25zKAogICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgdG9wUmFkaXVzLAogICAgICAgICAgYm90dG9tUmFkaXVzLAogICAgICAgICAgc2xpY2VzLAogICAgICAgICAgZmFsc2UKICAgICAgICApOwogICAgICAgIGxldCBudW1JbmRpY2VzID0gc2xpY2VzICogMjsKICAgICAgICBsZXQgbnVtU2lkZTsKICAgICAgICBpZiAobnVtYmVyT2ZWZXJ0aWNhbExpbmVzID4gMCkgewogICAgICAgICAgY29uc3QgbnVtU2lkZUxpbmVzID0gTWF0aC5taW4obnVtYmVyT2ZWZXJ0aWNhbExpbmVzLCBzbGljZXMpOwogICAgICAgICAgbnVtU2lkZSA9IE1hdGgucm91bmQoc2xpY2VzIC8gbnVtU2lkZUxpbmVzKTsKICAgICAgICAgIG51bUluZGljZXMgKz0gbnVtU2lkZUxpbmVzOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobnVtVmVydGljZXMsIG51bUluZGljZXMgKiAyKTsKICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGxldCBpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzbGljZXMgLSAxOyBpKyspIHsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGkgKyAxOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGkgKyBzbGljZXM7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaSArIDEgKyBzbGljZXM7CiAgICAgICAgfQogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBzbGljZXMgLSAxOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSAwOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBzbGljZXMgKyBzbGljZXMgLSAxOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBzbGljZXM7CiAgICAgICAgaWYgKG51bWJlck9mVmVydGljYWxMaW5lcyA+IDApIHsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzbGljZXM7IGkgKz0gbnVtU2lkZSkgewogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaTsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGkgKyBzbGljZXM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoKTsKICAgICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgIHZhbHVlczogcG9zaXRpb25zCiAgICAgICAgfSk7CiAgICAgICAgcmFkaXVzU2NyYXRjaDIueCA9IGxlbmd0aCAqIDAuNTsKICAgICAgICByYWRpdXNTY3JhdGNoMi55ID0gTWF0aC5tYXgoYm90dG9tUmFkaXVzLCB0b3BSYWRpdXMpOwogICAgICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlID0gbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywKICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5tYWduaXR1ZGUocmFkaXVzU2NyYXRjaDIpCiAgICAgICAgKTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGN5bGluZGVyR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgIGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IGN5bGluZGVyR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5OT05FID8gMCA6IDE7CiAgICAgICAgICBjb25zdCBhcHBseU9mZnNldCA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCAvIDMpLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICAgICAgYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBjeWxpbmRlckdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IEN5bGluZGVyT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVDeWxpbmRlck91dGxpbmVHZW9tZXRyeShjeWxpbmRlckdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBjeWxpbmRlckdlb21ldHJ5ID0gQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soY3lsaW5kZXJHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHJldHVybiBDeWxpbmRlck91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KGN5bGluZGVyR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVDeWxpbmRlck91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0N5bGluZGVyT3V0bGluZUdlb21ldHJ5KCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBjcmVhdGVDeWxpbmRlck91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVFbGxpcHNlR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlRWxsaXBzZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVFbGxpcHNlR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlRWxsaXBzZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVFbGxpcHNlR2VvbWV0cnkoZWxsaXBzZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBlbGxpcHNlR2VvbWV0cnkgPSBFbGxpcHNlR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soZWxsaXBzZUdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIpOwogICAgZWxsaXBzZUdlb21ldHJ5Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZCk7CiAgICByZXR1cm4gRWxsaXBzZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoZWxsaXBzZUdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZUVsbGlwc2VHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUVsbGlwc2VHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlRWxsaXBzZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc2VHZW9tZXRyeSgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBjcmVhdGVFbGxpcHNlR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZUVsbGlwc2VHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUVsbGlwc2VPdXRsaW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlRWxsaXBzZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlRWxsaXBzZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5KGVsbGlwc2VHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgZWxsaXBzZUdlb21ldHJ5ID0gRWxsaXBzZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhlbGxpcHNlR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICBlbGxpcHNlR2VvbWV0cnkuX2NlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShlbGxpcHNlR2VvbWV0cnkuX2NlbnRlcik7CiAgICBlbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc2VHZW9tZXRyeS5fZWxsaXBzb2lkKTsKICAgIHJldHVybiBFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoZWxsaXBzZUdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZUVsbGlwc2VPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc2VPdXRsaW5lR2VvbWV0cnkoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgY3JlYXRlRWxsaXBzZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlRWxsaXBzZU91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc29pZEdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gRWxsaXBzb2lkR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCByYWRpaSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMucmFkaWksIGRlZmF1bHRSYWRpaSk7CiAgICBjb25zdCBpbm5lclJhZGlpID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5pbm5lclJhZGlpLCByYWRpaSk7CiAgICBjb25zdCBtaW5pbXVtQ2xvY2sgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm1pbmltdW1DbG9jaywgMCk7CiAgICBjb25zdCBtYXhpbXVtQ2xvY2sgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm1heGltdW1DbG9jaywgTWF0aF9kZWZhdWx0LlRXT19QSSk7CiAgICBjb25zdCBtaW5pbXVtQ29uZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWluaW11bUNvbmUsIDApOwogICAgY29uc3QgbWF4aW11bUNvbmUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm1heGltdW1Db25lLCBNYXRoX2RlZmF1bHQuUEkpOwogICAgY29uc3Qgc3RhY2tQYXJ0aXRpb25zID0gTWF0aC5yb3VuZChkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnN0YWNrUGFydGl0aW9ucywgNjQpKTsKICAgIGNvbnN0IHNsaWNlUGFydGl0aW9ucyA9IE1hdGgucm91bmQoZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zbGljZVBhcnRpdGlvbnMsIDY0KSk7CiAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnZlcnRleEZvcm1hdCwgVmVydGV4Rm9ybWF0X2RlZmF1bHQuREVGQVVMVCk7CiAgICBpZiAoc2xpY2VQYXJ0aXRpb25zIDwgMykgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAib3B0aW9ucy5zbGljZVBhcnRpdGlvbnMgY2Fubm90IGJlIGxlc3MgdGhhbiB0aHJlZS4iCiAgICAgICk7CiAgICB9CiAgICBpZiAoc3RhY2tQYXJ0aXRpb25zIDwgMykgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAib3B0aW9ucy5zdGFja1BhcnRpdGlvbnMgY2Fubm90IGJlIGxlc3MgdGhhbiB0aHJlZS4iCiAgICAgICk7CiAgICB9CiAgICB0aGlzLl9yYWRpaSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShyYWRpaSk7CiAgICB0aGlzLl9pbm5lclJhZGlpID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGlubmVyUmFkaWkpOwogICAgdGhpcy5fbWluaW11bUNsb2NrID0gbWluaW11bUNsb2NrOwogICAgdGhpcy5fbWF4aW11bUNsb2NrID0gbWF4aW11bUNsb2NrOwogICAgdGhpcy5fbWluaW11bUNvbmUgPSBtaW5pbXVtQ29uZTsKICAgIHRoaXMuX21heGltdW1Db25lID0gbWF4aW11bUNvbmU7CiAgICB0aGlzLl9zdGFja1BhcnRpdGlvbnMgPSBzdGFja1BhcnRpdGlvbnM7CiAgICB0aGlzLl9zbGljZVBhcnRpdGlvbnMgPSBzbGljZVBhcnRpdGlvbnM7CiAgICB0aGlzLl92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSh2ZXJ0ZXhGb3JtYXQpOwogICAgdGhpcy5fb2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUVsbGlwc29pZEdlb21ldHJ5IjsKICB9CiAgdmFyIHNjcmF0Y2hQb3NpdGlvbjIsIHNjcmF0Y2hOb3JtYWw1LCBzY3JhdGNoVGFuZ2VudDMsIHNjcmF0Y2hCaXRhbmdlbnQzLCBzY3JhdGNoTm9ybWFsU1QsIGRlZmF1bHRSYWRpaSwgY29zLCBzaW4sIHNjcmF0Y2hSYWRpaSwgc2NyYXRjaElubmVyUmFkaWksIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ2LCBzY3JhdGNoT3B0aW9uczEzLCB1bml0RWxsaXBzb2lkR2VvbWV0cnksIEVsbGlwc29pZEdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfRWxsaXBzb2lkR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc29pZEdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgc2NyYXRjaFBvc2l0aW9uMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE5vcm1hbDUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hUYW5nZW50MyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEJpdGFuZ2VudDMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hOb3JtYWxTVCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZGVmYXVsdFJhZGlpID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgxLCAxLCAxKTsKICAgICAgY29zID0gTWF0aC5jb3M7CiAgICAgIHNpbiA9IE1hdGguc2luOwogICAgICBFbGxpcHNvaWRHZW9tZXRyeS5wYWNrZWRMZW5ndGggPSAyICogQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCArIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDc7CiAgICAgIEVsbGlwc29pZEdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2YWx1ZSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmFsdWUuX3JhZGlpLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZhbHVlLl9pbm5lclJhZGlpLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2sodmFsdWUuX3ZlcnRleEZvcm1hdCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fbWluaW11bUNsb2NrOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fbWF4aW11bUNsb2NrOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fbWluaW11bUNvbmU7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9tYXhpbXVtQ29uZTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3N0YWNrUGFydGl0aW9uczsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3NsaWNlUGFydGl0aW9uczsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHZhbHVlLl9vZmZzZXRBdHRyaWJ1dGUsIC0xKTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hSYWRpaSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaElubmVyUmFkaWkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ2ID0gbmV3IFZlcnRleEZvcm1hdF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hPcHRpb25zMTMgPSB7CiAgICAgICAgcmFkaWk6IHNjcmF0Y2hSYWRpaSwKICAgICAgICBpbm5lclJhZGlpOiBzY3JhdGNoSW5uZXJSYWRpaSwKICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ2LAogICAgICAgIG1pbmltdW1DbG9jazogdm9pZCAwLAogICAgICAgIG1heGltdW1DbG9jazogdm9pZCAwLAogICAgICAgIG1pbmltdW1Db25lOiB2b2lkIDAsCiAgICAgICAgbWF4aW11bUNvbmU6IHZvaWQgMCwKICAgICAgICBzdGFja1BhcnRpdGlvbnM6IHZvaWQgMCwKICAgICAgICBzbGljZVBhcnRpdGlvbnM6IHZvaWQgMCwKICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHZvaWQgMAogICAgICB9OwogICAgICBFbGxpcHNvaWRHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IHJhZGlpID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaFJhZGlpKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgaW5uZXJSYWRpaSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hJbm5lclJhZGlpKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDYKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IG1pbmltdW1DbG9jayA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgbWF4aW11bUNsb2NrID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBtaW5pbXVtQ29uZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgbWF4aW11bUNvbmUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHN0YWNrUGFydGl0aW9ucyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgc2xpY2VQYXJ0aXRpb25zID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBvZmZzZXRBdHRyaWJ1dGUgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEzLm1pbmltdW1DbG9jayA9IG1pbmltdW1DbG9jazsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTMubWF4aW11bUNsb2NrID0gbWF4aW11bUNsb2NrOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMy5taW5pbXVtQ29uZSA9IG1pbmltdW1Db25lOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMy5tYXhpbXVtQ29uZSA9IG1heGltdW1Db25lOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMy5zdGFja1BhcnRpdGlvbnMgPSBzdGFja1BhcnRpdGlvbnM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEzLnNsaWNlUGFydGl0aW9ucyA9IHNsaWNlUGFydGl0aW9uczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTMub2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIHJldHVybiBuZXcgRWxsaXBzb2lkR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnMxMyk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcmFkaWkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocmFkaWksIHJlc3VsdC5fcmFkaWkpOwogICAgICAgIHJlc3VsdC5faW5uZXJSYWRpaSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShpbm5lclJhZGlpLCByZXN1bHQuX2lubmVyUmFkaWkpOwogICAgICAgIHJlc3VsdC5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0LCByZXN1bHQuX3ZlcnRleEZvcm1hdCk7CiAgICAgICAgcmVzdWx0Ll9taW5pbXVtQ2xvY2sgPSBtaW5pbXVtQ2xvY2s7CiAgICAgICAgcmVzdWx0Ll9tYXhpbXVtQ2xvY2sgPSBtYXhpbXVtQ2xvY2s7CiAgICAgICAgcmVzdWx0Ll9taW5pbXVtQ29uZSA9IG1pbmltdW1Db25lOwogICAgICAgIHJlc3VsdC5fbWF4aW11bUNvbmUgPSBtYXhpbXVtQ29uZTsKICAgICAgICByZXN1bHQuX3N0YWNrUGFydGl0aW9ucyA9IHN0YWNrUGFydGl0aW9uczsKICAgICAgICByZXN1bHQuX3NsaWNlUGFydGl0aW9ucyA9IHNsaWNlUGFydGl0aW9uczsKICAgICAgICByZXN1bHQuX29mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihlbGxpcHNvaWRHZW9tZXRyeSkgewogICAgICAgIGNvbnN0IHJhZGlpID0gZWxsaXBzb2lkR2VvbWV0cnkuX3JhZGlpOwogICAgICAgIGlmIChyYWRpaS54IDw9IDAgfHwgcmFkaWkueSA8PSAwIHx8IHJhZGlpLnogPD0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbm5lclJhZGlpID0gZWxsaXBzb2lkR2VvbWV0cnkuX2lubmVyUmFkaWk7CiAgICAgICAgaWYgKGlubmVyUmFkaWkueCA8PSAwIHx8IGlubmVyUmFkaWkueSA8PSAwIHx8IGlubmVyUmFkaWkueiA8PSAwKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IG1pbmltdW1DbG9jayA9IGVsbGlwc29pZEdlb21ldHJ5Ll9taW5pbXVtQ2xvY2s7CiAgICAgICAgY29uc3QgbWF4aW11bUNsb2NrID0gZWxsaXBzb2lkR2VvbWV0cnkuX21heGltdW1DbG9jazsKICAgICAgICBjb25zdCBtaW5pbXVtQ29uZSA9IGVsbGlwc29pZEdlb21ldHJ5Ll9taW5pbXVtQ29uZTsKICAgICAgICBjb25zdCBtYXhpbXVtQ29uZSA9IGVsbGlwc29pZEdlb21ldHJ5Ll9tYXhpbXVtQ29uZTsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBlbGxpcHNvaWRHZW9tZXRyeS5fdmVydGV4Rm9ybWF0OwogICAgICAgIGxldCBzbGljZVBhcnRpdGlvbnMgPSBlbGxpcHNvaWRHZW9tZXRyeS5fc2xpY2VQYXJ0aXRpb25zICsgMTsKICAgICAgICBsZXQgc3RhY2tQYXJ0aXRpb25zID0gZWxsaXBzb2lkR2VvbWV0cnkuX3N0YWNrUGFydGl0aW9ucyArIDE7CiAgICAgICAgc2xpY2VQYXJ0aXRpb25zID0gTWF0aC5yb3VuZCgKICAgICAgICAgIHNsaWNlUGFydGl0aW9ucyAqIE1hdGguYWJzKG1heGltdW1DbG9jayAtIG1pbmltdW1DbG9jaykgLyBNYXRoX2RlZmF1bHQuVFdPX1BJCiAgICAgICAgKTsKICAgICAgICBzdGFja1BhcnRpdGlvbnMgPSBNYXRoLnJvdW5kKAogICAgICAgICAgc3RhY2tQYXJ0aXRpb25zICogTWF0aC5hYnMobWF4aW11bUNvbmUgLSBtaW5pbXVtQ29uZSkgLyBNYXRoX2RlZmF1bHQuUEkKICAgICAgICApOwogICAgICAgIGlmIChzbGljZVBhcnRpdGlvbnMgPCAyKSB7CiAgICAgICAgICBzbGljZVBhcnRpdGlvbnMgPSAyOwogICAgICAgIH0KICAgICAgICBpZiAoc3RhY2tQYXJ0aXRpb25zIDwgMikgewogICAgICAgICAgc3RhY2tQYXJ0aXRpb25zID0gMjsKICAgICAgICB9CiAgICAgICAgbGV0IGk7CiAgICAgICAgbGV0IGo7CiAgICAgICAgbGV0IGluZGV4ID0gMDsKICAgICAgICBjb25zdCBwaGlzID0gW21pbmltdW1Db25lXTsKICAgICAgICBjb25zdCB0aGV0YXMgPSBbbWluaW11bUNsb2NrXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc3RhY2tQYXJ0aXRpb25zOyBpKyspIHsKICAgICAgICAgIHBoaXMucHVzaCgKICAgICAgICAgICAgbWluaW11bUNvbmUgKyBpICogKG1heGltdW1Db25lIC0gbWluaW11bUNvbmUpIC8gKHN0YWNrUGFydGl0aW9ucyAtIDEpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBwaGlzLnB1c2gobWF4aW11bUNvbmUpOwogICAgICAgIGZvciAoaiA9IDA7IGogPCBzbGljZVBhcnRpdGlvbnM7IGorKykgewogICAgICAgICAgdGhldGFzLnB1c2goCiAgICAgICAgICAgIG1pbmltdW1DbG9jayArIGogKiAobWF4aW11bUNsb2NrIC0gbWluaW11bUNsb2NrKSAvIChzbGljZVBhcnRpdGlvbnMgLSAxKQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgdGhldGFzLnB1c2gobWF4aW11bUNsb2NrKTsKICAgICAgICBjb25zdCBudW1QaGlzID0gcGhpcy5sZW5ndGg7CiAgICAgICAgY29uc3QgbnVtVGhldGFzID0gdGhldGFzLmxlbmd0aDsKICAgICAgICBsZXQgZXh0cmFJbmRpY2VzID0gMDsKICAgICAgICBsZXQgdmVydGV4TXVsdGlwbGllciA9IDE7CiAgICAgICAgY29uc3QgaGFzSW5uZXJTdXJmYWNlID0gaW5uZXJSYWRpaS54ICE9PSByYWRpaS54IHx8IGlubmVyUmFkaWkueSAhPT0gcmFkaWkueSB8fCBpbm5lclJhZGlpLnogIT09IHJhZGlpLno7CiAgICAgICAgbGV0IGlzVG9wT3BlbiA9IGZhbHNlOwogICAgICAgIGxldCBpc0JvdE9wZW4gPSBmYWxzZTsKICAgICAgICBsZXQgaXNDbG9ja09wZW4gPSBmYWxzZTsKICAgICAgICBpZiAoaGFzSW5uZXJTdXJmYWNlKSB7CiAgICAgICAgICB2ZXJ0ZXhNdWx0aXBsaWVyID0gMjsKICAgICAgICAgIGlmIChtaW5pbXVtQ29uZSA+IDApIHsKICAgICAgICAgICAgaXNUb3BPcGVuID0gdHJ1ZTsKICAgICAgICAgICAgZXh0cmFJbmRpY2VzICs9IHNsaWNlUGFydGl0aW9ucyAtIDE7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobWF4aW11bUNvbmUgPCBNYXRoLlBJKSB7CiAgICAgICAgICAgIGlzQm90T3BlbiA9IHRydWU7CiAgICAgICAgICAgIGV4dHJhSW5kaWNlcyArPSBzbGljZVBhcnRpdGlvbnMgLSAxOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChtYXhpbXVtQ2xvY2sgLSBtaW5pbXVtQ2xvY2spICUgTWF0aF9kZWZhdWx0LlRXT19QSSkgewogICAgICAgICAgICBpc0Nsb2NrT3BlbiA9IHRydWU7CiAgICAgICAgICAgIGV4dHJhSW5kaWNlcyArPSAoc3RhY2tQYXJ0aXRpb25zIC0gMSkgKiAyICsgMTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGV4dHJhSW5kaWNlcyArPSAxOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCB2ZXJ0ZXhDb3VudCA9IG51bVRoZXRhcyAqIG51bVBoaXMgKiB2ZXJ0ZXhNdWx0aXBsaWVyOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkodmVydGV4Q291bnQgKiAzKTsKICAgICAgICBjb25zdCBpc0lubmVyID0gbmV3IEFycmF5KHZlcnRleENvdW50KS5maWxsKGZhbHNlKTsKICAgICAgICBjb25zdCBuZWdhdGVOb3JtYWwgPSBuZXcgQXJyYXkodmVydGV4Q291bnQpLmZpbGwoZmFsc2UpOwogICAgICAgIGNvbnN0IGluZGV4Q291bnQgPSBzbGljZVBhcnRpdGlvbnMgKiBzdGFja1BhcnRpdGlvbnMgKiB2ZXJ0ZXhNdWx0aXBsaWVyOwogICAgICAgIGNvbnN0IG51bUluZGljZXMgPSA2ICogKGluZGV4Q291bnQgKyBleHRyYUluZGljZXMgKyAxIC0gKHNsaWNlUGFydGl0aW9ucyArIHN0YWNrUGFydGl0aW9ucykgKiB2ZXJ0ZXhNdWx0aXBsaWVyKTsKICAgICAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoaW5kZXhDb3VudCwgbnVtSW5kaWNlcyk7CiAgICAgICAgY29uc3Qgbm9ybWFscyA9IHZlcnRleEZvcm1hdC5ub3JtYWwgPyBuZXcgRmxvYXQzMkFycmF5KHZlcnRleENvdW50ICogMykgOiB2b2lkIDA7CiAgICAgICAgY29uc3QgdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkodmVydGV4Q291bnQgKiAzKSA6IHZvaWQgMDsKICAgICAgICBjb25zdCBiaXRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkodmVydGV4Q291bnQgKiAzKSA6IHZvaWQgMDsKICAgICAgICBjb25zdCBzdCA9IHZlcnRleEZvcm1hdC5zdCA/IG5ldyBGbG9hdDMyQXJyYXkodmVydGV4Q291bnQgKiAyKSA6IHZvaWQgMDsKICAgICAgICBjb25zdCBzaW5QaGkgPSBuZXcgQXJyYXkobnVtUGhpcyk7CiAgICAgICAgY29uc3QgY29zUGhpID0gbmV3IEFycmF5KG51bVBoaXMpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1QaGlzOyBpKyspIHsKICAgICAgICAgIHNpblBoaVtpXSA9IHNpbihwaGlzW2ldKTsKICAgICAgICAgIGNvc1BoaVtpXSA9IGNvcyhwaGlzW2ldKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc2luVGhldGEgPSBuZXcgQXJyYXkobnVtVGhldGFzKTsKICAgICAgICBjb25zdCBjb3NUaGV0YSA9IG5ldyBBcnJheShudW1UaGV0YXMpOwogICAgICAgIGZvciAoaiA9IDA7IGogPCBudW1UaGV0YXM7IGorKykgewogICAgICAgICAgY29zVGhldGFbal0gPSBjb3ModGhldGFzW2pdKTsKICAgICAgICAgIHNpblRoZXRhW2pdID0gc2luKHRoZXRhc1tqXSk7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1QaGlzOyBpKyspIHsKICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBudW1UaGV0YXM7IGorKykgewogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSByYWRpaS54ICogc2luUGhpW2ldICogY29zVGhldGFbal07CiAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IHJhZGlpLnkgKiBzaW5QaGlbaV0gKiBzaW5UaGV0YVtqXTsKICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gcmFkaWkueiAqIGNvc1BoaVtpXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGV0IHZlcnRleEluZGV4ID0gdmVydGV4Q291bnQgLyAyOwogICAgICAgIGlmIChoYXNJbm5lclN1cmZhY2UpIHsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1QaGlzOyBpKyspIHsKICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IG51bVRoZXRhczsgaisrKSB7CiAgICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gaW5uZXJSYWRpaS54ICogc2luUGhpW2ldICogY29zVGhldGFbal07CiAgICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gaW5uZXJSYWRpaS55ICogc2luUGhpW2ldICogc2luVGhldGFbal07CiAgICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gaW5uZXJSYWRpaS56ICogY29zUGhpW2ldOwogICAgICAgICAgICAgIGlzSW5uZXJbdmVydGV4SW5kZXhdID0gdHJ1ZTsKICAgICAgICAgICAgICBpZiAoaSA+IDAgJiYgaSAhPT0gbnVtUGhpcyAtIDEgJiYgaiAhPT0gMCAmJiBqICE9PSBudW1UaGV0YXMgLSAxKSB7CiAgICAgICAgICAgICAgICBuZWdhdGVOb3JtYWxbdmVydGV4SW5kZXhdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmVydGV4SW5kZXgrKzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpbmRleCA9IDA7CiAgICAgICAgbGV0IHRvcE9mZnNldDsKICAgICAgICBsZXQgYm90dG9tT2Zmc2V0OwogICAgICAgIGZvciAoaSA9IDE7IGkgPCBudW1QaGlzIC0gMjsgaSsrKSB7CiAgICAgICAgICB0b3BPZmZzZXQgPSBpICogbnVtVGhldGFzOwogICAgICAgICAgYm90dG9tT2Zmc2V0ID0gKGkgKyAxKSAqIG51bVRoZXRhczsKICAgICAgICAgIGZvciAoaiA9IDE7IGogPCBudW1UaGV0YXMgLSAyOyBqKyspIHsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGJvdHRvbU9mZnNldCArIGo7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBib3R0b21PZmZzZXQgKyBqICsgMTsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHRvcE9mZnNldCArIGogKyAxOwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gYm90dG9tT2Zmc2V0ICsgajsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHRvcE9mZnNldCArIGogKyAxOwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdG9wT2Zmc2V0ICsgajsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGhhc0lubmVyU3VyZmFjZSkgewogICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gbnVtUGhpcyAqIG51bVRoZXRhczsKICAgICAgICAgIGZvciAoaSA9IDE7IGkgPCBudW1QaGlzIC0gMjsgaSsrKSB7CiAgICAgICAgICAgIHRvcE9mZnNldCA9IG9mZnNldCArIGkgKiBudW1UaGV0YXM7CiAgICAgICAgICAgIGJvdHRvbU9mZnNldCA9IG9mZnNldCArIChpICsgMSkgKiBudW1UaGV0YXM7CiAgICAgICAgICAgIGZvciAoaiA9IDE7IGogPCBudW1UaGV0YXMgLSAyOyBqKyspIHsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gYm90dG9tT2Zmc2V0ICsgajsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdG9wT2Zmc2V0ICsgajsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdG9wT2Zmc2V0ICsgaiArIDE7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGJvdHRvbU9mZnNldCArIGo7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHRvcE9mZnNldCArIGogKyAxOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBib3R0b21PZmZzZXQgKyBqICsgMTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBsZXQgb3V0ZXJPZmZzZXQ7CiAgICAgICAgbGV0IGlubmVyT2Zmc2V0OwogICAgICAgIGlmIChoYXNJbm5lclN1cmZhY2UpIHsKICAgICAgICAgIGlmIChpc1RvcE9wZW4pIHsKICAgICAgICAgICAgaW5uZXJPZmZzZXQgPSBudW1QaGlzICogbnVtVGhldGFzOwogICAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbnVtVGhldGFzIC0gMjsgaSsrKSB7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGk7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGkgKyAxOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpbm5lck9mZnNldCArIGkgKyAxOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpbm5lck9mZnNldCArIGkgKyAxOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpbm5lck9mZnNldCArIGk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0JvdE9wZW4pIHsKICAgICAgICAgICAgb3V0ZXJPZmZzZXQgPSBudW1QaGlzICogbnVtVGhldGFzIC0gbnVtVGhldGFzOwogICAgICAgICAgICBpbm5lck9mZnNldCA9IG51bVBoaXMgKiBudW1UaGV0YXMgKiB2ZXJ0ZXhNdWx0aXBsaWVyIC0gbnVtVGhldGFzOwogICAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbnVtVGhldGFzIC0gMjsgaSsrKSB7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IG91dGVyT2Zmc2V0ICsgaSArIDE7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IG91dGVyT2Zmc2V0ICsgaTsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaW5uZXJPZmZzZXQgKyBpOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBvdXRlck9mZnNldCArIGkgKyAxOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpbm5lck9mZnNldCArIGk7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGlubmVyT2Zmc2V0ICsgaSArIDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGlzQ2xvY2tPcGVuKSB7CiAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbnVtUGhpcyAtIDI7IGkrKykgewogICAgICAgICAgICBpbm5lck9mZnNldCA9IG51bVRoZXRhcyAqIG51bVBoaXMgKyBudW1UaGV0YXMgKiBpOwogICAgICAgICAgICBvdXRlck9mZnNldCA9IG51bVRoZXRhcyAqIGk7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpbm5lck9mZnNldDsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IG91dGVyT2Zmc2V0ICsgbnVtVGhldGFzOwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gb3V0ZXJPZmZzZXQ7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpbm5lck9mZnNldDsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGlubmVyT2Zmc2V0ICsgbnVtVGhldGFzOwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gb3V0ZXJPZmZzZXQgKyBudW1UaGV0YXM7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbnVtUGhpcyAtIDI7IGkrKykgewogICAgICAgICAgICBpbm5lck9mZnNldCA9IG51bVRoZXRhcyAqIG51bVBoaXMgKyBudW1UaGV0YXMgKiAoaSArIDEpIC0gMTsKICAgICAgICAgICAgb3V0ZXJPZmZzZXQgPSBudW1UaGV0YXMgKiAoaSArIDEpIC0gMTsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IG91dGVyT2Zmc2V0ICsgbnVtVGhldGFzOwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaW5uZXJPZmZzZXQ7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBvdXRlck9mZnNldDsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IG91dGVyT2Zmc2V0ICsgbnVtVGhldGFzOwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaW5uZXJPZmZzZXQgKyBudW1UaGV0YXM7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpbm5lck9mZnNldDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpOwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQucG9zaXRpb24pIHsKICAgICAgICAgIGF0dHJpYnV0ZXMucG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgdmFsdWVzOiBwb3NpdGlvbnMKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBsZXQgc3RJbmRleCA9IDA7CiAgICAgICAgbGV0IG5vcm1hbEluZGV4ID0gMDsKICAgICAgICBsZXQgdGFuZ2VudEluZGV4ID0gMDsKICAgICAgICBsZXQgYml0YW5nZW50SW5kZXggPSAwOwogICAgICAgIGNvbnN0IHZlcnRleENvdW50SGFsZiA9IHZlcnRleENvdW50IC8gMjsKICAgICAgICBsZXQgZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IGVsbGlwc29pZE91dGVyID0gRWxsaXBzb2lkX2RlZmF1bHQuZnJvbUNhcnRlc2lhbjMocmFkaWkpOwogICAgICAgIGNvbnN0IGVsbGlwc29pZElubmVyID0gRWxsaXBzb2lkX2RlZmF1bHQuZnJvbUNhcnRlc2lhbjMoaW5uZXJSYWRpaSk7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCB8fCB2ZXJ0ZXhGb3JtYXQubm9ybWFsIHx8IHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB2ZXJ0ZXhDb3VudDsgaSsrKSB7CiAgICAgICAgICAgIGVsbGlwc29pZCA9IGlzSW5uZXJbaV0gPyBlbGxpcHNvaWRJbm5lciA6IGVsbGlwc29pZE91dGVyOwogICAgICAgICAgICBjb25zdCBwb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpICogMywgc2NyYXRjaFBvc2l0aW9uMik7CiAgICAgICAgICAgIGNvbnN0IG5vcm1hbDIgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHBvc2l0aW9uLCBzY3JhdGNoTm9ybWFsNSk7CiAgICAgICAgICAgIGlmIChuZWdhdGVOb3JtYWxbaV0pIHsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgICAgICBjb25zdCBub3JtYWxTVCA9IENhcnRlc2lhbjJfZGVmYXVsdC5uZWdhdGUobm9ybWFsMiwgc2NyYXRjaE5vcm1hbFNUKTsKICAgICAgICAgICAgICBzdFtzdEluZGV4KytdID0gTWF0aC5hdGFuMihub3JtYWxTVC55LCBub3JtYWxTVC54KSAvIE1hdGhfZGVmYXVsdC5UV09fUEkgKyAwLjU7CiAgICAgICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IE1hdGguYXNpbihub3JtYWwyLnopIC8gTWF0aC5QSSArIDAuNTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLng7CiAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueTsKICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi56OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgICAgY29uc3QgdGFuZ2VudCA9IHNjcmF0Y2hUYW5nZW50MzsKICAgICAgICAgICAgICBsZXQgdGFuZ2V0T2Zmc2V0ID0gMDsKICAgICAgICAgICAgICBsZXQgdW5pdDsKICAgICAgICAgICAgICBpZiAoaXNJbm5lcltpXSkgewogICAgICAgICAgICAgICAgdGFuZ2V0T2Zmc2V0ID0gdmVydGV4Q291bnRIYWxmOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWlzVG9wT3BlbiAmJiBpID49IHRhbmdldE9mZnNldCAmJiBpIDwgdGFuZ2V0T2Zmc2V0ICsgbnVtVGhldGFzICogMikgewogICAgICAgICAgICAgICAgdW5pdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1g7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHVuaXQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9aOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3ModW5pdCwgbm9ybWFsMiwgdGFuZ2VudCk7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSh0YW5nZW50LCB0YW5nZW50KTsKICAgICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueDsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueTsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQuejsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJpdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhub3JtYWwyLCB0YW5nZW50LCBzY3JhdGNoQml0YW5nZW50Myk7CiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGJpdGFuZ2VudCwgYml0YW5nZW50KTsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQueDsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQueTsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQuejsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgICAgYXR0cmlidXRlcy5zdCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgICAgICAgIHZhbHVlczogc3QKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgICAgICBhdHRyaWJ1dGVzLm5vcm1hbCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICAgIHZhbHVlczogbm9ybWFscwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgICBhdHRyaWJ1dGVzLnRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IHRhbmdlbnRzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgYXR0cmlidXRlcy5iaXRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IGJpdGFuZ2VudHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZWxsaXBzb2lkR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IGVsbGlwc29pZEdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgY29uc3QgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGggLyAzKS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgICAgIGF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgIHZhbHVlczogYXBwbHlPZmZzZXQKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbUVsbGlwc29pZChlbGxpcHNvaWRPdXRlciksCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IGVsbGlwc29pZEdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkR2VvbWV0cnkuZ2V0VW5pdEVsbGlwc29pZCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHVuaXRFbGxpcHNvaWRHZW9tZXRyeSkpIHsKICAgICAgICAgIHVuaXRFbGxpcHNvaWRHZW9tZXRyeSA9IEVsbGlwc29pZEdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5KAogICAgICAgICAgICBuZXcgRWxsaXBzb2lkR2VvbWV0cnkoewogICAgICAgICAgICAgIHJhZGlpOiBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KDEsIDEsIDEpLAogICAgICAgICAgICAgIHZlcnRleEZvcm1hdDogVmVydGV4Rm9ybWF0X2RlZmF1bHQuUE9TSVRJT05fT05MWQogICAgICAgICAgICB9KQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVuaXRFbGxpcHNvaWRHZW9tZXRyeTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkR2VvbWV0cnlfZGVmYXVsdCA9IEVsbGlwc29pZEdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlRWxsaXBzb2lkR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlRWxsaXBzb2lkR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZUVsbGlwc29pZEdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUVsbGlwc29pZEdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVFbGxpcHNvaWRHZW9tZXRyeShlbGxpcHNvaWRHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgZWxsaXBzb2lkR2VvbWV0cnkgPSBFbGxpcHNvaWRHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhlbGxpcHNvaWRHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHJldHVybiBFbGxpcHNvaWRHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KGVsbGlwc29pZEdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZUVsbGlwc29pZEdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlRWxsaXBzb2lkR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUVsbGlwc29pZEdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkR2VvbWV0cnkoKTsKICAgICAgY3JlYXRlRWxsaXBzb2lkR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZUVsbGlwc29pZEdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgcmFkaWkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnJhZGlpLCBkZWZhdWx0UmFkaWkyKTsKICAgIGNvbnN0IGlubmVyUmFkaWkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmlubmVyUmFkaWksIHJhZGlpKTsKICAgIGNvbnN0IG1pbmltdW1DbG9jayA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWluaW11bUNsb2NrLCAwKTsKICAgIGNvbnN0IG1heGltdW1DbG9jayA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWF4aW11bUNsb2NrLCBNYXRoX2RlZmF1bHQuVFdPX1BJKTsKICAgIGNvbnN0IG1pbmltdW1Db25lID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5taW5pbXVtQ29uZSwgMCk7CiAgICBjb25zdCBtYXhpbXVtQ29uZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWF4aW11bUNvbmUsIE1hdGhfZGVmYXVsdC5QSSk7CiAgICBjb25zdCBzdGFja1BhcnRpdGlvbnMgPSBNYXRoLnJvdW5kKGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuc3RhY2tQYXJ0aXRpb25zLCAxMCkpOwogICAgY29uc3Qgc2xpY2VQYXJ0aXRpb25zID0gTWF0aC5yb3VuZChkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnNsaWNlUGFydGl0aW9ucywgOCkpOwogICAgY29uc3Qgc3ViZGl2aXNpb25zID0gTWF0aC5yb3VuZChkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnN1YmRpdmlzaW9ucywgMTI4KSk7CiAgICBpZiAoc3RhY2tQYXJ0aXRpb25zIDwgMSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5zdGFja1BhcnRpdGlvbnMgY2Fubm90IGJlIGxlc3MgdGhhbiAxIik7CiAgICB9CiAgICBpZiAoc2xpY2VQYXJ0aXRpb25zIDwgMCkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5zbGljZVBhcnRpdGlvbnMgY2Fubm90IGJlIGxlc3MgdGhhbiAwIik7CiAgICB9CiAgICBpZiAoc3ViZGl2aXNpb25zIDwgMCkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAib3B0aW9ucy5zdWJkaXZpc2lvbnMgbXVzdCBiZSBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8gemVyby4iCiAgICAgICk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlKSAmJiBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5UT1ApIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIkdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlLlRPUCBpcyBub3QgYSBzdXBwb3J0ZWQgb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgZm9yIHRoaXMgZ2VvbWV0cnkuIgogICAgICApOwogICAgfQogICAgdGhpcy5fcmFkaWkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocmFkaWkpOwogICAgdGhpcy5faW5uZXJSYWRpaSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShpbm5lclJhZGlpKTsKICAgIHRoaXMuX21pbmltdW1DbG9jayA9IG1pbmltdW1DbG9jazsKICAgIHRoaXMuX21heGltdW1DbG9jayA9IG1heGltdW1DbG9jazsKICAgIHRoaXMuX21pbmltdW1Db25lID0gbWluaW11bUNvbmU7CiAgICB0aGlzLl9tYXhpbXVtQ29uZSA9IG1heGltdW1Db25lOwogICAgdGhpcy5fc3RhY2tQYXJ0aXRpb25zID0gc3RhY2tQYXJ0aXRpb25zOwogICAgdGhpcy5fc2xpY2VQYXJ0aXRpb25zID0gc2xpY2VQYXJ0aXRpb25zOwogICAgdGhpcy5fc3ViZGl2aXNpb25zID0gc3ViZGl2aXNpb25zOwogICAgdGhpcy5fb2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeSI7CiAgfQogIHZhciBkZWZhdWx0UmFkaWkyLCBjb3MyLCBzaW4yLCBzY3JhdGNoUmFkaWkyLCBzY3JhdGNoSW5uZXJSYWRpaTIsIHNjcmF0Y2hPcHRpb25zMTQsIEVsbGlwc29pZE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0VsbGlwc29pZE91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBkZWZhdWx0UmFkaWkyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgxLCAxLCAxKTsKICAgICAgY29zMiA9IE1hdGguY29zOwogICAgICBzaW4yID0gTWF0aC5zaW47CiAgICAgIEVsbGlwc29pZE91dGxpbmVHZW9tZXRyeS5wYWNrZWRMZW5ndGggPSAyICogQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCArIDg7CiAgICAgIEVsbGlwc29pZE91dGxpbmVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWUgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZhbHVlLl9yYWRpaSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2YWx1ZS5faW5uZXJSYWRpaSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX21pbmltdW1DbG9jazsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX21heGltdW1DbG9jazsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX21pbmltdW1Db25lOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fbWF4aW11bUNvbmU7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zdGFja1BhcnRpdGlvbnM7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zbGljZVBhcnRpdGlvbnM7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zdWJkaXZpc2lvbnM7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh2YWx1ZS5fb2Zmc2V0QXR0cmlidXRlLCAtMSk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoUmFkaWkyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoSW5uZXJSYWRpaTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hPcHRpb25zMTQgPSB7CiAgICAgICAgcmFkaWk6IHNjcmF0Y2hSYWRpaTIsCiAgICAgICAgaW5uZXJSYWRpaTogc2NyYXRjaElubmVyUmFkaWkyLAogICAgICAgIG1pbmltdW1DbG9jazogdm9pZCAwLAogICAgICAgIG1heGltdW1DbG9jazogdm9pZCAwLAogICAgICAgIG1pbmltdW1Db25lOiB2b2lkIDAsCiAgICAgICAgbWF4aW11bUNvbmU6IHZvaWQgMCwKICAgICAgICBzdGFja1BhcnRpdGlvbnM6IHZvaWQgMCwKICAgICAgICBzbGljZVBhcnRpdGlvbnM6IHZvaWQgMCwKICAgICAgICBzdWJkaXZpc2lvbnM6IHZvaWQgMCwKICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHZvaWQgMAogICAgICB9OwogICAgICBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCByYWRpaSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hSYWRpaTIpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBpbm5lclJhZGlpID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaElubmVyUmFkaWkyKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgbWluaW11bUNsb2NrID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBtYXhpbXVtQ2xvY2sgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IG1pbmltdW1Db25lID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBtYXhpbXVtQ29uZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgc3RhY2tQYXJ0aXRpb25zID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzbGljZVBhcnRpdGlvbnMgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHN1YmRpdmlzaW9ucyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNC5taW5pbXVtQ2xvY2sgPSBtaW5pbXVtQ2xvY2s7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE0Lm1heGltdW1DbG9jayA9IG1heGltdW1DbG9jazsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTQubWluaW11bUNvbmUgPSBtaW5pbXVtQ29uZTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTQubWF4aW11bUNvbmUgPSBtYXhpbXVtQ29uZTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTQuc3RhY2tQYXJ0aXRpb25zID0gc3RhY2tQYXJ0aXRpb25zOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNC5zbGljZVBhcnRpdGlvbnMgPSBzbGljZVBhcnRpdGlvbnM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE0LnN1YmRpdmlzaW9ucyA9IHN1YmRpdmlzaW9uczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTQub2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIHJldHVybiBuZXcgRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zMTQpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX3JhZGlpID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHJhZGlpLCByZXN1bHQuX3JhZGlpKTsKICAgICAgICByZXN1bHQuX2lubmVyUmFkaWkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoaW5uZXJSYWRpaSwgcmVzdWx0Ll9pbm5lclJhZGlpKTsKICAgICAgICByZXN1bHQuX21pbmltdW1DbG9jayA9IG1pbmltdW1DbG9jazsKICAgICAgICByZXN1bHQuX21heGltdW1DbG9jayA9IG1heGltdW1DbG9jazsKICAgICAgICByZXN1bHQuX21pbmltdW1Db25lID0gbWluaW11bUNvbmU7CiAgICAgICAgcmVzdWx0Ll9tYXhpbXVtQ29uZSA9IG1heGltdW1Db25lOwogICAgICAgIHJlc3VsdC5fc3RhY2tQYXJ0aXRpb25zID0gc3RhY2tQYXJ0aXRpb25zOwogICAgICAgIHJlc3VsdC5fc2xpY2VQYXJ0aXRpb25zID0gc2xpY2VQYXJ0aXRpb25zOwogICAgICAgIHJlc3VsdC5fc3ViZGl2aXNpb25zID0gc3ViZGl2aXNpb25zOwogICAgICAgIHJlc3VsdC5fb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihlbGxpcHNvaWRHZW9tZXRyeSkgewogICAgICAgIGNvbnN0IHJhZGlpID0gZWxsaXBzb2lkR2VvbWV0cnkuX3JhZGlpOwogICAgICAgIGlmIChyYWRpaS54IDw9IDAgfHwgcmFkaWkueSA8PSAwIHx8IHJhZGlpLnogPD0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbm5lclJhZGlpID0gZWxsaXBzb2lkR2VvbWV0cnkuX2lubmVyUmFkaWk7CiAgICAgICAgaWYgKGlubmVyUmFkaWkueCA8PSAwIHx8IGlubmVyUmFkaWkueSA8PSAwIHx8IGlubmVyUmFkaWkueiA8PSAwKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IG1pbmltdW1DbG9jayA9IGVsbGlwc29pZEdlb21ldHJ5Ll9taW5pbXVtQ2xvY2s7CiAgICAgICAgY29uc3QgbWF4aW11bUNsb2NrID0gZWxsaXBzb2lkR2VvbWV0cnkuX21heGltdW1DbG9jazsKICAgICAgICBjb25zdCBtaW5pbXVtQ29uZSA9IGVsbGlwc29pZEdlb21ldHJ5Ll9taW5pbXVtQ29uZTsKICAgICAgICBjb25zdCBtYXhpbXVtQ29uZSA9IGVsbGlwc29pZEdlb21ldHJ5Ll9tYXhpbXVtQ29uZTsKICAgICAgICBjb25zdCBzdWJkaXZpc2lvbnMgPSBlbGxpcHNvaWRHZW9tZXRyeS5fc3ViZGl2aXNpb25zOwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmZyb21DYXJ0ZXNpYW4zKHJhZGlpKTsKICAgICAgICBsZXQgc2xpY2VQYXJ0aXRpb25zID0gZWxsaXBzb2lkR2VvbWV0cnkuX3NsaWNlUGFydGl0aW9ucyArIDE7CiAgICAgICAgbGV0IHN0YWNrUGFydGl0aW9ucyA9IGVsbGlwc29pZEdlb21ldHJ5Ll9zdGFja1BhcnRpdGlvbnMgKyAxOwogICAgICAgIHNsaWNlUGFydGl0aW9ucyA9IE1hdGgucm91bmQoCiAgICAgICAgICBzbGljZVBhcnRpdGlvbnMgKiBNYXRoLmFicyhtYXhpbXVtQ2xvY2sgLSBtaW5pbXVtQ2xvY2spIC8gTWF0aF9kZWZhdWx0LlRXT19QSQogICAgICAgICk7CiAgICAgICAgc3RhY2tQYXJ0aXRpb25zID0gTWF0aC5yb3VuZCgKICAgICAgICAgIHN0YWNrUGFydGl0aW9ucyAqIE1hdGguYWJzKG1heGltdW1Db25lIC0gbWluaW11bUNvbmUpIC8gTWF0aF9kZWZhdWx0LlBJCiAgICAgICAgKTsKICAgICAgICBpZiAoc2xpY2VQYXJ0aXRpb25zIDwgMikgewogICAgICAgICAgc2xpY2VQYXJ0aXRpb25zID0gMjsKICAgICAgICB9CiAgICAgICAgaWYgKHN0YWNrUGFydGl0aW9ucyA8IDIpIHsKICAgICAgICAgIHN0YWNrUGFydGl0aW9ucyA9IDI7CiAgICAgICAgfQogICAgICAgIGxldCBleHRyYUluZGljZXMgPSAwOwogICAgICAgIGxldCB2ZXJ0ZXhNdWx0aXBsaWVyID0gMTsKICAgICAgICBjb25zdCBoYXNJbm5lclN1cmZhY2UgPSBpbm5lclJhZGlpLnggIT09IHJhZGlpLnggfHwgaW5uZXJSYWRpaS55ICE9PSByYWRpaS55IHx8IGlubmVyUmFkaWkueiAhPT0gcmFkaWkuejsKICAgICAgICBsZXQgaXNUb3BPcGVuID0gZmFsc2U7CiAgICAgICAgbGV0IGlzQm90T3BlbiA9IGZhbHNlOwogICAgICAgIGlmIChoYXNJbm5lclN1cmZhY2UpIHsKICAgICAgICAgIHZlcnRleE11bHRpcGxpZXIgPSAyOwogICAgICAgICAgaWYgKG1pbmltdW1Db25lID4gMCkgewogICAgICAgICAgICBpc1RvcE9wZW4gPSB0cnVlOwogICAgICAgICAgICBleHRyYUluZGljZXMgKz0gc2xpY2VQYXJ0aXRpb25zOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG1heGltdW1Db25lIDwgTWF0aC5QSSkgewogICAgICAgICAgICBpc0JvdE9wZW4gPSB0cnVlOwogICAgICAgICAgICBleHRyYUluZGljZXMgKz0gc2xpY2VQYXJ0aXRpb25zOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCB2ZXJ0ZXhDb3VudCA9IHN1YmRpdmlzaW9ucyAqIHZlcnRleE11bHRpcGxpZXIgKiAoc3RhY2tQYXJ0aXRpb25zICsgc2xpY2VQYXJ0aXRpb25zKTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHZlcnRleENvdW50ICogMyk7CiAgICAgICAgY29uc3QgbnVtSW5kaWNlcyA9IDIgKiAodmVydGV4Q291bnQgKyBleHRyYUluZGljZXMgLSAoc2xpY2VQYXJ0aXRpb25zICsgc3RhY2tQYXJ0aXRpb25zKSAqIHZlcnRleE11bHRpcGxpZXIpOwogICAgICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSh2ZXJ0ZXhDb3VudCwgbnVtSW5kaWNlcyk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgbGV0IGo7CiAgICAgICAgbGV0IHRoZXRhOwogICAgICAgIGxldCBwaGk7CiAgICAgICAgbGV0IGluZGV4ID0gMDsKICAgICAgICBjb25zdCBzaW5QaGkgPSBuZXcgQXJyYXkoc3RhY2tQYXJ0aXRpb25zKTsKICAgICAgICBjb25zdCBjb3NQaGkgPSBuZXcgQXJyYXkoc3RhY2tQYXJ0aXRpb25zKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc3RhY2tQYXJ0aXRpb25zOyBpKyspIHsKICAgICAgICAgIHBoaSA9IG1pbmltdW1Db25lICsgaSAqIChtYXhpbXVtQ29uZSAtIG1pbmltdW1Db25lKSAvIChzdGFja1BhcnRpdGlvbnMgLSAxKTsKICAgICAgICAgIHNpblBoaVtpXSA9IHNpbjIocGhpKTsKICAgICAgICAgIGNvc1BoaVtpXSA9IGNvczIocGhpKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc2luVGhldGEgPSBuZXcgQXJyYXkoc3ViZGl2aXNpb25zKTsKICAgICAgICBjb25zdCBjb3NUaGV0YSA9IG5ldyBBcnJheShzdWJkaXZpc2lvbnMpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzdWJkaXZpc2lvbnM7IGkrKykgewogICAgICAgICAgdGhldGEgPSBtaW5pbXVtQ2xvY2sgKyBpICogKG1heGltdW1DbG9jayAtIG1pbmltdW1DbG9jaykgLyAoc3ViZGl2aXNpb25zIC0gMSk7CiAgICAgICAgICBzaW5UaGV0YVtpXSA9IHNpbjIodGhldGEpOwogICAgICAgICAgY29zVGhldGFbaV0gPSBjb3MyKHRoZXRhKTsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHN0YWNrUGFydGl0aW9uczsgaSsrKSB7CiAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgc3ViZGl2aXNpb25zOyBqKyspIHsKICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gcmFkaWkueCAqIHNpblBoaVtpXSAqIGNvc1RoZXRhW2pdOwogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSByYWRpaS55ICogc2luUGhpW2ldICogc2luVGhldGFbal07CiAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IHJhZGlpLnogKiBjb3NQaGlbaV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChoYXNJbm5lclN1cmZhY2UpIHsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzdGFja1BhcnRpdGlvbnM7IGkrKykgewogICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgc3ViZGl2aXNpb25zOyBqKyspIHsKICAgICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBpbm5lclJhZGlpLnggKiBzaW5QaGlbaV0gKiBjb3NUaGV0YVtqXTsKICAgICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBpbm5lclJhZGlpLnkgKiBzaW5QaGlbaV0gKiBzaW5UaGV0YVtqXTsKICAgICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBpbm5lclJhZGlpLnogKiBjb3NQaGlbaV07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgc2luUGhpLmxlbmd0aCA9IHN1YmRpdmlzaW9uczsKICAgICAgICBjb3NQaGkubGVuZ3RoID0gc3ViZGl2aXNpb25zOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzdWJkaXZpc2lvbnM7IGkrKykgewogICAgICAgICAgcGhpID0gbWluaW11bUNvbmUgKyBpICogKG1heGltdW1Db25lIC0gbWluaW11bUNvbmUpIC8gKHN1YmRpdmlzaW9ucyAtIDEpOwogICAgICAgICAgc2luUGhpW2ldID0gc2luMihwaGkpOwogICAgICAgICAgY29zUGhpW2ldID0gY29zMihwaGkpOwogICAgICAgIH0KICAgICAgICBzaW5UaGV0YS5sZW5ndGggPSBzbGljZVBhcnRpdGlvbnM7CiAgICAgICAgY29zVGhldGEubGVuZ3RoID0gc2xpY2VQYXJ0aXRpb25zOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzbGljZVBhcnRpdGlvbnM7IGkrKykgewogICAgICAgICAgdGhldGEgPSBtaW5pbXVtQ2xvY2sgKyBpICogKG1heGltdW1DbG9jayAtIG1pbmltdW1DbG9jaykgLyAoc2xpY2VQYXJ0aXRpb25zIC0gMSk7CiAgICAgICAgICBzaW5UaGV0YVtpXSA9IHNpbjIodGhldGEpOwogICAgICAgICAgY29zVGhldGFbaV0gPSBjb3MyKHRoZXRhKTsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHN1YmRpdmlzaW9uczsgaSsrKSB7CiAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgc2xpY2VQYXJ0aXRpb25zOyBqKyspIHsKICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gcmFkaWkueCAqIHNpblBoaVtpXSAqIGNvc1RoZXRhW2pdOwogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSByYWRpaS55ICogc2luUGhpW2ldICogc2luVGhldGFbal07CiAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IHJhZGlpLnogKiBjb3NQaGlbaV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChoYXNJbm5lclN1cmZhY2UpIHsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzdWJkaXZpc2lvbnM7IGkrKykgewogICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgc2xpY2VQYXJ0aXRpb25zOyBqKyspIHsKICAgICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBpbm5lclJhZGlpLnggKiBzaW5QaGlbaV0gKiBjb3NUaGV0YVtqXTsKICAgICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBpbm5lclJhZGlpLnkgKiBzaW5QaGlbaV0gKiBzaW5UaGV0YVtqXTsKICAgICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBpbm5lclJhZGlpLnogKiBjb3NQaGlbaV07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaW5kZXggPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzdGFja1BhcnRpdGlvbnMgKiB2ZXJ0ZXhNdWx0aXBsaWVyOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHRvcE9mZnNldCA9IGkgKiBzdWJkaXZpc2lvbnM7CiAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgc3ViZGl2aXNpb25zIC0gMTsgaisrKSB7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB0b3BPZmZzZXQgKyBqOwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdG9wT2Zmc2V0ICsgaiArIDE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCBvZmZzZXQgPSBzdGFja1BhcnRpdGlvbnMgKiBzdWJkaXZpc2lvbnMgKiB2ZXJ0ZXhNdWx0aXBsaWVyOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzbGljZVBhcnRpdGlvbnM7IGkrKykgewogICAgICAgICAgZm9yIChqID0gMDsgaiA8IHN1YmRpdmlzaW9ucyAtIDE7IGorKykgewogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gb2Zmc2V0ICsgaSArIGogKiBzbGljZVBhcnRpdGlvbnM7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBvZmZzZXQgKyBpICsgKGogKyAxKSAqIHNsaWNlUGFydGl0aW9uczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGhhc0lubmVyU3VyZmFjZSkgewogICAgICAgICAgb2Zmc2V0ID0gc3RhY2tQYXJ0aXRpb25zICogc3ViZGl2aXNpb25zICogdmVydGV4TXVsdGlwbGllciArIHNsaWNlUGFydGl0aW9ucyAqIHN1YmRpdmlzaW9uczsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzbGljZVBhcnRpdGlvbnM7IGkrKykgewogICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgc3ViZGl2aXNpb25zIC0gMTsgaisrKSB7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IG9mZnNldCArIGkgKyBqICogc2xpY2VQYXJ0aXRpb25zOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBvZmZzZXQgKyBpICsgKGogKyAxKSAqIHNsaWNlUGFydGl0aW9uczsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaGFzSW5uZXJTdXJmYWNlKSB7CiAgICAgICAgICBsZXQgb3V0ZXJPZmZzZXQgPSBzdGFja1BhcnRpdGlvbnMgKiBzdWJkaXZpc2lvbnMgKiB2ZXJ0ZXhNdWx0aXBsaWVyOwogICAgICAgICAgbGV0IGlubmVyT2Zmc2V0ID0gb3V0ZXJPZmZzZXQgKyBzdWJkaXZpc2lvbnMgKiBzbGljZVBhcnRpdGlvbnM7CiAgICAgICAgICBpZiAoaXNUb3BPcGVuKSB7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzbGljZVBhcnRpdGlvbnM7IGkrKykgewogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBvdXRlck9mZnNldCArIGk7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGlubmVyT2Zmc2V0ICsgaTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQm90T3BlbikgewogICAgICAgICAgICBvdXRlck9mZnNldCArPSBzdWJkaXZpc2lvbnMgKiBzbGljZVBhcnRpdGlvbnMgLSBzbGljZVBhcnRpdGlvbnM7CiAgICAgICAgICAgIGlubmVyT2Zmc2V0ICs9IHN1YmRpdmlzaW9ucyAqIHNsaWNlUGFydGl0aW9ucyAtIHNsaWNlUGFydGl0aW9uczsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNsaWNlUGFydGl0aW9uczsgaSsrKSB7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IG91dGVyT2Zmc2V0ICsgaTsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaW5uZXJPZmZzZXQgKyBpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoewogICAgICAgICAgcG9zaXRpb246IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICB2YWx1ZXM6IHBvc2l0aW9ucwogICAgICAgICAgfSkKICAgICAgICB9KTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGVsbGlwc29pZEdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgICAgY29uc3Qgb2Zmc2V0VmFsdWUgPSBlbGxpcHNvaWRHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgIGNvbnN0IGFwcGx5T2Zmc2V0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoIC8gMykuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgICAgICBhdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgICAgICB2YWx1ZXM6IGFwcGx5T2Zmc2V0CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbUVsbGlwc29pZChlbGxpcHNvaWQpLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBlbGxpcHNvaWRHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5KGVsbGlwc29pZEdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZWxsaXBzb2lkR2VvbWV0cnkuYnVmZmVyLCBvZmZzZXQpKSB7CiAgICAgIGVsbGlwc29pZEdlb21ldHJ5ID0gRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKAogICAgICAgIGVsbGlwc29pZEdlb21ldHJ5LAogICAgICAgIG9mZnNldAogICAgICApOwogICAgfQogICAgcmV0dXJuIEVsbGlwc29pZE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KGVsbGlwc29pZEdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ3VsbGluZ1ZvbHVtZS5qcwogIGZ1bmN0aW9uIEN1bGxpbmdWb2x1bWUocGxhbmVzKSB7CiAgICB0aGlzLnBsYW5lcyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHBsYW5lcywgW10pOwogIH0KICB2YXIgZmFjZXMsIHNjcmF0Y2hQbGFuZUNlbnRlciwgc2NyYXRjaFBsYW5lTm9ybWFsMiwgc2NyYXRjaFBsYW5lMiwgQ3VsbGluZ1ZvbHVtZV9kZWZhdWx0OwogIHZhciBpbml0X0N1bGxpbmdWb2x1bWUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0N1bGxpbmdWb2x1bWUuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW40KCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfSW50ZXJzZWN0KCk7CiAgICAgIGluaXRfUGxhbmUoKTsKICAgICAgZmFjZXMgPSBbbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLCBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKV07CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YLCBmYWNlc1swXSk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9ZLCBmYWNlc1sxXSk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9aLCBmYWNlc1syXSk7CiAgICAgIHNjcmF0Y2hQbGFuZUNlbnRlciA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBsYW5lTm9ybWFsMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBsYW5lMiA9IG5ldyBQbGFuZV9kZWZhdWx0KG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoMSwgMCwgMCksIDApOwogICAgICBDdWxsaW5nVm9sdW1lLmZyb21Cb3VuZGluZ1NwaGVyZSA9IGZ1bmN0aW9uKGJvdW5kaW5nU3BoZXJlLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChib3VuZGluZ1NwaGVyZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJib3VuZGluZ1NwaGVyZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEN1bGxpbmdWb2x1bWUoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoID0gZmFjZXMubGVuZ3RoOwogICAgICAgIGNvbnN0IHBsYW5lcyA9IHJlc3VsdC5wbGFuZXM7CiAgICAgICAgcGxhbmVzLmxlbmd0aCA9IDIgKiBsZW5ndGg7CiAgICAgICAgY29uc3QgY2VudGVyID0gYm91bmRpbmdTcGhlcmUuY2VudGVyOwogICAgICAgIGNvbnN0IHJhZGl1cyA9IGJvdW5kaW5nU3BoZXJlLnJhZGl1czsKICAgICAgICBsZXQgcGxhbmVJbmRleCA9IDA7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgY29uc3QgZmFjZU5vcm1hbCA9IGZhY2VzW2ldOwogICAgICAgICAgbGV0IHBsYW5lMCA9IHBsYW5lc1twbGFuZUluZGV4XTsKICAgICAgICAgIGxldCBwbGFuZTEgPSBwbGFuZXNbcGxhbmVJbmRleCArIDFdOwogICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUwKSkgewogICAgICAgICAgICBwbGFuZTAgPSBwbGFuZXNbcGxhbmVJbmRleF0gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZTEpKSB7CiAgICAgICAgICAgIHBsYW5lMSA9IHBsYW5lc1twbGFuZUluZGV4ICsgMV0gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgICAgICB9CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihmYWNlTm9ybWFsLCAtcmFkaXVzLCBzY3JhdGNoUGxhbmVDZW50ZXIpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChjZW50ZXIsIHNjcmF0Y2hQbGFuZUNlbnRlciwgc2NyYXRjaFBsYW5lQ2VudGVyKTsKICAgICAgICAgIHBsYW5lMC54ID0gZmFjZU5vcm1hbC54OwogICAgICAgICAgcGxhbmUwLnkgPSBmYWNlTm9ybWFsLnk7CiAgICAgICAgICBwbGFuZTAueiA9IGZhY2VOb3JtYWwuejsKICAgICAgICAgIHBsYW5lMC53ID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZmFjZU5vcm1hbCwgc2NyYXRjaFBsYW5lQ2VudGVyKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGZhY2VOb3JtYWwsIHJhZGl1cywgc2NyYXRjaFBsYW5lQ2VudGVyKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY2VudGVyLCBzY3JhdGNoUGxhbmVDZW50ZXIsIHNjcmF0Y2hQbGFuZUNlbnRlcik7CiAgICAgICAgICBwbGFuZTEueCA9IC1mYWNlTm9ybWFsLng7CiAgICAgICAgICBwbGFuZTEueSA9IC1mYWNlTm9ybWFsLnk7CiAgICAgICAgICBwbGFuZTEueiA9IC1mYWNlTm9ybWFsLno7CiAgICAgICAgICBwbGFuZTEudyA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGZhY2VOb3JtYWwsIHNjcmF0Y2hQbGFuZU5vcm1hbDIpLAogICAgICAgICAgICBzY3JhdGNoUGxhbmVDZW50ZXIKICAgICAgICAgICk7CiAgICAgICAgICBwbGFuZUluZGV4ICs9IDI7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEN1bGxpbmdWb2x1bWUucHJvdG90eXBlLmNvbXB1dGVWaXNpYmlsaXR5ID0gZnVuY3Rpb24oYm91bmRpbmdWb2x1bWUpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChib3VuZGluZ1ZvbHVtZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJib3VuZGluZ1ZvbHVtZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcGxhbmVzID0gdGhpcy5wbGFuZXM7CiAgICAgICAgbGV0IGludGVyc2VjdGluZyA9IGZhbHNlOwogICAgICAgIGZvciAobGV0IGsgPSAwLCBsZW4gPSBwbGFuZXMubGVuZ3RoOyBrIDwgbGVuOyArK2spIHsKICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGJvdW5kaW5nVm9sdW1lLmludGVyc2VjdFBsYW5lKAogICAgICAgICAgICBQbGFuZV9kZWZhdWx0LmZyb21DYXJ0ZXNpYW40KHBsYW5lc1trXSwgc2NyYXRjaFBsYW5lMikKICAgICAgICAgICk7CiAgICAgICAgICBpZiAocmVzdWx0ID09PSBJbnRlcnNlY3RfZGVmYXVsdC5PVVRTSURFKSB7CiAgICAgICAgICAgIHJldHVybiBJbnRlcnNlY3RfZGVmYXVsdC5PVVRTSURFOwogICAgICAgICAgfSBlbHNlIGlmIChyZXN1bHQgPT09IEludGVyc2VjdF9kZWZhdWx0LklOVEVSU0VDVElORykgewogICAgICAgICAgICBpbnRlcnNlY3RpbmcgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gaW50ZXJzZWN0aW5nID8gSW50ZXJzZWN0X2RlZmF1bHQuSU5URVJTRUNUSU5HIDogSW50ZXJzZWN0X2RlZmF1bHQuSU5TSURFOwogICAgICB9OwogICAgICBDdWxsaW5nVm9sdW1lLnByb3RvdHlwZS5jb21wdXRlVmlzaWJpbGl0eVdpdGhQbGFuZU1hc2sgPSBmdW5jdGlvbihib3VuZGluZ1ZvbHVtZSwgcGFyZW50UGxhbmVNYXNrKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYm91bmRpbmdWb2x1bWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYm91bmRpbmdWb2x1bWUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBhcmVudFBsYW5lTWFzaykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwYXJlbnRQbGFuZU1hc2sgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmIChwYXJlbnRQbGFuZU1hc2sgPT09IEN1bGxpbmdWb2x1bWUuTUFTS19PVVRTSURFIHx8IHBhcmVudFBsYW5lTWFzayA9PT0gQ3VsbGluZ1ZvbHVtZS5NQVNLX0lOU0lERSkgewogICAgICAgICAgcmV0dXJuIHBhcmVudFBsYW5lTWFzazsKICAgICAgICB9CiAgICAgICAgbGV0IG1hc2sgPSBDdWxsaW5nVm9sdW1lLk1BU0tfSU5TSURFOwogICAgICAgIGNvbnN0IHBsYW5lcyA9IHRoaXMucGxhbmVzOwogICAgICAgIGZvciAobGV0IGsgPSAwLCBsZW4gPSBwbGFuZXMubGVuZ3RoOyBrIDwgbGVuOyArK2spIHsKICAgICAgICAgIGNvbnN0IGZsYWcgPSBrIDwgMzEgPyAxIDw8IGsgOiAwOwogICAgICAgICAgaWYgKGsgPCAzMSAmJiAocGFyZW50UGxhbmVNYXNrICYgZmxhZykgPT09IDApIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCByZXN1bHQgPSBib3VuZGluZ1ZvbHVtZS5pbnRlcnNlY3RQbGFuZSgKICAgICAgICAgICAgUGxhbmVfZGVmYXVsdC5mcm9tQ2FydGVzaWFuNChwbGFuZXNba10sIHNjcmF0Y2hQbGFuZTIpCiAgICAgICAgICApOwogICAgICAgICAgaWYgKHJlc3VsdCA9PT0gSW50ZXJzZWN0X2RlZmF1bHQuT1VUU0lERSkgewogICAgICAgICAgICByZXR1cm4gQ3VsbGluZ1ZvbHVtZS5NQVNLX09VVFNJREU7CiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3VsdCA9PT0gSW50ZXJzZWN0X2RlZmF1bHQuSU5URVJTRUNUSU5HKSB7CiAgICAgICAgICAgIG1hc2sgfD0gZmxhZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1hc2s7CiAgICAgIH07CiAgICAgIEN1bGxpbmdWb2x1bWUuTUFTS19PVVRTSURFID0gNDI5NDk2NzI5NTsKICAgICAgQ3VsbGluZ1ZvbHVtZS5NQVNLX0lOU0lERSA9IDA7CiAgICAgIEN1bGxpbmdWb2x1bWUuTUFTS19JTkRFVEVSTUlOQVRFID0gMjE0NzQ4MzY0NzsKICAgICAgQ3VsbGluZ1ZvbHVtZV9kZWZhdWx0ID0gQ3VsbGluZ1ZvbHVtZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL09ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW0uanMKICBmdW5jdGlvbiBPcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgdGhpcy5sZWZ0ID0gb3B0aW9ucy5sZWZ0OwogICAgdGhpcy5fbGVmdCA9IHZvaWQgMDsKICAgIHRoaXMucmlnaHQgPSBvcHRpb25zLnJpZ2h0OwogICAgdGhpcy5fcmlnaHQgPSB2b2lkIDA7CiAgICB0aGlzLnRvcCA9IG9wdGlvbnMudG9wOwogICAgdGhpcy5fdG9wID0gdm9pZCAwOwogICAgdGhpcy5ib3R0b20gPSBvcHRpb25zLmJvdHRvbTsKICAgIHRoaXMuX2JvdHRvbSA9IHZvaWQgMDsKICAgIHRoaXMubmVhciA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubmVhciwgMSk7CiAgICB0aGlzLl9uZWFyID0gdGhpcy5uZWFyOwogICAgdGhpcy5mYXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmZhciwgNWU4KTsKICAgIHRoaXMuX2ZhciA9IHRoaXMuZmFyOwogICAgdGhpcy5fY3VsbGluZ1ZvbHVtZSA9IG5ldyBDdWxsaW5nVm9sdW1lX2RlZmF1bHQoKTsKICAgIHRoaXMuX29ydGhvZ3JhcGhpY01hdHJpeCA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICB9CiAgZnVuY3Rpb24gdXBkYXRlKGZydXN0dW0pIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0ucmlnaHQpIHx8ICFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5sZWZ0KSB8fCAhZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0udG9wKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0uYm90dG9tKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0ubmVhcikgfHwgIWRlZmluZWRfZGVmYXVsdChmcnVzdHVtLmZhcikpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgInJpZ2h0LCBsZWZ0LCB0b3AsIGJvdHRvbSwgbmVhciwgb3IgZmFyIHBhcmFtZXRlcnMgYXJlIG5vdCBzZXQuIgogICAgICApOwogICAgfQogICAgaWYgKGZydXN0dW0udG9wICE9PSBmcnVzdHVtLl90b3AgfHwgZnJ1c3R1bS5ib3R0b20gIT09IGZydXN0dW0uX2JvdHRvbSB8fCBmcnVzdHVtLmxlZnQgIT09IGZydXN0dW0uX2xlZnQgfHwgZnJ1c3R1bS5yaWdodCAhPT0gZnJ1c3R1bS5fcmlnaHQgfHwgZnJ1c3R1bS5uZWFyICE9PSBmcnVzdHVtLl9uZWFyIHx8IGZydXN0dW0uZmFyICE9PSBmcnVzdHVtLl9mYXIpIHsKICAgICAgaWYgKGZydXN0dW0ubGVmdCA+IGZydXN0dW0ucmlnaHQpIHsKICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmlnaHQgbXVzdCBiZSBncmVhdGVyIHRoYW4gbGVmdC4iKTsKICAgICAgfQogICAgICBpZiAoZnJ1c3R1bS5ib3R0b20gPiBmcnVzdHVtLnRvcCkgewogICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ0b3AgbXVzdCBiZSBncmVhdGVyIHRoYW4gYm90dG9tLiIpOwogICAgICB9CiAgICAgIGlmIChmcnVzdHVtLm5lYXIgPD0gMCB8fCBmcnVzdHVtLm5lYXIgPiBmcnVzdHVtLmZhcikgewogICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgIm5lYXIgbXVzdCBiZSBncmVhdGVyIHRoYW4gemVybyBhbmQgbGVzcyB0aGFuIGZhci4iCiAgICAgICAgKTsKICAgICAgfQogICAgICBmcnVzdHVtLl9sZWZ0ID0gZnJ1c3R1bS5sZWZ0OwogICAgICBmcnVzdHVtLl9yaWdodCA9IGZydXN0dW0ucmlnaHQ7CiAgICAgIGZydXN0dW0uX3RvcCA9IGZydXN0dW0udG9wOwogICAgICBmcnVzdHVtLl9ib3R0b20gPSBmcnVzdHVtLmJvdHRvbTsKICAgICAgZnJ1c3R1bS5fbmVhciA9IGZydXN0dW0ubmVhcjsKICAgICAgZnJ1c3R1bS5fZmFyID0gZnJ1c3R1bS5mYXI7CiAgICAgIGZydXN0dW0uX29ydGhvZ3JhcGhpY01hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC5jb21wdXRlT3J0aG9ncmFwaGljT2ZmQ2VudGVyKAogICAgICAgIGZydXN0dW0ubGVmdCwKICAgICAgICBmcnVzdHVtLnJpZ2h0LAogICAgICAgIGZydXN0dW0uYm90dG9tLAogICAgICAgIGZydXN0dW0udG9wLAogICAgICAgIGZydXN0dW0ubmVhciwKICAgICAgICBmcnVzdHVtLmZhciwKICAgICAgICBmcnVzdHVtLl9vcnRob2dyYXBoaWNNYXRyaXgKICAgICAgKTsKICAgIH0KICB9CiAgdmFyIGdldFBsYW5lc1JpZ2h0LCBnZXRQbGFuZXNOZWFyQ2VudGVyLCBnZXRQbGFuZXNQb2ludCwgbmVnYXRlU2NyYXRjaCwgT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bV9kZWZhdWx0OwogIHZhciBpbml0X09ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW0gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL09ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW0uanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW40KCk7CiAgICAgIGluaXRfQ3VsbGluZ1ZvbHVtZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKE9ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW0ucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgb3J0aG9ncmFwaGljIHByb2plY3Rpb24gbWF0cml4IGNvbXB1dGVkIGZyb20gdGhlIHZpZXcgZnJ1c3R1bS4KICAgICAgICAgKiBAbWVtYmVyb2YgT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7TWF0cml4NH0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBwcm9qZWN0aW9uTWF0cml4OiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB1cGRhdGUodGhpcyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9vcnRob2dyYXBoaWNNYXRyaXg7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgZ2V0UGxhbmVzUmlnaHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGdldFBsYW5lc05lYXJDZW50ZXIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGdldFBsYW5lc1BvaW50ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBuZWdhdGVTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBPcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtLnByb3RvdHlwZS5jb21wdXRlQ3VsbGluZ1ZvbHVtZSA9IGZ1bmN0aW9uKHBvc2l0aW9uLCBkaXJlY3Rpb24yLCB1cCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9uKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInBvc2l0aW9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChkaXJlY3Rpb24yKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImRpcmVjdGlvbiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodXApKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidXAgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBsYW5lcyA9IHRoaXMuX2N1bGxpbmdWb2x1bWUucGxhbmVzOwogICAgICAgIGNvbnN0IHQgPSB0aGlzLnRvcDsKICAgICAgICBjb25zdCBiID0gdGhpcy5ib3R0b207CiAgICAgICAgY29uc3QgciA9IHRoaXMucmlnaHQ7CiAgICAgICAgY29uc3QgbCA9IHRoaXMubGVmdDsKICAgICAgICBjb25zdCBuID0gdGhpcy5uZWFyOwogICAgICAgIGNvbnN0IGYgPSB0aGlzLmZhcjsKICAgICAgICBjb25zdCByaWdodCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhkaXJlY3Rpb24yLCB1cCwgZ2V0UGxhbmVzUmlnaHQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmlnaHQsIHJpZ2h0KTsKICAgICAgICBjb25zdCBuZWFyQ2VudGVyID0gZ2V0UGxhbmVzTmVhckNlbnRlcjsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihkaXJlY3Rpb24yLCBuLCBuZWFyQ2VudGVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uLCBuZWFyQ2VudGVyLCBuZWFyQ2VudGVyKTsKICAgICAgICBjb25zdCBwb2ludCA9IGdldFBsYW5lc1BvaW50OwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHJpZ2h0LCBsLCBwb2ludCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChuZWFyQ2VudGVyLCBwb2ludCwgcG9pbnQpOwogICAgICAgIGxldCBwbGFuZSA9IHBsYW5lc1swXTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZSkpIHsKICAgICAgICAgIHBsYW5lID0gcGxhbmVzWzBdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBwbGFuZS54ID0gcmlnaHQueDsKICAgICAgICBwbGFuZS55ID0gcmlnaHQueTsKICAgICAgICBwbGFuZS56ID0gcmlnaHQuejsKICAgICAgICBwbGFuZS53ID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3QocmlnaHQsIHBvaW50KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihyaWdodCwgciwgcG9pbnQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQobmVhckNlbnRlciwgcG9pbnQsIHBvaW50KTsKICAgICAgICBwbGFuZSA9IHBsYW5lc1sxXTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZSkpIHsKICAgICAgICAgIHBsYW5lID0gcGxhbmVzWzFdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBwbGFuZS54ID0gLXJpZ2h0Lng7CiAgICAgICAgcGxhbmUueSA9IC1yaWdodC55OwogICAgICAgIHBsYW5lLnogPSAtcmlnaHQuejsKICAgICAgICBwbGFuZS53ID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3QoQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShyaWdodCwgbmVnYXRlU2NyYXRjaCksIHBvaW50KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcih1cCwgYiwgcG9pbnQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQobmVhckNlbnRlciwgcG9pbnQsIHBvaW50KTsKICAgICAgICBwbGFuZSA9IHBsYW5lc1syXTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZSkpIHsKICAgICAgICAgIHBsYW5lID0gcGxhbmVzWzJdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBwbGFuZS54ID0gdXAueDsKICAgICAgICBwbGFuZS55ID0gdXAueTsKICAgICAgICBwbGFuZS56ID0gdXAuejsKICAgICAgICBwbGFuZS53ID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3QodXAsIHBvaW50KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcih1cCwgdCwgcG9pbnQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQobmVhckNlbnRlciwgcG9pbnQsIHBvaW50KTsKICAgICAgICBwbGFuZSA9IHBsYW5lc1szXTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZSkpIHsKICAgICAgICAgIHBsYW5lID0gcGxhbmVzWzNdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBwbGFuZS54ID0gLXVwLng7CiAgICAgICAgcGxhbmUueSA9IC11cC55OwogICAgICAgIHBsYW5lLnogPSAtdXAuejsKICAgICAgICBwbGFuZS53ID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3QoQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZSh1cCwgbmVnYXRlU2NyYXRjaCksIHBvaW50KTsKICAgICAgICBwbGFuZSA9IHBsYW5lc1s0XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZSkpIHsKICAgICAgICAgIHBsYW5lID0gcGxhbmVzWzRdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBwbGFuZS54ID0gZGlyZWN0aW9uMi54OwogICAgICAgIHBsYW5lLnkgPSBkaXJlY3Rpb24yLnk7CiAgICAgICAgcGxhbmUueiA9IGRpcmVjdGlvbjIuejsKICAgICAgICBwbGFuZS53ID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgbmVhckNlbnRlcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoZGlyZWN0aW9uMiwgZiwgcG9pbnQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24sIHBvaW50LCBwb2ludCk7CiAgICAgICAgcGxhbmUgPSBwbGFuZXNbNV07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICBwbGFuZSA9IHBsYW5lc1s1XSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcGxhbmUueCA9IC1kaXJlY3Rpb24yLng7CiAgICAgICAgcGxhbmUueSA9IC1kaXJlY3Rpb24yLnk7CiAgICAgICAgcGxhbmUueiA9IC1kaXJlY3Rpb24yLno7CiAgICAgICAgcGxhbmUudyA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoZGlyZWN0aW9uMiwgbmVnYXRlU2NyYXRjaCksIHBvaW50KTsKICAgICAgICByZXR1cm4gdGhpcy5fY3VsbGluZ1ZvbHVtZTsKICAgICAgfTsKICAgICAgT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bS5wcm90b3R5cGUuZ2V0UGl4ZWxEaW1lbnNpb25zID0gZnVuY3Rpb24oZHJhd2luZ0J1ZmZlcldpZHRoLCBkcmF3aW5nQnVmZmVySGVpZ2h0LCBkaXN0YW5jZSwgcGl4ZWxSYXRpbywgcmVzdWx0KSB7CiAgICAgICAgdXBkYXRlKHRoaXMpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGRyYXdpbmdCdWZmZXJXaWR0aCkgfHwgIWRlZmluZWRfZGVmYXVsdChkcmF3aW5nQnVmZmVySGVpZ2h0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJCb3RoIGRyYXdpbmdCdWZmZXJXaWR0aCBhbmQgZHJhd2luZ0J1ZmZlckhlaWdodCBhcmUgcmVxdWlyZWQuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRyYXdpbmdCdWZmZXJXaWR0aCA8PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZHJhd2luZ0J1ZmZlcldpZHRoIG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8uIik7CiAgICAgICAgfQogICAgICAgIGlmIChkcmF3aW5nQnVmZmVySGVpZ2h0IDw9IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkcmF3aW5nQnVmZmVySGVpZ2h0IG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8uIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGRpc3RhbmNlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImRpc3RhbmNlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwaXhlbFJhdGlvKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInBpeGVsUmF0aW8gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmIChwaXhlbFJhdGlvIDw9IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwaXhlbFJhdGlvIG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8uIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJBIHJlc3VsdCBvYmplY3QgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGZydXN0dW1XaWR0aCA9IHRoaXMucmlnaHQgLSB0aGlzLmxlZnQ7CiAgICAgICAgY29uc3QgZnJ1c3R1bUhlaWdodCA9IHRoaXMudG9wIC0gdGhpcy5ib3R0b207CiAgICAgICAgY29uc3QgcGl4ZWxXaWR0aCA9IHBpeGVsUmF0aW8gKiBmcnVzdHVtV2lkdGggLyBkcmF3aW5nQnVmZmVyV2lkdGg7CiAgICAgICAgY29uc3QgcGl4ZWxIZWlnaHQgPSBwaXhlbFJhdGlvICogZnJ1c3R1bUhlaWdodCAvIGRyYXdpbmdCdWZmZXJIZWlnaHQ7CiAgICAgICAgcmVzdWx0LnggPSBwaXhlbFdpZHRoOwogICAgICAgIHJlc3VsdC55ID0gcGl4ZWxIZWlnaHQ7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bS5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bSgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQubGVmdCA9IHRoaXMubGVmdDsKICAgICAgICByZXN1bHQucmlnaHQgPSB0aGlzLnJpZ2h0OwogICAgICAgIHJlc3VsdC50b3AgPSB0aGlzLnRvcDsKICAgICAgICByZXN1bHQuYm90dG9tID0gdGhpcy5ib3R0b207CiAgICAgICAgcmVzdWx0Lm5lYXIgPSB0aGlzLm5lYXI7CiAgICAgICAgcmVzdWx0LmZhciA9IHRoaXMuZmFyOwogICAgICAgIHJlc3VsdC5fbGVmdCA9IHZvaWQgMDsKICAgICAgICByZXN1bHQuX3JpZ2h0ID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fdG9wID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fYm90dG9tID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fbmVhciA9IHZvaWQgMDsKICAgICAgICByZXN1bHQuX2ZhciA9IHZvaWQgMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBPcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihvdGhlcikgewogICAgICAgIHJldHVybiBkZWZpbmVkX2RlZmF1bHQob3RoZXIpICYmIG90aGVyIGluc3RhbmNlb2YgT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bSAmJiB0aGlzLnJpZ2h0ID09PSBvdGhlci5yaWdodCAmJiB0aGlzLmxlZnQgPT09IG90aGVyLmxlZnQgJiYgdGhpcy50b3AgPT09IG90aGVyLnRvcCAmJiB0aGlzLmJvdHRvbSA9PT0gb3RoZXIuYm90dG9tICYmIHRoaXMubmVhciA9PT0gb3RoZXIubmVhciAmJiB0aGlzLmZhciA9PT0gb3RoZXIuZmFyOwogICAgICB9OwogICAgICBPcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtLnByb3RvdHlwZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24ob3RoZXIsIHJlbGF0aXZlRXBzaWxvbiwgYWJzb2x1dGVFcHNpbG9uKSB7CiAgICAgICAgcmV0dXJuIG90aGVyID09PSB0aGlzIHx8IGRlZmluZWRfZGVmYXVsdChvdGhlcikgJiYgb3RoZXIgaW5zdGFuY2VvZiBPcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy5yaWdodCwKICAgICAgICAgIG90aGVyLnJpZ2h0LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMubGVmdCwKICAgICAgICAgIG90aGVyLmxlZnQsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy50b3AsCiAgICAgICAgICBvdGhlci50b3AsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy5ib3R0b20sCiAgICAgICAgICBvdGhlci5ib3R0b20sCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy5uZWFyLAogICAgICAgICAgb3RoZXIubmVhciwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLmZhciwKICAgICAgICAgIG90aGVyLmZhciwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICk7CiAgICAgIH07CiAgICAgIE9ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW1fZGVmYXVsdCA9IE9ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW07CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9PcnRob2dyYXBoaWNGcnVzdHVtLmpzCiAgZnVuY3Rpb24gT3J0aG9ncmFwaGljRnJ1c3R1bShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIHRoaXMuX29mZkNlbnRlckZydXN0dW0gPSBuZXcgT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bV9kZWZhdWx0KCk7CiAgICB0aGlzLndpZHRoID0gb3B0aW9ucy53aWR0aDsKICAgIHRoaXMuX3dpZHRoID0gdm9pZCAwOwogICAgdGhpcy5hc3BlY3RSYXRpbyA9IG9wdGlvbnMuYXNwZWN0UmF0aW87CiAgICB0aGlzLl9hc3BlY3RSYXRpbyA9IHZvaWQgMDsKICAgIHRoaXMubmVhciA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubmVhciwgMSk7CiAgICB0aGlzLl9uZWFyID0gdGhpcy5uZWFyOwogICAgdGhpcy5mYXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmZhciwgNWU4KTsKICAgIHRoaXMuX2ZhciA9IHRoaXMuZmFyOwogIH0KICBmdW5jdGlvbiB1cGRhdGUyKGZydXN0dW0pIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0ud2lkdGgpIHx8ICFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5hc3BlY3RSYXRpbykgfHwgIWRlZmluZWRfZGVmYXVsdChmcnVzdHVtLm5lYXIpIHx8ICFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5mYXIpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJ3aWR0aCwgYXNwZWN0UmF0aW8sIG5lYXIsIG9yIGZhciBwYXJhbWV0ZXJzIGFyZSBub3Qgc2V0LiIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGYgPSBmcnVzdHVtLl9vZmZDZW50ZXJGcnVzdHVtOwogICAgaWYgKGZydXN0dW0ud2lkdGggIT09IGZydXN0dW0uX3dpZHRoIHx8IGZydXN0dW0uYXNwZWN0UmF0aW8gIT09IGZydXN0dW0uX2FzcGVjdFJhdGlvIHx8IGZydXN0dW0ubmVhciAhPT0gZnJ1c3R1bS5fbmVhciB8fCBmcnVzdHVtLmZhciAhPT0gZnJ1c3R1bS5fZmFyKSB7CiAgICAgIGlmIChmcnVzdHVtLmFzcGVjdFJhdGlvIDwgMCkgewogICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhc3BlY3RSYXRpbyBtdXN0IGJlIHBvc2l0aXZlLiIpOwogICAgICB9CiAgICAgIGlmIChmcnVzdHVtLm5lYXIgPCAwIHx8IGZydXN0dW0ubmVhciA+IGZydXN0dW0uZmFyKSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAibmVhciBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvIGFuZCBsZXNzIHRoYW4gZmFyLiIKICAgICAgICApOwogICAgICB9CiAgICAgIGZydXN0dW0uX2FzcGVjdFJhdGlvID0gZnJ1c3R1bS5hc3BlY3RSYXRpbzsKICAgICAgZnJ1c3R1bS5fd2lkdGggPSBmcnVzdHVtLndpZHRoOwogICAgICBmcnVzdHVtLl9uZWFyID0gZnJ1c3R1bS5uZWFyOwogICAgICBmcnVzdHVtLl9mYXIgPSBmcnVzdHVtLmZhcjsKICAgICAgY29uc3QgcmF0aW8gPSAxIC8gZnJ1c3R1bS5hc3BlY3RSYXRpbzsKICAgICAgZi5yaWdodCA9IGZydXN0dW0ud2lkdGggKiAwLjU7CiAgICAgIGYubGVmdCA9IC1mLnJpZ2h0OwogICAgICBmLnRvcCA9IHJhdGlvICogZi5yaWdodDsKICAgICAgZi5ib3R0b20gPSAtZi50b3A7CiAgICAgIGYubmVhciA9IGZydXN0dW0ubmVhcjsKICAgICAgZi5mYXIgPSBmcnVzdHVtLmZhcjsKICAgIH0KICB9CiAgdmFyIE9ydGhvZ3JhcGhpY0ZydXN0dW1fZGVmYXVsdDsKICB2YXIgaW5pdF9PcnRob2dyYXBoaWNGcnVzdHVtID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9PcnRob2dyYXBoaWNGcnVzdHVtLmpzIigpIHsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9PcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtKCk7CiAgICAgIE9ydGhvZ3JhcGhpY0ZydXN0dW0ucGFja2VkTGVuZ3RoID0gNDsKICAgICAgT3J0aG9ncmFwaGljRnJ1c3R1bS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUud2lkdGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLmFzcGVjdFJhdGlvOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5uZWFyOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gdmFsdWUuZmFyOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgT3J0aG9ncmFwaGljRnJ1c3R1bS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IE9ydGhvZ3JhcGhpY0ZydXN0dW0oKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LndpZHRoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQuYXNwZWN0UmF0aW8gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC5uZWFyID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQuZmFyID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoT3J0aG9ncmFwaGljRnJ1c3R1bS5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBvcnRob2dyYXBoaWMgcHJvamVjdGlvbiBtYXRyaXggY29tcHV0ZWQgZnJvbSB0aGUgdmlldyBmcnVzdHVtLgogICAgICAgICAqIEBtZW1iZXJvZiBPcnRob2dyYXBoaWNGcnVzdHVtLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtNYXRyaXg0fQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIHByb2plY3Rpb25NYXRyaXg6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHVwZGF0ZTIodGhpcyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9vZmZDZW50ZXJGcnVzdHVtLnByb2plY3Rpb25NYXRyaXg7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBvcnRob2dyYXBoaWMgcHJvamVjdGlvbiBtYXRyaXggY29tcHV0ZWQgZnJvbSB0aGUgdmlldyBmcnVzdHVtLgogICAgICAgICAqIEBtZW1iZXJvZiBPcnRob2dyYXBoaWNGcnVzdHVtLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtPcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgb2ZmQ2VudGVyRnJ1c3R1bTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdXBkYXRlMih0aGlzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX29mZkNlbnRlckZydXN0dW07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgT3J0aG9ncmFwaGljRnJ1c3R1bS5wcm90b3R5cGUuY29tcHV0ZUN1bGxpbmdWb2x1bWUgPSBmdW5jdGlvbihwb3NpdGlvbiwgZGlyZWN0aW9uMiwgdXApIHsKICAgICAgICB1cGRhdGUyKHRoaXMpOwogICAgICAgIHJldHVybiB0aGlzLl9vZmZDZW50ZXJGcnVzdHVtLmNvbXB1dGVDdWxsaW5nVm9sdW1lKHBvc2l0aW9uLCBkaXJlY3Rpb24yLCB1cCk7CiAgICAgIH07CiAgICAgIE9ydGhvZ3JhcGhpY0ZydXN0dW0ucHJvdG90eXBlLmdldFBpeGVsRGltZW5zaW9ucyA9IGZ1bmN0aW9uKGRyYXdpbmdCdWZmZXJXaWR0aCwgZHJhd2luZ0J1ZmZlckhlaWdodCwgZGlzdGFuY2UsIHBpeGVsUmF0aW8sIHJlc3VsdCkgewogICAgICAgIHVwZGF0ZTIodGhpcyk7CiAgICAgICAgcmV0dXJuIHRoaXMuX29mZkNlbnRlckZydXN0dW0uZ2V0UGl4ZWxEaW1lbnNpb25zKAogICAgICAgICAgZHJhd2luZ0J1ZmZlcldpZHRoLAogICAgICAgICAgZHJhd2luZ0J1ZmZlckhlaWdodCwKICAgICAgICAgIGRpc3RhbmNlLAogICAgICAgICAgcGl4ZWxSYXRpbywKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIE9ydGhvZ3JhcGhpY0ZydXN0dW0ucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IE9ydGhvZ3JhcGhpY0ZydXN0dW0oKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmFzcGVjdFJhdGlvID0gdGhpcy5hc3BlY3RSYXRpbzsKICAgICAgICByZXN1bHQud2lkdGggPSB0aGlzLndpZHRoOwogICAgICAgIHJlc3VsdC5uZWFyID0gdGhpcy5uZWFyOwogICAgICAgIHJlc3VsdC5mYXIgPSB0aGlzLmZhcjsKICAgICAgICByZXN1bHQuX2FzcGVjdFJhdGlvID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fd2lkdGggPSB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll9uZWFyID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fZmFyID0gdm9pZCAwOwogICAgICAgIHRoaXMuX29mZkNlbnRlckZydXN0dW0uY2xvbmUocmVzdWx0Ll9vZmZDZW50ZXJGcnVzdHVtKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBPcnRob2dyYXBoaWNGcnVzdHVtLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihvdGhlcikgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG90aGVyKSB8fCAhKG90aGVyIGluc3RhbmNlb2YgT3J0aG9ncmFwaGljRnJ1c3R1bSkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdXBkYXRlMih0aGlzKTsKICAgICAgICB1cGRhdGUyKG90aGVyKTsKICAgICAgICByZXR1cm4gdGhpcy53aWR0aCA9PT0gb3RoZXIud2lkdGggJiYgdGhpcy5hc3BlY3RSYXRpbyA9PT0gb3RoZXIuYXNwZWN0UmF0aW8gJiYgdGhpcy5fb2ZmQ2VudGVyRnJ1c3R1bS5lcXVhbHMob3RoZXIuX29mZkNlbnRlckZydXN0dW0pOwogICAgICB9OwogICAgICBPcnRob2dyYXBoaWNGcnVzdHVtLnByb3RvdHlwZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24ob3RoZXIsIHJlbGF0aXZlRXBzaWxvbiwgYWJzb2x1dGVFcHNpbG9uKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob3RoZXIpIHx8ICEob3RoZXIgaW5zdGFuY2VvZiBPcnRob2dyYXBoaWNGcnVzdHVtKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICB1cGRhdGUyKHRoaXMpOwogICAgICAgIHVwZGF0ZTIob3RoZXIpOwogICAgICAgIHJldHVybiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMud2lkdGgsCiAgICAgICAgICBvdGhlci53aWR0aCwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLmFzcGVjdFJhdGlvLAogICAgICAgICAgb3RoZXIuYXNwZWN0UmF0aW8sCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIHRoaXMuX29mZkNlbnRlckZydXN0dW0uZXF1YWxzRXBzaWxvbigKICAgICAgICAgIG90aGVyLl9vZmZDZW50ZXJGcnVzdHVtLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgT3J0aG9ncmFwaGljRnJ1c3R1bV9kZWZhdWx0ID0gT3J0aG9ncmFwaGljRnJ1c3R1bTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bS5qcwogIGZ1bmN0aW9uIFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIHRoaXMubGVmdCA9IG9wdGlvbnMubGVmdDsKICAgIHRoaXMuX2xlZnQgPSB2b2lkIDA7CiAgICB0aGlzLnJpZ2h0ID0gb3B0aW9ucy5yaWdodDsKICAgIHRoaXMuX3JpZ2h0ID0gdm9pZCAwOwogICAgdGhpcy50b3AgPSBvcHRpb25zLnRvcDsKICAgIHRoaXMuX3RvcCA9IHZvaWQgMDsKICAgIHRoaXMuYm90dG9tID0gb3B0aW9ucy5ib3R0b207CiAgICB0aGlzLl9ib3R0b20gPSB2b2lkIDA7CiAgICB0aGlzLm5lYXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm5lYXIsIDEpOwogICAgdGhpcy5fbmVhciA9IHRoaXMubmVhcjsKICAgIHRoaXMuZmFyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5mYXIsIDVlOCk7CiAgICB0aGlzLl9mYXIgPSB0aGlzLmZhcjsKICAgIHRoaXMuX2N1bGxpbmdWb2x1bWUgPSBuZXcgQ3VsbGluZ1ZvbHVtZV9kZWZhdWx0KCk7CiAgICB0aGlzLl9wZXJzcGVjdGl2ZU1hdHJpeCA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgIHRoaXMuX2luZmluaXRlUGVyc3BlY3RpdmUgPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgfQogIGZ1bmN0aW9uIHVwZGF0ZTMoZnJ1c3R1bSkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5yaWdodCkgfHwgIWRlZmluZWRfZGVmYXVsdChmcnVzdHVtLmxlZnQpIHx8ICFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS50b3ApIHx8ICFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5ib3R0b20pIHx8ICFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5uZWFyKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0uZmFyKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAicmlnaHQsIGxlZnQsIHRvcCwgYm90dG9tLCBuZWFyLCBvciBmYXIgcGFyYW1ldGVycyBhcmUgbm90IHNldC4iCiAgICAgICk7CiAgICB9CiAgICBjb25zdCB0ID0gZnJ1c3R1bS50b3A7CiAgICBjb25zdCBiID0gZnJ1c3R1bS5ib3R0b207CiAgICBjb25zdCByID0gZnJ1c3R1bS5yaWdodDsKICAgIGNvbnN0IGwgPSBmcnVzdHVtLmxlZnQ7CiAgICBjb25zdCBuID0gZnJ1c3R1bS5uZWFyOwogICAgY29uc3QgZiA9IGZydXN0dW0uZmFyOwogICAgaWYgKHQgIT09IGZydXN0dW0uX3RvcCB8fCBiICE9PSBmcnVzdHVtLl9ib3R0b20gfHwgbCAhPT0gZnJ1c3R1bS5fbGVmdCB8fCByICE9PSBmcnVzdHVtLl9yaWdodCB8fCBuICE9PSBmcnVzdHVtLl9uZWFyIHx8IGYgIT09IGZydXN0dW0uX2ZhcikgewogICAgICBpZiAoZnJ1c3R1bS5uZWFyIDw9IDAgfHwgZnJ1c3R1bS5uZWFyID4gZnJ1c3R1bS5mYXIpIHsKICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICJuZWFyIG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8gYW5kIGxlc3MgdGhhbiBmYXIuIgogICAgICAgICk7CiAgICAgIH0KICAgICAgZnJ1c3R1bS5fbGVmdCA9IGw7CiAgICAgIGZydXN0dW0uX3JpZ2h0ID0gcjsKICAgICAgZnJ1c3R1bS5fdG9wID0gdDsKICAgICAgZnJ1c3R1bS5fYm90dG9tID0gYjsKICAgICAgZnJ1c3R1bS5fbmVhciA9IG47CiAgICAgIGZydXN0dW0uX2ZhciA9IGY7CiAgICAgIGZydXN0dW0uX3BlcnNwZWN0aXZlTWF0cml4ID0gTWF0cml4NF9kZWZhdWx0LmNvbXB1dGVQZXJzcGVjdGl2ZU9mZkNlbnRlcigKICAgICAgICBsLAogICAgICAgIHIsCiAgICAgICAgYiwKICAgICAgICB0LAogICAgICAgIG4sCiAgICAgICAgZiwKICAgICAgICBmcnVzdHVtLl9wZXJzcGVjdGl2ZU1hdHJpeAogICAgICApOwogICAgICBmcnVzdHVtLl9pbmZpbml0ZVBlcnNwZWN0aXZlID0gTWF0cml4NF9kZWZhdWx0LmNvbXB1dGVJbmZpbml0ZVBlcnNwZWN0aXZlT2ZmQ2VudGVyKAogICAgICAgIGwsCiAgICAgICAgciwKICAgICAgICBiLAogICAgICAgIHQsCiAgICAgICAgbiwKICAgICAgICBmcnVzdHVtLl9pbmZpbml0ZVBlcnNwZWN0aXZlCiAgICAgICk7CiAgICB9CiAgfQogIHZhciBnZXRQbGFuZXNSaWdodDIsIGdldFBsYW5lc05lYXJDZW50ZXIyLCBnZXRQbGFuZXNGYXJDZW50ZXIsIGdldFBsYW5lc05vcm1hbCwgUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtX2RlZmF1bHQ7CiAgdmFyIGluaXRfUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9QZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW0uanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW40KCk7CiAgICAgIGluaXRfQ3VsbGluZ1ZvbHVtZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bS5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBwZXJzcGVjdGl2ZSBwcm9qZWN0aW9uIG1hdHJpeCBjb21wdXRlZCBmcm9tIHRoZSB2aWV3IGZydXN0dW0uCiAgICAgICAgICogQG1lbWJlcm9mIFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7TWF0cml4NH0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKgogICAgICAgICAqIEBzZWUgUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtI2luZmluaXRlUHJvamVjdGlvbk1hdHJpeAogICAgICAgICAqLwogICAgICAgIHByb2plY3Rpb25NYXRyaXg6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHVwZGF0ZTModGhpcyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wZXJzcGVjdGl2ZU1hdHJpeDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHBlcnNwZWN0aXZlIHByb2plY3Rpb24gbWF0cml4IGNvbXB1dGVkIGZyb20gdGhlIHZpZXcgZnJ1c3R1bSB3aXRoIGFuIGluZmluaXRlIGZhciBwbGFuZS4KICAgICAgICAgKiBAbWVtYmVyb2YgUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtNYXRyaXg0fQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqCiAgICAgICAgICogQHNlZSBQZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW0jcHJvamVjdGlvbk1hdHJpeAogICAgICAgICAqLwogICAgICAgIGluZmluaXRlUHJvamVjdGlvbk1hdHJpeDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdXBkYXRlMyh0aGlzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2luZmluaXRlUGVyc3BlY3RpdmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgZ2V0UGxhbmVzUmlnaHQyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBnZXRQbGFuZXNOZWFyQ2VudGVyMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZ2V0UGxhbmVzRmFyQ2VudGVyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBnZXRQbGFuZXNOb3JtYWwgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bS5wcm90b3R5cGUuY29tcHV0ZUN1bGxpbmdWb2x1bWUgPSBmdW5jdGlvbihwb3NpdGlvbiwgZGlyZWN0aW9uMiwgdXApIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwb3NpdGlvbiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZGlyZWN0aW9uMikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkaXJlY3Rpb24gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHVwKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInVwIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBwbGFuZXMgPSB0aGlzLl9jdWxsaW5nVm9sdW1lLnBsYW5lczsKICAgICAgICBjb25zdCB0ID0gdGhpcy50b3A7CiAgICAgICAgY29uc3QgYiA9IHRoaXMuYm90dG9tOwogICAgICAgIGNvbnN0IHIgPSB0aGlzLnJpZ2h0OwogICAgICAgIGNvbnN0IGwgPSB0aGlzLmxlZnQ7CiAgICAgICAgY29uc3QgbiA9IHRoaXMubmVhcjsKICAgICAgICBjb25zdCBmID0gdGhpcy5mYXI7CiAgICAgICAgY29uc3QgcmlnaHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoZGlyZWN0aW9uMiwgdXAsIGdldFBsYW5lc1JpZ2h0Mik7CiAgICAgICAgY29uc3QgbmVhckNlbnRlciA9IGdldFBsYW5lc05lYXJDZW50ZXIyOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGRpcmVjdGlvbjIsIG4sIG5lYXJDZW50ZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24sIG5lYXJDZW50ZXIsIG5lYXJDZW50ZXIpOwogICAgICAgIGNvbnN0IGZhckNlbnRlciA9IGdldFBsYW5lc0ZhckNlbnRlcjsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihkaXJlY3Rpb24yLCBmLCBmYXJDZW50ZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24sIGZhckNlbnRlciwgZmFyQ2VudGVyKTsKICAgICAgICBjb25zdCBub3JtYWwyID0gZ2V0UGxhbmVzTm9ybWFsOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHJpZ2h0LCBsLCBub3JtYWwyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5lYXJDZW50ZXIsIG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChub3JtYWwyLCBwb3NpdGlvbiwgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShub3JtYWwyLCBub3JtYWwyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3Mobm9ybWFsMiwgdXAsIG5vcm1hbDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUobm9ybWFsMiwgbm9ybWFsMik7CiAgICAgICAgbGV0IHBsYW5lID0gcGxhbmVzWzBdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBsYW5lKSkgewogICAgICAgICAgcGxhbmUgPSBwbGFuZXNbMF0gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIHBsYW5lLnggPSBub3JtYWwyLng7CiAgICAgICAgcGxhbmUueSA9IG5vcm1hbDIueTsKICAgICAgICBwbGFuZS56ID0gbm9ybWFsMi56OwogICAgICAgIHBsYW5lLncgPSAtQ2FydGVzaWFuM19kZWZhdWx0LmRvdChub3JtYWwyLCBwb3NpdGlvbik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIocmlnaHQsIHIsIG5vcm1hbDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQobmVhckNlbnRlciwgbm9ybWFsMiwgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG5vcm1hbDIsIHBvc2l0aW9uLCBub3JtYWwyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3ModXAsIG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUobm9ybWFsMiwgbm9ybWFsMik7CiAgICAgICAgcGxhbmUgPSBwbGFuZXNbMV07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICBwbGFuZSA9IHBsYW5lc1sxXSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcGxhbmUueCA9IG5vcm1hbDIueDsKICAgICAgICBwbGFuZS55ID0gbm9ybWFsMi55OwogICAgICAgIHBsYW5lLnogPSBub3JtYWwyLno7CiAgICAgICAgcGxhbmUudyA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KG5vcm1hbDIsIHBvc2l0aW9uKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcih1cCwgYiwgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChuZWFyQ2VudGVyLCBub3JtYWwyLCBub3JtYWwyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3Qobm9ybWFsMiwgcG9zaXRpb24sIG5vcm1hbDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhyaWdodCwgbm9ybWFsMiwgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShub3JtYWwyLCBub3JtYWwyKTsKICAgICAgICBwbGFuZSA9IHBsYW5lc1syXTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZSkpIHsKICAgICAgICAgIHBsYW5lID0gcGxhbmVzWzJdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBwbGFuZS54ID0gbm9ybWFsMi54OwogICAgICAgIHBsYW5lLnkgPSBub3JtYWwyLnk7CiAgICAgICAgcGxhbmUueiA9IG5vcm1hbDIuejsKICAgICAgICBwbGFuZS53ID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3Qobm9ybWFsMiwgcG9zaXRpb24pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHVwLCB0LCBub3JtYWwyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5lYXJDZW50ZXIsIG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChub3JtYWwyLCBwb3NpdGlvbiwgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKG5vcm1hbDIsIHJpZ2h0LCBub3JtYWwyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgIHBsYW5lID0gcGxhbmVzWzNdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBsYW5lKSkgewogICAgICAgICAgcGxhbmUgPSBwbGFuZXNbM10gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIHBsYW5lLnggPSBub3JtYWwyLng7CiAgICAgICAgcGxhbmUueSA9IG5vcm1hbDIueTsKICAgICAgICBwbGFuZS56ID0gbm9ybWFsMi56OwogICAgICAgIHBsYW5lLncgPSAtQ2FydGVzaWFuM19kZWZhdWx0LmRvdChub3JtYWwyLCBwb3NpdGlvbik7CiAgICAgICAgcGxhbmUgPSBwbGFuZXNbNF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICBwbGFuZSA9IHBsYW5lc1s0XSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcGxhbmUueCA9IGRpcmVjdGlvbjIueDsKICAgICAgICBwbGFuZS55ID0gZGlyZWN0aW9uMi55OwogICAgICAgIHBsYW5lLnogPSBkaXJlY3Rpb24yLno7CiAgICAgICAgcGxhbmUudyA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjIsIG5lYXJDZW50ZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoZGlyZWN0aW9uMiwgbm9ybWFsMik7CiAgICAgICAgcGxhbmUgPSBwbGFuZXNbNV07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICBwbGFuZSA9IHBsYW5lc1s1XSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcGxhbmUueCA9IG5vcm1hbDIueDsKICAgICAgICBwbGFuZS55ID0gbm9ybWFsMi55OwogICAgICAgIHBsYW5lLnogPSBub3JtYWwyLno7CiAgICAgICAgcGxhbmUudyA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KG5vcm1hbDIsIGZhckNlbnRlcik7CiAgICAgICAgcmV0dXJuIHRoaXMuX2N1bGxpbmdWb2x1bWU7CiAgICAgIH07CiAgICAgIFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bS5wcm90b3R5cGUuZ2V0UGl4ZWxEaW1lbnNpb25zID0gZnVuY3Rpb24oZHJhd2luZ0J1ZmZlcldpZHRoLCBkcmF3aW5nQnVmZmVySGVpZ2h0LCBkaXN0YW5jZSwgcGl4ZWxSYXRpbywgcmVzdWx0KSB7CiAgICAgICAgdXBkYXRlMyh0aGlzKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChkcmF3aW5nQnVmZmVyV2lkdGgpIHx8ICFkZWZpbmVkX2RlZmF1bHQoZHJhd2luZ0J1ZmZlckhlaWdodCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiQm90aCBkcmF3aW5nQnVmZmVyV2lkdGggYW5kIGRyYXdpbmdCdWZmZXJIZWlnaHQgYXJlIHJlcXVpcmVkLiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChkcmF3aW5nQnVmZmVyV2lkdGggPD0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImRyYXdpbmdCdWZmZXJXaWR0aCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoZHJhd2luZ0J1ZmZlckhlaWdodCA8PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZHJhd2luZ0J1ZmZlckhlaWdodCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChkaXN0YW5jZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkaXN0YW5jZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGl4ZWxSYXRpbykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwaXhlbFJhdGlvIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGlmIChwaXhlbFJhdGlvIDw9IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwaXhlbFJhdGlvIG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8uIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJBIHJlc3VsdCBvYmplY3QgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGludmVyc2VOZWFyID0gMSAvIHRoaXMubmVhcjsKICAgICAgICBsZXQgdGFuVGhldGEgPSB0aGlzLnRvcCAqIGludmVyc2VOZWFyOwogICAgICAgIGNvbnN0IHBpeGVsSGVpZ2h0ID0gMiAqIHBpeGVsUmF0aW8gKiBkaXN0YW5jZSAqIHRhblRoZXRhIC8gZHJhd2luZ0J1ZmZlckhlaWdodDsKICAgICAgICB0YW5UaGV0YSA9IHRoaXMucmlnaHQgKiBpbnZlcnNlTmVhcjsKICAgICAgICBjb25zdCBwaXhlbFdpZHRoID0gMiAqIHBpeGVsUmF0aW8gKiBkaXN0YW5jZSAqIHRhblRoZXRhIC8gZHJhd2luZ0J1ZmZlcldpZHRoOwogICAgICAgIHJlc3VsdC54ID0gcGl4ZWxXaWR0aDsKICAgICAgICByZXN1bHQueSA9IHBpeGVsSGVpZ2h0OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bS5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtKCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5yaWdodCA9IHRoaXMucmlnaHQ7CiAgICAgICAgcmVzdWx0LmxlZnQgPSB0aGlzLmxlZnQ7CiAgICAgICAgcmVzdWx0LnRvcCA9IHRoaXMudG9wOwogICAgICAgIHJlc3VsdC5ib3R0b20gPSB0aGlzLmJvdHRvbTsKICAgICAgICByZXN1bHQubmVhciA9IHRoaXMubmVhcjsKICAgICAgICByZXN1bHQuZmFyID0gdGhpcy5mYXI7CiAgICAgICAgcmVzdWx0Ll9sZWZ0ID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fcmlnaHQgPSB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll90b3AgPSB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll9ib3R0b20gPSB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll9uZWFyID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fZmFyID0gdm9pZCAwOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bS5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ob3RoZXIpIHsKICAgICAgICByZXR1cm4gZGVmaW5lZF9kZWZhdWx0KG90aGVyKSAmJiBvdGhlciBpbnN0YW5jZW9mIFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bSAmJiB0aGlzLnJpZ2h0ID09PSBvdGhlci5yaWdodCAmJiB0aGlzLmxlZnQgPT09IG90aGVyLmxlZnQgJiYgdGhpcy50b3AgPT09IG90aGVyLnRvcCAmJiB0aGlzLmJvdHRvbSA9PT0gb3RoZXIuYm90dG9tICYmIHRoaXMubmVhciA9PT0gb3RoZXIubmVhciAmJiB0aGlzLmZhciA9PT0gb3RoZXIuZmFyOwogICAgICB9OwogICAgICBQZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW0ucHJvdG90eXBlLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihvdGhlciwgcmVsYXRpdmVFcHNpbG9uLCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICByZXR1cm4gb3RoZXIgPT09IHRoaXMgfHwgZGVmaW5lZF9kZWZhdWx0KG90aGVyKSAmJiBvdGhlciBpbnN0YW5jZW9mIFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMucmlnaHQsCiAgICAgICAgICBvdGhlci5yaWdodCwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLmxlZnQsCiAgICAgICAgICBvdGhlci5sZWZ0LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMudG9wLAogICAgICAgICAgb3RoZXIudG9wLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMuYm90dG9tLAogICAgICAgICAgb3RoZXIuYm90dG9tLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMubmVhciwKICAgICAgICAgIG90aGVyLm5lYXIsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy5mYXIsCiAgICAgICAgICBvdGhlci5mYXIsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApOwogICAgICB9OwogICAgICBQZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW1fZGVmYXVsdCA9IFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BlcnNwZWN0aXZlRnJ1c3R1bS5qcwogIGZ1bmN0aW9uIFBlcnNwZWN0aXZlRnJ1c3R1bShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIHRoaXMuX29mZkNlbnRlckZydXN0dW0gPSBuZXcgUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtX2RlZmF1bHQoKTsKICAgIHRoaXMuZm92ID0gb3B0aW9ucy5mb3Y7CiAgICB0aGlzLl9mb3YgPSB2b2lkIDA7CiAgICB0aGlzLl9mb3Z5ID0gdm9pZCAwOwogICAgdGhpcy5fc3NlRGVub21pbmF0b3IgPSB2b2lkIDA7CiAgICB0aGlzLmFzcGVjdFJhdGlvID0gb3B0aW9ucy5hc3BlY3RSYXRpbzsKICAgIHRoaXMuX2FzcGVjdFJhdGlvID0gdm9pZCAwOwogICAgdGhpcy5uZWFyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5uZWFyLCAxKTsKICAgIHRoaXMuX25lYXIgPSB0aGlzLm5lYXI7CiAgICB0aGlzLmZhciA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZmFyLCA1ZTgpOwogICAgdGhpcy5fZmFyID0gdGhpcy5mYXI7CiAgICB0aGlzLnhPZmZzZXQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnhPZmZzZXQsIDApOwogICAgdGhpcy5feE9mZnNldCA9IHRoaXMueE9mZnNldDsKICAgIHRoaXMueU9mZnNldCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMueU9mZnNldCwgMCk7CiAgICB0aGlzLl95T2Zmc2V0ID0gdGhpcy55T2Zmc2V0OwogIH0KICBmdW5jdGlvbiB1cGRhdGU0KGZydXN0dW0pIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0uZm92KSB8fCAhZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0uYXNwZWN0UmF0aW8pIHx8ICFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5uZWFyKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0uZmFyKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAiZm92LCBhc3BlY3RSYXRpbywgbmVhciwgb3IgZmFyIHBhcmFtZXRlcnMgYXJlIG5vdCBzZXQuIgogICAgICApOwogICAgfQogICAgY29uc3QgZiA9IGZydXN0dW0uX29mZkNlbnRlckZydXN0dW07CiAgICBpZiAoZnJ1c3R1bS5mb3YgIT09IGZydXN0dW0uX2ZvdiB8fCBmcnVzdHVtLmFzcGVjdFJhdGlvICE9PSBmcnVzdHVtLl9hc3BlY3RSYXRpbyB8fCBmcnVzdHVtLm5lYXIgIT09IGZydXN0dW0uX25lYXIgfHwgZnJ1c3R1bS5mYXIgIT09IGZydXN0dW0uX2ZhciB8fCBmcnVzdHVtLnhPZmZzZXQgIT09IGZydXN0dW0uX3hPZmZzZXQgfHwgZnJ1c3R1bS55T2Zmc2V0ICE9PSBmcnVzdHVtLl95T2Zmc2V0KSB7CiAgICAgIGlmIChmcnVzdHVtLmZvdiA8IDAgfHwgZnJ1c3R1bS5mb3YgPj0gTWF0aC5QSSkgewogICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJmb3YgbXVzdCBiZSBpbiB0aGUgcmFuZ2UgWzAsIFBJKS4iKTsKICAgICAgfQogICAgICBpZiAoZnJ1c3R1bS5hc3BlY3RSYXRpbyA8IDApIHsKICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXNwZWN0UmF0aW8gbXVzdCBiZSBwb3NpdGl2ZS4iKTsKICAgICAgfQogICAgICBpZiAoZnJ1c3R1bS5uZWFyIDwgMCB8fCBmcnVzdHVtLm5lYXIgPiBmcnVzdHVtLmZhcikgewogICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgIm5lYXIgbXVzdCBiZSBncmVhdGVyIHRoYW4gemVybyBhbmQgbGVzcyB0aGFuIGZhci4iCiAgICAgICAgKTsKICAgICAgfQogICAgICBmcnVzdHVtLl9hc3BlY3RSYXRpbyA9IGZydXN0dW0uYXNwZWN0UmF0aW87CiAgICAgIGZydXN0dW0uX2ZvdiA9IGZydXN0dW0uZm92OwogICAgICBmcnVzdHVtLl9mb3Z5ID0gZnJ1c3R1bS5hc3BlY3RSYXRpbyA8PSAxID8gZnJ1c3R1bS5mb3YgOiBNYXRoLmF0YW4oTWF0aC50YW4oZnJ1c3R1bS5mb3YgKiAwLjUpIC8gZnJ1c3R1bS5hc3BlY3RSYXRpbykgKiAyOwogICAgICBmcnVzdHVtLl9uZWFyID0gZnJ1c3R1bS5uZWFyOwogICAgICBmcnVzdHVtLl9mYXIgPSBmcnVzdHVtLmZhcjsKICAgICAgZnJ1c3R1bS5fc3NlRGVub21pbmF0b3IgPSAyICogTWF0aC50YW4oMC41ICogZnJ1c3R1bS5fZm92eSk7CiAgICAgIGZydXN0dW0uX3hPZmZzZXQgPSBmcnVzdHVtLnhPZmZzZXQ7CiAgICAgIGZydXN0dW0uX3lPZmZzZXQgPSBmcnVzdHVtLnlPZmZzZXQ7CiAgICAgIGYudG9wID0gZnJ1c3R1bS5uZWFyICogTWF0aC50YW4oMC41ICogZnJ1c3R1bS5fZm92eSk7CiAgICAgIGYuYm90dG9tID0gLWYudG9wOwogICAgICBmLnJpZ2h0ID0gZnJ1c3R1bS5hc3BlY3RSYXRpbyAqIGYudG9wOwogICAgICBmLmxlZnQgPSAtZi5yaWdodDsKICAgICAgZi5uZWFyID0gZnJ1c3R1bS5uZWFyOwogICAgICBmLmZhciA9IGZydXN0dW0uZmFyOwogICAgICBmLnJpZ2h0ICs9IGZydXN0dW0ueE9mZnNldDsKICAgICAgZi5sZWZ0ICs9IGZydXN0dW0ueE9mZnNldDsKICAgICAgZi50b3AgKz0gZnJ1c3R1bS55T2Zmc2V0OwogICAgICBmLmJvdHRvbSArPSBmcnVzdHVtLnlPZmZzZXQ7CiAgICB9CiAgfQogIHZhciBQZXJzcGVjdGl2ZUZydXN0dW1fZGVmYXVsdDsKICB2YXIgaW5pdF9QZXJzcGVjdGl2ZUZydXN0dW0gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BlcnNwZWN0aXZlRnJ1c3R1bS5qcyIoKSB7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtKCk7CiAgICAgIFBlcnNwZWN0aXZlRnJ1c3R1bS5wYWNrZWRMZW5ndGggPSA2OwogICAgICBQZXJzcGVjdGl2ZUZydXN0dW0ucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLmZvdjsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuYXNwZWN0UmF0aW87CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLm5lYXI7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLmZhcjsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUueE9mZnNldDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLnlPZmZzZXQ7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBQZXJzcGVjdGl2ZUZydXN0dW0udW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBQZXJzcGVjdGl2ZUZydXN0dW0oKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmZvdiA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LmFzcGVjdFJhdGlvID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQubmVhciA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LmZhciA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LnhPZmZzZXQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC55T2Zmc2V0ID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoUGVyc3BlY3RpdmVGcnVzdHVtLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHBlcnNwZWN0aXZlIHByb2plY3Rpb24gbWF0cml4IGNvbXB1dGVkIGZyb20gdGhlIHZpZXcgZnJ1c3R1bS4KICAgICAgICAgKiBAbWVtYmVyb2YgUGVyc3BlY3RpdmVGcnVzdHVtLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtNYXRyaXg0fQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqCiAgICAgICAgICogQHNlZSBQZXJzcGVjdGl2ZUZydXN0dW0jaW5maW5pdGVQcm9qZWN0aW9uTWF0cml4CiAgICAgICAgICovCiAgICAgICAgcHJvamVjdGlvbk1hdHJpeDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdXBkYXRlNCh0aGlzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX29mZkNlbnRlckZydXN0dW0ucHJvamVjdGlvbk1hdHJpeDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBwZXJzcGVjdGl2ZSBwcm9qZWN0aW9uIG1hdHJpeCBjb21wdXRlZCBmcm9tIHRoZSB2aWV3IGZydXN0dW0gd2l0aCBhbiBpbmZpbml0ZSBmYXIgcGxhbmUuCiAgICAgICAgICogQG1lbWJlcm9mIFBlcnNwZWN0aXZlRnJ1c3R1bS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7TWF0cml4NH0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKgogICAgICAgICAqIEBzZWUgUGVyc3BlY3RpdmVGcnVzdHVtI3Byb2plY3Rpb25NYXRyaXgKICAgICAgICAgKi8KICAgICAgICBpbmZpbml0ZVByb2plY3Rpb25NYXRyaXg6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHVwZGF0ZTQodGhpcyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9vZmZDZW50ZXJGcnVzdHVtLmluZmluaXRlUHJvamVjdGlvbk1hdHJpeDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGFuZ2xlIG9mIHRoZSB2ZXJ0aWNhbCBmaWVsZCBvZiB2aWV3LCBpbiByYWRpYW5zLgogICAgICAgICAqIEBtZW1iZXJvZiBQZXJzcGVjdGl2ZUZydXN0dW0ucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKiBAZGVmYXVsdCB1bmRlZmluZWQKICAgICAgICAgKi8KICAgICAgICBmb3Z5OiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB1cGRhdGU0KHRoaXMpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fZm92eTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgc3NlRGVub21pbmF0b3I6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHVwZGF0ZTQodGhpcyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zc2VEZW5vbWluYXRvcjsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIG9ydGhvZ3JhcGhpYyBwcm9qZWN0aW9uIG1hdHJpeCBjb21wdXRlZCBmcm9tIHRoZSB2aWV3IGZydXN0dW0uCiAgICAgICAgICogQG1lbWJlcm9mIFBlcnNwZWN0aXZlRnJ1c3R1bS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7UGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgb2ZmQ2VudGVyRnJ1c3R1bTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdXBkYXRlNCh0aGlzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX29mZkNlbnRlckZydXN0dW07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgUGVyc3BlY3RpdmVGcnVzdHVtLnByb3RvdHlwZS5jb21wdXRlQ3VsbGluZ1ZvbHVtZSA9IGZ1bmN0aW9uKHBvc2l0aW9uLCBkaXJlY3Rpb24yLCB1cCkgewogICAgICAgIHVwZGF0ZTQodGhpcyk7CiAgICAgICAgcmV0dXJuIHRoaXMuX29mZkNlbnRlckZydXN0dW0uY29tcHV0ZUN1bGxpbmdWb2x1bWUocG9zaXRpb24sIGRpcmVjdGlvbjIsIHVwKTsKICAgICAgfTsKICAgICAgUGVyc3BlY3RpdmVGcnVzdHVtLnByb3RvdHlwZS5nZXRQaXhlbERpbWVuc2lvbnMgPSBmdW5jdGlvbihkcmF3aW5nQnVmZmVyV2lkdGgsIGRyYXdpbmdCdWZmZXJIZWlnaHQsIGRpc3RhbmNlLCBwaXhlbFJhdGlvLCByZXN1bHQpIHsKICAgICAgICB1cGRhdGU0KHRoaXMpOwogICAgICAgIHJldHVybiB0aGlzLl9vZmZDZW50ZXJGcnVzdHVtLmdldFBpeGVsRGltZW5zaW9ucygKICAgICAgICAgIGRyYXdpbmdCdWZmZXJXaWR0aCwKICAgICAgICAgIGRyYXdpbmdCdWZmZXJIZWlnaHQsCiAgICAgICAgICBkaXN0YW5jZSwKICAgICAgICAgIHBpeGVsUmF0aW8sCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBQZXJzcGVjdGl2ZUZydXN0dW0ucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFBlcnNwZWN0aXZlRnJ1c3R1bSgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuYXNwZWN0UmF0aW8gPSB0aGlzLmFzcGVjdFJhdGlvOwogICAgICAgIHJlc3VsdC5mb3YgPSB0aGlzLmZvdjsKICAgICAgICByZXN1bHQubmVhciA9IHRoaXMubmVhcjsKICAgICAgICByZXN1bHQuZmFyID0gdGhpcy5mYXI7CiAgICAgICAgcmVzdWx0Ll9hc3BlY3RSYXRpbyA9IHZvaWQgMDsKICAgICAgICByZXN1bHQuX2ZvdiA9IHZvaWQgMDsKICAgICAgICByZXN1bHQuX25lYXIgPSB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll9mYXIgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5fb2ZmQ2VudGVyRnJ1c3R1bS5jbG9uZShyZXN1bHQuX29mZkNlbnRlckZydXN0dW0pOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFBlcnNwZWN0aXZlRnJ1c3R1bS5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ob3RoZXIpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvdGhlcikgfHwgIShvdGhlciBpbnN0YW5jZW9mIFBlcnNwZWN0aXZlRnJ1c3R1bSkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdXBkYXRlNCh0aGlzKTsKICAgICAgICB1cGRhdGU0KG90aGVyKTsKICAgICAgICByZXR1cm4gdGhpcy5mb3YgPT09IG90aGVyLmZvdiAmJiB0aGlzLmFzcGVjdFJhdGlvID09PSBvdGhlci5hc3BlY3RSYXRpbyAmJiB0aGlzLl9vZmZDZW50ZXJGcnVzdHVtLmVxdWFscyhvdGhlci5fb2ZmQ2VudGVyRnJ1c3R1bSk7CiAgICAgIH07CiAgICAgIFBlcnNwZWN0aXZlRnJ1c3R1bS5wcm90b3R5cGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKG90aGVyLCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG90aGVyKSB8fCAhKG90aGVyIGluc3RhbmNlb2YgUGVyc3BlY3RpdmVGcnVzdHVtKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICB1cGRhdGU0KHRoaXMpOwogICAgICAgIHVwZGF0ZTQob3RoZXIpOwogICAgICAgIHJldHVybiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMuZm92LAogICAgICAgICAgb3RoZXIuZm92LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMuYXNwZWN0UmF0aW8sCiAgICAgICAgICBvdGhlci5hc3BlY3RSYXRpbywKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgdGhpcy5fb2ZmQ2VudGVyRnJ1c3R1bS5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgb3RoZXIuX29mZkNlbnRlckZydXN0dW0sCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApOwogICAgICB9OwogICAgICBQZXJzcGVjdGl2ZUZydXN0dW1fZGVmYXVsdCA9IFBlcnNwZWN0aXZlRnJ1c3R1bTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0ZydXN0dW1HZW9tZXRyeS5qcwogIGZ1bmN0aW9uIEZydXN0dW1HZW9tZXRyeShvcHRpb25zKSB7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm9wdGlvbnMiLCBvcHRpb25zKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib3B0aW9ucy5mcnVzdHVtIiwgb3B0aW9ucy5mcnVzdHVtKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib3B0aW9ucy5vcmlnaW4iLCBvcHRpb25zLm9yaWdpbik7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm9wdGlvbnMub3JpZW50YXRpb24iLCBvcHRpb25zLm9yaWVudGF0aW9uKTsKICAgIGNvbnN0IGZydXN0dW0gPSBvcHRpb25zLmZydXN0dW07CiAgICBjb25zdCBvcmllbnRhdGlvbiA9IG9wdGlvbnMub3JpZW50YXRpb247CiAgICBjb25zdCBvcmlnaW4gPSBvcHRpb25zLm9yaWdpbjsKICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMudmVydGV4Rm9ybWF0LCBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5ERUZBVUxUKTsKICAgIGNvbnN0IGRyYXdOZWFyUGxhbmUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLl9kcmF3TmVhclBsYW5lLCB0cnVlKTsKICAgIGxldCBmcnVzdHVtVHlwZTsKICAgIGxldCBmcnVzdHVtUGFja2VkTGVuZ3RoOwogICAgaWYgKGZydXN0dW0gaW5zdGFuY2VvZiBQZXJzcGVjdGl2ZUZydXN0dW1fZGVmYXVsdCkgewogICAgICBmcnVzdHVtVHlwZSA9IFBFUlNQRUNUSVZFOwogICAgICBmcnVzdHVtUGFja2VkTGVuZ3RoID0gUGVyc3BlY3RpdmVGcnVzdHVtX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgfSBlbHNlIGlmIChmcnVzdHVtIGluc3RhbmNlb2YgT3J0aG9ncmFwaGljRnJ1c3R1bV9kZWZhdWx0KSB7CiAgICAgIGZydXN0dW1UeXBlID0gT1JUSE9HUkFQSElDOwogICAgICBmcnVzdHVtUGFja2VkTGVuZ3RoID0gT3J0aG9ncmFwaGljRnJ1c3R1bV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIH0KICAgIHRoaXMuX2ZydXN0dW1UeXBlID0gZnJ1c3R1bVR5cGU7CiAgICB0aGlzLl9mcnVzdHVtID0gZnJ1c3R1bS5jbG9uZSgpOwogICAgdGhpcy5fb3JpZ2luID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG9yaWdpbik7CiAgICB0aGlzLl9vcmllbnRhdGlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC5jbG9uZShvcmllbnRhdGlvbik7CiAgICB0aGlzLl9kcmF3TmVhclBsYW5lID0gZHJhd05lYXJQbGFuZTsKICAgIHRoaXMuX3ZlcnRleEZvcm1hdCA9IHZlcnRleEZvcm1hdDsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlRnJ1c3R1bUdlb21ldHJ5IjsKICAgIHRoaXMucGFja2VkTGVuZ3RoID0gMiArIGZydXN0dW1QYWNrZWRMZW5ndGggKyBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgUXVhdGVybmlvbl9kZWZhdWx0LnBhY2tlZExlbmd0aCArIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICB9CiAgZnVuY3Rpb24gZ2V0QXR0cmlidXRlcyhvZmZzZXQsIG5vcm1hbHMsIHRhbmdlbnRzLCBiaXRhbmdlbnRzLCBzdCwgbm9ybWFsMiwgdGFuZ2VudCwgYml0YW5nZW50KSB7CiAgICBjb25zdCBzdE9mZnNldCA9IG9mZnNldCAvIDMgKiAyOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyArK2kpIHsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChub3JtYWxzKSkgewogICAgICAgIG5vcm1hbHNbb2Zmc2V0XSA9IG5vcm1hbDIueDsKICAgICAgICBub3JtYWxzW29mZnNldCArIDFdID0gbm9ybWFsMi55OwogICAgICAgIG5vcm1hbHNbb2Zmc2V0ICsgMl0gPSBub3JtYWwyLno7CiAgICAgIH0KICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0YW5nZW50cykpIHsKICAgICAgICB0YW5nZW50c1tvZmZzZXRdID0gdGFuZ2VudC54OwogICAgICAgIHRhbmdlbnRzW29mZnNldCArIDFdID0gdGFuZ2VudC55OwogICAgICAgIHRhbmdlbnRzW29mZnNldCArIDJdID0gdGFuZ2VudC56OwogICAgICB9CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYml0YW5nZW50cykpIHsKICAgICAgICBiaXRhbmdlbnRzW29mZnNldF0gPSBiaXRhbmdlbnQueDsKICAgICAgICBiaXRhbmdlbnRzW29mZnNldCArIDFdID0gYml0YW5nZW50Lnk7CiAgICAgICAgYml0YW5nZW50c1tvZmZzZXQgKyAyXSA9IGJpdGFuZ2VudC56OwogICAgICB9CiAgICAgIG9mZnNldCArPSAzOwogICAgfQogICAgc3Rbc3RPZmZzZXRdID0gMDsKICAgIHN0W3N0T2Zmc2V0ICsgMV0gPSAwOwogICAgc3Rbc3RPZmZzZXQgKyAyXSA9IDE7CiAgICBzdFtzdE9mZnNldCArIDNdID0gMDsKICAgIHN0W3N0T2Zmc2V0ICsgNF0gPSAxOwogICAgc3Rbc3RPZmZzZXQgKyA1XSA9IDE7CiAgICBzdFtzdE9mZnNldCArIDZdID0gMDsKICAgIHN0W3N0T2Zmc2V0ICsgN10gPSAxOwogIH0KICB2YXIgUEVSU1BFQ1RJVkUsIE9SVEhPR1JBUEhJQywgc2NyYXRjaFBhY2tQZXJzcGVjdGl2ZSwgc2NyYXRjaFBhY2tPcnRob2dyYXBoaWMsIHNjcmF0Y2hQYWNrUXVhdGVybmlvbiwgc2NyYXRjaFBhY2tvcmlnaW4sIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ3LCBzY3JhdGNoUm90YXRpb25NYXRyaXgsIHNjcmF0Y2hWaWV3TWF0cml4LCBzY3JhdGNoSW52ZXJzZU1hdHJpeCwgc2NyYXRjaFhEaXJlY3Rpb24sIHNjcmF0Y2hZRGlyZWN0aW9uLCBzY3JhdGNoWkRpcmVjdGlvbiwgc2NyYXRjaE5lZ2F0aXZlWCwgc2NyYXRjaE5lZ2F0aXZlWSwgc2NyYXRjaE5lZ2F0aXZlWiwgZnJ1c3R1bVNwbGl0cywgZnJ1c3R1bUNvcm5lcnNOREMsIHNjcmF0Y2hGcnVzdHVtQ29ybmVycywgRnJ1c3R1bUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfRnJ1c3R1bUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9GcnVzdHVtR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRlc2lhbjQoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfTWF0cml4NCgpOwogICAgICBpbml0X09ydGhvZ3JhcGhpY0ZydXN0dW0oKTsKICAgICAgaW5pdF9QZXJzcGVjdGl2ZUZydXN0dW0oKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfUXVhdGVybmlvbigpOwogICAgICBpbml0X1ZlcnRleEZvcm1hdCgpOwogICAgICBQRVJTUEVDVElWRSA9IDA7CiAgICAgIE9SVEhPR1JBUEhJQyA9IDE7CiAgICAgIEZydXN0dW1HZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBmcnVzdHVtVHlwZSA9IHZhbHVlLl9mcnVzdHVtVHlwZTsKICAgICAgICBjb25zdCBmcnVzdHVtID0gdmFsdWUuX2ZydXN0dW07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGZydXN0dW1UeXBlOwogICAgICAgIGlmIChmcnVzdHVtVHlwZSA9PT0gUEVSU1BFQ1RJVkUpIHsKICAgICAgICAgIFBlcnNwZWN0aXZlRnJ1c3R1bV9kZWZhdWx0LnBhY2soZnJ1c3R1bSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgICAgc3RhcnRpbmdJbmRleCArPSBQZXJzcGVjdGl2ZUZydXN0dW1fZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIE9ydGhvZ3JhcGhpY0ZydXN0dW1fZGVmYXVsdC5wYWNrKGZydXN0dW0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gT3J0aG9ncmFwaGljRnJ1c3R1bV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmFsdWUuX29yaWdpbiwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBRdWF0ZXJuaW9uX2RlZmF1bHQucGFjayh2YWx1ZS5fb3JpZW50YXRpb24sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFF1YXRlcm5pb25fZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFjayh2YWx1ZS5fdmVydGV4Rm9ybWF0LCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5fZHJhd05lYXJQbGFuZSA/IDEgOiAwOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaFBhY2tQZXJzcGVjdGl2ZSA9IG5ldyBQZXJzcGVjdGl2ZUZydXN0dW1fZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGFja09ydGhvZ3JhcGhpYyA9IG5ldyBPcnRob2dyYXBoaWNGcnVzdHVtX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBhY2tRdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb25fZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGFja29yaWdpbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDcgPSBuZXcgVmVydGV4Rm9ybWF0X2RlZmF1bHQoKTsKICAgICAgRnJ1c3R1bUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBmcnVzdHVtVHlwZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgbGV0IGZydXN0dW07CiAgICAgICAgaWYgKGZydXN0dW1UeXBlID09PSBQRVJTUEVDVElWRSkgewogICAgICAgICAgZnJ1c3R1bSA9IFBlcnNwZWN0aXZlRnJ1c3R1bV9kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgYXJyYXksCiAgICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICAgIHNjcmF0Y2hQYWNrUGVyc3BlY3RpdmUKICAgICAgICAgICk7CiAgICAgICAgICBzdGFydGluZ0luZGV4ICs9IFBlcnNwZWN0aXZlRnJ1c3R1bV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZnJ1c3R1bSA9IE9ydGhvZ3JhcGhpY0ZydXN0dW1fZGVmYXVsdC51bnBhY2soCiAgICAgICAgICAgIGFycmF5LAogICAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgICBzY3JhdGNoUGFja09ydGhvZ3JhcGhpYwogICAgICAgICAgKTsKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gT3J0aG9ncmFwaGljRnJ1c3R1bV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb3JpZ2luID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaFBhY2tvcmlnaW4pOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBvcmllbnRhdGlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoUGFja1F1YXRlcm5pb24KICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gUXVhdGVybmlvbl9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0NwogICAgICAgICk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgZHJhd05lYXJQbGFuZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdID09PSAxOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgRnJ1c3R1bUdlb21ldHJ5KHsKICAgICAgICAgICAgZnJ1c3R1bSwKICAgICAgICAgICAgb3JpZ2luLAogICAgICAgICAgICBvcmllbnRhdGlvbiwKICAgICAgICAgICAgdmVydGV4Rm9ybWF0LAogICAgICAgICAgICBfZHJhd05lYXJQbGFuZTogZHJhd05lYXJQbGFuZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGZydXN0dW1SZXN1bHQgPSBmcnVzdHVtVHlwZSA9PT0gcmVzdWx0Ll9mcnVzdHVtVHlwZSA/IHJlc3VsdC5fZnJ1c3R1bSA6IHZvaWQgMDsKICAgICAgICByZXN1bHQuX2ZydXN0dW0gPSBmcnVzdHVtLmNsb25lKGZydXN0dW1SZXN1bHQpOwogICAgICAgIHJlc3VsdC5fZnJ1c3R1bVR5cGUgPSBmcnVzdHVtVHlwZTsKICAgICAgICByZXN1bHQuX29yaWdpbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShvcmlnaW4sIHJlc3VsdC5fb3JpZ2luKTsKICAgICAgICByZXN1bHQuX29yaWVudGF0aW9uID0gUXVhdGVybmlvbl9kZWZhdWx0LmNsb25lKG9yaWVudGF0aW9uLCByZXN1bHQuX29yaWVudGF0aW9uKTsKICAgICAgICByZXN1bHQuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCwgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQpOwogICAgICAgIHJlc3VsdC5fZHJhd05lYXJQbGFuZSA9IGRyYXdOZWFyUGxhbmU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaFJvdGF0aW9uTWF0cml4ID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVmlld01hdHJpeCA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEludmVyc2VNYXRyaXggPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hYRGlyZWN0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoWURpcmVjdGlvbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFpEaXJlY3Rpb24gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hOZWdhdGl2ZVggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hOZWdhdGl2ZVkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hOZWdhdGl2ZVogPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZydXN0dW1TcGxpdHMgPSBuZXcgQXJyYXkoMyk7CiAgICAgIGZydXN0dW1Db3JuZXJzTkRDID0gbmV3IEFycmF5KDQpOwogICAgICBmcnVzdHVtQ29ybmVyc05EQ1swXSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoLTEsIC0xLCAxLCAxKTsKICAgICAgZnJ1c3R1bUNvcm5lcnNORENbMV0gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KDEsIC0xLCAxLCAxKTsKICAgICAgZnJ1c3R1bUNvcm5lcnNORENbMl0gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KDEsIDEsIDEsIDEpOwogICAgICBmcnVzdHVtQ29ybmVyc05EQ1szXSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoLTEsIDEsIDEsIDEpOwogICAgICBzY3JhdGNoRnJ1c3R1bUNvcm5lcnMgPSBuZXcgQXJyYXkoNCk7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgKytpKSB7CiAgICAgICAgc2NyYXRjaEZydXN0dW1Db3JuZXJzW2ldID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICB9CiAgICAgIEZydXN0dW1HZW9tZXRyeS5fY29tcHV0ZU5lYXJGYXJQbGFuZXMgPSBmdW5jdGlvbihvcmlnaW4sIG9yaWVudGF0aW9uLCBmcnVzdHVtVHlwZSwgZnJ1c3R1bSwgcG9zaXRpb25zLCB4RGlyZWN0aW9uLCB5RGlyZWN0aW9uLCB6RGlyZWN0aW9uKSB7CiAgICAgICAgY29uc3Qgcm90YXRpb25NYXRyaXggPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24oCiAgICAgICAgICBvcmllbnRhdGlvbiwKICAgICAgICAgIHNjcmF0Y2hSb3RhdGlvbk1hdHJpeAogICAgICAgICk7CiAgICAgICAgbGV0IHggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh4RGlyZWN0aW9uLCBzY3JhdGNoWERpcmVjdGlvbik7CiAgICAgICAgbGV0IHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh5RGlyZWN0aW9uLCBzY3JhdGNoWURpcmVjdGlvbik7CiAgICAgICAgbGV0IHogPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh6RGlyZWN0aW9uLCBzY3JhdGNoWkRpcmVjdGlvbik7CiAgICAgICAgeCA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4ocm90YXRpb25NYXRyaXgsIDAsIHgpOwogICAgICAgIHkgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKHJvdGF0aW9uTWF0cml4LCAxLCB5KTsKICAgICAgICB6ID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihyb3RhdGlvbk1hdHJpeCwgMiwgeik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSh4LCB4KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHksIHkpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoeiwgeik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZSh4LCB4KTsKICAgICAgICBjb25zdCB2aWV3ID0gTWF0cml4NF9kZWZhdWx0LmNvbXB1dGVWaWV3KG9yaWdpbiwgeiwgeSwgeCwgc2NyYXRjaFZpZXdNYXRyaXgpOwogICAgICAgIGxldCBpbnZlcnNlVmlldzsKICAgICAgICBsZXQgaW52ZXJzZVZpZXdQcm9qZWN0aW9uOwogICAgICAgIGNvbnN0IHByb2plY3Rpb24gPSBmcnVzdHVtLnByb2plY3Rpb25NYXRyaXg7CiAgICAgICAgaWYgKGZydXN0dW1UeXBlID09PSBQRVJTUEVDVElWRSkgewogICAgICAgICAgY29uc3Qgdmlld1Byb2plY3Rpb24gPSBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHkoCiAgICAgICAgICAgIHByb2plY3Rpb24sCiAgICAgICAgICAgIHZpZXcsCiAgICAgICAgICAgIHNjcmF0Y2hJbnZlcnNlTWF0cml4CiAgICAgICAgICApOwogICAgICAgICAgaW52ZXJzZVZpZXdQcm9qZWN0aW9uID0gTWF0cml4NF9kZWZhdWx0LmludmVyc2UoCiAgICAgICAgICAgIHZpZXdQcm9qZWN0aW9uLAogICAgICAgICAgICBzY3JhdGNoSW52ZXJzZU1hdHJpeAogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaW52ZXJzZVZpZXcgPSBNYXRyaXg0X2RlZmF1bHQuaW52ZXJzZVRyYW5zZm9ybWF0aW9uKHZpZXcsIHNjcmF0Y2hJbnZlcnNlTWF0cml4KTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnZlcnNlVmlld1Byb2plY3Rpb24pKSB7CiAgICAgICAgICBmcnVzdHVtU3BsaXRzWzBdID0gZnJ1c3R1bS5uZWFyOwogICAgICAgICAgZnJ1c3R1bVNwbGl0c1sxXSA9IGZydXN0dW0uZmFyOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmcnVzdHVtU3BsaXRzWzBdID0gMDsKICAgICAgICAgIGZydXN0dW1TcGxpdHNbMV0gPSBmcnVzdHVtLm5lYXI7CiAgICAgICAgICBmcnVzdHVtU3BsaXRzWzJdID0gZnJ1c3R1bS5mYXI7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMjsgKytpKSB7CiAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IDQ7ICsraikgewogICAgICAgICAgICBsZXQgY29ybmVyID0gQ2FydGVzaWFuNF9kZWZhdWx0LmNsb25lKAogICAgICAgICAgICAgIGZydXN0dW1Db3JuZXJzTkRDW2pdLAogICAgICAgICAgICAgIHNjcmF0Y2hGcnVzdHVtQ29ybmVyc1tqXQogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbnZlcnNlVmlld1Byb2plY3Rpb24pKSB7CiAgICAgICAgICAgICAgY29uc3Qgb2ZmQ2VudGVyRnJ1c3R1bSA9IGZydXN0dW0ub2ZmQ2VudGVyRnJ1c3R1bTsKICAgICAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZkNlbnRlckZydXN0dW0pKSB7CiAgICAgICAgICAgICAgICBmcnVzdHVtID0gb2ZmQ2VudGVyRnJ1c3R1bTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29uc3QgbmVhciA9IGZydXN0dW1TcGxpdHNbaV07CiAgICAgICAgICAgICAgY29uc3QgZmFyID0gZnJ1c3R1bVNwbGl0c1tpICsgMV07CiAgICAgICAgICAgICAgY29ybmVyLnggPSAoY29ybmVyLnggKiAoZnJ1c3R1bS5yaWdodCAtIGZydXN0dW0ubGVmdCkgKyBmcnVzdHVtLmxlZnQgKyBmcnVzdHVtLnJpZ2h0KSAqIDAuNTsKICAgICAgICAgICAgICBjb3JuZXIueSA9IChjb3JuZXIueSAqIChmcnVzdHVtLnRvcCAtIGZydXN0dW0uYm90dG9tKSArIGZydXN0dW0uYm90dG9tICsgZnJ1c3R1bS50b3ApICogMC41OwogICAgICAgICAgICAgIGNvcm5lci56ID0gKGNvcm5lci56ICogKG5lYXIgLSBmYXIpIC0gbmVhciAtIGZhcikgKiAwLjU7CiAgICAgICAgICAgICAgY29ybmVyLncgPSAxOwogICAgICAgICAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKGludmVyc2VWaWV3LCBjb3JuZXIsIGNvcm5lcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29ybmVyID0gTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoCiAgICAgICAgICAgICAgICBpbnZlcnNlVmlld1Byb2plY3Rpb24sCiAgICAgICAgICAgICAgICBjb3JuZXIsCiAgICAgICAgICAgICAgICBjb3JuZXIKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGNvbnN0IHcgPSAxIC8gY29ybmVyLnc7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoY29ybmVyLCB3LCBjb3JuZXIpOwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIG9yaWdpbiwgY29ybmVyKTsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGNvcm5lciwgY29ybmVyKTsKICAgICAgICAgICAgICBjb25zdCBmYWMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHosIGNvcm5lcik7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoY29ybmVyLCBmcnVzdHVtU3BsaXRzW2ldIC8gZmFjLCBjb3JuZXIpOwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCBvcmlnaW4sIGNvcm5lcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcG9zaXRpb25zWzEyICogaSArIGogKiAzXSA9IGNvcm5lci54OwogICAgICAgICAgICBwb3NpdGlvbnNbMTIgKiBpICsgaiAqIDMgKyAxXSA9IGNvcm5lci55OwogICAgICAgICAgICBwb3NpdGlvbnNbMTIgKiBpICsgaiAqIDMgKyAyXSA9IGNvcm5lci56OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgICAgRnJ1c3R1bUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oZnJ1c3R1bUdlb21ldHJ5KSB7CiAgICAgICAgY29uc3QgZnJ1c3R1bVR5cGUgPSBmcnVzdHVtR2VvbWV0cnkuX2ZydXN0dW1UeXBlOwogICAgICAgIGNvbnN0IGZydXN0dW0gPSBmcnVzdHVtR2VvbWV0cnkuX2ZydXN0dW07CiAgICAgICAgY29uc3Qgb3JpZ2luID0gZnJ1c3R1bUdlb21ldHJ5Ll9vcmlnaW47CiAgICAgICAgY29uc3Qgb3JpZW50YXRpb24gPSBmcnVzdHVtR2VvbWV0cnkuX29yaWVudGF0aW9uOwogICAgICAgIGNvbnN0IGRyYXdOZWFyUGxhbmUgPSBmcnVzdHVtR2VvbWV0cnkuX2RyYXdOZWFyUGxhbmU7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gZnJ1c3R1bUdlb21ldHJ5Ll92ZXJ0ZXhGb3JtYXQ7CiAgICAgICAgY29uc3QgbnVtYmVyT2ZQbGFuZXMgPSBkcmF3TmVhclBsYW5lID8gNiA6IDU7CiAgICAgICAgbGV0IHBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoMyAqIDQgKiA2KTsKICAgICAgICBGcnVzdHVtR2VvbWV0cnkuX2NvbXB1dGVOZWFyRmFyUGxhbmVzKAogICAgICAgICAgb3JpZ2luLAogICAgICAgICAgb3JpZW50YXRpb24sCiAgICAgICAgICBmcnVzdHVtVHlwZSwKICAgICAgICAgIGZydXN0dW0sCiAgICAgICAgICBwb3NpdGlvbnMKICAgICAgICApOwogICAgICAgIGxldCBvZmZzZXQgPSAzICogNCAqIDI7CiAgICAgICAgcG9zaXRpb25zW29mZnNldF0gPSBwb3NpdGlvbnNbMyAqIDRdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAxXSA9IHBvc2l0aW9uc1szICogNCArIDFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAyXSA9IHBvc2l0aW9uc1szICogNCArIDJdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAzXSA9IHBvc2l0aW9uc1swXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgNF0gPSBwb3NpdGlvbnNbMV07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDVdID0gcG9zaXRpb25zWzJdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA2XSA9IHBvc2l0aW9uc1szICogM107CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDddID0gcG9zaXRpb25zWzMgKiAzICsgMV07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDhdID0gcG9zaXRpb25zWzMgKiAzICsgMl07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDldID0gcG9zaXRpb25zWzMgKiA3XTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgMTBdID0gcG9zaXRpb25zWzMgKiA3ICsgMV07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDExXSA9IHBvc2l0aW9uc1szICogNyArIDJdOwogICAgICAgIG9mZnNldCArPSAzICogNDsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0XSA9IHBvc2l0aW9uc1szICogNV07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDFdID0gcG9zaXRpb25zWzMgKiA1ICsgMV07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDJdID0gcG9zaXRpb25zWzMgKiA1ICsgMl07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDNdID0gcG9zaXRpb25zWzNdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA0XSA9IHBvc2l0aW9uc1szICsgMV07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDVdID0gcG9zaXRpb25zWzMgKyAyXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgNl0gPSBwb3NpdGlvbnNbMF07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDddID0gcG9zaXRpb25zWzFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA4XSA9IHBvc2l0aW9uc1syXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgOV0gPSBwb3NpdGlvbnNbMyAqIDRdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAxMF0gPSBwb3NpdGlvbnNbMyAqIDQgKyAxXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgMTFdID0gcG9zaXRpb25zWzMgKiA0ICsgMl07CiAgICAgICAgb2Zmc2V0ICs9IDMgKiA0OwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXRdID0gcG9zaXRpb25zWzNdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAxXSA9IHBvc2l0aW9uc1szICsgMV07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDJdID0gcG9zaXRpb25zWzMgKyAyXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgM10gPSBwb3NpdGlvbnNbMyAqIDVdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA0XSA9IHBvc2l0aW9uc1szICogNSArIDFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA1XSA9IHBvc2l0aW9uc1szICogNSArIDJdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA2XSA9IHBvc2l0aW9uc1szICogNl07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDddID0gcG9zaXRpb25zWzMgKiA2ICsgMV07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDhdID0gcG9zaXRpb25zWzMgKiA2ICsgMl07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDldID0gcG9zaXRpb25zWzMgKiAyXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgMTBdID0gcG9zaXRpb25zWzMgKiAyICsgMV07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDExXSA9IHBvc2l0aW9uc1szICogMiArIDJdOwogICAgICAgIG9mZnNldCArPSAzICogNDsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0XSA9IHBvc2l0aW9uc1szICogMl07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDFdID0gcG9zaXRpb25zWzMgKiAyICsgMV07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDJdID0gcG9zaXRpb25zWzMgKiAyICsgMl07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDNdID0gcG9zaXRpb25zWzMgKiA2XTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgNF0gPSBwb3NpdGlvbnNbMyAqIDYgKyAxXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgNV0gPSBwb3NpdGlvbnNbMyAqIDYgKyAyXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgNl0gPSBwb3NpdGlvbnNbMyAqIDddOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA3XSA9IHBvc2l0aW9uc1szICogNyArIDFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA4XSA9IHBvc2l0aW9uc1szICogNyArIDJdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA5XSA9IHBvc2l0aW9uc1szICogM107CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDEwXSA9IHBvc2l0aW9uc1szICogMyArIDFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAxMV0gPSBwb3NpdGlvbnNbMyAqIDMgKyAyXTsKICAgICAgICBpZiAoIWRyYXdOZWFyUGxhbmUpIHsKICAgICAgICAgIHBvc2l0aW9ucyA9IHBvc2l0aW9ucy5zdWJhcnJheSgzICogNCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoewogICAgICAgICAgcG9zaXRpb246IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICB2YWx1ZXM6IHBvc2l0aW9ucwogICAgICAgICAgfSkKICAgICAgICB9KTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHZlcnRleEZvcm1hdC5ub3JtYWwpIHx8IGRlZmluZWRfZGVmYXVsdCh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgfHwgZGVmaW5lZF9kZWZhdWx0KHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHx8IGRlZmluZWRfZGVmYXVsdCh2ZXJ0ZXhGb3JtYXQuc3QpKSB7CiAgICAgICAgICBjb25zdCBub3JtYWxzID0gZGVmaW5lZF9kZWZhdWx0KHZlcnRleEZvcm1hdC5ub3JtYWwpID8gbmV3IEZsb2F0MzJBcnJheSgzICogNCAqIG51bWJlck9mUGxhbmVzKSA6IHZvaWQgMDsKICAgICAgICAgIGNvbnN0IHRhbmdlbnRzID0gZGVmaW5lZF9kZWZhdWx0KHZlcnRleEZvcm1hdC50YW5nZW50KSA/IG5ldyBGbG9hdDMyQXJyYXkoMyAqIDQgKiBudW1iZXJPZlBsYW5lcykgOiB2b2lkIDA7CiAgICAgICAgICBjb25zdCBiaXRhbmdlbnRzID0gZGVmaW5lZF9kZWZhdWx0KHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpID8gbmV3IEZsb2F0MzJBcnJheSgzICogNCAqIG51bWJlck9mUGxhbmVzKSA6IHZvaWQgMDsKICAgICAgICAgIGNvbnN0IHN0ID0gZGVmaW5lZF9kZWZhdWx0KHZlcnRleEZvcm1hdC5zdCkgPyBuZXcgRmxvYXQzMkFycmF5KDIgKiA0ICogbnVtYmVyT2ZQbGFuZXMpIDogdm9pZCAwOwogICAgICAgICAgY29uc3QgeCA9IHNjcmF0Y2hYRGlyZWN0aW9uOwogICAgICAgICAgY29uc3QgeSA9IHNjcmF0Y2hZRGlyZWN0aW9uOwogICAgICAgICAgY29uc3QgeiA9IHNjcmF0Y2haRGlyZWN0aW9uOwogICAgICAgICAgY29uc3QgbmVnYXRpdmVYMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoeCwgc2NyYXRjaE5lZ2F0aXZlWCk7CiAgICAgICAgICBjb25zdCBuZWdhdGl2ZVkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKHksIHNjcmF0Y2hOZWdhdGl2ZVkpOwogICAgICAgICAgY29uc3QgbmVnYXRpdmVaID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZSh6LCBzY3JhdGNoTmVnYXRpdmVaKTsKICAgICAgICAgIG9mZnNldCA9IDA7CiAgICAgICAgICBpZiAoZHJhd05lYXJQbGFuZSkgewogICAgICAgICAgICBnZXRBdHRyaWJ1dGVzKG9mZnNldCwgbm9ybWFscywgdGFuZ2VudHMsIGJpdGFuZ2VudHMsIHN0LCBuZWdhdGl2ZVosIHgsIHkpOwogICAgICAgICAgICBvZmZzZXQgKz0gMyAqIDQ7CiAgICAgICAgICB9CiAgICAgICAgICBnZXRBdHRyaWJ1dGVzKG9mZnNldCwgbm9ybWFscywgdGFuZ2VudHMsIGJpdGFuZ2VudHMsIHN0LCB6LCBuZWdhdGl2ZVgyLCB5KTsKICAgICAgICAgIG9mZnNldCArPSAzICogNDsKICAgICAgICAgIGdldEF0dHJpYnV0ZXMoCiAgICAgICAgICAgIG9mZnNldCwKICAgICAgICAgICAgbm9ybWFscywKICAgICAgICAgICAgdGFuZ2VudHMsCiAgICAgICAgICAgIGJpdGFuZ2VudHMsCiAgICAgICAgICAgIHN0LAogICAgICAgICAgICBuZWdhdGl2ZVgyLAogICAgICAgICAgICBuZWdhdGl2ZVosCiAgICAgICAgICAgIHkKICAgICAgICAgICk7CiAgICAgICAgICBvZmZzZXQgKz0gMyAqIDQ7CiAgICAgICAgICBnZXRBdHRyaWJ1dGVzKAogICAgICAgICAgICBvZmZzZXQsCiAgICAgICAgICAgIG5vcm1hbHMsCiAgICAgICAgICAgIHRhbmdlbnRzLAogICAgICAgICAgICBiaXRhbmdlbnRzLAogICAgICAgICAgICBzdCwKICAgICAgICAgICAgbmVnYXRpdmVZLAogICAgICAgICAgICBuZWdhdGl2ZVosCiAgICAgICAgICAgIG5lZ2F0aXZlWDIKICAgICAgICAgICk7CiAgICAgICAgICBvZmZzZXQgKz0gMyAqIDQ7CiAgICAgICAgICBnZXRBdHRyaWJ1dGVzKG9mZnNldCwgbm9ybWFscywgdGFuZ2VudHMsIGJpdGFuZ2VudHMsIHN0LCB4LCB6LCB5KTsKICAgICAgICAgIG9mZnNldCArPSAzICogNDsKICAgICAgICAgIGdldEF0dHJpYnV0ZXMob2Zmc2V0LCBub3JtYWxzLCB0YW5nZW50cywgYml0YW5nZW50cywgc3QsIHksIHosIG5lZ2F0aXZlWDIpOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChub3JtYWxzKSkgewogICAgICAgICAgICBhdHRyaWJ1dGVzLm5vcm1hbCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICAgIHZhbHVlczogbm9ybWFscwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodGFuZ2VudHMpKSB7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMudGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICAgIHZhbHVlczogdGFuZ2VudHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGJpdGFuZ2VudHMpKSB7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMuYml0YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiBiaXRhbmdlbnRzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChzdCkpIHsKICAgICAgICAgICAgYXR0cmlidXRlcy5zdCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgICAgICAgIHZhbHVlczogc3QKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGluZGljZXMgPSBuZXcgVWludDE2QXJyYXkoNiAqIG51bWJlck9mUGxhbmVzKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bWJlck9mUGxhbmVzOyArK2kpIHsKICAgICAgICAgIGNvbnN0IGluZGV4T2Zmc2V0ID0gaSAqIDY7CiAgICAgICAgICBjb25zdCBpbmRleCA9IGkgKiA0OwogICAgICAgICAgaW5kaWNlc1tpbmRleE9mZnNldF0gPSBpbmRleDsKICAgICAgICAgIGluZGljZXNbaW5kZXhPZmZzZXQgKyAxXSA9IGluZGV4ICsgMTsKICAgICAgICAgIGluZGljZXNbaW5kZXhPZmZzZXQgKyAyXSA9IGluZGV4ICsgMjsKICAgICAgICAgIGluZGljZXNbaW5kZXhPZmZzZXQgKyAzXSA9IGluZGV4OwogICAgICAgICAgaW5kaWNlc1tpbmRleE9mZnNldCArIDRdID0gaW5kZXggKyAyOwogICAgICAgICAgaW5kaWNlc1tpbmRleE9mZnNldCArIDVdID0gaW5kZXggKyAzOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVZlcnRpY2VzKHBvc2l0aW9ucykKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgRnJ1c3R1bUdlb21ldHJ5X2RlZmF1bHQgPSBGcnVzdHVtR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVGcnVzdHVtR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlRnJ1c3R1bUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVGcnVzdHVtR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlRnJ1c3R1bUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVGcnVzdHVtR2VvbWV0cnkoZnJ1c3R1bUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBmcnVzdHVtR2VvbWV0cnkgPSBGcnVzdHVtR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soZnJ1c3R1bUdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgcmV0dXJuIEZydXN0dW1HZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KGZydXN0dW1HZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVGcnVzdHVtR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVGcnVzdHVtR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUZydXN0dW1HZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0ZydXN0dW1HZW9tZXRyeSgpOwogICAgICBjcmVhdGVGcnVzdHVtR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZUZydXN0dW1HZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0ZydXN0dW1PdXRsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBGcnVzdHVtT3V0bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib3B0aW9ucyIsIG9wdGlvbnMpOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvcHRpb25zLmZydXN0dW0iLCBvcHRpb25zLmZydXN0dW0pOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvcHRpb25zLm9yaWdpbiIsIG9wdGlvbnMub3JpZ2luKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib3B0aW9ucy5vcmllbnRhdGlvbiIsIG9wdGlvbnMub3JpZW50YXRpb24pOwogICAgY29uc3QgZnJ1c3R1bSA9IG9wdGlvbnMuZnJ1c3R1bTsKICAgIGNvbnN0IG9yaWVudGF0aW9uID0gb3B0aW9ucy5vcmllbnRhdGlvbjsKICAgIGNvbnN0IG9yaWdpbiA9IG9wdGlvbnMub3JpZ2luOwogICAgY29uc3QgZHJhd05lYXJQbGFuZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuX2RyYXdOZWFyUGxhbmUsIHRydWUpOwogICAgbGV0IGZydXN0dW1UeXBlOwogICAgbGV0IGZydXN0dW1QYWNrZWRMZW5ndGg7CiAgICBpZiAoZnJ1c3R1bSBpbnN0YW5jZW9mIFBlcnNwZWN0aXZlRnJ1c3R1bV9kZWZhdWx0KSB7CiAgICAgIGZydXN0dW1UeXBlID0gUEVSU1BFQ1RJVkUyOwogICAgICBmcnVzdHVtUGFja2VkTGVuZ3RoID0gUGVyc3BlY3RpdmVGcnVzdHVtX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgfSBlbHNlIGlmIChmcnVzdHVtIGluc3RhbmNlb2YgT3J0aG9ncmFwaGljRnJ1c3R1bV9kZWZhdWx0KSB7CiAgICAgIGZydXN0dW1UeXBlID0gT1JUSE9HUkFQSElDMjsKICAgICAgZnJ1c3R1bVBhY2tlZExlbmd0aCA9IE9ydGhvZ3JhcGhpY0ZydXN0dW1fZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICB9CiAgICB0aGlzLl9mcnVzdHVtVHlwZSA9IGZydXN0dW1UeXBlOwogICAgdGhpcy5fZnJ1c3R1bSA9IGZydXN0dW0uY2xvbmUoKTsKICAgIHRoaXMuX29yaWdpbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShvcmlnaW4pOwogICAgdGhpcy5fb3JpZW50YXRpb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQuY2xvbmUob3JpZW50YXRpb24pOwogICAgdGhpcy5fZHJhd05lYXJQbGFuZSA9IGRyYXdOZWFyUGxhbmU7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUZydXN0dW1PdXRsaW5lR2VvbWV0cnkiOwogICAgdGhpcy5wYWNrZWRMZW5ndGggPSAyICsgZnJ1c3R1bVBhY2tlZExlbmd0aCArIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBRdWF0ZXJuaW9uX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogIH0KICB2YXIgUEVSU1BFQ1RJVkUyLCBPUlRIT0dSQVBISUMyLCBzY3JhdGNoUGFja1BlcnNwZWN0aXZlMiwgc2NyYXRjaFBhY2tPcnRob2dyYXBoaWMyLCBzY3JhdGNoUGFja1F1YXRlcm5pb24yLCBzY3JhdGNoUGFja29yaWdpbjIsIEZydXN0dW1PdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9GcnVzdHVtT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9GcnVzdHVtT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0ZydXN0dW1HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9PcnRob2dyYXBoaWNGcnVzdHVtKCk7CiAgICAgIGluaXRfUGVyc3BlY3RpdmVGcnVzdHVtKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1F1YXRlcm5pb24oKTsKICAgICAgUEVSU1BFQ1RJVkUyID0gMDsKICAgICAgT1JUSE9HUkFQSElDMiA9IDE7CiAgICAgIEZydXN0dW1PdXRsaW5lR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgZnJ1c3R1bVR5cGUgPSB2YWx1ZS5fZnJ1c3R1bVR5cGU7CiAgICAgICAgY29uc3QgZnJ1c3R1bSA9IHZhbHVlLl9mcnVzdHVtOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBmcnVzdHVtVHlwZTsKICAgICAgICBpZiAoZnJ1c3R1bVR5cGUgPT09IFBFUlNQRUNUSVZFMikgewogICAgICAgICAgUGVyc3BlY3RpdmVGcnVzdHVtX2RlZmF1bHQucGFjayhmcnVzdHVtLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgICBzdGFydGluZ0luZGV4ICs9IFBlcnNwZWN0aXZlRnJ1c3R1bV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgT3J0aG9ncmFwaGljRnJ1c3R1bV9kZWZhdWx0LnBhY2soZnJ1c3R1bSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgICAgc3RhcnRpbmdJbmRleCArPSBPcnRob2dyYXBoaWNGcnVzdHVtX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2YWx1ZS5fb3JpZ2luLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIFF1YXRlcm5pb25fZGVmYXVsdC5wYWNrKHZhbHVlLl9vcmllbnRhdGlvbiwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gUXVhdGVybmlvbl9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLl9kcmF3TmVhclBsYW5lID8gMSA6IDA7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoUGFja1BlcnNwZWN0aXZlMiA9IG5ldyBQZXJzcGVjdGl2ZUZydXN0dW1fZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGFja09ydGhvZ3JhcGhpYzIgPSBuZXcgT3J0aG9ncmFwaGljRnJ1c3R1bV9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQYWNrUXVhdGVybmlvbjIgPSBuZXcgUXVhdGVybmlvbl9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQYWNrb3JpZ2luMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgRnJ1c3R1bU91dGxpbmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgZnJ1c3R1bVR5cGUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGxldCBmcnVzdHVtOwogICAgICAgIGlmIChmcnVzdHVtVHlwZSA9PT0gUEVSU1BFQ1RJVkUyKSB7CiAgICAgICAgICBmcnVzdHVtID0gUGVyc3BlY3RpdmVGcnVzdHVtX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICBhcnJheSwKICAgICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgICAgc2NyYXRjaFBhY2tQZXJzcGVjdGl2ZTIKICAgICAgICAgICk7CiAgICAgICAgICBzdGFydGluZ0luZGV4ICs9IFBlcnNwZWN0aXZlRnJ1c3R1bV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZnJ1c3R1bSA9IE9ydGhvZ3JhcGhpY0ZydXN0dW1fZGVmYXVsdC51bnBhY2soCiAgICAgICAgICAgIGFycmF5LAogICAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgICBzY3JhdGNoUGFja09ydGhvZ3JhcGhpYzIKICAgICAgICAgICk7CiAgICAgICAgICBzdGFydGluZ0luZGV4ICs9IE9ydGhvZ3JhcGhpY0ZydXN0dW1fZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG9yaWdpbiA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hQYWNrb3JpZ2luMik7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IG9yaWVudGF0aW9uID0gUXVhdGVybmlvbl9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hQYWNrUXVhdGVybmlvbjIKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gUXVhdGVybmlvbl9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBkcmF3TmVhclBsYW5lID0gYXJyYXlbc3RhcnRpbmdJbmRleF0gPT09IDE7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBGcnVzdHVtT3V0bGluZUdlb21ldHJ5KHsKICAgICAgICAgICAgZnJ1c3R1bSwKICAgICAgICAgICAgb3JpZ2luLAogICAgICAgICAgICBvcmllbnRhdGlvbiwKICAgICAgICAgICAgX2RyYXdOZWFyUGxhbmU6IGRyYXdOZWFyUGxhbmUKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBjb25zdCBmcnVzdHVtUmVzdWx0ID0gZnJ1c3R1bVR5cGUgPT09IHJlc3VsdC5fZnJ1c3R1bVR5cGUgPyByZXN1bHQuX2ZydXN0dW0gOiB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll9mcnVzdHVtID0gZnJ1c3R1bS5jbG9uZShmcnVzdHVtUmVzdWx0KTsKICAgICAgICByZXN1bHQuX2ZydXN0dW1UeXBlID0gZnJ1c3R1bVR5cGU7CiAgICAgICAgcmVzdWx0Ll9vcmlnaW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUob3JpZ2luLCByZXN1bHQuX29yaWdpbik7CiAgICAgICAgcmVzdWx0Ll9vcmllbnRhdGlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC5jbG9uZShvcmllbnRhdGlvbiwgcmVzdWx0Ll9vcmllbnRhdGlvbik7CiAgICAgICAgcmVzdWx0Ll9kcmF3TmVhclBsYW5lID0gZHJhd05lYXJQbGFuZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBGcnVzdHVtT3V0bGluZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oZnJ1c3R1bUdlb21ldHJ5KSB7CiAgICAgICAgY29uc3QgZnJ1c3R1bVR5cGUgPSBmcnVzdHVtR2VvbWV0cnkuX2ZydXN0dW1UeXBlOwogICAgICAgIGNvbnN0IGZydXN0dW0gPSBmcnVzdHVtR2VvbWV0cnkuX2ZydXN0dW07CiAgICAgICAgY29uc3Qgb3JpZ2luID0gZnJ1c3R1bUdlb21ldHJ5Ll9vcmlnaW47CiAgICAgICAgY29uc3Qgb3JpZW50YXRpb24gPSBmcnVzdHVtR2VvbWV0cnkuX29yaWVudGF0aW9uOwogICAgICAgIGNvbnN0IGRyYXdOZWFyUGxhbmUgPSBmcnVzdHVtR2VvbWV0cnkuX2RyYXdOZWFyUGxhbmU7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheSgzICogNCAqIDIpOwogICAgICAgIEZydXN0dW1HZW9tZXRyeV9kZWZhdWx0Ll9jb21wdXRlTmVhckZhclBsYW5lcygKICAgICAgICAgIG9yaWdpbiwKICAgICAgICAgIG9yaWVudGF0aW9uLAogICAgICAgICAgZnJ1c3R1bVR5cGUsCiAgICAgICAgICBmcnVzdHVtLAogICAgICAgICAgcG9zaXRpb25zCiAgICAgICAgKTsKICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KHsKICAgICAgICAgIHBvc2l0aW9uOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgdmFsdWVzOiBwb3NpdGlvbnMKICAgICAgICAgIH0pCiAgICAgICAgfSk7CiAgICAgICAgbGV0IG9mZnNldDsKICAgICAgICBsZXQgaW5kZXg7CiAgICAgICAgY29uc3QgbnVtYmVyT2ZQbGFuZXMgPSBkcmF3TmVhclBsYW5lID8gMiA6IDE7CiAgICAgICAgY29uc3QgaW5kaWNlcyA9IG5ldyBVaW50MTZBcnJheSg4ICogKG51bWJlck9mUGxhbmVzICsgMSkpOwogICAgICAgIGxldCBpID0gZHJhd05lYXJQbGFuZSA/IDAgOiAxOwogICAgICAgIGZvciAoOyBpIDwgMjsgKytpKSB7CiAgICAgICAgICBvZmZzZXQgPSBkcmF3TmVhclBsYW5lID8gaSAqIDggOiAwOwogICAgICAgICAgaW5kZXggPSBpICogNDsKICAgICAgICAgIGluZGljZXNbb2Zmc2V0XSA9IGluZGV4OwogICAgICAgICAgaW5kaWNlc1tvZmZzZXQgKyAxXSA9IGluZGV4ICsgMTsKICAgICAgICAgIGluZGljZXNbb2Zmc2V0ICsgMl0gPSBpbmRleCArIDE7CiAgICAgICAgICBpbmRpY2VzW29mZnNldCArIDNdID0gaW5kZXggKyAyOwogICAgICAgICAgaW5kaWNlc1tvZmZzZXQgKyA0XSA9IGluZGV4ICsgMjsKICAgICAgICAgIGluZGljZXNbb2Zmc2V0ICsgNV0gPSBpbmRleCArIDM7CiAgICAgICAgICBpbmRpY2VzW29mZnNldCArIDZdID0gaW5kZXggKyAzOwogICAgICAgICAgaW5kaWNlc1tvZmZzZXQgKyA3XSA9IGluZGV4OwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgMjsgKytpKSB7CiAgICAgICAgICBvZmZzZXQgPSAobnVtYmVyT2ZQbGFuZXMgKyBpKSAqIDg7CiAgICAgICAgICBpbmRleCA9IGkgKiA0OwogICAgICAgICAgaW5kaWNlc1tvZmZzZXRdID0gaW5kZXg7CiAgICAgICAgICBpbmRpY2VzW29mZnNldCArIDFdID0gaW5kZXggKyA0OwogICAgICAgICAgaW5kaWNlc1tvZmZzZXQgKyAyXSA9IGluZGV4ICsgMTsKICAgICAgICAgIGluZGljZXNbb2Zmc2V0ICsgM10gPSBpbmRleCArIDU7CiAgICAgICAgICBpbmRpY2VzW29mZnNldCArIDRdID0gaW5kZXggKyAyOwogICAgICAgICAgaW5kaWNlc1tvZmZzZXQgKyA1XSA9IGluZGV4ICsgNjsKICAgICAgICAgIGluZGljZXNbb2Zmc2V0ICsgNl0gPSBpbmRleCArIDM7CiAgICAgICAgICBpbmRpY2VzW29mZnNldCArIDddID0gaW5kZXggKyA3OwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZTogQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tVmVydGljZXMocG9zaXRpb25zKQogICAgICAgIH0pOwogICAgICB9OwogICAgICBGcnVzdHVtT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBGcnVzdHVtT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUZydXN0dW1PdXRsaW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZUZydXN0dW1PdXRsaW5lR2VvbWV0cnkoZnJ1c3R1bUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBmcnVzdHVtR2VvbWV0cnkgPSBGcnVzdHVtT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKGZydXN0dW1HZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHJldHVybiBGcnVzdHVtT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoZnJ1c3R1bUdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZUZydXN0dW1PdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRnJ1c3R1bU91dGxpbmVHZW9tZXRyeSgpOwogICAgICBjcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvZ3JhcGhpY1RpbGluZ1NjaGVtZS5qcwogIGZ1bmN0aW9uIEdlb2dyYXBoaWNUaWxpbmdTY2hlbWUob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICB0aGlzLl9lbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgdGhpcy5fcmVjdGFuZ2xlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5yZWN0YW5nbGUsIFJlY3RhbmdsZV9kZWZhdWx0Lk1BWF9WQUxVRSk7CiAgICB0aGlzLl9wcm9qZWN0aW9uID0gbmV3IEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQodGhpcy5fZWxsaXBzb2lkKTsKICAgIHRoaXMuX251bWJlck9mTGV2ZWxaZXJvVGlsZXNYID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMubnVtYmVyT2ZMZXZlbFplcm9UaWxlc1gsCiAgICAgIDIKICAgICk7CiAgICB0aGlzLl9udW1iZXJPZkxldmVsWmVyb1RpbGVzWSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLm51bWJlck9mTGV2ZWxaZXJvVGlsZXNZLAogICAgICAxCiAgICApOwogIH0KICB2YXIgR2VvZ3JhcGhpY1RpbGluZ1NjaGVtZV9kZWZhdWx0OwogIHZhciBpbml0X0dlb2dyYXBoaWNUaWxpbmdTY2hlbWUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dlb2dyYXBoaWNUaWxpbmdTY2hlbWUuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9HZW9ncmFwaGljUHJvamVjdGlvbigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoR2VvZ3JhcGhpY1RpbGluZ1NjaGVtZS5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBlbGxpcHNvaWQgdGhhdCBpcyB0aWxlZCBieSB0aGlzIHRpbGluZyBzY2hlbWUuCiAgICAgICAgICogQG1lbWJlcm9mIEdlb2dyYXBoaWNUaWxpbmdTY2hlbWUucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0VsbGlwc29pZH0KICAgICAgICAgKi8KICAgICAgICBlbGxpcHNvaWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbGxpcHNvaWQ7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSByZWN0YW5nbGUsIGluIHJhZGlhbnMsIGNvdmVyZWQgYnkgdGhpcyB0aWxpbmcgc2NoZW1lLgogICAgICAgICAqIEBtZW1iZXJvZiBHZW9ncmFwaGljVGlsaW5nU2NoZW1lLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtSZWN0YW5nbGV9CiAgICAgICAgICovCiAgICAgICAgcmVjdGFuZ2xlOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcmVjdGFuZ2xlOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgbWFwIHByb2plY3Rpb24gdXNlZCBieSB0aGlzIHRpbGluZyBzY2hlbWUuCiAgICAgICAgICogQG1lbWJlcm9mIEdlb2dyYXBoaWNUaWxpbmdTY2hlbWUucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge01hcFByb2plY3Rpb259CiAgICAgICAgICovCiAgICAgICAgcHJvamVjdGlvbjogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3Byb2plY3Rpb247CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgR2VvZ3JhcGhpY1RpbGluZ1NjaGVtZS5wcm90b3R5cGUuZ2V0TnVtYmVyT2ZYVGlsZXNBdExldmVsID0gZnVuY3Rpb24obGV2ZWwpIHsKICAgICAgICByZXR1cm4gdGhpcy5fbnVtYmVyT2ZMZXZlbFplcm9UaWxlc1ggPDwgbGV2ZWw7CiAgICAgIH07CiAgICAgIEdlb2dyYXBoaWNUaWxpbmdTY2hlbWUucHJvdG90eXBlLmdldE51bWJlck9mWVRpbGVzQXRMZXZlbCA9IGZ1bmN0aW9uKGxldmVsKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX251bWJlck9mTGV2ZWxaZXJvVGlsZXNZIDw8IGxldmVsOwogICAgICB9OwogICAgICBHZW9ncmFwaGljVGlsaW5nU2NoZW1lLnByb3RvdHlwZS5yZWN0YW5nbGVUb05hdGl2ZVJlY3RhbmdsZSA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgICAgIGNvbnN0IHdlc3QgPSBNYXRoX2RlZmF1bHQudG9EZWdyZWVzKHJlY3RhbmdsZS53ZXN0KTsKICAgICAgICBjb25zdCBzb3V0aCA9IE1hdGhfZGVmYXVsdC50b0RlZ3JlZXMocmVjdGFuZ2xlLnNvdXRoKTsKICAgICAgICBjb25zdCBlYXN0ID0gTWF0aF9kZWZhdWx0LnRvRGVncmVlcyhyZWN0YW5nbGUuZWFzdCk7CiAgICAgICAgY29uc3Qgbm9ydGggPSBNYXRoX2RlZmF1bHQudG9EZWdyZWVzKHJlY3RhbmdsZS5ub3J0aCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBSZWN0YW5nbGVfZGVmYXVsdCh3ZXN0LCBzb3V0aCwgZWFzdCwgbm9ydGgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQud2VzdCA9IHdlc3Q7CiAgICAgICAgcmVzdWx0LnNvdXRoID0gc291dGg7CiAgICAgICAgcmVzdWx0LmVhc3QgPSBlYXN0OwogICAgICAgIHJlc3VsdC5ub3J0aCA9IG5vcnRoOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEdlb2dyYXBoaWNUaWxpbmdTY2hlbWUucHJvdG90eXBlLnRpbGVYWVRvTmF0aXZlUmVjdGFuZ2xlID0gZnVuY3Rpb24oeCwgeSwgbGV2ZWwsIHJlc3VsdCkgewogICAgICAgIGNvbnN0IHJlY3RhbmdsZVJhZGlhbnMgPSB0aGlzLnRpbGVYWVRvUmVjdGFuZ2xlKHgsIHksIGxldmVsLCByZXN1bHQpOwogICAgICAgIHJlY3RhbmdsZVJhZGlhbnMud2VzdCA9IE1hdGhfZGVmYXVsdC50b0RlZ3JlZXMocmVjdGFuZ2xlUmFkaWFucy53ZXN0KTsKICAgICAgICByZWN0YW5nbGVSYWRpYW5zLnNvdXRoID0gTWF0aF9kZWZhdWx0LnRvRGVncmVlcyhyZWN0YW5nbGVSYWRpYW5zLnNvdXRoKTsKICAgICAgICByZWN0YW5nbGVSYWRpYW5zLmVhc3QgPSBNYXRoX2RlZmF1bHQudG9EZWdyZWVzKHJlY3RhbmdsZVJhZGlhbnMuZWFzdCk7CiAgICAgICAgcmVjdGFuZ2xlUmFkaWFucy5ub3J0aCA9IE1hdGhfZGVmYXVsdC50b0RlZ3JlZXMocmVjdGFuZ2xlUmFkaWFucy5ub3J0aCk7CiAgICAgICAgcmV0dXJuIHJlY3RhbmdsZVJhZGlhbnM7CiAgICAgIH07CiAgICAgIEdlb2dyYXBoaWNUaWxpbmdTY2hlbWUucHJvdG90eXBlLnRpbGVYWVRvUmVjdGFuZ2xlID0gZnVuY3Rpb24oeCwgeSwgbGV2ZWwsIHJlc3VsdCkgewogICAgICAgIGNvbnN0IHJlY3RhbmdsZSA9IHRoaXMuX3JlY3RhbmdsZTsKICAgICAgICBjb25zdCB4VGlsZXMgPSB0aGlzLmdldE51bWJlck9mWFRpbGVzQXRMZXZlbChsZXZlbCk7CiAgICAgICAgY29uc3QgeVRpbGVzID0gdGhpcy5nZXROdW1iZXJPZllUaWxlc0F0TGV2ZWwobGV2ZWwpOwogICAgICAgIGNvbnN0IHhUaWxlV2lkdGggPSByZWN0YW5nbGUud2lkdGggLyB4VGlsZXM7CiAgICAgICAgY29uc3Qgd2VzdCA9IHggKiB4VGlsZVdpZHRoICsgcmVjdGFuZ2xlLndlc3Q7CiAgICAgICAgY29uc3QgZWFzdCA9ICh4ICsgMSkgKiB4VGlsZVdpZHRoICsgcmVjdGFuZ2xlLndlc3Q7CiAgICAgICAgY29uc3QgeVRpbGVIZWlnaHQgPSByZWN0YW5nbGUuaGVpZ2h0IC8geVRpbGVzOwogICAgICAgIGNvbnN0IG5vcnRoID0gcmVjdGFuZ2xlLm5vcnRoIC0geSAqIHlUaWxlSGVpZ2h0OwogICAgICAgIGNvbnN0IHNvdXRoID0gcmVjdGFuZ2xlLm5vcnRoIC0gKHkgKyAxKSAqIHlUaWxlSGVpZ2h0OwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBSZWN0YW5nbGVfZGVmYXVsdCh3ZXN0LCBzb3V0aCwgZWFzdCwgbm9ydGgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQud2VzdCA9IHdlc3Q7CiAgICAgICAgcmVzdWx0LnNvdXRoID0gc291dGg7CiAgICAgICAgcmVzdWx0LmVhc3QgPSBlYXN0OwogICAgICAgIHJlc3VsdC5ub3J0aCA9IG5vcnRoOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEdlb2dyYXBoaWNUaWxpbmdTY2hlbWUucHJvdG90eXBlLnBvc2l0aW9uVG9UaWxlWFkgPSBmdW5jdGlvbihwb3NpdGlvbiwgbGV2ZWwsIHJlc3VsdCkgewogICAgICAgIGNvbnN0IHJlY3RhbmdsZSA9IHRoaXMuX3JlY3RhbmdsZTsKICAgICAgICBpZiAoIVJlY3RhbmdsZV9kZWZhdWx0LmNvbnRhaW5zKHJlY3RhbmdsZSwgcG9zaXRpb24pKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBjb25zdCB4VGlsZXMgPSB0aGlzLmdldE51bWJlck9mWFRpbGVzQXRMZXZlbChsZXZlbCk7CiAgICAgICAgY29uc3QgeVRpbGVzID0gdGhpcy5nZXROdW1iZXJPZllUaWxlc0F0TGV2ZWwobGV2ZWwpOwogICAgICAgIGNvbnN0IHhUaWxlV2lkdGggPSByZWN0YW5nbGUud2lkdGggLyB4VGlsZXM7CiAgICAgICAgY29uc3QgeVRpbGVIZWlnaHQgPSByZWN0YW5nbGUuaGVpZ2h0IC8geVRpbGVzOwogICAgICAgIGxldCBsb25naXR1ZGUgPSBwb3NpdGlvbi5sb25naXR1ZGU7CiAgICAgICAgaWYgKHJlY3RhbmdsZS5lYXN0IDwgcmVjdGFuZ2xlLndlc3QpIHsKICAgICAgICAgIGxvbmdpdHVkZSArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIH0KICAgICAgICBsZXQgeFRpbGVDb29yZGluYXRlID0gKGxvbmdpdHVkZSAtIHJlY3RhbmdsZS53ZXN0KSAvIHhUaWxlV2lkdGggfCAwOwogICAgICAgIGlmICh4VGlsZUNvb3JkaW5hdGUgPj0geFRpbGVzKSB7CiAgICAgICAgICB4VGlsZUNvb3JkaW5hdGUgPSB4VGlsZXMgLSAxOwogICAgICAgIH0KICAgICAgICBsZXQgeVRpbGVDb29yZGluYXRlID0gKHJlY3RhbmdsZS5ub3J0aCAtIHBvc2l0aW9uLmxhdGl0dWRlKSAvIHlUaWxlSGVpZ2h0IHwgMDsKICAgICAgICBpZiAoeVRpbGVDb29yZGluYXRlID49IHlUaWxlcykgewogICAgICAgICAgeVRpbGVDb29yZGluYXRlID0geVRpbGVzIC0gMTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoeFRpbGVDb29yZGluYXRlLCB5VGlsZUNvb3JkaW5hdGUpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IHhUaWxlQ29vcmRpbmF0ZTsKICAgICAgICByZXN1bHQueSA9IHlUaWxlQ29vcmRpbmF0ZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBHZW9ncmFwaGljVGlsaW5nU2NoZW1lX2RlZmF1bHQgPSBHZW9ncmFwaGljVGlsaW5nU2NoZW1lOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5qcwogIGZ1bmN0aW9uIGdldFRpbGVYWUxldmVsKHJlY3RhbmdsZSkgewogICAgQ2FydG9ncmFwaGljX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgIHJlY3RhbmdsZS5lYXN0LAogICAgICByZWN0YW5nbGUubm9ydGgsCiAgICAgIDAsCiAgICAgIHNjcmF0Y2hDb3JuZXJzWzBdCiAgICApOwogICAgQ2FydG9ncmFwaGljX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgIHJlY3RhbmdsZS53ZXN0LAogICAgICByZWN0YW5nbGUubm9ydGgsCiAgICAgIDAsCiAgICAgIHNjcmF0Y2hDb3JuZXJzWzFdCiAgICApOwogICAgQ2FydG9ncmFwaGljX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgIHJlY3RhbmdsZS5lYXN0LAogICAgICByZWN0YW5nbGUuc291dGgsCiAgICAgIDAsCiAgICAgIHNjcmF0Y2hDb3JuZXJzWzJdCiAgICApOwogICAgQ2FydG9ncmFwaGljX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgIHJlY3RhbmdsZS53ZXN0LAogICAgICByZWN0YW5nbGUuc291dGgsCiAgICAgIDAsCiAgICAgIHNjcmF0Y2hDb3JuZXJzWzNdCiAgICApOwogICAgbGV0IGxhc3RMZXZlbFggPSAwLCBsYXN0TGV2ZWxZID0gMDsKICAgIGxldCBjdXJyZW50WCA9IDAsIGN1cnJlbnRZID0gMDsKICAgIGNvbnN0IG1heExldmVsID0gQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5fdGVycmFpbkhlaWdodHNNYXhMZXZlbDsKICAgIGxldCBpOwogICAgZm9yIChpID0gMDsgaSA8PSBtYXhMZXZlbDsgKytpKSB7CiAgICAgIGxldCBmYWlsZWQgPSBmYWxzZTsKICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCA0OyArK2opIHsKICAgICAgICBjb25zdCBjb3JuZXIgPSBzY3JhdGNoQ29ybmVyc1tqXTsKICAgICAgICB0aWxpbmdTY2hlbWUucG9zaXRpb25Ub1RpbGVYWShjb3JuZXIsIGksIHNjcmF0Y2hUaWxlWFkpOwogICAgICAgIGlmIChqID09PSAwKSB7CiAgICAgICAgICBjdXJyZW50WCA9IHNjcmF0Y2hUaWxlWFkueDsKICAgICAgICAgIGN1cnJlbnRZID0gc2NyYXRjaFRpbGVYWS55OwogICAgICAgIH0gZWxzZSBpZiAoY3VycmVudFggIT09IHNjcmF0Y2hUaWxlWFkueCB8fCBjdXJyZW50WSAhPT0gc2NyYXRjaFRpbGVYWS55KSB7CiAgICAgICAgICBmYWlsZWQgPSB0cnVlOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChmYWlsZWQpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBsYXN0TGV2ZWxYID0gY3VycmVudFg7CiAgICAgIGxhc3RMZXZlbFkgPSBjdXJyZW50WTsKICAgIH0KICAgIGlmIChpID09PSAwKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICByZXR1cm4gewogICAgICB4OiBsYXN0TGV2ZWxYLAogICAgICB5OiBsYXN0TGV2ZWxZLAogICAgICBsZXZlbDogaSA+IG1heExldmVsID8gbWF4TGV2ZWwgOiBpIC0gMQogICAgfTsKICB9CiAgdmFyIHNjcmF0Y2hEaWFnb25hbENhcnRlc2lhbk5FLCBzY3JhdGNoRGlhZ29uYWxDYXJ0ZXNpYW5TVywgc2NyYXRjaERpYWdvbmFsQ2FydG9ncmFwaGljLCBzY3JhdGNoQ2VudGVyQ2FydGVzaWFuLCBzY3JhdGNoU3VyZmFjZUNhcnRlc2lhbiwgc2NyYXRjaEJvdW5kaW5nU3BoZXJlMiwgdGlsaW5nU2NoZW1lLCBzY3JhdGNoQ29ybmVycywgc2NyYXRjaFRpbGVYWSwgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cywgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0c19kZWZhdWx0OwogIHZhciBpbml0X0FwcHJveGltYXRlVGVycmFpbkhlaWdodHMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0FwcHJveGltYXRlVGVycmFpbkhlaWdodHMuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfYnVpbGRNb2R1bGVVcmwoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvZ3JhcGhpY1RpbGluZ1NjaGVtZSgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X1Jlc291cmNlKCk7CiAgICAgIHNjcmF0Y2hEaWFnb25hbENhcnRlc2lhbk5FID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRGlhZ29uYWxDYXJ0ZXNpYW5TVyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaERpYWdvbmFsQ2FydG9ncmFwaGljID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDZW50ZXJDYXJ0ZXNpYW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hTdXJmYWNlQ2FydGVzaWFuID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQm91bmRpbmdTcGhlcmUyID0gbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoKTsKICAgICAgdGlsaW5nU2NoZW1lID0gbmV3IEdlb2dyYXBoaWNUaWxpbmdTY2hlbWVfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ29ybmVycyA9IFsKICAgICAgICBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKSwKICAgICAgICBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKSwKICAgICAgICBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKSwKICAgICAgICBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKQogICAgICBdOwogICAgICBzY3JhdGNoVGlsZVhZID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzID0ge307CiAgICAgIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGxldCBpbml0UHJvbWlzZSA9IEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX2luaXRQcm9taXNlOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW5pdFByb21pc2UpKSB7CiAgICAgICAgICByZXR1cm4gaW5pdFByb21pc2U7CiAgICAgICAgfQogICAgICAgIGluaXRQcm9taXNlID0gUmVzb3VyY2VfZGVmYXVsdC5mZXRjaEpzb24oCiAgICAgICAgICBidWlsZE1vZHVsZVVybF9kZWZhdWx0KCJBc3NldHMvYXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5qc29uIikKICAgICAgICApLnRoZW4oZnVuY3Rpb24oanNvbikgewogICAgICAgICAgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5fdGVycmFpbkhlaWdodHMgPSBqc29uOwogICAgICAgIH0pOwogICAgICAgIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX2luaXRQcm9taXNlID0gaW5pdFByb21pc2U7CiAgICAgICAgcmV0dXJuIGluaXRQcm9taXNlOwogICAgICB9OwogICAgICBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLmdldE1pbmltdW1NYXhpbXVtSGVpZ2h0cyA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgZWxsaXBzb2lkKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX3RlcnJhaW5IZWlnaHRzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJZb3UgbXVzdCBjYWxsIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuaW5pdGlhbGl6ZSBhbmQgd2FpdCBmb3IgdGhlIHByb21pc2UgdG8gcmVzb2x2ZSBiZWZvcmUgdXNpbmcgdGhpcyBmdW5jdGlvbiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgICAgIGNvbnN0IHh5TGV2ZWwgPSBnZXRUaWxlWFlMZXZlbChyZWN0YW5nbGUpOwogICAgICAgIGxldCBtaW5UZXJyYWluSGVpZ2h0ID0gQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5fZGVmYXVsdE1pblRlcnJhaW5IZWlnaHQ7CiAgICAgICAgbGV0IG1heFRlcnJhaW5IZWlnaHQgPSBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLl9kZWZhdWx0TWF4VGVycmFpbkhlaWdodDsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHh5TGV2ZWwpKSB7CiAgICAgICAgICBjb25zdCBrZXkgPSBgJHt4eUxldmVsLmxldmVsfS0ke3h5TGV2ZWwueH0tJHt4eUxldmVsLnl9YDsKICAgICAgICAgIGNvbnN0IGhlaWdodHMgPSBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLl90ZXJyYWluSGVpZ2h0c1trZXldOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChoZWlnaHRzKSkgewogICAgICAgICAgICBtaW5UZXJyYWluSGVpZ2h0ID0gaGVpZ2h0c1swXTsKICAgICAgICAgICAgbWF4VGVycmFpbkhlaWdodCA9IGhlaWdodHNbMV07CiAgICAgICAgICB9CiAgICAgICAgICBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgICAgIFJlY3RhbmdsZV9kZWZhdWx0Lm5vcnRoZWFzdChyZWN0YW5nbGUsIHNjcmF0Y2hEaWFnb25hbENhcnRvZ3JhcGhpYyksCiAgICAgICAgICAgIHNjcmF0Y2hEaWFnb25hbENhcnRlc2lhbk5FCiAgICAgICAgICApOwogICAgICAgICAgZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgICAgICBSZWN0YW5nbGVfZGVmYXVsdC5zb3V0aHdlc3QocmVjdGFuZ2xlLCBzY3JhdGNoRGlhZ29uYWxDYXJ0b2dyYXBoaWMpLAogICAgICAgICAgICBzY3JhdGNoRGlhZ29uYWxDYXJ0ZXNpYW5TVwogICAgICAgICAgKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5taWRwb2ludCgKICAgICAgICAgICAgc2NyYXRjaERpYWdvbmFsQ2FydGVzaWFuU1csCiAgICAgICAgICAgIHNjcmF0Y2hEaWFnb25hbENhcnRlc2lhbk5FLAogICAgICAgICAgICBzY3JhdGNoQ2VudGVyQ2FydGVzaWFuCiAgICAgICAgICApOwogICAgICAgICAgY29uc3Qgc3VyZmFjZVBvc2l0aW9uID0gZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UoCiAgICAgICAgICAgIHNjcmF0Y2hDZW50ZXJDYXJ0ZXNpYW4sCiAgICAgICAgICAgIHNjcmF0Y2hTdXJmYWNlQ2FydGVzaWFuCiAgICAgICAgICApOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChzdXJmYWNlUG9zaXRpb24pKSB7CiAgICAgICAgICAgIGNvbnN0IGRpc3RhbmNlID0gQ2FydGVzaWFuM19kZWZhdWx0LmRpc3RhbmNlKAogICAgICAgICAgICAgIHNjcmF0Y2hDZW50ZXJDYXJ0ZXNpYW4sCiAgICAgICAgICAgICAgc3VyZmFjZVBvc2l0aW9uCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIG1pblRlcnJhaW5IZWlnaHQgPSBNYXRoLm1pbihtaW5UZXJyYWluSGVpZ2h0LCAtZGlzdGFuY2UpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbWluVGVycmFpbkhlaWdodCA9IEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX2RlZmF1bHRNaW5UZXJyYWluSGVpZ2h0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBtaW5UZXJyYWluSGVpZ2h0ID0gTWF0aC5tYXgoCiAgICAgICAgICBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLl9kZWZhdWx0TWluVGVycmFpbkhlaWdodCwKICAgICAgICAgIG1pblRlcnJhaW5IZWlnaHQKICAgICAgICApOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBtaW5pbXVtVGVycmFpbkhlaWdodDogbWluVGVycmFpbkhlaWdodCwKICAgICAgICAgIG1heGltdW1UZXJyYWluSGVpZ2h0OiBtYXhUZXJyYWluSGVpZ2h0CiAgICAgICAgfTsKICAgICAgfTsKICAgICAgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5nZXRCb3VuZGluZ1NwaGVyZSA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgZWxsaXBzb2lkKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX3RlcnJhaW5IZWlnaHRzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJZb3UgbXVzdCBjYWxsIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuaW5pdGlhbGl6ZSBhbmQgd2FpdCBmb3IgdGhlIHByb21pc2UgdG8gcmVzb2x2ZSBiZWZvcmUgdXNpbmcgdGhpcyBmdW5jdGlvbiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgICAgIGNvbnN0IHh5TGV2ZWwgPSBnZXRUaWxlWFlMZXZlbChyZWN0YW5nbGUpOwogICAgICAgIGxldCBtYXhUZXJyYWluSGVpZ2h0ID0gQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5fZGVmYXVsdE1heFRlcnJhaW5IZWlnaHQ7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh4eUxldmVsKSkgewogICAgICAgICAgY29uc3Qga2V5ID0gYCR7eHlMZXZlbC5sZXZlbH0tJHt4eUxldmVsLnh9LSR7eHlMZXZlbC55fWA7CiAgICAgICAgICBjb25zdCBoZWlnaHRzID0gQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5fdGVycmFpbkhlaWdodHNba2V5XTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaGVpZ2h0cykpIHsKICAgICAgICAgICAgbWF4VGVycmFpbkhlaWdodCA9IGhlaWdodHNbMV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJlc3VsdCA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVJlY3RhbmdsZTNEKHJlY3RhbmdsZSwgZWxsaXBzb2lkLCAwKTsKICAgICAgICBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21SZWN0YW5nbGUzRCgKICAgICAgICAgIHJlY3RhbmdsZSwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIG1heFRlcnJhaW5IZWlnaHQsCiAgICAgICAgICBzY3JhdGNoQm91bmRpbmdTcGhlcmUyCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC51bmlvbihyZXN1bHQsIHNjcmF0Y2hCb3VuZGluZ1NwaGVyZTIsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX3RlcnJhaW5IZWlnaHRzTWF4TGV2ZWwgPSA2OwogICAgICBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLl9kZWZhdWx0TWF4VGVycmFpbkhlaWdodCA9IDllMzsKICAgICAgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5fZGVmYXVsdE1pblRlcnJhaW5IZWlnaHQgPSAtMWU1OwogICAgICBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLl90ZXJyYWluSGVpZ2h0cyA9IHZvaWQgMDsKICAgICAgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5faW5pdFByb21pc2UgPSB2b2lkIDA7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMsIHsKICAgICAgICAvKioKICAgICAgICAgKiBEZXRlcm1pbmVzIGlmIHRoZSB0ZXJyYWluIGhlaWdodHMgYXJlIGluaXRpYWxpemVkIGFuZCByZWFkeSB0byB1c2UuIFRvIGluaXRpYWxpemUgdGhlIHRlcnJhaW4gaGVpZ2h0cywKICAgICAgICAgKiBjYWxsIHtAbGluayBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzI2luaXRpYWxpemV9IGFuZCB3YWl0IGZvciB0aGUgcmV0dXJuZWQgcHJvbWlzZSB0byByZXNvbHZlLgogICAgICAgICAqIEB0eXBlIHtib29sZWFufQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqIEBtZW1iZXJvZiBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzCiAgICAgICAgICovCiAgICAgICAgaW5pdGlhbGl6ZWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBkZWZpbmVkX2RlZmF1bHQoQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5fdGVycmFpbkhlaWdodHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHNfZGVmYXVsdCA9IEFwcHJveGltYXRlVGVycmFpbkhlaWdodHM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Hcm91bmRQb2x5bGluZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gR3JvdW5kUG9seWxpbmVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG9wdGlvbnMucG9zaXRpb25zOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSB8fCBwb3NpdGlvbnMubGVuZ3RoIDwgMikgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiQXQgbGVhc3QgdHdvIHBvc2l0aW9ucyBhcmUgcmVxdWlyZWQuIik7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuYXJjVHlwZSkgJiYgb3B0aW9ucy5hcmNUeXBlICE9PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMgJiYgb3B0aW9ucy5hcmNUeXBlICE9PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIlZhbGlkIG9wdGlvbnMgZm9yIGFyY1R5cGUgYXJlIEFyY1R5cGUuR0VPREVTSUMgYW5kIEFyY1R5cGUuUkhVTUIuIgogICAgICApOwogICAgfQogICAgdGhpcy53aWR0aCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMud2lkdGgsIDEpOwogICAgdGhpcy5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgdGhpcy5ncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZ3JhbnVsYXJpdHksIDk5OTkpOwogICAgdGhpcy5sb29wID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5sb29wLCBmYWxzZSk7CiAgICB0aGlzLmFyY1R5cGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmFyY1R5cGUsIEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQyk7CiAgICB0aGlzLl9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NDsKICAgIHRoaXMuX3Byb2plY3Rpb25JbmRleCA9IDA7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnkiOwogICAgdGhpcy5fc2NlbmUzRE9ubHkgPSBmYWxzZTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVJpZ2h0Tm9ybWFsKHN0YXJ0LCBlbmQsIG1heEhlaWdodCwgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgIGNvbnN0IHN0YXJ0Qm90dG9tID0gZ2V0UG9zaXRpb24oZWxsaXBzb2lkLCBzdGFydCwgMCwgY2FydDNTY3JhdGNoMSk7CiAgICBjb25zdCBzdGFydFRvcCA9IGdldFBvc2l0aW9uKGVsbGlwc29pZCwgc3RhcnQsIG1heEhlaWdodCwgY2FydDNTY3JhdGNoMik7CiAgICBjb25zdCBlbmRCb3R0b20gPSBnZXRQb3NpdGlvbihlbGxpcHNvaWQsIGVuZCwgMCwgY2FydDNTY3JhdGNoMyk7CiAgICBjb25zdCB1cCA9IGRpcmVjdGlvbihzdGFydFRvcCwgc3RhcnRCb3R0b20sIGNhcnQzU2NyYXRjaDIpOwogICAgY29uc3QgZm9yd2FyZCA9IGRpcmVjdGlvbihlbmRCb3R0b20sIHN0YXJ0Qm90dG9tLCBjYXJ0M1NjcmF0Y2gzKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhmb3J3YXJkLCB1cCwgcmVzdWx0KTsKICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHJlc3VsdCwgcmVzdWx0KTsKICB9CiAgZnVuY3Rpb24gaW50ZXJwb2xhdGVTZWdtZW50KHN0YXJ0LCBlbmQsIG1pbkhlaWdodCwgbWF4SGVpZ2h0LCBncmFudWxhcml0eSwgYXJjVHlwZSwgZWxsaXBzb2lkLCBub3JtYWxzQXJyYXksIGJvdHRvbVBvc2l0aW9uc0FycmF5LCB0b3BQb3NpdGlvbnNBcnJheSwgY2FydG9ncmFwaGljc0FycmF5KSB7CiAgICBpZiAoZ3JhbnVsYXJpdHkgPT09IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgbGV0IGVsbGlwc29pZExpbmU7CiAgICBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDKSB7CiAgICAgIGVsbGlwc29pZExpbmUgPSBuZXcgRWxsaXBzb2lkR2VvZGVzaWNfZGVmYXVsdChzdGFydCwgZW5kLCBlbGxpcHNvaWQpOwogICAgfSBlbHNlIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgZWxsaXBzb2lkTGluZSA9IG5ldyBFbGxpcHNvaWRSaHVtYkxpbmVfZGVmYXVsdChzdGFydCwgZW5kLCBlbGxpcHNvaWQpOwogICAgfQogICAgY29uc3Qgc3VyZmFjZURpc3RhbmNlID0gZWxsaXBzb2lkTGluZS5zdXJmYWNlRGlzdGFuY2U7CiAgICBpZiAoc3VyZmFjZURpc3RhbmNlIDwgZ3JhbnVsYXJpdHkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgaW50ZXJwb2xhdGVkTm9ybWFsID0gY29tcHV0ZVJpZ2h0Tm9ybWFsKAogICAgICBzdGFydCwKICAgICAgZW5kLAogICAgICBtYXhIZWlnaHQsCiAgICAgIGVsbGlwc29pZCwKICAgICAgaW50ZXJwb2xhdGVkTm9ybWFsU2NyYXRjaAogICAgKTsKICAgIGNvbnN0IHNlZ21lbnRzID0gTWF0aC5jZWlsKHN1cmZhY2VEaXN0YW5jZSAvIGdyYW51bGFyaXR5KTsKICAgIGNvbnN0IGludGVycG9pbnREaXN0YW5jZSA9IHN1cmZhY2VEaXN0YW5jZSAvIHNlZ21lbnRzOwogICAgbGV0IGRpc3RhbmNlRnJvbVN0YXJ0ID0gaW50ZXJwb2ludERpc3RhbmNlOwogICAgY29uc3QgcG9pbnRzVG9BZGQgPSBzZWdtZW50cyAtIDE7CiAgICBsZXQgcGFja0luZGV4ID0gbm9ybWFsc0FycmF5Lmxlbmd0aDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9pbnRzVG9BZGQ7IGkrKykgewogICAgICBjb25zdCBpbnRlcnBvbGF0ZWRDYXJ0b2dyYXBoaWMgPSBlbGxpcHNvaWRMaW5lLmludGVycG9sYXRlVXNpbmdTdXJmYWNlRGlzdGFuY2UoCiAgICAgICAgZGlzdGFuY2VGcm9tU3RhcnQsCiAgICAgICAgaW50ZXJwb2xhdGVkQ2FydG9ncmFwaGljU2NyYXRjaAogICAgICApOwogICAgICBjb25zdCBpbnRlcnBvbGF0ZWRCb3R0b20gPSBnZXRQb3NpdGlvbigKICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgaW50ZXJwb2xhdGVkQ2FydG9ncmFwaGljLAogICAgICAgIG1pbkhlaWdodCwKICAgICAgICBpbnRlcnBvbGF0ZWRCb3R0b21TY3JhdGNoCiAgICAgICk7CiAgICAgIGNvbnN0IGludGVycG9sYXRlZFRvcCA9IGdldFBvc2l0aW9uKAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICBpbnRlcnBvbGF0ZWRDYXJ0b2dyYXBoaWMsCiAgICAgICAgbWF4SGVpZ2h0LAogICAgICAgIGludGVycG9sYXRlZFRvcFNjcmF0Y2gKICAgICAgKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soaW50ZXJwb2xhdGVkTm9ybWFsLCBub3JtYWxzQXJyYXksIHBhY2tJbmRleCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGludGVycG9sYXRlZEJvdHRvbSwgYm90dG9tUG9zaXRpb25zQXJyYXksIHBhY2tJbmRleCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGludGVycG9sYXRlZFRvcCwgdG9wUG9zaXRpb25zQXJyYXksIHBhY2tJbmRleCk7CiAgICAgIGNhcnRvZ3JhcGhpY3NBcnJheS5wdXNoKGludGVycG9sYXRlZENhcnRvZ3JhcGhpYy5sYXRpdHVkZSk7CiAgICAgIGNhcnRvZ3JhcGhpY3NBcnJheS5wdXNoKGludGVycG9sYXRlZENhcnRvZ3JhcGhpYy5sb25naXR1ZGUpOwogICAgICBwYWNrSW5kZXggKz0gMzsKICAgICAgZGlzdGFuY2VGcm9tU3RhcnQgKz0gaW50ZXJwb2ludERpc3RhbmNlOwogICAgfQogIH0KICBmdW5jdGlvbiBnZXRQb3NpdGlvbihlbGxpcHNvaWQsIGNhcnRvZ3JhcGhpYzIsIGhlaWdodCwgcmVzdWx0KSB7CiAgICBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5jbG9uZShjYXJ0b2dyYXBoaWMyLCBoZWlnaHRsZXNzQ2FydG9ncmFwaGljU2NyYXRjaCk7CiAgICBoZWlnaHRsZXNzQ2FydG9ncmFwaGljU2NyYXRjaC5oZWlnaHQgPSBoZWlnaHQ7CiAgICByZXR1cm4gQ2FydG9ncmFwaGljX2RlZmF1bHQudG9DYXJ0ZXNpYW4oCiAgICAgIGhlaWdodGxlc3NDYXJ0b2dyYXBoaWNTY3JhdGNoLAogICAgICBlbGxpcHNvaWQsCiAgICAgIHJlc3VsdAogICAgKTsKICB9CiAgZnVuY3Rpb24gZGlyZWN0aW9uKHRhcmdldCwgb3JpZ2luLCByZXN1bHQpIHsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCh0YXJnZXQsIG9yaWdpbiwgcmVzdWx0KTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmVzdWx0LCByZXN1bHQpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gdGFuZ2VudERpcmVjdGlvbih0YXJnZXQsIG9yaWdpbiwgdXAsIHJlc3VsdCkgewogICAgcmVzdWx0ID0gZGlyZWN0aW9uKHRhcmdldCwgb3JpZ2luLCByZXN1bHQpOwogICAgcmVzdWx0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHJlc3VsdCwgdXAsIHJlc3VsdCk7CiAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHJlc3VsdCwgcmVzdWx0KTsKICAgIHJlc3VsdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyh1cCwgcmVzdWx0LCByZXN1bHQpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVZlcnRleE1pdGVyTm9ybWFsKHByZXZpb3VzQm90dG9tLCB2ZXJ0ZXhCb3R0b20sIHZlcnRleFRvcCwgbmV4dEJvdHRvbSwgcmVzdWx0KSB7CiAgICBjb25zdCB1cCA9IGRpcmVjdGlvbih2ZXJ0ZXhUb3AsIHZlcnRleEJvdHRvbSwgdmVydGV4VXBTY3JhdGNoKTsKICAgIGNvbnN0IHRvUHJldmlvdXMgPSB0YW5nZW50RGlyZWN0aW9uKAogICAgICBwcmV2aW91c0JvdHRvbSwKICAgICAgdmVydGV4Qm90dG9tLAogICAgICB1cCwKICAgICAgdG9QcmV2aW91c1NjcmF0Y2gKICAgICk7CiAgICBjb25zdCB0b05leHQgPSB0YW5nZW50RGlyZWN0aW9uKG5leHRCb3R0b20sIHZlcnRleEJvdHRvbSwgdXAsIHRvTmV4dFNjcmF0Y2gpOwogICAgaWYgKE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHRvUHJldmlvdXMsIHRvTmV4dCksCiAgICAgIGNvc2luZTE4MCwKICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT041CiAgICApKSB7CiAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyh1cCwgdG9QcmV2aW91cywgcmVzdWx0KTsKICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShyZXN1bHQsIHJlc3VsdCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHRvTmV4dCwgdG9QcmV2aW91cywgcmVzdWx0KTsKICAgIHJlc3VsdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmVzdWx0LCByZXN1bHQpOwogICAgY29uc3QgZm9yd2FyZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyh1cCwgcmVzdWx0LCBmb3J3YXJkU2NyYXRjaCk7CiAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh0b05leHQsIGZvcndhcmQpIDwgY29zaW5lOTApIHsKICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShyZXN1bHQsIHJlc3VsdCk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBicmVha01pdGVyKGVuZEdlb21ldHJ5Tm9ybWFsLCBzdGFydEJvdHRvbSwgZW5kQm90dG9tLCBlbmRUb3ApIHsKICAgIGNvbnN0IGxpbmVEaXJlY3Rpb24gPSBkaXJlY3Rpb24oZW5kQm90dG9tLCBzdGFydEJvdHRvbSwgbGluZURpcmVjdGlvblNjcmF0Y2gpOwogICAgY29uc3QgZG90ID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChsaW5lRGlyZWN0aW9uLCBlbmRHZW9tZXRyeU5vcm1hbCk7CiAgICBpZiAoZG90ID4gTUlURVJfQlJFQUtfU01BTEwgfHwgZG90IDwgTUlURVJfQlJFQUtfTEFSR0UpIHsKICAgICAgY29uc3QgdmVydGV4VXAgPSBkaXJlY3Rpb24oZW5kVG9wLCBlbmRCb3R0b20sIHZlcnRleFVwU2NyYXRjaCk7CiAgICAgIGNvbnN0IGFuZ2xlID0gZG90IDwgTUlURVJfQlJFQUtfTEFSR0UgPyBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gOiAtTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPOwogICAgICBjb25zdCBxdWF0ZXJuaW9uID0gUXVhdGVybmlvbl9kZWZhdWx0LmZyb21BeGlzQW5nbGUoCiAgICAgICAgdmVydGV4VXAsCiAgICAgICAgYW5nbGUsCiAgICAgICAgcXVhdGVybmlvblNjcmF0Y2gzCiAgICAgICk7CiAgICAgIGNvbnN0IHJvdGF0aW9uTWF0cml4ID0gTWF0cml4M19kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKHF1YXRlcm5pb24sIG1hdHJpeDNTY3JhdGNoKTsKICAgICAgTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoCiAgICAgICAgcm90YXRpb25NYXRyaXgsCiAgICAgICAgZW5kR2VvbWV0cnlOb3JtYWwsCiAgICAgICAgZW5kR2VvbWV0cnlOb3JtYWwKICAgICAgKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGZ1bmN0aW9uIHByb2plY3ROb3JtYWwocHJvamVjdGlvbiwgY2FydG9ncmFwaGljMiwgbm9ybWFsMiwgcHJvamVjdGVkUG9zaXRpb24sIHJlc3VsdCkgewogICAgY29uc3QgcG9zaXRpb24gPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC50b0NhcnRlc2lhbigKICAgICAgY2FydG9ncmFwaGljMiwKICAgICAgcHJvamVjdGlvbi5fZWxsaXBzb2lkLAogICAgICBub3JtYWxTdGFydHBvaW50U2NyYXRjaAogICAgKTsKICAgIGxldCBub3JtYWxFbmRwb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24sIG5vcm1hbDIsIG5vcm1hbEVuZHBvaW50U2NyYXRjaCk7CiAgICBsZXQgZmxpcE5vcm1hbCA9IGZhbHNlOwogICAgY29uc3QgZWxsaXBzb2lkID0gcHJvamVjdGlvbi5fZWxsaXBzb2lkOwogICAgbGV0IG5vcm1hbEVuZHBvaW50Q2FydG9ncmFwaGljID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICBub3JtYWxFbmRwb2ludCwKICAgICAgZW5kUG9zQ2FydG9ncmFwaGljU2NyYXRjaAogICAgKTsKICAgIGlmIChNYXRoLmFicyhjYXJ0b2dyYXBoaWMyLmxvbmdpdHVkZSAtIG5vcm1hbEVuZHBvaW50Q2FydG9ncmFwaGljLmxvbmdpdHVkZSkgPiBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08pIHsKICAgICAgZmxpcE5vcm1hbCA9IHRydWU7CiAgICAgIG5vcm1hbEVuZHBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgIHBvc2l0aW9uLAogICAgICAgIG5vcm1hbDIsCiAgICAgICAgbm9ybWFsRW5kcG9pbnRTY3JhdGNoCiAgICAgICk7CiAgICAgIG5vcm1hbEVuZHBvaW50Q2FydG9ncmFwaGljID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICAgIG5vcm1hbEVuZHBvaW50LAogICAgICAgIGVuZFBvc0NhcnRvZ3JhcGhpY1NjcmF0Y2gKICAgICAgKTsKICAgIH0KICAgIG5vcm1hbEVuZHBvaW50Q2FydG9ncmFwaGljLmhlaWdodCA9IDA7CiAgICBjb25zdCBub3JtYWxFbmRwb2ludFByb2plY3RlZCA9IHByb2plY3Rpb24ucHJvamVjdCgKICAgICAgbm9ybWFsRW5kcG9pbnRDYXJ0b2dyYXBoaWMsCiAgICAgIHJlc3VsdAogICAgKTsKICAgIHJlc3VsdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgbm9ybWFsRW5kcG9pbnRQcm9qZWN0ZWQsCiAgICAgIHByb2plY3RlZFBvc2l0aW9uLAogICAgICByZXN1bHQKICAgICk7CiAgICByZXN1bHQueiA9IDA7CiAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHJlc3VsdCwgcmVzdWx0KTsKICAgIGlmIChmbGlwTm9ybWFsKSB7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUocmVzdWx0LCByZXN1bHQpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gYWRqdXN0SGVpZ2h0cyhib3R0b20sIHRvcCwgbWluSGVpZ2h0LCBtYXhIZWlnaHQsIGFkanVzdEhlaWdodEJvdHRvbSwgYWRqdXN0SGVpZ2h0VG9wKSB7CiAgICBjb25zdCBhZGp1c3RIZWlnaHROb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgIHRvcCwKICAgICAgYm90dG9tLAogICAgICBhZGp1c3RIZWlnaHROb3JtYWxTY3JhdGNoCiAgICApOwogICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShhZGp1c3RIZWlnaHROb3JtYWwsIGFkanVzdEhlaWdodE5vcm1hbCk7CiAgICBjb25zdCBkaXN0YW5jZUZvckJvdHRvbSA9IG1pbkhlaWdodCAtIFdBTExfSU5JVElBTF9NSU5fSEVJR0hUOwogICAgbGV0IGFkanVzdEhlaWdodE9mZnNldCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICBhZGp1c3RIZWlnaHROb3JtYWwsCiAgICAgIGRpc3RhbmNlRm9yQm90dG9tLAogICAgICBhZGp1c3RIZWlnaHRPZmZzZXRTY3JhdGNoCiAgICApOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChib3R0b20sIGFkanVzdEhlaWdodE9mZnNldCwgYWRqdXN0SGVpZ2h0Qm90dG9tKTsKICAgIGNvbnN0IGRpc3RhbmNlRm9yVG9wID0gbWF4SGVpZ2h0IC0gV0FMTF9JTklUSUFMX01BWF9IRUlHSFQ7CiAgICBhZGp1c3RIZWlnaHRPZmZzZXQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgYWRqdXN0SGVpZ2h0Tm9ybWFsLAogICAgICBkaXN0YW5jZUZvclRvcCwKICAgICAgYWRqdXN0SGVpZ2h0T2Zmc2V0U2NyYXRjaAogICAgKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQodG9wLCBhZGp1c3RIZWlnaHRPZmZzZXQsIGFkanVzdEhlaWdodFRvcCk7CiAgfQogIGZ1bmN0aW9uIG51ZGdlWFooc3RhcnQsIGVuZCkgewogICAgY29uc3Qgc3RhcnRUb1haZGlzdGFuY2UgPSBQbGFuZV9kZWZhdWx0LmdldFBvaW50RGlzdGFuY2UoWFpfUExBTkUsIHN0YXJ0KTsKICAgIGNvbnN0IGVuZFRvWFpkaXN0YW5jZSA9IFBsYW5lX2RlZmF1bHQuZ2V0UG9pbnREaXN0YW5jZShYWl9QTEFORSwgZW5kKTsKICAgIGxldCBvZmZzZXQgPSBudWRnZURpcmVjdGlvblNjcmF0Y2g7CiAgICBpZiAoTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oc3RhcnRUb1haZGlzdGFuY2UsIDAsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMikpIHsKICAgICAgb2Zmc2V0ID0gZGlyZWN0aW9uKGVuZCwgc3RhcnQsIG9mZnNldCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG9mZnNldCwgTWF0aF9kZWZhdWx0LkVQU0lMT04yLCBvZmZzZXQpOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHN0YXJ0LCBvZmZzZXQsIHN0YXJ0KTsKICAgIH0gZWxzZSBpZiAoTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oZW5kVG9YWmRpc3RhbmNlLCAwLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjIpKSB7CiAgICAgIG9mZnNldCA9IGRpcmVjdGlvbihzdGFydCwgZW5kLCBvZmZzZXQpOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihvZmZzZXQsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMiwgb2Zmc2V0KTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChlbmQsIG9mZnNldCwgZW5kKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gbnVkZ2VDYXJ0b2dyYXBoaWMoc3RhcnQsIGVuZCkgewogICAgY29uc3QgYWJzU3RhcnRMb24gPSBNYXRoLmFicyhzdGFydC5sb25naXR1ZGUpOwogICAgY29uc3QgYWJzRW5kTG9uID0gTWF0aC5hYnMoZW5kLmxvbmdpdHVkZSk7CiAgICBpZiAoTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oYWJzU3RhcnRMb24sIE1hdGhfZGVmYXVsdC5QSSwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMSkpIHsKICAgICAgY29uc3QgZW5kU2lnbiA9IE1hdGhfZGVmYXVsdC5zaWduKGVuZC5sb25naXR1ZGUpOwogICAgICBzdGFydC5sb25naXR1ZGUgPSBlbmRTaWduICogKGFic1N0YXJ0TG9uIC0gTWF0aF9kZWZhdWx0LkVQU0lMT04xMSk7CiAgICAgIHJldHVybiAxOwogICAgfSBlbHNlIGlmIChNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihhYnNFbmRMb24sIE1hdGhfZGVmYXVsdC5QSSwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMSkpIHsKICAgICAgY29uc3Qgc3RhcnRTaWduID0gTWF0aF9kZWZhdWx0LnNpZ24oc3RhcnQubG9uZ2l0dWRlKTsKICAgICAgZW5kLmxvbmdpdHVkZSA9IHN0YXJ0U2lnbiAqIChhYnNFbmRMb24gLSBNYXRoX2RlZmF1bHQuRVBTSUxPTjExKTsKICAgICAgcmV0dXJuIDI7CiAgICB9CiAgICByZXR1cm4gMDsKICB9CiAgZnVuY3Rpb24gZ2VuZXJhdGVHZW9tZXRyeUF0dHJpYnV0ZXMobG9vcCwgcHJvamVjdGlvbiwgYm90dG9tUG9zaXRpb25zQXJyYXksIHRvcFBvc2l0aW9uc0FycmF5LCBub3JtYWxzQXJyYXksIGNhcnRvZ3JhcGhpY3NBcnJheSwgY29tcHV0ZTJkQXR0cmlidXRlcykgewogICAgbGV0IGk7CiAgICBsZXQgaW5kZXg7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBwcm9qZWN0aW9uLl9lbGxpcHNvaWQ7CiAgICBjb25zdCBzZWdtZW50Q291bnQgPSBib3R0b21Qb3NpdGlvbnNBcnJheS5sZW5ndGggLyAzIC0gMTsKICAgIGNvbnN0IHZlcnRleENvdW50ID0gc2VnbWVudENvdW50ICogODsKICAgIGNvbnN0IGFycmF5U2l6ZVZlYzQgPSB2ZXJ0ZXhDb3VudCAqIDQ7CiAgICBjb25zdCBpbmRleENvdW50ID0gc2VnbWVudENvdW50ICogMzY7CiAgICBjb25zdCBpbmRpY2VzID0gdmVydGV4Q291bnQgPiA2NTUzNSA/IG5ldyBVaW50MzJBcnJheShpbmRleENvdW50KSA6IG5ldyBVaW50MTZBcnJheShpbmRleENvdW50KTsKICAgIGNvbnN0IHBvc2l0aW9uc0FycmF5ID0gbmV3IEZsb2F0NjRBcnJheSh2ZXJ0ZXhDb3VudCAqIDMpOwogICAgY29uc3Qgc3RhcnRIaUFuZEZvcndhcmRPZmZzZXRYID0gbmV3IEZsb2F0MzJBcnJheShhcnJheVNpemVWZWM0KTsKICAgIGNvbnN0IHN0YXJ0TG9BbmRGb3J3YXJkT2Zmc2V0WSA9IG5ldyBGbG9hdDMyQXJyYXkoYXJyYXlTaXplVmVjNCk7CiAgICBjb25zdCBzdGFydE5vcm1hbEFuZEZvcndhcmRPZmZzZXRaID0gbmV3IEZsb2F0MzJBcnJheShhcnJheVNpemVWZWM0KTsKICAgIGNvbnN0IGVuZE5vcm1hbEFuZFRleHR1cmVDb29yZGluYXRlTm9ybWFsaXphdGlvblggPSBuZXcgRmxvYXQzMkFycmF5KAogICAgICBhcnJheVNpemVWZWM0CiAgICApOwogICAgY29uc3QgcmlnaHROb3JtYWxBbmRUZXh0dXJlQ29vcmRpbmF0ZU5vcm1hbGl6YXRpb25ZID0gbmV3IEZsb2F0MzJBcnJheSgKICAgICAgYXJyYXlTaXplVmVjNAogICAgKTsKICAgIGxldCBzdGFydEhpTG8yRDsKICAgIGxldCBvZmZzZXRBbmRSaWdodDJEOwogICAgbGV0IHN0YXJ0RW5kTm9ybWFsczJEOwogICAgbGV0IHRleGNvb3JkTm9ybWFsaXphdGlvbjJEOwogICAgaWYgKGNvbXB1dGUyZEF0dHJpYnV0ZXMpIHsKICAgICAgc3RhcnRIaUxvMkQgPSBuZXcgRmxvYXQzMkFycmF5KGFycmF5U2l6ZVZlYzQpOwogICAgICBvZmZzZXRBbmRSaWdodDJEID0gbmV3IEZsb2F0MzJBcnJheShhcnJheVNpemVWZWM0KTsKICAgICAgc3RhcnRFbmROb3JtYWxzMkQgPSBuZXcgRmxvYXQzMkFycmF5KGFycmF5U2l6ZVZlYzQpOwogICAgICB0ZXhjb29yZE5vcm1hbGl6YXRpb24yRCA9IG5ldyBGbG9hdDMyQXJyYXkodmVydGV4Q291bnQgKiAyKTsKICAgIH0KICAgIGNvbnN0IGNhcnRvZ3JhcGhpY3NMZW5ndGggPSBjYXJ0b2dyYXBoaWNzQXJyYXkubGVuZ3RoIC8gMjsKICAgIGxldCBsZW5ndGgyRCA9IDA7CiAgICBjb25zdCBzdGFydENhcnRvZ3JhcGhpYyA9IHN0YXJ0Q2FydG9ncmFwaGljU2NyYXRjaDsKICAgIHN0YXJ0Q2FydG9ncmFwaGljLmhlaWdodCA9IDA7CiAgICBjb25zdCBlbmRDYXJ0b2dyYXBoaWMgPSBlbmRDYXJ0b2dyYXBoaWNTY3JhdGNoOwogICAgZW5kQ2FydG9ncmFwaGljLmhlaWdodCA9IDA7CiAgICBsZXQgc2VnbWVudFN0YXJ0Q2FydGVzaWFuID0gc2VnbWVudFN0YXJ0VG9wU2NyYXRjaDsKICAgIGxldCBzZWdtZW50RW5kQ2FydGVzaWFuID0gc2VnbWVudEVuZFRvcFNjcmF0Y2g7CiAgICBpZiAoY29tcHV0ZTJkQXR0cmlidXRlcykgewogICAgICBpbmRleCA9IDA7CiAgICAgIGZvciAoaSA9IDE7IGkgPCBjYXJ0b2dyYXBoaWNzTGVuZ3RoOyBpKyspIHsKICAgICAgICBzdGFydENhcnRvZ3JhcGhpYy5sYXRpdHVkZSA9IGNhcnRvZ3JhcGhpY3NBcnJheVtpbmRleF07CiAgICAgICAgc3RhcnRDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlID0gY2FydG9ncmFwaGljc0FycmF5W2luZGV4ICsgMV07CiAgICAgICAgZW5kQ2FydG9ncmFwaGljLmxhdGl0dWRlID0gY2FydG9ncmFwaGljc0FycmF5W2luZGV4ICsgMl07CiAgICAgICAgZW5kQ2FydG9ncmFwaGljLmxvbmdpdHVkZSA9IGNhcnRvZ3JhcGhpY3NBcnJheVtpbmRleCArIDNdOwogICAgICAgIHNlZ21lbnRTdGFydENhcnRlc2lhbiA9IHByb2plY3Rpb24ucHJvamVjdCgKICAgICAgICAgIHN0YXJ0Q2FydG9ncmFwaGljLAogICAgICAgICAgc2VnbWVudFN0YXJ0Q2FydGVzaWFuCiAgICAgICAgKTsKICAgICAgICBzZWdtZW50RW5kQ2FydGVzaWFuID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgZW5kQ2FydG9ncmFwaGljLAogICAgICAgICAgc2VnbWVudEVuZENhcnRlc2lhbgogICAgICAgICk7CiAgICAgICAgbGVuZ3RoMkQgKz0gQ2FydGVzaWFuM19kZWZhdWx0LmRpc3RhbmNlKAogICAgICAgICAgc2VnbWVudFN0YXJ0Q2FydGVzaWFuLAogICAgICAgICAgc2VnbWVudEVuZENhcnRlc2lhbgogICAgICAgICk7CiAgICAgICAgaW5kZXggKz0gMjsKICAgICAgfQogICAgfQogICAgY29uc3QgcG9zaXRpb25zTGVuZ3RoID0gdG9wUG9zaXRpb25zQXJyYXkubGVuZ3RoIC8gMzsKICAgIHNlZ21lbnRFbmRDYXJ0ZXNpYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICB0b3BQb3NpdGlvbnNBcnJheSwKICAgICAgMCwKICAgICAgc2VnbWVudEVuZENhcnRlc2lhbgogICAgKTsKICAgIGxldCBsZW5ndGgzRCA9IDA7CiAgICBpbmRleCA9IDM7CiAgICBmb3IgKGkgPSAxOyBpIDwgcG9zaXRpb25zTGVuZ3RoOyBpKyspIHsKICAgICAgc2VnbWVudFN0YXJ0Q2FydGVzaWFuID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKAogICAgICAgIHNlZ21lbnRFbmRDYXJ0ZXNpYW4sCiAgICAgICAgc2VnbWVudFN0YXJ0Q2FydGVzaWFuCiAgICAgICk7CiAgICAgIHNlZ21lbnRFbmRDYXJ0ZXNpYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgIHRvcFBvc2l0aW9uc0FycmF5LAogICAgICAgIGluZGV4LAogICAgICAgIHNlZ21lbnRFbmRDYXJ0ZXNpYW4KICAgICAgKTsKICAgICAgbGVuZ3RoM0QgKz0gQ2FydGVzaWFuM19kZWZhdWx0LmRpc3RhbmNlKHNlZ21lbnRTdGFydENhcnRlc2lhbiwgc2VnbWVudEVuZENhcnRlc2lhbik7CiAgICAgIGluZGV4ICs9IDM7CiAgICB9CiAgICBsZXQgajsKICAgIGluZGV4ID0gMzsKICAgIGxldCBjYXJ0b2dyYXBoaWNzSW5kZXggPSAwOwogICAgbGV0IHZlYzJzV3JpdGVJbmRleCA9IDA7CiAgICBsZXQgdmVjM3NXcml0ZUluZGV4ID0gMDsKICAgIGxldCB2ZWM0c1dyaXRlSW5kZXggPSAwOwogICAgbGV0IG1pdGVyQnJva2VuID0gZmFsc2U7CiAgICBsZXQgZW5kQm90dG9tID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgYm90dG9tUG9zaXRpb25zQXJyYXksCiAgICAgIDAsCiAgICAgIHNlZ21lbnRFbmRCb3R0b21TY3JhdGNoCiAgICApOwogICAgbGV0IGVuZFRvcCA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2sodG9wUG9zaXRpb25zQXJyYXksIDAsIHNlZ21lbnRFbmRUb3BTY3JhdGNoKTsKICAgIGxldCBlbmRHZW9tZXRyeU5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgIG5vcm1hbHNBcnJheSwKICAgICAgMCwKICAgICAgc2VnbWVudEVuZE5vcm1hbFNjcmF0Y2gKICAgICk7CiAgICBpZiAobG9vcCkgewogICAgICBjb25zdCBwcmVFbmRCb3R0b20gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgIGJvdHRvbVBvc2l0aW9uc0FycmF5LAogICAgICAgIGJvdHRvbVBvc2l0aW9uc0FycmF5Lmxlbmd0aCAtIDYsCiAgICAgICAgc2VnbWVudFN0YXJ0Qm90dG9tU2NyYXRjaAogICAgICApOwogICAgICBpZiAoYnJlYWtNaXRlcihlbmRHZW9tZXRyeU5vcm1hbCwgcHJlRW5kQm90dG9tLCBlbmRCb3R0b20sIGVuZFRvcCkpIHsKICAgICAgICBlbmRHZW9tZXRyeU5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoCiAgICAgICAgICBlbmRHZW9tZXRyeU5vcm1hbCwKICAgICAgICAgIGVuZEdlb21ldHJ5Tm9ybWFsCiAgICAgICAgKTsKICAgICAgfQogICAgfQogICAgbGV0IGxlbmd0aFNvRmFyM0QgPSAwOwogICAgbGV0IGxlbmd0aFNvRmFyMkQgPSAwOwogICAgbGV0IHN1bUhlaWdodHMgPSAwOwogICAgZm9yIChpID0gMDsgaSA8IHNlZ21lbnRDb3VudDsgaSsrKSB7CiAgICAgIGNvbnN0IHN0YXJ0Qm90dG9tID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGVuZEJvdHRvbSwgc2VnbWVudFN0YXJ0Qm90dG9tU2NyYXRjaCk7CiAgICAgIGNvbnN0IHN0YXJ0VG9wID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGVuZFRvcCwgc2VnbWVudFN0YXJ0VG9wU2NyYXRjaCk7CiAgICAgIGxldCBzdGFydEdlb21ldHJ5Tm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKAogICAgICAgIGVuZEdlb21ldHJ5Tm9ybWFsLAogICAgICAgIHNlZ21lbnRTdGFydE5vcm1hbFNjcmF0Y2gKICAgICAgKTsKICAgICAgaWYgKG1pdGVyQnJva2VuKSB7CiAgICAgICAgc3RhcnRHZW9tZXRyeU5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoCiAgICAgICAgICBzdGFydEdlb21ldHJ5Tm9ybWFsLAogICAgICAgICAgc3RhcnRHZW9tZXRyeU5vcm1hbAogICAgICAgICk7CiAgICAgIH0KICAgICAgZW5kQm90dG9tID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICBib3R0b21Qb3NpdGlvbnNBcnJheSwKICAgICAgICBpbmRleCwKICAgICAgICBzZWdtZW50RW5kQm90dG9tU2NyYXRjaAogICAgICApOwogICAgICBlbmRUb3AgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKHRvcFBvc2l0aW9uc0FycmF5LCBpbmRleCwgc2VnbWVudEVuZFRvcFNjcmF0Y2gpOwogICAgICBlbmRHZW9tZXRyeU5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgbm9ybWFsc0FycmF5LAogICAgICAgIGluZGV4LAogICAgICAgIHNlZ21lbnRFbmROb3JtYWxTY3JhdGNoCiAgICAgICk7CiAgICAgIG1pdGVyQnJva2VuID0gYnJlYWtNaXRlcihlbmRHZW9tZXRyeU5vcm1hbCwgc3RhcnRCb3R0b20sIGVuZEJvdHRvbSwgZW5kVG9wKTsKICAgICAgc3RhcnRDYXJ0b2dyYXBoaWMubGF0aXR1ZGUgPSBjYXJ0b2dyYXBoaWNzQXJyYXlbY2FydG9ncmFwaGljc0luZGV4XTsKICAgICAgc3RhcnRDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlID0gY2FydG9ncmFwaGljc0FycmF5W2NhcnRvZ3JhcGhpY3NJbmRleCArIDFdOwogICAgICBlbmRDYXJ0b2dyYXBoaWMubGF0aXR1ZGUgPSBjYXJ0b2dyYXBoaWNzQXJyYXlbY2FydG9ncmFwaGljc0luZGV4ICsgMl07CiAgICAgIGVuZENhcnRvZ3JhcGhpYy5sb25naXR1ZGUgPSBjYXJ0b2dyYXBoaWNzQXJyYXlbY2FydG9ncmFwaGljc0luZGV4ICsgM107CiAgICAgIGxldCBzdGFydDJEOwogICAgICBsZXQgZW5kMkQ7CiAgICAgIGxldCBzdGFydEdlb21ldHJ5Tm9ybWFsMkQ7CiAgICAgIGxldCBlbmRHZW9tZXRyeU5vcm1hbDJEOwogICAgICBpZiAoY29tcHV0ZTJkQXR0cmlidXRlcykgewogICAgICAgIGNvbnN0IG51ZGdlUmVzdWx0ID0gbnVkZ2VDYXJ0b2dyYXBoaWMoc3RhcnRDYXJ0b2dyYXBoaWMsIGVuZENhcnRvZ3JhcGhpYyk7CiAgICAgICAgc3RhcnQyRCA9IHByb2plY3Rpb24ucHJvamVjdChzdGFydENhcnRvZ3JhcGhpYywgc2VnbWVudFN0YXJ0MkRTY3JhdGNoKTsKICAgICAgICBlbmQyRCA9IHByb2plY3Rpb24ucHJvamVjdChlbmRDYXJ0b2dyYXBoaWMsIHNlZ21lbnRFbmQyRFNjcmF0Y2gpOwogICAgICAgIGNvbnN0IGRpcmVjdGlvbjJEID0gZGlyZWN0aW9uKGVuZDJELCBzdGFydDJELCBmb3J3YXJkT2Zmc2V0MkRTY3JhdGNoKTsKICAgICAgICBkaXJlY3Rpb24yRC55ID0gTWF0aC5hYnMoZGlyZWN0aW9uMkQueSk7CiAgICAgICAgc3RhcnRHZW9tZXRyeU5vcm1hbDJEID0gc2VnbWVudFN0YXJ0Tm9ybWFsMkRTY3JhdGNoOwogICAgICAgIGVuZEdlb21ldHJ5Tm9ybWFsMkQgPSBzZWdtZW50RW5kTm9ybWFsMkRTY3JhdGNoOwogICAgICAgIGlmIChudWRnZVJlc3VsdCA9PT0gMCB8fCBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjJELCBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9ZKSA+IE1JVEVSX0JSRUFLX1NNQUxMKSB7CiAgICAgICAgICBzdGFydEdlb21ldHJ5Tm9ybWFsMkQgPSBwcm9qZWN0Tm9ybWFsKAogICAgICAgICAgICBwcm9qZWN0aW9uLAogICAgICAgICAgICBzdGFydENhcnRvZ3JhcGhpYywKICAgICAgICAgICAgc3RhcnRHZW9tZXRyeU5vcm1hbCwKICAgICAgICAgICAgc3RhcnQyRCwKICAgICAgICAgICAgc2VnbWVudFN0YXJ0Tm9ybWFsMkRTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgZW5kR2VvbWV0cnlOb3JtYWwyRCA9IHByb2plY3ROb3JtYWwoCiAgICAgICAgICAgIHByb2plY3Rpb24sCiAgICAgICAgICAgIGVuZENhcnRvZ3JhcGhpYywKICAgICAgICAgICAgZW5kR2VvbWV0cnlOb3JtYWwsCiAgICAgICAgICAgIGVuZDJELAogICAgICAgICAgICBzZWdtZW50RW5kTm9ybWFsMkRTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSBpZiAobnVkZ2VSZXN1bHQgPT09IDEpIHsKICAgICAgICAgIGVuZEdlb21ldHJ5Tm9ybWFsMkQgPSBwcm9qZWN0Tm9ybWFsKAogICAgICAgICAgICBwcm9qZWN0aW9uLAogICAgICAgICAgICBlbmRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICAgIGVuZEdlb21ldHJ5Tm9ybWFsLAogICAgICAgICAgICBlbmQyRCwKICAgICAgICAgICAgc2VnbWVudEVuZE5vcm1hbDJEU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIHN0YXJ0R2VvbWV0cnlOb3JtYWwyRC54ID0gMDsKICAgICAgICAgIHN0YXJ0R2VvbWV0cnlOb3JtYWwyRC55ID0gTWF0aF9kZWZhdWx0LnNpZ24oCiAgICAgICAgICAgIHN0YXJ0Q2FydG9ncmFwaGljLmxvbmdpdHVkZSAtIE1hdGguYWJzKGVuZENhcnRvZ3JhcGhpYy5sb25naXR1ZGUpCiAgICAgICAgICApOwogICAgICAgICAgc3RhcnRHZW9tZXRyeU5vcm1hbDJELnogPSAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdGFydEdlb21ldHJ5Tm9ybWFsMkQgPSBwcm9qZWN0Tm9ybWFsKAogICAgICAgICAgICBwcm9qZWN0aW9uLAogICAgICAgICAgICBzdGFydENhcnRvZ3JhcGhpYywKICAgICAgICAgICAgc3RhcnRHZW9tZXRyeU5vcm1hbCwKICAgICAgICAgICAgc3RhcnQyRCwKICAgICAgICAgICAgc2VnbWVudFN0YXJ0Tm9ybWFsMkRTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgZW5kR2VvbWV0cnlOb3JtYWwyRC54ID0gMDsKICAgICAgICAgIGVuZEdlb21ldHJ5Tm9ybWFsMkQueSA9IE1hdGhfZGVmYXVsdC5zaWduKAogICAgICAgICAgICBzdGFydENhcnRvZ3JhcGhpYy5sb25naXR1ZGUgLSBlbmRDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlCiAgICAgICAgICApOwogICAgICAgICAgZW5kR2VvbWV0cnlOb3JtYWwyRC56ID0gMDsKICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3Qgc2VnbWVudExlbmd0aDNEID0gQ2FydGVzaWFuM19kZWZhdWx0LmRpc3RhbmNlKHN0YXJ0VG9wLCBlbmRUb3ApOwogICAgICBjb25zdCBlbmNvZGVkU3RhcnQgPSBFbmNvZGVkQ2FydGVzaWFuM19kZWZhdWx0LmZyb21DYXJ0ZXNpYW4oCiAgICAgICAgc3RhcnRCb3R0b20sCiAgICAgICAgZW5jb2RlU2NyYXRjaAogICAgICApOwogICAgICBjb25zdCBmb3J3YXJkT2Zmc2V0ID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgIGVuZEJvdHRvbSwKICAgICAgICBzdGFydEJvdHRvbSwKICAgICAgICBvZmZzZXRTY3JhdGNoMgogICAgICApOwogICAgICBjb25zdCBmb3J3YXJkID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShmb3J3YXJkT2Zmc2V0LCByaWdodFNjcmF0Y2gyKTsKICAgICAgbGV0IHN0YXJ0VXAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3Qoc3RhcnRUb3AsIHN0YXJ0Qm90dG9tLCBzdGFydFVwU2NyYXRjaCk7CiAgICAgIHN0YXJ0VXAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHN0YXJ0VXAsIHN0YXJ0VXApOwogICAgICBsZXQgcmlnaHROb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoZm9yd2FyZCwgc3RhcnRVcCwgcmlnaHRTY3JhdGNoMik7CiAgICAgIHJpZ2h0Tm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShyaWdodE5vcm1hbCwgcmlnaHROb3JtYWwpOwogICAgICBsZXQgc3RhcnRQbGFuZU5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcygKICAgICAgICBzdGFydFVwLAogICAgICAgIHN0YXJ0R2VvbWV0cnlOb3JtYWwsCiAgICAgICAgc3RhcnRQbGFuZU5vcm1hbFNjcmF0Y2gKICAgICAgKTsKICAgICAgc3RhcnRQbGFuZU5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoc3RhcnRQbGFuZU5vcm1hbCwgc3RhcnRQbGFuZU5vcm1hbCk7CiAgICAgIGxldCBlbmRVcCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChlbmRUb3AsIGVuZEJvdHRvbSwgZW5kVXBTY3JhdGNoKTsKICAgICAgZW5kVXAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGVuZFVwLCBlbmRVcCk7CiAgICAgIGxldCBlbmRQbGFuZU5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcygKICAgICAgICBlbmRHZW9tZXRyeU5vcm1hbCwKICAgICAgICBlbmRVcCwKICAgICAgICBlbmRQbGFuZU5vcm1hbFNjcmF0Y2gKICAgICAgKTsKICAgICAgZW5kUGxhbmVOb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGVuZFBsYW5lTm9ybWFsLCBlbmRQbGFuZU5vcm1hbCk7CiAgICAgIGNvbnN0IHRleGNvb3JkTm9ybWFsaXphdGlvbjNEWCA9IHNlZ21lbnRMZW5ndGgzRCAvIGxlbmd0aDNEOwogICAgICBjb25zdCB0ZXhjb29yZE5vcm1hbGl6YXRpb24zRFkgPSBsZW5ndGhTb0ZhcjNEIC8gbGVuZ3RoM0Q7CiAgICAgIGxldCBzZWdtZW50TGVuZ3RoMkQgPSAwOwogICAgICBsZXQgZW5jb2RlZFN0YXJ0MkQ7CiAgICAgIGxldCBmb3J3YXJkT2Zmc2V0MkQ7CiAgICAgIGxldCByaWdodDJEOwogICAgICBsZXQgdGV4Y29vcmROb3JtYWxpemF0aW9uMkRYID0gMDsKICAgICAgbGV0IHRleGNvb3JkTm9ybWFsaXphdGlvbjJEWSA9IDA7CiAgICAgIGlmIChjb21wdXRlMmRBdHRyaWJ1dGVzKSB7CiAgICAgICAgc2VnbWVudExlbmd0aDJEID0gQ2FydGVzaWFuM19kZWZhdWx0LmRpc3RhbmNlKHN0YXJ0MkQsIGVuZDJEKTsKICAgICAgICBlbmNvZGVkU3RhcnQyRCA9IEVuY29kZWRDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUNhcnRlc2lhbigKICAgICAgICAgIHN0YXJ0MkQsCiAgICAgICAgICBlbmNvZGVTY3JhdGNoMkQKICAgICAgICApOwogICAgICAgIGZvcndhcmRPZmZzZXQyRCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgIGVuZDJELAogICAgICAgICAgc3RhcnQyRCwKICAgICAgICAgIGZvcndhcmRPZmZzZXQyRFNjcmF0Y2gKICAgICAgICApOwogICAgICAgIHJpZ2h0MkQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGZvcndhcmRPZmZzZXQyRCwgcmlnaHQyRFNjcmF0Y2gpOwogICAgICAgIGNvbnN0IHN3YXAyID0gcmlnaHQyRC54OwogICAgICAgIHJpZ2h0MkQueCA9IHJpZ2h0MkQueTsKICAgICAgICByaWdodDJELnkgPSAtc3dhcDI7CiAgICAgICAgdGV4Y29vcmROb3JtYWxpemF0aW9uMkRYID0gc2VnbWVudExlbmd0aDJEIC8gbGVuZ3RoMkQ7CiAgICAgICAgdGV4Y29vcmROb3JtYWxpemF0aW9uMkRZID0gbGVuZ3RoU29GYXIyRCAvIGxlbmd0aDJEOwogICAgICB9CiAgICAgIGZvciAoaiA9IDA7IGogPCA4OyBqKyspIHsKICAgICAgICBjb25zdCB2ZWM0SW5kZXggPSB2ZWM0c1dyaXRlSW5kZXggKyBqICogNDsKICAgICAgICBjb25zdCB2ZWMySW5kZXggPSB2ZWMyc1dyaXRlSW5kZXggKyBqICogMjsKICAgICAgICBjb25zdCB3SW5kZXggPSB2ZWM0SW5kZXggKyAzOwogICAgICAgIGNvbnN0IHJpZ2h0UGxhbmVTaWRlID0gaiA8IDQgPyAxIDogLTE7CiAgICAgICAgY29uc3QgdG9wQm90dG9tU2lkZSA9IGogPT09IDIgfHwgaiA9PT0gMyB8fCBqID09PSA2IHx8IGogPT09IDcgPyAxIDogLTE7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soZW5jb2RlZFN0YXJ0LmhpZ2gsIHN0YXJ0SGlBbmRGb3J3YXJkT2Zmc2V0WCwgdmVjNEluZGV4KTsKICAgICAgICBzdGFydEhpQW5kRm9yd2FyZE9mZnNldFhbd0luZGV4XSA9IGZvcndhcmRPZmZzZXQueDsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhlbmNvZGVkU3RhcnQubG93LCBzdGFydExvQW5kRm9yd2FyZE9mZnNldFksIHZlYzRJbmRleCk7CiAgICAgICAgc3RhcnRMb0FuZEZvcndhcmRPZmZzZXRZW3dJbmRleF0gPSBmb3J3YXJkT2Zmc2V0Lnk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soCiAgICAgICAgICBzdGFydFBsYW5lTm9ybWFsLAogICAgICAgICAgc3RhcnROb3JtYWxBbmRGb3J3YXJkT2Zmc2V0WiwKICAgICAgICAgIHZlYzRJbmRleAogICAgICAgICk7CiAgICAgICAgc3RhcnROb3JtYWxBbmRGb3J3YXJkT2Zmc2V0Wlt3SW5kZXhdID0gZm9yd2FyZE9mZnNldC56OwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKAogICAgICAgICAgZW5kUGxhbmVOb3JtYWwsCiAgICAgICAgICBlbmROb3JtYWxBbmRUZXh0dXJlQ29vcmRpbmF0ZU5vcm1hbGl6YXRpb25YLAogICAgICAgICAgdmVjNEluZGV4CiAgICAgICAgKTsKICAgICAgICBlbmROb3JtYWxBbmRUZXh0dXJlQ29vcmRpbmF0ZU5vcm1hbGl6YXRpb25YW3dJbmRleF0gPSB0ZXhjb29yZE5vcm1hbGl6YXRpb24zRFggKiByaWdodFBsYW5lU2lkZTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjaygKICAgICAgICAgIHJpZ2h0Tm9ybWFsLAogICAgICAgICAgcmlnaHROb3JtYWxBbmRUZXh0dXJlQ29vcmRpbmF0ZU5vcm1hbGl6YXRpb25ZLAogICAgICAgICAgdmVjNEluZGV4CiAgICAgICAgKTsKICAgICAgICBsZXQgdGV4Y29vcmROb3JtYWxpemF0aW9uID0gdGV4Y29vcmROb3JtYWxpemF0aW9uM0RZICogdG9wQm90dG9tU2lkZTsKICAgICAgICBpZiAodGV4Y29vcmROb3JtYWxpemF0aW9uID09PSAwICYmIHRvcEJvdHRvbVNpZGUgPCAwKSB7CiAgICAgICAgICB0ZXhjb29yZE5vcm1hbGl6YXRpb24gPSA5OwogICAgICAgIH0KICAgICAgICByaWdodE5vcm1hbEFuZFRleHR1cmVDb29yZGluYXRlTm9ybWFsaXphdGlvbllbd0luZGV4XSA9IHRleGNvb3JkTm9ybWFsaXphdGlvbjsKICAgICAgICBpZiAoY29tcHV0ZTJkQXR0cmlidXRlcykgewogICAgICAgICAgc3RhcnRIaUxvMkRbdmVjNEluZGV4XSA9IGVuY29kZWRTdGFydDJELmhpZ2gueDsKICAgICAgICAgIHN0YXJ0SGlMbzJEW3ZlYzRJbmRleCArIDFdID0gZW5jb2RlZFN0YXJ0MkQuaGlnaC55OwogICAgICAgICAgc3RhcnRIaUxvMkRbdmVjNEluZGV4ICsgMl0gPSBlbmNvZGVkU3RhcnQyRC5sb3cueDsKICAgICAgICAgIHN0YXJ0SGlMbzJEW3ZlYzRJbmRleCArIDNdID0gZW5jb2RlZFN0YXJ0MkQubG93Lnk7CiAgICAgICAgICBzdGFydEVuZE5vcm1hbHMyRFt2ZWM0SW5kZXhdID0gLXN0YXJ0R2VvbWV0cnlOb3JtYWwyRC55OwogICAgICAgICAgc3RhcnRFbmROb3JtYWxzMkRbdmVjNEluZGV4ICsgMV0gPSBzdGFydEdlb21ldHJ5Tm9ybWFsMkQueDsKICAgICAgICAgIHN0YXJ0RW5kTm9ybWFsczJEW3ZlYzRJbmRleCArIDJdID0gZW5kR2VvbWV0cnlOb3JtYWwyRC55OwogICAgICAgICAgc3RhcnRFbmROb3JtYWxzMkRbdmVjNEluZGV4ICsgM10gPSAtZW5kR2VvbWV0cnlOb3JtYWwyRC54OwogICAgICAgICAgb2Zmc2V0QW5kUmlnaHQyRFt2ZWM0SW5kZXhdID0gZm9yd2FyZE9mZnNldDJELng7CiAgICAgICAgICBvZmZzZXRBbmRSaWdodDJEW3ZlYzRJbmRleCArIDFdID0gZm9yd2FyZE9mZnNldDJELnk7CiAgICAgICAgICBvZmZzZXRBbmRSaWdodDJEW3ZlYzRJbmRleCArIDJdID0gcmlnaHQyRC54OwogICAgICAgICAgb2Zmc2V0QW5kUmlnaHQyRFt2ZWM0SW5kZXggKyAzXSA9IHJpZ2h0MkQueTsKICAgICAgICAgIHRleGNvb3JkTm9ybWFsaXphdGlvbjJEW3ZlYzJJbmRleF0gPSB0ZXhjb29yZE5vcm1hbGl6YXRpb24yRFggKiByaWdodFBsYW5lU2lkZTsKICAgICAgICAgIHRleGNvb3JkTm9ybWFsaXphdGlvbiA9IHRleGNvb3JkTm9ybWFsaXphdGlvbjJEWSAqIHRvcEJvdHRvbVNpZGU7CiAgICAgICAgICBpZiAodGV4Y29vcmROb3JtYWxpemF0aW9uID09PSAwICYmIHRvcEJvdHRvbVNpZGUgPCAwKSB7CiAgICAgICAgICAgIHRleGNvb3JkTm9ybWFsaXphdGlvbiA9IDk7CiAgICAgICAgICB9CiAgICAgICAgICB0ZXhjb29yZE5vcm1hbGl6YXRpb24yRFt2ZWMySW5kZXggKyAxXSA9IHRleGNvb3JkTm9ybWFsaXphdGlvbjsKICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgYWRqdXN0SGVpZ2h0U3RhcnRCb3R0b20gPSBhZGp1c3RIZWlnaHRTdGFydEJvdHRvbVNjcmF0Y2g7CiAgICAgIGNvbnN0IGFkanVzdEhlaWdodEVuZEJvdHRvbSA9IGFkanVzdEhlaWdodEVuZEJvdHRvbVNjcmF0Y2g7CiAgICAgIGNvbnN0IGFkanVzdEhlaWdodFN0YXJ0VG9wID0gYWRqdXN0SGVpZ2h0U3RhcnRUb3BTY3JhdGNoOwogICAgICBjb25zdCBhZGp1c3RIZWlnaHRFbmRUb3AgPSBhZGp1c3RIZWlnaHRFbmRUb3BTY3JhdGNoOwogICAgICBjb25zdCBnZXRIZWlnaHRzUmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuZnJvbUNhcnRvZ3JhcGhpY0FycmF5KAogICAgICAgIGdldEhlaWdodENhcnRvZ3JhcGhpY3MsCiAgICAgICAgZ2V0SGVpZ2h0UmVjdGFuZ2xlU2NyYXRjaAogICAgICApOwogICAgICBjb25zdCBtaW5NYXhIZWlnaHRzID0gQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0c19kZWZhdWx0LmdldE1pbmltdW1NYXhpbXVtSGVpZ2h0cygKICAgICAgICBnZXRIZWlnaHRzUmVjdGFuZ2xlLAogICAgICAgIGVsbGlwc29pZAogICAgICApOwogICAgICBjb25zdCBtaW5IZWlnaHQgPSBtaW5NYXhIZWlnaHRzLm1pbmltdW1UZXJyYWluSGVpZ2h0OwogICAgICBjb25zdCBtYXhIZWlnaHQgPSBtaW5NYXhIZWlnaHRzLm1heGltdW1UZXJyYWluSGVpZ2h0OwogICAgICBzdW1IZWlnaHRzICs9IE1hdGguYWJzKG1pbkhlaWdodCk7CiAgICAgIHN1bUhlaWdodHMgKz0gTWF0aC5hYnMobWF4SGVpZ2h0KTsKICAgICAgYWRqdXN0SGVpZ2h0cygKICAgICAgICBzdGFydEJvdHRvbSwKICAgICAgICBzdGFydFRvcCwKICAgICAgICBtaW5IZWlnaHQsCiAgICAgICAgbWF4SGVpZ2h0LAogICAgICAgIGFkanVzdEhlaWdodFN0YXJ0Qm90dG9tLAogICAgICAgIGFkanVzdEhlaWdodFN0YXJ0VG9wCiAgICAgICk7CiAgICAgIGFkanVzdEhlaWdodHMoCiAgICAgICAgZW5kQm90dG9tLAogICAgICAgIGVuZFRvcCwKICAgICAgICBtaW5IZWlnaHQsCiAgICAgICAgbWF4SGVpZ2h0LAogICAgICAgIGFkanVzdEhlaWdodEVuZEJvdHRvbSwKICAgICAgICBhZGp1c3RIZWlnaHRFbmRUb3AKICAgICAgKTsKICAgICAgbGV0IG5vcm1hbE51ZGdlID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgcmlnaHROb3JtYWwsCiAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT041LAogICAgICAgIG5vcm1hbE51ZGdlU2NyYXRjaAogICAgICApOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgIGFkanVzdEhlaWdodFN0YXJ0Qm90dG9tLAogICAgICAgIG5vcm1hbE51ZGdlLAogICAgICAgIGFkanVzdEhlaWdodFN0YXJ0Qm90dG9tCiAgICAgICk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoYWRqdXN0SGVpZ2h0RW5kQm90dG9tLCBub3JtYWxOdWRnZSwgYWRqdXN0SGVpZ2h0RW5kQm90dG9tKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChhZGp1c3RIZWlnaHRTdGFydFRvcCwgbm9ybWFsTnVkZ2UsIGFkanVzdEhlaWdodFN0YXJ0VG9wKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChhZGp1c3RIZWlnaHRFbmRUb3AsIG5vcm1hbE51ZGdlLCBhZGp1c3RIZWlnaHRFbmRUb3ApOwogICAgICBudWRnZVhaKGFkanVzdEhlaWdodFN0YXJ0Qm90dG9tLCBhZGp1c3RIZWlnaHRFbmRCb3R0b20pOwogICAgICBudWRnZVhaKGFkanVzdEhlaWdodFN0YXJ0VG9wLCBhZGp1c3RIZWlnaHRFbmRUb3ApOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhhZGp1c3RIZWlnaHRTdGFydEJvdHRvbSwgcG9zaXRpb25zQXJyYXksIHZlYzNzV3JpdGVJbmRleCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGFkanVzdEhlaWdodEVuZEJvdHRvbSwgcG9zaXRpb25zQXJyYXksIHZlYzNzV3JpdGVJbmRleCArIDMpOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhhZGp1c3RIZWlnaHRFbmRUb3AsIHBvc2l0aW9uc0FycmF5LCB2ZWMzc1dyaXRlSW5kZXggKyA2KTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soYWRqdXN0SGVpZ2h0U3RhcnRUb3AsIHBvc2l0aW9uc0FycmF5LCB2ZWMzc1dyaXRlSW5kZXggKyA5KTsKICAgICAgbm9ybWFsTnVkZ2UgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICByaWdodE5vcm1hbCwKICAgICAgICAtMiAqIE1hdGhfZGVmYXVsdC5FUFNJTE9ONSwKICAgICAgICBub3JtYWxOdWRnZVNjcmF0Y2gKICAgICAgKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICBhZGp1c3RIZWlnaHRTdGFydEJvdHRvbSwKICAgICAgICBub3JtYWxOdWRnZSwKICAgICAgICBhZGp1c3RIZWlnaHRTdGFydEJvdHRvbQogICAgICApOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGFkanVzdEhlaWdodEVuZEJvdHRvbSwgbm9ybWFsTnVkZ2UsIGFkanVzdEhlaWdodEVuZEJvdHRvbSk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoYWRqdXN0SGVpZ2h0U3RhcnRUb3AsIG5vcm1hbE51ZGdlLCBhZGp1c3RIZWlnaHRTdGFydFRvcCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoYWRqdXN0SGVpZ2h0RW5kVG9wLCBub3JtYWxOdWRnZSwgYWRqdXN0SGVpZ2h0RW5kVG9wKTsKICAgICAgbnVkZ2VYWihhZGp1c3RIZWlnaHRTdGFydEJvdHRvbSwgYWRqdXN0SGVpZ2h0RW5kQm90dG9tKTsKICAgICAgbnVkZ2VYWihhZGp1c3RIZWlnaHRTdGFydFRvcCwgYWRqdXN0SGVpZ2h0RW5kVG9wKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soCiAgICAgICAgYWRqdXN0SGVpZ2h0U3RhcnRCb3R0b20sCiAgICAgICAgcG9zaXRpb25zQXJyYXksCiAgICAgICAgdmVjM3NXcml0ZUluZGV4ICsgMTIKICAgICAgKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soCiAgICAgICAgYWRqdXN0SGVpZ2h0RW5kQm90dG9tLAogICAgICAgIHBvc2l0aW9uc0FycmF5LAogICAgICAgIHZlYzNzV3JpdGVJbmRleCArIDE1CiAgICAgICk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGFkanVzdEhlaWdodEVuZFRvcCwgcG9zaXRpb25zQXJyYXksIHZlYzNzV3JpdGVJbmRleCArIDE4KTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soYWRqdXN0SGVpZ2h0U3RhcnRUb3AsIHBvc2l0aW9uc0FycmF5LCB2ZWMzc1dyaXRlSW5kZXggKyAyMSk7CiAgICAgIGNhcnRvZ3JhcGhpY3NJbmRleCArPSAyOwogICAgICBpbmRleCArPSAzOwogICAgICB2ZWMyc1dyaXRlSW5kZXggKz0gMTY7CiAgICAgIHZlYzNzV3JpdGVJbmRleCArPSAyNDsKICAgICAgdmVjNHNXcml0ZUluZGV4ICs9IDMyOwogICAgICBsZW5ndGhTb0ZhcjNEICs9IHNlZ21lbnRMZW5ndGgzRDsKICAgICAgbGVuZ3RoU29GYXIyRCArPSBzZWdtZW50TGVuZ3RoMkQ7CiAgICB9CiAgICBpbmRleCA9IDA7CiAgICBsZXQgaW5kZXhPZmZzZXQgPSAwOwogICAgZm9yIChpID0gMDsgaSA8IHNlZ21lbnRDb3VudDsgaSsrKSB7CiAgICAgIGZvciAoaiA9IDA7IGogPCBSRUZFUkVOQ0VfSU5ESUNFU19MRU5HVEg7IGorKykgewogICAgICAgIGluZGljZXNbaW5kZXggKyBqXSA9IFJFRkVSRU5DRV9JTkRJQ0VTW2pdICsgaW5kZXhPZmZzZXQ7CiAgICAgIH0KICAgICAgaW5kZXhPZmZzZXQgKz0gODsKICAgICAgaW5kZXggKz0gUkVGRVJFTkNFX0lORElDRVNfTEVOR1RIOwogICAgfQogICAgY29uc3QgYm91bmRpbmdTcGhlcmVzID0gc2NyYXRjaEJvdW5kaW5nU3BoZXJlczsKICAgIEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVZlcnRpY2VzKAogICAgICBib3R0b21Qb3NpdGlvbnNBcnJheSwKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sCiAgICAgIDMsCiAgICAgIGJvdW5kaW5nU3BoZXJlc1swXQogICAgKTsKICAgIEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVZlcnRpY2VzKAogICAgICB0b3BQb3NpdGlvbnNBcnJheSwKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sCiAgICAgIDMsCiAgICAgIGJvdW5kaW5nU3BoZXJlc1sxXQogICAgKTsKICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tQm91bmRpbmdTcGhlcmVzKGJvdW5kaW5nU3BoZXJlcyk7CiAgICBib3VuZGluZ1NwaGVyZS5yYWRpdXMgKz0gc3VtSGVpZ2h0cyAvIChzZWdtZW50Q291bnQgKiAyKTsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSB7CiAgICAgIHBvc2l0aW9uOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgbm9ybWFsaXplOiBmYWxzZSwKICAgICAgICB2YWx1ZXM6IHBvc2l0aW9uc0FycmF5CiAgICAgIH0pLAogICAgICBzdGFydEhpQW5kRm9yd2FyZE9mZnNldFg6IGdldFZlYzRHZW9tZXRyeUF0dHJpYnV0ZSgKICAgICAgICBzdGFydEhpQW5kRm9yd2FyZE9mZnNldFgKICAgICAgKSwKICAgICAgc3RhcnRMb0FuZEZvcndhcmRPZmZzZXRZOiBnZXRWZWM0R2VvbWV0cnlBdHRyaWJ1dGUoCiAgICAgICAgc3RhcnRMb0FuZEZvcndhcmRPZmZzZXRZCiAgICAgICksCiAgICAgIHN0YXJ0Tm9ybWFsQW5kRm9yd2FyZE9mZnNldFo6IGdldFZlYzRHZW9tZXRyeUF0dHJpYnV0ZSgKICAgICAgICBzdGFydE5vcm1hbEFuZEZvcndhcmRPZmZzZXRaCiAgICAgICksCiAgICAgIGVuZE5vcm1hbEFuZFRleHR1cmVDb29yZGluYXRlTm9ybWFsaXphdGlvblg6IGdldFZlYzRHZW9tZXRyeUF0dHJpYnV0ZSgKICAgICAgICBlbmROb3JtYWxBbmRUZXh0dXJlQ29vcmRpbmF0ZU5vcm1hbGl6YXRpb25YCiAgICAgICksCiAgICAgIHJpZ2h0Tm9ybWFsQW5kVGV4dHVyZUNvb3JkaW5hdGVOb3JtYWxpemF0aW9uWTogZ2V0VmVjNEdlb21ldHJ5QXR0cmlidXRlKAogICAgICAgIHJpZ2h0Tm9ybWFsQW5kVGV4dHVyZUNvb3JkaW5hdGVOb3JtYWxpemF0aW9uWQogICAgICApCiAgICB9OwogICAgaWYgKGNvbXB1dGUyZEF0dHJpYnV0ZXMpIHsKICAgICAgYXR0cmlidXRlcy5zdGFydEhpTG8yRCA9IGdldFZlYzRHZW9tZXRyeUF0dHJpYnV0ZShzdGFydEhpTG8yRCk7CiAgICAgIGF0dHJpYnV0ZXMub2Zmc2V0QW5kUmlnaHQyRCA9IGdldFZlYzRHZW9tZXRyeUF0dHJpYnV0ZShvZmZzZXRBbmRSaWdodDJEKTsKICAgICAgYXR0cmlidXRlcy5zdGFydEVuZE5vcm1hbHMyRCA9IGdldFZlYzRHZW9tZXRyeUF0dHJpYnV0ZShzdGFydEVuZE5vcm1hbHMyRCk7CiAgICAgIGF0dHJpYnV0ZXMudGV4Y29vcmROb3JtYWxpemF0aW9uMkQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICBub3JtYWxpemU6IGZhbHNlLAogICAgICAgIHZhbHVlczogdGV4Y29vcmROb3JtYWxpemF0aW9uMkQKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICBhdHRyaWJ1dGVzLAogICAgICBpbmRpY2VzLAogICAgICBib3VuZGluZ1NwaGVyZQogICAgfSk7CiAgfQogIGZ1bmN0aW9uIGdldFZlYzRHZW9tZXRyeUF0dHJpYnV0ZSh0eXBlZEFycmF5KSB7CiAgICByZXR1cm4gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogNCwKICAgICAgbm9ybWFsaXplOiBmYWxzZSwKICAgICAgdmFsdWVzOiB0eXBlZEFycmF5CiAgICB9KTsKICB9CiAgdmFyIFBST0pFQ1RJT05TLCBQUk9KRUNUSU9OX0NPVU5ULCBNSVRFUl9CUkVBS19TTUFMTCwgTUlURVJfQlJFQUtfTEFSR0UsIFdBTExfSU5JVElBTF9NSU5fSEVJR0hULCBXQUxMX0lOSVRJQUxfTUFYX0hFSUdIVCwgY2FydDNTY3JhdGNoMSwgY2FydDNTY3JhdGNoMiwgY2FydDNTY3JhdGNoMywgaW50ZXJwb2xhdGVkQ2FydG9ncmFwaGljU2NyYXRjaCwgaW50ZXJwb2xhdGVkQm90dG9tU2NyYXRjaCwgaW50ZXJwb2xhdGVkVG9wU2NyYXRjaCwgaW50ZXJwb2xhdGVkTm9ybWFsU2NyYXRjaCwgaGVpZ2h0bGVzc0NhcnRvZ3JhcGhpY1NjcmF0Y2gsIHRvUHJldmlvdXNTY3JhdGNoLCB0b05leHRTY3JhdGNoLCBmb3J3YXJkU2NyYXRjaCwgdmVydGV4VXBTY3JhdGNoLCBjb3NpbmU5MCwgY29zaW5lMTgwLCBYWl9QTEFORSwgcHJldmlvdXNCb3R0b21TY3JhdGNoLCB2ZXJ0ZXhCb3R0b21TY3JhdGNoLCB2ZXJ0ZXhUb3BTY3JhdGNoLCBuZXh0Qm90dG9tU2NyYXRjaCwgdmVydGV4Tm9ybWFsU2NyYXRjaCwgaW50ZXJzZWN0aW9uU2NyYXRjaCwgY2FydG9ncmFwaGljU2NyYXRjaDAsIGNhcnRvZ3JhcGhpY1NjcmF0Y2gxLCBjYXJ0b2dyYXBoaWNJbnRlcnNlY3Rpb25TY3JhdGNoLCBsaW5lRGlyZWN0aW9uU2NyYXRjaCwgbWF0cml4M1NjcmF0Y2gsIHF1YXRlcm5pb25TY3JhdGNoMywgZW5kUG9zQ2FydG9ncmFwaGljU2NyYXRjaCwgbm9ybWFsU3RhcnRwb2ludFNjcmF0Y2gsIG5vcm1hbEVuZHBvaW50U2NyYXRjaCwgYWRqdXN0SGVpZ2h0Tm9ybWFsU2NyYXRjaCwgYWRqdXN0SGVpZ2h0T2Zmc2V0U2NyYXRjaCwgbnVkZ2VEaXJlY3Rpb25TY3JhdGNoLCBzdGFydENhcnRvZ3JhcGhpY1NjcmF0Y2gsIGVuZENhcnRvZ3JhcGhpY1NjcmF0Y2gsIHNlZ21lbnRTdGFydFRvcFNjcmF0Y2gsIHNlZ21lbnRFbmRUb3BTY3JhdGNoLCBzZWdtZW50U3RhcnRCb3R0b21TY3JhdGNoLCBzZWdtZW50RW5kQm90dG9tU2NyYXRjaCwgc2VnbWVudFN0YXJ0Tm9ybWFsU2NyYXRjaCwgc2VnbWVudEVuZE5vcm1hbFNjcmF0Y2gsIGdldEhlaWdodENhcnRvZ3JhcGhpY3MsIGdldEhlaWdodFJlY3RhbmdsZVNjcmF0Y2gsIGFkanVzdEhlaWdodFN0YXJ0VG9wU2NyYXRjaCwgYWRqdXN0SGVpZ2h0RW5kVG9wU2NyYXRjaCwgYWRqdXN0SGVpZ2h0U3RhcnRCb3R0b21TY3JhdGNoLCBhZGp1c3RIZWlnaHRFbmRCb3R0b21TY3JhdGNoLCBzZWdtZW50U3RhcnQyRFNjcmF0Y2gsIHNlZ21lbnRFbmQyRFNjcmF0Y2gsIHNlZ21lbnRTdGFydE5vcm1hbDJEU2NyYXRjaCwgc2VnbWVudEVuZE5vcm1hbDJEU2NyYXRjaCwgb2Zmc2V0U2NyYXRjaDIsIHN0YXJ0VXBTY3JhdGNoLCBlbmRVcFNjcmF0Y2gsIHJpZ2h0U2NyYXRjaDIsIHN0YXJ0UGxhbmVOb3JtYWxTY3JhdGNoLCBlbmRQbGFuZU5vcm1hbFNjcmF0Y2gsIGVuY29kZVNjcmF0Y2gsIGVuY29kZVNjcmF0Y2gyRCwgZm9yd2FyZE9mZnNldDJEU2NyYXRjaCwgcmlnaHQyRFNjcmF0Y2gsIG5vcm1hbE51ZGdlU2NyYXRjaCwgc2NyYXRjaEJvdW5kaW5nU3BoZXJlcywgUkVGRVJFTkNFX0lORElDRVMsIFJFRkVSRU5DRV9JTkRJQ0VTX0xFTkdUSCwgR3JvdW5kUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0dyb3VuZFBvbHlsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dyb3VuZFBvbHlsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0FwcHJveGltYXRlVGVycmFpbkhlaWdodHMoKTsKICAgICAgaW5pdF9BcmNUeXBlKCk7CiAgICAgIGluaXRfYXJyYXlSZW1vdmVEdXBsaWNhdGVzKCk7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0VsbGlwc29pZEdlb2Rlc2ljKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkUmh1bWJMaW5lKCk7CiAgICAgIGluaXRfRW5jb2RlZENhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9HZW9ncmFwaGljUHJvamVjdGlvbigpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9JbnRlcnNlY3Rpb25UZXN0cygpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfUGxhbmUoKTsKICAgICAgaW5pdF9RdWF0ZXJuaW9uKCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfV2ViTWVyY2F0b3JQcm9qZWN0aW9uKCk7CiAgICAgIFBST0pFQ1RJT05TID0gW0dlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQsIFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0XTsKICAgICAgUFJPSkVDVElPTl9DT1VOVCA9IFBST0pFQ1RJT05TLmxlbmd0aDsKICAgICAgTUlURVJfQlJFQUtfU01BTEwgPSBNYXRoLmNvcyhNYXRoX2RlZmF1bHQudG9SYWRpYW5zKDMwKSk7CiAgICAgIE1JVEVSX0JSRUFLX0xBUkdFID0gTWF0aC5jb3MoTWF0aF9kZWZhdWx0LnRvUmFkaWFucygxNTApKTsKICAgICAgV0FMTF9JTklUSUFMX01JTl9IRUlHSFQgPSAwOwogICAgICBXQUxMX0lOSVRJQUxfTUFYX0hFSUdIVCA9IDFlMzsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoR3JvdW5kUG9seWxpbmVHZW9tZXRyeS5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgbnVtYmVyIG9mIGVsZW1lbnRzIHVzZWQgdG8gcGFjayB0aGUgb2JqZWN0IGludG8gYW4gYXJyYXkuCiAgICAgICAgICogQG1lbWJlcm9mIEdyb3VuZFBvbHlsaW5lR2VvbWV0cnkucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHBhY2tlZExlbmd0aDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIDEgKyB0aGlzLl9wb3NpdGlvbnMubGVuZ3RoICogMyArIDEgKyAxICsgMSArIEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDEgKyAxOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIEdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuc2V0UHJvamVjdGlvbkFuZEVsbGlwc29pZCA9IGZ1bmN0aW9uKGdyb3VuZFBvbHlsaW5lR2VvbWV0cnksIG1hcFByb2plY3Rpb24pIHsKICAgICAgICBsZXQgcHJvamVjdGlvbkluZGV4ID0gMDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IFBST0pFQ1RJT05fQ09VTlQ7IGkrKykgewogICAgICAgICAgaWYgKG1hcFByb2plY3Rpb24gaW5zdGFuY2VvZiBQUk9KRUNUSU9OU1tpXSkgewogICAgICAgICAgICBwcm9qZWN0aW9uSW5kZXggPSBpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZ3JvdW5kUG9seWxpbmVHZW9tZXRyeS5fcHJvamVjdGlvbkluZGV4ID0gcHJvamVjdGlvbkluZGV4OwogICAgICAgIGdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuX2VsbGlwc29pZCA9IG1hcFByb2plY3Rpb24uZWxsaXBzb2lkOwogICAgICB9OwogICAgICBjYXJ0M1NjcmF0Y2gxID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0M1NjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0M1NjcmF0Y2gzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBpbnRlcnBvbGF0ZWRDYXJ0b2dyYXBoaWNTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIGludGVycG9sYXRlZEJvdHRvbVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGludGVycG9sYXRlZFRvcFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGludGVycG9sYXRlZE5vcm1hbFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGhlaWdodGxlc3NDYXJ0b2dyYXBoaWNTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIEdyb3VuZFBvbHlsaW5lR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBsZXQgaW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB2YWx1ZS5fcG9zaXRpb25zOwogICAgICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgYXJyYXlbaW5kZXgrK10gPSBwb3NpdGlvbnNMZW5ndGg7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGg7ICsraSkgewogICAgICAgICAgY29uc3QgY2FydGVzaWFuMTEgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhjYXJ0ZXNpYW4xMSwgYXJyYXksIGluZGV4KTsKICAgICAgICAgIGluZGV4ICs9IDM7CiAgICAgICAgfQogICAgICAgIGFycmF5W2luZGV4KytdID0gdmFsdWUuZ3JhbnVsYXJpdHk7CiAgICAgICAgYXJyYXlbaW5kZXgrK10gPSB2YWx1ZS5sb29wID8gMSA6IDA7CiAgICAgICAgYXJyYXlbaW5kZXgrK10gPSB2YWx1ZS5hcmNUeXBlOwogICAgICAgIEVsbGlwc29pZF9kZWZhdWx0LnBhY2sodmFsdWUuX2VsbGlwc29pZCwgYXJyYXksIGluZGV4KTsKICAgICAgICBpbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbaW5kZXgrK10gPSB2YWx1ZS5fcHJvamVjdGlvbkluZGV4OwogICAgICAgIGFycmF5W2luZGV4KytdID0gdmFsdWUuX3NjZW5lM0RPbmx5ID8gMSA6IDA7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBHcm91bmRQb2x5bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIGxldCBpbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IGFycmF5W2luZGV4KytdOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheShwb3NpdGlvbnNMZW5ndGgpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb25zTGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHBvc2l0aW9uc1tpXSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIGluZGV4KTsKICAgICAgICAgIGluZGV4ICs9IDM7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbaW5kZXgrK107CiAgICAgICAgY29uc3QgbG9vcCA9IGFycmF5W2luZGV4KytdID09PSAxOwogICAgICAgIGNvbnN0IGFyY1R5cGUgPSBhcnJheVtpbmRleCsrXTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2soYXJyYXksIGluZGV4KTsKICAgICAgICBpbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgcHJvamVjdGlvbkluZGV4ID0gYXJyYXlbaW5kZXgrK107CiAgICAgICAgY29uc3Qgc2NlbmUzRE9ubHkgPSBhcnJheVtpbmRleCsrXSA9PT0gMTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgR3JvdW5kUG9seWxpbmVHZW9tZXRyeSh7CiAgICAgICAgICAgIHBvc2l0aW9ucwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgICAgIHJlc3VsdC5ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgIHJlc3VsdC5sb29wID0gbG9vcDsKICAgICAgICByZXN1bHQuYXJjVHlwZSA9IGFyY1R5cGU7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWQgPSBlbGxpcHNvaWQ7CiAgICAgICAgcmVzdWx0Ll9wcm9qZWN0aW9uSW5kZXggPSBwcm9qZWN0aW9uSW5kZXg7CiAgICAgICAgcmVzdWx0Ll9zY2VuZTNET25seSA9IHNjZW5lM0RPbmx5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHRvUHJldmlvdXNTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB0b05leHRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmb3J3YXJkU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdmVydGV4VXBTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjb3NpbmU5MCA9IDA7CiAgICAgIGNvc2luZTE4MCA9IC0xOwogICAgICBYWl9QTEFORSA9IFBsYW5lX2RlZmF1bHQuZnJvbVBvaW50Tm9ybWFsKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9ZKTsKICAgICAgcHJldmlvdXNCb3R0b21TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB2ZXJ0ZXhCb3R0b21TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB2ZXJ0ZXhUb3BTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBuZXh0Qm90dG9tU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdmVydGV4Tm9ybWFsU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgaW50ZXJzZWN0aW9uU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydG9ncmFwaGljU2NyYXRjaDAgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgY2FydG9ncmFwaGljU2NyYXRjaDEgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgY2FydG9ncmFwaGljSW50ZXJzZWN0aW9uU2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBHcm91bmRQb2x5bGluZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oZ3JvdW5kUG9seWxpbmVHZW9tZXRyeSkgewogICAgICAgIGNvbnN0IGNvbXB1dGUyZEF0dHJpYnV0ZXMgPSAhZ3JvdW5kUG9seWxpbmVHZW9tZXRyeS5fc2NlbmUzRE9ubHk7CiAgICAgICAgbGV0IGxvb3AgPSBncm91bmRQb2x5bGluZUdlb21ldHJ5Lmxvb3A7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gZ3JvdW5kUG9seWxpbmVHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZ3JvdW5kUG9seWxpbmVHZW9tZXRyeS5ncmFudWxhcml0eTsKICAgICAgICBjb25zdCBhcmNUeXBlID0gZ3JvdW5kUG9seWxpbmVHZW9tZXRyeS5hcmNUeXBlOwogICAgICAgIGNvbnN0IHByb2plY3Rpb24gPSBuZXcgUFJPSkVDVElPTlNbZ3JvdW5kUG9seWxpbmVHZW9tZXRyeS5fcHJvamVjdGlvbkluZGV4XSgKICAgICAgICAgIGVsbGlwc29pZAogICAgICAgICk7CiAgICAgICAgY29uc3QgbWluSGVpZ2h0ID0gV0FMTF9JTklUSUFMX01JTl9IRUlHSFQ7CiAgICAgICAgY29uc3QgbWF4SGVpZ2h0ID0gV0FMTF9JTklUSUFMX01BWF9IRUlHSFQ7CiAgICAgICAgbGV0IGluZGV4OwogICAgICAgIGxldCBpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IGdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuX3Bvc2l0aW9uczsKICAgICAgICBjb25zdCBwb3NpdGlvbnNMZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGlmIChwb3NpdGlvbnNMZW5ndGggPT09IDIpIHsKICAgICAgICAgIGxvb3AgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgbGV0IHAwOwogICAgICAgIGxldCBwMTsKICAgICAgICBsZXQgYzA7CiAgICAgICAgbGV0IGMxOwogICAgICAgIGNvbnN0IHJodW1iTGluZSA9IG5ldyBFbGxpcHNvaWRSaHVtYkxpbmVfZGVmYXVsdCh2b2lkIDAsIHZvaWQgMCwgZWxsaXBzb2lkKTsKICAgICAgICBsZXQgaW50ZXJzZWN0aW9uOwogICAgICAgIGxldCBpbnRlcnNlY3Rpb25DYXJ0b2dyYXBoaWM7CiAgICAgICAgbGV0IGludGVyc2VjdGlvbkxvbmdpdHVkZTsKICAgICAgICBjb25zdCBzcGxpdFBvc2l0aW9ucyA9IFtwb3NpdGlvbnNbMF1dOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgIHAwID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgcDEgPSBwb3NpdGlvbnNbaSArIDFdOwogICAgICAgICAgaW50ZXJzZWN0aW9uID0gSW50ZXJzZWN0aW9uVGVzdHNfZGVmYXVsdC5saW5lU2VnbWVudFBsYW5lKAogICAgICAgICAgICBwMCwKICAgICAgICAgICAgcDEsCiAgICAgICAgICAgIFhaX1BMQU5FLAogICAgICAgICAgICBpbnRlcnNlY3Rpb25TY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnRlcnNlY3Rpb24pICYmICFDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihpbnRlcnNlY3Rpb24sIHAwLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjcpICYmICFDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihpbnRlcnNlY3Rpb24sIHAxLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjcpKSB7CiAgICAgICAgICAgIGlmIChncm91bmRQb2x5bGluZUdlb21ldHJ5LmFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQykgewogICAgICAgICAgICAgIHNwbGl0UG9zaXRpb25zLnB1c2goQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGludGVyc2VjdGlvbikpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uTG9uZ2l0dWRlID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uLAogICAgICAgICAgICAgICAgY2FydG9ncmFwaGljU2NyYXRjaDAKICAgICAgICAgICAgICApLmxvbmdpdHVkZTsKICAgICAgICAgICAgICBjMCA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhwMCwgY2FydG9ncmFwaGljU2NyYXRjaDApOwogICAgICAgICAgICAgIGMxID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHAxLCBjYXJ0b2dyYXBoaWNTY3JhdGNoMSk7CiAgICAgICAgICAgICAgcmh1bWJMaW5lLnNldEVuZFBvaW50cyhjMCwgYzEpOwogICAgICAgICAgICAgIGludGVyc2VjdGlvbkNhcnRvZ3JhcGhpYyA9IHJodW1iTGluZS5maW5kSW50ZXJzZWN0aW9uV2l0aExvbmdpdHVkZSgKICAgICAgICAgICAgICAgIGludGVyc2VjdGlvbkxvbmdpdHVkZSwKICAgICAgICAgICAgICAgIGNhcnRvZ3JhcGhpY0ludGVyc2VjdGlvblNjcmF0Y2gKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGludGVyc2VjdGlvbiA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICAgICAgICAgIGludGVyc2VjdGlvbkNhcnRvZ3JhcGhpYywKICAgICAgICAgICAgICAgIGludGVyc2VjdGlvblNjcmF0Y2gKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW50ZXJzZWN0aW9uKSAmJiAhQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24oaW50ZXJzZWN0aW9uLCBwMCwgTWF0aF9kZWZhdWx0LkVQU0lMT043KSAmJiAhQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24oaW50ZXJzZWN0aW9uLCBwMSwgTWF0aF9kZWZhdWx0LkVQU0lMT043KSkgewogICAgICAgICAgICAgICAgc3BsaXRQb3NpdGlvbnMucHVzaChDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoaW50ZXJzZWN0aW9uKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBzcGxpdFBvc2l0aW9ucy5wdXNoKHAxKTsKICAgICAgICB9CiAgICAgICAgaWYgKGxvb3ApIHsKICAgICAgICAgIHAwID0gcG9zaXRpb25zW3Bvc2l0aW9uc0xlbmd0aCAtIDFdOwogICAgICAgICAgcDEgPSBwb3NpdGlvbnNbMF07CiAgICAgICAgICBpbnRlcnNlY3Rpb24gPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LmxpbmVTZWdtZW50UGxhbmUoCiAgICAgICAgICAgIHAwLAogICAgICAgICAgICBwMSwKICAgICAgICAgICAgWFpfUExBTkUsCiAgICAgICAgICAgIGludGVyc2VjdGlvblNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGludGVyc2VjdGlvbikgJiYgIUNhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGludGVyc2VjdGlvbiwgcDAsIE1hdGhfZGVmYXVsdC5FUFNJTE9ONykgJiYgIUNhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGludGVyc2VjdGlvbiwgcDEsIE1hdGhfZGVmYXVsdC5FUFNJTE9ONykpIHsKICAgICAgICAgICAgaWYgKGdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDKSB7CiAgICAgICAgICAgICAgc3BsaXRQb3NpdGlvbnMucHVzaChDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoaW50ZXJzZWN0aW9uKSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZ3JvdW5kUG9seWxpbmVHZW9tZXRyeS5hcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgICAgICAgICBpbnRlcnNlY3Rpb25Mb25naXR1ZGUgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgICAgICAgICBpbnRlcnNlY3Rpb24sCiAgICAgICAgICAgICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoMAogICAgICAgICAgICAgICkubG9uZ2l0dWRlOwogICAgICAgICAgICAgIGMwID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHAwLCBjYXJ0b2dyYXBoaWNTY3JhdGNoMCk7CiAgICAgICAgICAgICAgYzEgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocDEsIGNhcnRvZ3JhcGhpY1NjcmF0Y2gxKTsKICAgICAgICAgICAgICByaHVtYkxpbmUuc2V0RW5kUG9pbnRzKGMwLCBjMSk7CiAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uQ2FydG9ncmFwaGljID0gcmh1bWJMaW5lLmZpbmRJbnRlcnNlY3Rpb25XaXRoTG9uZ2l0dWRlKAogICAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uTG9uZ2l0dWRlLAogICAgICAgICAgICAgICAgY2FydG9ncmFwaGljSW50ZXJzZWN0aW9uU2NyYXRjaAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uQ2FydG9ncmFwaGljLAogICAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uU2NyYXRjaAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnRlcnNlY3Rpb24pICYmICFDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihpbnRlcnNlY3Rpb24sIHAwLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjcpICYmICFDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihpbnRlcnNlY3Rpb24sIHAxLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjcpKSB7CiAgICAgICAgICAgICAgICBzcGxpdFBvc2l0aW9ucy5wdXNoKENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShpbnRlcnNlY3Rpb24pKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGV0IGNhcnRvZ3JhcGhpY3NMZW5ndGggPSBzcGxpdFBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgbGV0IGNhcnRvZ3JhcGhpY3MgPSBuZXcgQXJyYXkoY2FydG9ncmFwaGljc0xlbmd0aCk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGNhcnRvZ3JhcGhpY3NMZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgY2FydG9ncmFwaGljMiA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmZyb21DYXJ0ZXNpYW4oCiAgICAgICAgICAgIHNwbGl0UG9zaXRpb25zW2ldLAogICAgICAgICAgICBlbGxpcHNvaWQKICAgICAgICAgICk7CiAgICAgICAgICBjYXJ0b2dyYXBoaWMyLmhlaWdodCA9IDA7CiAgICAgICAgICBjYXJ0b2dyYXBoaWNzW2ldID0gY2FydG9ncmFwaGljMjsKICAgICAgICB9CiAgICAgICAgY2FydG9ncmFwaGljcyA9IGFycmF5UmVtb3ZlRHVwbGljYXRlc19kZWZhdWx0KAogICAgICAgICAgY2FydG9ncmFwaGljcywKICAgICAgICAgIENhcnRvZ3JhcGhpY19kZWZhdWx0LmVxdWFsc0Vwc2lsb24KICAgICAgICApOwogICAgICAgIGNhcnRvZ3JhcGhpY3NMZW5ndGggPSBjYXJ0b2dyYXBoaWNzLmxlbmd0aDsKICAgICAgICBpZiAoY2FydG9ncmFwaGljc0xlbmd0aCA8IDIpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNhcnRvZ3JhcGhpY3NBcnJheSA9IFtdOwogICAgICAgIGNvbnN0IG5vcm1hbHNBcnJheSA9IFtdOwogICAgICAgIGNvbnN0IGJvdHRvbVBvc2l0aW9uc0FycmF5ID0gW107CiAgICAgICAgY29uc3QgdG9wUG9zaXRpb25zQXJyYXkgPSBbXTsKICAgICAgICBsZXQgcHJldmlvdXNCb3R0b20gPSBwcmV2aW91c0JvdHRvbVNjcmF0Y2g7CiAgICAgICAgbGV0IHZlcnRleEJvdHRvbSA9IHZlcnRleEJvdHRvbVNjcmF0Y2g7CiAgICAgICAgbGV0IHZlcnRleFRvcCA9IHZlcnRleFRvcFNjcmF0Y2g7CiAgICAgICAgbGV0IG5leHRCb3R0b20gPSBuZXh0Qm90dG9tU2NyYXRjaDsKICAgICAgICBsZXQgdmVydGV4Tm9ybWFsID0gdmVydGV4Tm9ybWFsU2NyYXRjaDsKICAgICAgICBjb25zdCBzdGFydENhcnRvZ3JhcGhpYyA9IGNhcnRvZ3JhcGhpY3NbMF07CiAgICAgICAgY29uc3QgbmV4dENhcnRvZ3JhcGhpYyA9IGNhcnRvZ3JhcGhpY3NbMV07CiAgICAgICAgY29uc3QgcHJlc3RhcnRDYXJ0b2dyYXBoaWMgPSBjYXJ0b2dyYXBoaWNzW2NhcnRvZ3JhcGhpY3NMZW5ndGggLSAxXTsKICAgICAgICBwcmV2aW91c0JvdHRvbSA9IGdldFBvc2l0aW9uKAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgcHJlc3RhcnRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICBtaW5IZWlnaHQsCiAgICAgICAgICBwcmV2aW91c0JvdHRvbQogICAgICAgICk7CiAgICAgICAgbmV4dEJvdHRvbSA9IGdldFBvc2l0aW9uKGVsbGlwc29pZCwgbmV4dENhcnRvZ3JhcGhpYywgbWluSGVpZ2h0LCBuZXh0Qm90dG9tKTsKICAgICAgICB2ZXJ0ZXhCb3R0b20gPSBnZXRQb3NpdGlvbigKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHN0YXJ0Q2FydG9ncmFwaGljLAogICAgICAgICAgbWluSGVpZ2h0LAogICAgICAgICAgdmVydGV4Qm90dG9tCiAgICAgICAgKTsKICAgICAgICB2ZXJ0ZXhUb3AgPSBnZXRQb3NpdGlvbihlbGxpcHNvaWQsIHN0YXJ0Q2FydG9ncmFwaGljLCBtYXhIZWlnaHQsIHZlcnRleFRvcCk7CiAgICAgICAgaWYgKGxvb3ApIHsKICAgICAgICAgIHZlcnRleE5vcm1hbCA9IGNvbXB1dGVWZXJ0ZXhNaXRlck5vcm1hbCgKICAgICAgICAgICAgcHJldmlvdXNCb3R0b20sCiAgICAgICAgICAgIHZlcnRleEJvdHRvbSwKICAgICAgICAgICAgdmVydGV4VG9wLAogICAgICAgICAgICBuZXh0Qm90dG9tLAogICAgICAgICAgICB2ZXJ0ZXhOb3JtYWwKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZlcnRleE5vcm1hbCA9IGNvbXB1dGVSaWdodE5vcm1hbCgKICAgICAgICAgICAgc3RhcnRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICAgIG5leHRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICAgIG1heEhlaWdodCwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICB2ZXJ0ZXhOb3JtYWwKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZlcnRleE5vcm1hbCwgbm9ybWFsc0FycmF5LCAwKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2ZXJ0ZXhCb3R0b20sIGJvdHRvbVBvc2l0aW9uc0FycmF5LCAwKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2ZXJ0ZXhUb3AsIHRvcFBvc2l0aW9uc0FycmF5LCAwKTsKICAgICAgICBjYXJ0b2dyYXBoaWNzQXJyYXkucHVzaChzdGFydENhcnRvZ3JhcGhpYy5sYXRpdHVkZSk7CiAgICAgICAgY2FydG9ncmFwaGljc0FycmF5LnB1c2goc3RhcnRDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlKTsKICAgICAgICBpbnRlcnBvbGF0ZVNlZ21lbnQoCiAgICAgICAgICBzdGFydENhcnRvZ3JhcGhpYywKICAgICAgICAgIG5leHRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICBtaW5IZWlnaHQsCiAgICAgICAgICBtYXhIZWlnaHQsCiAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgIGFyY1R5cGUsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBub3JtYWxzQXJyYXksCiAgICAgICAgICBib3R0b21Qb3NpdGlvbnNBcnJheSwKICAgICAgICAgIHRvcFBvc2l0aW9uc0FycmF5LAogICAgICAgICAgY2FydG9ncmFwaGljc0FycmF5CiAgICAgICAgKTsKICAgICAgICBmb3IgKGkgPSAxOyBpIDwgY2FydG9ncmFwaGljc0xlbmd0aCAtIDE7ICsraSkgewogICAgICAgICAgcHJldmlvdXNCb3R0b20gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUodmVydGV4Qm90dG9tLCBwcmV2aW91c0JvdHRvbSk7CiAgICAgICAgICB2ZXJ0ZXhCb3R0b20gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUobmV4dEJvdHRvbSwgdmVydGV4Qm90dG9tKTsKICAgICAgICAgIGNvbnN0IHZlcnRleENhcnRvZ3JhcGhpYyA9IGNhcnRvZ3JhcGhpY3NbaV07CiAgICAgICAgICBnZXRQb3NpdGlvbihlbGxpcHNvaWQsIHZlcnRleENhcnRvZ3JhcGhpYywgbWF4SGVpZ2h0LCB2ZXJ0ZXhUb3ApOwogICAgICAgICAgZ2V0UG9zaXRpb24oZWxsaXBzb2lkLCBjYXJ0b2dyYXBoaWNzW2kgKyAxXSwgbWluSGVpZ2h0LCBuZXh0Qm90dG9tKTsKICAgICAgICAgIGNvbXB1dGVWZXJ0ZXhNaXRlck5vcm1hbCgKICAgICAgICAgICAgcHJldmlvdXNCb3R0b20sCiAgICAgICAgICAgIHZlcnRleEJvdHRvbSwKICAgICAgICAgICAgdmVydGV4VG9wLAogICAgICAgICAgICBuZXh0Qm90dG9tLAogICAgICAgICAgICB2ZXJ0ZXhOb3JtYWwKICAgICAgICAgICk7CiAgICAgICAgICBpbmRleCA9IG5vcm1hbHNBcnJheS5sZW5ndGg7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2ZXJ0ZXhOb3JtYWwsIG5vcm1hbHNBcnJheSwgaW5kZXgpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmVydGV4Qm90dG9tLCBib3R0b21Qb3NpdGlvbnNBcnJheSwgaW5kZXgpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmVydGV4VG9wLCB0b3BQb3NpdGlvbnNBcnJheSwgaW5kZXgpOwogICAgICAgICAgY2FydG9ncmFwaGljc0FycmF5LnB1c2godmVydGV4Q2FydG9ncmFwaGljLmxhdGl0dWRlKTsKICAgICAgICAgIGNhcnRvZ3JhcGhpY3NBcnJheS5wdXNoKHZlcnRleENhcnRvZ3JhcGhpYy5sb25naXR1ZGUpOwogICAgICAgICAgaW50ZXJwb2xhdGVTZWdtZW50KAogICAgICAgICAgICBjYXJ0b2dyYXBoaWNzW2ldLAogICAgICAgICAgICBjYXJ0b2dyYXBoaWNzW2kgKyAxXSwKICAgICAgICAgICAgbWluSGVpZ2h0LAogICAgICAgICAgICBtYXhIZWlnaHQsCiAgICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgICBhcmNUeXBlLAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIG5vcm1hbHNBcnJheSwKICAgICAgICAgICAgYm90dG9tUG9zaXRpb25zQXJyYXksCiAgICAgICAgICAgIHRvcFBvc2l0aW9uc0FycmF5LAogICAgICAgICAgICBjYXJ0b2dyYXBoaWNzQXJyYXkKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVuZENhcnRvZ3JhcGhpYyA9IGNhcnRvZ3JhcGhpY3NbY2FydG9ncmFwaGljc0xlbmd0aCAtIDFdOwogICAgICAgIGNvbnN0IHByZUVuZENhcnRvZ3JhcGhpYyA9IGNhcnRvZ3JhcGhpY3NbY2FydG9ncmFwaGljc0xlbmd0aCAtIDJdOwogICAgICAgIHZlcnRleEJvdHRvbSA9IGdldFBvc2l0aW9uKAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgZW5kQ2FydG9ncmFwaGljLAogICAgICAgICAgbWluSGVpZ2h0LAogICAgICAgICAgdmVydGV4Qm90dG9tCiAgICAgICAgKTsKICAgICAgICB2ZXJ0ZXhUb3AgPSBnZXRQb3NpdGlvbihlbGxpcHNvaWQsIGVuZENhcnRvZ3JhcGhpYywgbWF4SGVpZ2h0LCB2ZXJ0ZXhUb3ApOwogICAgICAgIGlmIChsb29wKSB7CiAgICAgICAgICBjb25zdCBwb3N0RW5kQ2FydG9ncmFwaGljID0gY2FydG9ncmFwaGljc1swXTsKICAgICAgICAgIHByZXZpb3VzQm90dG9tID0gZ2V0UG9zaXRpb24oCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgcHJlRW5kQ2FydG9ncmFwaGljLAogICAgICAgICAgICBtaW5IZWlnaHQsCiAgICAgICAgICAgIHByZXZpb3VzQm90dG9tCiAgICAgICAgICApOwogICAgICAgICAgbmV4dEJvdHRvbSA9IGdldFBvc2l0aW9uKAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIHBvc3RFbmRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICAgIG1pbkhlaWdodCwKICAgICAgICAgICAgbmV4dEJvdHRvbQogICAgICAgICAgKTsKICAgICAgICAgIHZlcnRleE5vcm1hbCA9IGNvbXB1dGVWZXJ0ZXhNaXRlck5vcm1hbCgKICAgICAgICAgICAgcHJldmlvdXNCb3R0b20sCiAgICAgICAgICAgIHZlcnRleEJvdHRvbSwKICAgICAgICAgICAgdmVydGV4VG9wLAogICAgICAgICAgICBuZXh0Qm90dG9tLAogICAgICAgICAgICB2ZXJ0ZXhOb3JtYWwKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZlcnRleE5vcm1hbCA9IGNvbXB1dGVSaWdodE5vcm1hbCgKICAgICAgICAgICAgcHJlRW5kQ2FydG9ncmFwaGljLAogICAgICAgICAgICBlbmRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICAgIG1heEhlaWdodCwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICB2ZXJ0ZXhOb3JtYWwKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGluZGV4ID0gbm9ybWFsc0FycmF5Lmxlbmd0aDsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2ZXJ0ZXhOb3JtYWwsIG5vcm1hbHNBcnJheSwgaW5kZXgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZlcnRleEJvdHRvbSwgYm90dG9tUG9zaXRpb25zQXJyYXksIGluZGV4KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2ZXJ0ZXhUb3AsIHRvcFBvc2l0aW9uc0FycmF5LCBpbmRleCk7CiAgICAgICAgY2FydG9ncmFwaGljc0FycmF5LnB1c2goZW5kQ2FydG9ncmFwaGljLmxhdGl0dWRlKTsKICAgICAgICBjYXJ0b2dyYXBoaWNzQXJyYXkucHVzaChlbmRDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlKTsKICAgICAgICBpZiAobG9vcCkgewogICAgICAgICAgaW50ZXJwb2xhdGVTZWdtZW50KAogICAgICAgICAgICBlbmRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICAgIHN0YXJ0Q2FydG9ncmFwaGljLAogICAgICAgICAgICBtaW5IZWlnaHQsCiAgICAgICAgICAgIG1heEhlaWdodCwKICAgICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICAgIGFyY1R5cGUsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgbm9ybWFsc0FycmF5LAogICAgICAgICAgICBib3R0b21Qb3NpdGlvbnNBcnJheSwKICAgICAgICAgICAgdG9wUG9zaXRpb25zQXJyYXksCiAgICAgICAgICAgIGNhcnRvZ3JhcGhpY3NBcnJheQogICAgICAgICAgKTsKICAgICAgICAgIGluZGV4ID0gbm9ybWFsc0FycmF5Lmxlbmd0aDsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCAzOyArK2kpIHsKICAgICAgICAgICAgbm9ybWFsc0FycmF5W2luZGV4ICsgaV0gPSBub3JtYWxzQXJyYXlbaV07CiAgICAgICAgICAgIGJvdHRvbVBvc2l0aW9uc0FycmF5W2luZGV4ICsgaV0gPSBib3R0b21Qb3NpdGlvbnNBcnJheVtpXTsKICAgICAgICAgICAgdG9wUG9zaXRpb25zQXJyYXlbaW5kZXggKyBpXSA9IHRvcFBvc2l0aW9uc0FycmF5W2ldOwogICAgICAgICAgfQogICAgICAgICAgY2FydG9ncmFwaGljc0FycmF5LnB1c2goc3RhcnRDYXJ0b2dyYXBoaWMubGF0aXR1ZGUpOwogICAgICAgICAgY2FydG9ncmFwaGljc0FycmF5LnB1c2goc3RhcnRDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGdlbmVyYXRlR2VvbWV0cnlBdHRyaWJ1dGVzKAogICAgICAgICAgbG9vcCwKICAgICAgICAgIHByb2plY3Rpb24sCiAgICAgICAgICBib3R0b21Qb3NpdGlvbnNBcnJheSwKICAgICAgICAgIHRvcFBvc2l0aW9uc0FycmF5LAogICAgICAgICAgbm9ybWFsc0FycmF5LAogICAgICAgICAgY2FydG9ncmFwaGljc0FycmF5LAogICAgICAgICAgY29tcHV0ZTJkQXR0cmlidXRlcwogICAgICAgICk7CiAgICAgIH07CiAgICAgIGxpbmVEaXJlY3Rpb25TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBtYXRyaXgzU2NyYXRjaCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgcXVhdGVybmlvblNjcmF0Y2gzID0gbmV3IFF1YXRlcm5pb25fZGVmYXVsdCgpOwogICAgICBlbmRQb3NDYXJ0b2dyYXBoaWNTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIG5vcm1hbFN0YXJ0cG9pbnRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBub3JtYWxFbmRwb2ludFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGFkanVzdEhlaWdodE5vcm1hbFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGFkanVzdEhlaWdodE9mZnNldFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIG51ZGdlRGlyZWN0aW9uU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc3RhcnRDYXJ0b2dyYXBoaWNTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIGVuZENhcnRvZ3JhcGhpY1NjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2VnbWVudFN0YXJ0VG9wU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2VnbWVudEVuZFRvcFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNlZ21lbnRTdGFydEJvdHRvbVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNlZ21lbnRFbmRCb3R0b21TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzZWdtZW50U3RhcnROb3JtYWxTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzZWdtZW50RW5kTm9ybWFsU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZ2V0SGVpZ2h0Q2FydG9ncmFwaGljcyA9IFsKICAgICAgICBzdGFydENhcnRvZ3JhcGhpY1NjcmF0Y2gsCiAgICAgICAgZW5kQ2FydG9ncmFwaGljU2NyYXRjaAogICAgICBdOwogICAgICBnZXRIZWlnaHRSZWN0YW5nbGVTY3JhdGNoID0gbmV3IFJlY3RhbmdsZV9kZWZhdWx0KCk7CiAgICAgIGFkanVzdEhlaWdodFN0YXJ0VG9wU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYWRqdXN0SGVpZ2h0RW5kVG9wU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYWRqdXN0SGVpZ2h0U3RhcnRCb3R0b21TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBhZGp1c3RIZWlnaHRFbmRCb3R0b21TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzZWdtZW50U3RhcnQyRFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNlZ21lbnRFbmQyRFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNlZ21lbnRTdGFydE5vcm1hbDJEU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2VnbWVudEVuZE5vcm1hbDJEU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgb2Zmc2V0U2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHN0YXJ0VXBTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBlbmRVcFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHJpZ2h0U2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHN0YXJ0UGxhbmVOb3JtYWxTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBlbmRQbGFuZU5vcm1hbFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGVuY29kZVNjcmF0Y2ggPSBuZXcgRW5jb2RlZENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBlbmNvZGVTY3JhdGNoMkQgPSBuZXcgRW5jb2RlZENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmb3J3YXJkT2Zmc2V0MkRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICByaWdodDJEU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgbm9ybWFsTnVkZ2VTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQm91bmRpbmdTcGhlcmVzID0gW25ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KCksIG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KCldOwogICAgICBSRUZFUkVOQ0VfSU5ESUNFUyA9IFsKICAgICAgICAwLAogICAgICAgIDIsCiAgICAgICAgMSwKICAgICAgICAwLAogICAgICAgIDMsCiAgICAgICAgMiwKICAgICAgICAvLyByaWdodAogICAgICAgIDAsCiAgICAgICAgNywKICAgICAgICAzLAogICAgICAgIDAsCiAgICAgICAgNCwKICAgICAgICA3LAogICAgICAgIC8vIHN0YXJ0CiAgICAgICAgMCwKICAgICAgICA1LAogICAgICAgIDQsCiAgICAgICAgMCwKICAgICAgICAxLAogICAgICAgIDUsCiAgICAgICAgLy8gYm90dG9tCiAgICAgICAgNSwKICAgICAgICA3LAogICAgICAgIDQsCiAgICAgICAgNSwKICAgICAgICA2LAogICAgICAgIDcsCiAgICAgICAgLy8gbGVmdAogICAgICAgIDUsCiAgICAgICAgMiwKICAgICAgICA2LAogICAgICAgIDUsCiAgICAgICAgMSwKICAgICAgICAyLAogICAgICAgIC8vIGVuZAogICAgICAgIDMsCiAgICAgICAgNiwKICAgICAgICAyLAogICAgICAgIDMsCiAgICAgICAgNywKICAgICAgICA2CiAgICAgICAgLy8gdG9wCiAgICAgIF07CiAgICAgIFJFRkVSRU5DRV9JTkRJQ0VTX0xFTkdUSCA9IFJFRkVSRU5DRV9JTkRJQ0VTLmxlbmd0aDsKICAgICAgR3JvdW5kUG9seWxpbmVHZW9tZXRyeS5fcHJvamVjdE5vcm1hbCA9IHByb2plY3ROb3JtYWw7CiAgICAgIEdyb3VuZFBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IEdyb3VuZFBvbHlsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlR3JvdW5kUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlR3JvdW5kUG9seWxpbmVHZW9tZXRyeShncm91bmRQb2x5bGluZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIHJldHVybiBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzX2RlZmF1bHQuaW5pdGlhbGl6ZSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICAgIGdyb3VuZFBvbHlsaW5lR2VvbWV0cnkgPSBHcm91bmRQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgZ3JvdW5kUG9seWxpbmVHZW9tZXRyeSwKICAgICAgICAgIG9mZnNldAogICAgICAgICk7CiAgICAgIH0KICAgICAgcmV0dXJuIEdyb3VuZFBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShncm91bmRQb2x5bGluZUdlb21ldHJ5KTsKICAgIH0pOwogIH0KICB2YXIgY3JlYXRlR3JvdW5kUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0FwcHJveGltYXRlVGVycmFpbkhlaWdodHMoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfR3JvdW5kUG9seWxpbmVHZW9tZXRyeSgpOwogICAgICBjcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUGxhbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIFBsYW5lR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnZlcnRleEZvcm1hdCwgVmVydGV4Rm9ybWF0X2RlZmF1bHQuREVGQVVMVCk7CiAgICB0aGlzLl92ZXJ0ZXhGb3JtYXQgPSB2ZXJ0ZXhGb3JtYXQ7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZVBsYW5lR2VvbWV0cnkiOwogIH0KICB2YXIgc2NyYXRjaFZlcnRleEZvcm1hdDgsIHNjcmF0Y2hPcHRpb25zMTUsIG1pbiwgbWF4LCBQbGFuZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfUGxhbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUGxhbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1ZlcnRleEZvcm1hdCgpOwogICAgICBQbGFuZUdlb21ldHJ5LnBhY2tlZExlbmd0aCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgUGxhbmVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrKHZhbHVlLl92ZXJ0ZXhGb3JtYXQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ4ID0gbmV3IFZlcnRleEZvcm1hdF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hPcHRpb25zMTUgPSB7CiAgICAgICAgdmVydGV4Rm9ybWF0OiBzY3JhdGNoVmVydGV4Rm9ybWF0OAogICAgICB9OwogICAgICBQbGFuZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0OAogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBQbGFuZUdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zMTUpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCwgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIG1pbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoLTAuNSwgLTAuNSwgMCk7CiAgICAgIG1heCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoMC41LCAwLjUsIDApOwogICAgICBQbGFuZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24ocGxhbmVHZW9tZXRyeSkgewogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IHBsYW5lR2VvbWV0cnkuX3ZlcnRleEZvcm1hdDsKICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICAgICAgbGV0IGluZGljZXM7CiAgICAgICAgbGV0IHBvc2l0aW9uczsKICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnBvc2l0aW9uKSB7CiAgICAgICAgICBwb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KDQgKiAzKTsKICAgICAgICAgIHBvc2l0aW9uc1swXSA9IG1pbi54OwogICAgICAgICAgcG9zaXRpb25zWzFdID0gbWluLnk7CiAgICAgICAgICBwb3NpdGlvbnNbMl0gPSAwOwogICAgICAgICAgcG9zaXRpb25zWzNdID0gbWF4Lng7CiAgICAgICAgICBwb3NpdGlvbnNbNF0gPSBtaW4ueTsKICAgICAgICAgIHBvc2l0aW9uc1s1XSA9IDA7CiAgICAgICAgICBwb3NpdGlvbnNbNl0gPSBtYXgueDsKICAgICAgICAgIHBvc2l0aW9uc1s3XSA9IG1heC55OwogICAgICAgICAgcG9zaXRpb25zWzhdID0gMDsKICAgICAgICAgIHBvc2l0aW9uc1s5XSA9IG1pbi54OwogICAgICAgICAgcG9zaXRpb25zWzEwXSA9IG1heC55OwogICAgICAgICAgcG9zaXRpb25zWzExXSA9IDA7CiAgICAgICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogcG9zaXRpb25zCiAgICAgICAgICB9KTsKICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICAgIGNvbnN0IG5vcm1hbHMgPSBuZXcgRmxvYXQzMkFycmF5KDQgKiAzKTsKICAgICAgICAgICAgbm9ybWFsc1swXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMV0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzJdID0gMTsKICAgICAgICAgICAgbm9ybWFsc1szXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzVdID0gMTsKICAgICAgICAgICAgbm9ybWFsc1s2XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbN10gPSAwOwogICAgICAgICAgICBub3JtYWxzWzhdID0gMTsKICAgICAgICAgICAgbm9ybWFsc1s5XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMTBdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1sxMV0gPSAxOwogICAgICAgICAgICBhdHRyaWJ1dGVzLm5vcm1hbCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICAgIHZhbHVlczogbm9ybWFscwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgICAgY29uc3QgdGV4Q29vcmRzID0gbmV3IEZsb2F0MzJBcnJheSg0ICogMik7CiAgICAgICAgICAgIHRleENvb3Jkc1swXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1sxXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1syXSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1szXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1s0XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1s1XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1s2XSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1s3XSA9IDE7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICAgICAgICB2YWx1ZXM6IHRleENvb3JkcwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgICBjb25zdCB0YW5nZW50cyA9IG5ldyBGbG9hdDMyQXJyYXkoNCAqIDMpOwogICAgICAgICAgICB0YW5nZW50c1swXSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzFdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbMl0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1szXSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzRdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNV0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s2XSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzddID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbOF0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s5XSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzEwXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzExXSA9IDA7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMudGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICAgIHZhbHVlczogdGFuZ2VudHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgICBjb25zdCBiaXRhbmdlbnRzID0gbmV3IEZsb2F0MzJBcnJheSg0ICogMyk7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzFdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1syXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbM10gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzRdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s1XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNl0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzddID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1s4XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbOV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzEwXSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMTFdID0gMDsKICAgICAgICAgICAgYXR0cmlidXRlcy5iaXRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IGJpdGFuZ2VudHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpbmRpY2VzID0gbmV3IFVpbnQxNkFycmF5KDIgKiAzKTsKICAgICAgICAgIGluZGljZXNbMF0gPSAwOwogICAgICAgICAgaW5kaWNlc1sxXSA9IDE7CiAgICAgICAgICBpbmRpY2VzWzJdID0gMjsKICAgICAgICAgIGluZGljZXNbM10gPSAwOwogICAgICAgICAgaW5kaWNlc1s0XSA9IDI7CiAgICAgICAgICBpbmRpY2VzWzVdID0gMzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdChDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgTWF0aC5zcXJ0KDIpKQogICAgICAgIH0pOwogICAgICB9OwogICAgICBQbGFuZUdlb21ldHJ5X2RlZmF1bHQgPSBQbGFuZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUGxhbmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVQbGFuZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVQbGFuZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVBsYW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVBsYW5lR2VvbWV0cnkocGxhbmVHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgcGxhbmVHZW9tZXRyeSA9IFBsYW5lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2socGxhbmVHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHJldHVybiBQbGFuZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkocGxhbmVHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVQbGFuZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlUGxhbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUGxhbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X1BsYW5lR2VvbWV0cnkoKTsKICAgICAgY3JlYXRlUGxhbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlUGxhbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BsYW5lT3V0bGluZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gUGxhbmVPdXRsaW5lR2VvbWV0cnkoKSB7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZVBsYW5lT3V0bGluZUdlb21ldHJ5IjsKICB9CiAgdmFyIG1pbjIsIG1heDIsIFBsYW5lT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfUGxhbmVPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BsYW5lT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIFBsYW5lT3V0bGluZUdlb21ldHJ5LnBhY2tlZExlbmd0aCA9IDA7CiAgICAgIFBsYW5lT3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXkpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBQbGFuZU91dGxpbmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFBsYW5lT3V0bGluZUdlb21ldHJ5KCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIG1pbjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KC0wLjUsIC0wLjUsIDApOwogICAgICBtYXgyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgwLjUsIDAuNSwgMCk7CiAgICAgIFBsYW5lT3V0bGluZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpOwogICAgICAgIGNvbnN0IGluZGljZXMgPSBuZXcgVWludDE2QXJyYXkoNCAqIDIpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoNCAqIDMpOwogICAgICAgIHBvc2l0aW9uc1swXSA9IG1pbjIueDsKICAgICAgICBwb3NpdGlvbnNbMV0gPSBtaW4yLnk7CiAgICAgICAgcG9zaXRpb25zWzJdID0gbWluMi56OwogICAgICAgIHBvc2l0aW9uc1szXSA9IG1heDIueDsKICAgICAgICBwb3NpdGlvbnNbNF0gPSBtaW4yLnk7CiAgICAgICAgcG9zaXRpb25zWzVdID0gbWluMi56OwogICAgICAgIHBvc2l0aW9uc1s2XSA9IG1heDIueDsKICAgICAgICBwb3NpdGlvbnNbN10gPSBtYXgyLnk7CiAgICAgICAgcG9zaXRpb25zWzhdID0gbWluMi56OwogICAgICAgIHBvc2l0aW9uc1s5XSA9IG1pbjIueDsKICAgICAgICBwb3NpdGlvbnNbMTBdID0gbWF4Mi55OwogICAgICAgIHBvc2l0aW9uc1sxMV0gPSBtaW4yLno7CiAgICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICB2YWx1ZXM6IHBvc2l0aW9ucwogICAgICAgIH0pOwogICAgICAgIGluZGljZXNbMF0gPSAwOwogICAgICAgIGluZGljZXNbMV0gPSAxOwogICAgICAgIGluZGljZXNbMl0gPSAxOwogICAgICAgIGluZGljZXNbM10gPSAyOwogICAgICAgIGluZGljZXNbNF0gPSAyOwogICAgICAgIGluZGljZXNbNV0gPSAzOwogICAgICAgIGluZGljZXNbNl0gPSAzOwogICAgICAgIGluZGljZXNbN10gPSAwOwogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdChDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgTWF0aC5zcXJ0KDIpKQogICAgICAgIH0pOwogICAgICB9OwogICAgICBQbGFuZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gUGxhbmVPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVBsYW5lT3V0bGluZUdlb21ldHJ5KHBsYW5lR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIHBsYW5lR2VvbWV0cnkgPSBQbGFuZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhwbGFuZUdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgcmV0dXJuIFBsYW5lT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkocGxhbmVHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVBsYW5lT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X1BsYW5lT3V0bGluZUdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZVBsYW5lT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1N0ZXJlb2dyYXBoaWMuanMKICBmdW5jdGlvbiBTdGVyZW9ncmFwaGljKHBvc2l0aW9uLCB0YW5nZW50UGxhbmUpIHsKICAgIHRoaXMucG9zaXRpb24gPSBwb3NpdGlvbjsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHRoaXMucG9zaXRpb24pKSB7CiAgICAgIHRoaXMucG9zaXRpb24gPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICB9CiAgICB0aGlzLnRhbmdlbnRQbGFuZSA9IHRhbmdlbnRQbGFuZTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHRoaXMudGFuZ2VudFBsYW5lKSkgewogICAgICB0aGlzLnRhbmdlbnRQbGFuZSA9IFN0ZXJlb2dyYXBoaWMuTk9SVEhfUE9MRV9UQU5HRU5UX1BMQU5FOwogICAgfQogIH0KICB2YXIgc2NyYXRjaENhcnRvZ3JhcGhpYzUsIHNjcmF0Y2hDYXJ0ZXNpYW4xMCwgc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZVJheTIsIHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVSYXlEaXJlY3Rpb24sIHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVDYXJ0ZXNpYW4zMiwgU3RlcmVvZ3JhcGhpY19kZWZhdWx0OwogIHZhciBpbml0X1N0ZXJlb2dyYXBoaWMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1N0ZXJlb2dyYXBoaWMuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkVGFuZ2VudFBsYW5lKCk7CiAgICAgIGluaXRfSW50ZXJzZWN0aW9uVGVzdHMoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUmF5KCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFN0ZXJlb2dyYXBoaWMucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgZWxsaXBzb2lkLgogICAgICAgICAqIEBtZW1iZXJvZiBTdGVyZW9ncmFwaGljLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtFbGxpcHNvaWR9CiAgICAgICAgICovCiAgICAgICAgZWxsaXBzb2lkOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy50YW5nZW50UGxhbmUuZWxsaXBzb2lkOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgeCBjb29yZGluYXRlCiAgICAgICAgICogQG1lbWJlcm9mIFN0ZXJlb2dyYXBoaWMucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKi8KICAgICAgICB4OiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wb3NpdGlvbi54OwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgeSBjb29yZGluYXRlCiAgICAgICAgICogQG1lbWJlcm9mIFN0ZXJlb2dyYXBoaWMucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKi8KICAgICAgICB5OiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wb3NpdGlvbi55OwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogQ29tcHV0ZXMgdGhlIGNvbmZvcm1hbCBsYXRpdHVkZSwgb3IgdGhlIGVsbGlwc29pZGFsIGxhdGl0dWRlIHByb2plY3RlZCBvbnRvIGFuIGFyYml0cmFyeSBzcGhlcmUuCiAgICAgICAgICogQG1lbWJlcm9mIFN0ZXJlb2dyYXBoaWMucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKi8KICAgICAgICBjb25mb3JtYWxMYXRpdHVkZTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgY29uc3QgciA9IENhcnRlc2lhbjJfZGVmYXVsdC5tYWduaXR1ZGUodGhpcy5wb3NpdGlvbik7CiAgICAgICAgICAgIGNvbnN0IGQgPSAyICogdGhpcy5lbGxpcHNvaWQubWF4aW11bVJhZGl1czsKICAgICAgICAgICAgY29uc3Qgc2lnbjIgPSB0aGlzLnRhbmdlbnRQbGFuZS5wbGFuZS5ub3JtYWwuejsKICAgICAgICAgICAgcmV0dXJuIHNpZ24yICogKE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAtIDIgKiBNYXRoLmF0YW4yKHIsIGQpKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIENvbXB1dGVzIHRoZSBsb25naXR1ZGUKICAgICAgICAgKiBAbWVtYmVyb2YgU3RlcmVvZ3JhcGhpYy5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGxvbmdpdHVkZTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgbGV0IGxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyArIE1hdGguYXRhbjIodGhpcy55LCB0aGlzLngpOwogICAgICAgICAgICBpZiAobG9uZ2l0dWRlID4gTWF0aC5QSSkgewogICAgICAgICAgICAgIGxvbmdpdHVkZSAtPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsb25naXR1ZGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzUgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjEwID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBTdGVyZW9ncmFwaGljLnByb3RvdHlwZS5nZXRMYXRpdHVkZSA9IGZ1bmN0aW9uKGVsbGlwc29pZCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGVsbGlwc29pZCkpIHsKICAgICAgICAgIGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LldHUzg0OwogICAgICAgIH0KICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNS5sYXRpdHVkZSA9IHRoaXMuY29uZm9ybWFsTGF0aXR1ZGU7CiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzUubG9uZ2l0dWRlID0gdGhpcy5sb25naXR1ZGU7CiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzUuaGVpZ2h0ID0gMDsKICAgICAgICBjb25zdCBjYXJ0ZXNpYW4xMSA9IHRoaXMuZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzUsCiAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuMTAKICAgICAgICApOwogICAgICAgIGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhjYXJ0ZXNpYW4xMSwgc2NyYXRjaENhcnRvZ3JhcGhpYzUpOwogICAgICAgIHJldHVybiBzY3JhdGNoQ2FydG9ncmFwaGljNS5sYXRpdHVkZTsKICAgICAgfTsKICAgICAgc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZVJheTIgPSBuZXcgUmF5X2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZVJheURpcmVjdGlvbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZUNhcnRlc2lhbjMyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBTdGVyZW9ncmFwaGljLmZyb21DYXJ0ZXNpYW4gPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgY29uc3Qgc2lnbjIgPSBNYXRoX2RlZmF1bHQuc2lnbk5vdFplcm8oY2FydGVzaWFuMTEueik7CiAgICAgICAgbGV0IHRhbmdlbnRQbGFuZSA9IFN0ZXJlb2dyYXBoaWMuTk9SVEhfUE9MRV9UQU5HRU5UX1BMQU5FOwogICAgICAgIGxldCBvcmlnaW4gPSBTdGVyZW9ncmFwaGljLlNPVVRIX1BPTEU7CiAgICAgICAgaWYgKHNpZ24yIDwgMCkgewogICAgICAgICAgdGFuZ2VudFBsYW5lID0gU3RlcmVvZ3JhcGhpYy5TT1VUSF9QT0xFX1RBTkdFTlRfUExBTkU7CiAgICAgICAgICBvcmlnaW4gPSBTdGVyZW9ncmFwaGljLk5PUlRIX1BPTEU7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJheSA9IHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVSYXkyOwogICAgICAgIHJheS5vcmlnaW4gPSB0YW5nZW50UGxhbmUuZWxsaXBzb2lkLnNjYWxlVG9HZW9jZW50cmljU3VyZmFjZSgKICAgICAgICAgIGNhcnRlc2lhbjExLAogICAgICAgICAgcmF5Lm9yaWdpbgogICAgICAgICk7CiAgICAgICAgcmF5LmRpcmVjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgIHJheS5vcmlnaW4sCiAgICAgICAgICBvcmlnaW4sCiAgICAgICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lUmF5RGlyZWN0aW9uCiAgICAgICAgKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHJheS5kaXJlY3Rpb24sIHJheS5kaXJlY3Rpb24pOwogICAgICAgIGNvbnN0IGludGVyc2VjdGlvblBvaW50ID0gSW50ZXJzZWN0aW9uVGVzdHNfZGVmYXVsdC5yYXlQbGFuZSgKICAgICAgICAgIHJheSwKICAgICAgICAgIHRhbmdlbnRQbGFuZS5wbGFuZSwKICAgICAgICAgIHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVDYXJ0ZXNpYW4zMgogICAgICAgICk7CiAgICAgICAgY29uc3QgdjMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoaW50ZXJzZWN0aW9uUG9pbnQsIG9yaWdpbiwgaW50ZXJzZWN0aW9uUG9pbnQpOwogICAgICAgIGNvbnN0IHggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHRhbmdlbnRQbGFuZS54QXhpcywgdjMpOwogICAgICAgIGNvbnN0IHkgPSBzaWduMiAqIENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodGFuZ2VudFBsYW5lLnlBeGlzLCB2Myk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBTdGVyZW9ncmFwaGljKG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoeCwgeSksIHRhbmdlbnRQbGFuZSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5wb3NpdGlvbiA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoeCwgeSk7CiAgICAgICAgcmVzdWx0LnRhbmdlbnRQbGFuZSA9IHRhbmdlbnRQbGFuZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBTdGVyZW9ncmFwaGljLmZyb21DYXJ0ZXNpYW5BcnJheSA9IGZ1bmN0aW9uKGNhcnRlc2lhbnMsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2FydGVzaWFucyIsIGNhcnRlc2lhbnMpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNhcnRlc2lhbnMubGVuZ3RoOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICByZXN1bHRbaV0gPSBTdGVyZW9ncmFwaGljLmZyb21DYXJ0ZXNpYW4oY2FydGVzaWFuc1tpXSwgcmVzdWx0W2ldKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgU3RlcmVvZ3JhcGhpYy5jbG9uZSA9IGZ1bmN0aW9uKHN0ZXJlb2dyYXBoaWMsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHN0ZXJlb2dyYXBoaWMpKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFN0ZXJlb2dyYXBoaWMoCiAgICAgICAgICAgIHN0ZXJlb2dyYXBoaWMucG9zaXRpb24sCiAgICAgICAgICAgIHN0ZXJlb2dyYXBoaWMudGFuZ2VudFBsYW5lCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHQucG9zaXRpb24gPSBzdGVyZW9ncmFwaGljLnBvc2l0aW9uOwogICAgICAgIHJlc3VsdC50YW5nZW50UGxhbmUgPSBzdGVyZW9ncmFwaGljLnRhbmdlbnRQbGFuZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBTdGVyZW9ncmFwaGljLkhBTEZfVU5JVF9TUEhFUkUgPSBPYmplY3QuZnJlZXplKG5ldyBFbGxpcHNvaWRfZGVmYXVsdCgwLjUsIDAuNSwgMC41KSk7CiAgICAgIFN0ZXJlb2dyYXBoaWMuTk9SVEhfUE9MRSA9IE9iamVjdC5mcmVlemUobmV3IENhcnRlc2lhbjNfZGVmYXVsdCgwLCAwLCAwLjUpKTsKICAgICAgU3RlcmVvZ3JhcGhpYy5TT1VUSF9QT0xFID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydGVzaWFuM19kZWZhdWx0KDAsIDAsIC0wLjUpKTsKICAgICAgU3RlcmVvZ3JhcGhpYy5OT1JUSF9QT0xFX1RBTkdFTlRfUExBTkUgPSBPYmplY3QuZnJlZXplKAogICAgICAgIG5ldyBFbGxpcHNvaWRUYW5nZW50UGxhbmVfZGVmYXVsdCgKICAgICAgICAgIFN0ZXJlb2dyYXBoaWMuTk9SVEhfUE9MRSwKICAgICAgICAgIFN0ZXJlb2dyYXBoaWMuSEFMRl9VTklUX1NQSEVSRQogICAgICAgICkKICAgICAgKTsKICAgICAgU3RlcmVvZ3JhcGhpYy5TT1VUSF9QT0xFX1RBTkdFTlRfUExBTkUgPSBPYmplY3QuZnJlZXplKAogICAgICAgIG5ldyBFbGxpcHNvaWRUYW5nZW50UGxhbmVfZGVmYXVsdCgKICAgICAgICAgIFN0ZXJlb2dyYXBoaWMuU09VVEhfUE9MRSwKICAgICAgICAgIFN0ZXJlb2dyYXBoaWMuSEFMRl9VTklUX1NQSEVSRQogICAgICAgICkKICAgICAgKTsKICAgICAgU3RlcmVvZ3JhcGhpY19kZWZhdWx0ID0gU3RlcmVvZ3JhcGhpYzsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlnb25HZW9tZXRyeS5qcwogIGZ1bmN0aW9uIGFkanVzdFBvc0hlaWdodHNGb3JOb3JtYWwocG9zaXRpb24sIHAxLCBwMiwgZWxsaXBzb2lkKSB7CiAgICBjb25zdCBjYXJ0bzEyID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHBvc2l0aW9uLCBzY3JhdGNoQ2FydG8xKTsKICAgIGNvbnN0IGhlaWdodCA9IGNhcnRvMTIuaGVpZ2h0OwogICAgY29uc3QgcDFDYXJ0byA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhwMSwgc2NyYXRjaENhcnRvMik7CiAgICBwMUNhcnRvLmhlaWdodCA9IGhlaWdodDsKICAgIGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihwMUNhcnRvLCBwMSk7CiAgICBjb25zdCBwMkNhcnRvID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHAyLCBzY3JhdGNoQ2FydG8yKTsKICAgIHAyQ2FydG8uaGVpZ2h0ID0gaGVpZ2h0IC0gMTAwOwogICAgZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKHAyQ2FydG8sIHAyKTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZUF0dHJpYnV0ZXMob3B0aW9ucykgewogICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gb3B0aW9ucy52ZXJ0ZXhGb3JtYXQ7CiAgICBjb25zdCBnZW9tZXRyeSA9IG9wdGlvbnMuZ2VvbWV0cnk7CiAgICBjb25zdCBzaGFkb3dWb2x1bWUgPSBvcHRpb25zLnNoYWRvd1ZvbHVtZTsKICAgIGNvbnN0IGZsYXRQb3NpdGlvbnMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgIGNvbnN0IGZsYXRUZXhjb29yZHMgPSBkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkuYXR0cmlidXRlcy5zdCkgPyBnZW9tZXRyeS5hdHRyaWJ1dGVzLnN0LnZhbHVlcyA6IHZvaWQgMDsKICAgIGxldCBsZW5ndGggPSBmbGF0UG9zaXRpb25zLmxlbmd0aDsKICAgIGNvbnN0IHdhbGwgPSBvcHRpb25zLndhbGw7CiAgICBjb25zdCB0b3AgPSBvcHRpb25zLnRvcCB8fCB3YWxsOwogICAgY29uc3QgYm90dG9tID0gb3B0aW9ucy5ib3R0b20gfHwgd2FsbDsKICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QgfHwgdmVydGV4Rm9ybWF0Lm5vcm1hbCB8fCB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50IHx8IHNoYWRvd1ZvbHVtZSkgewogICAgICBjb25zdCBib3VuZGluZ1JlY3RhbmdsZSA9IG9wdGlvbnMuYm91bmRpbmdSZWN0YW5nbGU7CiAgICAgIGNvbnN0IHJvdGF0aW9uQXhpcyA9IG9wdGlvbnMucm90YXRpb25BeGlzOwogICAgICBjb25zdCBwcm9qZWN0VG8yZCA9IG9wdGlvbnMucHJvamVjdFRvMmQ7CiAgICAgIGNvbnN0IGVsbGlwc29pZCA9IG9wdGlvbnMuZWxsaXBzb2lkOwogICAgICBjb25zdCBzdFJvdGF0aW9uID0gb3B0aW9ucy5zdFJvdGF0aW9uOwogICAgICBjb25zdCBwZXJQb3NpdGlvbkhlaWdodCA9IG9wdGlvbnMucGVyUG9zaXRpb25IZWlnaHQ7CiAgICAgIGNvbnN0IG9yaWdpbiA9IGFwcGVuZFRleHR1cmVDb29yZGluYXRlc09yaWdpbjsKICAgICAgb3JpZ2luLnggPSBib3VuZGluZ1JlY3RhbmdsZS54OwogICAgICBvcmlnaW4ueSA9IGJvdW5kaW5nUmVjdGFuZ2xlLnk7CiAgICAgIGNvbnN0IHRleHR1cmVDb29yZGluYXRlcyA9IHZlcnRleEZvcm1hdC5zdCA/IG5ldyBGbG9hdDMyQXJyYXkoMiAqIChsZW5ndGggLyAzKSkgOiB2b2lkIDA7CiAgICAgIGxldCBub3JtYWxzOwogICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgIGlmIChwZXJQb3NpdGlvbkhlaWdodCAmJiB0b3AgJiYgIXdhbGwpIHsKICAgICAgICAgIG5vcm1hbHMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLm5vcm1hbC52YWx1ZXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG5vcm1hbHMgPSBuZXcgRmxvYXQzMkFycmF5KGxlbmd0aCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IHRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LnRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICAgIGNvbnN0IGJpdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShsZW5ndGgpIDogdm9pZCAwOwogICAgICBjb25zdCBleHRydWRlTm9ybWFscyA9IHNoYWRvd1ZvbHVtZSA/IG5ldyBGbG9hdDMyQXJyYXkobGVuZ3RoKSA6IHZvaWQgMDsKICAgICAgbGV0IHRleHR1cmVDb29yZEluZGV4ID0gMDsKICAgICAgbGV0IGF0dHJJbmRleCA9IDA7CiAgICAgIGxldCBub3JtYWwyID0gc2NyYXRjaE5vcm1hbDY7CiAgICAgIGxldCB0YW5nZW50ID0gc2NyYXRjaFRhbmdlbnQ0OwogICAgICBsZXQgYml0YW5nZW50ID0gc2NyYXRjaEJpdGFuZ2VudDQ7CiAgICAgIGxldCByZWNvbXB1dGVOb3JtYWwgPSB0cnVlOwogICAgICBsZXQgdGV4dHVyZU1hdHJpeCA9IGFwcGVuZFRleHR1cmVDb29yZGluYXRlc01hdHJpeDM7CiAgICAgIGxldCB0YW5nZW50Um90YXRpb25NYXRyaXggPSB0YW5nZW50TWF0cml4U2NyYXRjaDI7CiAgICAgIGlmIChzdFJvdGF0aW9uICE9PSAwKSB7CiAgICAgICAgbGV0IHJvdGF0aW9uID0gUXVhdGVybmlvbl9kZWZhdWx0LmZyb21BeGlzQW5nbGUoCiAgICAgICAgICByb3RhdGlvbkF4aXMsCiAgICAgICAgICBzdFJvdGF0aW9uLAogICAgICAgICAgYXBwZW5kVGV4dHVyZUNvb3JkaW5hdGVzUXVhdGVybmlvbgogICAgICAgICk7CiAgICAgICAgdGV4dHVyZU1hdHJpeCA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tUXVhdGVybmlvbihyb3RhdGlvbiwgdGV4dHVyZU1hdHJpeCk7CiAgICAgICAgcm90YXRpb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbUF4aXNBbmdsZSgKICAgICAgICAgIHJvdGF0aW9uQXhpcywKICAgICAgICAgIC1zdFJvdGF0aW9uLAogICAgICAgICAgYXBwZW5kVGV4dHVyZUNvb3JkaW5hdGVzUXVhdGVybmlvbgogICAgICAgICk7CiAgICAgICAgdGFuZ2VudFJvdGF0aW9uTWF0cml4ID0gTWF0cml4M19kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKAogICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICB0YW5nZW50Um90YXRpb25NYXRyaXgKICAgICAgICApOwogICAgICB9IGVsc2UgewogICAgICAgIHRleHR1cmVNYXRyaXggPSBNYXRyaXgzX2RlZmF1bHQuY2xvbmUoTWF0cml4M19kZWZhdWx0LklERU5USVRZLCB0ZXh0dXJlTWF0cml4KTsKICAgICAgICB0YW5nZW50Um90YXRpb25NYXRyaXggPSBNYXRyaXgzX2RlZmF1bHQuY2xvbmUoCiAgICAgICAgICBNYXRyaXgzX2RlZmF1bHQuSURFTlRJVFksCiAgICAgICAgICB0YW5nZW50Um90YXRpb25NYXRyaXgKICAgICAgICApOwogICAgICB9CiAgICAgIGxldCBib3R0b21PZmZzZXQgPSAwOwogICAgICBsZXQgYm90dG9tT2Zmc2V0MiA9IDA7CiAgICAgIGlmICh0b3AgJiYgYm90dG9tKSB7CiAgICAgICAgYm90dG9tT2Zmc2V0ID0gbGVuZ3RoIC8gMjsKICAgICAgICBib3R0b21PZmZzZXQyID0gbGVuZ3RoIC8gMzsKICAgICAgICBsZW5ndGggLz0gMjsKICAgICAgfQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAzKSB7CiAgICAgICAgY29uc3QgcG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgZmxhdFBvc2l0aW9ucywKICAgICAgICAgIGksCiAgICAgICAgICBhcHBlbmRUZXh0dXJlQ29vcmRpbmF0ZXNDYXJ0ZXNpYW4zCiAgICAgICAgKTsKICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChmbGF0VGV4Y29vcmRzKSkgewogICAgICAgICAgICBsZXQgcCA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKAogICAgICAgICAgICAgIHRleHR1cmVNYXRyaXgsCiAgICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgICAgc2NyYXRjaFBvc2l0aW9uMwogICAgICAgICAgICApOwogICAgICAgICAgICBwID0gZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UocCwgcCk7CiAgICAgICAgICAgIGNvbnN0IHN0ID0gcHJvamVjdFRvMmQocCwgYXBwZW5kVGV4dHVyZUNvb3JkaW5hdGVzQ2FydGVzaWFuMik7CiAgICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5zdWJ0cmFjdChzdCwgb3JpZ2luLCBzdCk7CiAgICAgICAgICAgIGNvbnN0IHN0eCA9IE1hdGhfZGVmYXVsdC5jbGFtcChzdC54IC8gYm91bmRpbmdSZWN0YW5nbGUud2lkdGgsIDAsIDEpOwogICAgICAgICAgICBjb25zdCBzdHkgPSBNYXRoX2RlZmF1bHQuY2xhbXAoc3QueSAvIGJvdW5kaW5nUmVjdGFuZ2xlLmhlaWdodCwgMCwgMSk7CiAgICAgICAgICAgIGlmIChib3R0b20pIHsKICAgICAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbdGV4dHVyZUNvb3JkSW5kZXggKyBib3R0b21PZmZzZXQyXSA9IHN0eDsKICAgICAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbdGV4dHVyZUNvb3JkSW5kZXggKyAxICsgYm90dG9tT2Zmc2V0Ml0gPSBzdHk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRvcCkgewogICAgICAgICAgICAgIHRleHR1cmVDb29yZGluYXRlc1t0ZXh0dXJlQ29vcmRJbmRleF0gPSBzdHg7CiAgICAgICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3RleHR1cmVDb29yZEluZGV4ICsgMV0gPSBzdHk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGV4dHVyZUNvb3JkSW5kZXggKz0gMjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwgfHwgdmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCB8fCBzaGFkb3dWb2x1bWUpIHsKICAgICAgICAgIGNvbnN0IGF0dHJJbmRleDEgPSBhdHRySW5kZXggKyAxOwogICAgICAgICAgY29uc3QgYXR0ckluZGV4MiA9IGF0dHJJbmRleCArIDI7CiAgICAgICAgICBpZiAod2FsbCkgewogICAgICAgICAgICBpZiAoaSArIDMgPCBsZW5ndGgpIHsKICAgICAgICAgICAgICBjb25zdCBwMSA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoZmxhdFBvc2l0aW9ucywgaSArIDMsIHAxU2NyYXRjaDMpOwogICAgICAgICAgICAgIGlmIChyZWNvbXB1dGVOb3JtYWwpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgICAgICAgZmxhdFBvc2l0aW9ucywKICAgICAgICAgICAgICAgICAgaSArIGxlbmd0aCwKICAgICAgICAgICAgICAgICAgcDJTY3JhdGNoMwogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGlmIChwZXJQb3NpdGlvbkhlaWdodCkgewogICAgICAgICAgICAgICAgICBhZGp1c3RQb3NIZWlnaHRzRm9yTm9ybWFsKHBvc2l0aW9uLCBwMSwgcDIsIGVsbGlwc29pZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocDEsIHBvc2l0aW9uLCBwMSk7CiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocDIsIHBvc2l0aW9uLCBwMik7CiAgICAgICAgICAgICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHAyLCBwMSwgbm9ybWFsMiksCiAgICAgICAgICAgICAgICAgIG5vcm1hbDIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICByZWNvbXB1dGVOb3JtYWwgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKHAxLCBwb3NpdGlvbiwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMCkpIHsKICAgICAgICAgICAgICAgIHJlY29tcHV0ZU5vcm1hbCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgICAgYml0YW5nZW50ID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbiwgYml0YW5nZW50KTsKICAgICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICAgICAgICAgIHRhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoYml0YW5nZW50LCBub3JtYWwyLCB0YW5nZW50KSwKICAgICAgICAgICAgICAgICAgdGFuZ2VudAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5vcm1hbDIgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHBvc2l0aW9uLCBub3JtYWwyKTsKICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgICBpZiAocGVyUG9zaXRpb25IZWlnaHQpIHsKICAgICAgICAgICAgICAgIHNjcmF0Y2hQZXJQb3NOb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICAgICAgICBub3JtYWxzLAogICAgICAgICAgICAgICAgICBhdHRySW5kZXgsCiAgICAgICAgICAgICAgICAgIHNjcmF0Y2hQZXJQb3NOb3JtYWwKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBzY3JhdGNoUGVyUG9zVGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcygKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWiwKICAgICAgICAgICAgICAgICAgc2NyYXRjaFBlclBvc05vcm1hbCwKICAgICAgICAgICAgICAgICAgc2NyYXRjaFBlclBvc1RhbmdlbnQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBzY3JhdGNoUGVyUG9zVGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgICAgIE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKAogICAgICAgICAgICAgICAgICAgIHRhbmdlbnRSb3RhdGlvbk1hdHJpeCwKICAgICAgICAgICAgICAgICAgICBzY3JhdGNoUGVyUG9zVGFuZ2VudCwKICAgICAgICAgICAgICAgICAgICBzY3JhdGNoUGVyUG9zVGFuZ2VudAogICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICBzY3JhdGNoUGVyUG9zVGFuZ2VudAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgICAgICAgIHNjcmF0Y2hQZXJQb3NCaXRhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcygKICAgICAgICAgICAgICAgICAgICAgIHNjcmF0Y2hQZXJQb3NOb3JtYWwsCiAgICAgICAgICAgICAgICAgICAgICBzY3JhdGNoUGVyUG9zVGFuZ2VudCwKICAgICAgICAgICAgICAgICAgICAgIHNjcmF0Y2hQZXJQb3NCaXRhbmdlbnQKICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgIHNjcmF0Y2hQZXJQb3NCaXRhbmdlbnQKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9aLCBub3JtYWwyLCB0YW5nZW50KTsKICAgICAgICAgICAgICB0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICAgIE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKHRhbmdlbnRSb3RhdGlvbk1hdHJpeCwgdGFuZ2VudCwgdGFuZ2VudCksCiAgICAgICAgICAgICAgICB0YW5nZW50CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgICAgICAgYml0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKG5vcm1hbDIsIHRhbmdlbnQsIGJpdGFuZ2VudCksCiAgICAgICAgICAgICAgICAgIGJpdGFuZ2VudAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICAgIGlmIChvcHRpb25zLndhbGwpIHsKICAgICAgICAgICAgICBub3JtYWxzW2F0dHJJbmRleCArIGJvdHRvbU9mZnNldF0gPSBub3JtYWwyLng7CiAgICAgICAgICAgICAgbm9ybWFsc1thdHRySW5kZXgxICsgYm90dG9tT2Zmc2V0XSA9IG5vcm1hbDIueTsKICAgICAgICAgICAgICBub3JtYWxzW2F0dHJJbmRleDIgKyBib3R0b21PZmZzZXRdID0gbm9ybWFsMi56OwogICAgICAgICAgICB9IGVsc2UgaWYgKGJvdHRvbSkgewogICAgICAgICAgICAgIG5vcm1hbHNbYXR0ckluZGV4ICsgYm90dG9tT2Zmc2V0XSA9IC1ub3JtYWwyLng7CiAgICAgICAgICAgICAgbm9ybWFsc1thdHRySW5kZXgxICsgYm90dG9tT2Zmc2V0XSA9IC1ub3JtYWwyLnk7CiAgICAgICAgICAgICAgbm9ybWFsc1thdHRySW5kZXgyICsgYm90dG9tT2Zmc2V0XSA9IC1ub3JtYWwyLno7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRvcCAmJiAhcGVyUG9zaXRpb25IZWlnaHQgfHwgd2FsbCkgewogICAgICAgICAgICAgIG5vcm1hbHNbYXR0ckluZGV4XSA9IG5vcm1hbDIueDsKICAgICAgICAgICAgICBub3JtYWxzW2F0dHJJbmRleDFdID0gbm9ybWFsMi55OwogICAgICAgICAgICAgIG5vcm1hbHNbYXR0ckluZGV4Ml0gPSBub3JtYWwyLno7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgICAgICAgaWYgKHdhbGwpIHsKICAgICAgICAgICAgICBub3JtYWwyID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbiwgbm9ybWFsMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZXh0cnVkZU5vcm1hbHNbYXR0ckluZGV4ICsgYm90dG9tT2Zmc2V0XSA9IC1ub3JtYWwyLng7CiAgICAgICAgICAgIGV4dHJ1ZGVOb3JtYWxzW2F0dHJJbmRleDEgKyBib3R0b21PZmZzZXRdID0gLW5vcm1hbDIueTsKICAgICAgICAgICAgZXh0cnVkZU5vcm1hbHNbYXR0ckluZGV4MiArIGJvdHRvbU9mZnNldF0gPSAtbm9ybWFsMi56OwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICAgIGlmIChvcHRpb25zLndhbGwpIHsKICAgICAgICAgICAgICB0YW5nZW50c1thdHRySW5kZXggKyBib3R0b21PZmZzZXRdID0gdGFuZ2VudC54OwogICAgICAgICAgICAgIHRhbmdlbnRzW2F0dHJJbmRleDEgKyBib3R0b21PZmZzZXRdID0gdGFuZ2VudC55OwogICAgICAgICAgICAgIHRhbmdlbnRzW2F0dHJJbmRleDIgKyBib3R0b21PZmZzZXRdID0gdGFuZ2VudC56OwogICAgICAgICAgICB9IGVsc2UgaWYgKGJvdHRvbSkgewogICAgICAgICAgICAgIHRhbmdlbnRzW2F0dHJJbmRleCArIGJvdHRvbU9mZnNldF0gPSAtdGFuZ2VudC54OwogICAgICAgICAgICAgIHRhbmdlbnRzW2F0dHJJbmRleDEgKyBib3R0b21PZmZzZXRdID0gLXRhbmdlbnQueTsKICAgICAgICAgICAgICB0YW5nZW50c1thdHRySW5kZXgyICsgYm90dG9tT2Zmc2V0XSA9IC10YW5nZW50Lno7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRvcCkgewogICAgICAgICAgICAgIGlmIChwZXJQb3NpdGlvbkhlaWdodCkgewogICAgICAgICAgICAgICAgdGFuZ2VudHNbYXR0ckluZGV4XSA9IHNjcmF0Y2hQZXJQb3NUYW5nZW50Lng7CiAgICAgICAgICAgICAgICB0YW5nZW50c1thdHRySW5kZXgxXSA9IHNjcmF0Y2hQZXJQb3NUYW5nZW50Lnk7CiAgICAgICAgICAgICAgICB0YW5nZW50c1thdHRySW5kZXgyXSA9IHNjcmF0Y2hQZXJQb3NUYW5nZW50Lno7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW2F0dHJJbmRleF0gPSB0YW5nZW50Lng7CiAgICAgICAgICAgICAgICB0YW5nZW50c1thdHRySW5kZXgxXSA9IHRhbmdlbnQueTsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW2F0dHJJbmRleDJdID0gdGFuZ2VudC56OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgaWYgKGJvdHRvbSkgewogICAgICAgICAgICAgIGJpdGFuZ2VudHNbYXR0ckluZGV4ICsgYm90dG9tT2Zmc2V0XSA9IGJpdGFuZ2VudC54OwogICAgICAgICAgICAgIGJpdGFuZ2VudHNbYXR0ckluZGV4MSArIGJvdHRvbU9mZnNldF0gPSBiaXRhbmdlbnQueTsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2F0dHJJbmRleDIgKyBib3R0b21PZmZzZXRdID0gYml0YW5nZW50Lno7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRvcCkgewogICAgICAgICAgICAgIGlmIChwZXJQb3NpdGlvbkhlaWdodCkgewogICAgICAgICAgICAgICAgYml0YW5nZW50c1thdHRySW5kZXhdID0gc2NyYXRjaFBlclBvc0JpdGFuZ2VudC54OwogICAgICAgICAgICAgICAgYml0YW5nZW50c1thdHRySW5kZXgxXSA9IHNjcmF0Y2hQZXJQb3NCaXRhbmdlbnQueTsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudHNbYXR0ckluZGV4Ml0gPSBzY3JhdGNoUGVyUG9zQml0YW5nZW50Lno7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudHNbYXR0ckluZGV4XSA9IGJpdGFuZ2VudC54OwogICAgICAgICAgICAgICAgYml0YW5nZW50c1thdHRySW5kZXgxXSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgICAgICAgYml0YW5nZW50c1thdHRySW5kZXgyXSA9IGJpdGFuZ2VudC56OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgYXR0ckluZGV4ICs9IDM7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QgJiYgIWRlZmluZWRfZGVmYXVsdChmbGF0VGV4Y29vcmRzKSkgewogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgICB2YWx1ZXM6IHRleHR1cmVDb29yZGluYXRlcwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5ub3JtYWwgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICB2YWx1ZXM6IG5vcm1hbHMKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLnRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICB2YWx1ZXM6IHRhbmdlbnRzCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLmJpdGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgIHZhbHVlczogYml0YW5nZW50cwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLmV4dHJ1ZGVEaXJlY3Rpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICB2YWx1ZXM6IGV4dHJ1ZGVOb3JtYWxzCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICAgIGlmIChvcHRpb25zLmV4dHJ1ZGUgJiYgZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlKSkgewogICAgICBjb25zdCBzaXplID0gZmxhdFBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgICBsZXQgb2Zmc2V0QXR0cmlidXRlID0gbmV3IFVpbnQ4QXJyYXkoc2l6ZSk7CiAgICAgIGlmIChvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5UT1ApIHsKICAgICAgICBpZiAodG9wICYmIGJvdHRvbSB8fCB3YWxsKSB7CiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUuZmlsbCgxLCAwLCBzaXplIC8gMik7CiAgICAgICAgfSBlbHNlIGlmICh0b3ApIHsKICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZS5maWxsKDEpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICBvZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgIH0KICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgdmFsdWVzOiBvZmZzZXRBdHRyaWJ1dGUKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gZ2VvbWV0cnk7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc0V4dHJ1ZGVkKGVsbGlwc29pZCwgcG9seWdvbjIsIHRleHR1cmVDb29yZGluYXRlcywgZ3JhbnVsYXJpdHksIGhpZXJhcmNoeSwgcGVyUG9zaXRpb25IZWlnaHQsIGNsb3NlVG9wLCBjbG9zZUJvdHRvbSwgdmVydGV4Rm9ybWF0LCBhcmNUeXBlKSB7CiAgICBjb25zdCBnZW9zID0gewogICAgICB3YWxsczogW10KICAgIH07CiAgICBsZXQgaTsKICAgIGlmIChjbG9zZVRvcCB8fCBjbG9zZUJvdHRvbSkgewogICAgICBjb25zdCB0b3BHZW8gPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zKAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICBwb2x5Z29uMiwKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXMsCiAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgcGVyUG9zaXRpb25IZWlnaHQsCiAgICAgICAgdmVydGV4Rm9ybWF0LAogICAgICAgIGFyY1R5cGUKICAgICAgKTsKICAgICAgY29uc3QgZWRnZVBvaW50cyA9IHRvcEdlby5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgICAgY29uc3QgaW5kaWNlcyA9IHRvcEdlby5pbmRpY2VzOwogICAgICBsZXQgbnVtUG9zaXRpb25zOwogICAgICBsZXQgbmV3SW5kaWNlczsKICAgICAgaWYgKGNsb3NlVG9wICYmIGNsb3NlQm90dG9tKSB7CiAgICAgICAgY29uc3QgdG9wQm90dG9tUG9zaXRpb25zID0gZWRnZVBvaW50cy5jb25jYXQoZWRnZVBvaW50cyk7CiAgICAgICAgbnVtUG9zaXRpb25zID0gdG9wQm90dG9tUG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICAgICAgbmV3SW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICAgICAgbnVtUG9zaXRpb25zLAogICAgICAgICAgaW5kaWNlcy5sZW5ndGggKiAyCiAgICAgICAgKTsKICAgICAgICBuZXdJbmRpY2VzLnNldChpbmRpY2VzKTsKICAgICAgICBjb25zdCBpbGVuZ3RoID0gaW5kaWNlcy5sZW5ndGg7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gbnVtUG9zaXRpb25zIC8gMjsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgaWxlbmd0aDsgaSArPSAzKSB7CiAgICAgICAgICBjb25zdCBpMCA9IG5ld0luZGljZXNbaV0gKyBsZW5ndGg7CiAgICAgICAgICBjb25zdCBpMSA9IG5ld0luZGljZXNbaSArIDFdICsgbGVuZ3RoOwogICAgICAgICAgY29uc3QgaTIgPSBuZXdJbmRpY2VzW2kgKyAyXSArIGxlbmd0aDsKICAgICAgICAgIG5ld0luZGljZXNbaSArIGlsZW5ndGhdID0gaTI7CiAgICAgICAgICBuZXdJbmRpY2VzW2kgKyAxICsgaWxlbmd0aF0gPSBpMTsKICAgICAgICAgIG5ld0luZGljZXNbaSArIDIgKyBpbGVuZ3RoXSA9IGkwOwogICAgICAgIH0KICAgICAgICB0b3BHZW8uYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSB0b3BCb3R0b21Qb3NpdGlvbnM7CiAgICAgICAgaWYgKHBlclBvc2l0aW9uSGVpZ2h0ICYmIHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICAgIGNvbnN0IG5vcm1hbHMgPSB0b3BHZW8uYXR0cmlidXRlcy5ub3JtYWwudmFsdWVzOwogICAgICAgICAgdG9wR2VvLmF0dHJpYnV0ZXMubm9ybWFsLnZhbHVlcyA9IG5ldyBGbG9hdDMyQXJyYXkoCiAgICAgICAgICAgIHRvcEJvdHRvbVBvc2l0aW9ucy5sZW5ndGgKICAgICAgICAgICk7CiAgICAgICAgICB0b3BHZW8uYXR0cmlidXRlcy5ub3JtYWwudmFsdWVzLnNldChub3JtYWxzKTsKICAgICAgICB9CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCAmJiBkZWZpbmVkX2RlZmF1bHQodGV4dHVyZUNvb3JkaW5hdGVzKSkgewogICAgICAgICAgY29uc3QgdGV4Y29vcmRzID0gdG9wR2VvLmF0dHJpYnV0ZXMuc3QudmFsdWVzOwogICAgICAgICAgdG9wR2VvLmF0dHJpYnV0ZXMuc3QudmFsdWVzID0gbmV3IEZsb2F0MzJBcnJheShudW1Qb3NpdGlvbnMgKiAyKTsKICAgICAgICAgIHRvcEdlby5hdHRyaWJ1dGVzLnN0LnZhbHVlcyA9IHRleGNvb3Jkcy5jb25jYXQodGV4Y29vcmRzKTsKICAgICAgICB9CiAgICAgICAgdG9wR2VvLmluZGljZXMgPSBuZXdJbmRpY2VzOwogICAgICB9IGVsc2UgaWYgKGNsb3NlQm90dG9tKSB7CiAgICAgICAgbnVtUG9zaXRpb25zID0gZWRnZVBvaW50cy5sZW5ndGggLyAzOwogICAgICAgIG5ld0luZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShudW1Qb3NpdGlvbnMsIGluZGljZXMubGVuZ3RoKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgaW5kaWNlcy5sZW5ndGg7IGkgKz0gMykgewogICAgICAgICAgbmV3SW5kaWNlc1tpXSA9IGluZGljZXNbaSArIDJdOwogICAgICAgICAgbmV3SW5kaWNlc1tpICsgMV0gPSBpbmRpY2VzW2kgKyAxXTsKICAgICAgICAgIG5ld0luZGljZXNbaSArIDJdID0gaW5kaWNlc1tpXTsKICAgICAgICB9CiAgICAgICAgdG9wR2VvLmluZGljZXMgPSBuZXdJbmRpY2VzOwogICAgICB9CiAgICAgIGdlb3MudG9wQW5kQm90dG9tID0gbmV3IEdlb21ldHJ5SW5zdGFuY2VfZGVmYXVsdCh7CiAgICAgICAgZ2VvbWV0cnk6IHRvcEdlbwogICAgICB9KTsKICAgIH0KICAgIGxldCBvdXRlclJpbmcgPSBoaWVyYXJjaHkub3V0ZXJSaW5nOwogICAgY29uc3QgdGFuZ2VudFBsYW5lID0gRWxsaXBzb2lkVGFuZ2VudFBsYW5lX2RlZmF1bHQuZnJvbVBvaW50cyhvdXRlclJpbmcsIGVsbGlwc29pZCk7CiAgICBsZXQgcG9zaXRpb25zMkQgPSB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50c09udG9QbGFuZSgKICAgICAgb3V0ZXJSaW5nLAogICAgICBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnNFeHRydWRlZFBvc2l0aW9ucwogICAgKTsKICAgIGxldCB3aW5kaW5nT3JkZXIgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5jb21wdXRlV2luZGluZ09yZGVyMkQocG9zaXRpb25zMkQpOwogICAgaWYgKHdpbmRpbmdPcmRlciA9PT0gV2luZGluZ09yZGVyX2RlZmF1bHQuQ0xPQ0tXSVNFKSB7CiAgICAgIG91dGVyUmluZyA9IG91dGVyUmluZy5zbGljZSgpLnJldmVyc2UoKTsKICAgIH0KICAgIGxldCB3YWxsR2VvID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVXYWxsR2VvbWV0cnkoCiAgICAgIG91dGVyUmluZywKICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzLAogICAgICBlbGxpcHNvaWQsCiAgICAgIGdyYW51bGFyaXR5LAogICAgICBwZXJQb3NpdGlvbkhlaWdodCwKICAgICAgYXJjVHlwZQogICAgKTsKICAgIGdlb3Mud2FsbHMucHVzaCgKICAgICAgbmV3IEdlb21ldHJ5SW5zdGFuY2VfZGVmYXVsdCh7CiAgICAgICAgZ2VvbWV0cnk6IHdhbGxHZW8KICAgICAgfSkKICAgICk7CiAgICBjb25zdCBob2xlcyA9IGhpZXJhcmNoeS5ob2xlczsKICAgIGZvciAoaSA9IDA7IGkgPCBob2xlcy5sZW5ndGg7IGkrKykgewogICAgICBsZXQgaG9sZSA9IGhvbGVzW2ldOwogICAgICBwb3NpdGlvbnMyRCA9IHRhbmdlbnRQbGFuZS5wcm9qZWN0UG9pbnRzT250b1BsYW5lKAogICAgICAgIGhvbGUsCiAgICAgICAgY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zRXh0cnVkZWRQb3NpdGlvbnMKICAgICAgKTsKICAgICAgd2luZGluZ09yZGVyID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuY29tcHV0ZVdpbmRpbmdPcmRlcjJEKHBvc2l0aW9uczJEKTsKICAgICAgaWYgKHdpbmRpbmdPcmRlciA9PT0gV2luZGluZ09yZGVyX2RlZmF1bHQuQ09VTlRFUl9DTE9DS1dJU0UpIHsKICAgICAgICBob2xlID0gaG9sZS5zbGljZSgpLnJldmVyc2UoKTsKICAgICAgfQogICAgICB3YWxsR2VvID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVXYWxsR2VvbWV0cnkoCiAgICAgICAgaG9sZSwKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXMsCiAgICAgICAgZWxsaXBzb2lkLAogICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0LAogICAgICAgIGFyY1R5cGUKICAgICAgKTsKICAgICAgZ2Vvcy53YWxscy5wdXNoKAogICAgICAgIG5ldyBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQoewogICAgICAgICAgZ2VvbWV0cnk6IHdhbGxHZW8KICAgICAgICB9KQogICAgICApOwogICAgfQogICAgcmV0dXJuIGdlb3M7CiAgfQogIGZ1bmN0aW9uIFBvbHlnb25HZW9tZXRyeShvcHRpb25zKSB7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm9wdGlvbnMiLCBvcHRpb25zKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib3B0aW9ucy5wb2x5Z29uSGllcmFyY2h5Iiwgb3B0aW9ucy5wb2x5Z29uSGllcmFyY2h5KTsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5wZXJQb3NpdGlvbkhlaWdodCkgJiYgb3B0aW9ucy5wZXJQb3NpdGlvbkhlaWdodCAmJiBkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5oZWlnaHQpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJDYW5ub3QgdXNlIGJvdGggb3B0aW9ucy5wZXJQb3NpdGlvbkhlaWdodCBhbmQgb3B0aW9ucy5oZWlnaHQiCiAgICAgICk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuYXJjVHlwZSkgJiYgb3B0aW9ucy5hcmNUeXBlICE9PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMgJiYgb3B0aW9ucy5hcmNUeXBlICE9PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIkludmFsaWQgYXJjVHlwZS4gVmFsaWQgb3B0aW9ucyBhcmUgQXJjVHlwZS5HRU9ERVNJQyBhbmQgQXJjVHlwZS5SSFVNQi4iCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBwb2x5Z29uSGllcmFyY2h5ID0gb3B0aW9ucy5wb2x5Z29uSGllcmFyY2h5OwogICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy52ZXJ0ZXhGb3JtYXQsIFZlcnRleEZvcm1hdF9kZWZhdWx0LkRFRkFVTFQpOwogICAgY29uc3QgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICk7CiAgICBjb25zdCBzdFJvdGF0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zdFJvdGF0aW9uLCAwKTsKICAgIGNvbnN0IHRleHR1cmVDb29yZGluYXRlcyA9IG9wdGlvbnMudGV4dHVyZUNvb3JkaW5hdGVzOwogICAgY29uc3QgcGVyUG9zaXRpb25IZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnBlclBvc2l0aW9uSGVpZ2h0LCBmYWxzZSk7CiAgICBjb25zdCBwZXJQb3NpdGlvbkhlaWdodEV4dHJ1ZGUgPSBwZXJQb3NpdGlvbkhlaWdodCAmJiBkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5leHRydWRlZEhlaWdodCk7CiAgICBsZXQgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5oZWlnaHQsIDApOwogICAgbGV0IGV4dHJ1ZGVkSGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5leHRydWRlZEhlaWdodCwgaGVpZ2h0KTsKICAgIGlmICghcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlKSB7CiAgICAgIGNvbnN0IGggPSBNYXRoLm1heChoZWlnaHQsIGV4dHJ1ZGVkSGVpZ2h0KTsKICAgICAgZXh0cnVkZWRIZWlnaHQgPSBNYXRoLm1pbihoZWlnaHQsIGV4dHJ1ZGVkSGVpZ2h0KTsKICAgICAgaGVpZ2h0ID0gaDsKICAgIH0KICAgIHRoaXMuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCk7CiAgICB0aGlzLl9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQpOwogICAgdGhpcy5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgIHRoaXMuX3N0Um90YXRpb24gPSBzdFJvdGF0aW9uOwogICAgdGhpcy5faGVpZ2h0ID0gaGVpZ2h0OwogICAgdGhpcy5fZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgIHRoaXMuX2Nsb3NlVG9wID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5jbG9zZVRvcCwgdHJ1ZSk7CiAgICB0aGlzLl9jbG9zZUJvdHRvbSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuY2xvc2VCb3R0b20sIHRydWUpOwogICAgdGhpcy5fcG9seWdvbkhpZXJhcmNoeSA9IHBvbHlnb25IaWVyYXJjaHk7CiAgICB0aGlzLl9wZXJQb3NpdGlvbkhlaWdodCA9IHBlclBvc2l0aW9uSGVpZ2h0OwogICAgdGhpcy5fcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlID0gcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlOwogICAgdGhpcy5fc2hhZG93Vm9sdW1lID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zaGFkb3dWb2x1bWUsIGZhbHNlKTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlUG9seWdvbkdlb21ldHJ5IjsKICAgIHRoaXMuX29mZnNldEF0dHJpYnV0ZSA9IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlOwogICAgdGhpcy5fYXJjVHlwZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuYXJjVHlwZSwgQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDKTsKICAgIHRoaXMuX3JlY3RhbmdsZSA9IHZvaWQgMDsKICAgIHRoaXMuX3RleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHMgPSB2b2lkIDA7CiAgICB0aGlzLl90ZXh0dXJlQ29vcmRpbmF0ZXMgPSB0ZXh0dXJlQ29vcmRpbmF0ZXM7CiAgICB0aGlzLnBhY2tlZExlbmd0aCA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlSGllcmFyY2h5UGFja2VkTGVuZ3RoKAogICAgICBwb2x5Z29uSGllcmFyY2h5LAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQKICAgICkgKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAodGV4dHVyZUNvb3JkaW5hdGVzID8gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVIaWVyYXJjaHlQYWNrZWRMZW5ndGgoCiAgICAgIHRleHR1cmVDb29yZGluYXRlcywKICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0CiAgICApIDogMSkgKyAxMjsKICB9CiAgZnVuY3Rpb24gZXhwYW5kUmVjdGFuZ2xlKHBvbGFyLCBsYXN0UG9sYXIsIGVsbGlwc29pZCwgYXJjVHlwZSwgcG9seWdvbjIsIHJlc3VsdCkgewogICAgY29uc3QgbG9uZ2l0dWRlID0gcG9sYXIubG9uZ2l0dWRlOwogICAgY29uc3QgbG9uQWRqdXN0ZWQgPSBsb25naXR1ZGUgPj0gMCA/IGxvbmdpdHVkZSA6IGxvbmdpdHVkZSArIE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICBwb2x5Z29uMi53ZXN0T3ZlcklkbCA9IE1hdGgubWluKHBvbHlnb24yLndlc3RPdmVySWRsLCBsb25BZGp1c3RlZCk7CiAgICBwb2x5Z29uMi5lYXN0T3ZlcklkbCA9IE1hdGgubWF4KHBvbHlnb24yLmVhc3RPdmVySWRsLCBsb25BZGp1c3RlZCk7CiAgICByZXN1bHQud2VzdCA9IE1hdGgubWluKHJlc3VsdC53ZXN0LCBsb25naXR1ZGUpOwogICAgcmVzdWx0LmVhc3QgPSBNYXRoLm1heChyZXN1bHQuZWFzdCwgbG9uZ2l0dWRlKTsKICAgIGNvbnN0IGxhdGl0dWRlID0gcG9sYXIuZ2V0TGF0aXR1ZGUoZWxsaXBzb2lkKTsKICAgIGxldCBzZWdtZW50TGF0aXR1ZGUgPSBsYXRpdHVkZTsKICAgIHJlc3VsdC5zb3V0aCA9IE1hdGgubWluKHJlc3VsdC5zb3V0aCwgbGF0aXR1ZGUpOwogICAgcmVzdWx0Lm5vcnRoID0gTWF0aC5tYXgocmVzdWx0Lm5vcnRoLCBsYXRpdHVkZSk7CiAgICBpZiAoYXJjVHlwZSAhPT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgIGNvbnN0IHNlZ21lbnQgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgbGFzdFBvbGFyLnBvc2l0aW9uLAogICAgICAgIHBvbGFyLnBvc2l0aW9uLAogICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4wMgogICAgICApOwogICAgICBjb25zdCB0ID0gQ2FydGVzaWFuMl9kZWZhdWx0LmRvdChsYXN0UG9sYXIucG9zaXRpb24sIHNlZ21lbnQpIC8gQ2FydGVzaWFuMl9kZWZhdWx0LmRvdChzZWdtZW50LCBzZWdtZW50KTsKICAgICAgaWYgKHQgPiAwICYmIHQgPCAxKSB7CiAgICAgICAgY29uc3QgcHJvamVjdGVkID0gQ2FydGVzaWFuMl9kZWZhdWx0LmFkZCgKICAgICAgICAgIGxhc3RQb2xhci5wb3NpdGlvbiwKICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHNlZ21lbnQsIC10LCBzZWdtZW50KSwKICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xOAogICAgICAgICk7CiAgICAgICAgY29uc3QgY2xvc2VzdFBvbGFyID0gU3RlcmVvZ3JhcGhpY19kZWZhdWx0LmNsb25lKGxhc3RQb2xhciwgc2NyYXRjaFBvbGFyQ2xvc2VzdCk7CiAgICAgICAgY2xvc2VzdFBvbGFyLnBvc2l0aW9uID0gcHJvamVjdGVkOwogICAgICAgIGNvbnN0IGFkanVzdGVkTGF0aXR1ZGUgPSBjbG9zZXN0UG9sYXIuZ2V0TGF0aXR1ZGUoZWxsaXBzb2lkKTsKICAgICAgICByZXN1bHQuc291dGggPSBNYXRoLm1pbihyZXN1bHQuc291dGgsIGFkanVzdGVkTGF0aXR1ZGUpOwogICAgICAgIHJlc3VsdC5ub3J0aCA9IE1hdGgubWF4KHJlc3VsdC5ub3J0aCwgYWRqdXN0ZWRMYXRpdHVkZSk7CiAgICAgICAgaWYgKE1hdGguYWJzKGxhdGl0dWRlKSA+IE1hdGguYWJzKGFkanVzdGVkTGF0aXR1ZGUpKSB7CiAgICAgICAgICBzZWdtZW50TGF0aXR1ZGUgPSBhZGp1c3RlZExhdGl0dWRlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgY29uc3QgZGlyZWN0aW9uMiA9IGxhc3RQb2xhci54ICogcG9sYXIueSAtIHBvbGFyLnggKiBsYXN0UG9sYXIueTsKICAgIGxldCBhbmdsZSA9IE1hdGguc2lnbihkaXJlY3Rpb24yKTsKICAgIGlmIChhbmdsZSAhPT0gMCkgewogICAgICBhbmdsZSAqPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuYW5nbGVCZXR3ZWVuKGxhc3RQb2xhci5wb3NpdGlvbiwgcG9sYXIucG9zaXRpb24pOwogICAgfQogICAgaWYgKHNlZ21lbnRMYXRpdHVkZSA+PSAwKSB7CiAgICAgIHBvbHlnb24yLm5vcnRoQW5nbGUgKz0gYW5nbGU7CiAgICB9CiAgICBpZiAoc2VnbWVudExhdGl0dWRlIDw9IDApIHsKICAgICAgcG9seWdvbjIuc291dGhBbmdsZSArPSBhbmdsZTsKICAgIH0KICB9CiAgZnVuY3Rpb24gZ2V0VGFuZ2VudFBsYW5lKHJlY3RhbmdsZSwgcG9zaXRpb25zLCBlbGxpcHNvaWQpIHsKICAgIGlmIChyZWN0YW5nbGUuaGVpZ2h0ID49IE1hdGhfZGVmYXVsdC5QSSB8fCByZWN0YW5nbGUud2lkdGggPj0gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgIGNvbnN0IHBvbGFyID0gU3RlcmVvZ3JhcGhpY19kZWZhdWx0LmZyb21DYXJ0ZXNpYW4oCiAgICAgICAgcG9zaXRpb25zWzBdLAogICAgICAgIHNjcmF0Y2hQb2xhckZvclBsYW5lCiAgICAgICk7CiAgICAgIHJldHVybiBwb2xhci50YW5nZW50UGxhbmU7CiAgICB9CiAgICByZXR1cm4gRWxsaXBzb2lkVGFuZ2VudFBsYW5lX2RlZmF1bHQuZnJvbVBvaW50cyhwb3NpdGlvbnMsIGVsbGlwc29pZCk7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVByb2plY3RUbzJkKHJlY3RhbmdsZSwgb3V0ZXJQb3NpdGlvbnMsIGVsbGlwc29pZCkgewogICAgcmV0dXJuIChwb3NpdGlvbnMsIHJlc3VsdHMpID0+IHsKICAgICAgaWYgKHJlY3RhbmdsZS5oZWlnaHQgPj0gTWF0aF9kZWZhdWx0LlBJIHx8IHJlY3RhbmdsZS53aWR0aCA+PSBNYXRoX2RlZmF1bHQuUEkpIHsKICAgICAgICBpZiAocmVjdGFuZ2xlLnNvdXRoIDwgMCAmJiByZWN0YW5nbGUubm9ydGggPiAwKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHRzKSkgewogICAgICAgICAgICByZXN1bHRzID0gW107CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9ucy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICBjb25zdCBjYXJ0b2dyYXBoaWMyID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICAgICAgICAgIHBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljQ3lsbGluZHJpY2FsCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJlc3VsdHNbaV0gPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KAogICAgICAgICAgICAgIGNhcnRvZ3JhcGhpYzIubG9uZ2l0dWRlIC8gTWF0aF9kZWZhdWx0LlBJLAogICAgICAgICAgICAgIGNhcnRvZ3JhcGhpYzIubGF0aXR1ZGUgLyBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08KICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdHMubGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgIH0KICAgICAgICByZXR1cm4gU3RlcmVvZ3JhcGhpY19kZWZhdWx0LmZyb21DYXJ0ZXNpYW5BcnJheShwb3NpdGlvbnMsIHJlc3VsdHMpOwogICAgICB9CiAgICAgIGNvbnN0IHRhbmdlbnRQbGFuZSA9IEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0LmZyb21Qb2ludHMoCiAgICAgICAgb3V0ZXJQb3NpdGlvbnMsCiAgICAgICAgZWxsaXBzb2lkCiAgICAgICk7CiAgICAgIHJldHVybiB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50c09udG9QbGFuZShwb3NpdGlvbnMsIHJlc3VsdHMpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlUHJvamVjdFBvc2l0aW9uVG8yZChyZWN0YW5nbGUsIG91dGVyUmluZywgZWxsaXBzb2lkKSB7CiAgICBpZiAocmVjdGFuZ2xlLmhlaWdodCA+PSBNYXRoX2RlZmF1bHQuUEkgfHwgcmVjdGFuZ2xlLndpZHRoID49IE1hdGhfZGVmYXVsdC5QSSkgewogICAgICByZXR1cm4gKHBvc2l0aW9uLCByZXN1bHQpID0+IHsKICAgICAgICBpZiAocmVjdGFuZ2xlLnNvdXRoIDwgMCAmJiByZWN0YW5nbGUubm9ydGggPiAwKSB7CiAgICAgICAgICBjb25zdCBjYXJ0b2dyYXBoaWMyID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY0N5bGxpbmRyaWNhbAogICAgICAgICAgKTsKICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICAgICAgfQogICAgICAgICAgcmVzdWx0LnggPSBjYXJ0b2dyYXBoaWMyLmxvbmdpdHVkZSAvIE1hdGhfZGVmYXVsdC5QSTsKICAgICAgICAgIHJlc3VsdC55ID0gY2FydG9ncmFwaGljMi5sYXRpdHVkZSAvIE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTzsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBTdGVyZW9ncmFwaGljX2RlZmF1bHQuZnJvbUNhcnRlc2lhbihwb3NpdGlvbiwgcmVzdWx0KTsKICAgICAgfTsKICAgIH0KICAgIGNvbnN0IHRhbmdlbnRQbGFuZSA9IEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0LmZyb21Qb2ludHMob3V0ZXJSaW5nLCBlbGxpcHNvaWQpOwogICAgcmV0dXJuIChwb3NpdGlvbiwgcmVzdWx0KSA9PiB7CiAgICAgIHJldHVybiB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50c09udG9QbGFuZShwb3NpdGlvbiwgcmVzdWx0KTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVNwbGl0UG9seWdvbnMocmVjdGFuZ2xlLCBlbGxpcHNvaWQsIGFyY1R5cGUsIHBlclBvc2l0aW9uSGVpZ2h0KSB7CiAgICByZXR1cm4gKHBvbHlnb25zLCByZXN1bHRzKSA9PiB7CiAgICAgIGlmICghcGVyUG9zaXRpb25IZWlnaHQgJiYgKHJlY3RhbmdsZS5oZWlnaHQgPj0gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIHx8IHJlY3RhbmdsZS53aWR0aCA+PSAyICogTWF0aF9kZWZhdWx0LlBJX09WRVJfVEhSRUUpKSB7CiAgICAgICAgcmV0dXJuIFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5zcGxpdFBvbHlnb25zT25FcXVhdG9yKAogICAgICAgICAgcG9seWdvbnMsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBhcmNUeXBlLAogICAgICAgICAgcmVzdWx0cwogICAgICAgICk7CiAgICAgIH0KICAgICAgcmV0dXJuIHBvbHlnb25zOwogICAgfTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlKG91dGVyUmluZywgcmVjdGFuZ2xlLCBlbGxpcHNvaWQsIHN0Um90YXRpb24pIHsKICAgIGlmIChyZWN0YW5nbGUuaGVpZ2h0ID49IE1hdGhfZGVmYXVsdC5QSSB8fCByZWN0YW5nbGUud2lkdGggPj0gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgIHJldHVybiBCb3VuZGluZ1JlY3RhbmdsZV9kZWZhdWx0LmZyb21SZWN0YW5nbGUoCiAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgIHZvaWQgMCwKICAgICAgICBzY3JhdGNoQm91bmRpbmdSZWN0YW5nbGUKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IG91dGVyUG9zaXRpb25zID0gb3V0ZXJSaW5nOwogICAgY29uc3QgdGFuZ2VudFBsYW5lID0gRWxsaXBzb2lkVGFuZ2VudFBsYW5lX2RlZmF1bHQuZnJvbVBvaW50cygKICAgICAgb3V0ZXJQb3NpdGlvbnMsCiAgICAgIGVsbGlwc29pZAogICAgKTsKICAgIHJldHVybiBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlKAogICAgICB0YW5nZW50UGxhbmUucGxhbmUubm9ybWFsLAogICAgICB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50T250b1BsYW5lLmJpbmQodGFuZ2VudFBsYW5lKSwKICAgICAgb3V0ZXJQb3NpdGlvbnMsCiAgICAgIHN0Um90YXRpb24sCiAgICAgIHNjcmF0Y2hCb3VuZGluZ1JlY3RhbmdsZQogICAgKTsKICB9CiAgZnVuY3Rpb24gdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50czIocG9seWdvbkdlb21ldHJ5KSB7CiAgICBjb25zdCBzdFJvdGF0aW9uID0gLXBvbHlnb25HZW9tZXRyeS5fc3RSb3RhdGlvbjsKICAgIGlmIChzdFJvdGF0aW9uID09PSAwKSB7CiAgICAgIHJldHVybiBbMCwgMCwgMCwgMSwgMSwgMF07CiAgICB9CiAgICBjb25zdCBlbGxpcHNvaWQgPSBwb2x5Z29uR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IHBvbHlnb25HZW9tZXRyeS5fcG9seWdvbkhpZXJhcmNoeS5wb3NpdGlvbnM7CiAgICBjb25zdCBib3VuZGluZ1JlY3RhbmdsZSA9IHBvbHlnb25HZW9tZXRyeS5yZWN0YW5nbGU7CiAgICByZXR1cm4gR2VvbWV0cnlfZGVmYXVsdC5fdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50cygKICAgICAgcG9zaXRpb25zLAogICAgICBzdFJvdGF0aW9uLAogICAgICBlbGxpcHNvaWQsCiAgICAgIGJvdW5kaW5nUmVjdGFuZ2xlCiAgICApOwogIH0KICB2YXIgc2NyYXRjaENhcnRvMSwgc2NyYXRjaENhcnRvMiwgc2NyYXRjaEJvdW5kaW5nUmVjdGFuZ2xlLCBzY3JhdGNoUG9zaXRpb24zLCBzY3JhdGNoTm9ybWFsNiwgc2NyYXRjaFRhbmdlbnQ0LCBzY3JhdGNoQml0YW5nZW50NCwgcDFTY3JhdGNoMywgcDJTY3JhdGNoMywgc2NyYXRjaFBlclBvc05vcm1hbCwgc2NyYXRjaFBlclBvc1RhbmdlbnQsIHNjcmF0Y2hQZXJQb3NCaXRhbmdlbnQsIGFwcGVuZFRleHR1cmVDb29yZGluYXRlc09yaWdpbiwgYXBwZW5kVGV4dHVyZUNvb3JkaW5hdGVzQ2FydGVzaWFuMiwgYXBwZW5kVGV4dHVyZUNvb3JkaW5hdGVzQ2FydGVzaWFuMywgYXBwZW5kVGV4dHVyZUNvb3JkaW5hdGVzUXVhdGVybmlvbiwgYXBwZW5kVGV4dHVyZUNvb3JkaW5hdGVzTWF0cml4MywgdGFuZ2VudE1hdHJpeFNjcmF0Y2gyLCBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnNFeHRydWRlZFBvc2l0aW9ucywgc2NyYXRjaEVsbGlwc29pZDYsIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ5LCBkdW1teU9wdGlvbnMsIHNjcmF0Y2hDYXJ0ZXNpYW4wMiwgc2NyYXRjaENhcnRlc2lhbjE4LCBzY3JhdGNoUG9sYXJDbG9zZXN0LCBzY3JhdGNoUG9sYXIsIHNjcmF0Y2hQb2xhclByZXZpb3VzLCBwb2x5Z29uLCBzY3JhdGNoUG9sYXJGb3JQbGFuZSwgc2NyYXRjaENhcnRvZ3JhcGhpY0N5bGxpbmRyaWNhbCwgUG9seWdvbkdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfUG9seWdvbkdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5Z29uR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0FyY1R5cGUoKTsKICAgICAgaW5pdF9Cb3VuZGluZ1JlY3RhbmdsZSgpOwogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkVGFuZ2VudFBsYW5lKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5SW5zdGFuY2UoKTsKICAgICAgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5UGlwZWxpbmUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9Qb2x5Z29uR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIGluaXRfUG9seWdvblBpcGVsaW5lKCk7CiAgICAgIGluaXRfUXVhdGVybmlvbigpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X1N0ZXJlb2dyYXBoaWMoKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgaW5pdF9XaW5kaW5nT3JkZXIoKTsKICAgICAgc2NyYXRjaENhcnRvMSA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydG8yID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hCb3VuZGluZ1JlY3RhbmdsZSA9IG5ldyBCb3VuZGluZ1JlY3RhbmdsZV9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQb3NpdGlvbjMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hOb3JtYWw2ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVGFuZ2VudDQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hCaXRhbmdlbnQ0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwMVNjcmF0Y2gzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwMlNjcmF0Y2gzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyUG9zTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyUG9zVGFuZ2VudCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlclBvc0JpdGFuZ2VudCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYXBwZW5kVGV4dHVyZUNvb3JkaW5hdGVzT3JpZ2luID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBhcHBlbmRUZXh0dXJlQ29vcmRpbmF0ZXNDYXJ0ZXNpYW4yID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBhcHBlbmRUZXh0dXJlQ29vcmRpbmF0ZXNDYXJ0ZXNpYW4zID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBhcHBlbmRUZXh0dXJlQ29vcmRpbmF0ZXNRdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb25fZGVmYXVsdCgpOwogICAgICBhcHBlbmRUZXh0dXJlQ29vcmRpbmF0ZXNNYXRyaXgzID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICB0YW5nZW50TWF0cml4U2NyYXRjaDIgPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc0V4dHJ1ZGVkUG9zaXRpb25zID0gW107CiAgICAgIFBvbHlnb25HZW9tZXRyeS5mcm9tUG9zaXRpb25zID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib3B0aW9ucy5wb3NpdGlvbnMiLCBvcHRpb25zLnBvc2l0aW9ucyk7CiAgICAgICAgY29uc3QgbmV3T3B0aW9ucyA9IHsKICAgICAgICAgIHBvbHlnb25IaWVyYXJjaHk6IHsKICAgICAgICAgICAgcG9zaXRpb25zOiBvcHRpb25zLnBvc2l0aW9ucwogICAgICAgICAgfSwKICAgICAgICAgIGhlaWdodDogb3B0aW9ucy5oZWlnaHQsCiAgICAgICAgICBleHRydWRlZEhlaWdodDogb3B0aW9ucy5leHRydWRlZEhlaWdodCwKICAgICAgICAgIHZlcnRleEZvcm1hdDogb3B0aW9ucy52ZXJ0ZXhGb3JtYXQsCiAgICAgICAgICBzdFJvdGF0aW9uOiBvcHRpb25zLnN0Um90YXRpb24sCiAgICAgICAgICBlbGxpcHNvaWQ6IG9wdGlvbnMuZWxsaXBzb2lkLAogICAgICAgICAgZ3JhbnVsYXJpdHk6IG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgICAgICBwZXJQb3NpdGlvbkhlaWdodDogb3B0aW9ucy5wZXJQb3NpdGlvbkhlaWdodCwKICAgICAgICAgIGNsb3NlVG9wOiBvcHRpb25zLmNsb3NlVG9wLAogICAgICAgICAgY2xvc2VCb3R0b206IG9wdGlvbnMuY2xvc2VCb3R0b20sCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlLAogICAgICAgICAgYXJjVHlwZTogb3B0aW9ucy5hcmNUeXBlLAogICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzOiBvcHRpb25zLnRleHR1cmVDb29yZGluYXRlcwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIG5ldyBQb2x5Z29uR2VvbWV0cnkobmV3T3B0aW9ucyk7CiAgICAgIH07CiAgICAgIFBvbHlnb25HZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnBhY2tQb2x5Z29uSGllcmFyY2h5KAogICAgICAgICAgdmFsdWUuX3BvbHlnb25IaWVyYXJjaHksCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQKICAgICAgICApOwogICAgICAgIEVsbGlwc29pZF9kZWZhdWx0LnBhY2sodmFsdWUuX2VsbGlwc29pZCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2sodmFsdWUuX3ZlcnRleEZvcm1hdCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5faGVpZ2h0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3N0Um90YXRpb247CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9wZXJQb3NpdGlvbkhlaWdodEV4dHJ1ZGUgPyAxIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3BlclBvc2l0aW9uSGVpZ2h0ID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9jbG9zZVRvcCA/IDEgOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fY2xvc2VCb3R0b20gPyAxIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3NoYWRvd1ZvbHVtZSA/IDEgOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh2YWx1ZS5fb2Zmc2V0QXR0cmlidXRlLCAtMSk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9hcmNUeXBlOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodmFsdWUuX3RleHR1cmVDb29yZGluYXRlcykpIHsKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQucGFja1BvbHlnb25IaWVyYXJjaHkoCiAgICAgICAgICAgIHZhbHVlLl90ZXh0dXJlQ29vcmRpbmF0ZXMsCiAgICAgICAgICAgIGFycmF5LAogICAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSAtMTsKICAgICAgICB9CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLnBhY2tlZExlbmd0aDsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQ2ID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoRWxsaXBzb2lkX2RlZmF1bHQuVU5JVF9TUEhFUkUpOwogICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0OSA9IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCgpOwogICAgICBkdW1teU9wdGlvbnMgPSB7CiAgICAgICAgcG9seWdvbkhpZXJhcmNoeToge30KICAgICAgfTsKICAgICAgUG9seWdvbkdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBwb2x5Z29uSGllcmFyY2h5ID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnVucGFja1BvbHlnb25IaWVyYXJjaHkoCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBwb2x5Z29uSGllcmFyY2h5LnN0YXJ0aW5nSW5kZXg7CiAgICAgICAgZGVsZXRlIHBvbHlnb25IaWVyYXJjaHkuc3RhcnRpbmdJbmRleDsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hFbGxpcHNvaWQ2KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0OQogICAgICAgICk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHN0Um90YXRpb24gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHBlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPT09IDE7CiAgICAgICAgY29uc3QgcGVyUG9zaXRpb25IZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIGNvbnN0IGNsb3NlVG9wID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9PT0gMTsKICAgICAgICBjb25zdCBjbG9zZUJvdHRvbSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPT09IDE7CiAgICAgICAgY29uc3Qgc2hhZG93Vm9sdW1lID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9PT0gMTsKICAgICAgICBjb25zdCBvZmZzZXRBdHRyaWJ1dGUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGFyY1R5cGUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHRleHR1cmVDb29yZGluYXRlcyA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdID09PSAtMSA/IHZvaWQgMCA6IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC51bnBhY2tQb2x5Z29uSGllcmFyY2h5KAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0CiAgICAgICAgKTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHRleHR1cmVDb29yZGluYXRlcykpIHsKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggPSB0ZXh0dXJlQ29vcmRpbmF0ZXMuc3RhcnRpbmdJbmRleDsKICAgICAgICAgIGRlbGV0ZSB0ZXh0dXJlQ29vcmRpbmF0ZXMuc3RhcnRpbmdJbmRleDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RhcnRpbmdJbmRleCsrOwogICAgICAgIH0KICAgICAgICBjb25zdCBwYWNrZWRMZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBQb2x5Z29uR2VvbWV0cnkoZHVtbXlPcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9wb2x5Z29uSGllcmFyY2h5ID0gcG9seWdvbkhpZXJhcmNoeTsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCwgcmVzdWx0Ll9lbGxpcHNvaWQpOwogICAgICAgIHJlc3VsdC5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0LCByZXN1bHQuX3ZlcnRleEZvcm1hdCk7CiAgICAgICAgcmVzdWx0Ll9oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgcmVzdWx0Ll9leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIHJlc3VsdC5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICByZXN1bHQuX3N0Um90YXRpb24gPSBzdFJvdGF0aW9uOwogICAgICAgIHJlc3VsdC5fcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlID0gcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlOwogICAgICAgIHJlc3VsdC5fcGVyUG9zaXRpb25IZWlnaHQgPSBwZXJQb3NpdGlvbkhlaWdodDsKICAgICAgICByZXN1bHQuX2Nsb3NlVG9wID0gY2xvc2VUb3A7CiAgICAgICAgcmVzdWx0Ll9jbG9zZUJvdHRvbSA9IGNsb3NlQm90dG9tOwogICAgICAgIHJlc3VsdC5fc2hhZG93Vm9sdW1lID0gc2hhZG93Vm9sdW1lOwogICAgICAgIHJlc3VsdC5fb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICByZXN1bHQuX2FyY1R5cGUgPSBhcmNUeXBlOwogICAgICAgIHJlc3VsdC5fdGV4dHVyZUNvb3JkaW5hdGVzID0gdGV4dHVyZUNvb3JkaW5hdGVzOwogICAgICAgIHJlc3VsdC5wYWNrZWRMZW5ndGggPSBwYWNrZWRMZW5ndGg7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjAyID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMTggPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQb2xhckNsb3Nlc3QgPSBuZXcgU3RlcmVvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQb2xhciA9IG5ldyBTdGVyZW9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBvbGFyUHJldmlvdXMgPSBuZXcgU3RlcmVvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHBvbHlnb24gPSB7CiAgICAgICAgbm9ydGhBbmdsZTogMCwKICAgICAgICBzb3V0aEFuZ2xlOiAwLAogICAgICAgIHdlc3RPdmVySWRsOiAwLAogICAgICAgIGVhc3RPdmVySWRsOiAwCiAgICAgIH07CiAgICAgIFBvbHlnb25HZW9tZXRyeS5jb21wdXRlUmVjdGFuZ2xlRnJvbVBvc2l0aW9ucyA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgZWxsaXBzb2lkLCBhcmNUeXBlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInBvc2l0aW9ucyIsIHBvc2l0aW9ucyk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFJlY3RhbmdsZV9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGlmIChwb3NpdGlvbnMubGVuZ3RoIDwgMykgewogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Lndlc3QgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgICAgcmVzdWx0LmVhc3QgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgICAgcmVzdWx0LnNvdXRoID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICAgIHJlc3VsdC5ub3J0aCA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgICAgICBwb2x5Z29uLm5vcnRoQW5nbGUgPSAwOwogICAgICAgIHBvbHlnb24uc291dGhBbmdsZSA9IDA7CiAgICAgICAgcG9seWdvbi53ZXN0T3ZlcklkbCA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgICAgICBwb2x5Z29uLmVhc3RPdmVySWRsID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgbGV0IGxhc3RQb2xhclBvc2l0aW9uID0gU3RlcmVvZ3JhcGhpY19kZWZhdWx0LmZyb21DYXJ0ZXNpYW4oCiAgICAgICAgICBwb3NpdGlvbnNbMF0sCiAgICAgICAgICBzY3JhdGNoUG9sYXJQcmV2aW91cwogICAgICAgICk7CiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBwb3NpdGlvbnNMZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgcG9sYXJQb3NpdGlvbiA9IFN0ZXJlb2dyYXBoaWNfZGVmYXVsdC5mcm9tQ2FydGVzaWFuKAogICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgIHNjcmF0Y2hQb2xhcgogICAgICAgICAgKTsKICAgICAgICAgIGV4cGFuZFJlY3RhbmdsZSgKICAgICAgICAgICAgcG9sYXJQb3NpdGlvbiwKICAgICAgICAgICAgbGFzdFBvbGFyUG9zaXRpb24sCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgYXJjVHlwZSwKICAgICAgICAgICAgcG9seWdvbiwKICAgICAgICAgICAgcmVzdWx0CiAgICAgICAgICApOwogICAgICAgICAgbGFzdFBvbGFyUG9zaXRpb24gPSBTdGVyZW9ncmFwaGljX2RlZmF1bHQuY2xvbmUocG9sYXJQb3NpdGlvbiwgbGFzdFBvbGFyUG9zaXRpb24pOwogICAgICAgIH0KICAgICAgICBleHBhbmRSZWN0YW5nbGUoCiAgICAgICAgICBTdGVyZW9ncmFwaGljX2RlZmF1bHQuZnJvbUNhcnRlc2lhbihwb3NpdGlvbnNbMF0sIHNjcmF0Y2hQb2xhciksCiAgICAgICAgICBsYXN0UG9sYXJQb3NpdGlvbiwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIGFyY1R5cGUsCiAgICAgICAgICBwb2x5Z29uLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgICBpZiAocmVzdWx0LmVhc3QgLSByZXN1bHQud2VzdCA+IHBvbHlnb24uZWFzdE92ZXJJZGwgLSBwb2x5Z29uLndlc3RPdmVySWRsKSB7CiAgICAgICAgICByZXN1bHQud2VzdCA9IHBvbHlnb24ud2VzdE92ZXJJZGw7CiAgICAgICAgICByZXN1bHQuZWFzdCA9IHBvbHlnb24uZWFzdE92ZXJJZGw7CiAgICAgICAgICBpZiAocmVzdWx0LmVhc3QgPiBNYXRoX2RlZmF1bHQuUEkpIHsKICAgICAgICAgICAgcmVzdWx0LmVhc3QgPSByZXN1bHQuZWFzdCAtIE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmVzdWx0Lndlc3QgPiBNYXRoX2RlZmF1bHQuUEkpIHsKICAgICAgICAgICAgcmVzdWx0Lndlc3QgPSByZXN1bHQud2VzdCAtIE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIE1hdGguYWJzKHBvbHlnb24ubm9ydGhBbmdsZSksCiAgICAgICAgICBNYXRoX2RlZmF1bHQuVFdPX1BJLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04xMAogICAgICAgICkpIHsKICAgICAgICAgIHJlc3VsdC5ub3J0aCA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTzsKICAgICAgICAgIHJlc3VsdC5lYXN0ID0gTWF0aF9kZWZhdWx0LlBJOwogICAgICAgICAgcmVzdWx0Lndlc3QgPSAtTWF0aF9kZWZhdWx0LlBJOwogICAgICAgIH0KICAgICAgICBpZiAoTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBNYXRoLmFicyhwb2x5Z29uLnNvdXRoQW5nbGUpLAogICAgICAgICAgTWF0aF9kZWZhdWx0LlRXT19QSSwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTAKICAgICAgICApKSB7CiAgICAgICAgICByZXN1bHQuc291dGggPSAtTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPOwogICAgICAgICAgcmVzdWx0LmVhc3QgPSBNYXRoX2RlZmF1bHQuUEk7CiAgICAgICAgICByZXN1bHQud2VzdCA9IC1NYXRoX2RlZmF1bHQuUEk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hQb2xhckZvclBsYW5lID0gbmV3IFN0ZXJlb2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljQ3lsbGluZHJpY2FsID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIFBvbHlnb25HZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKHBvbHlnb25HZW9tZXRyeSkgewogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IHBvbHlnb25HZW9tZXRyeS5fdmVydGV4Rm9ybWF0OwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHBvbHlnb25HZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gcG9seWdvbkdlb21ldHJ5Ll9ncmFudWxhcml0eTsKICAgICAgICBjb25zdCBzdFJvdGF0aW9uID0gcG9seWdvbkdlb21ldHJ5Ll9zdFJvdGF0aW9uOwogICAgICAgIGNvbnN0IHBvbHlnb25IaWVyYXJjaHkgPSBwb2x5Z29uR2VvbWV0cnkuX3BvbHlnb25IaWVyYXJjaHk7CiAgICAgICAgY29uc3QgcGVyUG9zaXRpb25IZWlnaHQgPSBwb2x5Z29uR2VvbWV0cnkuX3BlclBvc2l0aW9uSGVpZ2h0OwogICAgICAgIGNvbnN0IGNsb3NlVG9wID0gcG9seWdvbkdlb21ldHJ5Ll9jbG9zZVRvcDsKICAgICAgICBjb25zdCBjbG9zZUJvdHRvbSA9IHBvbHlnb25HZW9tZXRyeS5fY2xvc2VCb3R0b207CiAgICAgICAgY29uc3QgYXJjVHlwZSA9IHBvbHlnb25HZW9tZXRyeS5fYXJjVHlwZTsKICAgICAgICBjb25zdCB0ZXh0dXJlQ29vcmRpbmF0ZXMgPSBwb2x5Z29uR2VvbWV0cnkuX3RleHR1cmVDb29yZGluYXRlczsKICAgICAgICBjb25zdCBoYXNUZXh0dXJlQ29vcmRpbmF0ZXMgPSBkZWZpbmVkX2RlZmF1bHQodGV4dHVyZUNvb3JkaW5hdGVzKTsKICAgICAgICBjb25zdCBvdXRlclBvc2l0aW9ucyA9IHBvbHlnb25IaWVyYXJjaHkucG9zaXRpb25zOwogICAgICAgIGlmIChvdXRlclBvc2l0aW9ucy5sZW5ndGggPCAzKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJlY3RhbmdsZSA9IHBvbHlnb25HZW9tZXRyeS5yZWN0YW5nbGU7CiAgICAgICAgY29uc3QgcmVzdWx0cyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5wb2x5Z29uc0Zyb21IaWVyYXJjaHkoCiAgICAgICAgICBwb2x5Z29uSGllcmFyY2h5LAogICAgICAgICAgaGFzVGV4dHVyZUNvb3JkaW5hdGVzLAogICAgICAgICAgY3JlYXRlUHJvamVjdFRvMmQocmVjdGFuZ2xlLCBvdXRlclBvc2l0aW9ucywgZWxsaXBzb2lkKSwKICAgICAgICAgICFwZXJQb3NpdGlvbkhlaWdodCwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIGNyZWF0ZVNwbGl0UG9seWdvbnMocmVjdGFuZ2xlLCBlbGxpcHNvaWQsIGFyY1R5cGUsIHBlclBvc2l0aW9uSGVpZ2h0KQogICAgICAgICk7CiAgICAgICAgY29uc3QgaGllcmFyY2h5ID0gcmVzdWx0cy5oaWVyYXJjaHk7CiAgICAgICAgY29uc3QgcG9seWdvbnMgPSByZXN1bHRzLnBvbHlnb25zOwogICAgICAgIGNvbnN0IGR1bW15RnVuY3Rpb24gPSBmdW5jdGlvbihpZGVudGl0eSkgewogICAgICAgICAgcmV0dXJuIGlkZW50aXR5OwogICAgICAgIH07CiAgICAgICAgY29uc3QgdGV4dHVyZUNvb3JkaW5hdGVQb2x5Z29ucyA9IGhhc1RleHR1cmVDb29yZGluYXRlcyA/IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5wb2x5Z29uc0Zyb21IaWVyYXJjaHkoCiAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXMsCiAgICAgICAgICB0cnVlLAogICAgICAgICAgZHVtbXlGdW5jdGlvbiwKICAgICAgICAgIGZhbHNlLAogICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgKS5wb2x5Z29ucyA6IHZvaWQgMDsKICAgICAgICBpZiAoaGllcmFyY2h5Lmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBvdXRlclJpbmcgPSBoaWVyYXJjaHlbMF0ub3V0ZXJSaW5nOwogICAgICAgIGNvbnN0IGJvdW5kaW5nUmVjdGFuZ2xlID0gY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlKAogICAgICAgICAgb3V0ZXJSaW5nLAogICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgc3RSb3RhdGlvbgogICAgICAgICk7CiAgICAgICAgY29uc3QgZ2VvbWV0cmllcyA9IFtdOwogICAgICAgIGNvbnN0IGhlaWdodCA9IHBvbHlnb25HZW9tZXRyeS5faGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gcG9seWdvbkdlb21ldHJ5Ll9leHRydWRlZEhlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlID0gcG9seWdvbkdlb21ldHJ5Ll9wZXJQb3NpdGlvbkhlaWdodEV4dHJ1ZGUgfHwgIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGhlaWdodCwgZXh0cnVkZWRIZWlnaHQsIDAsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMik7CiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHsKICAgICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0LAogICAgICAgICAgdmVydGV4Rm9ybWF0LAogICAgICAgICAgZ2VvbWV0cnk6IHZvaWQgMCwKICAgICAgICAgIHJvdGF0aW9uQXhpczogZ2V0VGFuZ2VudFBsYW5lKHJlY3RhbmdsZSwgb3V0ZXJSaW5nLCBlbGxpcHNvaWQpLnBsYW5lLm5vcm1hbCwKICAgICAgICAgIHByb2plY3RUbzJkOiBjcmVhdGVQcm9qZWN0UG9zaXRpb25UbzJkKHJlY3RhbmdsZSwgb3V0ZXJSaW5nLCBlbGxpcHNvaWQpLAogICAgICAgICAgYm91bmRpbmdSZWN0YW5nbGUsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBzdFJvdGF0aW9uLAogICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzOiB2b2lkIDAsCiAgICAgICAgICBib3R0b206IGZhbHNlLAogICAgICAgICAgdG9wOiB0cnVlLAogICAgICAgICAgd2FsbDogZmFsc2UsCiAgICAgICAgICBleHRydWRlOiBmYWxzZSwKICAgICAgICAgIGFyY1R5cGUKICAgICAgICB9OwogICAgICAgIGxldCBpOwogICAgICAgIGlmIChleHRydWRlKSB7CiAgICAgICAgICBvcHRpb25zLmV4dHJ1ZGUgPSB0cnVlOwogICAgICAgICAgb3B0aW9ucy50b3AgPSBjbG9zZVRvcDsKICAgICAgICAgIG9wdGlvbnMuYm90dG9tID0gY2xvc2VCb3R0b207CiAgICAgICAgICBvcHRpb25zLnNoYWRvd1ZvbHVtZSA9IHBvbHlnb25HZW9tZXRyeS5fc2hhZG93Vm9sdW1lOwogICAgICAgICAgb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPSBwb2x5Z29uR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwb2x5Z29ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCBzcGxpdEdlb21ldHJ5ID0gY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zRXh0cnVkZWQoCiAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgIHBvbHlnb25zW2ldLAogICAgICAgICAgICAgIGhhc1RleHR1cmVDb29yZGluYXRlcyA/IHRleHR1cmVDb29yZGluYXRlUG9seWdvbnNbaV0gOiB2b2lkIDAsCiAgICAgICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICAgICAgaGllcmFyY2h5W2ldLAogICAgICAgICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0LAogICAgICAgICAgICAgIGNsb3NlVG9wLAogICAgICAgICAgICAgIGNsb3NlQm90dG9tLAogICAgICAgICAgICAgIHZlcnRleEZvcm1hdCwKICAgICAgICAgICAgICBhcmNUeXBlCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGxldCB0b3BBbmRCb3R0b207CiAgICAgICAgICAgIGlmIChjbG9zZVRvcCAmJiBjbG9zZUJvdHRvbSkgewogICAgICAgICAgICAgIHRvcEFuZEJvdHRvbSA9IHNwbGl0R2VvbWV0cnkudG9wQW5kQm90dG9tOwogICAgICAgICAgICAgIG9wdGlvbnMuZ2VvbWV0cnkgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuc2NhbGVUb0dlb2RldGljSGVpZ2h0RXh0cnVkZWQoCiAgICAgICAgICAgICAgICB0b3BBbmRCb3R0b20uZ2VvbWV0cnksCiAgICAgICAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAgICAgICBleHRydWRlZEhlaWdodCwKICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbG9zZVRvcCkgewogICAgICAgICAgICAgIHRvcEFuZEJvdHRvbSA9IHNwbGl0R2VvbWV0cnkudG9wQW5kQm90dG9tOwogICAgICAgICAgICAgIHRvcEFuZEJvdHRvbS5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodCgKICAgICAgICAgICAgICAgIHRvcEFuZEJvdHRvbS5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgICAgICAgICAgIGhlaWdodCwKICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgICFwZXJQb3NpdGlvbkhlaWdodAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgb3B0aW9ucy5nZW9tZXRyeSA9IHRvcEFuZEJvdHRvbS5nZW9tZXRyeTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbG9zZUJvdHRvbSkgewogICAgICAgICAgICAgIHRvcEFuZEJvdHRvbSA9IHNwbGl0R2VvbWV0cnkudG9wQW5kQm90dG9tOwogICAgICAgICAgICAgIHRvcEFuZEJvdHRvbS5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodCgKICAgICAgICAgICAgICAgIHRvcEFuZEJvdHRvbS5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgdHJ1ZQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgb3B0aW9ucy5nZW9tZXRyeSA9IHRvcEFuZEJvdHRvbS5nZW9tZXRyeTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2xvc2VUb3AgfHwgY2xvc2VCb3R0b20pIHsKICAgICAgICAgICAgICBvcHRpb25zLndhbGwgPSBmYWxzZTsKICAgICAgICAgICAgICB0b3BBbmRCb3R0b20uZ2VvbWV0cnkgPSBjb21wdXRlQXR0cmlidXRlcyhvcHRpb25zKTsKICAgICAgICAgICAgICBnZW9tZXRyaWVzLnB1c2godG9wQW5kQm90dG9tKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCB3YWxscyA9IHNwbGl0R2VvbWV0cnkud2FsbHM7CiAgICAgICAgICAgIG9wdGlvbnMud2FsbCA9IHRydWU7CiAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgd2FsbHMubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgICBjb25zdCB3YWxsID0gd2FsbHNba107CiAgICAgICAgICAgICAgb3B0aW9ucy5nZW9tZXRyeSA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHRFeHRydWRlZCgKICAgICAgICAgICAgICAgIHdhbGwuZ2VvbWV0cnksCiAgICAgICAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAgICAgICBleHRydWRlZEhlaWdodCwKICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB3YWxsLmdlb21ldHJ5ID0gY29tcHV0ZUF0dHJpYnV0ZXMob3B0aW9ucyk7CiAgICAgICAgICAgICAgZ2VvbWV0cmllcy5wdXNoKHdhbGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwb2x5Z29ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCBnZW9tZXRyeUluc3RhbmNlID0gbmV3IEdlb21ldHJ5SW5zdGFuY2VfZGVmYXVsdCh7CiAgICAgICAgICAgICAgZ2VvbWV0cnk6IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnMoCiAgICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgICBwb2x5Z29uc1tpXSwKICAgICAgICAgICAgICAgIGhhc1RleHR1cmVDb29yZGluYXRlcyA/IHRleHR1cmVDb29yZGluYXRlUG9seWdvbnNbaV0gOiB2b2lkIDAsCiAgICAgICAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0LAogICAgICAgICAgICAgICAgdmVydGV4Rm9ybWF0LAogICAgICAgICAgICAgICAgYXJjVHlwZQogICAgICAgICAgICAgICkKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGdlb21ldHJ5SW5zdGFuY2UuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgICAgICAgICAgZ2VvbWV0cnlJbnN0YW5jZS5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICFwZXJQb3NpdGlvbkhlaWdodAogICAgICAgICAgICApOwogICAgICAgICAgICBvcHRpb25zLmdlb21ldHJ5ID0gZ2VvbWV0cnlJbnN0YW5jZS5nZW9tZXRyeTsKICAgICAgICAgICAgZ2VvbWV0cnlJbnN0YW5jZS5nZW9tZXRyeSA9IGNvbXB1dGVBdHRyaWJ1dGVzKG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHBvbHlnb25HZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlKSkgewogICAgICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IGdlb21ldHJ5SW5zdGFuY2UuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoOwogICAgICAgICAgICAgIGNvbnN0IG9mZnNldFZhbHVlID0gcG9seWdvbkdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgICAgIGNvbnN0IGFwcGx5T2Zmc2V0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoIC8gMykuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgICAgICAgICAgZ2VvbWV0cnlJbnN0YW5jZS5nZW9tZXRyeS5hdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgICAgICAgIHZhbHVlczogYXBwbHlPZmZzZXQKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGdlb21ldHJpZXMucHVzaChnZW9tZXRyeUluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQuY29tYmluZUluc3RhbmNlcyhnZW9tZXRyaWVzKVswXTsKICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyA9IG5ldyBGbG9hdDY0QXJyYXkoCiAgICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcwogICAgICAgICk7CiAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoIC8gMywKICAgICAgICAgIGdlb21ldHJ5LmluZGljZXMKICAgICAgICApOwogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tVmVydGljZXMoCiAgICAgICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcwogICAgICAgICk7CiAgICAgICAgaWYgKCF2ZXJ0ZXhGb3JtYXQucG9zaXRpb24pIHsKICAgICAgICAgIGRlbGV0ZSBhdHRyaWJ1dGVzLnBvc2l0aW9uOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXM6IGdlb21ldHJ5LmluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBnZW9tZXRyeS5wcmltaXRpdmVUeXBlLAogICAgICAgICAgYm91bmRpbmdTcGhlcmUsCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHBvbHlnb25HZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFBvbHlnb25HZW9tZXRyeS5jcmVhdGVTaGFkb3dWb2x1bWUgPSBmdW5jdGlvbihwb2x5Z29uR2VvbWV0cnksIG1pbkhlaWdodEZ1bmMsIG1heEhlaWdodEZ1bmMpIHsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IHBvbHlnb25HZW9tZXRyeS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gcG9seWdvbkdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgbWluSGVpZ2h0ID0gbWluSGVpZ2h0RnVuYyhncmFudWxhcml0eSwgZWxsaXBzb2lkKTsKICAgICAgICBjb25zdCBtYXhIZWlnaHQgPSBtYXhIZWlnaHRGdW5jKGdyYW51bGFyaXR5LCBlbGxpcHNvaWQpOwogICAgICAgIHJldHVybiBuZXcgUG9seWdvbkdlb21ldHJ5KHsKICAgICAgICAgIHBvbHlnb25IaWVyYXJjaHk6IHBvbHlnb25HZW9tZXRyeS5fcG9seWdvbkhpZXJhcmNoeSwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHN0Um90YXRpb246IHBvbHlnb25HZW9tZXRyeS5fc3RSb3RhdGlvbiwKICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgcGVyUG9zaXRpb25IZWlnaHQ6IGZhbHNlLAogICAgICAgICAgZXh0cnVkZWRIZWlnaHQ6IG1pbkhlaWdodCwKICAgICAgICAgIGhlaWdodDogbWF4SGVpZ2h0LAogICAgICAgICAgdmVydGV4Rm9ybWF0OiBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5QT1NJVElPTl9PTkxZLAogICAgICAgICAgc2hhZG93Vm9sdW1lOiB0cnVlLAogICAgICAgICAgYXJjVHlwZTogcG9seWdvbkdlb21ldHJ5Ll9hcmNUeXBlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFBvbHlnb25HZW9tZXRyeS5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHJlY3RhbmdsZTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhpcy5fcmVjdGFuZ2xlKSkgewogICAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHRoaXMuX3BvbHlnb25IaWVyYXJjaHkucG9zaXRpb25zOwogICAgICAgICAgICAgIHRoaXMuX3JlY3RhbmdsZSA9IFBvbHlnb25HZW9tZXRyeS5jb21wdXRlUmVjdGFuZ2xlRnJvbVBvc2l0aW9ucygKICAgICAgICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgICAgICAgIHRoaXMuX2VsbGlwc29pZCwKICAgICAgICAgICAgICAgIHRoaXMuX2FyY1R5cGUKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9yZWN0YW5nbGU7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBGb3IgcmVtYXBwaW5nIHRleHR1cmUgY29vcmRpbmF0ZXMgd2hlbiByZW5kZXJpbmcgUG9seWdvbkdlb21ldHJpZXMgYXMgR3JvdW5kUHJpbWl0aXZlcy4KICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHRleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHM6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHRoaXMuX3RleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHMpKSB7CiAgICAgICAgICAgICAgdGhpcy5fdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50cyA9IHRleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHMyKAogICAgICAgICAgICAgICAgdGhpcwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3RleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgUG9seWdvbkdlb21ldHJ5X2RlZmF1bHQgPSBQb2x5Z29uR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVQb2x5Z29uR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlUG9seWdvbkdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVQb2x5Z29uR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlUG9seWdvbkdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVQb2x5Z29uR2VvbWV0cnkocG9seWdvbkdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBwb2x5Z29uR2VvbWV0cnkgPSBQb2x5Z29uR2VvbWV0cnlfZGVmYXVsdC51bnBhY2socG9seWdvbkdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgcG9seWdvbkdlb21ldHJ5Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShwb2x5Z29uR2VvbWV0cnkuX2VsbGlwc29pZCk7CiAgICByZXR1cm4gUG9seWdvbkdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkocG9seWdvbkdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZVBvbHlnb25HZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVBvbHlnb25HZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUG9seWdvbkdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfUG9seWdvbkdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZVBvbHlnb25HZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlUG9seWdvbkdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWdvbk91dGxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uczIoZWxsaXBzb2lkLCBwb3NpdGlvbnMsIG1pbkRpc3RhbmNlLCBwZXJQb3NpdGlvbkhlaWdodCwgYXJjVHlwZSkgewogICAgY29uc3QgdGFuZ2VudFBsYW5lID0gRWxsaXBzb2lkVGFuZ2VudFBsYW5lX2RlZmF1bHQuZnJvbVBvaW50cyhwb3NpdGlvbnMsIGVsbGlwc29pZCk7CiAgICBjb25zdCBwb3NpdGlvbnMyRCA9IHRhbmdlbnRQbGFuZS5wcm9qZWN0UG9pbnRzT250b1BsYW5lKAogICAgICBwb3NpdGlvbnMsCiAgICAgIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc1Bvc2l0aW9ucwogICAgKTsKICAgIGNvbnN0IG9yaWdpbmFsV2luZGluZ09yZGVyID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuY29tcHV0ZVdpbmRpbmdPcmRlcjJEKAogICAgICBwb3NpdGlvbnMyRAogICAgKTsKICAgIGlmIChvcmlnaW5hbFdpbmRpbmdPcmRlciA9PT0gV2luZGluZ09yZGVyX2RlZmF1bHQuQ0xPQ0tXSVNFKSB7CiAgICAgIHBvc2l0aW9uczJELnJldmVyc2UoKTsKICAgICAgcG9zaXRpb25zID0gcG9zaXRpb25zLnNsaWNlKCkucmV2ZXJzZSgpOwogICAgfQogICAgbGV0IHN1YmRpdmlkZWRQb3NpdGlvbnM7CiAgICBsZXQgaTsKICAgIGxldCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGlmICghcGVyUG9zaXRpb25IZWlnaHQpIHsKICAgICAgbGV0IG51bVZlcnRpY2VzID0gMDsKICAgICAgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQykgewogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgbnVtVmVydGljZXMgKz0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnN1YmRpdmlkZUxpbmVDb3VudCgKICAgICAgICAgICAgcG9zaXRpb25zW2ldLAogICAgICAgICAgICBwb3NpdGlvbnNbKGkgKyAxKSAlIGxlbmd0aF0sCiAgICAgICAgICAgIG1pbkRpc3RhbmNlCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIG51bVZlcnRpY2VzICs9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5zdWJkaXZpZGVSaHVtYkxpbmVDb3VudCgKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgIHBvc2l0aW9uc1soaSArIDEpICUgbGVuZ3RoXSwKICAgICAgICAgICAgbWluRGlzdGFuY2UKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KG51bVZlcnRpY2VzICogMyk7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGxldCB0ZW1wUG9zaXRpb25zOwogICAgICAgIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpIHsKICAgICAgICAgIHRlbXBQb3NpdGlvbnMgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuc3ViZGl2aWRlTGluZSgKICAgICAgICAgICAgcG9zaXRpb25zW2ldLAogICAgICAgICAgICBwb3NpdGlvbnNbKGkgKyAxKSAlIGxlbmd0aF0sCiAgICAgICAgICAgIG1pbkRpc3RhbmNlLAogICAgICAgICAgICBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnNTdWJkaXZpZGVkCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgICAgICB0ZW1wUG9zaXRpb25zID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnN1YmRpdmlkZVJodW1iTGluZSgKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgIHBvc2l0aW9uc1soaSArIDEpICUgbGVuZ3RoXSwKICAgICAgICAgICAgbWluRGlzdGFuY2UsCiAgICAgICAgICAgIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc1N1YmRpdmlkZWQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHRlbXBQb3NpdGlvbnNMZW5ndGggPSB0ZW1wUG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHRlbXBQb3NpdGlvbnNMZW5ndGg7ICsraikgewogICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1tpbmRleCsrXSA9IHRlbXBQb3NpdGlvbnNbal07CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBzdWJkaXZpZGVkUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShsZW5ndGggKiAyICogMyk7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IHAwID0gcG9zaXRpb25zW2ldOwogICAgICAgIGNvbnN0IHAxID0gcG9zaXRpb25zWyhpICsgMSkgJSBsZW5ndGhdOwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMC54OwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMC55OwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMC56OwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMS54OwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMS55OwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMS56OwogICAgICB9CiAgICB9CiAgICBsZW5ndGggPSBzdWJkaXZpZGVkUG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICBjb25zdCBpbmRpY2VzU2l6ZSA9IGxlbmd0aCAqIDI7CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobGVuZ3RoLCBpbmRpY2VzU2l6ZSk7CiAgICBpbmRleCA9IDA7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gaSArIDE7CiAgICB9CiAgICBpbmRpY2VzW2luZGV4KytdID0gbGVuZ3RoIC0gMTsKICAgIGluZGljZXNbaW5kZXgrK10gPSAwOwogICAgcmV0dXJuIG5ldyBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQoewogICAgICBnZW9tZXRyeTogbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgIGF0dHJpYnV0ZXM6IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCh7CiAgICAgICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogc3ViZGl2aWRlZFBvc2l0aW9ucwogICAgICAgICAgfSkKICAgICAgICB9KSwKICAgICAgICBpbmRpY2VzLAogICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUwogICAgICB9KQogICAgfSk7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc0V4dHJ1ZGVkMihlbGxpcHNvaWQsIHBvc2l0aW9ucywgbWluRGlzdGFuY2UsIHBlclBvc2l0aW9uSGVpZ2h0LCBhcmNUeXBlKSB7CiAgICBjb25zdCB0YW5nZW50UGxhbmUgPSBFbGxpcHNvaWRUYW5nZW50UGxhbmVfZGVmYXVsdC5mcm9tUG9pbnRzKHBvc2l0aW9ucywgZWxsaXBzb2lkKTsKICAgIGNvbnN0IHBvc2l0aW9uczJEID0gdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludHNPbnRvUGxhbmUoCiAgICAgIHBvc2l0aW9ucywKICAgICAgY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zUG9zaXRpb25zCiAgICApOwogICAgY29uc3Qgb3JpZ2luYWxXaW5kaW5nT3JkZXIgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5jb21wdXRlV2luZGluZ09yZGVyMkQoCiAgICAgIHBvc2l0aW9uczJECiAgICApOwogICAgaWYgKG9yaWdpbmFsV2luZGluZ09yZGVyID09PSBXaW5kaW5nT3JkZXJfZGVmYXVsdC5DTE9DS1dJU0UpIHsKICAgICAgcG9zaXRpb25zMkQucmV2ZXJzZSgpOwogICAgICBwb3NpdGlvbnMgPSBwb3NpdGlvbnMuc2xpY2UoKS5yZXZlcnNlKCk7CiAgICB9CiAgICBsZXQgc3ViZGl2aWRlZFBvc2l0aW9uczsKICAgIGxldCBpOwogICAgbGV0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICBjb25zdCBjb3JuZXJzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICBsZXQgaW5kZXggPSAwOwogICAgaWYgKCFwZXJQb3NpdGlvbkhlaWdodCkgewogICAgICBsZXQgbnVtVmVydGljZXMgPSAwOwogICAgICBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDKSB7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBudW1WZXJ0aWNlcyArPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuc3ViZGl2aWRlTGluZUNvdW50KAogICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgIHBvc2l0aW9uc1soaSArIDEpICUgbGVuZ3RoXSwKICAgICAgICAgICAgbWluRGlzdGFuY2UKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5SSFVNQikgewogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgbnVtVmVydGljZXMgKz0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnN1YmRpdmlkZVJodW1iTGluZUNvdW50KAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIHBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgcG9zaXRpb25zWyhpICsgMSkgJSBsZW5ndGhdLAogICAgICAgICAgICBtaW5EaXN0YW5jZQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkobnVtVmVydGljZXMgKiAzICogMik7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgIGNvcm5lcnNbaV0gPSBpbmRleCAvIDM7CiAgICAgICAgbGV0IHRlbXBQb3NpdGlvbnM7CiAgICAgICAgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQykgewogICAgICAgICAgdGVtcFBvc2l0aW9ucyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5zdWJkaXZpZGVMaW5lKAogICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgIHBvc2l0aW9uc1soaSArIDEpICUgbGVuZ3RoXSwKICAgICAgICAgICAgbWluRGlzdGFuY2UsCiAgICAgICAgICAgIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc1N1YmRpdmlkZWQKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgICAgIHRlbXBQb3NpdGlvbnMgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuc3ViZGl2aWRlUmh1bWJMaW5lKAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIHBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgcG9zaXRpb25zWyhpICsgMSkgJSBsZW5ndGhdLAogICAgICAgICAgICBtaW5EaXN0YW5jZSwKICAgICAgICAgICAgY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zU3ViZGl2aWRlZAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdGVtcFBvc2l0aW9uc0xlbmd0aCA9IHRlbXBQb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgdGVtcFBvc2l0aW9uc0xlbmd0aDsgKytqKSB7CiAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zW2luZGV4KytdID0gdGVtcFBvc2l0aW9uc1tqXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KGxlbmd0aCAqIDIgKiAzICogMik7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgIGNvcm5lcnNbaV0gPSBpbmRleCAvIDM7CiAgICAgICAgY29uc3QgcDAgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgY29uc3QgcDEgPSBwb3NpdGlvbnNbKGkgKyAxKSAlIGxlbmd0aF07CiAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1tpbmRleCsrXSA9IHAwLng7CiAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1tpbmRleCsrXSA9IHAwLnk7CiAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1tpbmRleCsrXSA9IHAwLno7CiAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1tpbmRleCsrXSA9IHAxLng7CiAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1tpbmRleCsrXSA9IHAxLnk7CiAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1tpbmRleCsrXSA9IHAxLno7CiAgICAgIH0KICAgIH0KICAgIGxlbmd0aCA9IHN1YmRpdmlkZWRQb3NpdGlvbnMubGVuZ3RoIC8gKDMgKiAyKTsKICAgIGNvbnN0IGNvcm5lcnNMZW5ndGggPSBjb3JuZXJzLmxlbmd0aDsKICAgIGNvbnN0IGluZGljZXNTaXplID0gKGxlbmd0aCAqIDIgKyBjb3JuZXJzTGVuZ3RoKSAqIDI7CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIGxlbmd0aCArIGNvcm5lcnNMZW5ndGgsCiAgICAgIGluZGljZXNTaXplCiAgICApOwogICAgaW5kZXggPSAwOwogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gKGkgKyAxKSAlIGxlbmd0aDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGkgKyBsZW5ndGg7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSAoaSArIDEpICUgbGVuZ3RoICsgbGVuZ3RoOwogICAgfQogICAgZm9yIChpID0gMDsgaSA8IGNvcm5lcnNMZW5ndGg7IGkrKykgewogICAgICBjb25zdCBjb3JuZXIgPSBjb3JuZXJzW2ldOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gY29ybmVyOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gY29ybmVyICsgbGVuZ3RoOwogICAgfQogICAgcmV0dXJuIG5ldyBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQoewogICAgICBnZW9tZXRyeTogbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgIGF0dHJpYnV0ZXM6IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCh7CiAgICAgICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogc3ViZGl2aWRlZFBvc2l0aW9ucwogICAgICAgICAgfSkKICAgICAgICB9KSwKICAgICAgICBpbmRpY2VzLAogICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUwogICAgICB9KQogICAgfSk7CiAgfQogIGZ1bmN0aW9uIFBvbHlnb25PdXRsaW5lR2VvbWV0cnkob3B0aW9ucykgewogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvcHRpb25zIiwgb3B0aW9ucyk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm9wdGlvbnMucG9seWdvbkhpZXJhcmNoeSIsIG9wdGlvbnMucG9seWdvbkhpZXJhcmNoeSk7CiAgICBpZiAob3B0aW9ucy5wZXJQb3NpdGlvbkhlaWdodCAmJiBkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5oZWlnaHQpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJDYW5ub3QgdXNlIGJvdGggb3B0aW9ucy5wZXJQb3NpdGlvbkhlaWdodCBhbmQgb3B0aW9ucy5oZWlnaHQiCiAgICAgICk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuYXJjVHlwZSkgJiYgb3B0aW9ucy5hcmNUeXBlICE9PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMgJiYgb3B0aW9ucy5hcmNUeXBlICE9PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIkludmFsaWQgYXJjVHlwZS4gVmFsaWQgb3B0aW9ucyBhcmUgQXJjVHlwZS5HRU9ERVNJQyBhbmQgQXJjVHlwZS5SSFVNQi4iCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBwb2x5Z29uSGllcmFyY2h5ID0gb3B0aW9ucy5wb2x5Z29uSGllcmFyY2h5OwogICAgY29uc3QgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICk7CiAgICBjb25zdCBwZXJQb3NpdGlvbkhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMucGVyUG9zaXRpb25IZWlnaHQsIGZhbHNlKTsKICAgIGNvbnN0IHBlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZSA9IHBlclBvc2l0aW9uSGVpZ2h0ICYmIGRlZmluZWRfZGVmYXVsdChvcHRpb25zLmV4dHJ1ZGVkSGVpZ2h0KTsKICAgIGNvbnN0IGFyY1R5cGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmFyY1R5cGUsIEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQyk7CiAgICBsZXQgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5oZWlnaHQsIDApOwogICAgbGV0IGV4dHJ1ZGVkSGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5leHRydWRlZEhlaWdodCwgaGVpZ2h0KTsKICAgIGlmICghcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlKSB7CiAgICAgIGNvbnN0IGggPSBNYXRoLm1heChoZWlnaHQsIGV4dHJ1ZGVkSGVpZ2h0KTsKICAgICAgZXh0cnVkZWRIZWlnaHQgPSBNYXRoLm1pbihoZWlnaHQsIGV4dHJ1ZGVkSGVpZ2h0KTsKICAgICAgaGVpZ2h0ID0gaDsKICAgIH0KICAgIHRoaXMuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCk7CiAgICB0aGlzLl9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgdGhpcy5faGVpZ2h0ID0gaGVpZ2h0OwogICAgdGhpcy5fZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgIHRoaXMuX2FyY1R5cGUgPSBhcmNUeXBlOwogICAgdGhpcy5fcG9seWdvbkhpZXJhcmNoeSA9IHBvbHlnb25IaWVyYXJjaHk7CiAgICB0aGlzLl9wZXJQb3NpdGlvbkhlaWdodCA9IHBlclBvc2l0aW9uSGVpZ2h0OwogICAgdGhpcy5fcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlID0gcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlOwogICAgdGhpcy5fb2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZVBvbHlnb25PdXRsaW5lR2VvbWV0cnkiOwogICAgdGhpcy5wYWNrZWRMZW5ndGggPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZUhpZXJhcmNoeVBhY2tlZExlbmd0aCgKICAgICAgcG9seWdvbkhpZXJhcmNoeSwKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0CiAgICApICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgODsKICB9CiAgdmFyIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc1Bvc2l0aW9ucywgY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zU3ViZGl2aWRlZCwgc2NyYXRjaEVsbGlwc29pZDcsIGR1bW15T3B0aW9uczIsIFBvbHlnb25PdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9Qb2x5Z29uT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5Z29uT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9BcmNUeXBlKCk7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0VsbGlwc29pZFRhbmdlbnRQbGFuZSgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeUluc3RhbmNlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeVBpcGVsaW5lKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9Qb2x5Z29uR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIGluaXRfUG9seWdvblBpcGVsaW5lKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1dpbmRpbmdPcmRlcigpOwogICAgICBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnNQb3NpdGlvbnMgPSBbXTsKICAgICAgY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zU3ViZGl2aWRlZCA9IFtdOwogICAgICBQb2x5Z29uT3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQucGFja1BvbHlnb25IaWVyYXJjaHkoCiAgICAgICAgICB2YWx1ZS5fcG9seWdvbkhpZXJhcmNoeSwKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdAogICAgICAgICk7CiAgICAgICAgRWxsaXBzb2lkX2RlZmF1bHQucGFjayh2YWx1ZS5fZWxsaXBzb2lkLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9oZWlnaHQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9leHRydWRlZEhlaWdodDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2dyYW51bGFyaXR5OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9wZXJQb3NpdGlvbkhlaWdodCA/IDEgOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fYXJjVHlwZTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmFsdWUuX29mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gdmFsdWUucGFja2VkTGVuZ3RoOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaEVsbGlwc29pZDcgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShFbGxpcHNvaWRfZGVmYXVsdC5VTklUX1NQSEVSRSk7CiAgICAgIGR1bW15T3B0aW9uczIgPSB7CiAgICAgICAgcG9seWdvbkhpZXJhcmNoeToge30KICAgICAgfTsKICAgICAgUG9seWdvbk91dGxpbmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgcG9seWdvbkhpZXJhcmNoeSA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC51bnBhY2tQb2x5Z29uSGllcmFyY2h5KAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0CiAgICAgICAgKTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gcG9seWdvbkhpZXJhcmNoeS5zdGFydGluZ0luZGV4OwogICAgICAgIGRlbGV0ZSBwb2x5Z29uSGllcmFyY2h5LnN0YXJ0aW5nSW5kZXg7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoRWxsaXBzb2lkNyk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHBlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPT09IDE7CiAgICAgICAgY29uc3QgcGVyUG9zaXRpb25IZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIGNvbnN0IGFyY1R5cGUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IG9mZnNldEF0dHJpYnV0ZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgcGFja2VkTGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFBvbHlnb25PdXRsaW5lR2VvbWV0cnkoZHVtbXlPcHRpb25zMik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcG9seWdvbkhpZXJhcmNoeSA9IHBvbHlnb25IaWVyYXJjaHk7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQsIHJlc3VsdC5fZWxsaXBzb2lkKTsKICAgICAgICByZXN1bHQuX2hlaWdodCA9IGhlaWdodDsKICAgICAgICByZXN1bHQuX2V4dHJ1ZGVkSGVpZ2h0ID0gZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgcmVzdWx0Ll9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgIHJlc3VsdC5fcGVyUG9zaXRpb25IZWlnaHQgPSBwZXJQb3NpdGlvbkhlaWdodDsKICAgICAgICByZXN1bHQuX3BlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZSA9IHBlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZTsKICAgICAgICByZXN1bHQuX2FyY1R5cGUgPSBhcmNUeXBlOwogICAgICAgIHJlc3VsdC5fb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICByZXN1bHQucGFja2VkTGVuZ3RoID0gcGFja2VkTGVuZ3RoOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFBvbHlnb25PdXRsaW5lR2VvbWV0cnkuZnJvbVBvc2l0aW9ucyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9wdGlvbnMucG9zaXRpb25zIiwgb3B0aW9ucy5wb3NpdGlvbnMpOwogICAgICAgIGNvbnN0IG5ld09wdGlvbnMgPSB7CiAgICAgICAgICBwb2x5Z29uSGllcmFyY2h5OiB7CiAgICAgICAgICAgIHBvc2l0aW9uczogb3B0aW9ucy5wb3NpdGlvbnMKICAgICAgICAgIH0sCiAgICAgICAgICBoZWlnaHQ6IG9wdGlvbnMuaGVpZ2h0LAogICAgICAgICAgZXh0cnVkZWRIZWlnaHQ6IG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQsCiAgICAgICAgICBlbGxpcHNvaWQ6IG9wdGlvbnMuZWxsaXBzb2lkLAogICAgICAgICAgZ3JhbnVsYXJpdHk6IG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgICAgICBwZXJQb3NpdGlvbkhlaWdodDogb3B0aW9ucy5wZXJQb3NpdGlvbkhlaWdodCwKICAgICAgICAgIGFyY1R5cGU6IG9wdGlvbnMuYXJjVHlwZSwKICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZTogb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9OwogICAgICAgIHJldHVybiBuZXcgUG9seWdvbk91dGxpbmVHZW9tZXRyeShuZXdPcHRpb25zKTsKICAgICAgfTsKICAgICAgUG9seWdvbk91dGxpbmVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKHBvbHlnb25HZW9tZXRyeSkgewogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHBvbHlnb25HZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gcG9seWdvbkdlb21ldHJ5Ll9ncmFudWxhcml0eTsKICAgICAgICBjb25zdCBwb2x5Z29uSGllcmFyY2h5ID0gcG9seWdvbkdlb21ldHJ5Ll9wb2x5Z29uSGllcmFyY2h5OwogICAgICAgIGNvbnN0IHBlclBvc2l0aW9uSGVpZ2h0ID0gcG9seWdvbkdlb21ldHJ5Ll9wZXJQb3NpdGlvbkhlaWdodDsKICAgICAgICBjb25zdCBhcmNUeXBlID0gcG9seWdvbkdlb21ldHJ5Ll9hcmNUeXBlOwogICAgICAgIGNvbnN0IHBvbHlnb25zID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnBvbHlnb25PdXRsaW5lc0Zyb21IaWVyYXJjaHkoCiAgICAgICAgICBwb2x5Z29uSGllcmFyY2h5LAogICAgICAgICAgIXBlclBvc2l0aW9uSGVpZ2h0LAogICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgKTsKICAgICAgICBpZiAocG9seWdvbnMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBsZXQgZ2VvbWV0cnlJbnN0YW5jZTsKICAgICAgICBjb25zdCBnZW9tZXRyaWVzID0gW107CiAgICAgICAgY29uc3QgbWluRGlzdGFuY2UgPSBNYXRoX2RlZmF1bHQuY2hvcmRMZW5ndGgoCiAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgIGVsbGlwc29pZC5tYXhpbXVtUmFkaXVzCiAgICAgICAgKTsKICAgICAgICBjb25zdCBoZWlnaHQgPSBwb2x5Z29uR2VvbWV0cnkuX2hlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IHBvbHlnb25HZW9tZXRyeS5fZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgY29uc3QgZXh0cnVkZSA9IHBvbHlnb25HZW9tZXRyeS5fcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlIHx8ICFNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihoZWlnaHQsIGV4dHJ1ZGVkSGVpZ2h0LCAwLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjIpOwogICAgICAgIGxldCBvZmZzZXRWYWx1ZTsKICAgICAgICBsZXQgaTsKICAgICAgICBpZiAoZXh0cnVkZSkgewogICAgICAgICAgZm9yIChpID0gMDsgaSA8IHBvbHlnb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGdlb21ldHJ5SW5zdGFuY2UgPSBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnNFeHRydWRlZDIoCiAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgIHBvbHlnb25zW2ldLAogICAgICAgICAgICAgIG1pbkRpc3RhbmNlLAogICAgICAgICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0LAogICAgICAgICAgICAgIGFyY1R5cGUKICAgICAgICAgICAgKTsKICAgICAgICAgICAgZ2VvbWV0cnlJbnN0YW5jZS5nZW9tZXRyeSA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHRFeHRydWRlZCgKICAgICAgICAgICAgICBnZW9tZXRyeUluc3RhbmNlLmdlb21ldHJ5LAogICAgICAgICAgICAgIGhlaWdodCwKICAgICAgICAgICAgICBleHRydWRlZEhlaWdodCwKICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgcGVyUG9zaXRpb25IZWlnaHQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChwb2x5Z29uR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgICAgICBjb25zdCBzaXplID0gZ2VvbWV0cnlJbnN0YW5jZS5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGggLyAzOwogICAgICAgICAgICAgIGxldCBvZmZzZXRBdHRyaWJ1dGUgPSBuZXcgVWludDhBcnJheShzaXplKTsKICAgICAgICAgICAgICBpZiAocG9seWdvbkdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuVE9QKSB7CiAgICAgICAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUuZmlsbCgxLCAwLCBzaXplIC8gMik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG9mZnNldFZhbHVlID0gcG9seWdvbkdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgICAgICAgb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBnZW9tZXRyeUluc3RhbmNlLmdlb21ldHJ5LmF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCgKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICAgICAgICAgICAgdmFsdWVzOiBvZmZzZXRBdHRyaWJ1dGUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGdlb21ldHJpZXMucHVzaChnZW9tZXRyeUluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yIChpID0gMDsgaSA8IHBvbHlnb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGdlb21ldHJ5SW5zdGFuY2UgPSBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnMyKAogICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICBwb2x5Z29uc1tpXSwKICAgICAgICAgICAgICBtaW5EaXN0YW5jZSwKICAgICAgICAgICAgICBwZXJQb3NpdGlvbkhlaWdodCwKICAgICAgICAgICAgICBhcmNUeXBlCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGdlb21ldHJ5SW5zdGFuY2UuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgICAgICAgICAgZ2VvbWV0cnlJbnN0YW5jZS5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICFwZXJQb3NpdGlvbkhlaWdodAogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHBvbHlnb25HZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlKSkgewogICAgICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IGdlb21ldHJ5SW5zdGFuY2UuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoOwogICAgICAgICAgICAgIG9mZnNldFZhbHVlID0gcG9seWdvbkdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgICAgIGNvbnN0IGFwcGx5T2Zmc2V0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoIC8gMykuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgICAgICAgICAgZ2VvbWV0cnlJbnN0YW5jZS5nZW9tZXRyeS5hdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgICAgICAgIHZhbHVlczogYXBwbHlPZmZzZXQKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGdlb21ldHJpZXMucHVzaChnZW9tZXRyeUluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQuY29tYmluZUluc3RhbmNlcyhnZW9tZXRyaWVzKVswXTsKICAgICAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVZlcnRpY2VzKAogICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMKICAgICAgICApOwogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzOiBnZW9tZXRyeS5hdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlczogZ2VvbWV0cnkuaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZSwKICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZTogcG9seWdvbkdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUG9seWdvbk91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gUG9seWdvbk91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVBvbHlnb25PdXRsaW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5KHBvbHlnb25HZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgcG9seWdvbkdlb21ldHJ5ID0gUG9seWdvbk91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhwb2x5Z29uR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICBwb2x5Z29uR2VvbWV0cnkuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKHBvbHlnb25HZW9tZXRyeS5fZWxsaXBzb2lkKTsKICAgIHJldHVybiBQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkocG9seWdvbkdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZVBvbHlnb25PdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfUG9seWdvbk91dGxpbmVHZW9tZXRyeSgpOwogICAgICBjcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29sb3IuanMKICBmdW5jdGlvbiBodWUycmdiKG0xLCBtMiwgaCkgewogICAgaWYgKGggPCAwKSB7CiAgICAgIGggKz0gMTsKICAgIH0KICAgIGlmIChoID4gMSkgewogICAgICBoIC09IDE7CiAgICB9CiAgICBpZiAoaCAqIDYgPCAxKSB7CiAgICAgIHJldHVybiBtMSArIChtMiAtIG0xKSAqIDYgKiBoOwogICAgfQogICAgaWYgKGggKiAyIDwgMSkgewogICAgICByZXR1cm4gbTI7CiAgICB9CiAgICBpZiAoaCAqIDMgPCAyKSB7CiAgICAgIHJldHVybiBtMSArIChtMiAtIG0xKSAqICgyIC8gMyAtIGgpICogNjsKICAgIH0KICAgIHJldHVybiBtMTsKICB9CiAgZnVuY3Rpb24gQ29sb3IocmVkLCBncmVlbiwgYmx1ZSwgYWxwaGEpIHsKICAgIHRoaXMucmVkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQocmVkLCAxKTsKICAgIHRoaXMuZ3JlZW4gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChncmVlbiwgMSk7CiAgICB0aGlzLmJsdWUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChibHVlLCAxKTsKICAgIHRoaXMuYWxwaGEgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChhbHBoYSwgMSk7CiAgfQogIHZhciBzY3JhdGNoQXJyYXlCdWZmZXIsIHNjcmF0Y2hVaW50MzJBcnJheSwgc2NyYXRjaFVpbnQ4QXJyYXksIHJnYmFNYXRjaGVyLCBycmdnYmJhYU1hdGNoZXIsIHJnYlBhcmVudGhlc2VzTWF0Y2hlciwgaHNsUGFyZW50aGVzZXNNYXRjaGVyLCBDb2xvcl9kZWZhdWx0OwogIHZhciBpbml0X0NvbG9yID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db2xvci5qcyIoKSB7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRmVhdHVyZURldGVjdGlvbigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgQ29sb3IuZnJvbUNhcnRlc2lhbjQgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDb2xvcihjYXJ0ZXNpYW4xMS54LCBjYXJ0ZXNpYW4xMS55LCBjYXJ0ZXNpYW4xMS56LCBjYXJ0ZXNpYW4xMS53KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnJlZCA9IGNhcnRlc2lhbjExLng7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gY2FydGVzaWFuMTEueTsKICAgICAgICByZXN1bHQuYmx1ZSA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgcmVzdWx0LmFscGhhID0gY2FydGVzaWFuMTEudzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5mcm9tQnl0ZXMgPSBmdW5jdGlvbihyZWQsIGdyZWVuLCBibHVlLCBhbHBoYSwgcmVzdWx0KSB7CiAgICAgICAgcmVkID0gQ29sb3IuYnl0ZVRvRmxvYXQoZGVmYXVsdFZhbHVlX2RlZmF1bHQocmVkLCAyNTUpKTsKICAgICAgICBncmVlbiA9IENvbG9yLmJ5dGVUb0Zsb2F0KGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGdyZWVuLCAyNTUpKTsKICAgICAgICBibHVlID0gQ29sb3IuYnl0ZVRvRmxvYXQoZGVmYXVsdFZhbHVlX2RlZmF1bHQoYmx1ZSwgMjU1KSk7CiAgICAgICAgYWxwaGEgPSBDb2xvci5ieXRlVG9GbG9hdChkZWZhdWx0VmFsdWVfZGVmYXVsdChhbHBoYSwgMjU1KSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDb2xvcihyZWQsIGdyZWVuLCBibHVlLCBhbHBoYSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5yZWQgPSByZWQ7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gZ3JlZW47CiAgICAgICAgcmVzdWx0LmJsdWUgPSBibHVlOwogICAgICAgIHJlc3VsdC5hbHBoYSA9IGFscGhhOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvbG9yLmZyb21BbHBoYSA9IGZ1bmN0aW9uKGNvbG9yLCBhbHBoYSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjb2xvciIsIGNvbG9yKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImFscGhhIiwgYWxwaGEpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ29sb3IoY29sb3IucmVkLCBjb2xvci5ncmVlbiwgY29sb3IuYmx1ZSwgYWxwaGEpOwogICAgICAgIH0KICAgICAgICByZXN1bHQucmVkID0gY29sb3IucmVkOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IGNvbG9yLmdyZWVuOwogICAgICAgIHJlc3VsdC5ibHVlID0gY29sb3IuYmx1ZTsKICAgICAgICByZXN1bHQuYWxwaGEgPSBhbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBpZiAoRmVhdHVyZURldGVjdGlvbl9kZWZhdWx0LnN1cHBvcnRzVHlwZWRBcnJheXMoKSkgewogICAgICAgIHNjcmF0Y2hBcnJheUJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcig0KTsKICAgICAgICBzY3JhdGNoVWludDMyQXJyYXkgPSBuZXcgVWludDMyQXJyYXkoc2NyYXRjaEFycmF5QnVmZmVyKTsKICAgICAgICBzY3JhdGNoVWludDhBcnJheSA9IG5ldyBVaW50OEFycmF5KHNjcmF0Y2hBcnJheUJ1ZmZlcik7CiAgICAgIH0KICAgICAgQ29sb3IuZnJvbVJnYmEgPSBmdW5jdGlvbihyZ2JhLCByZXN1bHQpIHsKICAgICAgICBzY3JhdGNoVWludDMyQXJyYXlbMF0gPSByZ2JhOwogICAgICAgIHJldHVybiBDb2xvci5mcm9tQnl0ZXMoCiAgICAgICAgICBzY3JhdGNoVWludDhBcnJheVswXSwKICAgICAgICAgIHNjcmF0Y2hVaW50OEFycmF5WzFdLAogICAgICAgICAgc2NyYXRjaFVpbnQ4QXJyYXlbMl0sCiAgICAgICAgICBzY3JhdGNoVWludDhBcnJheVszXSwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIENvbG9yLmZyb21Ic2wgPSBmdW5jdGlvbihodWUsIHNhdHVyYXRpb24sIGxpZ2h0bmVzcywgYWxwaGEsIHJlc3VsdCkgewogICAgICAgIGh1ZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGh1ZSwgMCkgJSAxOwogICAgICAgIHNhdHVyYXRpb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzYXR1cmF0aW9uLCAwKTsKICAgICAgICBsaWdodG5lc3MgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChsaWdodG5lc3MsIDApOwogICAgICAgIGFscGhhID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoYWxwaGEsIDEpOwogICAgICAgIGxldCByZWQgPSBsaWdodG5lc3M7CiAgICAgICAgbGV0IGdyZWVuID0gbGlnaHRuZXNzOwogICAgICAgIGxldCBibHVlID0gbGlnaHRuZXNzOwogICAgICAgIGlmIChzYXR1cmF0aW9uICE9PSAwKSB7CiAgICAgICAgICBsZXQgbTI7CiAgICAgICAgICBpZiAobGlnaHRuZXNzIDwgMC41KSB7CiAgICAgICAgICAgIG0yID0gbGlnaHRuZXNzICogKDEgKyBzYXR1cmF0aW9uKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG0yID0gbGlnaHRuZXNzICsgc2F0dXJhdGlvbiAtIGxpZ2h0bmVzcyAqIHNhdHVyYXRpb247CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBtMSA9IDIgKiBsaWdodG5lc3MgLSBtMjsKICAgICAgICAgIHJlZCA9IGh1ZTJyZ2IobTEsIG0yLCBodWUgKyAxIC8gMyk7CiAgICAgICAgICBncmVlbiA9IGh1ZTJyZ2IobTEsIG0yLCBodWUpOwogICAgICAgICAgYmx1ZSA9IGh1ZTJyZ2IobTEsIG0yLCBodWUgLSAxIC8gMyk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ29sb3IocmVkLCBncmVlbiwgYmx1ZSwgYWxwaGEpOwogICAgICAgIH0KICAgICAgICByZXN1bHQucmVkID0gcmVkOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IGdyZWVuOwogICAgICAgIHJlc3VsdC5ibHVlID0gYmx1ZTsKICAgICAgICByZXN1bHQuYWxwaGEgPSBhbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5mcm9tUmFuZG9tID0gZnVuY3Rpb24ob3B0aW9ucywgcmVzdWx0KSB7CiAgICAgICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICAgICAgbGV0IHJlZCA9IG9wdGlvbnMucmVkOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlZCkpIHsKICAgICAgICAgIGNvbnN0IG1pbmltdW1SZWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm1pbmltdW1SZWQsIDApOwogICAgICAgICAgY29uc3QgbWF4aW11bVJlZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWF4aW11bVJlZCwgMSk7CiAgICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygibWluaW11bVJlZCIsIG1pbmltdW1SZWQsIG1heGltdW1SZWQpOwogICAgICAgICAgcmVkID0gbWluaW11bVJlZCArIE1hdGhfZGVmYXVsdC5uZXh0UmFuZG9tTnVtYmVyKCkgKiAobWF4aW11bVJlZCAtIG1pbmltdW1SZWQpOwogICAgICAgIH0KICAgICAgICBsZXQgZ3JlZW4gPSBvcHRpb25zLmdyZWVuOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdyZWVuKSkgewogICAgICAgICAgY29uc3QgbWluaW11bUdyZWVuID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5taW5pbXVtR3JlZW4sIDApOwogICAgICAgICAgY29uc3QgbWF4aW11bUdyZWVuID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5tYXhpbXVtR3JlZW4sIDEpOwogICAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoCiAgICAgICAgICAgICJtaW5pbXVtR3JlZW4iLAogICAgICAgICAgICBtaW5pbXVtR3JlZW4sCiAgICAgICAgICAgIG1heGltdW1HcmVlbgogICAgICAgICAgKTsKICAgICAgICAgIGdyZWVuID0gbWluaW11bUdyZWVuICsgTWF0aF9kZWZhdWx0Lm5leHRSYW5kb21OdW1iZXIoKSAqIChtYXhpbXVtR3JlZW4gLSBtaW5pbXVtR3JlZW4pOwogICAgICAgIH0KICAgICAgICBsZXQgYmx1ZSA9IG9wdGlvbnMuYmx1ZTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChibHVlKSkgewogICAgICAgICAgY29uc3QgbWluaW11bUJsdWUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm1pbmltdW1CbHVlLCAwKTsKICAgICAgICAgIGNvbnN0IG1heGltdW1CbHVlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5tYXhpbXVtQmx1ZSwgMSk7CiAgICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygKICAgICAgICAgICAgIm1pbmltdW1CbHVlIiwKICAgICAgICAgICAgbWluaW11bUJsdWUsCiAgICAgICAgICAgIG1heGltdW1CbHVlCiAgICAgICAgICApOwogICAgICAgICAgYmx1ZSA9IG1pbmltdW1CbHVlICsgTWF0aF9kZWZhdWx0Lm5leHRSYW5kb21OdW1iZXIoKSAqIChtYXhpbXVtQmx1ZSAtIG1pbmltdW1CbHVlKTsKICAgICAgICB9CiAgICAgICAgbGV0IGFscGhhID0gb3B0aW9ucy5hbHBoYTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhbHBoYSkpIHsKICAgICAgICAgIGNvbnN0IG1pbmltdW1BbHBoYSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWluaW11bUFscGhhLCAwKTsKICAgICAgICAgIGNvbnN0IG1heGltdW1BbHBoYSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWF4aW11bUFscGhhLCAxKTsKICAgICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKAogICAgICAgICAgICAibWludW11bUFscGhhIiwKICAgICAgICAgICAgbWluaW11bUFscGhhLAogICAgICAgICAgICBtYXhpbXVtQWxwaGEKICAgICAgICAgICk7CiAgICAgICAgICBhbHBoYSA9IG1pbmltdW1BbHBoYSArIE1hdGhfZGVmYXVsdC5uZXh0UmFuZG9tTnVtYmVyKCkgKiAobWF4aW11bUFscGhhIC0gbWluaW11bUFscGhhKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDb2xvcihyZWQsIGdyZWVuLCBibHVlLCBhbHBoYSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5yZWQgPSByZWQ7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gZ3JlZW47CiAgICAgICAgcmVzdWx0LmJsdWUgPSBibHVlOwogICAgICAgIHJlc3VsdC5hbHBoYSA9IGFscGhhOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHJnYmFNYXRjaGVyID0gL14jKFswLTlhLWZdKShbMC05YS1mXSkoWzAtOWEtZl0pKFswLTlhLWZdKT8kL2k7CiAgICAgIHJyZ2diYmFhTWF0Y2hlciA9IC9eIyhbMC05YS1mXXsyfSkoWzAtOWEtZl17Mn0pKFswLTlhLWZdezJ9KShbMC05YS1mXXsyfSk/JC9pOwogICAgICByZ2JQYXJlbnRoZXNlc01hdGNoZXIgPSAvXnJnYmE/XHMqXChccyooWzAtOS5dKyU/KVxzKlssXHNdK1xzKihbMC05Ll0rJT8pXHMqWyxcc10rXHMqKFswLTkuXSslPykoPzpccypbLFxzL10rXHMqKFswLTkuXSspKT9ccypcKSQvaTsKICAgICAgaHNsUGFyZW50aGVzZXNNYXRjaGVyID0gL15oc2xhP1xzKlwoXHMqKFswLTkuXSspXHMqWyxcc10rXHMqKFswLTkuXSslKVxzKlssXHNdK1xzKihbMC05Ll0rJSkoPzpccypbLFxzL10rXHMqKFswLTkuXSspKT9ccypcKSQvaTsKICAgICAgQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nID0gZnVuY3Rpb24oY29sb3IsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLnN0cmluZygiY29sb3IiLCBjb2xvcik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENvbG9yKCk7CiAgICAgICAgfQogICAgICAgIGNvbG9yID0gY29sb3IudHJpbSgpOwogICAgICAgIGNvbnN0IG5hbWVkQ29sb3IgPSBDb2xvcltjb2xvci50b1VwcGVyQ2FzZSgpXTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG5hbWVkQ29sb3IpKSB7CiAgICAgICAgICBDb2xvci5jbG9uZShuYW1lZENvbG9yLCByZXN1bHQpOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgbGV0IG1hdGNoZXMgPSByZ2JhTWF0Y2hlci5leGVjKGNvbG9yKTsKICAgICAgICBpZiAobWF0Y2hlcyAhPT0gbnVsbCkgewogICAgICAgICAgcmVzdWx0LnJlZCA9IHBhcnNlSW50KG1hdGNoZXNbMV0sIDE2KSAvIDE1OwogICAgICAgICAgcmVzdWx0LmdyZWVuID0gcGFyc2VJbnQobWF0Y2hlc1syXSwgMTYpIC8gMTU7CiAgICAgICAgICByZXN1bHQuYmx1ZSA9IHBhcnNlSW50KG1hdGNoZXNbM10sIDE2KSAvIDE1OwogICAgICAgICAgcmVzdWx0LmFscGhhID0gcGFyc2VJbnQoZGVmYXVsdFZhbHVlX2RlZmF1bHQobWF0Y2hlc1s0XSwgImYiKSwgMTYpIC8gMTU7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBtYXRjaGVzID0gcnJnZ2JiYWFNYXRjaGVyLmV4ZWMoY29sb3IpOwogICAgICAgIGlmIChtYXRjaGVzICE9PSBudWxsKSB7CiAgICAgICAgICByZXN1bHQucmVkID0gcGFyc2VJbnQobWF0Y2hlc1sxXSwgMTYpIC8gMjU1OwogICAgICAgICAgcmVzdWx0LmdyZWVuID0gcGFyc2VJbnQobWF0Y2hlc1syXSwgMTYpIC8gMjU1OwogICAgICAgICAgcmVzdWx0LmJsdWUgPSBwYXJzZUludChtYXRjaGVzWzNdLCAxNikgLyAyNTU7CiAgICAgICAgICByZXN1bHQuYWxwaGEgPSBwYXJzZUludChkZWZhdWx0VmFsdWVfZGVmYXVsdChtYXRjaGVzWzRdLCAiZmYiKSwgMTYpIC8gMjU1OwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgbWF0Y2hlcyA9IHJnYlBhcmVudGhlc2VzTWF0Y2hlci5leGVjKGNvbG9yKTsKICAgICAgICBpZiAobWF0Y2hlcyAhPT0gbnVsbCkgewogICAgICAgICAgcmVzdWx0LnJlZCA9IHBhcnNlRmxvYXQobWF0Y2hlc1sxXSkgLyAoIiUiID09PSBtYXRjaGVzWzFdLnN1YnN0cigtMSkgPyAxMDAgOiAyNTUpOwogICAgICAgICAgcmVzdWx0LmdyZWVuID0gcGFyc2VGbG9hdChtYXRjaGVzWzJdKSAvICgiJSIgPT09IG1hdGNoZXNbMl0uc3Vic3RyKC0xKSA/IDEwMCA6IDI1NSk7CiAgICAgICAgICByZXN1bHQuYmx1ZSA9IHBhcnNlRmxvYXQobWF0Y2hlc1szXSkgLyAoIiUiID09PSBtYXRjaGVzWzNdLnN1YnN0cigtMSkgPyAxMDAgOiAyNTUpOwogICAgICAgICAgcmVzdWx0LmFscGhhID0gcGFyc2VGbG9hdChkZWZhdWx0VmFsdWVfZGVmYXVsdChtYXRjaGVzWzRdLCAiMS4wIikpOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgbWF0Y2hlcyA9IGhzbFBhcmVudGhlc2VzTWF0Y2hlci5leGVjKGNvbG9yKTsKICAgICAgICBpZiAobWF0Y2hlcyAhPT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIENvbG9yLmZyb21Ic2woCiAgICAgICAgICAgIHBhcnNlRmxvYXQobWF0Y2hlc1sxXSkgLyAzNjAsCiAgICAgICAgICAgIHBhcnNlRmxvYXQobWF0Y2hlc1syXSkgLyAxMDAsCiAgICAgICAgICAgIHBhcnNlRmxvYXQobWF0Y2hlc1szXSkgLyAxMDAsCiAgICAgICAgICAgIHBhcnNlRmxvYXQoZGVmYXVsdFZhbHVlX2RlZmF1bHQobWF0Y2hlc1s0XSwgIjEuMCIpKSwKICAgICAgICAgICAgcmVzdWx0CiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSB2b2lkIDA7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29sb3IucGFja2VkTGVuZ3RoID0gNDsKICAgICAgQ29sb3IucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLnJlZDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuZ3JlZW47CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLmJsdWU7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5hbHBoYTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIENvbG9yLnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ29sb3IoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnJlZCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LmdyZWVuID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQuYmx1ZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LmFscGhhID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29sb3IuYnl0ZVRvRmxvYXQgPSBmdW5jdGlvbihudW1iZXIpIHsKICAgICAgICByZXR1cm4gbnVtYmVyIC8gMjU1OwogICAgICB9OwogICAgICBDb2xvci5mbG9hdFRvQnl0ZSA9IGZ1bmN0aW9uKG51bWJlcikgewogICAgICAgIHJldHVybiBudW1iZXIgPT09IDEgPyAyNTUgOiBudW1iZXIgKiAyNTYgfCAwOwogICAgICB9OwogICAgICBDb2xvci5jbG9uZSA9IGZ1bmN0aW9uKGNvbG9yLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjb2xvcikpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ29sb3IoY29sb3IucmVkLCBjb2xvci5ncmVlbiwgY29sb3IuYmx1ZSwgY29sb3IuYWxwaGEpOwogICAgICAgIH0KICAgICAgICByZXN1bHQucmVkID0gY29sb3IucmVkOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IGNvbG9yLmdyZWVuOwogICAgICAgIHJlc3VsdC5ibHVlID0gY29sb3IuYmx1ZTsKICAgICAgICByZXN1bHQuYWxwaGEgPSBjb2xvci5hbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCAvLwogICAgICAgIGRlZmluZWRfZGVmYXVsdChsZWZ0KSAmJiAvLwogICAgICAgIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgLy8KICAgICAgICBsZWZ0LnJlZCA9PT0gcmlnaHQucmVkICYmIC8vCiAgICAgICAgbGVmdC5ncmVlbiA9PT0gcmlnaHQuZ3JlZW4gJiYgLy8KICAgICAgICBsZWZ0LmJsdWUgPT09IHJpZ2h0LmJsdWUgJiYgLy8KICAgICAgICBsZWZ0LmFscGhhID09PSByaWdodC5hbHBoYTsKICAgICAgfTsKICAgICAgQ29sb3IuZXF1YWxzQXJyYXkgPSBmdW5jdGlvbihjb2xvciwgYXJyYXksIG9mZnNldCkgewogICAgICAgIHJldHVybiBjb2xvci5yZWQgPT09IGFycmF5W29mZnNldF0gJiYgY29sb3IuZ3JlZW4gPT09IGFycmF5W29mZnNldCArIDFdICYmIGNvbG9yLmJsdWUgPT09IGFycmF5W29mZnNldCArIDJdICYmIGNvbG9yLmFscGhhID09PSBhcnJheVtvZmZzZXQgKyAzXTsKICAgICAgfTsKICAgICAgQ29sb3IucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIENvbG9yLmNsb25lKHRoaXMsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIENvbG9yLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihvdGhlcikgewogICAgICAgIHJldHVybiBDb2xvci5lcXVhbHModGhpcywgb3RoZXIpOwogICAgICB9OwogICAgICBDb2xvci5wcm90b3R5cGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKG90aGVyLCBlcHNpbG9uKSB7CiAgICAgICAgcmV0dXJuIHRoaXMgPT09IG90aGVyIHx8IC8vCiAgICAgICAgZGVmaW5lZF9kZWZhdWx0KG90aGVyKSAmJiAvLwogICAgICAgIE1hdGguYWJzKHRoaXMucmVkIC0gb3RoZXIucmVkKSA8PSBlcHNpbG9uICYmIC8vCiAgICAgICAgTWF0aC5hYnModGhpcy5ncmVlbiAtIG90aGVyLmdyZWVuKSA8PSBlcHNpbG9uICYmIC8vCiAgICAgICAgTWF0aC5hYnModGhpcy5ibHVlIC0gb3RoZXIuYmx1ZSkgPD0gZXBzaWxvbiAmJiAvLwogICAgICAgIE1hdGguYWJzKHRoaXMuYWxwaGEgLSBvdGhlci5hbHBoYSkgPD0gZXBzaWxvbjsKICAgICAgfTsKICAgICAgQ29sb3IucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGAoJHt0aGlzLnJlZH0sICR7dGhpcy5ncmVlbn0sICR7dGhpcy5ibHVlfSwgJHt0aGlzLmFscGhhfSlgOwogICAgICB9OwogICAgICBDb2xvci5wcm90b3R5cGUudG9Dc3NDb2xvclN0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnN0IHJlZCA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMucmVkKTsKICAgICAgICBjb25zdCBncmVlbiA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMuZ3JlZW4pOwogICAgICAgIGNvbnN0IGJsdWUgPSBDb2xvci5mbG9hdFRvQnl0ZSh0aGlzLmJsdWUpOwogICAgICAgIGlmICh0aGlzLmFscGhhID09PSAxKSB7CiAgICAgICAgICByZXR1cm4gYHJnYigke3JlZH0sJHtncmVlbn0sJHtibHVlfSlgOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYHJnYmEoJHtyZWR9LCR7Z3JlZW59LCR7Ymx1ZX0sJHt0aGlzLmFscGhhfSlgOwogICAgICB9OwogICAgICBDb2xvci5wcm90b3R5cGUudG9Dc3NIZXhTdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICBsZXQgciA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMucmVkKS50b1N0cmluZygxNik7CiAgICAgICAgaWYgKHIubGVuZ3RoIDwgMikgewogICAgICAgICAgciA9IGAwJHtyfWA7CiAgICAgICAgfQogICAgICAgIGxldCBnID0gQ29sb3IuZmxvYXRUb0J5dGUodGhpcy5ncmVlbikudG9TdHJpbmcoMTYpOwogICAgICAgIGlmIChnLmxlbmd0aCA8IDIpIHsKICAgICAgICAgIGcgPSBgMCR7Z31gOwogICAgICAgIH0KICAgICAgICBsZXQgYiA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMuYmx1ZSkudG9TdHJpbmcoMTYpOwogICAgICAgIGlmIChiLmxlbmd0aCA8IDIpIHsKICAgICAgICAgIGIgPSBgMCR7Yn1gOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5hbHBoYSA8IDEpIHsKICAgICAgICAgIGxldCBoZXhBbHBoYSA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMuYWxwaGEpLnRvU3RyaW5nKDE2KTsKICAgICAgICAgIGlmIChoZXhBbHBoYS5sZW5ndGggPCAyKSB7CiAgICAgICAgICAgIGhleEFscGhhID0gYDAke2hleEFscGhhfWA7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYCMke3J9JHtnfSR7Yn0ke2hleEFscGhhfWA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBgIyR7cn0ke2d9JHtifWA7CiAgICAgIH07CiAgICAgIENvbG9yLnByb3RvdHlwZS50b0J5dGVzID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgY29uc3QgcmVkID0gQ29sb3IuZmxvYXRUb0J5dGUodGhpcy5yZWQpOwogICAgICAgIGNvbnN0IGdyZWVuID0gQ29sb3IuZmxvYXRUb0J5dGUodGhpcy5ncmVlbik7CiAgICAgICAgY29uc3QgYmx1ZSA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMuYmx1ZSk7CiAgICAgICAgY29uc3QgYWxwaGEgPSBDb2xvci5mbG9hdFRvQnl0ZSh0aGlzLmFscGhhKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gW3JlZCwgZ3JlZW4sIGJsdWUsIGFscGhhXTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gcmVkOwogICAgICAgIHJlc3VsdFsxXSA9IGdyZWVuOwogICAgICAgIHJlc3VsdFsyXSA9IGJsdWU7CiAgICAgICAgcmVzdWx0WzNdID0gYWxwaGE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29sb3IucHJvdG90eXBlLnRvUmdiYSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHNjcmF0Y2hVaW50OEFycmF5WzBdID0gQ29sb3IuZmxvYXRUb0J5dGUodGhpcy5yZWQpOwogICAgICAgIHNjcmF0Y2hVaW50OEFycmF5WzFdID0gQ29sb3IuZmxvYXRUb0J5dGUodGhpcy5ncmVlbik7CiAgICAgICAgc2NyYXRjaFVpbnQ4QXJyYXlbMl0gPSBDb2xvci5mbG9hdFRvQnl0ZSh0aGlzLmJsdWUpOwogICAgICAgIHNjcmF0Y2hVaW50OEFycmF5WzNdID0gQ29sb3IuZmxvYXRUb0J5dGUodGhpcy5hbHBoYSk7CiAgICAgICAgcmV0dXJuIHNjcmF0Y2hVaW50MzJBcnJheVswXTsKICAgICAgfTsKICAgICAgQ29sb3IucHJvdG90eXBlLmJyaWdodGVuID0gZnVuY3Rpb24obWFnbml0dWRlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIm1hZ25pdHVkZSIsIG1hZ25pdHVkZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoIm1hZ25pdHVkZSIsIG1hZ25pdHVkZSwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIG1hZ25pdHVkZSA9IDEgLSBtYWduaXR1ZGU7CiAgICAgICAgcmVzdWx0LnJlZCA9IDEgLSAoMSAtIHRoaXMucmVkKSAqIG1hZ25pdHVkZTsKICAgICAgICByZXN1bHQuZ3JlZW4gPSAxIC0gKDEgLSB0aGlzLmdyZWVuKSAqIG1hZ25pdHVkZTsKICAgICAgICByZXN1bHQuYmx1ZSA9IDEgLSAoMSAtIHRoaXMuYmx1ZSkgKiBtYWduaXR1ZGU7CiAgICAgICAgcmVzdWx0LmFscGhhID0gdGhpcy5hbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5wcm90b3R5cGUuZGFya2VuID0gZnVuY3Rpb24obWFnbml0dWRlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIm1hZ25pdHVkZSIsIG1hZ25pdHVkZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoIm1hZ25pdHVkZSIsIG1hZ25pdHVkZSwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIG1hZ25pdHVkZSA9IDEgLSBtYWduaXR1ZGU7CiAgICAgICAgcmVzdWx0LnJlZCA9IHRoaXMucmVkICogbWFnbml0dWRlOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IHRoaXMuZ3JlZW4gKiBtYWduaXR1ZGU7CiAgICAgICAgcmVzdWx0LmJsdWUgPSB0aGlzLmJsdWUgKiBtYWduaXR1ZGU7CiAgICAgICAgcmVzdWx0LmFscGhhID0gdGhpcy5hbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5wcm90b3R5cGUud2l0aEFscGhhID0gZnVuY3Rpb24oYWxwaGEsIHJlc3VsdCkgewogICAgICAgIHJldHVybiBDb2xvci5mcm9tQWxwaGEodGhpcywgYWxwaGEsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIENvbG9yLmFkZCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQucmVkID0gbGVmdC5yZWQgKyByaWdodC5yZWQ7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gbGVmdC5ncmVlbiArIHJpZ2h0LmdyZWVuOwogICAgICAgIHJlc3VsdC5ibHVlID0gbGVmdC5ibHVlICsgcmlnaHQuYmx1ZTsKICAgICAgICByZXN1bHQuYWxwaGEgPSBsZWZ0LmFscGhhICsgcmlnaHQuYWxwaGE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29sb3Iuc3VidHJhY3QgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnJlZCA9IGxlZnQucmVkIC0gcmlnaHQucmVkOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IGxlZnQuZ3JlZW4gLSByaWdodC5ncmVlbjsKICAgICAgICByZXN1bHQuYmx1ZSA9IGxlZnQuYmx1ZSAtIHJpZ2h0LmJsdWU7CiAgICAgICAgcmVzdWx0LmFscGhhID0gbGVmdC5hbHBoYSAtIHJpZ2h0LmFscGhhOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvbG9yLm11bHRpcGx5ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC5yZWQgPSBsZWZ0LnJlZCAqIHJpZ2h0LnJlZDsKICAgICAgICByZXN1bHQuZ3JlZW4gPSBsZWZ0LmdyZWVuICogcmlnaHQuZ3JlZW47CiAgICAgICAgcmVzdWx0LmJsdWUgPSBsZWZ0LmJsdWUgKiByaWdodC5ibHVlOwogICAgICAgIHJlc3VsdC5hbHBoYSA9IGxlZnQuYWxwaGEgKiByaWdodC5hbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5kaXZpZGUgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnJlZCA9IGxlZnQucmVkIC8gcmlnaHQucmVkOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IGxlZnQuZ3JlZW4gLyByaWdodC5ncmVlbjsKICAgICAgICByZXN1bHQuYmx1ZSA9IGxlZnQuYmx1ZSAvIHJpZ2h0LmJsdWU7CiAgICAgICAgcmVzdWx0LmFscGhhID0gbGVmdC5hbHBoYSAvIHJpZ2h0LmFscGhhOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvbG9yLm1vZCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQucmVkID0gbGVmdC5yZWQgJSByaWdodC5yZWQ7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gbGVmdC5ncmVlbiAlIHJpZ2h0LmdyZWVuOwogICAgICAgIHJlc3VsdC5ibHVlID0gbGVmdC5ibHVlICUgcmlnaHQuYmx1ZTsKICAgICAgICByZXN1bHQuYWxwaGEgPSBsZWZ0LmFscGhhICUgcmlnaHQuYWxwaGE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29sb3IubGVycCA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQsIHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3RhcnQiLCBzdGFydCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJlbmQiLCBlbmQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigidCIsIHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQucmVkID0gTWF0aF9kZWZhdWx0LmxlcnAoc3RhcnQucmVkLCBlbmQucmVkLCB0KTsKICAgICAgICByZXN1bHQuZ3JlZW4gPSBNYXRoX2RlZmF1bHQubGVycChzdGFydC5ncmVlbiwgZW5kLmdyZWVuLCB0KTsKICAgICAgICByZXN1bHQuYmx1ZSA9IE1hdGhfZGVmYXVsdC5sZXJwKHN0YXJ0LmJsdWUsIGVuZC5ibHVlLCB0KTsKICAgICAgICByZXN1bHQuYWxwaGEgPSBNYXRoX2RlZmF1bHQubGVycChzdGFydC5hbHBoYSwgZW5kLmFscGhhLCB0KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5tdWx0aXBseUJ5U2NhbGFyID0gZnVuY3Rpb24oY29sb3IsIHNjYWxhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjb2xvciIsIGNvbG9yKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxhciIsIHNjYWxhcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC5yZWQgPSBjb2xvci5yZWQgKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gY29sb3IuZ3JlZW4gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0LmJsdWUgPSBjb2xvci5ibHVlICogc2NhbGFyOwogICAgICAgIHJlc3VsdC5hbHBoYSA9IGNvbG9yLmFscGhhICogc2NhbGFyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvbG9yLmRpdmlkZUJ5U2NhbGFyID0gZnVuY3Rpb24oY29sb3IsIHNjYWxhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjb2xvciIsIGNvbG9yKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxhciIsIHNjYWxhcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC5yZWQgPSBjb2xvci5yZWQgLyBzY2FsYXI7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gY29sb3IuZ3JlZW4gLyBzY2FsYXI7CiAgICAgICAgcmVzdWx0LmJsdWUgPSBjb2xvci5ibHVlIC8gc2NhbGFyOwogICAgICAgIHJlc3VsdC5hbHBoYSA9IGNvbG9yLmFscGhhIC8gc2NhbGFyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvbG9yLkFMSUNFQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRjBGOEZGIikpOwogICAgICBDb2xvci5BTlRJUVVFV0hJVEUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZBRUJENyIpKTsKICAgICAgQ29sb3IuQVFVQSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMDBGRkZGIikpOwogICAgICBDb2xvci5BUVVBTUFSSU5FID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM3RkZGRDQiKSk7CiAgICAgIENvbG9yLkFaVVJFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGMEZGRkYiKSk7CiAgICAgIENvbG9yLkJFSUdFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGNUY1REMiKSk7CiAgICAgIENvbG9yLkJJU1FVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZFNEM0IikpOwogICAgICBDb2xvci5CTEFDSyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMDAwMDAwIikpOwogICAgICBDb2xvci5CTEFOQ0hFREFMTU9ORCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZFQkNEIikpOwogICAgICBDb2xvci5CTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMwMDAwRkYiKSk7CiAgICAgIENvbG9yLkJMVUVWSU9MRVQgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzhBMkJFMiIpKTsKICAgICAgQ29sb3IuQlJPV04gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0E1MkEyQSIpKTsKICAgICAgQ29sb3IuQlVSTFlXT09EID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNERUI4ODciKSk7CiAgICAgIENvbG9yLkNBREVUQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjNUY5RUEwIikpOwogICAgICBDb2xvci5DSEFSVFJFVVNFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM3RkZGMDAiKSk7CiAgICAgIENvbG9yLkNIT0NPTEFURSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRDI2OTFFIikpOwogICAgICBDb2xvci5DT1JBTCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkY3RjUwIikpOwogICAgICBDb2xvci5DT1JORkxPV0VSQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjNjQ5NUVEIikpOwogICAgICBDb2xvci5DT1JOU0lMSyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZGOERDIikpOwogICAgICBDb2xvci5DUklNU09OID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNEQzE0M0MiKSk7CiAgICAgIENvbG9yLkNZQU4gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwRkZGRiIpKTsKICAgICAgQ29sb3IuREFSS0JMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwMDA4QiIpKTsKICAgICAgQ29sb3IuREFSS0NZQU4gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwOEI4QiIpKTsKICAgICAgQ29sb3IuREFSS0dPTERFTlJPRCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjQjg4NjBCIikpOwogICAgICBDb2xvci5EQVJLR1JBWSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjQTlBOUE5IikpOwogICAgICBDb2xvci5EQVJLR1JFRU4gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwNjQwMCIpKTsKICAgICAgQ29sb3IuREFSS0dSRVkgPSBDb2xvci5EQVJLR1JBWTsKICAgICAgQ29sb3IuREFSS0tIQUtJID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNCREI3NkIiKSk7CiAgICAgIENvbG9yLkRBUktNQUdFTlRBID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM4QjAwOEIiKSk7CiAgICAgIENvbG9yLkRBUktPTElWRUdSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM1NTZCMkYiKSk7CiAgICAgIENvbG9yLkRBUktPUkFOR0UgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGOEMwMCIpKTsKICAgICAgQ29sb3IuREFSS09SQ0hJRCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjOTkzMkNDIikpOwogICAgICBDb2xvci5EQVJLUkVEID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM4QjAwMDAiKSk7CiAgICAgIENvbG9yLkRBUktTQUxNT04gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0U5OTY3QSIpKTsKICAgICAgQ29sb3IuREFSS1NFQUdSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM4RkJDOEYiKSk7CiAgICAgIENvbG9yLkRBUktTTEFURUJMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzQ4M0Q4QiIpKTsKICAgICAgQ29sb3IuREFSS1NMQVRFR1JBWSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMkY0RjRGIikpOwogICAgICBDb2xvci5EQVJLU0xBVEVHUkVZID0gQ29sb3IuREFSS1NMQVRFR1JBWTsKICAgICAgQ29sb3IuREFSS1RVUlFVT0lTRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMDBDRUQxIikpOwogICAgICBDb2xvci5EQVJLVklPTEVUID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM5NDAwRDMiKSk7CiAgICAgIENvbG9yLkRFRVBQSU5LID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRjE0OTMiKSk7CiAgICAgIENvbG9yLkRFRVBTS1lCTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMwMEJGRkYiKSk7CiAgICAgIENvbG9yLkRJTUdSQVkgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzY5Njk2OSIpKTsKICAgICAgQ29sb3IuRElNR1JFWSA9IENvbG9yLkRJTUdSQVk7CiAgICAgIENvbG9yLkRPREdFUkJMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzFFOTBGRiIpKTsKICAgICAgQ29sb3IuRklSRUJSSUNLID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNCMjIyMjIiKSk7CiAgICAgIENvbG9yLkZMT1JBTFdISVRFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkZBRjAiKSk7CiAgICAgIENvbG9yLkZPUkVTVEdSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMyMjhCMjIiKSk7CiAgICAgIENvbG9yLkZVQ0hTSUEgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGMDBGRiIpKTsKICAgICAgQ29sb3IuR0FJTlNCT1JPID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNEQ0RDREMiKSk7CiAgICAgIENvbG9yLkdIT1NUV0hJVEUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0Y4RjhGRiIpKTsKICAgICAgQ29sb3IuR09MRCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZENzAwIikpOwogICAgICBDb2xvci5HT0xERU5ST0QgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0RBQTUyMCIpKTsKICAgICAgQ29sb3IuR1JBWSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjODA4MDgwIikpOwogICAgICBDb2xvci5HUkVFTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMDA4MDAwIikpOwogICAgICBDb2xvci5HUkVFTllFTExPVyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjQURGRjJGIikpOwogICAgICBDb2xvci5HUkVZID0gQ29sb3IuR1JBWTsKICAgICAgQ29sb3IuSE9ORVlERVcgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0YwRkZGMCIpKTsKICAgICAgQ29sb3IuSE9UUElOSyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkY2OUI0IikpOwogICAgICBDb2xvci5JTkRJQU5SRUQgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0NENUM1QyIpKTsKICAgICAgQ29sb3IuSU5ESUdPID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM0QjAwODIiKSk7CiAgICAgIENvbG9yLklWT1JZID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkZGRjAiKSk7CiAgICAgIENvbG9yLktIQUtJID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGMEU2OEMiKSk7CiAgICAgIENvbG9yLkxBVkVOREVSID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNFNkU2RkEiKSk7CiAgICAgIENvbG9yLkxBVkVOREFSX0JMVVNIID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkYwRjUiKSk7CiAgICAgIENvbG9yLkxBV05HUkVFTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjN0NGQzAwIikpOwogICAgICBDb2xvci5MRU1PTkNISUZGT04gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGRkFDRCIpKTsKICAgICAgQ29sb3IuTElHSFRCTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNBREQ4RTYiKSk7CiAgICAgIENvbG9yLkxJR0hUQ09SQUwgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0YwODA4MCIpKTsKICAgICAgQ29sb3IuTElHSFRDWUFOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNFMEZGRkYiKSk7CiAgICAgIENvbG9yLkxJR0hUR09MREVOUk9EWUVMTE9XID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGQUZBRDIiKSk7CiAgICAgIENvbG9yLkxJR0hUR1JBWSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRDNEM0QzIikpOwogICAgICBDb2xvci5MSUdIVEdSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM5MEVFOTAiKSk7CiAgICAgIENvbG9yLkxJR0hUR1JFWSA9IENvbG9yLkxJR0hUR1JBWTsKICAgICAgQ29sb3IuTElHSFRQSU5LID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkI2QzEiKSk7CiAgICAgIENvbG9yLkxJR0hUU0VBR1JFRU4gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzIwQjJBQSIpKTsKICAgICAgQ29sb3IuTElHSFRTS1lCTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM4N0NFRkEiKSk7CiAgICAgIENvbG9yLkxJR0hUU0xBVEVHUkFZID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM3Nzg4OTkiKSk7CiAgICAgIENvbG9yLkxJR0hUU0xBVEVHUkVZID0gQ29sb3IuTElHSFRTTEFURUdSQVk7CiAgICAgIENvbG9yLkxJR0hUU1RFRUxCTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNCMEM0REUiKSk7CiAgICAgIENvbG9yLkxJR0hUWUVMTE9XID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkZGRTAiKSk7CiAgICAgIENvbG9yLkxJTUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwRkYwMCIpKTsKICAgICAgQ29sb3IuTElNRUdSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMzMkNEMzIiKSk7CiAgICAgIENvbG9yLkxJTkVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGQUYwRTYiKSk7CiAgICAgIENvbG9yLk1BR0VOVEEgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGMDBGRiIpKTsKICAgICAgQ29sb3IuTUFST09OID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM4MDAwMDAiKSk7CiAgICAgIENvbG9yLk1FRElVTUFRVUFNQVJJTkUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzY2Q0RBQSIpKTsKICAgICAgQ29sb3IuTUVESVVNQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMDAwMENEIikpOwogICAgICBDb2xvci5NRURJVU1PUkNISUQgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0JBNTVEMyIpKTsKICAgICAgQ29sb3IuTUVESVVNUFVSUExFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM5MzcwREIiKSk7CiAgICAgIENvbG9yLk1FRElVTVNFQUdSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMzQ0IzNzEiKSk7CiAgICAgIENvbG9yLk1FRElVTVNMQVRFQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjN0I2OEVFIikpOwogICAgICBDb2xvci5NRURJVU1TUFJJTkdHUkVFTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMDBGQTlBIikpOwogICAgICBDb2xvci5NRURJVU1UVVJRVU9JU0UgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzQ4RDFDQyIpKTsKICAgICAgQ29sb3IuTUVESVVNVklPTEVUUkVEID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNDNzE1ODUiKSk7CiAgICAgIENvbG9yLk1JRE5JR0hUQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMTkxOTcwIikpOwogICAgICBDb2xvci5NSU5UQ1JFQU0gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0Y1RkZGQSIpKTsKICAgICAgQ29sb3IuTUlTVFlST1NFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkU0RTEiKSk7CiAgICAgIENvbG9yLk1PQ0NBU0lOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkU0QjUiKSk7CiAgICAgIENvbG9yLk5BVkFKT1dISVRFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkRFQUQiKSk7CiAgICAgIENvbG9yLk5BVlkgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwMDA4MCIpKTsKICAgICAgQ29sb3IuT0xETEFDRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkRGNUU2IikpOwogICAgICBDb2xvci5PTElWRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjODA4MDAwIikpOwogICAgICBDb2xvci5PTElWRURSQUIgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzZCOEUyMyIpKTsKICAgICAgQ29sb3IuT1JBTkdFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkE1MDAiKSk7CiAgICAgIENvbG9yLk9SQU5HRVJFRCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkY0NTAwIikpOwogICAgICBDb2xvci5PUkNISUQgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0RBNzBENiIpKTsKICAgICAgQ29sb3IuUEFMRUdPTERFTlJPRCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRUVFOEFBIikpOwogICAgICBDb2xvci5QQUxFR1JFRU4gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzk4RkI5OCIpKTsKICAgICAgQ29sb3IuUEFMRVRVUlFVT0lTRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjQUZFRUVFIikpOwogICAgICBDb2xvci5QQUxFVklPTEVUUkVEID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNEQjcwOTMiKSk7CiAgICAgIENvbG9yLlBBUEFZQVdISVAgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGRUZENSIpKTsKICAgICAgQ29sb3IuUEVBQ0hQVUZGID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkRBQjkiKSk7CiAgICAgIENvbG9yLlBFUlUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0NEODUzRiIpKTsKICAgICAgQ29sb3IuUElOSyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZDMENCIikpOwogICAgICBDb2xvci5QTFVNID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNEREEwREQiKSk7CiAgICAgIENvbG9yLlBPV0RFUkJMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0IwRTBFNiIpKTsKICAgICAgQ29sb3IuUFVSUExFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM4MDAwODAiKSk7CiAgICAgIENvbG9yLlJFRCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkYwMDAwIikpOwogICAgICBDb2xvci5ST1NZQlJPV04gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0JDOEY4RiIpKTsKICAgICAgQ29sb3IuUk9ZQUxCTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM0MTY5RTEiKSk7CiAgICAgIENvbG9yLlNBRERMRUJST1dOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM4QjQ1MTMiKSk7CiAgICAgIENvbG9yLlNBTE1PTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkE4MDcyIikpOwogICAgICBDb2xvci5TQU5EWUJST1dOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGNEE0NjAiKSk7CiAgICAgIENvbG9yLlNFQUdSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMyRThCNTciKSk7CiAgICAgIENvbG9yLlNFQVNIRUxMID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkY1RUUiKSk7CiAgICAgIENvbG9yLlNJRU5OQSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjQTA1MjJEIikpOwogICAgICBDb2xvci5TSUxWRVIgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0MwQzBDMCIpKTsKICAgICAgQ29sb3IuU0tZQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjODdDRUVCIikpOwogICAgICBDb2xvci5TTEFURUJMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzZBNUFDRCIpKTsKICAgICAgQ29sb3IuU0xBVEVHUkFZID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM3MDgwOTAiKSk7CiAgICAgIENvbG9yLlNMQVRFR1JFWSA9IENvbG9yLlNMQVRFR1JBWTsKICAgICAgQ29sb3IuU05PVyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZGQUZBIikpOwogICAgICBDb2xvci5TUFJJTkdHUkVFTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMDBGRjdGIikpOwogICAgICBDb2xvci5TVEVFTEJMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzQ2ODJCNCIpKTsKICAgICAgQ29sb3IuVEFOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNEMkI0OEMiKSk7CiAgICAgIENvbG9yLlRFQUwgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwODA4MCIpKTsKICAgICAgQ29sb3IuVEhJU1RMRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRDhCRkQ4IikpOwogICAgICBDb2xvci5UT01BVE8gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGNjM0NyIpKTsKICAgICAgQ29sb3IuVFVSUVVPSVNFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM0MEUwRDAiKSk7CiAgICAgIENvbG9yLlZJT0xFVCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRUU4MkVFIikpOwogICAgICBDb2xvci5XSEVBVCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRjVERUIzIikpOwogICAgICBDb2xvci5XSElURSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZGRkZGIikpOwogICAgICBDb2xvci5XSElURVNNT0tFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGNUY1RjUiKSk7CiAgICAgIENvbG9yLllFTExPVyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZGRjAwIikpOwogICAgICBDb2xvci5ZRUxMT1dHUkVFTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjOUFDRDMyIikpOwogICAgICBDb2xvci5UUkFOU1BBUkVOVCA9IE9iamVjdC5mcmVlemUobmV3IENvbG9yKDAsIDAsIDAsIDApKTsKICAgICAgQ29sb3JfZGVmYXVsdCA9IENvbG9yOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIGludGVycG9sYXRlQ29sb3JzKHAwLCBwMSwgY29sb3IwLCBjb2xvcjEsIG51bVBvaW50cykgewogICAgY29uc3QgY29sb3JzID0gc2NyYXRjaEludGVycG9sYXRlQ29sb3JzQXJyYXk7CiAgICBjb2xvcnMubGVuZ3RoID0gbnVtUG9pbnRzOwogICAgbGV0IGk7CiAgICBjb25zdCByMCA9IGNvbG9yMC5yZWQ7CiAgICBjb25zdCBnMCA9IGNvbG9yMC5ncmVlbjsKICAgIGNvbnN0IGIwID0gY29sb3IwLmJsdWU7CiAgICBjb25zdCBhMCA9IGNvbG9yMC5hbHBoYTsKICAgIGNvbnN0IHIxID0gY29sb3IxLnJlZDsKICAgIGNvbnN0IGcxID0gY29sb3IxLmdyZWVuOwogICAgY29uc3QgYjEgPSBjb2xvcjEuYmx1ZTsKICAgIGNvbnN0IGExID0gY29sb3IxLmFscGhhOwogICAgaWYgKENvbG9yX2RlZmF1bHQuZXF1YWxzKGNvbG9yMCwgY29sb3IxKSkgewogICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtUG9pbnRzOyBpKyspIHsKICAgICAgICBjb2xvcnNbaV0gPSBDb2xvcl9kZWZhdWx0LmNsb25lKGNvbG9yMCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGNvbG9yczsKICAgIH0KICAgIGNvbnN0IHJlZFBlclZlcnRleCA9IChyMSAtIHIwKSAvIG51bVBvaW50czsKICAgIGNvbnN0IGdyZWVuUGVyVmVydGV4ID0gKGcxIC0gZzApIC8gbnVtUG9pbnRzOwogICAgY29uc3QgYmx1ZVBlclZlcnRleCA9IChiMSAtIGIwKSAvIG51bVBvaW50czsKICAgIGNvbnN0IGFscGhhUGVyVmVydGV4ID0gKGExIC0gYTApIC8gbnVtUG9pbnRzOwogICAgZm9yIChpID0gMDsgaSA8IG51bVBvaW50czsgaSsrKSB7CiAgICAgIGNvbG9yc1tpXSA9IG5ldyBDb2xvcl9kZWZhdWx0KAogICAgICAgIHIwICsgaSAqIHJlZFBlclZlcnRleCwKICAgICAgICBnMCArIGkgKiBncmVlblBlclZlcnRleCwKICAgICAgICBiMCArIGkgKiBibHVlUGVyVmVydGV4LAogICAgICAgIGEwICsgaSAqIGFscGhhUGVyVmVydGV4CiAgICAgICk7CiAgICB9CiAgICByZXR1cm4gY29sb3JzOwogIH0KICBmdW5jdGlvbiBQb2x5bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgcG9zaXRpb25zID0gb3B0aW9ucy5wb3NpdGlvbnM7CiAgICBjb25zdCBjb2xvcnMgPSBvcHRpb25zLmNvbG9yczsKICAgIGNvbnN0IHdpZHRoID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy53aWR0aCwgMSk7CiAgICBjb25zdCBjb2xvcnNQZXJWZXJ0ZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmNvbG9yc1BlclZlcnRleCwgZmFsc2UpOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSB8fCBwb3NpdGlvbnMubGVuZ3RoIDwgMikgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiQXQgbGVhc3QgdHdvIHBvc2l0aW9ucyBhcmUgcmVxdWlyZWQuIik7CiAgICB9CiAgICBpZiAodHlwZW9mIHdpZHRoICE9PSAibnVtYmVyIikgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgid2lkdGggbXVzdCBiZSBhIG51bWJlciIpOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChjb2xvcnMpICYmIChjb2xvcnNQZXJWZXJ0ZXggJiYgY29sb3JzLmxlbmd0aCA8IHBvc2l0aW9ucy5sZW5ndGggfHwgIWNvbG9yc1BlclZlcnRleCAmJiBjb2xvcnMubGVuZ3RoIDwgcG9zaXRpb25zLmxlbmd0aCAtIDEpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjb2xvcnMgaGFzIGFuIGludmFsaWQgbGVuZ3RoLiIpOwogICAgfQogICAgdGhpcy5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgdGhpcy5fY29sb3JzID0gY29sb3JzOwogICAgdGhpcy5fd2lkdGggPSB3aWR0aDsKICAgIHRoaXMuX2NvbG9yc1BlclZlcnRleCA9IGNvbG9yc1BlclZlcnRleDsKICAgIHRoaXMuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnZlcnRleEZvcm1hdCwgVmVydGV4Rm9ybWF0X2RlZmF1bHQuREVGQVVMVCkKICAgICk7CiAgICB0aGlzLl9hcmNUeXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5hcmNUeXBlLCBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpOwogICAgdGhpcy5fZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRQogICAgKTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpCiAgICApOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVQb2x5bGluZUdlb21ldHJ5IjsKICAgIGxldCBudW1Db21wb25lbnRzID0gMSArIHBvc2l0aW9ucy5sZW5ndGggKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgbnVtQ29tcG9uZW50cyArPSBkZWZpbmVkX2RlZmF1bHQoY29sb3JzKSA/IDEgKyBjb2xvcnMubGVuZ3RoICogQ29sb3JfZGVmYXVsdC5wYWNrZWRMZW5ndGggOiAxOwogICAgdGhpcy5wYWNrZWRMZW5ndGggPSBudW1Db21wb25lbnRzICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgNDsKICB9CiAgdmFyIHNjcmF0Y2hJbnRlcnBvbGF0ZUNvbG9yc0FycmF5LCBzY3JhdGNoRWxsaXBzb2lkOCwgc2NyYXRjaFZlcnRleEZvcm1hdDEwLCBzY3JhdGNoT3B0aW9uczE2LCBzY3JhdGNoQ2FydGVzaWFuMzgsIHNjcmF0Y2hQb3NpdGlvbjQsIHNjcmF0Y2hQcmV2UG9zaXRpb24sIHNjcmF0Y2hOZXh0UG9zaXRpb24sIFBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9Qb2x5bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9BcmNUeXBlKCk7CiAgICAgIGluaXRfYXJyYXlSZW1vdmVEdXBsaWNhdGVzKCk7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ29sb3IoKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeVR5cGUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1BvbHlsaW5lUGlwZWxpbmUoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfVmVydGV4Rm9ybWF0KCk7CiAgICAgIHNjcmF0Y2hJbnRlcnBvbGF0ZUNvbG9yc0FycmF5ID0gW107CiAgICAgIFBvbHlsaW5lR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZhbHVlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInZhbHVlIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB2YWx1ZS5fcG9zaXRpb25zOwogICAgICAgIGxldCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBsZW5ndGg7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHBvc2l0aW9uc1tpXSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb2xvcnMgPSB2YWx1ZS5fY29sb3JzOwogICAgICAgIGxlbmd0aCA9IGRlZmluZWRfZGVmYXVsdChjb2xvcnMpID8gY29sb3JzLmxlbmd0aCA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGxlbmd0aDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ29sb3JfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIENvbG9yX2RlZmF1bHQucGFjayhjb2xvcnNbaV0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgRWxsaXBzb2lkX2RlZmF1bHQucGFjayh2YWx1ZS5fZWxsaXBzb2lkLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFjayh2YWx1ZS5fdmVydGV4Rm9ybWF0LCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl93aWR0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2NvbG9yc1BlclZlcnRleCA/IDEgOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fYXJjVHlwZTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQ4ID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoRWxsaXBzb2lkX2RlZmF1bHQuVU5JVF9TUEhFUkUpOwogICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0MTAgPSBuZXcgVmVydGV4Rm9ybWF0X2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE9wdGlvbnMxNiA9IHsKICAgICAgICBwb3NpdGlvbnM6IHZvaWQgMCwKICAgICAgICBjb2xvcnM6IHZvaWQgMCwKICAgICAgICBlbGxpcHNvaWQ6IHNjcmF0Y2hFbGxpcHNvaWQ4LAogICAgICAgIHZlcnRleEZvcm1hdDogc2NyYXRjaFZlcnRleEZvcm1hdDEwLAogICAgICAgIHdpZHRoOiB2b2lkIDAsCiAgICAgICAgY29sb3JzUGVyVmVydGV4OiB2b2lkIDAsCiAgICAgICAgYXJjVHlwZTogdm9pZCAwLAogICAgICAgIGdyYW51bGFyaXR5OiB2b2lkIDAKICAgICAgfTsKICAgICAgUG9seWxpbmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGxldCBpOwogICAgICAgIGxldCBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBwb3NpdGlvbnNbaV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgbGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBjb2xvcnMgPSBsZW5ndGggPiAwID8gbmV3IEFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENvbG9yX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBjb2xvcnNbaV0gPSBDb2xvcl9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaEVsbGlwc29pZDgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQxMAogICAgICAgICk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3Qgd2lkdGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGNvbG9yc1BlclZlcnRleCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPT09IDE7CiAgICAgICAgY29uc3QgYXJjVHlwZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE2LnBvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTYuY29sb3JzID0gY29sb3JzOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNi53aWR0aCA9IHdpZHRoOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNi5jb2xvcnNQZXJWZXJ0ZXggPSBjb2xvcnNQZXJWZXJ0ZXg7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE2LmFyY1R5cGUgPSBhcmNUeXBlOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNi5ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgICAgcmV0dXJuIG5ldyBQb2x5bGluZUdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zMTYpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX3Bvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgICAgICByZXN1bHQuX2NvbG9ycyA9IGNvbG9yczsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCwgcmVzdWx0Ll9lbGxpcHNvaWQpOwogICAgICAgIHJlc3VsdC5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0LCByZXN1bHQuX3ZlcnRleEZvcm1hdCk7CiAgICAgICAgcmVzdWx0Ll93aWR0aCA9IHdpZHRoOwogICAgICAgIHJlc3VsdC5fY29sb3JzUGVyVmVydGV4ID0gY29sb3JzUGVyVmVydGV4OwogICAgICAgIHJlc3VsdC5fYXJjVHlwZSA9IGFyY1R5cGU7CiAgICAgICAgcmVzdWx0Ll9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zOCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBvc2l0aW9uNCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFByZXZQb3NpdGlvbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE5leHRQb3NpdGlvbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgUG9seWxpbmVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKHBvbHlsaW5lR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCB3aWR0aCA9IHBvbHlsaW5lR2VvbWV0cnkuX3dpZHRoOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IHBvbHlsaW5lR2VvbWV0cnkuX3ZlcnRleEZvcm1hdDsKICAgICAgICBsZXQgY29sb3JzID0gcG9seWxpbmVHZW9tZXRyeS5fY29sb3JzOwogICAgICAgIGNvbnN0IGNvbG9yc1BlclZlcnRleCA9IHBvbHlsaW5lR2VvbWV0cnkuX2NvbG9yc1BlclZlcnRleDsKICAgICAgICBjb25zdCBhcmNUeXBlID0gcG9seWxpbmVHZW9tZXRyeS5fYXJjVHlwZTsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IHBvbHlsaW5lR2VvbWV0cnkuX2dyYW51bGFyaXR5OwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHBvbHlsaW5lR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgICAgICBsZXQgaTsKICAgICAgICBsZXQgajsKICAgICAgICBsZXQgazsKICAgICAgICBjb25zdCByZW1vdmVkSW5kaWNlcyA9IFtdOwogICAgICAgIGxldCBwb3NpdGlvbnMgPSBhcnJheVJlbW92ZUR1cGxpY2F0ZXNfZGVmYXVsdCgKICAgICAgICAgIHBvbHlsaW5lR2VvbWV0cnkuX3Bvc2l0aW9ucywKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uLAogICAgICAgICAgZmFsc2UsCiAgICAgICAgICByZW1vdmVkSW5kaWNlcwogICAgICAgICk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChjb2xvcnMpICYmIHJlbW92ZWRJbmRpY2VzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGxldCByZW1vdmVkQXJyYXlJbmRleCA9IDA7CiAgICAgICAgICBsZXQgbmV4dFJlbW92ZWRJbmRleCA9IHJlbW92ZWRJbmRpY2VzWzBdOwogICAgICAgICAgY29sb3JzID0gY29sb3JzLmZpbHRlcihmdW5jdGlvbihjb2xvciwgaW5kZXgyKSB7CiAgICAgICAgICAgIGxldCByZW1vdmUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGNvbG9yc1BlclZlcnRleCkgewogICAgICAgICAgICAgIHJlbW92ZSA9IGluZGV4MiA9PT0gbmV4dFJlbW92ZWRJbmRleCB8fCBpbmRleDIgPT09IDAgJiYgbmV4dFJlbW92ZWRJbmRleCA9PT0gMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZW1vdmUgPSBpbmRleDIgKyAxID09PSBuZXh0UmVtb3ZlZEluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZW1vdmUpIHsKICAgICAgICAgICAgICByZW1vdmVkQXJyYXlJbmRleCsrOwogICAgICAgICAgICAgIG5leHRSZW1vdmVkSW5kZXggPSByZW1vdmVkSW5kaWNlc1tyZW1vdmVkQXJyYXlJbmRleF07CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGxldCBwb3NpdGlvbnNMZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGlmIChwb3NpdGlvbnNMZW5ndGggPCAyIHx8IHdpZHRoIDw9IDApIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMgfHwgYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgICAgICBsZXQgc3ViZGl2aXNpb25TaXplOwogICAgICAgICAgbGV0IG51bWJlck9mUG9pbnRzRnVuY3Rpb247CiAgICAgICAgICBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDKSB7CiAgICAgICAgICAgIHN1YmRpdmlzaW9uU2l6ZSA9IE1hdGhfZGVmYXVsdC5jaG9yZExlbmd0aCgKICAgICAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgICAgICBlbGxpcHNvaWQubWF4aW11bVJhZGl1cwogICAgICAgICAgICApOwogICAgICAgICAgICBudW1iZXJPZlBvaW50c0Z1bmN0aW9uID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0Lm51bWJlck9mUG9pbnRzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3ViZGl2aXNpb25TaXplID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICAgIG51bWJlck9mUG9pbnRzRnVuY3Rpb24gPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQubnVtYmVyT2ZQb2ludHNSaHVtYkxpbmU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBoZWlnaHRzID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmV4dHJhY3RIZWlnaHRzKHBvc2l0aW9ucywgZWxsaXBzb2lkKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoY29sb3JzKSkgewogICAgICAgICAgICBsZXQgY29sb3JMZW5ndGggPSAxOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcG9zaXRpb25zTGVuZ3RoIC0gMTsgKytpKSB7CiAgICAgICAgICAgICAgY29sb3JMZW5ndGggKz0gbnVtYmVyT2ZQb2ludHNGdW5jdGlvbigKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpICsgMV0sCiAgICAgICAgICAgICAgICBzdWJkaXZpc2lvblNpemUKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IG5ld0NvbG9ycyA9IG5ldyBBcnJheShjb2xvckxlbmd0aCk7CiAgICAgICAgICAgIGxldCBuZXdDb2xvckluZGV4ID0gMDsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHBvc2l0aW9uc0xlbmd0aCAtIDE7ICsraSkgewogICAgICAgICAgICAgIGNvbnN0IHAwID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgICAgIGNvbnN0IHAxID0gcG9zaXRpb25zW2kgKyAxXTsKICAgICAgICAgICAgICBjb25zdCBjMCA9IGNvbG9yc1tpXTsKICAgICAgICAgICAgICBjb25zdCBudW1Db2xvcnMgPSBudW1iZXJPZlBvaW50c0Z1bmN0aW9uKHAwLCBwMSwgc3ViZGl2aXNpb25TaXplKTsKICAgICAgICAgICAgICBpZiAoY29sb3JzUGVyVmVydGV4ICYmIGkgPCBjb2xvckxlbmd0aCkgewogICAgICAgICAgICAgICAgY29uc3QgYzEgPSBjb2xvcnNbaSArIDFdOwogICAgICAgICAgICAgICAgY29uc3QgaW50ZXJwb2xhdGVkQ29sb3JzID0gaW50ZXJwb2xhdGVDb2xvcnMoCiAgICAgICAgICAgICAgICAgIHAwLAogICAgICAgICAgICAgICAgICBwMSwKICAgICAgICAgICAgICAgICAgYzAsCiAgICAgICAgICAgICAgICAgIGMxLAogICAgICAgICAgICAgICAgICBudW1Db2xvcnMKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBjb25zdCBpbnRlcnBvbGF0ZWRDb2xvcnNMZW5ndGggPSBpbnRlcnBvbGF0ZWRDb2xvcnMubGVuZ3RoOwogICAgICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IGludGVycG9sYXRlZENvbG9yc0xlbmd0aDsgKytqKSB7CiAgICAgICAgICAgICAgICAgIG5ld0NvbG9yc1tuZXdDb2xvckluZGV4KytdID0gaW50ZXJwb2xhdGVkQ29sb3JzW2pdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgbnVtQ29sb3JzOyArK2opIHsKICAgICAgICAgICAgICAgICAgbmV3Q29sb3JzW25ld0NvbG9ySW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmNsb25lKGMwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV3Q29sb3JzW25ld0NvbG9ySW5kZXhdID0gQ29sb3JfZGVmYXVsdC5jbG9uZShjb2xvcnNbY29sb3JzLmxlbmd0aCAtIDFdKTsKICAgICAgICAgICAgY29sb3JzID0gbmV3Q29sb3JzOwogICAgICAgICAgICBzY3JhdGNoSW50ZXJwb2xhdGVDb2xvcnNBcnJheS5sZW5ndGggPSAwOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQykgewogICAgICAgICAgICBwb3NpdGlvbnMgPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQuZ2VuZXJhdGVDYXJ0ZXNpYW5BcmMoewogICAgICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgICAgICBtaW5EaXN0YW5jZTogc3ViZGl2aXNpb25TaXplLAogICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICBoZWlnaHQ6IGhlaWdodHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwb3NpdGlvbnMgPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQuZ2VuZXJhdGVDYXJ0ZXNpYW5SaHVtYkFyYyh7CiAgICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICAgIGdyYW51bGFyaXR5OiBzdWJkaXZpc2lvblNpemUsCiAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgIGhlaWdodDogaGVpZ2h0cwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcG9zaXRpb25zTGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBjb25zdCBzaXplID0gcG9zaXRpb25zTGVuZ3RoICogNCAtIDQ7CiAgICAgICAgY29uc3QgZmluYWxQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHNpemUgKiAzKTsKICAgICAgICBjb25zdCBwcmV2UG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShzaXplICogMyk7CiAgICAgICAgY29uc3QgbmV4dFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoc2l6ZSAqIDMpOwogICAgICAgIGNvbnN0IGV4cGFuZEFuZFdpZHRoID0gbmV3IEZsb2F0MzJBcnJheShzaXplICogMik7CiAgICAgICAgY29uc3Qgc3QgPSB2ZXJ0ZXhGb3JtYXQuc3QgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUgKiAyKSA6IHZvaWQgMDsKICAgICAgICBjb25zdCBmaW5hbENvbG9ycyA9IGRlZmluZWRfZGVmYXVsdChjb2xvcnMpID8gbmV3IFVpbnQ4QXJyYXkoc2l6ZSAqIDQpIDogdm9pZCAwOwogICAgICAgIGxldCBwb3NpdGlvbkluZGV4ID0gMDsKICAgICAgICBsZXQgZXhwYW5kQW5kV2lkdGhJbmRleCA9IDA7CiAgICAgICAgbGV0IHN0SW5kZXggPSAwOwogICAgICAgIGxldCBjb2xvckluZGV4ID0gMDsKICAgICAgICBsZXQgcG9zaXRpb247CiAgICAgICAgZm9yIChqID0gMDsgaiA8IHBvc2l0aW9uc0xlbmd0aDsgKytqKSB7CiAgICAgICAgICBpZiAoaiA9PT0gMCkgewogICAgICAgICAgICBwb3NpdGlvbiA9IHNjcmF0Y2hDYXJ0ZXNpYW4zODsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHBvc2l0aW9uc1swXSwgcG9zaXRpb25zWzFdLCBwb3NpdGlvbik7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb25zWzBdLCBwb3NpdGlvbiwgcG9zaXRpb24pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcG9zaXRpb24gPSBwb3NpdGlvbnNbaiAtIDFdOwogICAgICAgICAgfQogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHBvc2l0aW9uLCBzY3JhdGNoUHJldlBvc2l0aW9uKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwb3NpdGlvbnNbal0sIHNjcmF0Y2hQb3NpdGlvbjQpOwogICAgICAgICAgaWYgKGogPT09IHBvc2l0aW9uc0xlbmd0aCAtIDEpIHsKICAgICAgICAgICAgcG9zaXRpb24gPSBzY3JhdGNoQ2FydGVzaWFuMzg7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25zTGVuZ3RoIC0gMV0sCiAgICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uc0xlbmd0aCAtIDJdLAogICAgICAgICAgICAgIHBvc2l0aW9uCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb25zW3Bvc2l0aW9uc0xlbmd0aCAtIDFdLCBwb3NpdGlvbiwgcG9zaXRpb24pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcG9zaXRpb24gPSBwb3NpdGlvbnNbaiArIDFdOwogICAgICAgICAgfQogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHBvc2l0aW9uLCBzY3JhdGNoTmV4dFBvc2l0aW9uKTsKICAgICAgICAgIGxldCBjb2xvcjAsIGNvbG9yMTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZmluYWxDb2xvcnMpKSB7CiAgICAgICAgICAgIGlmIChqICE9PSAwICYmICFjb2xvcnNQZXJWZXJ0ZXgpIHsKICAgICAgICAgICAgICBjb2xvcjAgPSBjb2xvcnNbaiAtIDFdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbG9yMCA9IGNvbG9yc1tqXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaiAhPT0gcG9zaXRpb25zTGVuZ3RoIC0gMSkgewogICAgICAgICAgICAgIGNvbG9yMSA9IGNvbG9yc1tqXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY29uc3Qgc3RhcnRLID0gaiA9PT0gMCA/IDIgOiAwOwogICAgICAgICAgY29uc3QgZW5kSyA9IGogPT09IHBvc2l0aW9uc0xlbmd0aCAtIDEgPyAyIDogNDsKICAgICAgICAgIGZvciAoayA9IHN0YXJ0SzsgayA8IGVuZEs7ICsraykgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhzY3JhdGNoUG9zaXRpb240LCBmaW5hbFBvc2l0aW9ucywgcG9zaXRpb25JbmRleCk7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHNjcmF0Y2hQcmV2UG9zaXRpb24sIHByZXZQb3NpdGlvbnMsIHBvc2l0aW9uSW5kZXgpOwogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhzY3JhdGNoTmV4dFBvc2l0aW9uLCBuZXh0UG9zaXRpb25zLCBwb3NpdGlvbkluZGV4KTsKICAgICAgICAgICAgcG9zaXRpb25JbmRleCArPSAzOwogICAgICAgICAgICBjb25zdCBkaXJlY3Rpb24yID0gayAtIDIgPCAwID8gLTEgOiAxOwogICAgICAgICAgICBleHBhbmRBbmRXaWR0aFtleHBhbmRBbmRXaWR0aEluZGV4KytdID0gMiAqIChrICUgMikgLSAxOwogICAgICAgICAgICBleHBhbmRBbmRXaWR0aFtleHBhbmRBbmRXaWR0aEluZGV4KytdID0gZGlyZWN0aW9uMiAqIHdpZHRoOwogICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IGogLyAocG9zaXRpb25zTGVuZ3RoIC0gMSk7CiAgICAgICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IE1hdGgubWF4KGV4cGFuZEFuZFdpZHRoW2V4cGFuZEFuZFdpZHRoSW5kZXggLSAyXSwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChmaW5hbENvbG9ycykpIHsKICAgICAgICAgICAgICBjb25zdCBjb2xvciA9IGsgPCAyID8gY29sb3IwIDogY29sb3IxOwogICAgICAgICAgICAgIGZpbmFsQ29sb3JzW2NvbG9ySW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLnJlZCk7CiAgICAgICAgICAgICAgZmluYWxDb2xvcnNbY29sb3JJbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IuZ3JlZW4pOwogICAgICAgICAgICAgIGZpbmFsQ29sb3JzW2NvbG9ySW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLmJsdWUpOwogICAgICAgICAgICAgIGZpbmFsQ29sb3JzW2NvbG9ySW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLmFscGhhKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICB2YWx1ZXM6IGZpbmFsUG9zaXRpb25zCiAgICAgICAgfSk7CiAgICAgICAgYXR0cmlidXRlcy5wcmV2UG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiBwcmV2UG9zaXRpb25zCiAgICAgICAgfSk7CiAgICAgICAgYXR0cmlidXRlcy5uZXh0UG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiBuZXh0UG9zaXRpb25zCiAgICAgICAgfSk7CiAgICAgICAgYXR0cmlidXRlcy5leHBhbmRBbmRXaWR0aCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICAgIHZhbHVlczogZXhwYW5kQW5kV2lkdGgKICAgICAgICB9KTsKICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICAgICAgdmFsdWVzOiBzdAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZmluYWxDb2xvcnMpKSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLmNvbG9yID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiA0LAogICAgICAgICAgICB2YWx1ZXM6IGZpbmFsQ29sb3JzLAogICAgICAgICAgICBub3JtYWxpemU6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoc2l6ZSwgcG9zaXRpb25zTGVuZ3RoICogNiAtIDYpOwogICAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgICAgbGV0IGluZGljZXNJbmRleCA9IDA7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zTGVuZ3RoIC0gMTsKICAgICAgICBmb3IgKGogPSAwOyBqIDwgbGVuZ3RoOyArK2opIHsKICAgICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaW5kZXg7CiAgICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGluZGV4ICsgMjsKICAgICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaW5kZXggKyAxOwogICAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpbmRleCArIDE7CiAgICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGluZGV4ICsgMjsKICAgICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaW5kZXggKyAzOwogICAgICAgICAgaW5kZXggKz0gNDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21Qb2ludHMocG9zaXRpb25zKSwKICAgICAgICAgIGdlb21ldHJ5VHlwZTogR2VvbWV0cnlUeXBlX2RlZmF1bHQuUE9MWUxJTkVTCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IFBvbHlsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVQb2x5bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZVBvbHlsaW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZVBvbHlsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlUG9seWxpbmVHZW9tZXRyeShwb2x5bGluZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBwb2x5bGluZUdlb21ldHJ5ID0gUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhwb2x5bGluZUdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgcG9seWxpbmVHZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUocG9seWxpbmVHZW9tZXRyeS5fZWxsaXBzb2lkKTsKICAgIHJldHVybiBQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkocG9seWxpbmVHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlUG9seWxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUG9seWxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X1BvbHlsaW5lR2VvbWV0cnkoKTsKICAgICAgY3JlYXRlUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlUG9seWxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlsaW5lVm9sdW1lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBjb21wdXRlQXR0cmlidXRlczIoY29tYmluZWRQb3NpdGlvbnMsIHNoYXBlLCBib3VuZGluZ1JlY3RhbmdsZSwgdmVydGV4Rm9ybWF0KSB7CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICBpZiAodmVydGV4Rm9ybWF0LnBvc2l0aW9uKSB7CiAgICAgIGF0dHJpYnV0ZXMucG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBjb21iaW5lZFBvc2l0aW9ucwogICAgICB9KTsKICAgIH0KICAgIGNvbnN0IHNoYXBlTGVuZ3RoID0gc2hhcGUubGVuZ3RoOwogICAgY29uc3QgdmVydGV4Q291bnQgPSBjb21iaW5lZFBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgY29uc3QgbGVuZ3RoID0gKHZlcnRleENvdW50IC0gc2hhcGVMZW5ndGggKiAyKSAvIChzaGFwZUxlbmd0aCAqIDIpOwogICAgY29uc3QgZmlyc3RFbmRJbmRpY2VzID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQudHJpYW5ndWxhdGUoc2hhcGUpOwogICAgY29uc3QgaW5kaWNlc0NvdW50ID0gKGxlbmd0aCAtIDEpICogc2hhcGVMZW5ndGggKiA2ICsgZmlyc3RFbmRJbmRpY2VzLmxlbmd0aCAqIDI7CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkodmVydGV4Q291bnQsIGluZGljZXNDb3VudCk7CiAgICBsZXQgaSwgajsKICAgIGxldCBsbCwgdWwsIHVyLCBscjsKICAgIGNvbnN0IG9mZnNldCA9IHNoYXBlTGVuZ3RoICogMjsKICAgIGxldCBpbmRleCA9IDA7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgIGZvciAoaiA9IDA7IGogPCBzaGFwZUxlbmd0aCAtIDE7IGorKykgewogICAgICAgIGxsID0gaiAqIDIgKyBpICogc2hhcGVMZW5ndGggKiAyOwogICAgICAgIGxyID0gbGwgKyBvZmZzZXQ7CiAgICAgICAgdWwgPSBsbCArIDE7CiAgICAgICAgdXIgPSB1bCArIG9mZnNldDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdWw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGxsOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB1cjsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdXI7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGxsOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBscjsKICAgICAgfQogICAgICBsbCA9IHNoYXBlTGVuZ3RoICogMiAtIDIgKyBpICogc2hhcGVMZW5ndGggKiAyOwogICAgICB1bCA9IGxsICsgMTsKICAgICAgdXIgPSB1bCArIG9mZnNldDsKICAgICAgbHIgPSBsbCArIG9mZnNldDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHVsOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gbGw7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSB1cjsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHVyOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gbGw7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBscjsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QgfHwgdmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICBjb25zdCBzdCA9IG5ldyBGbG9hdDMyQXJyYXkodmVydGV4Q291bnQgKiAyKTsKICAgICAgY29uc3QgbGVuZ3RoU3QgPSAxIC8gKGxlbmd0aCAtIDEpOwogICAgICBjb25zdCBoZWlnaHRTdCA9IDEgLyBib3VuZGluZ1JlY3RhbmdsZS5oZWlnaHQ7CiAgICAgIGNvbnN0IGhlaWdodE9mZnNldCA9IGJvdW5kaW5nUmVjdGFuZ2xlLmhlaWdodCAvIDI7CiAgICAgIGxldCBzLCB0OwogICAgICBsZXQgc3RpbmRleCA9IDA7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIHMgPSBpICogbGVuZ3RoU3Q7CiAgICAgICAgdCA9IGhlaWdodFN0ICogKHNoYXBlWzBdLnkgKyBoZWlnaHRPZmZzZXQpOwogICAgICAgIHN0W3N0aW5kZXgrK10gPSBzOwogICAgICAgIHN0W3N0aW5kZXgrK10gPSB0OwogICAgICAgIGZvciAoaiA9IDE7IGogPCBzaGFwZUxlbmd0aDsgaisrKSB7CiAgICAgICAgICB0ID0gaGVpZ2h0U3QgKiAoc2hhcGVbal0ueSArIGhlaWdodE9mZnNldCk7CiAgICAgICAgICBzdFtzdGluZGV4KytdID0gczsKICAgICAgICAgIHN0W3N0aW5kZXgrK10gPSB0OwogICAgICAgICAgc3Rbc3RpbmRleCsrXSA9IHM7CiAgICAgICAgICBzdFtzdGluZGV4KytdID0gdDsKICAgICAgICB9CiAgICAgICAgdCA9IGhlaWdodFN0ICogKHNoYXBlWzBdLnkgKyBoZWlnaHRPZmZzZXQpOwogICAgICAgIHN0W3N0aW5kZXgrK10gPSBzOwogICAgICAgIHN0W3N0aW5kZXgrK10gPSB0OwogICAgICB9CiAgICAgIGZvciAoaiA9IDA7IGogPCBzaGFwZUxlbmd0aDsgaisrKSB7CiAgICAgICAgcyA9IDA7CiAgICAgICAgdCA9IGhlaWdodFN0ICogKHNoYXBlW2pdLnkgKyBoZWlnaHRPZmZzZXQpOwogICAgICAgIHN0W3N0aW5kZXgrK10gPSBzOwogICAgICAgIHN0W3N0aW5kZXgrK10gPSB0OwogICAgICB9CiAgICAgIGZvciAoaiA9IDA7IGogPCBzaGFwZUxlbmd0aDsgaisrKSB7CiAgICAgICAgcyA9IChsZW5ndGggLSAxKSAqIGxlbmd0aFN0OwogICAgICAgIHQgPSBoZWlnaHRTdCAqIChzaGFwZVtqXS55ICsgaGVpZ2h0T2Zmc2V0KTsKICAgICAgICBzdFtzdGluZGV4KytdID0gczsKICAgICAgICBzdFtzdGluZGV4KytdID0gdDsKICAgICAgfQogICAgICBhdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgdmFsdWVzOiBuZXcgRmxvYXQzMkFycmF5KHN0KQogICAgICB9KTsKICAgIH0KICAgIGNvbnN0IGVuZE9mZnNldCA9IHZlcnRleENvdW50IC0gc2hhcGVMZW5ndGggKiAyOwogICAgZm9yIChpID0gMDsgaSA8IGZpcnN0RW5kSW5kaWNlcy5sZW5ndGg7IGkgKz0gMykgewogICAgICBjb25zdCB2MDIgPSBmaXJzdEVuZEluZGljZXNbaV0gKyBlbmRPZmZzZXQ7CiAgICAgIGNvbnN0IHYxMiA9IGZpcnN0RW5kSW5kaWNlc1tpICsgMV0gKyBlbmRPZmZzZXQ7CiAgICAgIGNvbnN0IHYyMiA9IGZpcnN0RW5kSW5kaWNlc1tpICsgMl0gKyBlbmRPZmZzZXQ7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSB2MDI7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSB2MTI7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSB2MjI7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSB2MjIgKyBzaGFwZUxlbmd0aDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHYxMiArIHNoYXBlTGVuZ3RoOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gdjAyICsgc2hhcGVMZW5ndGg7CiAgICB9CiAgICBsZXQgZ2VvbWV0cnkgPSBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgIGF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXMsCiAgICAgIGJvdW5kaW5nU3BoZXJlOiBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21WZXJ0aWNlcyhjb21iaW5lZFBvc2l0aW9ucyksCiAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMKICAgIH0pOwogICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgZ2VvbWV0cnkgPSBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQuY29tcHV0ZU5vcm1hbChnZW9tZXRyeSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICB0cnkgewogICAgICAgIGdlb21ldHJ5ID0gR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LmNvbXB1dGVUYW5nZW50QW5kQml0YW5nZW50KGdlb21ldHJ5KTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIG9uZVRpbWVXYXJuaW5nX2RlZmF1bHQoCiAgICAgICAgICAicG9seWxpbmUtdm9sdW1lLXRhbmdlbnQtYml0YW5nZW50IiwKICAgICAgICAgICJVbmFibGUgdG8gY29tcHV0ZSB0YW5nZW50cyBhbmQgYml0YW5nZW50cyBmb3IgcG9seWxpbmUgdm9sdW1lIGdlb21ldHJ5IgogICAgICAgICk7CiAgICAgIH0KICAgICAgaWYgKCF2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMudGFuZ2VudCA9IHZvaWQgMDsKICAgICAgfQogICAgICBpZiAoIXZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLmJpdGFuZ2VudCA9IHZvaWQgMDsKICAgICAgfQogICAgICBpZiAoIXZlcnRleEZvcm1hdC5zdCkgewogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMuc3QgPSB2b2lkIDA7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBnZW9tZXRyeTsKICB9CiAgZnVuY3Rpb24gUG9seWxpbmVWb2x1bWVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG9wdGlvbnMucG9seWxpbmVQb3NpdGlvbnM7CiAgICBjb25zdCBzaGFwZSA9IG9wdGlvbnMuc2hhcGVQb3NpdGlvbnM7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnBvbHlsaW5lUG9zaXRpb25zIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc2hhcGUpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnNoYXBlUG9zaXRpb25zIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgdGhpcy5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgdGhpcy5fc2hhcGUgPSBzaGFwZTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpCiAgICApOwogICAgdGhpcy5fY29ybmVyVHlwZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuY29ybmVyVHlwZSwgQ29ybmVyVHlwZV9kZWZhdWx0LlJPVU5ERUQpOwogICAgdGhpcy5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUoCiAgICAgIGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMudmVydGV4Rm9ybWF0LCBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5ERUZBVUxUKQogICAgKTsKICAgIHRoaXMuX2dyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICk7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnkiOwogICAgbGV0IG51bUNvbXBvbmVudHMgPSAxICsgcG9zaXRpb25zLmxlbmd0aCAqIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICBudW1Db21wb25lbnRzICs9IDEgKyBzaGFwZS5sZW5ndGggKiBDYXJ0ZXNpYW4yX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgdGhpcy5wYWNrZWRMZW5ndGggPSBudW1Db21wb25lbnRzICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMjsKICB9CiAgdmFyIHNjcmF0Y2hFbGxpcHNvaWQ5LCBzY3JhdGNoVmVydGV4Rm9ybWF0MTEsIHNjcmF0Y2hPcHRpb25zMTcsIGJyU2NyYXRjaCwgUG9seWxpbmVWb2x1bWVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1BvbHlsaW5lVm9sdW1lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlsaW5lVm9sdW1lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2FycmF5UmVtb3ZlRHVwbGljYXRlcygpOwogICAgICBpbml0X0JvdW5kaW5nUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfQ29ybmVyVHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeVBpcGVsaW5lKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9vbmVUaW1lV2FybmluZygpOwogICAgICBpbml0X1BvbHlnb25QaXBlbGluZSgpOwogICAgICBpbml0X1BvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1ZlcnRleEZvcm1hdCgpOwogICAgICBpbml0X1dpbmRpbmdPcmRlcigpOwogICAgICBQb2x5bGluZVZvbHVtZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2YWx1ZSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gdmFsdWUuX3Bvc2l0aW9uczsKICAgICAgICBsZXQgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhwb3NpdGlvbnNbaV0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc2hhcGUgPSB2YWx1ZS5fc2hhcGU7CiAgICAgICAgbGVuZ3RoID0gc2hhcGUubGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBsZW5ndGg7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrKHNoYXBlW2ldLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIEVsbGlwc29pZF9kZWZhdWx0LnBhY2sodmFsdWUuX2VsbGlwc29pZCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2sodmFsdWUuX3ZlcnRleEZvcm1hdCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fY29ybmVyVHlwZTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQ5ID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoRWxsaXBzb2lkX2RlZmF1bHQuVU5JVF9TUEhFUkUpOwogICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0MTEgPSBuZXcgVmVydGV4Rm9ybWF0X2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE9wdGlvbnMxNyA9IHsKICAgICAgICBwb2x5bGluZVBvc2l0aW9uczogdm9pZCAwLAogICAgICAgIHNoYXBlUG9zaXRpb25zOiB2b2lkIDAsCiAgICAgICAgZWxsaXBzb2lkOiBzY3JhdGNoRWxsaXBzb2lkOSwKICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IHNjcmF0Y2hWZXJ0ZXhGb3JtYXQxMSwKICAgICAgICBjb3JuZXJUeXBlOiB2b2lkIDAsCiAgICAgICAgZ3JhbnVsYXJpdHk6IHZvaWQgMAogICAgICB9OwogICAgICBQb2x5bGluZVZvbHVtZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgbGV0IGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIHBvc2l0aW9uc1tpXSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHNoYXBlID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIHNoYXBlW2ldID0gQ2FydGVzaWFuMl9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaEVsbGlwc29pZDkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQxMQogICAgICAgICk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgY29ybmVyVHlwZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE3LnBvbHlsaW5lUG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNy5zaGFwZVBvc2l0aW9ucyA9IHNoYXBlOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNy5jb3JuZXJUeXBlID0gY29ybmVyVHlwZTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTcuZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICAgIHJldHVybiBuZXcgUG9seWxpbmVWb2x1bWVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczE3KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgcmVzdWx0Ll9zaGFwZSA9IHNoYXBlOwogICAgICAgIHJlc3VsdC5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkLCByZXN1bHQuX2VsbGlwc29pZCk7CiAgICAgICAgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSh2ZXJ0ZXhGb3JtYXQsIHJlc3VsdC5fdmVydGV4Rm9ybWF0KTsKICAgICAgICByZXN1bHQuX2Nvcm5lclR5cGUgPSBjb3JuZXJUeXBlOwogICAgICAgIHJlc3VsdC5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBiclNjcmF0Y2ggPSBuZXcgQm91bmRpbmdSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgICBQb2x5bGluZVZvbHVtZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24ocG9seWxpbmVWb2x1bWVHZW9tZXRyeSkgewogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHBvbHlsaW5lVm9sdW1lR2VvbWV0cnkuX3Bvc2l0aW9uczsKICAgICAgICBjb25zdCBjbGVhblBvc2l0aW9ucyA9IGFycmF5UmVtb3ZlRHVwbGljYXRlc19kZWZhdWx0KAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24KICAgICAgICApOwogICAgICAgIGxldCBzaGFwZTJEID0gcG9seWxpbmVWb2x1bWVHZW9tZXRyeS5fc2hhcGU7CiAgICAgICAgc2hhcGUyRCA9IFBvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQucmVtb3ZlRHVwbGljYXRlc0Zyb21TaGFwZShzaGFwZTJEKTsKICAgICAgICBpZiAoY2xlYW5Qb3NpdGlvbnMubGVuZ3RoIDwgMiB8fCBzaGFwZTJELmxlbmd0aCA8IDMpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmIChQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5jb21wdXRlV2luZGluZ09yZGVyMkQoc2hhcGUyRCkgPT09IFdpbmRpbmdPcmRlcl9kZWZhdWx0LkNMT0NLV0lTRSkgewogICAgICAgICAgc2hhcGUyRC5yZXZlcnNlKCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGJvdW5kaW5nUmVjdGFuZ2xlID0gQm91bmRpbmdSZWN0YW5nbGVfZGVmYXVsdC5mcm9tUG9pbnRzKHNoYXBlMkQsIGJyU2NyYXRjaCk7CiAgICAgICAgY29uc3QgY29tcHV0ZWRQb3NpdGlvbnMgPSBQb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbnMoCiAgICAgICAgICBjbGVhblBvc2l0aW9ucywKICAgICAgICAgIHNoYXBlMkQsCiAgICAgICAgICBib3VuZGluZ1JlY3RhbmdsZSwKICAgICAgICAgIHBvbHlsaW5lVm9sdW1lR2VvbWV0cnksCiAgICAgICAgICB0cnVlCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gY29tcHV0ZUF0dHJpYnV0ZXMyKAogICAgICAgICAgY29tcHV0ZWRQb3NpdGlvbnMsCiAgICAgICAgICBzaGFwZTJELAogICAgICAgICAgYm91bmRpbmdSZWN0YW5nbGUsCiAgICAgICAgICBwb2x5bGluZVZvbHVtZUdlb21ldHJ5Ll92ZXJ0ZXhGb3JtYXQKICAgICAgICApOwogICAgICB9OwogICAgICBQb2x5bGluZVZvbHVtZUdlb21ldHJ5X2RlZmF1bHQgPSBQb2x5bGluZVZvbHVtZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUG9seWxpbmVWb2x1bWVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnkocG9seWxpbmVWb2x1bWVHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgcG9seWxpbmVWb2x1bWVHZW9tZXRyeSA9IFBvbHlsaW5lVm9sdW1lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soCiAgICAgICAgcG9seWxpbmVWb2x1bWVHZW9tZXRyeSwKICAgICAgICBvZmZzZXQKICAgICAgKTsKICAgIH0KICAgIHBvbHlsaW5lVm9sdW1lR2VvbWV0cnkuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICBwb2x5bGluZVZvbHVtZUdlb21ldHJ5Ll9lbGxpcHNvaWQKICAgICk7CiAgICByZXR1cm4gUG9seWxpbmVWb2x1bWVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KHBvbHlsaW5lVm9sdW1lR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlUG9seWxpbmVWb2x1bWVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9Qb2x5bGluZVZvbHVtZUdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIGNvbXB1dGVBdHRyaWJ1dGVzMyhwb3NpdGlvbnMsIHNoYXBlKSB7CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgIHZhbHVlczogcG9zaXRpb25zCiAgICB9KTsKICAgIGNvbnN0IHNoYXBlTGVuZ3RoID0gc2hhcGUubGVuZ3RoOwogICAgY29uc3QgdmVydGV4Q291bnQgPSBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGggLyAzOwogICAgY29uc3QgcG9zaXRpb25MZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgIGNvbnN0IHNoYXBlQ291bnQgPSBwb3NpdGlvbkxlbmd0aCAvIHNoYXBlTGVuZ3RoOwogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICB2ZXJ0ZXhDb3VudCwKICAgICAgMiAqIHNoYXBlTGVuZ3RoICogKHNoYXBlQ291bnQgKyAxKQogICAgKTsKICAgIGxldCBpLCBqOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGkgPSAwOwogICAgbGV0IG9mZnNldCA9IGkgKiBzaGFwZUxlbmd0aDsKICAgIGZvciAoaiA9IDA7IGogPCBzaGFwZUxlbmd0aCAtIDE7IGorKykgewogICAgICBpbmRpY2VzW2luZGV4KytdID0gaiArIG9mZnNldDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGogKyBvZmZzZXQgKyAxOwogICAgfQogICAgaW5kaWNlc1tpbmRleCsrXSA9IHNoYXBlTGVuZ3RoIC0gMSArIG9mZnNldDsKICAgIGluZGljZXNbaW5kZXgrK10gPSBvZmZzZXQ7CiAgICBpID0gc2hhcGVDb3VudCAtIDE7CiAgICBvZmZzZXQgPSBpICogc2hhcGVMZW5ndGg7CiAgICBmb3IgKGogPSAwOyBqIDwgc2hhcGVMZW5ndGggLSAxOyBqKyspIHsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGogKyBvZmZzZXQ7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBqICsgb2Zmc2V0ICsgMTsKICAgIH0KICAgIGluZGljZXNbaW5kZXgrK10gPSBzaGFwZUxlbmd0aCAtIDEgKyBvZmZzZXQ7CiAgICBpbmRpY2VzW2luZGV4KytdID0gb2Zmc2V0OwogICAgZm9yIChpID0gMDsgaSA8IHNoYXBlQ291bnQgLSAxOyBpKyspIHsKICAgICAgY29uc3QgZmlyc3RPZmZzZXQgPSBzaGFwZUxlbmd0aCAqIGk7CiAgICAgIGNvbnN0IHNlY29uZE9mZnNldCA9IGZpcnN0T2Zmc2V0ICsgc2hhcGVMZW5ndGg7CiAgICAgIGZvciAoaiA9IDA7IGogPCBzaGFwZUxlbmd0aDsgaisrKSB7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGogKyBmaXJzdE9mZnNldDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaiArIHNlY29uZE9mZnNldDsKICAgICAgfQogICAgfQogICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgIGF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXM6IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KHZlcnRleENvdW50LCBpbmRpY2VzKSwKICAgICAgYm91bmRpbmdTcGhlcmU6IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVZlcnRpY2VzKHBvc2l0aW9ucyksCiAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUwogICAgfSk7CiAgICByZXR1cm4gZ2VvbWV0cnk7CiAgfQogIGZ1bmN0aW9uIFBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgcG9zaXRpb25zID0gb3B0aW9ucy5wb2x5bGluZVBvc2l0aW9uczsKICAgIGNvbnN0IHNoYXBlID0gb3B0aW9ucy5zaGFwZVBvc2l0aW9uczsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMucG9seWxpbmVQb3NpdGlvbnMgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChzaGFwZSkpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMuc2hhcGVQb3NpdGlvbnMgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICB0aGlzLl9wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICB0aGlzLl9zaGFwZSA9IHNoYXBlOwogICAgdGhpcy5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoCiAgICAgIGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCkKICAgICk7CiAgICB0aGlzLl9jb3JuZXJUeXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5jb3JuZXJUeXBlLCBDb3JuZXJUeXBlX2RlZmF1bHQuUk9VTkRFRCk7CiAgICB0aGlzLl9ncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFCiAgICApOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeSI7CiAgICBsZXQgbnVtQ29tcG9uZW50cyA9IDEgKyBwb3NpdGlvbnMubGVuZ3RoICogQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIG51bUNvbXBvbmVudHMgKz0gMSArIHNoYXBlLmxlbmd0aCAqIENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICB0aGlzLnBhY2tlZExlbmd0aCA9IG51bUNvbXBvbmVudHMgKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAyOwogIH0KICB2YXIgc2NyYXRjaEVsbGlwc29pZDEwLCBzY3JhdGNoT3B0aW9uczE4LCBiclNjcmF0Y2gyLCBQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1BvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfYXJyYXlSZW1vdmVEdXBsaWNhdGVzKCk7CiAgICAgIGluaXRfQm91bmRpbmdSZWN0YW5nbGUoKTsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9Db3JuZXJUeXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUG9seWdvblBpcGVsaW5lKCk7CiAgICAgIGluaXRfUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfV2luZGluZ09yZGVyKCk7CiAgICAgIFBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2YWx1ZSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gdmFsdWUuX3Bvc2l0aW9uczsKICAgICAgICBsZXQgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhwb3NpdGlvbnNbaV0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc2hhcGUgPSB2YWx1ZS5fc2hhcGU7CiAgICAgICAgbGVuZ3RoID0gc2hhcGUubGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBsZW5ndGg7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrKHNoYXBlW2ldLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIEVsbGlwc29pZF9kZWZhdWx0LnBhY2sodmFsdWUuX2VsbGlwc29pZCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fY29ybmVyVHlwZTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQxMCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKEVsbGlwc29pZF9kZWZhdWx0LlVOSVRfU1BIRVJFKTsKICAgICAgc2NyYXRjaE9wdGlvbnMxOCA9IHsKICAgICAgICBwb2x5bGluZVBvc2l0aW9uczogdm9pZCAwLAogICAgICAgIHNoYXBlUG9zaXRpb25zOiB2b2lkIDAsCiAgICAgICAgZWxsaXBzb2lkOiBzY3JhdGNoRWxsaXBzb2lkMTAsCiAgICAgICAgaGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgY29ybmVyVHlwZTogdm9pZCAwLAogICAgICAgIGdyYW51bGFyaXR5OiB2b2lkIDAKICAgICAgfTsKICAgICAgUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBsZXQgaTsKICAgICAgICBsZXQgbGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgcG9zaXRpb25zW2ldID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgc2hhcGUgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuMl9kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgc2hhcGVbaV0gPSBDYXJ0ZXNpYW4yX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoRWxsaXBzb2lkMTApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGNvcm5lclR5cGUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxOC5wb2x5bGluZVBvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTguc2hhcGVQb3NpdGlvbnMgPSBzaGFwZTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTguY29ybmVyVHlwZSA9IGNvcm5lclR5cGU7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE4LmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICByZXR1cm4gbmV3IFBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zMTgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX3Bvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgICAgICByZXN1bHQuX3NoYXBlID0gc2hhcGU7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQsIHJlc3VsdC5fZWxsaXBzb2lkKTsKICAgICAgICByZXN1bHQuX2Nvcm5lclR5cGUgPSBjb3JuZXJUeXBlOwogICAgICAgIHJlc3VsdC5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBiclNjcmF0Y2gyID0gbmV3IEJvdW5kaW5nUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihwb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeSkgewogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5Ll9wb3NpdGlvbnM7CiAgICAgICAgY29uc3QgY2xlYW5Qb3NpdGlvbnMgPSBhcnJheVJlbW92ZUR1cGxpY2F0ZXNfZGVmYXVsdCgKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uCiAgICAgICAgKTsKICAgICAgICBsZXQgc2hhcGUyRCA9IHBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5Ll9zaGFwZTsKICAgICAgICBzaGFwZTJEID0gUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5yZW1vdmVEdXBsaWNhdGVzRnJvbVNoYXBlKHNoYXBlMkQpOwogICAgICAgIGlmIChjbGVhblBvc2l0aW9ucy5sZW5ndGggPCAyIHx8IHNoYXBlMkQubGVuZ3RoIDwgMykgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LmNvbXB1dGVXaW5kaW5nT3JkZXIyRChzaGFwZTJEKSA9PT0gV2luZGluZ09yZGVyX2RlZmF1bHQuQ0xPQ0tXSVNFKSB7CiAgICAgICAgICBzaGFwZTJELnJldmVyc2UoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYm91bmRpbmdSZWN0YW5nbGUgPSBCb3VuZGluZ1JlY3RhbmdsZV9kZWZhdWx0LmZyb21Qb2ludHMoc2hhcGUyRCwgYnJTY3JhdGNoMik7CiAgICAgICAgY29uc3QgY29tcHV0ZWRQb3NpdGlvbnMgPSBQb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbnMoCiAgICAgICAgICBjbGVhblBvc2l0aW9ucywKICAgICAgICAgIHNoYXBlMkQsCiAgICAgICAgICBib3VuZGluZ1JlY3RhbmdsZSwKICAgICAgICAgIHBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5LAogICAgICAgICAgZmFsc2UKICAgICAgICApOwogICAgICAgIHJldHVybiBjb21wdXRlQXR0cmlidXRlczMoY29tcHV0ZWRQb3NpdGlvbnMsIHNoYXBlMkQpOwogICAgICB9OwogICAgICBQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5KHBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBwb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeSA9IFBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKAogICAgICAgIHBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5LAogICAgICAgIG9mZnNldAogICAgICApOwogICAgfQogICAgcG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICBwb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeS5fZWxsaXBzb2lkCiAgICApOwogICAgcmV0dXJuIFBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoCiAgICAgIHBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5CiAgICApOwogIH0KICB2YXIgY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9Qb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeSgpOwogICAgICBjcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnkuanMKICBmdW5jdGlvbiBnZXRSb3RhdGlvbk9wdGlvbnMobndDb3JuZXIsIHJvdGF0aW9uLCBncmFudWxhcml0eVgsIGdyYW51bGFyaXR5WSwgY2VudGVyLCB3aWR0aCwgaGVpZ2h0KSB7CiAgICBjb25zdCBjb3NSb3RhdGlvbiA9IE1hdGguY29zKHJvdGF0aW9uKTsKICAgIGNvbnN0IGdyYW5ZQ29zID0gZ3JhbnVsYXJpdHlZICogY29zUm90YXRpb247CiAgICBjb25zdCBncmFuWENvcyA9IGdyYW51bGFyaXR5WCAqIGNvc1JvdGF0aW9uOwogICAgY29uc3Qgc2luUm90YXRpb24gPSBNYXRoLnNpbihyb3RhdGlvbik7CiAgICBjb25zdCBncmFuWVNpbiA9IGdyYW51bGFyaXR5WSAqIHNpblJvdGF0aW9uOwogICAgY29uc3QgZ3JhblhTaW4gPSBncmFudWxhcml0eVggKiBzaW5Sb3RhdGlvbjsKICAgIG53Q2FydGVzaWFuID0gcHJvai5wcm9qZWN0KG53Q29ybmVyLCBud0NhcnRlc2lhbik7CiAgICBud0NhcnRlc2lhbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChud0NhcnRlc2lhbiwgY2VudGVyQ2FydGVzaWFuLCBud0NhcnRlc2lhbik7CiAgICBjb25zdCByb3RhdGlvbk1hdHJpeCA9IE1hdHJpeDJfZGVmYXVsdC5mcm9tUm90YXRpb24ocm90YXRpb24sIHJvdGF0aW9uTWF0cml4U2NyYXRjaCk7CiAgICBud0NhcnRlc2lhbiA9IE1hdHJpeDJfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKAogICAgICByb3RhdGlvbk1hdHJpeCwKICAgICAgbndDYXJ0ZXNpYW4sCiAgICAgIG53Q2FydGVzaWFuCiAgICApOwogICAgbndDYXJ0ZXNpYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG53Q2FydGVzaWFuLCBjZW50ZXJDYXJ0ZXNpYW4sIG53Q2FydGVzaWFuKTsKICAgIG53Q29ybmVyID0gcHJvai51bnByb2plY3QobndDYXJ0ZXNpYW4sIG53Q29ybmVyKTsKICAgIHdpZHRoIC09IDE7CiAgICBoZWlnaHQgLT0gMTsKICAgIGNvbnN0IGxhdGl0dWRlID0gbndDb3JuZXIubGF0aXR1ZGU7CiAgICBjb25zdCBsYXRpdHVkZTAgPSBsYXRpdHVkZSArIHdpZHRoICogZ3JhblhTaW47CiAgICBjb25zdCBsYXRpdHVkZTEgPSBsYXRpdHVkZSAtIGdyYW5ZQ29zICogaGVpZ2h0OwogICAgY29uc3QgbGF0aXR1ZGUyID0gbGF0aXR1ZGUgLSBncmFuWUNvcyAqIGhlaWdodCArIHdpZHRoICogZ3JhblhTaW47CiAgICBjb25zdCBub3J0aCA9IE1hdGgubWF4KGxhdGl0dWRlLCBsYXRpdHVkZTAsIGxhdGl0dWRlMSwgbGF0aXR1ZGUyKTsKICAgIGNvbnN0IHNvdXRoID0gTWF0aC5taW4obGF0aXR1ZGUsIGxhdGl0dWRlMCwgbGF0aXR1ZGUxLCBsYXRpdHVkZTIpOwogICAgY29uc3QgbG9uZ2l0dWRlID0gbndDb3JuZXIubG9uZ2l0dWRlOwogICAgY29uc3QgbG9uZ2l0dWRlMCA9IGxvbmdpdHVkZSArIHdpZHRoICogZ3JhblhDb3M7CiAgICBjb25zdCBsb25naXR1ZGUxID0gbG9uZ2l0dWRlICsgaGVpZ2h0ICogZ3JhbllTaW47CiAgICBjb25zdCBsb25naXR1ZGUyID0gbG9uZ2l0dWRlICsgaGVpZ2h0ICogZ3JhbllTaW4gKyB3aWR0aCAqIGdyYW5YQ29zOwogICAgY29uc3QgZWFzdCA9IE1hdGgubWF4KGxvbmdpdHVkZSwgbG9uZ2l0dWRlMCwgbG9uZ2l0dWRlMSwgbG9uZ2l0dWRlMik7CiAgICBjb25zdCB3ZXN0ID0gTWF0aC5taW4obG9uZ2l0dWRlLCBsb25naXR1ZGUwLCBsb25naXR1ZGUxLCBsb25naXR1ZGUyKTsKICAgIHJldHVybiB7CiAgICAgIG5vcnRoLAogICAgICBzb3V0aCwKICAgICAgZWFzdCwKICAgICAgd2VzdCwKICAgICAgZ3JhbllDb3MsCiAgICAgIGdyYW5ZU2luLAogICAgICBncmFuWENvcywKICAgICAgZ3JhblhTaW4sCiAgICAgIG53Q29ybmVyCiAgICB9OwogIH0KICB2YXIgY29zMywgc2luMywgc3FydCwgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5LCByb3RhdGlvbk1hdHJpeFNjcmF0Y2gsIG53Q2FydGVzaWFuLCBjZW50ZXJTY3JhdGNoMywgY2VudGVyQ2FydGVzaWFuLCBwcm9qLCBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdDsKICB2YXIgaW5pdF9SZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JlY3RhbmdsZUdlb21ldHJ5TGlicmFyeS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0dlb2dyYXBoaWNQcm9qZWN0aW9uKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDIoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgY29zMyA9IE1hdGguY29zOwogICAgICBzaW4zID0gTWF0aC5zaW47CiAgICAgIHNxcnQgPSBNYXRoLnNxcnQ7CiAgICAgIFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeSA9IHt9OwogICAgICBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnkuY29tcHV0ZVBvc2l0aW9uID0gZnVuY3Rpb24oY29tcHV0ZWRPcHRpb25zLCBlbGxpcHNvaWQsIGNvbXB1dGVTVCwgcm93LCBjb2wsIHBvc2l0aW9uLCBzdCkgewogICAgICAgIGNvbnN0IHJhZGlpU3F1YXJlZCA9IGVsbGlwc29pZC5yYWRpaVNxdWFyZWQ7CiAgICAgICAgY29uc3QgbndDb3JuZXIgPSBjb21wdXRlZE9wdGlvbnMubndDb3JuZXI7CiAgICAgICAgY29uc3QgcmVjdGFuZ2xlID0gY29tcHV0ZWRPcHRpb25zLmJvdW5kaW5nUmVjdGFuZ2xlOwogICAgICAgIGxldCBzdExhdGl0dWRlID0gbndDb3JuZXIubGF0aXR1ZGUgLSBjb21wdXRlZE9wdGlvbnMuZ3JhbllDb3MgKiByb3cgKyBjb2wgKiBjb21wdXRlZE9wdGlvbnMuZ3JhblhTaW47CiAgICAgICAgY29uc3QgY29zTGF0aXR1ZGUgPSBjb3MzKHN0TGF0aXR1ZGUpOwogICAgICAgIGNvbnN0IG5aID0gc2luMyhzdExhdGl0dWRlKTsKICAgICAgICBjb25zdCBrWiA9IHJhZGlpU3F1YXJlZC56ICogblo7CiAgICAgICAgbGV0IHN0TG9uZ2l0dWRlID0gbndDb3JuZXIubG9uZ2l0dWRlICsgcm93ICogY29tcHV0ZWRPcHRpb25zLmdyYW5ZU2luICsgY29sICogY29tcHV0ZWRPcHRpb25zLmdyYW5YQ29zOwogICAgICAgIGNvbnN0IG5YID0gY29zTGF0aXR1ZGUgKiBjb3MzKHN0TG9uZ2l0dWRlKTsKICAgICAgICBjb25zdCBuWSA9IGNvc0xhdGl0dWRlICogc2luMyhzdExvbmdpdHVkZSk7CiAgICAgICAgY29uc3Qga1ggPSByYWRpaVNxdWFyZWQueCAqIG5YOwogICAgICAgIGNvbnN0IGtZID0gcmFkaWlTcXVhcmVkLnkgKiBuWTsKICAgICAgICBjb25zdCBnYW1tYSA9IHNxcnQoa1ggKiBuWCArIGtZICogblkgKyBrWiAqIG5aKTsKICAgICAgICBwb3NpdGlvbi54ID0ga1ggLyBnYW1tYTsKICAgICAgICBwb3NpdGlvbi55ID0ga1kgLyBnYW1tYTsKICAgICAgICBwb3NpdGlvbi56ID0ga1ogLyBnYW1tYTsKICAgICAgICBpZiAoY29tcHV0ZVNUKSB7CiAgICAgICAgICBjb25zdCBzdE53Q29ybmVyID0gY29tcHV0ZWRPcHRpb25zLnN0TndDb3JuZXI7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHN0TndDb3JuZXIpKSB7CiAgICAgICAgICAgIHN0TGF0aXR1ZGUgPSBzdE53Q29ybmVyLmxhdGl0dWRlIC0gY29tcHV0ZWRPcHRpb25zLnN0R3JhbllDb3MgKiByb3cgKyBjb2wgKiBjb21wdXRlZE9wdGlvbnMuc3RHcmFuWFNpbjsKICAgICAgICAgICAgc3RMb25naXR1ZGUgPSBzdE53Q29ybmVyLmxvbmdpdHVkZSArIHJvdyAqIGNvbXB1dGVkT3B0aW9ucy5zdEdyYW5ZU2luICsgY29sICogY29tcHV0ZWRPcHRpb25zLnN0R3JhblhDb3M7CiAgICAgICAgICAgIHN0LnggPSAoc3RMb25naXR1ZGUgLSBjb21wdXRlZE9wdGlvbnMuc3RXZXN0KSAqIGNvbXB1dGVkT3B0aW9ucy5sb25TY2FsYXI7CiAgICAgICAgICAgIHN0LnkgPSAoc3RMYXRpdHVkZSAtIGNvbXB1dGVkT3B0aW9ucy5zdFNvdXRoKSAqIGNvbXB1dGVkT3B0aW9ucy5sYXRTY2FsYXI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdC54ID0gKHN0TG9uZ2l0dWRlIC0gcmVjdGFuZ2xlLndlc3QpICogY29tcHV0ZWRPcHRpb25zLmxvblNjYWxhcjsKICAgICAgICAgICAgc3QueSA9IChzdExhdGl0dWRlIC0gcmVjdGFuZ2xlLnNvdXRoKSAqIGNvbXB1dGVkT3B0aW9ucy5sYXRTY2FsYXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgICByb3RhdGlvbk1hdHJpeFNjcmF0Y2ggPSBuZXcgTWF0cml4Ml9kZWZhdWx0KCk7CiAgICAgIG53Q2FydGVzaWFuID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjZW50ZXJTY3JhdGNoMyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBjZW50ZXJDYXJ0ZXNpYW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHByb2ogPSBuZXcgR2VvZ3JhcGhpY1Byb2plY3Rpb25fZGVmYXVsdCgpOwogICAgICBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnkuY29tcHV0ZU9wdGlvbnMgPSBmdW5jdGlvbihyZWN0YW5nbGUsIGdyYW51bGFyaXR5LCByb3RhdGlvbiwgc3RSb3RhdGlvbiwgYm91bmRpbmdSZWN0YW5nbGVTY3JhdGNoLCBud0Nvcm5lclJlc3VsdCwgc3ROd0Nvcm5lclJlc3VsdCkgewogICAgICAgIGxldCBlYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgbGV0IHdlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgICAgICBsZXQgbm9ydGggPSByZWN0YW5nbGUubm9ydGg7CiAgICAgICAgbGV0IHNvdXRoID0gcmVjdGFuZ2xlLnNvdXRoOwogICAgICAgIGxldCBub3J0aENhcCA9IGZhbHNlOwogICAgICAgIGxldCBzb3V0aENhcCA9IGZhbHNlOwogICAgICAgIGlmIChub3J0aCA9PT0gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPKSB7CiAgICAgICAgICBub3J0aENhcCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGlmIChzb3V0aCA9PT0gLU1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTykgewogICAgICAgICAgc291dGhDYXAgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBsZXQgZHg7CiAgICAgICAgY29uc3QgZHkgPSBub3J0aCAtIHNvdXRoOwogICAgICAgIGlmICh3ZXN0ID4gZWFzdCkgewogICAgICAgICAgZHggPSBNYXRoX2RlZmF1bHQuVFdPX1BJIC0gd2VzdCArIGVhc3Q7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGR4ID0gZWFzdCAtIHdlc3Q7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHdpZHRoID0gTWF0aC5jZWlsKGR4IC8gZ3JhbnVsYXJpdHkpICsgMTsKICAgICAgICBjb25zdCBoZWlnaHQgPSBNYXRoLmNlaWwoZHkgLyBncmFudWxhcml0eSkgKyAxOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5WCA9IGR4IC8gKHdpZHRoIC0gMSk7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHlZID0gZHkgLyAoaGVpZ2h0IC0gMSk7CiAgICAgICAgY29uc3QgbndDb3JuZXIgPSBSZWN0YW5nbGVfZGVmYXVsdC5ub3J0aHdlc3QocmVjdGFuZ2xlLCBud0Nvcm5lclJlc3VsdCk7CiAgICAgICAgY29uc3QgY2VudGVyID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2VudGVyKHJlY3RhbmdsZSwgY2VudGVyU2NyYXRjaDMpOwogICAgICAgIGlmIChyb3RhdGlvbiAhPT0gMCB8fCBzdFJvdGF0aW9uICE9PSAwKSB7CiAgICAgICAgICBpZiAoY2VudGVyLmxvbmdpdHVkZSA8IG53Q29ybmVyLmxvbmdpdHVkZSkgewogICAgICAgICAgICBjZW50ZXIubG9uZ2l0dWRlICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgICB9CiAgICAgICAgICBjZW50ZXJDYXJ0ZXNpYW4gPSBwcm9qLnByb2plY3QoY2VudGVyLCBjZW50ZXJDYXJ0ZXNpYW4pOwogICAgICAgIH0KICAgICAgICBjb25zdCBncmFuWUNvcyA9IGdyYW51bGFyaXR5WTsKICAgICAgICBjb25zdCBncmFuWENvcyA9IGdyYW51bGFyaXR5WDsKICAgICAgICBjb25zdCBncmFuWVNpbiA9IDA7CiAgICAgICAgY29uc3QgZ3JhblhTaW4gPSAwOwogICAgICAgIGNvbnN0IGJvdW5kaW5nUmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUoCiAgICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgICBib3VuZGluZ1JlY3RhbmdsZVNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IGNvbXB1dGVkT3B0aW9ucyA9IHsKICAgICAgICAgIGdyYW5ZQ29zLAogICAgICAgICAgZ3JhbllTaW4sCiAgICAgICAgICBncmFuWENvcywKICAgICAgICAgIGdyYW5YU2luLAogICAgICAgICAgbndDb3JuZXIsCiAgICAgICAgICBib3VuZGluZ1JlY3RhbmdsZSwKICAgICAgICAgIHdpZHRoLAogICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgbm9ydGhDYXAsCiAgICAgICAgICBzb3V0aENhcAogICAgICAgIH07CiAgICAgICAgaWYgKHJvdGF0aW9uICE9PSAwKSB7CiAgICAgICAgICBjb25zdCByb3RhdGlvbk9wdGlvbnMgPSBnZXRSb3RhdGlvbk9wdGlvbnMoCiAgICAgICAgICAgIG53Q29ybmVyLAogICAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgICAgZ3JhbnVsYXJpdHlYLAogICAgICAgICAgICBncmFudWxhcml0eVksCiAgICAgICAgICAgIGNlbnRlciwKICAgICAgICAgICAgd2lkdGgsCiAgICAgICAgICAgIGhlaWdodAogICAgICAgICAgKTsKICAgICAgICAgIG5vcnRoID0gcm90YXRpb25PcHRpb25zLm5vcnRoOwogICAgICAgICAgc291dGggPSByb3RhdGlvbk9wdGlvbnMuc291dGg7CiAgICAgICAgICBlYXN0ID0gcm90YXRpb25PcHRpb25zLmVhc3Q7CiAgICAgICAgICB3ZXN0ID0gcm90YXRpb25PcHRpb25zLndlc3Q7CiAgICAgICAgICBpZiAobm9ydGggPCAtTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIHx8IG5vcnRoID4gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIHx8IHNvdXRoIDwgLU1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyB8fCBzb3V0aCA+IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTykgewogICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgICAiUm90YXRlZCByZWN0YW5nbGUgaXMgaW52YWxpZC4gIEl0IGNyb3NzZXMgb3ZlciBlaXRoZXIgdGhlIG5vcnRoIG9yIHNvdXRoIHBvbGUuIgogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgY29tcHV0ZWRPcHRpb25zLmdyYW5ZQ29zID0gcm90YXRpb25PcHRpb25zLmdyYW5ZQ29zOwogICAgICAgICAgY29tcHV0ZWRPcHRpb25zLmdyYW5ZU2luID0gcm90YXRpb25PcHRpb25zLmdyYW5ZU2luOwogICAgICAgICAgY29tcHV0ZWRPcHRpb25zLmdyYW5YQ29zID0gcm90YXRpb25PcHRpb25zLmdyYW5YQ29zOwogICAgICAgICAgY29tcHV0ZWRPcHRpb25zLmdyYW5YU2luID0gcm90YXRpb25PcHRpb25zLmdyYW5YU2luOwogICAgICAgICAgYm91bmRpbmdSZWN0YW5nbGUubm9ydGggPSBub3J0aDsKICAgICAgICAgIGJvdW5kaW5nUmVjdGFuZ2xlLnNvdXRoID0gc291dGg7CiAgICAgICAgICBib3VuZGluZ1JlY3RhbmdsZS5lYXN0ID0gZWFzdDsKICAgICAgICAgIGJvdW5kaW5nUmVjdGFuZ2xlLndlc3QgPSB3ZXN0OwogICAgICAgIH0KICAgICAgICBpZiAoc3RSb3RhdGlvbiAhPT0gMCkgewogICAgICAgICAgcm90YXRpb24gPSByb3RhdGlvbiAtIHN0Um90YXRpb247CiAgICAgICAgICBjb25zdCBzdE53Q29ybmVyID0gUmVjdGFuZ2xlX2RlZmF1bHQubm9ydGh3ZXN0KGJvdW5kaW5nUmVjdGFuZ2xlLCBzdE53Q29ybmVyUmVzdWx0KTsKICAgICAgICAgIGNvbnN0IHN0Um90YXRpb25PcHRpb25zID0gZ2V0Um90YXRpb25PcHRpb25zKAogICAgICAgICAgICBzdE53Q29ybmVyLAogICAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgICAgZ3JhbnVsYXJpdHlYLAogICAgICAgICAgICBncmFudWxhcml0eVksCiAgICAgICAgICAgIGNlbnRlciwKICAgICAgICAgICAgd2lkdGgsCiAgICAgICAgICAgIGhlaWdodAogICAgICAgICAgKTsKICAgICAgICAgIGNvbXB1dGVkT3B0aW9ucy5zdEdyYW5ZQ29zID0gc3RSb3RhdGlvbk9wdGlvbnMuZ3JhbllDb3M7CiAgICAgICAgICBjb21wdXRlZE9wdGlvbnMuc3RHcmFuWENvcyA9IHN0Um90YXRpb25PcHRpb25zLmdyYW5YQ29zOwogICAgICAgICAgY29tcHV0ZWRPcHRpb25zLnN0R3JhbllTaW4gPSBzdFJvdGF0aW9uT3B0aW9ucy5ncmFuWVNpbjsKICAgICAgICAgIGNvbXB1dGVkT3B0aW9ucy5zdEdyYW5YU2luID0gc3RSb3RhdGlvbk9wdGlvbnMuZ3JhblhTaW47CiAgICAgICAgICBjb21wdXRlZE9wdGlvbnMuc3ROd0Nvcm5lciA9IHN0TndDb3JuZXI7CiAgICAgICAgICBjb21wdXRlZE9wdGlvbnMuc3RXZXN0ID0gc3RSb3RhdGlvbk9wdGlvbnMud2VzdDsKICAgICAgICAgIGNvbXB1dGVkT3B0aW9ucy5zdFNvdXRoID0gc3RSb3RhdGlvbk9wdGlvbnMuc291dGg7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjb21wdXRlZE9wdGlvbnM7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0ID0gUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVjdGFuZ2xlR2VvbWV0cnkuanMKICBmdW5jdGlvbiBjcmVhdGVBdHRyaWJ1dGVzKHZlcnRleEZvcm1hdCwgYXR0cmlidXRlcykgewogICAgY29uc3QgZ2VvID0gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICBhdHRyaWJ1dGVzOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoKSwKICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUwogICAgfSk7CiAgICBnZW8uYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICB2YWx1ZXM6IGF0dHJpYnV0ZXMucG9zaXRpb25zCiAgICB9KTsKICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgIGdlby5hdHRyaWJ1dGVzLm5vcm1hbCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogYXR0cmlidXRlcy5ub3JtYWxzCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgIGdlby5hdHRyaWJ1dGVzLnRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IGF0dHJpYnV0ZXMudGFuZ2VudHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICBnZW8uYXR0cmlidXRlcy5iaXRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IGF0dHJpYnV0ZXMuYml0YW5nZW50cwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBnZW87CiAgfQogIGZ1bmN0aW9uIGNhbGN1bGF0ZUF0dHJpYnV0ZXMocG9zaXRpb25zLCB2ZXJ0ZXhGb3JtYXQsIGVsbGlwc29pZCwgdGFuZ2VudFJvdGF0aW9uTWF0cml4KSB7CiAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgY29uc3Qgbm9ybWFscyA9IHZlcnRleEZvcm1hdC5ub3JtYWwgPyBuZXcgRmxvYXQzMkFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICBjb25zdCB0YW5nZW50cyA9IHZlcnRleEZvcm1hdC50YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShsZW5ndGgpIDogdm9pZCAwOwogICAgY29uc3QgYml0YW5nZW50cyA9IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICBsZXQgYXR0ckluZGV4ID0gMDsKICAgIGNvbnN0IGJpdGFuZ2VudCA9IGJpdGFuZ2VudFNjcmF0Y2gyOwogICAgY29uc3QgdGFuZ2VudCA9IHRhbmdlbnRTY3JhdGNoMjsKICAgIGxldCBub3JtYWwyID0gbm9ybWFsU2NyYXRjaDQ7CiAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCB8fCB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICBjb25zdCBwID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGksIHBvc2l0aW9uU2NyYXRjaDIpOwogICAgICAgIGNvbnN0IGF0dHJJbmRleDEgPSBhdHRySW5kZXggKyAxOwogICAgICAgIGNvbnN0IGF0dHJJbmRleDIgPSBhdHRySW5kZXggKyAyOwogICAgICAgIG5vcm1hbDIgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHAsIG5vcm1hbDIpOwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWiwgbm9ybWFsMiwgdGFuZ2VudCk7CiAgICAgICAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3Rvcih0YW5nZW50Um90YXRpb25NYXRyaXgsIHRhbmdlbnQsIHRhbmdlbnQpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSh0YW5nZW50LCB0YW5nZW50KTsKICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKG5vcm1hbDIsIHRhbmdlbnQsIGJpdGFuZ2VudCksCiAgICAgICAgICAgICAgYml0YW5nZW50CiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICBub3JtYWxzW2F0dHJJbmRleF0gPSBub3JtYWwyLng7CiAgICAgICAgICBub3JtYWxzW2F0dHJJbmRleDFdID0gbm9ybWFsMi55OwogICAgICAgICAgbm9ybWFsc1thdHRySW5kZXgyXSA9IG5vcm1hbDIuejsKICAgICAgICB9CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICB0YW5nZW50c1thdHRySW5kZXhdID0gdGFuZ2VudC54OwogICAgICAgICAgdGFuZ2VudHNbYXR0ckluZGV4MV0gPSB0YW5nZW50Lnk7CiAgICAgICAgICB0YW5nZW50c1thdHRySW5kZXgyXSA9IHRhbmdlbnQuejsKICAgICAgICB9CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgIGJpdGFuZ2VudHNbYXR0ckluZGV4XSA9IGJpdGFuZ2VudC54OwogICAgICAgICAgYml0YW5nZW50c1thdHRySW5kZXgxXSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgYml0YW5nZW50c1thdHRySW5kZXgyXSA9IGJpdGFuZ2VudC56OwogICAgICAgIH0KICAgICAgICBhdHRySW5kZXggKz0gMzsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGNyZWF0ZUF0dHJpYnV0ZXModmVydGV4Rm9ybWF0LCB7CiAgICAgIHBvc2l0aW9ucywKICAgICAgbm9ybWFscywKICAgICAgdGFuZ2VudHMsCiAgICAgIGJpdGFuZ2VudHMKICAgIH0pOwogIH0KICBmdW5jdGlvbiBjYWxjdWxhdGVBdHRyaWJ1dGVzV2FsbChwb3NpdGlvbnMsIHZlcnRleEZvcm1hdCwgZWxsaXBzb2lkKSB7CiAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgY29uc3Qgbm9ybWFscyA9IHZlcnRleEZvcm1hdC5ub3JtYWwgPyBuZXcgRmxvYXQzMkFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICBjb25zdCB0YW5nZW50cyA9IHZlcnRleEZvcm1hdC50YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShsZW5ndGgpIDogdm9pZCAwOwogICAgY29uc3QgYml0YW5nZW50cyA9IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICBsZXQgbm9ybWFsSW5kZXggPSAwOwogICAgbGV0IHRhbmdlbnRJbmRleCA9IDA7CiAgICBsZXQgYml0YW5nZW50SW5kZXggPSAwOwogICAgbGV0IHJlY29tcHV0ZU5vcm1hbCA9IHRydWU7CiAgICBsZXQgYml0YW5nZW50ID0gYml0YW5nZW50U2NyYXRjaDI7CiAgICBsZXQgdGFuZ2VudCA9IHRhbmdlbnRTY3JhdGNoMjsKICAgIGxldCBub3JtYWwyID0gbm9ybWFsU2NyYXRjaDQ7CiAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCB8fCB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDYpIHsKICAgICAgICBjb25zdCBwID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGksIHBvc2l0aW9uU2NyYXRjaDIpOwogICAgICAgIGNvbnN0IHAxID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIChpICsgNikgJSBsZW5ndGgsIHYxU2NyYXRjaCk7CiAgICAgICAgaWYgKHJlY29tcHV0ZU5vcm1hbCkgewogICAgICAgICAgY29uc3QgcDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgKGkgKyAzKSAlIGxlbmd0aCwgdjJTY3JhdGNoKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwMSwgcCwgcDEpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHAyLCBwLCBwMik7CiAgICAgICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MocDIsIHAxLCBub3JtYWwyKSwgbm9ybWFsMik7CiAgICAgICAgICByZWNvbXB1dGVOb3JtYWwgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKHAxLCBwLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwKSkgewogICAgICAgICAgcmVjb21wdXRlTm9ybWFsID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgIGJpdGFuZ2VudCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocCwgYml0YW5nZW50KTsKICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgICB0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoYml0YW5nZW50LCBub3JtYWwyLCB0YW5nZW50KSwKICAgICAgICAgICAgICB0YW5nZW50CiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi54OwogICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueTsKICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLno7CiAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi54OwogICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueTsKICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLno7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC54OwogICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC55OwogICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC56OwogICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC54OwogICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC55OwogICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC56OwogICAgICAgIH0KICAgICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC54OwogICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC56OwogICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC54OwogICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC56OwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGNyZWF0ZUF0dHJpYnV0ZXModmVydGV4Rm9ybWF0LCB7CiAgICAgIHBvc2l0aW9ucywKICAgICAgbm9ybWFscywKICAgICAgdGFuZ2VudHMsCiAgICAgIGJpdGFuZ2VudHMKICAgIH0pOwogIH0KICBmdW5jdGlvbiBjb25zdHJ1Y3RSZWN0YW5nbGUocmVjdGFuZ2xlR2VvbWV0cnksIGNvbXB1dGVkT3B0aW9ucykgewogICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gcmVjdGFuZ2xlR2VvbWV0cnkuX3ZlcnRleEZvcm1hdDsKICAgIGNvbnN0IGVsbGlwc29pZCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICBjb25zdCBoZWlnaHQgPSBjb21wdXRlZE9wdGlvbnMuaGVpZ2h0OwogICAgY29uc3Qgd2lkdGggPSBjb21wdXRlZE9wdGlvbnMud2lkdGg7CiAgICBjb25zdCBub3J0aENhcCA9IGNvbXB1dGVkT3B0aW9ucy5ub3J0aENhcDsKICAgIGNvbnN0IHNvdXRoQ2FwID0gY29tcHV0ZWRPcHRpb25zLnNvdXRoQ2FwOwogICAgbGV0IHJvd1N0YXJ0ID0gMDsKICAgIGxldCByb3dFbmQgPSBoZWlnaHQ7CiAgICBsZXQgcm93SGVpZ2h0ID0gaGVpZ2h0OwogICAgbGV0IHNpemUgPSAwOwogICAgaWYgKG5vcnRoQ2FwKSB7CiAgICAgIHJvd1N0YXJ0ID0gMTsKICAgICAgcm93SGVpZ2h0IC09IDE7CiAgICAgIHNpemUgKz0gMTsKICAgIH0KICAgIGlmIChzb3V0aENhcCkgewogICAgICByb3dFbmQgLT0gMTsKICAgICAgcm93SGVpZ2h0IC09IDE7CiAgICAgIHNpemUgKz0gMTsKICAgIH0KICAgIHNpemUgKz0gd2lkdGggKiByb3dIZWlnaHQ7CiAgICBjb25zdCBwb3NpdGlvbnMgPSB2ZXJ0ZXhGb3JtYXQucG9zaXRpb24gPyBuZXcgRmxvYXQ2NEFycmF5KHNpemUgKiAzKSA6IHZvaWQgMDsKICAgIGNvbnN0IHRleHR1cmVDb29yZGluYXRlcyA9IHZlcnRleEZvcm1hdC5zdCA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDIpIDogdm9pZCAwOwogICAgbGV0IHBvc0luZGV4ID0gMDsKICAgIGxldCBzdEluZGV4ID0gMDsKICAgIGNvbnN0IHBvc2l0aW9uID0gcG9zaXRpb25TY3JhdGNoMjsKICAgIGNvbnN0IHN0ID0gc3RTY3JhdGNoMjsKICAgIGxldCBtaW5YID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgIGxldCBtaW5ZID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgIGxldCBtYXhYID0gLU51bWJlci5NQVhfVkFMVUU7CiAgICBsZXQgbWF4WSA9IC1OdW1iZXIuTUFYX1ZBTFVFOwogICAgZm9yIChsZXQgcm93ID0gcm93U3RhcnQ7IHJvdyA8IHJvd0VuZDsgKytyb3cpIHsKICAgICAgZm9yIChsZXQgY29sID0gMDsgY29sIDwgd2lkdGg7ICsrY29sKSB7CiAgICAgICAgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9uKAogICAgICAgICAgY29tcHV0ZWRPcHRpb25zLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgdmVydGV4Rm9ybWF0LnN0LAogICAgICAgICAgcm93LAogICAgICAgICAgY29sLAogICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICBzdAogICAgICAgICk7CiAgICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24ueDsKICAgICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi55OwogICAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLno7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3N0SW5kZXgrK10gPSBzdC54OwogICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3N0SW5kZXgrK10gPSBzdC55OwogICAgICAgICAgbWluWCA9IE1hdGgubWluKG1pblgsIHN0LngpOwogICAgICAgICAgbWluWSA9IE1hdGgubWluKG1pblksIHN0LnkpOwogICAgICAgICAgbWF4WCA9IE1hdGgubWF4KG1heFgsIHN0LngpOwogICAgICAgICAgbWF4WSA9IE1hdGgubWF4KG1heFksIHN0LnkpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKG5vcnRoQ2FwKSB7CiAgICAgIFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbigKICAgICAgICBjb21wdXRlZE9wdGlvbnMsCiAgICAgICAgZWxsaXBzb2lkLAogICAgICAgIHZlcnRleEZvcm1hdC5zdCwKICAgICAgICAwLAogICAgICAgIDAsCiAgICAgICAgcG9zaXRpb24sCiAgICAgICAgc3QKICAgICAgKTsKICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24ueDsKICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24ueTsKICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24uejsKICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgIHRleHR1cmVDb29yZGluYXRlc1tzdEluZGV4KytdID0gc3QueDsKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbc3RJbmRleCsrXSA9IHN0Lnk7CiAgICAgICAgbWluWCA9IHN0Lng7CiAgICAgICAgbWluWSA9IHN0Lnk7CiAgICAgICAgbWF4WCA9IHN0Lng7CiAgICAgICAgbWF4WSA9IHN0Lnk7CiAgICAgIH0KICAgIH0KICAgIGlmIChzb3V0aENhcCkgewogICAgICBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb24oCiAgICAgICAgY29tcHV0ZWRPcHRpb25zLAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICB2ZXJ0ZXhGb3JtYXQuc3QsCiAgICAgICAgaGVpZ2h0IC0gMSwKICAgICAgICAwLAogICAgICAgIHBvc2l0aW9uLAogICAgICAgIHN0CiAgICAgICk7CiAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLng7CiAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLnk7CiAgICAgIHBvc2l0aW9uc1twb3NJbmRleF0gPSBwb3NpdGlvbi56OwogICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3N0SW5kZXgrK10gPSBzdC54OwogICAgICAgIHRleHR1cmVDb29yZGluYXRlc1tzdEluZGV4XSA9IHN0Lnk7CiAgICAgICAgbWluWCA9IE1hdGgubWluKG1pblgsIHN0LngpOwogICAgICAgIG1pblkgPSBNYXRoLm1pbihtaW5ZLCBzdC55KTsKICAgICAgICBtYXhYID0gTWF0aC5tYXgobWF4WCwgc3QueCk7CiAgICAgICAgbWF4WSA9IE1hdGgubWF4KG1heFksIHN0LnkpOwogICAgICB9CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnN0ICYmIChtaW5YIDwgMCB8fCBtaW5ZIDwgMCB8fCBtYXhYID4gMSB8fCBtYXhZID4gMSkpIHsKICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCB0ZXh0dXJlQ29vcmRpbmF0ZXMubGVuZ3RoOyBrICs9IDIpIHsKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNba10gPSAodGV4dHVyZUNvb3JkaW5hdGVzW2tdIC0gbWluWCkgLyAobWF4WCAtIG1pblgpOwogICAgICAgIHRleHR1cmVDb29yZGluYXRlc1trICsgMV0gPSAodGV4dHVyZUNvb3JkaW5hdGVzW2sgKyAxXSAtIG1pblkpIC8gKG1heFkgLSBtaW5ZKTsKICAgICAgfQogICAgfQogICAgY29uc3QgZ2VvID0gY2FsY3VsYXRlQXR0cmlidXRlcygKICAgICAgcG9zaXRpb25zLAogICAgICB2ZXJ0ZXhGb3JtYXQsCiAgICAgIGVsbGlwc29pZCwKICAgICAgY29tcHV0ZWRPcHRpb25zLnRhbmdlbnRSb3RhdGlvbk1hdHJpeAogICAgKTsKICAgIGxldCBpbmRpY2VzU2l6ZSA9IDYgKiAod2lkdGggLSAxKSAqIChyb3dIZWlnaHQgLSAxKTsKICAgIGlmIChub3J0aENhcCkgewogICAgICBpbmRpY2VzU2l6ZSArPSAzICogKHdpZHRoIC0gMSk7CiAgICB9CiAgICBpZiAoc291dGhDYXApIHsKICAgICAgaW5kaWNlc1NpemUgKz0gMyAqICh3aWR0aCAtIDEpOwogICAgfQogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KHNpemUsIGluZGljZXNTaXplKTsKICAgIGxldCBpbmRleCA9IDA7CiAgICBsZXQgaW5kaWNlc0luZGV4ID0gMDsKICAgIGxldCBpOwogICAgZm9yIChpID0gMDsgaSA8IHJvd0hlaWdodCAtIDE7ICsraSkgewogICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHdpZHRoIC0gMTsgKytqKSB7CiAgICAgICAgY29uc3QgdXBwZXJMZWZ0ID0gaW5kZXg7CiAgICAgICAgY29uc3QgbG93ZXJMZWZ0ID0gdXBwZXJMZWZ0ICsgd2lkdGg7CiAgICAgICAgY29uc3QgbG93ZXJSaWdodCA9IGxvd2VyTGVmdCArIDE7CiAgICAgICAgY29uc3QgdXBwZXJSaWdodCA9IHVwcGVyTGVmdCArIDE7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSB1cHBlckxlZnQ7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBsb3dlckxlZnQ7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSB1cHBlclJpZ2h0OwogICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gdXBwZXJSaWdodDsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGxvd2VyTGVmdDsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGxvd2VyUmlnaHQ7CiAgICAgICAgKytpbmRleDsKICAgICAgfQogICAgICArK2luZGV4OwogICAgfQogICAgaWYgKG5vcnRoQ2FwIHx8IHNvdXRoQ2FwKSB7CiAgICAgIGxldCBub3J0aEluZGV4ID0gc2l6ZSAtIDE7CiAgICAgIGNvbnN0IHNvdXRoSW5kZXggPSBzaXplIC0gMTsKICAgICAgaWYgKG5vcnRoQ2FwICYmIHNvdXRoQ2FwKSB7CiAgICAgICAgbm9ydGhJbmRleCA9IHNpemUgLSAyOwogICAgICB9CiAgICAgIGxldCBwMTsKICAgICAgbGV0IHAyOwogICAgICBpbmRleCA9IDA7CiAgICAgIGlmIChub3J0aENhcCkgewogICAgICAgIGZvciAoaSA9IDA7IGkgPCB3aWR0aCAtIDE7IGkrKykgewogICAgICAgICAgcDEgPSBpbmRleDsKICAgICAgICAgIHAyID0gcDEgKyAxOwogICAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBub3J0aEluZGV4OwogICAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwMTsKICAgICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcDI7CiAgICAgICAgICArK2luZGV4OwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoc291dGhDYXApIHsKICAgICAgICBpbmRleCA9IChyb3dIZWlnaHQgLSAxKSAqIHdpZHRoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCB3aWR0aCAtIDE7IGkrKykgewogICAgICAgICAgcDEgPSBpbmRleDsKICAgICAgICAgIHAyID0gcDEgKyAxOwogICAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwMTsKICAgICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gc291dGhJbmRleDsKICAgICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcDI7CiAgICAgICAgICArK2luZGV4OwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZ2VvLmluZGljZXMgPSBpbmRpY2VzOwogICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICBnZW8uYXR0cmlidXRlcy5zdCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgIHZhbHVlczogdGV4dHVyZUNvb3JkaW5hdGVzCiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIGdlbzsKICB9CiAgZnVuY3Rpb24gYWRkV2FsbFBvc2l0aW9uczIod2FsbFBvc2l0aW9ucywgcG9zSW5kZXgsIGksIHRvcFBvc2l0aW9ucywgYm90dG9tUG9zaXRpb25zKSB7CiAgICB3YWxsUG9zaXRpb25zW3Bvc0luZGV4KytdID0gdG9wUG9zaXRpb25zW2ldOwogICAgd2FsbFBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHRvcFBvc2l0aW9uc1tpICsgMV07CiAgICB3YWxsUG9zaXRpb25zW3Bvc0luZGV4KytdID0gdG9wUG9zaXRpb25zW2kgKyAyXTsKICAgIHdhbGxQb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBib3R0b21Qb3NpdGlvbnNbaV07CiAgICB3YWxsUG9zaXRpb25zW3Bvc0luZGV4KytdID0gYm90dG9tUG9zaXRpb25zW2kgKyAxXTsKICAgIHdhbGxQb3NpdGlvbnNbcG9zSW5kZXhdID0gYm90dG9tUG9zaXRpb25zW2kgKyAyXTsKICAgIHJldHVybiB3YWxsUG9zaXRpb25zOwogIH0KICBmdW5jdGlvbiBhZGRXYWxsVGV4dHVyZUNvb3JkaW5hdGVzKHdhbGxUZXh0dXJlcywgc3RJbmRleCwgaSwgc3QpIHsKICAgIHdhbGxUZXh0dXJlc1tzdEluZGV4KytdID0gc3RbaV07CiAgICB3YWxsVGV4dHVyZXNbc3RJbmRleCsrXSA9IHN0W2kgKyAxXTsKICAgIHdhbGxUZXh0dXJlc1tzdEluZGV4KytdID0gc3RbaV07CiAgICB3YWxsVGV4dHVyZXNbc3RJbmRleF0gPSBzdFtpICsgMV07CiAgICByZXR1cm4gd2FsbFRleHR1cmVzOwogIH0KICBmdW5jdGlvbiBjb25zdHJ1Y3RFeHRydWRlZFJlY3RhbmdsZShyZWN0YW5nbGVHZW9tZXRyeSwgY29tcHV0ZWRPcHRpb25zKSB7CiAgICBjb25zdCBzaGFkb3dWb2x1bWUgPSByZWN0YW5nbGVHZW9tZXRyeS5fc2hhZG93Vm9sdW1lOwogICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlVmFsdWUgPSByZWN0YW5nbGVHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlOwogICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gcmVjdGFuZ2xlR2VvbWV0cnkuX3ZlcnRleEZvcm1hdDsKICAgIGNvbnN0IG1pbkhlaWdodCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9leHRydWRlZEhlaWdodDsKICAgIGNvbnN0IG1heEhlaWdodCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9zdXJmYWNlSGVpZ2h0OwogICAgY29uc3QgZWxsaXBzb2lkID0gcmVjdGFuZ2xlR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgIGNvbnN0IGhlaWdodCA9IGNvbXB1dGVkT3B0aW9ucy5oZWlnaHQ7CiAgICBjb25zdCB3aWR0aCA9IGNvbXB1dGVkT3B0aW9ucy53aWR0aDsKICAgIGxldCBpOwogICAgaWYgKHNoYWRvd1ZvbHVtZSkgewogICAgICBjb25zdCBuZXdWZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSgKICAgICAgICB2ZXJ0ZXhGb3JtYXQsCiAgICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDEyCiAgICAgICk7CiAgICAgIG5ld1ZlcnRleEZvcm1hdC5ub3JtYWwgPSB0cnVlOwogICAgICByZWN0YW5nbGVHZW9tZXRyeS5fdmVydGV4Rm9ybWF0ID0gbmV3VmVydGV4Rm9ybWF0OwogICAgfQogICAgY29uc3QgdG9wQm90dG9tR2VvID0gY29uc3RydWN0UmVjdGFuZ2xlKHJlY3RhbmdsZUdlb21ldHJ5LCBjb21wdXRlZE9wdGlvbnMpOwogICAgaWYgKHNoYWRvd1ZvbHVtZSkgewogICAgICByZWN0YW5nbGVHZW9tZXRyeS5fdmVydGV4Rm9ybWF0ID0gdmVydGV4Rm9ybWF0OwogICAgfQogICAgbGV0IHRvcFBvc2l0aW9ucyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodCgKICAgICAgdG9wQm90dG9tR2VvLmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLAogICAgICBtYXhIZWlnaHQsCiAgICAgIGVsbGlwc29pZCwKICAgICAgZmFsc2UKICAgICk7CiAgICB0b3BQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHRvcFBvc2l0aW9ucyk7CiAgICBsZXQgbGVuZ3RoID0gdG9wUG9zaXRpb25zLmxlbmd0aDsKICAgIGNvbnN0IG5ld0xlbmd0aCA9IGxlbmd0aCAqIDI7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KG5ld0xlbmd0aCk7CiAgICBwb3NpdGlvbnMuc2V0KHRvcFBvc2l0aW9ucyk7CiAgICBjb25zdCBib3R0b21Qb3NpdGlvbnMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgIHRvcEJvdHRvbUdlby5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgbWluSGVpZ2h0LAogICAgICBlbGxpcHNvaWQKICAgICk7CiAgICBwb3NpdGlvbnMuc2V0KGJvdHRvbVBvc2l0aW9ucywgbGVuZ3RoKTsKICAgIHRvcEJvdHRvbUdlby5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyA9IHBvc2l0aW9uczsKICAgIGNvbnN0IG5vcm1hbHMgPSB2ZXJ0ZXhGb3JtYXQubm9ybWFsID8gbmV3IEZsb2F0MzJBcnJheShuZXdMZW5ndGgpIDogdm9pZCAwOwogICAgY29uc3QgdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkobmV3TGVuZ3RoKSA6IHZvaWQgMDsKICAgIGNvbnN0IGJpdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShuZXdMZW5ndGgpIDogdm9pZCAwOwogICAgY29uc3QgdGV4dHVyZXMgPSB2ZXJ0ZXhGb3JtYXQuc3QgPyBuZXcgRmxvYXQzMkFycmF5KG5ld0xlbmd0aCAvIDMgKiAyKSA6IHZvaWQgMDsKICAgIGxldCB0b3BTdDsKICAgIGxldCB0b3BOb3JtYWxzOwogICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgdG9wTm9ybWFscyA9IHRvcEJvdHRvbUdlby5hdHRyaWJ1dGVzLm5vcm1hbC52YWx1ZXM7CiAgICAgIG5vcm1hbHMuc2V0KHRvcE5vcm1hbHMpOwogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICB0b3BOb3JtYWxzW2ldID0gLXRvcE5vcm1hbHNbaV07CiAgICAgIH0KICAgICAgbm9ybWFscy5zZXQodG9wTm9ybWFscywgbGVuZ3RoKTsKICAgICAgdG9wQm90dG9tR2VvLmF0dHJpYnV0ZXMubm9ybWFsLnZhbHVlcyA9IG5vcm1hbHM7CiAgICB9CiAgICBpZiAoc2hhZG93Vm9sdW1lKSB7CiAgICAgIHRvcE5vcm1hbHMgPSB0b3BCb3R0b21HZW8uYXR0cmlidXRlcy5ub3JtYWwudmFsdWVzOwogICAgICBpZiAoIXZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICB0b3BCb3R0b21HZW8uYXR0cmlidXRlcy5ub3JtYWwgPSB2b2lkIDA7CiAgICAgIH0KICAgICAgY29uc3QgZXh0cnVkZU5vcm1hbHMgPSBuZXcgRmxvYXQzMkFycmF5KG5ld0xlbmd0aCk7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIHRvcE5vcm1hbHNbaV0gPSAtdG9wTm9ybWFsc1tpXTsKICAgICAgfQogICAgICBleHRydWRlTm9ybWFscy5zZXQodG9wTm9ybWFscywgbGVuZ3RoKTsKICAgICAgdG9wQm90dG9tR2VvLmF0dHJpYnV0ZXMuZXh0cnVkZURpcmVjdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogZXh0cnVkZU5vcm1hbHMKICAgICAgfSk7CiAgICB9CiAgICBsZXQgb2Zmc2V0VmFsdWU7CiAgICBjb25zdCBoYXNPZmZzZXRzID0gZGVmaW5lZF9kZWZhdWx0KG9mZnNldEF0dHJpYnV0ZVZhbHVlKTsKICAgIGlmIChoYXNPZmZzZXRzKSB7CiAgICAgIGNvbnN0IHNpemUgPSBsZW5ndGggLyAzICogMjsKICAgICAgbGV0IG9mZnNldEF0dHJpYnV0ZSA9IG5ldyBVaW50OEFycmF5KHNpemUpOwogICAgICBpZiAob2Zmc2V0QXR0cmlidXRlVmFsdWUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuVE9QKSB7CiAgICAgICAgb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlLmZpbGwoMSwgMCwgc2l6ZSAvIDIpOwogICAgICB9IGVsc2UgewogICAgICAgIG9mZnNldFZhbHVlID0gb2Zmc2V0QXR0cmlidXRlVmFsdWUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgIG9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgfQogICAgICB0b3BCb3R0b21HZW8uYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgdmFsdWVzOiBvZmZzZXRBdHRyaWJ1dGUKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgY29uc3QgdG9wVGFuZ2VudHMgPSB0b3BCb3R0b21HZW8uYXR0cmlidXRlcy50YW5nZW50LnZhbHVlczsKICAgICAgdGFuZ2VudHMuc2V0KHRvcFRhbmdlbnRzKTsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgdG9wVGFuZ2VudHNbaV0gPSAtdG9wVGFuZ2VudHNbaV07CiAgICAgIH0KICAgICAgdGFuZ2VudHMuc2V0KHRvcFRhbmdlbnRzLCBsZW5ndGgpOwogICAgICB0b3BCb3R0b21HZW8uYXR0cmlidXRlcy50YW5nZW50LnZhbHVlcyA9IHRhbmdlbnRzOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgY29uc3QgdG9wQml0YW5nZW50cyA9IHRvcEJvdHRvbUdlby5hdHRyaWJ1dGVzLmJpdGFuZ2VudC52YWx1ZXM7CiAgICAgIGJpdGFuZ2VudHMuc2V0KHRvcEJpdGFuZ2VudHMpOwogICAgICBiaXRhbmdlbnRzLnNldCh0b3BCaXRhbmdlbnRzLCBsZW5ndGgpOwogICAgICB0b3BCb3R0b21HZW8uYXR0cmlidXRlcy5iaXRhbmdlbnQudmFsdWVzID0gYml0YW5nZW50czsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgdG9wU3QgPSB0b3BCb3R0b21HZW8uYXR0cmlidXRlcy5zdC52YWx1ZXM7CiAgICAgIHRleHR1cmVzLnNldCh0b3BTdCk7CiAgICAgIHRleHR1cmVzLnNldCh0b3BTdCwgbGVuZ3RoIC8gMyAqIDIpOwogICAgICB0b3BCb3R0b21HZW8uYXR0cmlidXRlcy5zdC52YWx1ZXMgPSB0ZXh0dXJlczsKICAgIH0KICAgIGNvbnN0IGluZGljZXMgPSB0b3BCb3R0b21HZW8uaW5kaWNlczsKICAgIGNvbnN0IGluZGljZXNMZW5ndGggPSBpbmRpY2VzLmxlbmd0aDsKICAgIGNvbnN0IHBvc0xlbmd0aCA9IGxlbmd0aCAvIDM7CiAgICBjb25zdCBuZXdJbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIG5ld0xlbmd0aCAvIDMsCiAgICAgIGluZGljZXNMZW5ndGggKiAyCiAgICApOwogICAgbmV3SW5kaWNlcy5zZXQoaW5kaWNlcyk7CiAgICBmb3IgKGkgPSAwOyBpIDwgaW5kaWNlc0xlbmd0aDsgaSArPSAzKSB7CiAgICAgIG5ld0luZGljZXNbaSArIGluZGljZXNMZW5ndGhdID0gaW5kaWNlc1tpICsgMl0gKyBwb3NMZW5ndGg7CiAgICAgIG5ld0luZGljZXNbaSArIDEgKyBpbmRpY2VzTGVuZ3RoXSA9IGluZGljZXNbaSArIDFdICsgcG9zTGVuZ3RoOwogICAgICBuZXdJbmRpY2VzW2kgKyAyICsgaW5kaWNlc0xlbmd0aF0gPSBpbmRpY2VzW2ldICsgcG9zTGVuZ3RoOwogICAgfQogICAgdG9wQm90dG9tR2VvLmluZGljZXMgPSBuZXdJbmRpY2VzOwogICAgY29uc3Qgbm9ydGhDYXAgPSBjb21wdXRlZE9wdGlvbnMubm9ydGhDYXA7CiAgICBjb25zdCBzb3V0aENhcCA9IGNvbXB1dGVkT3B0aW9ucy5zb3V0aENhcDsKICAgIGxldCByb3dIZWlnaHQgPSBoZWlnaHQ7CiAgICBsZXQgd2lkdGhNdWx0aXBsaWVyID0gMjsKICAgIGxldCBwZXJpbWV0ZXJQb3NpdGlvbnMgPSAwOwogICAgbGV0IGNvcm5lcnMgPSA0OwogICAgbGV0IGR1cGxpYXRlQ29ybmVycyA9IDQ7CiAgICBpZiAobm9ydGhDYXApIHsKICAgICAgd2lkdGhNdWx0aXBsaWVyIC09IDE7CiAgICAgIHJvd0hlaWdodCAtPSAxOwogICAgICBwZXJpbWV0ZXJQb3NpdGlvbnMgKz0gMTsKICAgICAgY29ybmVycyAtPSAyOwogICAgICBkdXBsaWF0ZUNvcm5lcnMgLT0gMTsKICAgIH0KICAgIGlmIChzb3V0aENhcCkgewogICAgICB3aWR0aE11bHRpcGxpZXIgLT0gMTsKICAgICAgcm93SGVpZ2h0IC09IDE7CiAgICAgIHBlcmltZXRlclBvc2l0aW9ucyArPSAxOwogICAgICBjb3JuZXJzIC09IDI7CiAgICAgIGR1cGxpYXRlQ29ybmVycyAtPSAxOwogICAgfQogICAgcGVyaW1ldGVyUG9zaXRpb25zICs9IHdpZHRoTXVsdGlwbGllciAqIHdpZHRoICsgMiAqIHJvd0hlaWdodCAtIGNvcm5lcnM7CiAgICBjb25zdCB3YWxsQ291bnQgPSAocGVyaW1ldGVyUG9zaXRpb25zICsgZHVwbGlhdGVDb3JuZXJzKSAqIDI7CiAgICBsZXQgd2FsbFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkod2FsbENvdW50ICogMyk7CiAgICBjb25zdCB3YWxsRXh0cnVkZU5vcm1hbHMgPSBzaGFkb3dWb2x1bWUgPyBuZXcgRmxvYXQzMkFycmF5KHdhbGxDb3VudCAqIDMpIDogdm9pZCAwOwogICAgbGV0IHdhbGxPZmZzZXRBdHRyaWJ1dGUgPSBoYXNPZmZzZXRzID8gbmV3IFVpbnQ4QXJyYXkod2FsbENvdW50KSA6IHZvaWQgMDsKICAgIGxldCB3YWxsVGV4dHVyZXMgPSB2ZXJ0ZXhGb3JtYXQuc3QgPyBuZXcgRmxvYXQzMkFycmF5KHdhbGxDb3VudCAqIDIpIDogdm9pZCAwOwogICAgY29uc3QgY29tcHV0ZVRvcE9mZnNldHMgPSBvZmZzZXRBdHRyaWJ1dGVWYWx1ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5UT1A7CiAgICBpZiAoaGFzT2Zmc2V0cyAmJiAhY29tcHV0ZVRvcE9mZnNldHMpIHsKICAgICAgb2Zmc2V0VmFsdWUgPSBvZmZzZXRBdHRyaWJ1dGVWYWx1ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5BTEwgPyAxIDogMDsKICAgICAgd2FsbE9mZnNldEF0dHJpYnV0ZSA9IHdhbGxPZmZzZXRBdHRyaWJ1dGUuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICB9CiAgICBsZXQgcG9zSW5kZXggPSAwOwogICAgbGV0IHN0SW5kZXggPSAwOwogICAgbGV0IGV4dHJ1ZGVOb3JtYWxJbmRleCA9IDA7CiAgICBsZXQgd2FsbE9mZnNldEluZGV4ID0gMDsKICAgIGNvbnN0IGFyZWEgPSB3aWR0aCAqIHJvd0hlaWdodDsKICAgIGxldCB0aHJlZUk7CiAgICBmb3IgKGkgPSAwOyBpIDwgYXJlYTsgaSArPSB3aWR0aCkgewogICAgICB0aHJlZUkgPSBpICogMzsKICAgICAgd2FsbFBvc2l0aW9ucyA9IGFkZFdhbGxQb3NpdGlvbnMyKAogICAgICAgIHdhbGxQb3NpdGlvbnMsCiAgICAgICAgcG9zSW5kZXgsCiAgICAgICAgdGhyZWVJLAogICAgICAgIHRvcFBvc2l0aW9ucywKICAgICAgICBib3R0b21Qb3NpdGlvbnMKICAgICAgKTsKICAgICAgcG9zSW5kZXggKz0gNjsKICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgIHdhbGxUZXh0dXJlcyA9IGFkZFdhbGxUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICB3YWxsVGV4dHVyZXMsCiAgICAgICAgICBzdEluZGV4LAogICAgICAgICAgaSAqIDIsCiAgICAgICAgICB0b3BTdAogICAgICAgICk7CiAgICAgICAgc3RJbmRleCArPSA0OwogICAgICB9CiAgICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgICBleHRydWRlTm9ybWFsSW5kZXggKz0gMzsKICAgICAgICB3YWxsRXh0cnVkZU5vcm1hbHNbZXh0cnVkZU5vcm1hbEluZGV4KytdID0gdG9wTm9ybWFsc1t0aHJlZUldOwogICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSSArIDFdOwogICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSSArIDJdOwogICAgICB9CiAgICAgIGlmIChjb21wdXRlVG9wT2Zmc2V0cykgewogICAgICAgIHdhbGxPZmZzZXRBdHRyaWJ1dGVbd2FsbE9mZnNldEluZGV4KytdID0gMTsKICAgICAgICB3YWxsT2Zmc2V0SW5kZXggKz0gMTsKICAgICAgfQogICAgfQogICAgaWYgKCFzb3V0aENhcCkgewogICAgICBmb3IgKGkgPSBhcmVhIC0gd2lkdGg7IGkgPCBhcmVhOyBpKyspIHsKICAgICAgICB0aHJlZUkgPSBpICogMzsKICAgICAgICB3YWxsUG9zaXRpb25zID0gYWRkV2FsbFBvc2l0aW9uczIoCiAgICAgICAgICB3YWxsUG9zaXRpb25zLAogICAgICAgICAgcG9zSW5kZXgsCiAgICAgICAgICB0aHJlZUksCiAgICAgICAgICB0b3BQb3NpdGlvbnMsCiAgICAgICAgICBib3R0b21Qb3NpdGlvbnMKICAgICAgICApOwogICAgICAgIHBvc0luZGV4ICs9IDY7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgd2FsbFRleHR1cmVzID0gYWRkV2FsbFRleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgICAgd2FsbFRleHR1cmVzLAogICAgICAgICAgICBzdEluZGV4LAogICAgICAgICAgICBpICogMiwKICAgICAgICAgICAgdG9wU3QKICAgICAgICAgICk7CiAgICAgICAgICBzdEluZGV4ICs9IDQ7CiAgICAgICAgfQogICAgICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgICAgIGV4dHJ1ZGVOb3JtYWxJbmRleCArPSAzOwogICAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJXTsKICAgICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSSArIDFdOwogICAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJICsgMl07CiAgICAgICAgfQogICAgICAgIGlmIChjb21wdXRlVG9wT2Zmc2V0cykgewogICAgICAgICAgd2FsbE9mZnNldEF0dHJpYnV0ZVt3YWxsT2Zmc2V0SW5kZXgrK10gPSAxOwogICAgICAgICAgd2FsbE9mZnNldEluZGV4ICs9IDE7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBjb25zdCBzb3V0aEluZGV4ID0gbm9ydGhDYXAgPyBhcmVhICsgMSA6IGFyZWE7CiAgICAgIHRocmVlSSA9IHNvdXRoSW5kZXggKiAzOwogICAgICBmb3IgKGkgPSAwOyBpIDwgMjsgaSsrKSB7CiAgICAgICAgd2FsbFBvc2l0aW9ucyA9IGFkZFdhbGxQb3NpdGlvbnMyKAogICAgICAgICAgd2FsbFBvc2l0aW9ucywKICAgICAgICAgIHBvc0luZGV4LAogICAgICAgICAgdGhyZWVJLAogICAgICAgICAgdG9wUG9zaXRpb25zLAogICAgICAgICAgYm90dG9tUG9zaXRpb25zCiAgICAgICAgKTsKICAgICAgICBwb3NJbmRleCArPSA2OwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgIHdhbGxUZXh0dXJlcyA9IGFkZFdhbGxUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICAgIHdhbGxUZXh0dXJlcywKICAgICAgICAgICAgc3RJbmRleCwKICAgICAgICAgICAgc291dGhJbmRleCAqIDIsCiAgICAgICAgICAgIHRvcFN0CiAgICAgICAgICApOwogICAgICAgICAgc3RJbmRleCArPSA0OwogICAgICAgIH0KICAgICAgICBpZiAoc2hhZG93Vm9sdW1lKSB7CiAgICAgICAgICBleHRydWRlTm9ybWFsSW5kZXggKz0gMzsKICAgICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSV07CiAgICAgICAgICB3YWxsRXh0cnVkZU5vcm1hbHNbZXh0cnVkZU5vcm1hbEluZGV4KytdID0gdG9wTm9ybWFsc1t0aHJlZUkgKyAxXTsKICAgICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSSArIDJdOwogICAgICAgIH0KICAgICAgICBpZiAoY29tcHV0ZVRvcE9mZnNldHMpIHsKICAgICAgICAgIHdhbGxPZmZzZXRBdHRyaWJ1dGVbd2FsbE9mZnNldEluZGV4KytdID0gMTsKICAgICAgICAgIHdhbGxPZmZzZXRJbmRleCArPSAxOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZm9yIChpID0gYXJlYSAtIDE7IGkgPiAwOyBpIC09IHdpZHRoKSB7CiAgICAgIHRocmVlSSA9IGkgKiAzOwogICAgICB3YWxsUG9zaXRpb25zID0gYWRkV2FsbFBvc2l0aW9uczIoCiAgICAgICAgd2FsbFBvc2l0aW9ucywKICAgICAgICBwb3NJbmRleCwKICAgICAgICB0aHJlZUksCiAgICAgICAgdG9wUG9zaXRpb25zLAogICAgICAgIGJvdHRvbVBvc2l0aW9ucwogICAgICApOwogICAgICBwb3NJbmRleCArPSA2OwogICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgd2FsbFRleHR1cmVzID0gYWRkV2FsbFRleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgIHdhbGxUZXh0dXJlcywKICAgICAgICAgIHN0SW5kZXgsCiAgICAgICAgICBpICogMiwKICAgICAgICAgIHRvcFN0CiAgICAgICAgKTsKICAgICAgICBzdEluZGV4ICs9IDQ7CiAgICAgIH0KICAgICAgaWYgKHNoYWRvd1ZvbHVtZSkgewogICAgICAgIGV4dHJ1ZGVOb3JtYWxJbmRleCArPSAzOwogICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSV07CiAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJICsgMV07CiAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJICsgMl07CiAgICAgIH0KICAgICAgaWYgKGNvbXB1dGVUb3BPZmZzZXRzKSB7CiAgICAgICAgd2FsbE9mZnNldEF0dHJpYnV0ZVt3YWxsT2Zmc2V0SW5kZXgrK10gPSAxOwogICAgICAgIHdhbGxPZmZzZXRJbmRleCArPSAxOwogICAgICB9CiAgICB9CiAgICBpZiAoIW5vcnRoQ2FwKSB7CiAgICAgIGZvciAoaSA9IHdpZHRoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICB0aHJlZUkgPSBpICogMzsKICAgICAgICB3YWxsUG9zaXRpb25zID0gYWRkV2FsbFBvc2l0aW9uczIoCiAgICAgICAgICB3YWxsUG9zaXRpb25zLAogICAgICAgICAgcG9zSW5kZXgsCiAgICAgICAgICB0aHJlZUksCiAgICAgICAgICB0b3BQb3NpdGlvbnMsCiAgICAgICAgICBib3R0b21Qb3NpdGlvbnMKICAgICAgICApOwogICAgICAgIHBvc0luZGV4ICs9IDY7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgd2FsbFRleHR1cmVzID0gYWRkV2FsbFRleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgICAgd2FsbFRleHR1cmVzLAogICAgICAgICAgICBzdEluZGV4LAogICAgICAgICAgICBpICogMiwKICAgICAgICAgICAgdG9wU3QKICAgICAgICAgICk7CiAgICAgICAgICBzdEluZGV4ICs9IDQ7CiAgICAgICAgfQogICAgICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgICAgIGV4dHJ1ZGVOb3JtYWxJbmRleCArPSAzOwogICAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJXTsKICAgICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSSArIDFdOwogICAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJICsgMl07CiAgICAgICAgfQogICAgICAgIGlmIChjb21wdXRlVG9wT2Zmc2V0cykgewogICAgICAgICAgd2FsbE9mZnNldEF0dHJpYnV0ZVt3YWxsT2Zmc2V0SW5kZXgrK10gPSAxOwogICAgICAgICAgd2FsbE9mZnNldEluZGV4ICs9IDE7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBjb25zdCBub3J0aEluZGV4ID0gYXJlYTsKICAgICAgdGhyZWVJID0gbm9ydGhJbmRleCAqIDM7CiAgICAgIGZvciAoaSA9IDA7IGkgPCAyOyBpKyspIHsKICAgICAgICB3YWxsUG9zaXRpb25zID0gYWRkV2FsbFBvc2l0aW9uczIoCiAgICAgICAgICB3YWxsUG9zaXRpb25zLAogICAgICAgICAgcG9zSW5kZXgsCiAgICAgICAgICB0aHJlZUksCiAgICAgICAgICB0b3BQb3NpdGlvbnMsCiAgICAgICAgICBib3R0b21Qb3NpdGlvbnMKICAgICAgICApOwogICAgICAgIHBvc0luZGV4ICs9IDY7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgd2FsbFRleHR1cmVzID0gYWRkV2FsbFRleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgICAgd2FsbFRleHR1cmVzLAogICAgICAgICAgICBzdEluZGV4LAogICAgICAgICAgICBub3J0aEluZGV4ICogMiwKICAgICAgICAgICAgdG9wU3QKICAgICAgICAgICk7CiAgICAgICAgICBzdEluZGV4ICs9IDQ7CiAgICAgICAgfQogICAgICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgICAgIGV4dHJ1ZGVOb3JtYWxJbmRleCArPSAzOwogICAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJXTsKICAgICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSSArIDFdOwogICAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJICsgMl07CiAgICAgICAgfQogICAgICAgIGlmIChjb21wdXRlVG9wT2Zmc2V0cykgewogICAgICAgICAgd2FsbE9mZnNldEF0dHJpYnV0ZVt3YWxsT2Zmc2V0SW5kZXgrK10gPSAxOwogICAgICAgICAgd2FsbE9mZnNldEluZGV4ICs9IDE7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBsZXQgZ2VvID0gY2FsY3VsYXRlQXR0cmlidXRlc1dhbGwod2FsbFBvc2l0aW9ucywgdmVydGV4Rm9ybWF0LCBlbGxpcHNvaWQpOwogICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICBnZW8uYXR0cmlidXRlcy5zdCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgIHZhbHVlczogd2FsbFRleHR1cmVzCiAgICAgIH0pOwogICAgfQogICAgaWYgKHNoYWRvd1ZvbHVtZSkgewogICAgICBnZW8uYXR0cmlidXRlcy5leHRydWRlRGlyZWN0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiB3YWxsRXh0cnVkZU5vcm1hbHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAoaGFzT2Zmc2V0cykgewogICAgICBnZW8uYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgdmFsdWVzOiB3YWxsT2Zmc2V0QXR0cmlidXRlCiAgICAgIH0pOwogICAgfQogICAgY29uc3Qgd2FsbEluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgd2FsbENvdW50LAogICAgICBwZXJpbWV0ZXJQb3NpdGlvbnMgKiA2CiAgICApOwogICAgbGV0IHVwcGVyTGVmdDsKICAgIGxldCBsb3dlckxlZnQ7CiAgICBsZXQgbG93ZXJSaWdodDsKICAgIGxldCB1cHBlclJpZ2h0OwogICAgbGVuZ3RoID0gd2FsbFBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGggLSAxOyBpICs9IDIpIHsKICAgICAgdXBwZXJMZWZ0ID0gaTsKICAgICAgdXBwZXJSaWdodCA9ICh1cHBlckxlZnQgKyAyKSAlIGxlbmd0aDsKICAgICAgY29uc3QgcDEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHdhbGxQb3NpdGlvbnMsIHVwcGVyTGVmdCAqIDMsIHYxU2NyYXRjaCk7CiAgICAgIGNvbnN0IHAyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSh3YWxsUG9zaXRpb25zLCB1cHBlclJpZ2h0ICogMywgdjJTY3JhdGNoKTsKICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKHAxLCBwMiwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMCkpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBsb3dlckxlZnQgPSAodXBwZXJMZWZ0ICsgMSkgJSBsZW5ndGg7CiAgICAgIGxvd2VyUmlnaHQgPSAobG93ZXJMZWZ0ICsgMikgJSBsZW5ndGg7CiAgICAgIHdhbGxJbmRpY2VzW2luZGV4KytdID0gdXBwZXJMZWZ0OwogICAgICB3YWxsSW5kaWNlc1tpbmRleCsrXSA9IGxvd2VyTGVmdDsKICAgICAgd2FsbEluZGljZXNbaW5kZXgrK10gPSB1cHBlclJpZ2h0OwogICAgICB3YWxsSW5kaWNlc1tpbmRleCsrXSA9IHVwcGVyUmlnaHQ7CiAgICAgIHdhbGxJbmRpY2VzW2luZGV4KytdID0gbG93ZXJMZWZ0OwogICAgICB3YWxsSW5kaWNlc1tpbmRleCsrXSA9IGxvd2VyUmlnaHQ7CiAgICB9CiAgICBnZW8uaW5kaWNlcyA9IHdhbGxJbmRpY2VzOwogICAgZ2VvID0gR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LmNvbWJpbmVJbnN0YW5jZXMoWwogICAgICBuZXcgR2VvbWV0cnlJbnN0YW5jZV9kZWZhdWx0KHsKICAgICAgICBnZW9tZXRyeTogdG9wQm90dG9tR2VvCiAgICAgIH0pLAogICAgICBuZXcgR2VvbWV0cnlJbnN0YW5jZV9kZWZhdWx0KHsKICAgICAgICBnZW9tZXRyeTogZ2VvCiAgICAgIH0pCiAgICBdKTsKICAgIHJldHVybiBnZW9bMF07CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVSZWN0YW5nbGUzKHJlY3RhbmdsZSwgZ3JhbnVsYXJpdHksIHJvdGF0aW9uLCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgaWYgKHJvdGF0aW9uID09PSAwKSB7CiAgICAgIHJldHVybiBSZWN0YW5nbGVfZGVmYXVsdC5jbG9uZShyZWN0YW5nbGUsIHJlc3VsdCk7CiAgICB9CiAgICBjb25zdCBjb21wdXRlZE9wdGlvbnMgPSBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlT3B0aW9ucygKICAgICAgcmVjdGFuZ2xlLAogICAgICBncmFudWxhcml0eSwKICAgICAgcm90YXRpb24sCiAgICAgIDAsCiAgICAgIHJlY3RhbmdsZVNjcmF0Y2gsCiAgICAgIG53U2NyYXRjaAogICAgKTsKICAgIGNvbnN0IGhlaWdodCA9IGNvbXB1dGVkT3B0aW9ucy5oZWlnaHQ7CiAgICBjb25zdCB3aWR0aCA9IGNvbXB1dGVkT3B0aW9ucy53aWR0aDsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IHNjcmF0Y2hSZWN0YW5nbGVQb2ludHM7CiAgICBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb24oCiAgICAgIGNvbXB1dGVkT3B0aW9ucywKICAgICAgZWxsaXBzb2lkLAogICAgICBmYWxzZSwKICAgICAgMCwKICAgICAgMCwKICAgICAgcG9zaXRpb25zWzBdCiAgICApOwogICAgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9uKAogICAgICBjb21wdXRlZE9wdGlvbnMsCiAgICAgIGVsbGlwc29pZCwKICAgICAgZmFsc2UsCiAgICAgIDAsCiAgICAgIHdpZHRoIC0gMSwKICAgICAgcG9zaXRpb25zWzFdCiAgICApOwogICAgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9uKAogICAgICBjb21wdXRlZE9wdGlvbnMsCiAgICAgIGVsbGlwc29pZCwKICAgICAgZmFsc2UsCiAgICAgIGhlaWdodCAtIDEsCiAgICAgIDAsCiAgICAgIHBvc2l0aW9uc1syXQogICAgKTsKICAgIFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbigKICAgICAgY29tcHV0ZWRPcHRpb25zLAogICAgICBlbGxpcHNvaWQsCiAgICAgIGZhbHNlLAogICAgICBoZWlnaHQgLSAxLAogICAgICB3aWR0aCAtIDEsCiAgICAgIHBvc2l0aW9uc1szXQogICAgKTsKICAgIHJldHVybiBSZWN0YW5nbGVfZGVmYXVsdC5mcm9tQ2FydGVzaWFuQXJyYXkocG9zaXRpb25zLCBlbGxpcHNvaWQsIHJlc3VsdCk7CiAgfQogIGZ1bmN0aW9uIFJlY3RhbmdsZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgcmVjdGFuZ2xlID0gb3B0aW9ucy5yZWN0YW5nbGU7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICBSZWN0YW5nbGVfZGVmYXVsdC52YWxpZGF0ZShyZWN0YW5nbGUpOwogICAgaWYgKHJlY3RhbmdsZS5ub3J0aCA8IHJlY3RhbmdsZS5zb3V0aCkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAib3B0aW9ucy5yZWN0YW5nbGUubm9ydGggbXVzdCBiZSBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8gb3B0aW9ucy5yZWN0YW5nbGUuc291dGgiCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBoZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmhlaWdodCwgMCk7CiAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQsIGhlaWdodCk7CiAgICB0aGlzLl9yZWN0YW5nbGUgPSBSZWN0YW5nbGVfZGVmYXVsdC5jbG9uZShyZWN0YW5nbGUpOwogICAgdGhpcy5fZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRQogICAgKTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpCiAgICApOwogICAgdGhpcy5fc3VyZmFjZUhlaWdodCA9IE1hdGgubWF4KGhlaWdodCwgZXh0cnVkZWRIZWlnaHQpOwogICAgdGhpcy5fcm90YXRpb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnJvdGF0aW9uLCAwKTsKICAgIHRoaXMuX3N0Um90YXRpb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnN0Um90YXRpb24sIDApOwogICAgdGhpcy5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUoCiAgICAgIGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMudmVydGV4Rm9ybWF0LCBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5ERUZBVUxUKQogICAgKTsKICAgIHRoaXMuX2V4dHJ1ZGVkSGVpZ2h0ID0gTWF0aC5taW4oaGVpZ2h0LCBleHRydWRlZEhlaWdodCk7CiAgICB0aGlzLl9zaGFkb3dWb2x1bWUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnNoYWRvd1ZvbHVtZSwgZmFsc2UpOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVSZWN0YW5nbGVHZW9tZXRyeSI7CiAgICB0aGlzLl9vZmZzZXRBdHRyaWJ1dGUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZTsKICAgIHRoaXMuX3JvdGF0ZWRSZWN0YW5nbGUgPSB2b2lkIDA7CiAgICB0aGlzLl90ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzID0gdm9pZCAwOwogIH0KICBmdW5jdGlvbiB0ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzMyhyZWN0YW5nbGVHZW9tZXRyeSkgewogICAgaWYgKHJlY3RhbmdsZUdlb21ldHJ5Ll9zdFJvdGF0aW9uID09PSAwKSB7CiAgICAgIHJldHVybiBbMCwgMCwgMCwgMSwgMSwgMF07CiAgICB9CiAgICBjb25zdCByZWN0YW5nbGUgPSBSZWN0YW5nbGVfZGVmYXVsdC5jbG9uZSgKICAgICAgcmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZSwKICAgICAgdW5yb3RhdGVkVGV4dHVyZVJlY3RhbmdsZVNjcmF0Y2gKICAgICk7CiAgICBjb25zdCBncmFudWxhcml0eSA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9ncmFudWxhcml0eTsKICAgIGNvbnN0IGVsbGlwc29pZCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICBjb25zdCByb3RhdGlvbiA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9yb3RhdGlvbiAtIHJlY3RhbmdsZUdlb21ldHJ5Ll9zdFJvdGF0aW9uOwogICAgY29uc3QgdW5yb3RhdGVkVGV4dHVyZVJlY3RhbmdsZSA9IGNvbXB1dGVSZWN0YW5nbGUzKAogICAgICByZWN0YW5nbGUsCiAgICAgIGdyYW51bGFyaXR5LAogICAgICByb3RhdGlvbiwKICAgICAgZWxsaXBzb2lkLAogICAgICB1bnJvdGF0ZWRUZXh0dXJlUmVjdGFuZ2xlU2NyYXRjaAogICAgKTsKICAgIGNvbnN0IHBvaW50czJEID0gcG9pbnRzMkRTY3JhdGNoMjsKICAgIHBvaW50czJEWzBdLnggPSB1bnJvdGF0ZWRUZXh0dXJlUmVjdGFuZ2xlLndlc3Q7CiAgICBwb2ludHMyRFswXS55ID0gdW5yb3RhdGVkVGV4dHVyZVJlY3RhbmdsZS5zb3V0aDsKICAgIHBvaW50czJEWzFdLnggPSB1bnJvdGF0ZWRUZXh0dXJlUmVjdGFuZ2xlLndlc3Q7CiAgICBwb2ludHMyRFsxXS55ID0gdW5yb3RhdGVkVGV4dHVyZVJlY3RhbmdsZS5ub3J0aDsKICAgIHBvaW50czJEWzJdLnggPSB1bnJvdGF0ZWRUZXh0dXJlUmVjdGFuZ2xlLmVhc3Q7CiAgICBwb2ludHMyRFsyXS55ID0gdW5yb3RhdGVkVGV4dHVyZVJlY3RhbmdsZS5zb3V0aDsKICAgIGNvbnN0IGJvdW5kaW5nUmVjdGFuZ2xlID0gcmVjdGFuZ2xlR2VvbWV0cnkucmVjdGFuZ2xlOwogICAgY29uc3QgdG9EZXNpcmVkSW5Db21wdXRlZCA9IE1hdHJpeDJfZGVmYXVsdC5mcm9tUm90YXRpb24oCiAgICAgIHJlY3RhbmdsZUdlb21ldHJ5Ll9zdFJvdGF0aW9uLAogICAgICByb3RhdGlvbjJEU2NyYXRjaDIKICAgICk7CiAgICBjb25zdCBib3VuZGluZ1JlY3RhbmdsZUNlbnRlciA9IFJlY3RhbmdsZV9kZWZhdWx0LmNlbnRlcigKICAgICAgYm91bmRpbmdSZWN0YW5nbGUsCiAgICAgIHJlY3RhbmdsZUNlbnRlclNjcmF0Y2gyCiAgICApOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCAzOyArK2kpIHsKICAgICAgY29uc3QgcG9pbnQyRCA9IHBvaW50czJEW2ldOwogICAgICBwb2ludDJELnggLT0gYm91bmRpbmdSZWN0YW5nbGVDZW50ZXIubG9uZ2l0dWRlOwogICAgICBwb2ludDJELnkgLT0gYm91bmRpbmdSZWN0YW5nbGVDZW50ZXIubGF0aXR1ZGU7CiAgICAgIE1hdHJpeDJfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKHRvRGVzaXJlZEluQ29tcHV0ZWQsIHBvaW50MkQsIHBvaW50MkQpOwogICAgICBwb2ludDJELnggKz0gYm91bmRpbmdSZWN0YW5nbGVDZW50ZXIubG9uZ2l0dWRlOwogICAgICBwb2ludDJELnkgKz0gYm91bmRpbmdSZWN0YW5nbGVDZW50ZXIubGF0aXR1ZGU7CiAgICAgIHBvaW50MkQueCA9IChwb2ludDJELnggLSBib3VuZGluZ1JlY3RhbmdsZS53ZXN0KSAvIGJvdW5kaW5nUmVjdGFuZ2xlLndpZHRoOwogICAgICBwb2ludDJELnkgPSAocG9pbnQyRC55IC0gYm91bmRpbmdSZWN0YW5nbGUuc291dGgpIC8gYm91bmRpbmdSZWN0YW5nbGUuaGVpZ2h0OwogICAgfQogICAgY29uc3QgbWluWFlDb3JuZXIgPSBwb2ludHMyRFswXTsKICAgIGNvbnN0IG1heFlDb3JuZXIgPSBwb2ludHMyRFsxXTsKICAgIGNvbnN0IG1heFhDb3JuZXIgPSBwb2ludHMyRFsyXTsKICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBBcnJheSg2KTsKICAgIENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrKG1pblhZQ29ybmVyLCByZXN1bHQpOwogICAgQ2FydGVzaWFuMl9kZWZhdWx0LnBhY2sobWF4WUNvcm5lciwgcmVzdWx0LCAyKTsKICAgIENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrKG1heFhDb3JuZXIsIHJlc3VsdCwgNCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICB2YXIgcG9zaXRpb25TY3JhdGNoMiwgbm9ybWFsU2NyYXRjaDQsIHRhbmdlbnRTY3JhdGNoMiwgYml0YW5nZW50U2NyYXRjaDIsIHJlY3RhbmdsZVNjcmF0Y2gsIHN0U2NyYXRjaDIsIGJvdHRvbUJvdW5kaW5nU3BoZXJlMywgdG9wQm91bmRpbmdTcGhlcmUzLCB2MVNjcmF0Y2gsIHYyU2NyYXRjaCwgc2NyYXRjaFZlcnRleEZvcm1hdDEyLCBzY3JhdGNoUmVjdGFuZ2xlUG9pbnRzLCBud1NjcmF0Y2gsIHN0TndTY3JhdGNoLCBzY3JhdGNoUmVjdGFuZ2xlLCBzY3JhdGNoRWxsaXBzb2lkMTEsIHNjcmF0Y2hPcHRpb25zMTksIHRhbmdlbnRSb3RhdGlvbk1hdHJpeFNjcmF0Y2gsIHF1YXRlcm5pb25TY3JhdGNoNCwgY2VudGVyU2NyYXRjaDQsIHVucm90YXRlZFRleHR1cmVSZWN0YW5nbGVTY3JhdGNoLCBwb2ludHMyRFNjcmF0Y2gyLCByb3RhdGlvbjJEU2NyYXRjaDIsIHJlY3RhbmdsZUNlbnRlclNjcmF0Y2gyLCBSZWN0YW5nbGVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1JlY3RhbmdsZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZWN0YW5nbGVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlJbnN0YW5jZSgpOwogICAgICBpbml0X0dlb21ldHJ5T2Zmc2V0QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlQaXBlbGluZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MigpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9Qb2x5Z29uUGlwZWxpbmUoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfUXVhdGVybmlvbigpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X1JlY3RhbmdsZUdlb21ldHJ5TGlicmFyeSgpOwogICAgICBpbml0X1ZlcnRleEZvcm1hdCgpOwogICAgICBwb3NpdGlvblNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBub3JtYWxTY3JhdGNoNCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdGFuZ2VudFNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBiaXRhbmdlbnRTY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcmVjdGFuZ2xlU2NyYXRjaCA9IG5ldyBSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgICBzdFNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBib3R0b21Cb3VuZGluZ1NwaGVyZTMgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgpOwogICAgICB0b3BCb3VuZGluZ1NwaGVyZTMgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgpOwogICAgICB2MVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHYyU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDEyID0gbmV3IFZlcnRleEZvcm1hdF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hSZWN0YW5nbGVQb2ludHMgPSBbCiAgICAgICAgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpCiAgICAgIF07CiAgICAgIG53U2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzdE53U2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBSZWN0YW5nbGVHZW9tZXRyeS5wYWNrZWRMZW5ndGggPSBSZWN0YW5nbGVfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyA3OwogICAgICBSZWN0YW5nbGVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBSZWN0YW5nbGVfZGVmYXVsdC5wYWNrKHZhbHVlLl9yZWN0YW5nbGUsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFJlY3RhbmdsZV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrKHZhbHVlLl92ZXJ0ZXhGb3JtYXQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2dyYW51bGFyaXR5OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc3VyZmFjZUhlaWdodDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3JvdGF0aW9uOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc3RSb3RhdGlvbjsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc2hhZG93Vm9sdW1lID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh2YWx1ZS5fb2Zmc2V0QXR0cmlidXRlLCAtMSk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoUmVjdGFuZ2xlID0gbmV3IFJlY3RhbmdsZV9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQxMSA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKEVsbGlwc29pZF9kZWZhdWx0LlVOSVRfU1BIRVJFKTsKICAgICAgc2NyYXRjaE9wdGlvbnMxOSA9IHsKICAgICAgICByZWN0YW5nbGU6IHNjcmF0Y2hSZWN0YW5nbGUsCiAgICAgICAgZWxsaXBzb2lkOiBzY3JhdGNoRWxsaXBzb2lkMTEsCiAgICAgICAgdmVydGV4Rm9ybWF0OiBzY3JhdGNoVmVydGV4Rm9ybWF0MTIsCiAgICAgICAgZ3JhbnVsYXJpdHk6IHZvaWQgMCwKICAgICAgICBoZWlnaHQ6IHZvaWQgMCwKICAgICAgICByb3RhdGlvbjogdm9pZCAwLAogICAgICAgIHN0Um90YXRpb246IHZvaWQgMCwKICAgICAgICBleHRydWRlZEhlaWdodDogdm9pZCAwLAogICAgICAgIHNoYWRvd1ZvbHVtZTogdm9pZCAwLAogICAgICAgIG9mZnNldEF0dHJpYnV0ZTogdm9pZCAwCiAgICAgIH07CiAgICAgIFJlY3RhbmdsZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCByZWN0YW5nbGUgPSBSZWN0YW5nbGVfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hSZWN0YW5nbGUpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gUmVjdGFuZ2xlX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaEVsbGlwc29pZDExKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0MTIKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzdXJmYWNlSGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCByb3RhdGlvbiA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgc3RSb3RhdGlvbiA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHNoYWRvd1ZvbHVtZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPT09IDE7CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxOS5ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxOS5oZWlnaHQgPSBzdXJmYWNlSGVpZ2h0OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxOS5yb3RhdGlvbiA9IHJvdGF0aW9uOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxOS5zdFJvdGF0aW9uID0gc3RSb3RhdGlvbjsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTkuZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTkuc2hhZG93Vm9sdW1lID0gc2hhZG93Vm9sdW1lOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxOS5vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgICAgcmV0dXJuIG5ldyBSZWN0YW5nbGVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczE5KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9yZWN0YW5nbGUgPSBSZWN0YW5nbGVfZGVmYXVsdC5jbG9uZShyZWN0YW5nbGUsIHJlc3VsdC5fcmVjdGFuZ2xlKTsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCwgcmVzdWx0Ll9lbGxpcHNvaWQpOwogICAgICAgIHJlc3VsdC5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0LCByZXN1bHQuX3ZlcnRleEZvcm1hdCk7CiAgICAgICAgcmVzdWx0Ll9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgIHJlc3VsdC5fc3VyZmFjZUhlaWdodCA9IHN1cmZhY2VIZWlnaHQ7CiAgICAgICAgcmVzdWx0Ll9yb3RhdGlvbiA9IHJvdGF0aW9uOwogICAgICAgIHJlc3VsdC5fc3RSb3RhdGlvbiA9IHN0Um90YXRpb247CiAgICAgICAgcmVzdWx0Ll9leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIHJlc3VsdC5fc2hhZG93Vm9sdW1lID0gc2hhZG93Vm9sdW1lOwogICAgICAgIHJlc3VsdC5fb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGVHZW9tZXRyeS5jb21wdXRlUmVjdGFuZ2xlID0gZnVuY3Rpb24ob3B0aW9ucywgcmVzdWx0KSB7CiAgICAgICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICAgICAgY29uc3QgcmVjdGFuZ2xlID0gb3B0aW9ucy5yZWN0YW5nbGU7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgICAgIFJlY3RhbmdsZV9kZWZhdWx0LnZhbGlkYXRlKHJlY3RhbmdsZSk7CiAgICAgICAgaWYgKHJlY3RhbmdsZS5ub3J0aCA8IHJlY3RhbmdsZS5zb3V0aCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJvcHRpb25zLnJlY3RhbmdsZS5ub3J0aCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiBvciBlcXVhbCB0byBvcHRpb25zLnJlY3RhbmdsZS5zb3V0aCIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICAgICAgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRQogICAgICAgICk7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgICAgICBjb25zdCByb3RhdGlvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMucm90YXRpb24sIDApOwogICAgICAgIHJldHVybiBjb21wdXRlUmVjdGFuZ2xlMyhyZWN0YW5nbGUsIGdyYW51bGFyaXR5LCByb3RhdGlvbiwgZWxsaXBzb2lkLCByZXN1bHQpOwogICAgICB9OwogICAgICB0YW5nZW50Um90YXRpb25NYXRyaXhTY3JhdGNoID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBxdWF0ZXJuaW9uU2NyYXRjaDQgPSBuZXcgUXVhdGVybmlvbl9kZWZhdWx0KCk7CiAgICAgIGNlbnRlclNjcmF0Y2g0ID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIFJlY3RhbmdsZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24ocmVjdGFuZ2xlR2VvbWV0cnkpIHsKICAgICAgICBpZiAoTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICByZWN0YW5nbGVHZW9tZXRyeS5fcmVjdGFuZ2xlLm5vcnRoLAogICAgICAgICAgcmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZS5zb3V0aCwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTAKICAgICAgICApIHx8IE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgcmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZS5lYXN0LAogICAgICAgICAgcmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZS53ZXN0LAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04xMAogICAgICAgICkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGxldCByZWN0YW5nbGUgPSByZWN0YW5nbGVHZW9tZXRyeS5fcmVjdGFuZ2xlOwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgY29uc3Qgcm90YXRpb24gPSByZWN0YW5nbGVHZW9tZXRyeS5fcm90YXRpb247CiAgICAgICAgY29uc3Qgc3RSb3RhdGlvbiA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9zdFJvdGF0aW9uOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll92ZXJ0ZXhGb3JtYXQ7CiAgICAgICAgY29uc3QgY29tcHV0ZWRPcHRpb25zID0gUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZU9wdGlvbnMoCiAgICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgICByZWN0YW5nbGVHZW9tZXRyeS5fZ3JhbnVsYXJpdHksCiAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgIHN0Um90YXRpb24sCiAgICAgICAgICByZWN0YW5nbGVTY3JhdGNoLAogICAgICAgICAgbndTY3JhdGNoLAogICAgICAgICAgc3ROd1NjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IHRhbmdlbnRSb3RhdGlvbk1hdHJpeCA9IHRhbmdlbnRSb3RhdGlvbk1hdHJpeFNjcmF0Y2g7CiAgICAgICAgaWYgKHN0Um90YXRpb24gIT09IDAgfHwgcm90YXRpb24gIT09IDApIHsKICAgICAgICAgIGNvbnN0IGNlbnRlciA9IFJlY3RhbmdsZV9kZWZhdWx0LmNlbnRlcihyZWN0YW5nbGUsIGNlbnRlclNjcmF0Y2g0KTsKICAgICAgICAgIGNvbnN0IGF4aXMgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsQ2FydG9ncmFwaGljKGNlbnRlciwgdjFTY3JhdGNoKTsKICAgICAgICAgIFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKGF4aXMsIC1zdFJvdGF0aW9uLCBxdWF0ZXJuaW9uU2NyYXRjaDQpOwogICAgICAgICAgTWF0cml4M19kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKHF1YXRlcm5pb25TY3JhdGNoNCwgdGFuZ2VudFJvdGF0aW9uTWF0cml4KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgTWF0cml4M19kZWZhdWx0LmNsb25lKE1hdHJpeDNfZGVmYXVsdC5JREVOVElUWSwgdGFuZ2VudFJvdGF0aW9uTWF0cml4KTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc3VyZmFjZUhlaWdodCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9zdXJmYWNlSGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gcmVjdGFuZ2xlR2VvbWV0cnkuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGUgPSAhTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBzdXJmYWNlSGVpZ2h0LAogICAgICAgICAgZXh0cnVkZWRIZWlnaHQsCiAgICAgICAgICAwLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04yCiAgICAgICAgKTsKICAgICAgICBjb21wdXRlZE9wdGlvbnMubG9uU2NhbGFyID0gMSAvIHJlY3RhbmdsZUdlb21ldHJ5Ll9yZWN0YW5nbGUud2lkdGg7CiAgICAgICAgY29tcHV0ZWRPcHRpb25zLmxhdFNjYWxhciA9IDEgLyByZWN0YW5nbGVHZW9tZXRyeS5fcmVjdGFuZ2xlLmhlaWdodDsKICAgICAgICBjb21wdXRlZE9wdGlvbnMudGFuZ2VudFJvdGF0aW9uTWF0cml4ID0gdGFuZ2VudFJvdGF0aW9uTWF0cml4OwogICAgICAgIGxldCBnZW9tZXRyeTsKICAgICAgICBsZXQgYm91bmRpbmdTcGhlcmU7CiAgICAgICAgcmVjdGFuZ2xlID0gcmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZTsKICAgICAgICBpZiAoZXh0cnVkZSkgewogICAgICAgICAgZ2VvbWV0cnkgPSBjb25zdHJ1Y3RFeHRydWRlZFJlY3RhbmdsZShyZWN0YW5nbGVHZW9tZXRyeSwgY29tcHV0ZWRPcHRpb25zKTsKICAgICAgICAgIGNvbnN0IHRvcEJTID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tUmVjdGFuZ2xlM0QoCiAgICAgICAgICAgIHJlY3RhbmdsZSwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBzdXJmYWNlSGVpZ2h0LAogICAgICAgICAgICB0b3BCb3VuZGluZ1NwaGVyZTMKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBib3R0b21CUyA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVJlY3RhbmdsZTNEKAogICAgICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgZXh0cnVkZWRIZWlnaHQsCiAgICAgICAgICAgIGJvdHRvbUJvdW5kaW5nU3BoZXJlMwogICAgICAgICAgKTsKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC51bmlvbih0b3BCUywgYm90dG9tQlMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBnZW9tZXRyeSA9IGNvbnN0cnVjdFJlY3RhbmdsZShyZWN0YW5nbGVHZW9tZXRyeSwgY29tcHV0ZWRPcHRpb25zKTsKICAgICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuc2NhbGVUb0dlb2RldGljSGVpZ2h0KAogICAgICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgICAgICAgc3VyZmFjZUhlaWdodCwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVjdGFuZ2xlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoOwogICAgICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgICBjb25zdCBhcHBseU9mZnNldCA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCAvIDMpLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICAgICAgICB2YWx1ZXM6IGFwcGx5T2Zmc2V0CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgYm91bmRpbmdTcGhlcmUgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21SZWN0YW5nbGUzRCgKICAgICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIHN1cmZhY2VIZWlnaHQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmICghdmVydGV4Rm9ybWF0LnBvc2l0aW9uKSB7CiAgICAgICAgICBkZWxldGUgZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXM6IGdlb21ldHJ5LmF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzOiBnZW9tZXRyeS5pbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSwKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiByZWN0YW5nbGVHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZUdlb21ldHJ5LmNyZWF0ZVNoYWRvd1ZvbHVtZSA9IGZ1bmN0aW9uKHJlY3RhbmdsZUdlb21ldHJ5LCBtaW5IZWlnaHRGdW5jLCBtYXhIZWlnaHRGdW5jKSB7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSByZWN0YW5nbGVHZW9tZXRyeS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gcmVjdGFuZ2xlR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgICAgICBjb25zdCBtaW5IZWlnaHQgPSBtaW5IZWlnaHRGdW5jKGdyYW51bGFyaXR5LCBlbGxpcHNvaWQpOwogICAgICAgIGNvbnN0IG1heEhlaWdodCA9IG1heEhlaWdodEZ1bmMoZ3JhbnVsYXJpdHksIGVsbGlwc29pZCk7CiAgICAgICAgcmV0dXJuIG5ldyBSZWN0YW5nbGVHZW9tZXRyeSh7CiAgICAgICAgICByZWN0YW5nbGU6IHJlY3RhbmdsZUdlb21ldHJ5Ll9yZWN0YW5nbGUsCiAgICAgICAgICByb3RhdGlvbjogcmVjdGFuZ2xlR2VvbWV0cnkuX3JvdGF0aW9uLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgc3RSb3RhdGlvbjogcmVjdGFuZ2xlR2VvbWV0cnkuX3N0Um90YXRpb24sCiAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0OiBtYXhIZWlnaHQsCiAgICAgICAgICBoZWlnaHQ6IG1pbkhlaWdodCwKICAgICAgICAgIHZlcnRleEZvcm1hdDogVmVydGV4Rm9ybWF0X2RlZmF1bHQuUE9TSVRJT05fT05MWSwKICAgICAgICAgIHNoYWRvd1ZvbHVtZTogdHJ1ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICB1bnJvdGF0ZWRUZXh0dXJlUmVjdGFuZ2xlU2NyYXRjaCA9IG5ldyBSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgICBwb2ludHMyRFNjcmF0Y2gyID0gW25ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKSwgbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpLCBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCldOwogICAgICByb3RhdGlvbjJEU2NyYXRjaDIgPSBuZXcgTWF0cml4Ml9kZWZhdWx0KCk7CiAgICAgIHJlY3RhbmdsZUNlbnRlclNjcmF0Y2gyID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFJlY3RhbmdsZUdlb21ldHJ5LnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgcmVjdGFuZ2xlOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0aGlzLl9yb3RhdGVkUmVjdGFuZ2xlKSkgewogICAgICAgICAgICAgIHRoaXMuX3JvdGF0ZWRSZWN0YW5nbGUgPSBjb21wdXRlUmVjdGFuZ2xlMygKICAgICAgICAgICAgICAgIHRoaXMuX3JlY3RhbmdsZSwKICAgICAgICAgICAgICAgIHRoaXMuX2dyYW51bGFyaXR5LAogICAgICAgICAgICAgICAgdGhpcy5fcm90YXRpb24sCiAgICAgICAgICAgICAgICB0aGlzLl9lbGxpcHNvaWQKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9yb3RhdGVkUmVjdGFuZ2xlOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogRm9yIHJlbWFwcGluZyB0ZXh0dXJlIGNvb3JkaW5hdGVzIHdoZW4gcmVuZGVyaW5nIFJlY3RhbmdsZUdlb21ldHJpZXMgYXMgR3JvdW5kUHJpbWl0aXZlcy4KICAgICAgICAgKiBUaGlzIHZlcnNpb24gcGVybWl0cyBza2V3IGluIHRleHR1cmVzIGJ5IGNvbXB1dGluZyBvZmZzZXRzIGRpcmVjdGx5IGluIGNhcnRvZ3JhcGhpYyBzcGFjZSBhbmQKICAgICAgICAgKiBtb3JlIGFjY3VyYXRlbHkgYXBwcm94aW1hdGVzIHJlbmRlcmluZyBSZWN0YW5nbGVHZW9tZXRyaWVzIHdpdGggaGVpZ2h0IGFzIHN0YW5kYXJkIFByaW1pdGl2ZXMuCiAgICAgICAgICogQHNlZSBHZW9tZXRyeSNfdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50cwogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50czogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhpcy5fdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50cykpIHsKICAgICAgICAgICAgICB0aGlzLl90ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzID0gdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50czMoCiAgICAgICAgICAgICAgICB0aGlzCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5fdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50czsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBSZWN0YW5nbGVHZW9tZXRyeV9kZWZhdWx0ID0gUmVjdGFuZ2xlR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVSZWN0YW5nbGVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVSZWN0YW5nbGVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVJlY3RhbmdsZUdlb21ldHJ5KHJlY3RhbmdsZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICByZWN0YW5nbGVHZW9tZXRyeSA9IFJlY3RhbmdsZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKHJlY3RhbmdsZUdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgcmVjdGFuZ2xlR2VvbWV0cnkuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKHJlY3RhbmdsZUdlb21ldHJ5Ll9lbGxpcHNvaWQpOwogICAgcmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZSA9IFJlY3RhbmdsZV9kZWZhdWx0LmNsb25lKHJlY3RhbmdsZUdlb21ldHJ5Ll9yZWN0YW5nbGUpOwogICAgcmV0dXJuIFJlY3RhbmdsZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkocmVjdGFuZ2xlR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVSZWN0YW5nbGVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9SZWN0YW5nbGVHZW9tZXRyeSgpOwogICAgICBjcmVhdGVSZWN0YW5nbGVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBjb25zdHJ1Y3RSZWN0YW5nbGUyKGdlb21ldHJ5LCBjb21wdXRlZE9wdGlvbnMpIHsKICAgIGNvbnN0IGVsbGlwc29pZCA9IGdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICBjb25zdCBoZWlnaHQgPSBjb21wdXRlZE9wdGlvbnMuaGVpZ2h0OwogICAgY29uc3Qgd2lkdGggPSBjb21wdXRlZE9wdGlvbnMud2lkdGg7CiAgICBjb25zdCBub3J0aENhcCA9IGNvbXB1dGVkT3B0aW9ucy5ub3J0aENhcDsKICAgIGNvbnN0IHNvdXRoQ2FwID0gY29tcHV0ZWRPcHRpb25zLnNvdXRoQ2FwOwogICAgbGV0IHJvd0hlaWdodCA9IGhlaWdodDsKICAgIGxldCB3aWR0aE11bHRpcGxpZXIgPSAyOwogICAgbGV0IHNpemUgPSAwOwogICAgbGV0IGNvcm5lcnMgPSA0OwogICAgaWYgKG5vcnRoQ2FwKSB7CiAgICAgIHdpZHRoTXVsdGlwbGllciAtPSAxOwogICAgICByb3dIZWlnaHQgLT0gMTsKICAgICAgc2l6ZSArPSAxOwogICAgICBjb3JuZXJzIC09IDI7CiAgICB9CiAgICBpZiAoc291dGhDYXApIHsKICAgICAgd2lkdGhNdWx0aXBsaWVyIC09IDE7CiAgICAgIHJvd0hlaWdodCAtPSAxOwogICAgICBzaXplICs9IDE7CiAgICAgIGNvcm5lcnMgLT0gMjsKICAgIH0KICAgIHNpemUgKz0gd2lkdGhNdWx0aXBsaWVyICogd2lkdGggKyAyICogcm93SGVpZ2h0IC0gY29ybmVyczsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoc2l6ZSAqIDMpOwogICAgbGV0IHBvc0luZGV4ID0gMDsKICAgIGxldCByb3cgPSAwOwogICAgbGV0IGNvbDsKICAgIGNvbnN0IHBvc2l0aW9uID0gcG9zaXRpb25TY3JhdGNoMzsKICAgIGlmIChub3J0aENhcCkgewogICAgICBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb24oCiAgICAgICAgY29tcHV0ZWRPcHRpb25zLAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICBmYWxzZSwKICAgICAgICByb3csCiAgICAgICAgMCwKICAgICAgICBwb3NpdGlvbgogICAgICApOwogICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi54OwogICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi55OwogICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi56OwogICAgfSBlbHNlIHsKICAgICAgZm9yIChjb2wgPSAwOyBjb2wgPCB3aWR0aDsgY29sKyspIHsKICAgICAgICBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb24oCiAgICAgICAgICBjb21wdXRlZE9wdGlvbnMsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBmYWxzZSwKICAgICAgICAgIHJvdywKICAgICAgICAgIGNvbCwKICAgICAgICAgIHBvc2l0aW9uCiAgICAgICAgKTsKICAgICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi54OwogICAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLnk7CiAgICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24uejsKICAgICAgfQogICAgfQogICAgY29sID0gd2lkdGggLSAxOwogICAgZm9yIChyb3cgPSAxOyByb3cgPCBoZWlnaHQ7IHJvdysrKSB7CiAgICAgIFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbigKICAgICAgICBjb21wdXRlZE9wdGlvbnMsCiAgICAgICAgZWxsaXBzb2lkLAogICAgICAgIGZhbHNlLAogICAgICAgIHJvdywKICAgICAgICBjb2wsCiAgICAgICAgcG9zaXRpb24KICAgICAgKTsKICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24ueDsKICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24ueTsKICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24uejsKICAgIH0KICAgIHJvdyA9IGhlaWdodCAtIDE7CiAgICBpZiAoIXNvdXRoQ2FwKSB7CiAgICAgIGZvciAoY29sID0gd2lkdGggLSAyOyBjb2wgPj0gMDsgY29sLS0pIHsKICAgICAgICBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb24oCiAgICAgICAgICBjb21wdXRlZE9wdGlvbnMsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBmYWxzZSwKICAgICAgICAgIHJvdywKICAgICAgICAgIGNvbCwKICAgICAgICAgIHBvc2l0aW9uCiAgICAgICAgKTsKICAgICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi54OwogICAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLnk7CiAgICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24uejsKICAgICAgfQogICAgfQogICAgY29sID0gMDsKICAgIGZvciAocm93ID0gaGVpZ2h0IC0gMjsgcm93ID4gMDsgcm93LS0pIHsKICAgICAgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9uKAogICAgICAgIGNvbXB1dGVkT3B0aW9ucywKICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgZmFsc2UsCiAgICAgICAgcm93LAogICAgICAgIGNvbCwKICAgICAgICBwb3NpdGlvbgogICAgICApOwogICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi54OwogICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi55OwogICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi56OwogICAgfQogICAgY29uc3QgaW5kaWNlc1NpemUgPSBwb3NpdGlvbnMubGVuZ3RoIC8gMyAqIDI7CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIHBvc2l0aW9ucy5sZW5ndGggLyAzLAogICAgICBpbmRpY2VzU2l6ZQogICAgKTsKICAgIGxldCBpbmRleCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9ucy5sZW5ndGggLyAzIC0gMTsgaSsrKSB7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gaSArIDE7CiAgICB9CiAgICBpbmRpY2VzW2luZGV4KytdID0gcG9zaXRpb25zLmxlbmd0aCAvIDMgLSAxOwogICAgaW5kaWNlc1tpbmRleCsrXSA9IDA7CiAgICBjb25zdCBnZW8gPSBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgIGF0dHJpYnV0ZXM6IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpLAogICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMKICAgIH0pOwogICAgZ2VvLmF0dHJpYnV0ZXMucG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgdmFsdWVzOiBwb3NpdGlvbnMKICAgIH0pOwogICAgZ2VvLmluZGljZXMgPSBpbmRpY2VzOwogICAgcmV0dXJuIGdlbzsKICB9CiAgZnVuY3Rpb24gY29uc3RydWN0RXh0cnVkZWRSZWN0YW5nbGUyKHJlY3RhbmdsZUdlb21ldHJ5LCBjb21wdXRlZE9wdGlvbnMpIHsKICAgIGNvbnN0IG1heEhlaWdodCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9zdXJmYWNlSGVpZ2h0OwogICAgY29uc3QgbWluSGVpZ2h0ID0gcmVjdGFuZ2xlR2VvbWV0cnkuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgY29uc3QgZWxsaXBzb2lkID0gcmVjdGFuZ2xlR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgIGNvbnN0IGdlbyA9IGNvbnN0cnVjdFJlY3RhbmdsZTIocmVjdGFuZ2xlR2VvbWV0cnksIGNvbXB1dGVkT3B0aW9ucyk7CiAgICBjb25zdCBoZWlnaHQgPSBjb21wdXRlZE9wdGlvbnMuaGVpZ2h0OwogICAgY29uc3Qgd2lkdGggPSBjb21wdXRlZE9wdGlvbnMud2lkdGg7CiAgICBjb25zdCB0b3BQb3NpdGlvbnMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgIGdlby5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgbWF4SGVpZ2h0LAogICAgICBlbGxpcHNvaWQsCiAgICAgIGZhbHNlCiAgICApOwogICAgbGV0IGxlbmd0aCA9IHRvcFBvc2l0aW9ucy5sZW5ndGg7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KGxlbmd0aCAqIDIpOwogICAgcG9zaXRpb25zLnNldCh0b3BQb3NpdGlvbnMpOwogICAgY29uc3QgYm90dG9tUG9zaXRpb25zID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuc2NhbGVUb0dlb2RldGljSGVpZ2h0KAogICAgICBnZW8uYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMsCiAgICAgIG1pbkhlaWdodCwKICAgICAgZWxsaXBzb2lkCiAgICApOwogICAgcG9zaXRpb25zLnNldChib3R0b21Qb3NpdGlvbnMsIGxlbmd0aCk7CiAgICBnZW8uYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSBwb3NpdGlvbnM7CiAgICBjb25zdCBub3J0aENhcCA9IGNvbXB1dGVkT3B0aW9ucy5ub3J0aENhcDsKICAgIGNvbnN0IHNvdXRoQ2FwID0gY29tcHV0ZWRPcHRpb25zLnNvdXRoQ2FwOwogICAgbGV0IGNvcm5lcnMgPSA0OwogICAgaWYgKG5vcnRoQ2FwKSB7CiAgICAgIGNvcm5lcnMgLT0gMTsKICAgIH0KICAgIGlmIChzb3V0aENhcCkgewogICAgICBjb3JuZXJzIC09IDE7CiAgICB9CiAgICBjb25zdCBpbmRpY2VzU2l6ZSA9IChwb3NpdGlvbnMubGVuZ3RoIC8gMyArIGNvcm5lcnMpICogMjsKICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgcG9zaXRpb25zLmxlbmd0aCAvIDMsCiAgICAgIGluZGljZXNTaXplCiAgICApOwogICAgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aCAvIDY7CiAgICBsZXQgaW5kZXggPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGggLSAxOyBpKyspIHsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGk7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpICsgMTsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGkgKyBsZW5ndGg7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpICsgbGVuZ3RoICsgMTsKICAgIH0KICAgIGluZGljZXNbaW5kZXgrK10gPSBsZW5ndGggLSAxOwogICAgaW5kaWNlc1tpbmRleCsrXSA9IDA7CiAgICBpbmRpY2VzW2luZGV4KytdID0gbGVuZ3RoICsgbGVuZ3RoIC0gMTsKICAgIGluZGljZXNbaW5kZXgrK10gPSBsZW5ndGg7CiAgICBpbmRpY2VzW2luZGV4KytdID0gMDsKICAgIGluZGljZXNbaW5kZXgrK10gPSBsZW5ndGg7CiAgICBsZXQgYm90dG9tQ29ybmVyOwogICAgaWYgKG5vcnRoQ2FwKSB7CiAgICAgIGJvdHRvbUNvcm5lciA9IGhlaWdodCAtIDE7CiAgICB9IGVsc2UgewogICAgICBjb25zdCB0b3BSaWdodENvcm5lciA9IHdpZHRoIC0gMTsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHRvcFJpZ2h0Q29ybmVyOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gdG9wUmlnaHRDb3JuZXIgKyBsZW5ndGg7CiAgICAgIGJvdHRvbUNvcm5lciA9IHdpZHRoICsgaGVpZ2h0IC0gMjsKICAgIH0KICAgIGluZGljZXNbaW5kZXgrK10gPSBib3R0b21Db3JuZXI7CiAgICBpbmRpY2VzW2luZGV4KytdID0gYm90dG9tQ29ybmVyICsgbGVuZ3RoOwogICAgaWYgKCFzb3V0aENhcCkgewogICAgICBjb25zdCBib3R0b21MZWZ0Q29ybmVyID0gd2lkdGggKyBib3R0b21Db3JuZXIgLSAxOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gYm90dG9tTGVmdENvcm5lcjsKICAgICAgaW5kaWNlc1tpbmRleF0gPSBib3R0b21MZWZ0Q29ybmVyICsgbGVuZ3RoOwogICAgfQogICAgZ2VvLmluZGljZXMgPSBpbmRpY2VzOwogICAgcmV0dXJuIGdlbzsKICB9CiAgZnVuY3Rpb24gUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgcmVjdGFuZ2xlID0gb3B0aW9ucy5yZWN0YW5nbGU7CiAgICBjb25zdCBncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFCiAgICApOwogICAgY29uc3QgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgIGNvbnN0IHJvdGF0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5yb3RhdGlvbiwgMCk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZWN0YW5nbGUpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyZWN0YW5nbGUgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICBSZWN0YW5nbGVfZGVmYXVsdC52YWxpZGF0ZShyZWN0YW5nbGUpOwogICAgaWYgKHJlY3RhbmdsZS5ub3J0aCA8IHJlY3RhbmdsZS5zb3V0aCkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAib3B0aW9ucy5yZWN0YW5nbGUubm9ydGggbXVzdCBiZSBncmVhdGVyIHRoYW4gb3B0aW9ucy5yZWN0YW5nbGUuc291dGgiCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBoZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmhlaWdodCwgMCk7CiAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQsIGhlaWdodCk7CiAgICB0aGlzLl9yZWN0YW5nbGUgPSBSZWN0YW5nbGVfZGVmYXVsdC5jbG9uZShyZWN0YW5nbGUpOwogICAgdGhpcy5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IGVsbGlwc29pZDsKICAgIHRoaXMuX3N1cmZhY2VIZWlnaHQgPSBNYXRoLm1heChoZWlnaHQsIGV4dHJ1ZGVkSGVpZ2h0KTsKICAgIHRoaXMuX3JvdGF0aW9uID0gcm90YXRpb247CiAgICB0aGlzLl9leHRydWRlZEhlaWdodCA9IE1hdGgubWluKGhlaWdodCwgZXh0cnVkZWRIZWlnaHQpOwogICAgdGhpcy5fb2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeSI7CiAgfQogIHZhciBib3R0b21Cb3VuZGluZ1NwaGVyZTQsIHRvcEJvdW5kaW5nU3BoZXJlNCwgcG9zaXRpb25TY3JhdGNoMywgcmVjdGFuZ2xlU2NyYXRjaDIsIHNjcmF0Y2hSZWN0YW5nbGUyLCBzY3JhdGNoRWxsaXBzb2lkMTIsIHNjcmF0Y2hPcHRpb25zMjAsIG53U2NyYXRjaDIsIFJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1JlY3RhbmdsZU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUG9seWdvblBpcGVsaW5lKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X1JlY3RhbmdsZUdlb21ldHJ5TGlicmFyeSgpOwogICAgICBib3R0b21Cb3VuZGluZ1NwaGVyZTQgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgpOwogICAgICB0b3BCb3VuZGluZ1NwaGVyZTQgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgpOwogICAgICBwb3NpdGlvblNjcmF0Y2gzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICByZWN0YW5nbGVTY3JhdGNoMiA9IG5ldyBSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgICBSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkucGFja2VkTGVuZ3RoID0gUmVjdGFuZ2xlX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgNTsKICAgICAgUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2YWx1ZSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgUmVjdGFuZ2xlX2RlZmF1bHQucGFjayh2YWx1ZS5fcmVjdGFuZ2xlLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBSZWN0YW5nbGVfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgRWxsaXBzb2lkX2RlZmF1bHQucGFjayh2YWx1ZS5fZWxsaXBzb2lkLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3N1cmZhY2VIZWlnaHQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9yb3RhdGlvbjsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmFsdWUuX29mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaFJlY3RhbmdsZTIgPSBuZXcgUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEVsbGlwc29pZDEyID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoRWxsaXBzb2lkX2RlZmF1bHQuVU5JVF9TUEhFUkUpOwogICAgICBzY3JhdGNoT3B0aW9uczIwID0gewogICAgICAgIHJlY3RhbmdsZTogc2NyYXRjaFJlY3RhbmdsZTIsCiAgICAgICAgZWxsaXBzb2lkOiBzY3JhdGNoRWxsaXBzb2lkMTIsCiAgICAgICAgZ3JhbnVsYXJpdHk6IHZvaWQgMCwKICAgICAgICBoZWlnaHQ6IHZvaWQgMCwKICAgICAgICByb3RhdGlvbjogdm9pZCAwLAogICAgICAgIGV4dHJ1ZGVkSGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiB2b2lkIDAKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgcmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoUmVjdGFuZ2xlMik7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBSZWN0YW5nbGVfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoRWxsaXBzb2lkMTIpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBoZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHJvdGF0aW9uID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMyMC5ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMyMC5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIwLnJvdGF0aW9uID0gcm90YXRpb247CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIwLmV4dHJ1ZGVkSGVpZ2h0ID0gZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIwLm9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgICByZXR1cm4gbmV3IFJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczIwKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9yZWN0YW5nbGUgPSBSZWN0YW5nbGVfZGVmYXVsdC5jbG9uZShyZWN0YW5nbGUsIHJlc3VsdC5fcmVjdGFuZ2xlKTsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCwgcmVzdWx0Ll9lbGxpcHNvaWQpOwogICAgICAgIHJlc3VsdC5fc3VyZmFjZUhlaWdodCA9IGhlaWdodDsKICAgICAgICByZXN1bHQuX3JvdGF0aW9uID0gcm90YXRpb247CiAgICAgICAgcmVzdWx0Ll9leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIHJlc3VsdC5fb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBud1NjcmF0Y2gyID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIFJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKHJlY3RhbmdsZUdlb21ldHJ5KSB7CiAgICAgICAgY29uc3QgcmVjdGFuZ2xlID0gcmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSByZWN0YW5nbGVHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IGNvbXB1dGVkT3B0aW9ucyA9IFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVPcHRpb25zKAogICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgcmVjdGFuZ2xlR2VvbWV0cnkuX2dyYW51bGFyaXR5LAogICAgICAgICAgcmVjdGFuZ2xlR2VvbWV0cnkuX3JvdGF0aW9uLAogICAgICAgICAgMCwKICAgICAgICAgIHJlY3RhbmdsZVNjcmF0Y2gyLAogICAgICAgICAgbndTY3JhdGNoMgogICAgICAgICk7CiAgICAgICAgbGV0IGdlb21ldHJ5OwogICAgICAgIGxldCBib3VuZGluZ1NwaGVyZTsKICAgICAgICBpZiAoTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICByZWN0YW5nbGUubm9ydGgsCiAgICAgICAgICByZWN0YW5nbGUuc291dGgsCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwCiAgICAgICAgKSB8fCBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHJlY3RhbmdsZS5lYXN0LAogICAgICAgICAgcmVjdGFuZ2xlLndlc3QsCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwCiAgICAgICAgKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc3VyZmFjZUhlaWdodCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9zdXJmYWNlSGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gcmVjdGFuZ2xlR2VvbWV0cnkuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGUgPSAhTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBzdXJmYWNlSGVpZ2h0LAogICAgICAgICAgZXh0cnVkZWRIZWlnaHQsCiAgICAgICAgICAwLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04yCiAgICAgICAgKTsKICAgICAgICBsZXQgb2Zmc2V0VmFsdWU7CiAgICAgICAgaWYgKGV4dHJ1ZGUpIHsKICAgICAgICAgIGdlb21ldHJ5ID0gY29uc3RydWN0RXh0cnVkZWRSZWN0YW5nbGUyKHJlY3RhbmdsZUdlb21ldHJ5LCBjb21wdXRlZE9wdGlvbnMpOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZWN0YW5nbGVHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlKSkgewogICAgICAgICAgICBjb25zdCBzaXplID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoIC8gMzsKICAgICAgICAgICAgbGV0IG9mZnNldEF0dHJpYnV0ZSA9IG5ldyBVaW50OEFycmF5KHNpemUpOwogICAgICAgICAgICBpZiAocmVjdGFuZ2xlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5UT1ApIHsKICAgICAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUuZmlsbCgxLCAwLCBzaXplIC8gMik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgb2Zmc2V0VmFsdWUgPSByZWN0YW5nbGVHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgICAgdmFsdWVzOiBvZmZzZXRBdHRyaWJ1dGUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCB0b3BCUyA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVJlY3RhbmdsZTNEKAogICAgICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgc3VyZmFjZUhlaWdodCwKICAgICAgICAgICAgdG9wQm91bmRpbmdTcGhlcmU0CiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgYm90dG9tQlMgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21SZWN0YW5nbGUzRCgKICAgICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICAgICAgICBib3R0b21Cb3VuZGluZ1NwaGVyZTQKICAgICAgICAgICk7CiAgICAgICAgICBib3VuZGluZ1NwaGVyZSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQudW5pb24odG9wQlMsIGJvdHRvbUJTKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZ2VvbWV0cnkgPSBjb25zdHJ1Y3RSZWN0YW5nbGUyKHJlY3RhbmdsZUdlb21ldHJ5LCBjb21wdXRlZE9wdGlvbnMpOwogICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLAogICAgICAgICAgICBzdXJmYWNlSGVpZ2h0LAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZWN0YW5nbGVHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlKSkgewogICAgICAgICAgICBjb25zdCBsZW5ndGggPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGg7CiAgICAgICAgICAgIG9mZnNldFZhbHVlID0gcmVjdGFuZ2xlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5OT05FID8gMCA6IDE7CiAgICAgICAgICAgIGNvbnN0IGFwcGx5T2Zmc2V0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoIC8gMykuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgICAgICAgIHZhbHVlczogYXBwbHlPZmZzZXQKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBib3VuZGluZ1NwaGVyZSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVJlY3RhbmdsZTNEKAogICAgICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgc3VyZmFjZUhlaWdodAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXM6IGdlb21ldHJ5LmF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzOiBnZW9tZXRyeS5pbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmUsCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHJlY3RhbmdsZUdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkocmVjdGFuZ2xlR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIHJlY3RhbmdsZUdlb21ldHJ5ID0gUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKAogICAgICAgIHJlY3RhbmdsZUdlb21ldHJ5LAogICAgICAgIG9mZnNldAogICAgICApOwogICAgfQogICAgcmVjdGFuZ2xlR2VvbWV0cnkuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKHJlY3RhbmdsZUdlb21ldHJ5Ll9lbGxpcHNvaWQpOwogICAgcmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZSA9IFJlY3RhbmdsZV9kZWZhdWx0LmNsb25lKHJlY3RhbmdsZUdlb21ldHJ5Ll9yZWN0YW5nbGUpOwogICAgcmV0dXJuIFJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KHJlY3RhbmdsZUdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvU2ltcGxlUG9seWxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIGludGVycG9sYXRlQ29sb3JzMihwMCwgcDEsIGNvbG9yMCwgY29sb3IxLCBtaW5EaXN0YW5jZSwgYXJyYXksIG9mZnNldCkgewogICAgY29uc3QgbnVtUG9pbnRzID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0Lm51bWJlck9mUG9pbnRzKHAwLCBwMSwgbWluRGlzdGFuY2UpOwogICAgbGV0IGk7CiAgICBjb25zdCByMCA9IGNvbG9yMC5yZWQ7CiAgICBjb25zdCBnMCA9IGNvbG9yMC5ncmVlbjsKICAgIGNvbnN0IGIwID0gY29sb3IwLmJsdWU7CiAgICBjb25zdCBhMCA9IGNvbG9yMC5hbHBoYTsKICAgIGNvbnN0IHIxID0gY29sb3IxLnJlZDsKICAgIGNvbnN0IGcxID0gY29sb3IxLmdyZWVuOwogICAgY29uc3QgYjEgPSBjb2xvcjEuYmx1ZTsKICAgIGNvbnN0IGExID0gY29sb3IxLmFscGhhOwogICAgaWYgKENvbG9yX2RlZmF1bHQuZXF1YWxzKGNvbG9yMCwgY29sb3IxKSkgewogICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtUG9pbnRzOyBpKyspIHsKICAgICAgICBhcnJheVtvZmZzZXQrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKHIwKTsKICAgICAgICBhcnJheVtvZmZzZXQrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGcwKTsKICAgICAgICBhcnJheVtvZmZzZXQrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGIwKTsKICAgICAgICBhcnJheVtvZmZzZXQrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGEwKTsKICAgICAgfQogICAgICByZXR1cm4gb2Zmc2V0OwogICAgfQogICAgY29uc3QgcmVkUGVyVmVydGV4ID0gKHIxIC0gcjApIC8gbnVtUG9pbnRzOwogICAgY29uc3QgZ3JlZW5QZXJWZXJ0ZXggPSAoZzEgLSBnMCkgLyBudW1Qb2ludHM7CiAgICBjb25zdCBibHVlUGVyVmVydGV4ID0gKGIxIC0gYjApIC8gbnVtUG9pbnRzOwogICAgY29uc3QgYWxwaGFQZXJWZXJ0ZXggPSAoYTEgLSBhMCkgLyBudW1Qb2ludHM7CiAgICBsZXQgaW5kZXggPSBvZmZzZXQ7CiAgICBmb3IgKGkgPSAwOyBpIDwgbnVtUG9pbnRzOyBpKyspIHsKICAgICAgYXJyYXlbaW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKHIwICsgaSAqIHJlZFBlclZlcnRleCk7CiAgICAgIGFycmF5W2luZGV4KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShnMCArIGkgKiBncmVlblBlclZlcnRleCk7CiAgICAgIGFycmF5W2luZGV4KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShiMCArIGkgKiBibHVlUGVyVmVydGV4KTsKICAgICAgYXJyYXlbaW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGEwICsgaSAqIGFscGhhUGVyVmVydGV4KTsKICAgIH0KICAgIHJldHVybiBpbmRleDsKICB9CiAgZnVuY3Rpb24gU2ltcGxlUG9seWxpbmVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG9wdGlvbnMucG9zaXRpb25zOwogICAgY29uc3QgY29sb3JzID0gb3B0aW9ucy5jb2xvcnM7CiAgICBjb25zdCBjb2xvcnNQZXJWZXJ0ZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmNvbG9yc1BlclZlcnRleCwgZmFsc2UpOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSB8fCBwb3NpdGlvbnMubGVuZ3RoIDwgMikgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiQXQgbGVhc3QgdHdvIHBvc2l0aW9ucyBhcmUgcmVxdWlyZWQuIik7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykgJiYgKGNvbG9yc1BlclZlcnRleCAmJiBjb2xvcnMubGVuZ3RoIDwgcG9zaXRpb25zLmxlbmd0aCB8fCAhY29sb3JzUGVyVmVydGV4ICYmIGNvbG9ycy5sZW5ndGggPCBwb3NpdGlvbnMubGVuZ3RoIC0gMSkpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImNvbG9ycyBoYXMgYW4gaW52YWxpZCBsZW5ndGguIik7CiAgICB9CiAgICB0aGlzLl9wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICB0aGlzLl9jb2xvcnMgPSBjb2xvcnM7CiAgICB0aGlzLl9jb2xvcnNQZXJWZXJ0ZXggPSBjb2xvcnNQZXJWZXJ0ZXg7CiAgICB0aGlzLl9hcmNUeXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5hcmNUeXBlLCBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpOwogICAgdGhpcy5fZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRQogICAgKTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZVNpbXBsZVBvbHlsaW5lR2VvbWV0cnkiOwogICAgbGV0IG51bUNvbXBvbmVudHMgPSAxICsgcG9zaXRpb25zLmxlbmd0aCAqIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICBudW1Db21wb25lbnRzICs9IGRlZmluZWRfZGVmYXVsdChjb2xvcnMpID8gMSArIGNvbG9ycy5sZW5ndGggKiBDb2xvcl9kZWZhdWx0LnBhY2tlZExlbmd0aCA6IDE7CiAgICB0aGlzLnBhY2tlZExlbmd0aCA9IG51bUNvbXBvbmVudHMgKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAzOwogIH0KICB2YXIgc2NyYXRjaEFycmF5MSwgc2NyYXRjaEFycmF5MiwgZ2VuZXJhdGVBcmNPcHRpb25zU2NyYXRjaCwgU2ltcGxlUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1NpbXBsZVBvbHlsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1NpbXBsZVBvbHlsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0FyY1R5cGUoKTsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9Db2xvcigpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUG9seWxpbmVQaXBlbGluZSgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgU2ltcGxlUG9seWxpbmVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWUgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGxldCBpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHZhbHVlLl9wb3NpdGlvbnM7CiAgICAgICAgbGV0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGxlbmd0aDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2socG9zaXRpb25zW2ldLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNvbG9ycyA9IHZhbHVlLl9jb2xvcnM7CiAgICAgICAgbGVuZ3RoID0gZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykgPyBjb2xvcnMubGVuZ3RoIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDb2xvcl9kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgQ29sb3JfZGVmYXVsdC5wYWNrKGNvbG9yc1tpXSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2NvbG9yc1BlclZlcnRleCA/IDEgOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fYXJjVHlwZTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIFNpbXBsZVBvbHlsaW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBsZXQgaTsKICAgICAgICBsZXQgbGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgcG9zaXRpb25zW2ldID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgY29sb3JzID0gbGVuZ3RoID4gMCA/IG5ldyBBcnJheShsZW5ndGgpIDogdm9pZCAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDb2xvcl9kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgY29sb3JzW2ldID0gQ29sb3JfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGNvbG9yc1BlclZlcnRleCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPT09IDE7CiAgICAgICAgY29uc3QgYXJjVHlwZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFNpbXBsZVBvbHlsaW5lR2VvbWV0cnkoewogICAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAgIGNvbG9ycywKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBjb2xvcnNQZXJWZXJ0ZXgsCiAgICAgICAgICAgIGFyY1R5cGUsCiAgICAgICAgICAgIGdyYW51bGFyaXR5CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgcmVzdWx0Ll9jb2xvcnMgPSBjb2xvcnM7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWQgPSBlbGxpcHNvaWQ7CiAgICAgICAgcmVzdWx0Ll9jb2xvcnNQZXJWZXJ0ZXggPSBjb2xvcnNQZXJWZXJ0ZXg7CiAgICAgICAgcmVzdWx0Ll9hcmNUeXBlID0gYXJjVHlwZTsKICAgICAgICByZXN1bHQuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaEFycmF5MSA9IG5ldyBBcnJheSgyKTsKICAgICAgc2NyYXRjaEFycmF5MiA9IG5ldyBBcnJheSgyKTsKICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zU2NyYXRjaCA9IHsKICAgICAgICBwb3NpdGlvbnM6IHNjcmF0Y2hBcnJheTEsCiAgICAgICAgaGVpZ2h0OiBzY3JhdGNoQXJyYXkyLAogICAgICAgIGVsbGlwc29pZDogdm9pZCAwLAogICAgICAgIG1pbkRpc3RhbmNlOiB2b2lkIDAsCiAgICAgICAgZ3JhbnVsYXJpdHk6IHZvaWQgMAogICAgICB9OwogICAgICBTaW1wbGVQb2x5bGluZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oc2ltcGxlUG9seWxpbmVHZW9tZXRyeSkgewogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHNpbXBsZVBvbHlsaW5lR2VvbWV0cnkuX3Bvc2l0aW9uczsKICAgICAgICBjb25zdCBjb2xvcnMgPSBzaW1wbGVQb2x5bGluZUdlb21ldHJ5Ll9jb2xvcnM7CiAgICAgICAgY29uc3QgY29sb3JzUGVyVmVydGV4ID0gc2ltcGxlUG9seWxpbmVHZW9tZXRyeS5fY29sb3JzUGVyVmVydGV4OwogICAgICAgIGNvbnN0IGFyY1R5cGUgPSBzaW1wbGVQb2x5bGluZUdlb21ldHJ5Ll9hcmNUeXBlOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gc2ltcGxlUG9seWxpbmVHZW9tZXRyeS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gc2ltcGxlUG9seWxpbmVHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IG1pbkRpc3RhbmNlID0gTWF0aF9kZWZhdWx0LmNob3JkTGVuZ3RoKAogICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICBlbGxpcHNvaWQubWF4aW11bVJhZGl1cwogICAgICAgICk7CiAgICAgICAgY29uc3QgcGVyU2VnbWVudENvbG9ycyA9IGRlZmluZWRfZGVmYXVsdChjb2xvcnMpICYmICFjb2xvcnNQZXJWZXJ0ZXg7CiAgICAgICAgbGV0IGk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBsZXQgcG9zaXRpb25WYWx1ZXM7CiAgICAgICAgbGV0IG51bWJlck9mUG9zaXRpb25zOwogICAgICAgIGxldCBjb2xvclZhbHVlczsKICAgICAgICBsZXQgY29sb3I7CiAgICAgICAgbGV0IG9mZnNldCA9IDA7CiAgICAgICAgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQyB8fCBhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgICAgIGxldCBzdWJkaXZpc2lvblNpemU7CiAgICAgICAgICBsZXQgbnVtYmVyT2ZQb2ludHNGdW5jdGlvbjsKICAgICAgICAgIGxldCBnZW5lcmF0ZUFyY0Z1bmN0aW9uOwogICAgICAgICAgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQykgewogICAgICAgICAgICBzdWJkaXZpc2lvblNpemUgPSBNYXRoX2RlZmF1bHQuY2hvcmRMZW5ndGgoCiAgICAgICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICAgICAgZWxsaXBzb2lkLm1heGltdW1SYWRpdXMKICAgICAgICAgICAgKTsKICAgICAgICAgICAgbnVtYmVyT2ZQb2ludHNGdW5jdGlvbiA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5udW1iZXJPZlBvaW50czsKICAgICAgICAgICAgZ2VuZXJhdGVBcmNGdW5jdGlvbiA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5nZW5lcmF0ZUFyYzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN1YmRpdmlzaW9uU2l6ZSA9IGdyYW51bGFyaXR5OwogICAgICAgICAgICBudW1iZXJPZlBvaW50c0Z1bmN0aW9uID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0Lm51bWJlck9mUG9pbnRzUmh1bWJMaW5lOwogICAgICAgICAgICBnZW5lcmF0ZUFyY0Z1bmN0aW9uID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmdlbmVyYXRlUmh1bWJBcmM7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBoZWlnaHRzID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmV4dHJhY3RIZWlnaHRzKHBvc2l0aW9ucywgZWxsaXBzb2lkKTsKICAgICAgICAgIGNvbnN0IGdlbmVyYXRlQXJjT3B0aW9ucyA9IGdlbmVyYXRlQXJjT3B0aW9uc1NjcmF0Y2g7CiAgICAgICAgICBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDKSB7CiAgICAgICAgICAgIGdlbmVyYXRlQXJjT3B0aW9ucy5taW5EaXN0YW5jZSA9IG1pbkRpc3RhbmNlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zLmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICB9CiAgICAgICAgICBnZW5lcmF0ZUFyY09wdGlvbnMuZWxsaXBzb2lkID0gZWxsaXBzb2lkOwogICAgICAgICAgaWYgKHBlclNlZ21lbnRDb2xvcnMpIHsKICAgICAgICAgICAgbGV0IHBvc2l0aW9uQ291bnQgPSAwOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgICAgICAgcG9zaXRpb25Db3VudCArPSBudW1iZXJPZlBvaW50c0Z1bmN0aW9uKAogICAgICAgICAgICAgICAgcG9zaXRpb25zW2ldLAogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kgKyAxXSwKICAgICAgICAgICAgICAgIHN1YmRpdmlzaW9uU2l6ZQogICAgICAgICAgICAgICkgKyAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBvc2l0aW9uVmFsdWVzID0gbmV3IEZsb2F0NjRBcnJheShwb3NpdGlvbkNvdW50ICogMyk7CiAgICAgICAgICAgIGNvbG9yVmFsdWVzID0gbmV3IFVpbnQ4QXJyYXkocG9zaXRpb25Db3VudCAqIDQpOwogICAgICAgICAgICBnZW5lcmF0ZUFyY09wdGlvbnMucG9zaXRpb25zID0gc2NyYXRjaEFycmF5MTsKICAgICAgICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zLmhlaWdodCA9IHNjcmF0Y2hBcnJheTI7CiAgICAgICAgICAgIGxldCBjaSA9IDA7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGggLSAxOyArK2kpIHsKICAgICAgICAgICAgICBzY3JhdGNoQXJyYXkxWzBdID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgICAgIHNjcmF0Y2hBcnJheTFbMV0gPSBwb3NpdGlvbnNbaSArIDFdOwogICAgICAgICAgICAgIHNjcmF0Y2hBcnJheTJbMF0gPSBoZWlnaHRzW2ldOwogICAgICAgICAgICAgIHNjcmF0Y2hBcnJheTJbMV0gPSBoZWlnaHRzW2kgKyAxXTsKICAgICAgICAgICAgICBjb25zdCBwb3MgPSBnZW5lcmF0ZUFyY0Z1bmN0aW9uKGdlbmVyYXRlQXJjT3B0aW9ucyk7CiAgICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChjb2xvcnMpKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzZWdMZW4gPSBwb3MubGVuZ3RoIC8gMzsKICAgICAgICAgICAgICAgIGNvbG9yID0gY29sb3JzW2ldOwogICAgICAgICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBzZWdMZW47ICsraykgewogICAgICAgICAgICAgICAgICBjb2xvclZhbHVlc1tjaSsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IucmVkKTsKICAgICAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY2krK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLmdyZWVuKTsKICAgICAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY2krK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLmJsdWUpOwogICAgICAgICAgICAgICAgICBjb2xvclZhbHVlc1tjaSsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IuYWxwaGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwb3NpdGlvblZhbHVlcy5zZXQocG9zLCBvZmZzZXQpOwogICAgICAgICAgICAgIG9mZnNldCArPSBwb3MubGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBnZW5lcmF0ZUFyY09wdGlvbnMucG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgICAgICAgICBnZW5lcmF0ZUFyY09wdGlvbnMuaGVpZ2h0ID0gaGVpZ2h0czsKICAgICAgICAgICAgcG9zaXRpb25WYWx1ZXMgPSBuZXcgRmxvYXQ2NEFycmF5KAogICAgICAgICAgICAgIGdlbmVyYXRlQXJjRnVuY3Rpb24oZ2VuZXJhdGVBcmNPcHRpb25zKQogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykpIHsKICAgICAgICAgICAgICBjb2xvclZhbHVlcyA9IG5ldyBVaW50OEFycmF5KHBvc2l0aW9uVmFsdWVzLmxlbmd0aCAvIDMgKiA0KTsKICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoIC0gMTsgKytpKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwMCA9IHBvc2l0aW9uc1tpXTsKICAgICAgICAgICAgICAgIGNvbnN0IHAxID0gcG9zaXRpb25zW2kgKyAxXTsKICAgICAgICAgICAgICAgIGNvbnN0IGMwID0gY29sb3JzW2ldOwogICAgICAgICAgICAgICAgY29uc3QgYzEgPSBjb2xvcnNbaSArIDFdOwogICAgICAgICAgICAgICAgb2Zmc2V0ID0gaW50ZXJwb2xhdGVDb2xvcnMyKAogICAgICAgICAgICAgICAgICBwMCwKICAgICAgICAgICAgICAgICAgcDEsCiAgICAgICAgICAgICAgICAgIGMwLAogICAgICAgICAgICAgICAgICBjMSwKICAgICAgICAgICAgICAgICAgbWluRGlzdGFuY2UsCiAgICAgICAgICAgICAgICAgIGNvbG9yVmFsdWVzLAogICAgICAgICAgICAgICAgICBvZmZzZXQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnN0IGxhc3RDb2xvciA9IGNvbG9yc1tsZW5ndGggLSAxXTsKICAgICAgICAgICAgICBjb2xvclZhbHVlc1tvZmZzZXQrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGxhc3RDb2xvci5yZWQpOwogICAgICAgICAgICAgIGNvbG9yVmFsdWVzW29mZnNldCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUobGFzdENvbG9yLmdyZWVuKTsKICAgICAgICAgICAgICBjb2xvclZhbHVlc1tvZmZzZXQrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGxhc3RDb2xvci5ibHVlKTsKICAgICAgICAgICAgICBjb2xvclZhbHVlc1tvZmZzZXQrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGxhc3RDb2xvci5hbHBoYSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgbnVtYmVyT2ZQb3NpdGlvbnMgPSBwZXJTZWdtZW50Q29sb3JzID8gbGVuZ3RoICogMiAtIDIgOiBsZW5ndGg7CiAgICAgICAgICBwb3NpdGlvblZhbHVlcyA9IG5ldyBGbG9hdDY0QXJyYXkobnVtYmVyT2ZQb3NpdGlvbnMgKiAzKTsKICAgICAgICAgIGNvbG9yVmFsdWVzID0gZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykgPyBuZXcgVWludDhBcnJheShudW1iZXJPZlBvc2l0aW9ucyAqIDQpIDogdm9pZCAwOwogICAgICAgICAgbGV0IHBvc2l0aW9uSW5kZXggPSAwOwogICAgICAgICAgbGV0IGNvbG9ySW5kZXggPSAwOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGNvbnN0IHAgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICAgIGlmIChwZXJTZWdtZW50Q29sb3JzICYmIGkgPiAwKSB7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2socCwgcG9zaXRpb25WYWx1ZXMsIHBvc2l0aW9uSW5kZXgpOwogICAgICAgICAgICAgIHBvc2l0aW9uSW5kZXggKz0gMzsKICAgICAgICAgICAgICBjb2xvciA9IGNvbG9yc1tpIC0gMV07CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY29sb3JJbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IucmVkKTsKICAgICAgICAgICAgICBjb2xvclZhbHVlc1tjb2xvckluZGV4KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShjb2xvci5ncmVlbik7CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY29sb3JJbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IuYmx1ZSk7CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY29sb3JJbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IuYWxwaGEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwZXJTZWdtZW50Q29sb3JzICYmIGkgPT09IGxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhwLCBwb3NpdGlvblZhbHVlcywgcG9zaXRpb25JbmRleCk7CiAgICAgICAgICAgIHBvc2l0aW9uSW5kZXggKz0gMzsKICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChjb2xvcnMpKSB7CiAgICAgICAgICAgICAgY29sb3IgPSBjb2xvcnNbaV07CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY29sb3JJbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IucmVkKTsKICAgICAgICAgICAgICBjb2xvclZhbHVlc1tjb2xvckluZGV4KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShjb2xvci5ncmVlbik7CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY29sb3JJbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IuYmx1ZSk7CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY29sb3JJbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IuYWxwaGEpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoKTsKICAgICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgIHZhbHVlczogcG9zaXRpb25WYWx1ZXMKICAgICAgICB9KTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykpIHsKICAgICAgICAgIGF0dHJpYnV0ZXMuY29sb3IgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDQsCiAgICAgICAgICAgIHZhbHVlczogY29sb3JWYWx1ZXMsCiAgICAgICAgICAgIG5vcm1hbGl6ZTogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIG51bWJlck9mUG9zaXRpb25zID0gcG9zaXRpb25WYWx1ZXMubGVuZ3RoIC8gMzsKICAgICAgICBjb25zdCBudW1iZXJPZkluZGljZXMgPSAobnVtYmVyT2ZQb3NpdGlvbnMgLSAxKSAqIDI7CiAgICAgICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICAgICAgbnVtYmVyT2ZQb3NpdGlvbnMsCiAgICAgICAgICBudW1iZXJPZkluZGljZXMKICAgICAgICApOwogICAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IG51bWJlck9mUG9zaXRpb25zIC0gMTsgKytpKSB7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaTsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpICsgMTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVBvaW50cyhwb3NpdGlvbnMpCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFNpbXBsZVBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IFNpbXBsZVBvbHlsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVTaW1wbGVQb2x5bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZVNpbXBsZVBvbHlsaW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZVNpbXBsZVBvbHlsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeShzaW1wbGVQb2x5bGluZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBzaW1wbGVQb2x5bGluZUdlb21ldHJ5ID0gU2ltcGxlUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjaygKICAgICAgICBzaW1wbGVQb2x5bGluZUdlb21ldHJ5LAogICAgICAgIG9mZnNldAogICAgICApOwogICAgfQogICAgc2ltcGxlUG9seWxpbmVHZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoCiAgICAgIHNpbXBsZVBvbHlsaW5lR2VvbWV0cnkuX2VsbGlwc29pZAogICAgKTsKICAgIHJldHVybiBTaW1wbGVQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoc2ltcGxlUG9seWxpbmVHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVTaW1wbGVQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X1NpbXBsZVBvbHlsaW5lR2VvbWV0cnkoKTsKICAgICAgY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1NwaGVyZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gU3BoZXJlR2VvbWV0cnkob3B0aW9ucykgewogICAgY29uc3QgcmFkaXVzID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5yYWRpdXMsIDEpOwogICAgY29uc3QgcmFkaWkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KHJhZGl1cywgcmFkaXVzLCByYWRpdXMpOwogICAgY29uc3QgZWxsaXBzb2lkT3B0aW9ucyA9IHsKICAgICAgcmFkaWksCiAgICAgIHN0YWNrUGFydGl0aW9uczogb3B0aW9ucy5zdGFja1BhcnRpdGlvbnMsCiAgICAgIHNsaWNlUGFydGl0aW9uczogb3B0aW9ucy5zbGljZVBhcnRpdGlvbnMsCiAgICAgIHZlcnRleEZvcm1hdDogb3B0aW9ucy52ZXJ0ZXhGb3JtYXQKICAgIH07CiAgICB0aGlzLl9lbGxpcHNvaWRHZW9tZXRyeSA9IG5ldyBFbGxpcHNvaWRHZW9tZXRyeV9kZWZhdWx0KGVsbGlwc29pZE9wdGlvbnMpOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVTcGhlcmVHZW9tZXRyeSI7CiAgfQogIHZhciBzY3JhdGNoRWxsaXBzb2lkR2VvbWV0cnksIHNjcmF0Y2hPcHRpb25zMjEsIFNwaGVyZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfU3BoZXJlR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1NwaGVyZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkR2VvbWV0cnkoKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgU3BoZXJlR2VvbWV0cnkucGFja2VkTGVuZ3RoID0gRWxsaXBzb2lkR2VvbWV0cnlfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgIFNwaGVyZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIHJldHVybiBFbGxpcHNvaWRHZW9tZXRyeV9kZWZhdWx0LnBhY2sodmFsdWUuX2VsbGlwc29pZEdlb21ldHJ5LCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWRHZW9tZXRyeSA9IG5ldyBFbGxpcHNvaWRHZW9tZXRyeV9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hPcHRpb25zMjEgPSB7CiAgICAgICAgcmFkaXVzOiB2b2lkIDAsCiAgICAgICAgcmFkaWk6IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCgpLAogICAgICAgIHN0YWNrUGFydGl0aW9uczogdm9pZCAwLAogICAgICAgIHNsaWNlUGFydGl0aW9uczogdm9pZCAwCiAgICAgIH07CiAgICAgIFNwaGVyZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBjb25zdCBlbGxpcHNvaWRHZW9tZXRyeSA9IEVsbGlwc29pZEdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgc2NyYXRjaEVsbGlwc29pZEdlb21ldHJ5CiAgICAgICAgKTsKICAgICAgICBzY3JhdGNoT3B0aW9uczIxLnZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKAogICAgICAgICAgZWxsaXBzb2lkR2VvbWV0cnkuX3ZlcnRleEZvcm1hdCwKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMjEudmVydGV4Rm9ybWF0CiAgICAgICAgKTsKICAgICAgICBzY3JhdGNoT3B0aW9uczIxLnN0YWNrUGFydGl0aW9ucyA9IGVsbGlwc29pZEdlb21ldHJ5Ll9zdGFja1BhcnRpdGlvbnM7CiAgICAgICAgc2NyYXRjaE9wdGlvbnMyMS5zbGljZVBhcnRpdGlvbnMgPSBlbGxpcHNvaWRHZW9tZXRyeS5fc2xpY2VQYXJ0aXRpb25zOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMjEucmFkaXVzID0gZWxsaXBzb2lkR2VvbWV0cnkuX3JhZGlpLng7CiAgICAgICAgICByZXR1cm4gbmV3IFNwaGVyZUdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zMjEpOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkR2VvbWV0cnkuX3JhZGlpLCBzY3JhdGNoT3B0aW9uczIxLnJhZGlpKTsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZEdlb21ldHJ5ID0gbmV3IEVsbGlwc29pZEdlb21ldHJ5X2RlZmF1bHQoc2NyYXRjaE9wdGlvbnMyMSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgU3BoZXJlR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihzcGhlcmVHZW9tZXRyeSkgewogICAgICAgIHJldHVybiBFbGxpcHNvaWRHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KHNwaGVyZUdlb21ldHJ5Ll9lbGxpcHNvaWRHZW9tZXRyeSk7CiAgICAgIH07CiAgICAgIFNwaGVyZUdlb21ldHJ5X2RlZmF1bHQgPSBTcGhlcmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVNwaGVyZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZVNwaGVyZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVTcGhlcmVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVTcGhlcmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlU3BoZXJlR2VvbWV0cnkoc3BoZXJlR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIHNwaGVyZUdlb21ldHJ5ID0gU3BoZXJlR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soc3BoZXJlR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICByZXR1cm4gU3BoZXJlR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShzcGhlcmVHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVTcGhlcmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVNwaGVyZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVTcGhlcmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X1NwaGVyZUdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZVNwaGVyZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVTcGhlcmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1NwaGVyZU91dGxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIFNwaGVyZU91dGxpbmVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBjb25zdCByYWRpdXMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnJhZGl1cywgMSk7CiAgICBjb25zdCByYWRpaSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQocmFkaXVzLCByYWRpdXMsIHJhZGl1cyk7CiAgICBjb25zdCBlbGxpcHNvaWRPcHRpb25zID0gewogICAgICByYWRpaSwKICAgICAgc3RhY2tQYXJ0aXRpb25zOiBvcHRpb25zLnN0YWNrUGFydGl0aW9ucywKICAgICAgc2xpY2VQYXJ0aXRpb25zOiBvcHRpb25zLnNsaWNlUGFydGl0aW9ucywKICAgICAgc3ViZGl2aXNpb25zOiBvcHRpb25zLnN1YmRpdmlzaW9ucwogICAgfTsKICAgIHRoaXMuX2VsbGlwc29pZEdlb21ldHJ5ID0gbmV3IEVsbGlwc29pZE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0KGVsbGlwc29pZE9wdGlvbnMpOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnkiOwogIH0KICB2YXIgc2NyYXRjaEVsbGlwc29pZEdlb21ldHJ5Miwgc2NyYXRjaE9wdGlvbnMyMiwgU3BoZXJlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfU3BoZXJlT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9TcGhlcmVPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkoKTsKICAgICAgU3BoZXJlT3V0bGluZUdlb21ldHJ5LnBhY2tlZExlbmd0aCA9IEVsbGlwc29pZE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgU3BoZXJlT3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIHJldHVybiBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5wYWNrKAogICAgICAgICAgdmFsdWUuX2VsbGlwc29pZEdlb21ldHJ5LAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgc2NyYXRjaEVsbGlwc29pZEdlb21ldHJ5MiA9IG5ldyBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoT3B0aW9uczIyID0gewogICAgICAgIHJhZGl1czogdm9pZCAwLAogICAgICAgIHJhZGlpOiBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgc3RhY2tQYXJ0aXRpb25zOiB2b2lkIDAsCiAgICAgICAgc2xpY2VQYXJ0aXRpb25zOiB2b2lkIDAsCiAgICAgICAgc3ViZGl2aXNpb25zOiB2b2lkIDAKICAgICAgfTsKICAgICAgU3BoZXJlT3V0bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBjb25zdCBlbGxpcHNvaWRHZW9tZXRyeSA9IEVsbGlwc29pZE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hFbGxpcHNvaWRHZW9tZXRyeTIKICAgICAgICApOwogICAgICAgIHNjcmF0Y2hPcHRpb25zMjIuc3RhY2tQYXJ0aXRpb25zID0gZWxsaXBzb2lkR2VvbWV0cnkuX3N0YWNrUGFydGl0aW9uczsKICAgICAgICBzY3JhdGNoT3B0aW9uczIyLnNsaWNlUGFydGl0aW9ucyA9IGVsbGlwc29pZEdlb21ldHJ5Ll9zbGljZVBhcnRpdGlvbnM7CiAgICAgICAgc2NyYXRjaE9wdGlvbnMyMi5zdWJkaXZpc2lvbnMgPSBlbGxpcHNvaWRHZW9tZXRyeS5fc3ViZGl2aXNpb25zOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMjIucmFkaXVzID0gZWxsaXBzb2lkR2VvbWV0cnkuX3JhZGlpLng7CiAgICAgICAgICByZXR1cm4gbmV3IFNwaGVyZU91dGxpbmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczIyKTsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGVsbGlwc29pZEdlb21ldHJ5Ll9yYWRpaSwgc2NyYXRjaE9wdGlvbnMyMi5yYWRpaSk7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWRHZW9tZXRyeSA9IG5ldyBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdChzY3JhdGNoT3B0aW9uczIyKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBTcGhlcmVPdXRsaW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihzcGhlcmVHZW9tZXRyeSkgewogICAgICAgIHJldHVybiBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeSgKICAgICAgICAgIHNwaGVyZUdlb21ldHJ5Ll9lbGxpcHNvaWRHZW9tZXRyeQogICAgICAgICk7CiAgICAgIH07CiAgICAgIFNwaGVyZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gU3BoZXJlT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlU3BoZXJlT3V0bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZVNwaGVyZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlU3BoZXJlT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVNwaGVyZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlU3BoZXJlT3V0bGluZUdlb21ldHJ5KHNwaGVyZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBzcGhlcmVHZW9tZXRyeSA9IFNwaGVyZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhzcGhlcmVHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHJldHVybiBTcGhlcmVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShzcGhlcmVHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVNwaGVyZU91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X1NwaGVyZU91dGxpbmVHZW9tZXRyeSgpOwogICAgICBjcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVNwaGVyZU91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVZlY3RvclRpbGVDbGFtcGVkUG9seWxpbmVzLmpzCiAgdmFyIGNyZWF0ZVZlY3RvclRpbGVDbGFtcGVkUG9seWxpbmVzX2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVWZWN0b3JUaWxlQ2xhbXBlZFBvbHlsaW5lc19leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVWZWN0b3JUaWxlQ2xhbXBlZFBvbHlsaW5lc19kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gZGVjb2RlUG9zaXRpb25zKHVCdWZmZXIsIHZCdWZmZXIsIGhlaWdodEJ1ZmZlciwgcmVjdGFuZ2xlLCBtaW5pbXVtSGVpZ2h0LCBtYXhpbXVtSGVpZ2h0LCBlbGxpcHNvaWQpIHsKICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IHVCdWZmZXIubGVuZ3RoOwogICAgY29uc3QgZGVjb2RlZFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkocG9zaXRpb25zTGVuZ3RoICogMyk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9uc0xlbmd0aDsgKytpKSB7CiAgICAgIGNvbnN0IHUzID0gdUJ1ZmZlcltpXTsKICAgICAgY29uc3QgdjMgPSB2QnVmZmVyW2ldOwogICAgICBjb25zdCBoID0gaGVpZ2h0QnVmZmVyW2ldOwogICAgICBjb25zdCBsb24gPSBNYXRoX2RlZmF1bHQubGVycChyZWN0YW5nbGUud2VzdCwgcmVjdGFuZ2xlLmVhc3QsIHUzIC8gTUFYX1NIT1JUKTsKICAgICAgY29uc3QgbGF0ID0gTWF0aF9kZWZhdWx0LmxlcnAoCiAgICAgICAgcmVjdGFuZ2xlLnNvdXRoLAogICAgICAgIHJlY3RhbmdsZS5ub3J0aCwKICAgICAgICB2MyAvIE1BWF9TSE9SVAogICAgICApOwogICAgICBjb25zdCBhbHQgPSBNYXRoX2RlZmF1bHQubGVycChtaW5pbXVtSGVpZ2h0LCBtYXhpbXVtSGVpZ2h0LCBoIC8gTUFYX1NIT1JUKTsKICAgICAgY29uc3QgY2FydG9ncmFwaGljMiA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICAgIGxvbiwKICAgICAgICBsYXQsCiAgICAgICAgYWx0LAogICAgICAgIHNjcmF0Y2hCVkNhcnRvZ3JhcGhpYwogICAgICApOwogICAgICBjb25zdCBkZWNvZGVkUG9zaXRpb24gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgY2FydG9ncmFwaGljMiwKICAgICAgICBzY3JhdGNoRW5jb2RlZFBvc2l0aW9uCiAgICAgICk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGRlY29kZWRQb3NpdGlvbiwgZGVjb2RlZFBvc2l0aW9ucywgaSAqIDMpOwogICAgfQogICAgcmV0dXJuIGRlY29kZWRQb3NpdGlvbnM7CiAgfQogIGZ1bmN0aW9uIGdldFBvc2l0aW9uT2Zmc2V0cyhjb3VudHMpIHsKICAgIGNvbnN0IGNvdW50c0xlbmd0aCA9IGNvdW50cy5sZW5ndGg7CiAgICBjb25zdCBwb3NpdGlvbk9mZnNldHMgPSBuZXcgVWludDMyQXJyYXkoY291bnRzTGVuZ3RoICsgMSk7CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnRzTGVuZ3RoOyArK2kpIHsKICAgICAgcG9zaXRpb25PZmZzZXRzW2ldID0gb2Zmc2V0OwogICAgICBvZmZzZXQgKz0gY291bnRzW2ldOwogICAgfQogICAgcG9zaXRpb25PZmZzZXRzW2NvdW50c0xlbmd0aF0gPSBvZmZzZXQ7CiAgICByZXR1cm4gcG9zaXRpb25PZmZzZXRzOwogIH0KICBmdW5jdGlvbiByZW1vdmVEdXBsaWNhdGVzKHVCdWZmZXIsIHZCdWZmZXIsIGhlaWdodEJ1ZmZlciwgY291bnRzKSB7CiAgICBjb25zdCBjb3VudHNMZW5ndGggPSBjb3VudHMubGVuZ3RoOwogICAgY29uc3QgcG9zaXRpb25zTGVuZ3RoID0gdUJ1ZmZlci5sZW5ndGg7CiAgICBjb25zdCBtYXJrUmVtb3ZhbCA9IG5ldyBVaW50OEFycmF5KHBvc2l0aW9uc0xlbmd0aCk7CiAgICBjb25zdCBwcmV2aW91cyA9IHByZXZpb3VzQ29tcHJlc3NlZENhcnRvZ3JhcGhpY1NjcmF0Y2g7CiAgICBjb25zdCBjdXJyZW50ID0gY3VycmVudENvbXByZXNzZWRDYXJ0b2dyYXBoaWNTY3JhdGNoOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50c0xlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGNvdW50ID0gY291bnRzW2ldOwogICAgICBsZXQgdXBkYXRlZENvdW50ID0gY291bnQ7CiAgICAgIGZvciAobGV0IGogPSAxOyBqIDwgY291bnQ7IGorKykgewogICAgICAgIGNvbnN0IGluZGV4ID0gb2Zmc2V0ICsgajsKICAgICAgICBjb25zdCBwcmV2aW91c0luZGV4ID0gaW5kZXggLSAxOwogICAgICAgIGN1cnJlbnQubG9uZ2l0dWRlID0gdUJ1ZmZlcltpbmRleF07CiAgICAgICAgY3VycmVudC5sYXRpdHVkZSA9IHZCdWZmZXJbaW5kZXhdOwogICAgICAgIHByZXZpb3VzLmxvbmdpdHVkZSA9IHVCdWZmZXJbcHJldmlvdXNJbmRleF07CiAgICAgICAgcHJldmlvdXMubGF0aXR1ZGUgPSB2QnVmZmVyW3ByZXZpb3VzSW5kZXhdOwogICAgICAgIGlmIChDYXJ0b2dyYXBoaWNfZGVmYXVsdC5lcXVhbHMoY3VycmVudCwgcHJldmlvdXMpKSB7CiAgICAgICAgICB1cGRhdGVkQ291bnQtLTsKICAgICAgICAgIG1hcmtSZW1vdmFsW3ByZXZpb3VzSW5kZXhdID0gMTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY291bnRzW2ldID0gdXBkYXRlZENvdW50OwogICAgICBvZmZzZXQgKz0gY291bnQ7CiAgICB9CiAgICBsZXQgbmV4dEF2YWlsYWJsZUluZGV4ID0gMDsKICAgIGZvciAobGV0IGsgPSAwOyBrIDwgcG9zaXRpb25zTGVuZ3RoOyBrKyspIHsKICAgICAgaWYgKG1hcmtSZW1vdmFsW2tdICE9PSAxKSB7CiAgICAgICAgdUJ1ZmZlcltuZXh0QXZhaWxhYmxlSW5kZXhdID0gdUJ1ZmZlcltrXTsKICAgICAgICB2QnVmZmVyW25leHRBdmFpbGFibGVJbmRleF0gPSB2QnVmZmVyW2tdOwogICAgICAgIGhlaWdodEJ1ZmZlcltuZXh0QXZhaWxhYmxlSW5kZXhdID0gaGVpZ2h0QnVmZmVyW2tdOwogICAgICAgIG5leHRBdmFpbGFibGVJbmRleCsrOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIFZlcnRleEF0dHJpYnV0ZXNBbmRJbmRpY2VzKHZvbHVtZXNDb3VudCkgewogICAgY29uc3QgdmVydGV4Q291bnQgPSB2b2x1bWVzQ291bnQgKiA4OwogICAgY29uc3QgdmVjM0Zsb2F0cyA9IHZlcnRleENvdW50ICogMzsKICAgIGNvbnN0IHZlYzRGbG9hdHMgPSB2ZXJ0ZXhDb3VudCAqIDQ7CiAgICB0aGlzLnN0YXJ0RWxsaXBzb2lkTm9ybWFscyA9IG5ldyBGbG9hdDMyQXJyYXkodmVjM0Zsb2F0cyk7CiAgICB0aGlzLmVuZEVsbGlwc29pZE5vcm1hbHMgPSBuZXcgRmxvYXQzMkFycmF5KHZlYzNGbG9hdHMpOwogICAgdGhpcy5zdGFydFBvc2l0aW9uQW5kSGVpZ2h0cyA9IG5ldyBGbG9hdDMyQXJyYXkodmVjNEZsb2F0cyk7CiAgICB0aGlzLnN0YXJ0RmFjZU5vcm1hbEFuZFZlcnRleENvcm5lcklkcyA9IG5ldyBGbG9hdDMyQXJyYXkodmVjNEZsb2F0cyk7CiAgICB0aGlzLmVuZFBvc2l0aW9uQW5kSGVpZ2h0cyA9IG5ldyBGbG9hdDMyQXJyYXkodmVjNEZsb2F0cyk7CiAgICB0aGlzLmVuZEZhY2VOb3JtYWxBbmRIYWxmV2lkdGhzID0gbmV3IEZsb2F0MzJBcnJheSh2ZWM0RmxvYXRzKTsKICAgIHRoaXMudmVydGV4QmF0Y2hJZHMgPSBuZXcgVWludDE2QXJyYXkodmVydGV4Q291bnQpOwogICAgdGhpcy5pbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkodmVydGV4Q291bnQsIDM2ICogdm9sdW1lc0NvdW50KTsKICAgIHRoaXMudmVjM09mZnNldCA9IDA7CiAgICB0aGlzLnZlYzRPZmZzZXQgPSAwOwogICAgdGhpcy5iYXRjaElkT2Zmc2V0ID0gMDsKICAgIHRoaXMuaW5kZXhPZmZzZXQgPSAwOwogICAgdGhpcy52b2x1bWVTdGFydEluZGV4ID0gMDsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZU1pdGVyZWROb3JtYWwocHJldmlvdXNQb3NpdGlvbiwgcG9zaXRpb24sIG5leHRQb3NpdGlvbiwgZWxsaXBzb2lkU3VyZmFjZU5vcm1hbCwgcmVzdWx0KSB7CiAgICBjb25zdCB0b3dhcmROZXh0ID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICBuZXh0UG9zaXRpb24sCiAgICAgIHBvc2l0aW9uLAogICAgICB0b3dhcmROZXh0U2NyYXRjaAogICAgKTsKICAgIGxldCB0b3dhcmRDdXJyID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICBwb3NpdGlvbiwKICAgICAgcHJldmlvdXNQb3NpdGlvbiwKICAgICAgdG93YXJkQ3VyclNjcmF0Y2gKICAgICk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHRvd2FyZE5leHQsIHRvd2FyZE5leHQpOwogICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSh0b3dhcmRDdXJyLCB0b3dhcmRDdXJyKTsKICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHRvd2FyZE5leHQsIHRvd2FyZEN1cnIpIDwgTUlURVJfQlJFQUspIHsKICAgICAgdG93YXJkQ3VyciA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgIHRvd2FyZEN1cnIsCiAgICAgICAgLTEsCiAgICAgICAgdG93YXJkQ3VyclNjcmF0Y2gKICAgICAgKTsKICAgIH0KICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQodG93YXJkTmV4dCwgdG93YXJkQ3VyciwgcmVzdWx0KTsKICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKHJlc3VsdCwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pKSB7CiAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwcmV2aW91c1Bvc2l0aW9uLCBwb3NpdGlvbik7CiAgICB9CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MocmVzdWx0LCBlbGxpcHNvaWRTdXJmYWNlTm9ybWFsLCByZXN1bHQpOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKGVsbGlwc29pZFN1cmZhY2VOb3JtYWwsIHJlc3VsdCwgcmVzdWx0KTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmVzdWx0LCByZXN1bHQpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXMocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3QgZW5jb2RlZFBvc2l0aW9ucyA9IG5ldyBVaW50MTZBcnJheShwYXJhbWV0ZXJzLnBvc2l0aW9ucyk7CiAgICBjb25zdCB3aWR0aHMgPSBuZXcgVWludDE2QXJyYXkocGFyYW1ldGVycy53aWR0aHMpOwogICAgY29uc3QgY291bnRzID0gbmV3IFVpbnQzMkFycmF5KHBhcmFtZXRlcnMuY291bnRzKTsKICAgIGNvbnN0IGJhdGNoSWRzID0gbmV3IFVpbnQxNkFycmF5KHBhcmFtZXRlcnMuYmF0Y2hJZHMpOwogICAgY29uc3QgcmVjdGFuZ2xlID0gc2NyYXRjaFJlY3RhbmdsZTM7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBzY3JhdGNoRWxsaXBzb2lkMTM7CiAgICBjb25zdCBjZW50ZXIgPSBzY3JhdGNoQ2VudGVyNDsKICAgIGNvbnN0IHBhY2tlZEJ1ZmZlciA9IG5ldyBGbG9hdDY0QXJyYXkocGFyYW1ldGVycy5wYWNrZWRCdWZmZXIpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBjb25zdCBtaW5pbXVtSGVpZ2h0ID0gcGFja2VkQnVmZmVyW29mZnNldCsrXTsKICAgIGNvbnN0IG1heGltdW1IZWlnaHQgPSBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdOwogICAgUmVjdGFuZ2xlX2RlZmF1bHQudW5wYWNrKHBhY2tlZEJ1ZmZlciwgb2Zmc2V0LCByZWN0YW5nbGUpOwogICAgb2Zmc2V0ICs9IFJlY3RhbmdsZV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhwYWNrZWRCdWZmZXIsIG9mZnNldCwgZWxsaXBzb2lkKTsKICAgIG9mZnNldCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKHBhY2tlZEJ1ZmZlciwgb2Zmc2V0LCBjZW50ZXIpOwogICAgbGV0IGk7CiAgICBsZXQgcG9zaXRpb25zTGVuZ3RoID0gZW5jb2RlZFBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgY29uc3QgdUJ1ZmZlciA9IGVuY29kZWRQb3NpdGlvbnMuc3ViYXJyYXkoMCwgcG9zaXRpb25zTGVuZ3RoKTsKICAgIGNvbnN0IHZCdWZmZXIgPSBlbmNvZGVkUG9zaXRpb25zLnN1YmFycmF5KAogICAgICBwb3NpdGlvbnNMZW5ndGgsCiAgICAgIDIgKiBwb3NpdGlvbnNMZW5ndGgKICAgICk7CiAgICBjb25zdCBoZWlnaHRCdWZmZXIgPSBlbmNvZGVkUG9zaXRpb25zLnN1YmFycmF5KAogICAgICAyICogcG9zaXRpb25zTGVuZ3RoLAogICAgICAzICogcG9zaXRpb25zTGVuZ3RoCiAgICApOwogICAgQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC56aWdaYWdEZWx0YURlY29kZSh1QnVmZmVyLCB2QnVmZmVyLCBoZWlnaHRCdWZmZXIpOwogICAgcmVtb3ZlRHVwbGljYXRlcyh1QnVmZmVyLCB2QnVmZmVyLCBoZWlnaHRCdWZmZXIsIGNvdW50cyk7CiAgICBjb25zdCBjb3VudHNMZW5ndGggPSBjb3VudHMubGVuZ3RoOwogICAgbGV0IHZvbHVtZXNDb3VudCA9IDA7CiAgICBmb3IgKGkgPSAwOyBpIDwgY291bnRzTGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcG9seWxpbmVQb3NpdGlvbkNvdW50ID0gY291bnRzW2ldOwogICAgICB2b2x1bWVzQ291bnQgKz0gcG9seWxpbmVQb3NpdGlvbkNvdW50IC0gMTsKICAgIH0KICAgIGNvbnN0IGF0dHJpYnNBbmRJbmRpY2VzID0gbmV3IFZlcnRleEF0dHJpYnV0ZXNBbmRJbmRpY2VzKHZvbHVtZXNDb3VudCk7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBkZWNvZGVQb3NpdGlvbnMoCiAgICAgIHVCdWZmZXIsCiAgICAgIHZCdWZmZXIsCiAgICAgIGhlaWdodEJ1ZmZlciwKICAgICAgcmVjdGFuZ2xlLAogICAgICBtaW5pbXVtSGVpZ2h0LAogICAgICBtYXhpbXVtSGVpZ2h0LAogICAgICBlbGxpcHNvaWQsCiAgICAgIGNlbnRlcgogICAgKTsKICAgIHBvc2l0aW9uc0xlbmd0aCA9IHVCdWZmZXIubGVuZ3RoOwogICAgY29uc3QgcG9zaXRpb25zUlRDID0gbmV3IEZsb2F0MzJBcnJheShwb3NpdGlvbnNMZW5ndGggKiAzKTsKICAgIGZvciAoaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGg7ICsraSkgewogICAgICBwb3NpdGlvbnNSVENbaSAqIDNdID0gcG9zaXRpb25zW2kgKiAzXSAtIGNlbnRlci54OwogICAgICBwb3NpdGlvbnNSVENbaSAqIDMgKyAxXSA9IHBvc2l0aW9uc1tpICogMyArIDFdIC0gY2VudGVyLnk7CiAgICAgIHBvc2l0aW9uc1JUQ1tpICogMyArIDJdID0gcG9zaXRpb25zW2kgKiAzICsgMl0gLSBjZW50ZXIuejsKICAgIH0KICAgIGxldCBjdXJyZW50UG9zaXRpb25JbmRleCA9IDA7CiAgICBsZXQgY3VycmVudEhlaWdodEluZGV4ID0gMDsKICAgIGZvciAoaSA9IDA7IGkgPCBjb3VudHNMZW5ndGg7IGkrKykgewogICAgICBjb25zdCBwb2x5bGluZVZvbHVtZUNvdW50ID0gY291bnRzW2ldIC0gMTsKICAgICAgY29uc3QgaGFsZldpZHRoID0gd2lkdGhzW2ldICogMC41OwogICAgICBjb25zdCBiYXRjaElkID0gYmF0Y2hJZHNbaV07CiAgICAgIGNvbnN0IHZvbHVtZUZpcnN0UG9zaXRpb25JbmRleCA9IGN1cnJlbnRQb3NpdGlvbkluZGV4OwogICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHBvbHlsaW5lVm9sdW1lQ291bnQ7IGorKykgewogICAgICAgIGNvbnN0IHZvbHVtZVN0YXJ0ID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgIHBvc2l0aW9uc1JUQywKICAgICAgICAgIGN1cnJlbnRQb3NpdGlvbkluZGV4LAogICAgICAgICAgc2NyYXRjaFAwCiAgICAgICAgKTsKICAgICAgICBjb25zdCB2b2x1bWVFbmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgcG9zaXRpb25zUlRDLAogICAgICAgICAgY3VycmVudFBvc2l0aW9uSW5kZXggKyAzLAogICAgICAgICAgc2NyYXRjaFAxCiAgICAgICAgKTsKICAgICAgICBsZXQgc3RhcnRIZWlnaHQgPSBoZWlnaHRCdWZmZXJbY3VycmVudEhlaWdodEluZGV4XTsKICAgICAgICBsZXQgZW5kSGVpZ2h0ID0gaGVpZ2h0QnVmZmVyW2N1cnJlbnRIZWlnaHRJbmRleCArIDFdOwogICAgICAgIHN0YXJ0SGVpZ2h0ID0gTWF0aF9kZWZhdWx0LmxlcnAoCiAgICAgICAgICBtaW5pbXVtSGVpZ2h0LAogICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgIHN0YXJ0SGVpZ2h0IC8gTUFYX1NIT1JUCiAgICAgICAgKTsKICAgICAgICBlbmRIZWlnaHQgPSBNYXRoX2RlZmF1bHQubGVycCgKICAgICAgICAgIG1pbmltdW1IZWlnaHQsCiAgICAgICAgICBtYXhpbXVtSGVpZ2h0LAogICAgICAgICAgZW5kSGVpZ2h0IC8gTUFYX1NIT1JUCiAgICAgICAgKTsKICAgICAgICBjdXJyZW50SGVpZ2h0SW5kZXgrKzsKICAgICAgICBsZXQgcHJlU3RhcnQgPSBzY3JhdGNoUHJldjsKICAgICAgICBsZXQgcG9zdEVuZCA9IHNjcmF0Y2hOZXh0OwogICAgICAgIGlmIChqID09PSAwKSB7CiAgICAgICAgICBjb25zdCBmaW5hbFBvc2l0aW9uSW5kZXggPSB2b2x1bWVGaXJzdFBvc2l0aW9uSW5kZXggKyBwb2x5bGluZVZvbHVtZUNvdW50ICogMzsKICAgICAgICAgIGNvbnN0IGZpbmFsUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICBwb3NpdGlvbnNSVEMsCiAgICAgICAgICAgIGZpbmFsUG9zaXRpb25JbmRleCwKICAgICAgICAgICAgc2NyYXRjaFByZXYKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhmaW5hbFBvc2l0aW9uLCB2b2x1bWVTdGFydCkpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhwb3NpdGlvbnNSVEMsIGZpbmFsUG9zaXRpb25JbmRleCAtIDMsIHByZVN0YXJ0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IG9mZnNldFBhc3RTdGFydCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgICAgICB2b2x1bWVTdGFydCwKICAgICAgICAgICAgICB2b2x1bWVFbmQsCiAgICAgICAgICAgICAgc2NyYXRjaFByZXYKICAgICAgICAgICAgKTsKICAgICAgICAgICAgcHJlU3RhcnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG9mZnNldFBhc3RTdGFydCwgdm9sdW1lU3RhcnQsIHNjcmF0Y2hQcmV2KTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhwb3NpdGlvbnNSVEMsIGN1cnJlbnRQb3NpdGlvbkluZGV4IC0gMywgcHJlU3RhcnQpOwogICAgICAgIH0KICAgICAgICBpZiAoaiA9PT0gcG9seWxpbmVWb2x1bWVDb3VudCAtIDEpIHsKICAgICAgICAgIGNvbnN0IGZpcnN0UG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICBwb3NpdGlvbnNSVEMsCiAgICAgICAgICAgIHZvbHVtZUZpcnN0UG9zaXRpb25JbmRleCwKICAgICAgICAgICAgc2NyYXRjaE5leHQKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhmaXJzdFBvc2l0aW9uLCB2b2x1bWVFbmQpKSB7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICAgICAgcG9zaXRpb25zUlRDLAogICAgICAgICAgICAgIHZvbHVtZUZpcnN0UG9zaXRpb25JbmRleCArIDMsCiAgICAgICAgICAgICAgcG9zdEVuZAogICAgICAgICAgICApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc3Qgb2Zmc2V0UGFzdEVuZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgICAgICB2b2x1bWVFbmQsCiAgICAgICAgICAgICAgdm9sdW1lU3RhcnQsCiAgICAgICAgICAgICAgc2NyYXRjaE5leHQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgcG9zdEVuZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQob2Zmc2V0UGFzdEVuZCwgdm9sdW1lRW5kLCBzY3JhdGNoTmV4dCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2socG9zaXRpb25zUlRDLCBjdXJyZW50UG9zaXRpb25JbmRleCArIDYsIHBvc3RFbmQpOwogICAgICAgIH0KICAgICAgICBhdHRyaWJzQW5kSW5kaWNlcy5hZGRWb2x1bWUoCiAgICAgICAgICBwcmVTdGFydCwKICAgICAgICAgIHZvbHVtZVN0YXJ0LAogICAgICAgICAgdm9sdW1lRW5kLAogICAgICAgICAgcG9zdEVuZCwKICAgICAgICAgIHN0YXJ0SGVpZ2h0LAogICAgICAgICAgZW5kSGVpZ2h0LAogICAgICAgICAgaGFsZldpZHRoLAogICAgICAgICAgYmF0Y2hJZCwKICAgICAgICAgIGNlbnRlciwKICAgICAgICAgIGVsbGlwc29pZAogICAgICAgICk7CiAgICAgICAgY3VycmVudFBvc2l0aW9uSW5kZXggKz0gMzsKICAgICAgfQogICAgICBjdXJyZW50UG9zaXRpb25JbmRleCArPSAzOwogICAgICBjdXJyZW50SGVpZ2h0SW5kZXgrKzsKICAgIH0KICAgIGNvbnN0IGluZGljZXMgPSBhdHRyaWJzQW5kSW5kaWNlcy5pbmRpY2VzOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKGF0dHJpYnNBbmRJbmRpY2VzLnN0YXJ0RWxsaXBzb2lkTm9ybWFscy5idWZmZXIpOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKGF0dHJpYnNBbmRJbmRpY2VzLmVuZEVsbGlwc29pZE5vcm1hbHMuYnVmZmVyKTsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChhdHRyaWJzQW5kSW5kaWNlcy5zdGFydFBvc2l0aW9uQW5kSGVpZ2h0cy5idWZmZXIpOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKAogICAgICBhdHRyaWJzQW5kSW5kaWNlcy5zdGFydEZhY2VOb3JtYWxBbmRWZXJ0ZXhDb3JuZXJJZHMuYnVmZmVyCiAgICApOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKGF0dHJpYnNBbmRJbmRpY2VzLmVuZFBvc2l0aW9uQW5kSGVpZ2h0cy5idWZmZXIpOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKGF0dHJpYnNBbmRJbmRpY2VzLmVuZEZhY2VOb3JtYWxBbmRIYWxmV2lkdGhzLmJ1ZmZlcik7CiAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2goYXR0cmlic0FuZEluZGljZXMudmVydGV4QmF0Y2hJZHMuYnVmZmVyKTsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChpbmRpY2VzLmJ1ZmZlcik7CiAgICBsZXQgcmVzdWx0cyA9IHsKICAgICAgaW5kZXhEYXRhdHlwZTogaW5kaWNlcy5CWVRFU19QRVJfRUxFTUVOVCA9PT0gMiA/IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9TSE9SVCA6IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9JTlQsCiAgICAgIHN0YXJ0RWxsaXBzb2lkTm9ybWFsczogYXR0cmlic0FuZEluZGljZXMuc3RhcnRFbGxpcHNvaWROb3JtYWxzLmJ1ZmZlciwKICAgICAgZW5kRWxsaXBzb2lkTm9ybWFsczogYXR0cmlic0FuZEluZGljZXMuZW5kRWxsaXBzb2lkTm9ybWFscy5idWZmZXIsCiAgICAgIHN0YXJ0UG9zaXRpb25BbmRIZWlnaHRzOiBhdHRyaWJzQW5kSW5kaWNlcy5zdGFydFBvc2l0aW9uQW5kSGVpZ2h0cy5idWZmZXIsCiAgICAgIHN0YXJ0RmFjZU5vcm1hbEFuZFZlcnRleENvcm5lcklkczogYXR0cmlic0FuZEluZGljZXMuc3RhcnRGYWNlTm9ybWFsQW5kVmVydGV4Q29ybmVySWRzLmJ1ZmZlciwKICAgICAgZW5kUG9zaXRpb25BbmRIZWlnaHRzOiBhdHRyaWJzQW5kSW5kaWNlcy5lbmRQb3NpdGlvbkFuZEhlaWdodHMuYnVmZmVyLAogICAgICBlbmRGYWNlTm9ybWFsQW5kSGFsZldpZHRoczogYXR0cmlic0FuZEluZGljZXMuZW5kRmFjZU5vcm1hbEFuZEhhbGZXaWR0aHMuYnVmZmVyLAogICAgICB2ZXJ0ZXhCYXRjaElkczogYXR0cmlic0FuZEluZGljZXMudmVydGV4QmF0Y2hJZHMuYnVmZmVyLAogICAgICBpbmRpY2VzOiBpbmRpY2VzLmJ1ZmZlcgogICAgfTsKICAgIGlmIChwYXJhbWV0ZXJzLmtlZXBEZWNvZGVkUG9zaXRpb25zKSB7CiAgICAgIGNvbnN0IHBvc2l0aW9uT2Zmc2V0cyA9IGdldFBvc2l0aW9uT2Zmc2V0cyhjb3VudHMpOwogICAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2gocG9zaXRpb25zLmJ1ZmZlciwgcG9zaXRpb25PZmZzZXRzLmJ1ZmZlcik7CiAgICAgIHJlc3VsdHMgPSBjb21iaW5lX2RlZmF1bHQocmVzdWx0cywgewogICAgICAgIGRlY29kZWRQb3NpdGlvbnM6IHBvc2l0aW9ucy5idWZmZXIsCiAgICAgICAgZGVjb2RlZFBvc2l0aW9uT2Zmc2V0czogcG9zaXRpb25PZmZzZXRzLmJ1ZmZlcgogICAgICB9KTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH0KICB2YXIgTUFYX1NIT1JULCBNSVRFUl9CUkVBSywgc2NyYXRjaEJWQ2FydG9ncmFwaGljLCBzY3JhdGNoRW5jb2RlZFBvc2l0aW9uLCBwcmV2aW91c0NvbXByZXNzZWRDYXJ0b2dyYXBoaWNTY3JhdGNoLCBjdXJyZW50Q29tcHJlc3NlZENhcnRvZ3JhcGhpY1NjcmF0Y2gsIHRvd2FyZEN1cnJTY3JhdGNoLCB0b3dhcmROZXh0U2NyYXRjaCwgUkVGRVJFTkNFX0lORElDRVMyLCBSRUZFUkVOQ0VfSU5ESUNFU19MRU5HVEgyLCBwb3NpdGlvblNjcmF0Y2g0LCBzY3JhdGNoU3RhcnRFbGxpcHNvaWROb3JtYWwsIHNjcmF0Y2hTdGFydEZhY2VOb3JtYWwsIHNjcmF0Y2hFbmRFbGxpcHNvaWROb3JtYWwsIHNjcmF0Y2hFbmRGYWNlTm9ybWFsLCBzY3JhdGNoUmVjdGFuZ2xlMywgc2NyYXRjaEVsbGlwc29pZDEzLCBzY3JhdGNoQ2VudGVyNCwgc2NyYXRjaFByZXYsIHNjcmF0Y2hQMCwgc2NyYXRjaFAxLCBzY3JhdGNoTmV4dCwgY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXNfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVWZWN0b3JUaWxlQ2xhbXBlZFBvbHlsaW5lcyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXMuanMiKCkgewogICAgICBpbml0X0F0dHJpYnV0ZUNvbXByZXNzaW9uKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X2NvbWJpbmUoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKTsKICAgICAgTUFYX1NIT1JUID0gMzI3Njc7CiAgICAgIE1JVEVSX0JSRUFLID0gTWF0aC5jb3MoTWF0aF9kZWZhdWx0LnRvUmFkaWFucygxNTApKTsKICAgICAgc2NyYXRjaEJWQ2FydG9ncmFwaGljID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFbmNvZGVkUG9zaXRpb24gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHByZXZpb3VzQ29tcHJlc3NlZENhcnRvZ3JhcGhpY1NjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgY3VycmVudENvbXByZXNzZWRDYXJ0b2dyYXBoaWNTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHRvd2FyZEN1cnJTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB0b3dhcmROZXh0U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgUkVGRVJFTkNFX0lORElDRVMyID0gWwogICAgICAgIDAsCiAgICAgICAgMiwKICAgICAgICA2LAogICAgICAgIDAsCiAgICAgICAgNiwKICAgICAgICA0LAogICAgICAgIC8vIHJpZ2h0CiAgICAgICAgMCwKICAgICAgICAxLAogICAgICAgIDMsCiAgICAgICAgMCwKICAgICAgICAzLAogICAgICAgIDIsCiAgICAgICAgLy8gc3RhcnQgZmFjZQogICAgICAgIDAsCiAgICAgICAgNCwKICAgICAgICA1LAogICAgICAgIDAsCiAgICAgICAgNSwKICAgICAgICAxLAogICAgICAgIC8vIGJvdHRvbQogICAgICAgIDUsCiAgICAgICAgMywKICAgICAgICAxLAogICAgICAgIDUsCiAgICAgICAgNywKICAgICAgICAzLAogICAgICAgIC8vIGxlZnQKICAgICAgICA3LAogICAgICAgIDUsCiAgICAgICAgNCwKICAgICAgICA3LAogICAgICAgIDQsCiAgICAgICAgNiwKICAgICAgICAvLyBlbmQgZmFjZQogICAgICAgIDcsCiAgICAgICAgNiwKICAgICAgICAyLAogICAgICAgIDcsCiAgICAgICAgMiwKICAgICAgICAzCiAgICAgICAgLy8gdG9wCiAgICAgIF07CiAgICAgIFJFRkVSRU5DRV9JTkRJQ0VTX0xFTkdUSDIgPSBSRUZFUkVOQ0VfSU5ESUNFUzIubGVuZ3RoOwogICAgICBwb3NpdGlvblNjcmF0Y2g0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoU3RhcnRFbGxpcHNvaWROb3JtYWwgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hTdGFydEZhY2VOb3JtYWwgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFbmRFbGxpcHNvaWROb3JtYWwgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFbmRGYWNlTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBWZXJ0ZXhBdHRyaWJ1dGVzQW5kSW5kaWNlcy5wcm90b3R5cGUuYWRkVm9sdW1lID0gZnVuY3Rpb24ocHJlU3RhcnRSVEMsIHN0YXJ0UlRDLCBlbmRSVEMsIHBvc3RFbmRSVEMsIHN0YXJ0SGVpZ2h0LCBlbmRIZWlnaHQsIGhhbGZXaWR0aCwgYmF0Y2hJZCwgY2VudGVyLCBlbGxpcHNvaWQpIHsKICAgICAgICBsZXQgcG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHN0YXJ0UlRDLCBjZW50ZXIsIHBvc2l0aW9uU2NyYXRjaDQpOwogICAgICAgIGNvbnN0IHN0YXJ0RWxsaXBzb2lkTm9ybWFsID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbCgKICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgc2NyYXRjaFN0YXJ0RWxsaXBzb2lkTm9ybWFsCiAgICAgICAgKTsKICAgICAgICBwb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoZW5kUlRDLCBjZW50ZXIsIHBvc2l0aW9uU2NyYXRjaDQpOwogICAgICAgIGNvbnN0IGVuZEVsbGlwc29pZE5vcm1hbCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoCiAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgIHNjcmF0Y2hFbmRFbGxpcHNvaWROb3JtYWwKICAgICAgICApOwogICAgICAgIGNvbnN0IHN0YXJ0RmFjZU5vcm1hbCA9IGNvbXB1dGVNaXRlcmVkTm9ybWFsKAogICAgICAgICAgcHJlU3RhcnRSVEMsCiAgICAgICAgICBzdGFydFJUQywKICAgICAgICAgIGVuZFJUQywKICAgICAgICAgIHN0YXJ0RWxsaXBzb2lkTm9ybWFsLAogICAgICAgICAgc2NyYXRjaFN0YXJ0RmFjZU5vcm1hbAogICAgICAgICk7CiAgICAgICAgY29uc3QgZW5kRmFjZU5vcm1hbCA9IGNvbXB1dGVNaXRlcmVkTm9ybWFsKAogICAgICAgICAgcG9zdEVuZFJUQywKICAgICAgICAgIGVuZFJUQywKICAgICAgICAgIHN0YXJ0UlRDLAogICAgICAgICAgZW5kRWxsaXBzb2lkTm9ybWFsLAogICAgICAgICAgc2NyYXRjaEVuZEZhY2VOb3JtYWwKICAgICAgICApOwogICAgICAgIGNvbnN0IHN0YXJ0RWxsaXBzb2lkTm9ybWFscyA9IHRoaXMuc3RhcnRFbGxpcHNvaWROb3JtYWxzOwogICAgICAgIGNvbnN0IGVuZEVsbGlwc29pZE5vcm1hbHMgPSB0aGlzLmVuZEVsbGlwc29pZE5vcm1hbHM7CiAgICAgICAgY29uc3Qgc3RhcnRQb3NpdGlvbkFuZEhlaWdodHMgPSB0aGlzLnN0YXJ0UG9zaXRpb25BbmRIZWlnaHRzOwogICAgICAgIGNvbnN0IHN0YXJ0RmFjZU5vcm1hbEFuZFZlcnRleENvcm5lcklkcyA9IHRoaXMuc3RhcnRGYWNlTm9ybWFsQW5kVmVydGV4Q29ybmVySWRzOwogICAgICAgIGNvbnN0IGVuZFBvc2l0aW9uQW5kSGVpZ2h0cyA9IHRoaXMuZW5kUG9zaXRpb25BbmRIZWlnaHRzOwogICAgICAgIGNvbnN0IGVuZEZhY2VOb3JtYWxBbmRIYWxmV2lkdGhzID0gdGhpcy5lbmRGYWNlTm9ybWFsQW5kSGFsZldpZHRoczsKICAgICAgICBjb25zdCB2ZXJ0ZXhCYXRjaElkcyA9IHRoaXMudmVydGV4QmF0Y2hJZHM7CiAgICAgICAgbGV0IGJhdGNoSWRPZmZzZXQgPSB0aGlzLmJhdGNoSWRPZmZzZXQ7CiAgICAgICAgbGV0IHZlYzNPZmZzZXQgPSB0aGlzLnZlYzNPZmZzZXQ7CiAgICAgICAgbGV0IHZlYzRPZmZzZXQgPSB0aGlzLnZlYzRPZmZzZXQ7CiAgICAgICAgbGV0IGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IDg7IGkrKykgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soc3RhcnRFbGxpcHNvaWROb3JtYWwsIHN0YXJ0RWxsaXBzb2lkTm9ybWFscywgdmVjM09mZnNldCk7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhlbmRFbGxpcHNvaWROb3JtYWwsIGVuZEVsbGlwc29pZE5vcm1hbHMsIHZlYzNPZmZzZXQpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soc3RhcnRSVEMsIHN0YXJ0UG9zaXRpb25BbmRIZWlnaHRzLCB2ZWM0T2Zmc2V0KTsKICAgICAgICAgIHN0YXJ0UG9zaXRpb25BbmRIZWlnaHRzW3ZlYzRPZmZzZXQgKyAzXSA9IHN0YXJ0SGVpZ2h0OwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soZW5kUlRDLCBlbmRQb3NpdGlvbkFuZEhlaWdodHMsIHZlYzRPZmZzZXQpOwogICAgICAgICAgZW5kUG9zaXRpb25BbmRIZWlnaHRzW3ZlYzRPZmZzZXQgKyAzXSA9IGVuZEhlaWdodDsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKAogICAgICAgICAgICBzdGFydEZhY2VOb3JtYWwsCiAgICAgICAgICAgIHN0YXJ0RmFjZU5vcm1hbEFuZFZlcnRleENvcm5lcklkcywKICAgICAgICAgICAgdmVjNE9mZnNldAogICAgICAgICAgKTsKICAgICAgICAgIHN0YXJ0RmFjZU5vcm1hbEFuZFZlcnRleENvcm5lcklkc1t2ZWM0T2Zmc2V0ICsgM10gPSBpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soZW5kRmFjZU5vcm1hbCwgZW5kRmFjZU5vcm1hbEFuZEhhbGZXaWR0aHMsIHZlYzRPZmZzZXQpOwogICAgICAgICAgZW5kRmFjZU5vcm1hbEFuZEhhbGZXaWR0aHNbdmVjNE9mZnNldCArIDNdID0gaGFsZldpZHRoOwogICAgICAgICAgdmVydGV4QmF0Y2hJZHNbYmF0Y2hJZE9mZnNldCsrXSA9IGJhdGNoSWQ7CiAgICAgICAgICB2ZWMzT2Zmc2V0ICs9IDM7CiAgICAgICAgICB2ZWM0T2Zmc2V0ICs9IDQ7CiAgICAgICAgfQogICAgICAgIHRoaXMuYmF0Y2hJZE9mZnNldCA9IGJhdGNoSWRPZmZzZXQ7CiAgICAgICAgdGhpcy52ZWMzT2Zmc2V0ID0gdmVjM09mZnNldDsKICAgICAgICB0aGlzLnZlYzRPZmZzZXQgPSB2ZWM0T2Zmc2V0OwogICAgICAgIGNvbnN0IGluZGljZXMgPSB0aGlzLmluZGljZXM7CiAgICAgICAgY29uc3Qgdm9sdW1lU3RhcnRJbmRleCA9IHRoaXMudm9sdW1lU3RhcnRJbmRleDsKICAgICAgICBjb25zdCBpbmRleE9mZnNldCA9IHRoaXMuaW5kZXhPZmZzZXQ7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IFJFRkVSRU5DRV9JTkRJQ0VTX0xFTkdUSDI7IGkrKykgewogICAgICAgICAgaW5kaWNlc1tpbmRleE9mZnNldCArIGldID0gUkVGRVJFTkNFX0lORElDRVMyW2ldICsgdm9sdW1lU3RhcnRJbmRleDsKICAgICAgICB9CiAgICAgICAgdGhpcy52b2x1bWVTdGFydEluZGV4ICs9IDg7CiAgICAgICAgdGhpcy5pbmRleE9mZnNldCArPSBSRUZFUkVOQ0VfSU5ESUNFU19MRU5HVEgyOwogICAgICB9OwogICAgICBzY3JhdGNoUmVjdGFuZ2xlMyA9IG5ldyBSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRWxsaXBzb2lkMTMgPSBuZXcgRWxsaXBzb2lkX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENlbnRlcjQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQcmV2ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUDAgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQMSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE5leHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNyZWF0ZVZlY3RvclRpbGVDbGFtcGVkUG9seWxpbmVzX2RlZmF1bHQgPSBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2RlZmF1bHQoY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXMpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1NjZW5lL1ZlY3RvcjNEVGlsZUJhdGNoLmpzCiAgZnVuY3Rpb24gVmVjdG9yM0RUaWxlQmF0Y2gob3B0aW9ucykgewogICAgdGhpcy5vZmZzZXQgPSBvcHRpb25zLm9mZnNldDsKICAgIHRoaXMuY291bnQgPSBvcHRpb25zLmNvdW50OwogICAgdGhpcy5jb2xvciA9IG9wdGlvbnMuY29sb3I7CiAgICB0aGlzLmJhdGNoSWRzID0gb3B0aW9ucy5iYXRjaElkczsKICB9CiAgdmFyIFZlY3RvcjNEVGlsZUJhdGNoX2RlZmF1bHQ7CiAgdmFyIGluaXRfVmVjdG9yM0RUaWxlQmF0Y2ggPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9TY2VuZS9WZWN0b3IzRFRpbGVCYXRjaC5qcyIoKSB7CiAgICAgIFZlY3RvcjNEVGlsZUJhdGNoX2RlZmF1bHQgPSBWZWN0b3IzRFRpbGVCYXRjaDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVZlY3RvclRpbGVHZW9tZXRyaWVzLmpzCiAgdmFyIGNyZWF0ZVZlY3RvclRpbGVHZW9tZXRyaWVzX2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVWZWN0b3JUaWxlR2VvbWV0cmllc19leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVWZWN0b3JUaWxlR2VvbWV0cmllc19kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gYm94TW9kZWxNYXRyaXhBbmRCb3VuZGluZ1ZvbHVtZShib3hlcywgaW5kZXgpIHsKICAgIGxldCBib3hJbmRleCA9IGluZGV4ICogcGFja2VkQm94TGVuZ3RoOwogICAgY29uc3QgZGltZW5zaW9ucyA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYm94ZXMsIGJveEluZGV4LCBzY3JhdGNoQ2FydGVzaWFuMTEpOwogICAgYm94SW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIGNvbnN0IGJveE1vZGVsTWF0cml4ID0gTWF0cml4NF9kZWZhdWx0LnVucGFjaygKICAgICAgYm94ZXMsCiAgICAgIGJveEluZGV4LAogICAgICBzY3JhdGNoTW9kZWxNYXRyaXhBbmRCVi5tb2RlbE1hdHJpeAogICAgKTsKICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGUoYm94TW9kZWxNYXRyaXgsIGRpbWVuc2lvbnMsIGJveE1vZGVsTWF0cml4KTsKICAgIGNvbnN0IGJvdW5kaW5nVm9sdW1lID0gc2NyYXRjaE1vZGVsTWF0cml4QW5kQlYuYm91bmRpbmdWb2x1bWU7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIGJvdW5kaW5nVm9sdW1lLmNlbnRlcik7CiAgICBib3VuZGluZ1ZvbHVtZS5yYWRpdXMgPSBNYXRoLnNxcnQoMyk7CiAgICByZXR1cm4gc2NyYXRjaE1vZGVsTWF0cml4QW5kQlY7CiAgfQogIGZ1bmN0aW9uIGN5bGluZGVyTW9kZWxNYXRyaXhBbmRCb3VuZGluZ1ZvbHVtZShjeWxpbmRlcnMsIGluZGV4KSB7CiAgICBsZXQgY3lsaW5kZXJJbmRleCA9IGluZGV4ICogcGFja2VkQ3lsaW5kZXJMZW5ndGg7CiAgICBjb25zdCBjeWxpbmRlclJhZGl1cyA9IGN5bGluZGVyc1tjeWxpbmRlckluZGV4KytdOwogICAgY29uc3QgbGVuZ3RoID0gY3lsaW5kZXJzW2N5bGluZGVySW5kZXgrK107CiAgICBjb25zdCBzY2FsZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tRWxlbWVudHMoCiAgICAgIGN5bGluZGVyUmFkaXVzLAogICAgICBjeWxpbmRlclJhZGl1cywKICAgICAgbGVuZ3RoLAogICAgICBzY3JhdGNoQ2FydGVzaWFuMTEKICAgICk7CiAgICBjb25zdCBjeWxpbmRlck1vZGVsTWF0cml4ID0gTWF0cml4NF9kZWZhdWx0LnVucGFjaygKICAgICAgY3lsaW5kZXJzLAogICAgICBjeWxpbmRlckluZGV4LAogICAgICBzY3JhdGNoTW9kZWxNYXRyaXhBbmRCVi5tb2RlbE1hdHJpeAogICAgKTsKICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGUoY3lsaW5kZXJNb2RlbE1hdHJpeCwgc2NhbGUsIGN5bGluZGVyTW9kZWxNYXRyaXgpOwogICAgY29uc3QgYm91bmRpbmdWb2x1bWUgPSBzY3JhdGNoTW9kZWxNYXRyaXhBbmRCVi5ib3VuZGluZ1ZvbHVtZTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgYm91bmRpbmdWb2x1bWUuY2VudGVyKTsKICAgIGJvdW5kaW5nVm9sdW1lLnJhZGl1cyA9IE1hdGguc3FydCgyKTsKICAgIHJldHVybiBzY3JhdGNoTW9kZWxNYXRyaXhBbmRCVjsKICB9CiAgZnVuY3Rpb24gZWxsaXBzb2lkTW9kZWxNYXRyaXhBbmRCb3VuZGluZ1ZvbHVtZShlbGxpcHNvaWRzLCBpbmRleCkgewogICAgbGV0IGVsbGlwc29pZEluZGV4ID0gaW5kZXggKiBwYWNrZWRFbGxpcHNvaWRMZW5ndGg7CiAgICBjb25zdCByYWRpaSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soZWxsaXBzb2lkcywgZWxsaXBzb2lkSW5kZXgsIHNjcmF0Y2hDYXJ0ZXNpYW4xMSk7CiAgICBlbGxpcHNvaWRJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgY29uc3QgZWxsaXBzb2lkTW9kZWxNYXRyaXggPSBNYXRyaXg0X2RlZmF1bHQudW5wYWNrKAogICAgICBlbGxpcHNvaWRzLAogICAgICBlbGxpcHNvaWRJbmRleCwKICAgICAgc2NyYXRjaE1vZGVsTWF0cml4QW5kQlYubW9kZWxNYXRyaXgKICAgICk7CiAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVNjYWxlKGVsbGlwc29pZE1vZGVsTWF0cml4LCByYWRpaSwgZWxsaXBzb2lkTW9kZWxNYXRyaXgpOwogICAgY29uc3QgYm91bmRpbmdWb2x1bWUgPSBzY3JhdGNoTW9kZWxNYXRyaXhBbmRCVi5ib3VuZGluZ1ZvbHVtZTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgYm91bmRpbmdWb2x1bWUuY2VudGVyKTsKICAgIGJvdW5kaW5nVm9sdW1lLnJhZGl1cyA9IDE7CiAgICByZXR1cm4gc2NyYXRjaE1vZGVsTWF0cml4QW5kQlY7CiAgfQogIGZ1bmN0aW9uIHNwaGVyZU1vZGVsTWF0cml4QW5kQm91bmRpbmdWb2x1bWUoc3BoZXJlcywgaW5kZXgpIHsKICAgIGxldCBzcGhlcmVJbmRleCA9IGluZGV4ICogcGFja2VkU3BoZXJlTGVuZ3RoOwogICAgY29uc3Qgc3BoZXJlUmFkaXVzID0gc3BoZXJlc1tzcGhlcmVJbmRleCsrXTsKICAgIGNvbnN0IHNwaGVyZVRyYW5zbGF0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgc3BoZXJlcywKICAgICAgc3BoZXJlSW5kZXgsCiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xMQogICAgKTsKICAgIGNvbnN0IHNwaGVyZU1vZGVsTWF0cml4ID0gTWF0cml4NF9kZWZhdWx0LmZyb21UcmFuc2xhdGlvbigKICAgICAgc3BoZXJlVHJhbnNsYXRpb24sCiAgICAgIHNjcmF0Y2hNb2RlbE1hdHJpeEFuZEJWLm1vZGVsTWF0cml4CiAgICApOwogICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlVbmlmb3JtU2NhbGUoCiAgICAgIHNwaGVyZU1vZGVsTWF0cml4LAogICAgICBzcGhlcmVSYWRpdXMsCiAgICAgIHNwaGVyZU1vZGVsTWF0cml4CiAgICApOwogICAgY29uc3QgYm91bmRpbmdWb2x1bWUgPSBzY3JhdGNoTW9kZWxNYXRyaXhBbmRCVi5ib3VuZGluZ1ZvbHVtZTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgYm91bmRpbmdWb2x1bWUuY2VudGVyKTsKICAgIGJvdW5kaW5nVm9sdW1lLnJhZGl1cyA9IDE7CiAgICByZXR1cm4gc2NyYXRjaE1vZGVsTWF0cml4QW5kQlY7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVByaW1pdGl2ZShvcHRpb25zLCBwcmltaXRpdmUsIHByaW1pdGl2ZUJhdGNoSWRzLCBnZW9tZXRyeSwgZ2V0TW9kZWxNYXRyaXhBbmRCb3VuZGluZ1ZvbHVtZSkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocHJpbWl0aXZlKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBudW1iZXJPZlByaW1pdGl2ZXMgPSBwcmltaXRpdmVCYXRjaElkcy5sZW5ndGg7CiAgICBjb25zdCBnZW9tZXRyeVBvc2l0aW9ucyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgY29uc3QgZ2VvbWV0cnlJbmRpY2VzID0gZ2VvbWV0cnkuaW5kaWNlczsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG9wdGlvbnMucG9zaXRpb25zOwogICAgY29uc3QgdmVydGV4QmF0Y2hJZHMgPSBvcHRpb25zLnZlcnRleEJhdGNoSWRzOwogICAgY29uc3QgaW5kaWNlcyA9IG9wdGlvbnMuaW5kaWNlczsKICAgIGNvbnN0IGJhdGNoSWRzID0gb3B0aW9ucy5iYXRjaElkczsKICAgIGNvbnN0IGJhdGNoVGFibGVDb2xvcnMgPSBvcHRpb25zLmJhdGNoVGFibGVDb2xvcnM7CiAgICBjb25zdCBiYXRjaGVkSW5kaWNlcyA9IG9wdGlvbnMuYmF0Y2hlZEluZGljZXM7CiAgICBjb25zdCBpbmRleE9mZnNldHMgPSBvcHRpb25zLmluZGV4T2Zmc2V0czsKICAgIGNvbnN0IGluZGV4Q291bnRzID0gb3B0aW9ucy5pbmRleENvdW50czsKICAgIGNvbnN0IGJvdW5kaW5nVm9sdW1lcyA9IG9wdGlvbnMuYm91bmRpbmdWb2x1bWVzOwogICAgY29uc3QgbW9kZWxNYXRyaXggPSBvcHRpb25zLm1vZGVsTWF0cml4OwogICAgY29uc3QgY2VudGVyID0gb3B0aW9ucy5jZW50ZXI7CiAgICBsZXQgcG9zaXRpb25PZmZzZXQgPSBvcHRpb25zLnBvc2l0aW9uT2Zmc2V0OwogICAgbGV0IGJhdGNoSWRJbmRleCA9IG9wdGlvbnMuYmF0Y2hJZEluZGV4OwogICAgbGV0IGluZGV4T2Zmc2V0ID0gb3B0aW9ucy5pbmRleE9mZnNldDsKICAgIGNvbnN0IGJhdGNoZWRJbmRpY2VzT2Zmc2V0ID0gb3B0aW9ucy5iYXRjaGVkSW5kaWNlc09mZnNldDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtYmVyT2ZQcmltaXRpdmVzOyArK2kpIHsKICAgICAgY29uc3QgcHJpbWl0aXZlTW9kZWxNYXRyaXhBbmRCViA9IGdldE1vZGVsTWF0cml4QW5kQm91bmRpbmdWb2x1bWUoCiAgICAgICAgcHJpbWl0aXZlLAogICAgICAgIGkKICAgICAgKTsKICAgICAgY29uc3QgcHJpbWl0aXZlTW9kZWxNYXRyaXggPSBwcmltaXRpdmVNb2RlbE1hdHJpeEFuZEJWLm1vZGVsTWF0cml4OwogICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHkobW9kZWxNYXRyaXgsIHByaW1pdGl2ZU1vZGVsTWF0cml4LCBwcmltaXRpdmVNb2RlbE1hdHJpeCk7CiAgICAgIGNvbnN0IGJhdGNoSWQgPSBwcmltaXRpdmVCYXRjaElkc1tpXTsKICAgICAgY29uc3QgcG9zaXRpb25zTGVuZ3RoID0gZ2VvbWV0cnlQb3NpdGlvbnMubGVuZ3RoOwogICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHBvc2l0aW9uc0xlbmd0aDsgaiArPSAzKSB7CiAgICAgICAgY29uc3QgcG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGdlb21ldHJ5UG9zaXRpb25zLCBqLCBzY3JhdGNoUG9zaXRpb241KTsKICAgICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50KHByaW1pdGl2ZU1vZGVsTWF0cml4LCBwb3NpdGlvbiwgcG9zaXRpb24pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwb3NpdGlvbiwgY2VudGVyLCBwb3NpdGlvbik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2socG9zaXRpb24sIHBvc2l0aW9ucywgcG9zaXRpb25PZmZzZXQgKiAzICsgaik7CiAgICAgICAgdmVydGV4QmF0Y2hJZHNbYmF0Y2hJZEluZGV4KytdID0gYmF0Y2hJZDsKICAgICAgfQogICAgICBjb25zdCBpbmRpY2VzTGVuZ3RoID0gZ2VvbWV0cnlJbmRpY2VzLmxlbmd0aDsKICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBpbmRpY2VzTGVuZ3RoOyArK2spIHsKICAgICAgICBpbmRpY2VzW2luZGV4T2Zmc2V0ICsga10gPSBnZW9tZXRyeUluZGljZXNba10gKyBwb3NpdGlvbk9mZnNldDsKICAgICAgfQogICAgICBjb25zdCBvZmZzZXQgPSBpICsgYmF0Y2hlZEluZGljZXNPZmZzZXQ7CiAgICAgIGJhdGNoZWRJbmRpY2VzW29mZnNldF0gPSBuZXcgVmVjdG9yM0RUaWxlQmF0Y2hfZGVmYXVsdCh7CiAgICAgICAgb2Zmc2V0OiBpbmRleE9mZnNldCwKICAgICAgICBjb3VudDogaW5kaWNlc0xlbmd0aCwKICAgICAgICBjb2xvcjogQ29sb3JfZGVmYXVsdC5mcm9tUmdiYShiYXRjaFRhYmxlQ29sb3JzW2JhdGNoSWRdKSwKICAgICAgICBiYXRjaElkczogW2JhdGNoSWRdCiAgICAgIH0pOwogICAgICBiYXRjaElkc1tvZmZzZXRdID0gYmF0Y2hJZDsKICAgICAgaW5kZXhPZmZzZXRzW29mZnNldF0gPSBpbmRleE9mZnNldDsKICAgICAgaW5kZXhDb3VudHNbb2Zmc2V0XSA9IGluZGljZXNMZW5ndGg7CiAgICAgIGJvdW5kaW5nVm9sdW1lc1tvZmZzZXRdID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC50cmFuc2Zvcm0oCiAgICAgICAgcHJpbWl0aXZlTW9kZWxNYXRyaXhBbmRCVi5ib3VuZGluZ1ZvbHVtZSwKICAgICAgICBwcmltaXRpdmVNb2RlbE1hdHJpeAogICAgICApOwogICAgICBwb3NpdGlvbk9mZnNldCArPSBwb3NpdGlvbnNMZW5ndGggLyAzOwogICAgICBpbmRleE9mZnNldCArPSBpbmRpY2VzTGVuZ3RoOwogICAgfQogICAgb3B0aW9ucy5wb3NpdGlvbk9mZnNldCA9IHBvc2l0aW9uT2Zmc2V0OwogICAgb3B0aW9ucy5iYXRjaElkSW5kZXggPSBiYXRjaElkSW5kZXg7CiAgICBvcHRpb25zLmluZGV4T2Zmc2V0ID0gaW5kZXhPZmZzZXQ7CiAgICBvcHRpb25zLmJhdGNoZWRJbmRpY2VzT2Zmc2V0ICs9IG51bWJlck9mUHJpbWl0aXZlczsKICB9CiAgZnVuY3Rpb24gdW5wYWNrQnVmZmVyKGJ1ZmZlcikgewogICAgY29uc3QgcGFja2VkQnVmZmVyID0gbmV3IEZsb2F0NjRBcnJheShidWZmZXIpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKHBhY2tlZEJ1ZmZlciwgb2Zmc2V0LCBzY3JhdGNoQ2VudGVyNSk7CiAgICBvZmZzZXQgKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIE1hdHJpeDRfZGVmYXVsdC51bnBhY2socGFja2VkQnVmZmVyLCBvZmZzZXQsIHNjcmF0Y2hNYXRyaXg0KTsKICB9CiAgZnVuY3Rpb24gcGFja2VkQmF0Y2hlZEluZGljZXNMZW5ndGgoYmF0Y2hlZEluZGljZXMpIHsKICAgIGNvbnN0IGxlbmd0aCA9IGJhdGNoZWRJbmRpY2VzLmxlbmd0aDsKICAgIGxldCBjb3VudCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGNvdW50ICs9IENvbG9yX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMyArIGJhdGNoZWRJbmRpY2VzW2ldLmJhdGNoSWRzLmxlbmd0aDsKICAgIH0KICAgIHJldHVybiBjb3VudDsKICB9CiAgZnVuY3Rpb24gcGFja0J1ZmZlcihpbmRpY2VzQnl0ZXNQZXJFbGVtZW50LCBiYXRjaGVkSW5kaWNlcywgYm91bmRpbmdWb2x1bWVzKSB7CiAgICBjb25zdCBudW1CVnMgPSBib3VuZGluZ1ZvbHVtZXMubGVuZ3RoOwogICAgY29uc3QgbGVuZ3RoID0gMSArIDEgKyBudW1CVnMgKiBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDEgKyBwYWNrZWRCYXRjaGVkSW5kaWNlc0xlbmd0aChiYXRjaGVkSW5kaWNlcyk7CiAgICBjb25zdCBwYWNrZWRCdWZmZXIgPSBuZXcgRmxvYXQ2NEFycmF5KGxlbmd0aCk7CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIHBhY2tlZEJ1ZmZlcltvZmZzZXQrK10gPSBpbmRpY2VzQnl0ZXNQZXJFbGVtZW50OwogICAgcGFja2VkQnVmZmVyW29mZnNldCsrXSA9IG51bUJWczsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtQlZzOyArK2kpIHsKICAgICAgQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrKGJvdW5kaW5nVm9sdW1lc1tpXSwgcGFja2VkQnVmZmVyLCBvZmZzZXQpOwogICAgICBvZmZzZXQgKz0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICB9CiAgICBjb25zdCBpbmRpY2VzTGVuZ3RoID0gYmF0Y2hlZEluZGljZXMubGVuZ3RoOwogICAgcGFja2VkQnVmZmVyW29mZnNldCsrXSA9IGluZGljZXNMZW5ndGg7CiAgICBmb3IgKGxldCBqID0gMDsgaiA8IGluZGljZXNMZW5ndGg7ICsraikgewogICAgICBjb25zdCBiYXRjaGVkSW5kZXggPSBiYXRjaGVkSW5kaWNlc1tqXTsKICAgICAgQ29sb3JfZGVmYXVsdC5wYWNrKGJhdGNoZWRJbmRleC5jb2xvciwgcGFja2VkQnVmZmVyLCBvZmZzZXQpOwogICAgICBvZmZzZXQgKz0gQ29sb3JfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgIHBhY2tlZEJ1ZmZlcltvZmZzZXQrK10gPSBiYXRjaGVkSW5kZXgub2Zmc2V0OwogICAgICBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdID0gYmF0Y2hlZEluZGV4LmNvdW50OwogICAgICBjb25zdCBiYXRjaElkcyA9IGJhdGNoZWRJbmRleC5iYXRjaElkczsKICAgICAgY29uc3QgYmF0Y2hJZHNMZW5ndGggPSBiYXRjaElkcy5sZW5ndGg7CiAgICAgIHBhY2tlZEJ1ZmZlcltvZmZzZXQrK10gPSBiYXRjaElkc0xlbmd0aDsKICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBiYXRjaElkc0xlbmd0aDsgKytrKSB7CiAgICAgICAgcGFja2VkQnVmZmVyW29mZnNldCsrXSA9IGJhdGNoSWRzW2tdOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcGFja2VkQnVmZmVyOwogIH0KICBmdW5jdGlvbiBjcmVhdGVWZWN0b3JUaWxlR2VvbWV0cmllcyhwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBjb25zdCBib3hlcyA9IGRlZmluZWRfZGVmYXVsdChwYXJhbWV0ZXJzLmJveGVzKSA/IG5ldyBGbG9hdDMyQXJyYXkocGFyYW1ldGVycy5ib3hlcykgOiB2b2lkIDA7CiAgICBjb25zdCBib3hCYXRjaElkcyA9IGRlZmluZWRfZGVmYXVsdChwYXJhbWV0ZXJzLmJveEJhdGNoSWRzKSA/IG5ldyBVaW50MTZBcnJheShwYXJhbWV0ZXJzLmJveEJhdGNoSWRzKSA6IHZvaWQgMDsKICAgIGNvbnN0IGN5bGluZGVycyA9IGRlZmluZWRfZGVmYXVsdChwYXJhbWV0ZXJzLmN5bGluZGVycykgPyBuZXcgRmxvYXQzMkFycmF5KHBhcmFtZXRlcnMuY3lsaW5kZXJzKSA6IHZvaWQgMDsKICAgIGNvbnN0IGN5bGluZGVyQmF0Y2hJZHMgPSBkZWZpbmVkX2RlZmF1bHQocGFyYW1ldGVycy5jeWxpbmRlckJhdGNoSWRzKSA/IG5ldyBVaW50MTZBcnJheShwYXJhbWV0ZXJzLmN5bGluZGVyQmF0Y2hJZHMpIDogdm9pZCAwOwogICAgY29uc3QgZWxsaXBzb2lkcyA9IGRlZmluZWRfZGVmYXVsdChwYXJhbWV0ZXJzLmVsbGlwc29pZHMpID8gbmV3IEZsb2F0MzJBcnJheShwYXJhbWV0ZXJzLmVsbGlwc29pZHMpIDogdm9pZCAwOwogICAgY29uc3QgZWxsaXBzb2lkQmF0Y2hJZHMgPSBkZWZpbmVkX2RlZmF1bHQocGFyYW1ldGVycy5lbGxpcHNvaWRCYXRjaElkcykgPyBuZXcgVWludDE2QXJyYXkocGFyYW1ldGVycy5lbGxpcHNvaWRCYXRjaElkcykgOiB2b2lkIDA7CiAgICBjb25zdCBzcGhlcmVzID0gZGVmaW5lZF9kZWZhdWx0KHBhcmFtZXRlcnMuc3BoZXJlcykgPyBuZXcgRmxvYXQzMkFycmF5KHBhcmFtZXRlcnMuc3BoZXJlcykgOiB2b2lkIDA7CiAgICBjb25zdCBzcGhlcmVCYXRjaElkcyA9IGRlZmluZWRfZGVmYXVsdChwYXJhbWV0ZXJzLnNwaGVyZUJhdGNoSWRzKSA/IG5ldyBVaW50MTZBcnJheShwYXJhbWV0ZXJzLnNwaGVyZUJhdGNoSWRzKSA6IHZvaWQgMDsKICAgIGNvbnN0IG51bWJlck9mQm94ZXMgPSBkZWZpbmVkX2RlZmF1bHQoYm94ZXMpID8gYm94QmF0Y2hJZHMubGVuZ3RoIDogMDsKICAgIGNvbnN0IG51bWJlck9mQ3lsaW5kZXJzID0gZGVmaW5lZF9kZWZhdWx0KGN5bGluZGVycykgPyBjeWxpbmRlckJhdGNoSWRzLmxlbmd0aCA6IDA7CiAgICBjb25zdCBudW1iZXJPZkVsbGlwc29pZHMgPSBkZWZpbmVkX2RlZmF1bHQoZWxsaXBzb2lkcykgPyBlbGxpcHNvaWRCYXRjaElkcy5sZW5ndGggOiAwOwogICAgY29uc3QgbnVtYmVyT2ZTcGhlcmVzID0gZGVmaW5lZF9kZWZhdWx0KHNwaGVyZXMpID8gc3BoZXJlQmF0Y2hJZHMubGVuZ3RoIDogMDsKICAgIGNvbnN0IGJveEdlb21ldHJ5ID0gQm94R2VvbWV0cnlfZGVmYXVsdC5nZXRVbml0Qm94KCk7CiAgICBjb25zdCBjeWxpbmRlckdlb21ldHJ5ID0gQ3lsaW5kZXJHZW9tZXRyeV9kZWZhdWx0LmdldFVuaXRDeWxpbmRlcigpOwogICAgY29uc3QgZWxsaXBzb2lkR2VvbWV0cnkgPSBFbGxpcHNvaWRHZW9tZXRyeV9kZWZhdWx0LmdldFVuaXRFbGxpcHNvaWQoKTsKICAgIGNvbnN0IGJveFBvc2l0aW9ucyA9IGJveEdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgY29uc3QgY3lsaW5kZXJQb3NpdGlvbnMgPSBjeWxpbmRlckdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgY29uc3QgZWxsaXBzb2lkUG9zaXRpb25zID0gZWxsaXBzb2lkR2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXM7CiAgICBsZXQgbnVtYmVyT2ZQb3NpdGlvbnMgPSBib3hQb3NpdGlvbnMubGVuZ3RoICogbnVtYmVyT2ZCb3hlczsKICAgIG51bWJlck9mUG9zaXRpb25zICs9IGN5bGluZGVyUG9zaXRpb25zLmxlbmd0aCAqIG51bWJlck9mQ3lsaW5kZXJzOwogICAgbnVtYmVyT2ZQb3NpdGlvbnMgKz0gZWxsaXBzb2lkUG9zaXRpb25zLmxlbmd0aCAqIChudW1iZXJPZkVsbGlwc29pZHMgKyBudW1iZXJPZlNwaGVyZXMpOwogICAgY29uc3QgYm94SW5kaWNlcyA9IGJveEdlb21ldHJ5LmluZGljZXM7CiAgICBjb25zdCBjeWxpbmRlckluZGljZXMgPSBjeWxpbmRlckdlb21ldHJ5LmluZGljZXM7CiAgICBjb25zdCBlbGxpcHNvaWRJbmRpY2VzID0gZWxsaXBzb2lkR2VvbWV0cnkuaW5kaWNlczsKICAgIGxldCBudW1iZXJPZkluZGljZXMgPSBib3hJbmRpY2VzLmxlbmd0aCAqIG51bWJlck9mQm94ZXM7CiAgICBudW1iZXJPZkluZGljZXMgKz0gY3lsaW5kZXJJbmRpY2VzLmxlbmd0aCAqIG51bWJlck9mQ3lsaW5kZXJzOwogICAgbnVtYmVyT2ZJbmRpY2VzICs9IGVsbGlwc29pZEluZGljZXMubGVuZ3RoICogKG51bWJlck9mRWxsaXBzb2lkcyArIG51bWJlck9mU3BoZXJlcyk7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgRmxvYXQzMkFycmF5KG51bWJlck9mUG9zaXRpb25zKTsKICAgIGNvbnN0IHZlcnRleEJhdGNoSWRzID0gbmV3IFVpbnQxNkFycmF5KG51bWJlck9mUG9zaXRpb25zIC8gMyk7CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIG51bWJlck9mUG9zaXRpb25zIC8gMywKICAgICAgbnVtYmVyT2ZJbmRpY2VzCiAgICApOwogICAgY29uc3QgbnVtYmVyT2ZHZW9tZXRyaWVzID0gbnVtYmVyT2ZCb3hlcyArIG51bWJlck9mQ3lsaW5kZXJzICsgbnVtYmVyT2ZFbGxpcHNvaWRzICsgbnVtYmVyT2ZTcGhlcmVzOwogICAgY29uc3QgYmF0Y2hJZHMgPSBuZXcgVWludDE2QXJyYXkobnVtYmVyT2ZHZW9tZXRyaWVzKTsKICAgIGNvbnN0IGJhdGNoZWRJbmRpY2VzID0gbmV3IEFycmF5KG51bWJlck9mR2VvbWV0cmllcyk7CiAgICBjb25zdCBpbmRleE9mZnNldHMgPSBuZXcgVWludDMyQXJyYXkobnVtYmVyT2ZHZW9tZXRyaWVzKTsKICAgIGNvbnN0IGluZGV4Q291bnRzID0gbmV3IFVpbnQzMkFycmF5KG51bWJlck9mR2VvbWV0cmllcyk7CiAgICBjb25zdCBib3VuZGluZ1ZvbHVtZXMgPSBuZXcgQXJyYXkobnVtYmVyT2ZHZW9tZXRyaWVzKTsKICAgIHVucGFja0J1ZmZlcihwYXJhbWV0ZXJzLnBhY2tlZEJ1ZmZlcik7CiAgICBjb25zdCBvcHRpb25zID0gewogICAgICBiYXRjaFRhYmxlQ29sb3JzOiBuZXcgVWludDMyQXJyYXkocGFyYW1ldGVycy5iYXRjaFRhYmxlQ29sb3JzKSwKICAgICAgcG9zaXRpb25zLAogICAgICB2ZXJ0ZXhCYXRjaElkcywKICAgICAgaW5kaWNlcywKICAgICAgYmF0Y2hJZHMsCiAgICAgIGJhdGNoZWRJbmRpY2VzLAogICAgICBpbmRleE9mZnNldHMsCiAgICAgIGluZGV4Q291bnRzLAogICAgICBib3VuZGluZ1ZvbHVtZXMsCiAgICAgIHBvc2l0aW9uT2Zmc2V0OiAwLAogICAgICBiYXRjaElkSW5kZXg6IDAsCiAgICAgIGluZGV4T2Zmc2V0OiAwLAogICAgICBiYXRjaGVkSW5kaWNlc09mZnNldDogMCwKICAgICAgbW9kZWxNYXRyaXg6IHNjcmF0Y2hNYXRyaXg0LAogICAgICBjZW50ZXI6IHNjcmF0Y2hDZW50ZXI1CiAgICB9OwogICAgY3JlYXRlUHJpbWl0aXZlKAogICAgICBvcHRpb25zLAogICAgICBib3hlcywKICAgICAgYm94QmF0Y2hJZHMsCiAgICAgIGJveEdlb21ldHJ5LAogICAgICBib3hNb2RlbE1hdHJpeEFuZEJvdW5kaW5nVm9sdW1lCiAgICApOwogICAgY3JlYXRlUHJpbWl0aXZlKAogICAgICBvcHRpb25zLAogICAgICBjeWxpbmRlcnMsCiAgICAgIGN5bGluZGVyQmF0Y2hJZHMsCiAgICAgIGN5bGluZGVyR2VvbWV0cnksCiAgICAgIGN5bGluZGVyTW9kZWxNYXRyaXhBbmRCb3VuZGluZ1ZvbHVtZQogICAgKTsKICAgIGNyZWF0ZVByaW1pdGl2ZSgKICAgICAgb3B0aW9ucywKICAgICAgZWxsaXBzb2lkcywKICAgICAgZWxsaXBzb2lkQmF0Y2hJZHMsCiAgICAgIGVsbGlwc29pZEdlb21ldHJ5LAogICAgICBlbGxpcHNvaWRNb2RlbE1hdHJpeEFuZEJvdW5kaW5nVm9sdW1lCiAgICApOwogICAgY3JlYXRlUHJpbWl0aXZlKAogICAgICBvcHRpb25zLAogICAgICBzcGhlcmVzLAogICAgICBzcGhlcmVCYXRjaElkcywKICAgICAgZWxsaXBzb2lkR2VvbWV0cnksCiAgICAgIHNwaGVyZU1vZGVsTWF0cml4QW5kQm91bmRpbmdWb2x1bWUKICAgICk7CiAgICBjb25zdCBwYWNrZWRCdWZmZXIgPSBwYWNrQnVmZmVyKAogICAgICBpbmRpY2VzLkJZVEVTX1BFUl9FTEVNRU5ULAogICAgICBiYXRjaGVkSW5kaWNlcywKICAgICAgYm91bmRpbmdWb2x1bWVzCiAgICApOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKAogICAgICBwb3NpdGlvbnMuYnVmZmVyLAogICAgICB2ZXJ0ZXhCYXRjaElkcy5idWZmZXIsCiAgICAgIGluZGljZXMuYnVmZmVyCiAgICApOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKAogICAgICBiYXRjaElkcy5idWZmZXIsCiAgICAgIGluZGV4T2Zmc2V0cy5idWZmZXIsCiAgICAgIGluZGV4Q291bnRzLmJ1ZmZlcgogICAgKTsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChwYWNrZWRCdWZmZXIuYnVmZmVyKTsKICAgIHJldHVybiB7CiAgICAgIHBvc2l0aW9uczogcG9zaXRpb25zLmJ1ZmZlciwKICAgICAgdmVydGV4QmF0Y2hJZHM6IHZlcnRleEJhdGNoSWRzLmJ1ZmZlciwKICAgICAgaW5kaWNlczogaW5kaWNlcy5idWZmZXIsCiAgICAgIGluZGV4T2Zmc2V0czogaW5kZXhPZmZzZXRzLmJ1ZmZlciwKICAgICAgaW5kZXhDb3VudHM6IGluZGV4Q291bnRzLmJ1ZmZlciwKICAgICAgYmF0Y2hJZHM6IGJhdGNoSWRzLmJ1ZmZlciwKICAgICAgcGFja2VkQnVmZmVyOiBwYWNrZWRCdWZmZXIuYnVmZmVyCiAgICB9OwogIH0KICB2YXIgc2NyYXRjaENhcnRlc2lhbjExLCBwYWNrZWRCb3hMZW5ndGgsIHBhY2tlZEN5bGluZGVyTGVuZ3RoLCBwYWNrZWRFbGxpcHNvaWRMZW5ndGgsIHBhY2tlZFNwaGVyZUxlbmd0aCwgc2NyYXRjaE1vZGVsTWF0cml4QW5kQlYsIHNjcmF0Y2hQb3NpdGlvbjUsIHNjcmF0Y2hDZW50ZXI1LCBzY3JhdGNoTWF0cml4NCwgY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXNfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVWZWN0b3JUaWxlR2VvbWV0cmllcyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXMuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQm94R2VvbWV0cnkoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ29sb3IoKTsKICAgICAgaW5pdF9DeWxpbmRlckdlb21ldHJ5KCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZEdlb21ldHJ5KCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9WZWN0b3IzRFRpbGVCYXRjaCgpOwogICAgICBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjExID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwYWNrZWRCb3hMZW5ndGggPSBNYXRyaXg0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgcGFja2VkQ3lsaW5kZXJMZW5ndGggPSBNYXRyaXg0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMjsKICAgICAgcGFja2VkRWxsaXBzb2lkTGVuZ3RoID0gTWF0cml4NF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgIHBhY2tlZFNwaGVyZUxlbmd0aCA9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAxOwogICAgICBzY3JhdGNoTW9kZWxNYXRyaXhBbmRCViA9IHsKICAgICAgICBtb2RlbE1hdHJpeDogbmV3IE1hdHJpeDRfZGVmYXVsdCgpLAogICAgICAgIGJvdW5kaW5nVm9sdW1lOiBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgpCiAgICAgIH07CiAgICAgIHNjcmF0Y2hQb3NpdGlvbjUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDZW50ZXI1ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTWF0cml4NCA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXNfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdChjcmVhdGVWZWN0b3JUaWxlR2VvbWV0cmllcyk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVWZWN0b3JUaWxlUG9pbnRzLmpzCiAgdmFyIGNyZWF0ZVZlY3RvclRpbGVQb2ludHNfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZVZlY3RvclRpbGVQb2ludHNfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlVmVjdG9yVGlsZVBvaW50c19kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gdW5wYWNrQnVmZmVyMihwYWNrZWRCdWZmZXIpIHsKICAgIHBhY2tlZEJ1ZmZlciA9IG5ldyBGbG9hdDY0QXJyYXkocGFja2VkQnVmZmVyKTsKICAgIGxldCBvZmZzZXQgPSAwOwogICAgc2NyYXRjaE1pbk1heEhlaWdodHMubWluID0gcGFja2VkQnVmZmVyW29mZnNldCsrXTsKICAgIHNjcmF0Y2hNaW5NYXhIZWlnaHRzLm1heCA9IHBhY2tlZEJ1ZmZlcltvZmZzZXQrK107CiAgICBSZWN0YW5nbGVfZGVmYXVsdC51bnBhY2socGFja2VkQnVmZmVyLCBvZmZzZXQsIHNjcmF0Y2hSZWN0YW5nbGU0KTsKICAgIG9mZnNldCArPSBSZWN0YW5nbGVfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2socGFja2VkQnVmZmVyLCBvZmZzZXQsIHNjcmF0Y2hFbGxpcHNvaWQxNCk7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVZlY3RvclRpbGVQb2ludHMocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3QgcG9zaXRpb25zID0gbmV3IFVpbnQxNkFycmF5KHBhcmFtZXRlcnMucG9zaXRpb25zKTsKICAgIHVucGFja0J1ZmZlcjIocGFyYW1ldGVycy5wYWNrZWRCdWZmZXIpOwogICAgY29uc3QgcmVjdGFuZ2xlID0gc2NyYXRjaFJlY3RhbmdsZTQ7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBzY3JhdGNoRWxsaXBzb2lkMTQ7CiAgICBjb25zdCBtaW5pbXVtSGVpZ2h0ID0gc2NyYXRjaE1pbk1heEhlaWdodHMubWluOwogICAgY29uc3QgbWF4aW11bUhlaWdodCA9IHNjcmF0Y2hNaW5NYXhIZWlnaHRzLm1heDsKICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgY29uc3QgdUJ1ZmZlciA9IHBvc2l0aW9ucy5zdWJhcnJheSgwLCBwb3NpdGlvbnNMZW5ndGgpOwogICAgY29uc3QgdkJ1ZmZlciA9IHBvc2l0aW9ucy5zdWJhcnJheShwb3NpdGlvbnNMZW5ndGgsIDIgKiBwb3NpdGlvbnNMZW5ndGgpOwogICAgY29uc3QgaGVpZ2h0QnVmZmVyID0gcG9zaXRpb25zLnN1YmFycmF5KAogICAgICAyICogcG9zaXRpb25zTGVuZ3RoLAogICAgICAzICogcG9zaXRpb25zTGVuZ3RoCiAgICApOwogICAgQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC56aWdaYWdEZWx0YURlY29kZSh1QnVmZmVyLCB2QnVmZmVyLCBoZWlnaHRCdWZmZXIpOwogICAgY29uc3QgZGVjb2RlZCA9IG5ldyBGbG9hdDY0QXJyYXkocG9zaXRpb25zLmxlbmd0aCk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9uc0xlbmd0aDsgKytpKSB7CiAgICAgIGNvbnN0IHUzID0gdUJ1ZmZlcltpXTsKICAgICAgY29uc3QgdjMgPSB2QnVmZmVyW2ldOwogICAgICBjb25zdCBoID0gaGVpZ2h0QnVmZmVyW2ldOwogICAgICBjb25zdCBsb24gPSBNYXRoX2RlZmF1bHQubGVycChyZWN0YW5nbGUud2VzdCwgcmVjdGFuZ2xlLmVhc3QsIHUzIC8gbWF4U2hvcnQpOwogICAgICBjb25zdCBsYXQgPSBNYXRoX2RlZmF1bHQubGVycChyZWN0YW5nbGUuc291dGgsIHJlY3RhbmdsZS5ub3J0aCwgdjMgLyBtYXhTaG9ydCk7CiAgICAgIGNvbnN0IGFsdCA9IE1hdGhfZGVmYXVsdC5sZXJwKG1pbmltdW1IZWlnaHQsIG1heGltdW1IZWlnaHQsIGggLyBtYXhTaG9ydCk7CiAgICAgIGNvbnN0IGNhcnRvZ3JhcGhpYzIgPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICBsb24sCiAgICAgICAgbGF0LAogICAgICAgIGFsdCwKICAgICAgICBzY3JhdGNoQlZDYXJ0b2dyYXBoaWMyCiAgICAgICk7CiAgICAgIGNvbnN0IGRlY29kZWRQb3NpdGlvbiA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICBjYXJ0b2dyYXBoaWMyLAogICAgICAgIHNjcmF0Y2hFbmNvZGVkUG9zaXRpb24yCiAgICAgICk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGRlY29kZWRQb3NpdGlvbiwgZGVjb2RlZCwgaSAqIDMpOwogICAgfQogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKGRlY29kZWQuYnVmZmVyKTsKICAgIHJldHVybiB7CiAgICAgIHBvc2l0aW9uczogZGVjb2RlZC5idWZmZXIKICAgIH07CiAgfQogIHZhciBtYXhTaG9ydCwgc2NyYXRjaEJWQ2FydG9ncmFwaGljMiwgc2NyYXRjaEVuY29kZWRQb3NpdGlvbjIsIHNjcmF0Y2hSZWN0YW5nbGU0LCBzY3JhdGNoRWxsaXBzb2lkMTQsIHNjcmF0Y2hNaW5NYXhIZWlnaHRzLCBjcmVhdGVWZWN0b3JUaWxlUG9pbnRzX2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlVmVjdG9yVGlsZVBvaW50cyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVmVjdG9yVGlsZVBvaW50cy5qcyIoKSB7CiAgICAgIGluaXRfQXR0cmlidXRlQ29tcHJlc3Npb24oKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKTsKICAgICAgbWF4U2hvcnQgPSAzMjc2NzsKICAgICAgc2NyYXRjaEJWQ2FydG9ncmFwaGljMiA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRW5jb2RlZFBvc2l0aW9uMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFJlY3RhbmdsZTQgPSBuZXcgUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEVsbGlwc29pZDE0ID0gbmV3IEVsbGlwc29pZF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hNaW5NYXhIZWlnaHRzID0gewogICAgICAgIG1pbjogdm9pZCAwLAogICAgICAgIG1heDogdm9pZCAwCiAgICAgIH07CiAgICAgIGNyZWF0ZVZlY3RvclRpbGVQb2ludHNfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdChjcmVhdGVWZWN0b3JUaWxlUG9pbnRzKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVZlY3RvclRpbGVQb2x5Z29ucy5qcwogIHZhciBjcmVhdGVWZWN0b3JUaWxlUG9seWdvbnNfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZVZlY3RvclRpbGVQb2x5Z29uc19leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVWZWN0b3JUaWxlUG9seWdvbnNfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIHVucGFja0J1ZmZlcjMoYnVmZmVyKSB7CiAgICBjb25zdCBwYWNrZWRCdWZmZXIgPSBuZXcgRmxvYXQ2NEFycmF5KGJ1ZmZlcik7CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIHNjcmF0Y2hTY2FsYXJzLmluZGV4Qnl0ZXNQZXJFbGVtZW50ID0gcGFja2VkQnVmZmVyW29mZnNldCsrXTsKICAgIHNjcmF0Y2hTY2FsYXJzLm1pbiA9IHBhY2tlZEJ1ZmZlcltvZmZzZXQrK107CiAgICBzY3JhdGNoU2NhbGFycy5tYXggPSBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhwYWNrZWRCdWZmZXIsIG9mZnNldCwgc2NyYXRjaENlbnRlcjYpOwogICAgb2Zmc2V0ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2socGFja2VkQnVmZmVyLCBvZmZzZXQsIHNjcmF0Y2hFbGxpcHNvaWQxNSk7CiAgICBvZmZzZXQgKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgUmVjdGFuZ2xlX2RlZmF1bHQudW5wYWNrKHBhY2tlZEJ1ZmZlciwgb2Zmc2V0LCBzY3JhdGNoUmVjdGFuZ2xlNSk7CiAgfQogIGZ1bmN0aW9uIHBhY2tlZEJhdGNoZWRJbmRpY2VzTGVuZ3RoMihiYXRjaGVkSW5kaWNlcykgewogICAgY29uc3QgbGVuZ3RoID0gYmF0Y2hlZEluZGljZXMubGVuZ3RoOwogICAgbGV0IGNvdW50ID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgY291bnQgKz0gQ29sb3JfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAzICsgYmF0Y2hlZEluZGljZXNbaV0uYmF0Y2hJZHMubGVuZ3RoOwogICAgfQogICAgcmV0dXJuIGNvdW50OwogIH0KICBmdW5jdGlvbiBwYWNrQnVmZmVyMihpbmRleERhdGF0eXBlLCBib3VuZGluZ1ZvbHVtZXMsIGJhdGNoZWRJbmRpY2VzKSB7CiAgICBjb25zdCBudW1CVnMgPSBib3VuZGluZ1ZvbHVtZXMubGVuZ3RoOwogICAgY29uc3QgbGVuZ3RoID0gMSArIDEgKyBudW1CVnMgKiBPcmllbnRlZEJvdW5kaW5nQm94X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMSArIHBhY2tlZEJhdGNoZWRJbmRpY2VzTGVuZ3RoMihiYXRjaGVkSW5kaWNlcyk7CiAgICBjb25zdCBwYWNrZWRCdWZmZXIgPSBuZXcgRmxvYXQ2NEFycmF5KGxlbmd0aCk7CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIHBhY2tlZEJ1ZmZlcltvZmZzZXQrK10gPSBpbmRleERhdGF0eXBlOwogICAgcGFja2VkQnVmZmVyW29mZnNldCsrXSA9IG51bUJWczsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtQlZzOyArK2kpIHsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveF9kZWZhdWx0LnBhY2soYm91bmRpbmdWb2x1bWVzW2ldLCBwYWNrZWRCdWZmZXIsIG9mZnNldCk7CiAgICAgIG9mZnNldCArPSBPcmllbnRlZEJvdW5kaW5nQm94X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgfQogICAgY29uc3QgaW5kaWNlc0xlbmd0aCA9IGJhdGNoZWRJbmRpY2VzLmxlbmd0aDsKICAgIHBhY2tlZEJ1ZmZlcltvZmZzZXQrK10gPSBpbmRpY2VzTGVuZ3RoOwogICAgZm9yIChsZXQgaiA9IDA7IGogPCBpbmRpY2VzTGVuZ3RoOyArK2opIHsKICAgICAgY29uc3QgYmF0Y2hlZEluZGV4ID0gYmF0Y2hlZEluZGljZXNbal07CiAgICAgIENvbG9yX2RlZmF1bHQucGFjayhiYXRjaGVkSW5kZXguY29sb3IsIHBhY2tlZEJ1ZmZlciwgb2Zmc2V0KTsKICAgICAgb2Zmc2V0ICs9IENvbG9yX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdID0gYmF0Y2hlZEluZGV4Lm9mZnNldDsKICAgICAgcGFja2VkQnVmZmVyW29mZnNldCsrXSA9IGJhdGNoZWRJbmRleC5jb3VudDsKICAgICAgY29uc3QgYmF0Y2hJZHMgPSBiYXRjaGVkSW5kZXguYmF0Y2hJZHM7CiAgICAgIGNvbnN0IGJhdGNoSWRzTGVuZ3RoID0gYmF0Y2hJZHMubGVuZ3RoOwogICAgICBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdID0gYmF0Y2hJZHNMZW5ndGg7CiAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgYmF0Y2hJZHNMZW5ndGg7ICsraykgewogICAgICAgIHBhY2tlZEJ1ZmZlcltvZmZzZXQrK10gPSBiYXRjaElkc1trXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHBhY2tlZEJ1ZmZlcjsKICB9CiAgZnVuY3Rpb24gY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIHVucGFja0J1ZmZlcjMocGFyYW1ldGVycy5wYWNrZWRCdWZmZXIpOwogICAgbGV0IGluZGljZXM7CiAgICBjb25zdCBpbmRleEJ5dGVzUGVyRWxlbWVudCA9IHNjcmF0Y2hTY2FsYXJzLmluZGV4Qnl0ZXNQZXJFbGVtZW50OwogICAgaWYgKGluZGV4Qnl0ZXNQZXJFbGVtZW50ID09PSAyKSB7CiAgICAgIGluZGljZXMgPSBuZXcgVWludDE2QXJyYXkocGFyYW1ldGVycy5pbmRpY2VzKTsKICAgIH0gZWxzZSB7CiAgICAgIGluZGljZXMgPSBuZXcgVWludDMyQXJyYXkocGFyYW1ldGVycy5pbmRpY2VzKTsKICAgIH0KICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBVaW50MTZBcnJheShwYXJhbWV0ZXJzLnBvc2l0aW9ucyk7CiAgICBjb25zdCBjb3VudHMgPSBuZXcgVWludDMyQXJyYXkocGFyYW1ldGVycy5jb3VudHMpOwogICAgY29uc3QgaW5kZXhDb3VudHMgPSBuZXcgVWludDMyQXJyYXkocGFyYW1ldGVycy5pbmRleENvdW50cyk7CiAgICBjb25zdCBiYXRjaElkcyA9IG5ldyBVaW50MzJBcnJheShwYXJhbWV0ZXJzLmJhdGNoSWRzKTsKICAgIGNvbnN0IGJhdGNoVGFibGVDb2xvcnMgPSBuZXcgVWludDMyQXJyYXkocGFyYW1ldGVycy5iYXRjaFRhYmxlQ29sb3JzKTsKICAgIGNvbnN0IGJvdW5kaW5nVm9sdW1lcyA9IG5ldyBBcnJheShjb3VudHMubGVuZ3RoKTsKICAgIGNvbnN0IGNlbnRlciA9IHNjcmF0Y2hDZW50ZXI2OwogICAgY29uc3QgZWxsaXBzb2lkID0gc2NyYXRjaEVsbGlwc29pZDE1OwogICAgbGV0IHJlY3RhbmdsZSA9IHNjcmF0Y2hSZWN0YW5nbGU1OwogICAgY29uc3QgbWluSGVpZ2h0ID0gc2NyYXRjaFNjYWxhcnMubWluOwogICAgY29uc3QgbWF4SGVpZ2h0ID0gc2NyYXRjaFNjYWxhcnMubWF4OwogICAgbGV0IG1pbmltdW1IZWlnaHRzID0gcGFyYW1ldGVycy5taW5pbXVtSGVpZ2h0czsKICAgIGxldCBtYXhpbXVtSGVpZ2h0cyA9IHBhcmFtZXRlcnMubWF4aW11bUhlaWdodHM7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1IZWlnaHRzKSAmJiBkZWZpbmVkX2RlZmF1bHQobWF4aW11bUhlaWdodHMpKSB7CiAgICAgIG1pbmltdW1IZWlnaHRzID0gbmV3IEZsb2F0MzJBcnJheShtaW5pbXVtSGVpZ2h0cyk7CiAgICAgIG1heGltdW1IZWlnaHRzID0gbmV3IEZsb2F0MzJBcnJheShtYXhpbXVtSGVpZ2h0cyk7CiAgICB9CiAgICBsZXQgaTsKICAgIGxldCBqOwogICAgbGV0IHJnYmE7CiAgICBjb25zdCBwb3NpdGlvbnNMZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoIC8gMjsKICAgIGNvbnN0IHVCdWZmZXIgPSBwb3NpdGlvbnMuc3ViYXJyYXkoMCwgcG9zaXRpb25zTGVuZ3RoKTsKICAgIGNvbnN0IHZCdWZmZXIgPSBwb3NpdGlvbnMuc3ViYXJyYXkocG9zaXRpb25zTGVuZ3RoLCAyICogcG9zaXRpb25zTGVuZ3RoKTsKICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQuemlnWmFnRGVsdGFEZWNvZGUodUJ1ZmZlciwgdkJ1ZmZlcik7CiAgICBjb25zdCBkZWNvZGVkUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShwb3NpdGlvbnNMZW5ndGggKiAzKTsKICAgIGZvciAoaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGg7ICsraSkgewogICAgICBjb25zdCB1MyA9IHVCdWZmZXJbaV07CiAgICAgIGNvbnN0IHYzID0gdkJ1ZmZlcltpXTsKICAgICAgY29uc3QgeCA9IE1hdGhfZGVmYXVsdC5sZXJwKHJlY3RhbmdsZS53ZXN0LCByZWN0YW5nbGUuZWFzdCwgdTMgLyBtYXhTaG9ydDIpOwogICAgICBjb25zdCB5ID0gTWF0aF9kZWZhdWx0LmxlcnAocmVjdGFuZ2xlLnNvdXRoLCByZWN0YW5nbGUubm9ydGgsIHYzIC8gbWF4U2hvcnQyKTsKICAgICAgY29uc3QgY2FydCA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmZyb21SYWRpYW5zKHgsIHksIDAsIHNjcmF0Y2hCVkNhcnRvZ3JhcGhpYzMpOwogICAgICBjb25zdCBkZWNvZGVkUG9zaXRpb24gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgY2FydCwKICAgICAgICBzY3JhdGNoRW5jb2RlZFBvc2l0aW9uMwogICAgICApOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhkZWNvZGVkUG9zaXRpb24sIGRlY29kZWRQb3NpdGlvbnMsIGkgKiAzKTsKICAgIH0KICAgIGNvbnN0IGNvdW50c0xlbmd0aCA9IGNvdW50cy5sZW5ndGg7CiAgICBjb25zdCBvZmZzZXRzID0gbmV3IEFycmF5KGNvdW50c0xlbmd0aCk7CiAgICBjb25zdCBpbmRleE9mZnNldHMgPSBuZXcgQXJyYXkoY291bnRzTGVuZ3RoKTsKICAgIGxldCBjdXJyZW50T2Zmc2V0ID0gMDsKICAgIGxldCBjdXJyZW50SW5kZXhPZmZzZXQgPSAwOwogICAgZm9yIChpID0gMDsgaSA8IGNvdW50c0xlbmd0aDsgKytpKSB7CiAgICAgIG9mZnNldHNbaV0gPSBjdXJyZW50T2Zmc2V0OwogICAgICBpbmRleE9mZnNldHNbaV0gPSBjdXJyZW50SW5kZXhPZmZzZXQ7CiAgICAgIGN1cnJlbnRPZmZzZXQgKz0gY291bnRzW2ldOwogICAgICBjdXJyZW50SW5kZXhPZmZzZXQgKz0gaW5kZXhDb3VudHNbaV07CiAgICB9CiAgICBjb25zdCBiYXRjaGVkUG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShwb3NpdGlvbnNMZW5ndGggKiAzICogMik7CiAgICBjb25zdCBiYXRjaGVkSWRzID0gbmV3IFVpbnQxNkFycmF5KHBvc2l0aW9uc0xlbmd0aCAqIDIpOwogICAgY29uc3QgYmF0Y2hlZEluZGV4T2Zmc2V0cyA9IG5ldyBVaW50MzJBcnJheShpbmRleE9mZnNldHMubGVuZ3RoKTsKICAgIGNvbnN0IGJhdGNoZWRJbmRleENvdW50cyA9IG5ldyBVaW50MzJBcnJheShpbmRleENvdW50cy5sZW5ndGgpOwogICAgbGV0IGJhdGNoZWRJbmRpY2VzID0gW107CiAgICBjb25zdCBjb2xvclRvQnVmZmVycyA9IHt9OwogICAgZm9yIChpID0gMDsgaSA8IGNvdW50c0xlbmd0aDsgKytpKSB7CiAgICAgIHJnYmEgPSBiYXRjaFRhYmxlQ29sb3JzW2ldOwogICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjb2xvclRvQnVmZmVyc1tyZ2JhXSkpIHsKICAgICAgICBjb2xvclRvQnVmZmVyc1tyZ2JhXSA9IHsKICAgICAgICAgIHBvc2l0aW9uTGVuZ3RoOiBjb3VudHNbaV0sCiAgICAgICAgICBpbmRleExlbmd0aDogaW5kZXhDb3VudHNbaV0sCiAgICAgICAgICBvZmZzZXQ6IDAsCiAgICAgICAgICBpbmRleE9mZnNldDogMCwKICAgICAgICAgIGJhdGNoSWRzOiBbaV0KICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIGNvbG9yVG9CdWZmZXJzW3JnYmFdLnBvc2l0aW9uTGVuZ3RoICs9IGNvdW50c1tpXTsKICAgICAgICBjb2xvclRvQnVmZmVyc1tyZ2JhXS5pbmRleExlbmd0aCArPSBpbmRleENvdW50c1tpXTsKICAgICAgICBjb2xvclRvQnVmZmVyc1tyZ2JhXS5iYXRjaElkcy5wdXNoKGkpOwogICAgICB9CiAgICB9CiAgICBsZXQgYnVmZmVyOwogICAgbGV0IGJ5Q29sb3JQb3NpdGlvbk9mZnNldCA9IDA7CiAgICBsZXQgYnlDb2xvckluZGV4T2Zmc2V0ID0gMDsKICAgIGZvciAocmdiYSBpbiBjb2xvclRvQnVmZmVycykgewogICAgICBpZiAoY29sb3JUb0J1ZmZlcnMuaGFzT3duUHJvcGVydHkocmdiYSkpIHsKICAgICAgICBidWZmZXIgPSBjb2xvclRvQnVmZmVyc1tyZ2JhXTsKICAgICAgICBidWZmZXIub2Zmc2V0ID0gYnlDb2xvclBvc2l0aW9uT2Zmc2V0OwogICAgICAgIGJ1ZmZlci5pbmRleE9mZnNldCA9IGJ5Q29sb3JJbmRleE9mZnNldDsKICAgICAgICBjb25zdCBwb3NpdGlvbkxlbmd0aCA9IGJ1ZmZlci5wb3NpdGlvbkxlbmd0aCAqIDI7CiAgICAgICAgY29uc3QgaW5kZXhMZW5ndGggPSBidWZmZXIuaW5kZXhMZW5ndGggKiAyICsgYnVmZmVyLnBvc2l0aW9uTGVuZ3RoICogNjsKICAgICAgICBieUNvbG9yUG9zaXRpb25PZmZzZXQgKz0gcG9zaXRpb25MZW5ndGg7CiAgICAgICAgYnlDb2xvckluZGV4T2Zmc2V0ICs9IGluZGV4TGVuZ3RoOwogICAgICAgIGJ1ZmZlci5pbmRleExlbmd0aCA9IGluZGV4TGVuZ3RoOwogICAgICB9CiAgICB9CiAgICBjb25zdCBiYXRjaGVkRHJhd0NhbGxzID0gW107CiAgICBmb3IgKHJnYmEgaW4gY29sb3JUb0J1ZmZlcnMpIHsKICAgICAgaWYgKGNvbG9yVG9CdWZmZXJzLmhhc093blByb3BlcnR5KHJnYmEpKSB7CiAgICAgICAgYnVmZmVyID0gY29sb3JUb0J1ZmZlcnNbcmdiYV07CiAgICAgICAgYmF0Y2hlZERyYXdDYWxscy5wdXNoKHsKICAgICAgICAgIGNvbG9yOiBDb2xvcl9kZWZhdWx0LmZyb21SZ2JhKHBhcnNlSW50KHJnYmEpKSwKICAgICAgICAgIG9mZnNldDogYnVmZmVyLmluZGV4T2Zmc2V0LAogICAgICAgICAgY291bnQ6IGJ1ZmZlci5pbmRleExlbmd0aCwKICAgICAgICAgIGJhdGNoSWRzOiBidWZmZXIuYmF0Y2hJZHMKICAgICAgICB9KTsKICAgICAgfQogICAgfQogICAgZm9yIChpID0gMDsgaSA8IGNvdW50c0xlbmd0aDsgKytpKSB7CiAgICAgIHJnYmEgPSBiYXRjaFRhYmxlQ29sb3JzW2ldOwogICAgICBidWZmZXIgPSBjb2xvclRvQnVmZmVyc1tyZ2JhXTsKICAgICAgY29uc3QgcG9zaXRpb25PZmZzZXQgPSBidWZmZXIub2Zmc2V0OwogICAgICBsZXQgcG9zaXRpb25JbmRleCA9IHBvc2l0aW9uT2Zmc2V0ICogMzsKICAgICAgbGV0IGJhdGNoSWRJbmRleCA9IHBvc2l0aW9uT2Zmc2V0OwogICAgICBjb25zdCBwb2x5Z29uT2Zmc2V0ID0gb2Zmc2V0c1tpXTsKICAgICAgY29uc3QgcG9seWdvbkNvdW50ID0gY291bnRzW2ldOwogICAgICBjb25zdCBiYXRjaElkID0gYmF0Y2hJZHNbaV07CiAgICAgIGxldCBwb2x5Z29uTWluaW11bUhlaWdodCA9IG1pbkhlaWdodDsKICAgICAgbGV0IHBvbHlnb25NYXhpbXVtSGVpZ2h0ID0gbWF4SGVpZ2h0OwogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1IZWlnaHRzKSAmJiBkZWZpbmVkX2RlZmF1bHQobWF4aW11bUhlaWdodHMpKSB7CiAgICAgICAgcG9seWdvbk1pbmltdW1IZWlnaHQgPSBtaW5pbXVtSGVpZ2h0c1tpXTsKICAgICAgICBwb2x5Z29uTWF4aW11bUhlaWdodCA9IG1heGltdW1IZWlnaHRzW2ldOwogICAgICB9CiAgICAgIGxldCBtaW5MYXQgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgIGxldCBtYXhMYXQgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgIGxldCBtaW5Mb24gPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgIGxldCBtYXhMb24gPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgIGZvciAoaiA9IDA7IGogPCBwb2x5Z29uQ291bnQ7ICsraikgewogICAgICAgIGNvbnN0IHBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGRlY29kZWRQb3NpdGlvbnMsCiAgICAgICAgICBwb2x5Z29uT2Zmc2V0ICogMyArIGogKiAzLAogICAgICAgICAgc2NyYXRjaEVuY29kZWRQb3NpdGlvbjMKICAgICAgICApOwogICAgICAgIGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKHBvc2l0aW9uLCBwb3NpdGlvbik7CiAgICAgICAgY29uc3QgY2FydG8gPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgIHNjcmF0Y2hCVkNhcnRvZ3JhcGhpYzMKICAgICAgICApOwogICAgICAgIGNvbnN0IGxhdCA9IGNhcnRvLmxhdGl0dWRlOwogICAgICAgIGNvbnN0IGxvbiA9IGNhcnRvLmxvbmdpdHVkZTsKICAgICAgICBtaW5MYXQgPSBNYXRoLm1pbihsYXQsIG1pbkxhdCk7CiAgICAgICAgbWF4TGF0ID0gTWF0aC5tYXgobGF0LCBtYXhMYXQpOwogICAgICAgIG1pbkxvbiA9IE1hdGgubWluKGxvbiwgbWluTG9uKTsKICAgICAgICBtYXhMb24gPSBNYXRoLm1heChsb24sIG1heExvbik7CiAgICAgICAgY29uc3Qgbm9ybWFsMiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24sIHNjcmF0Y2hOb3JtYWw3KTsKICAgICAgICBsZXQgc2NhbGVkTm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICBub3JtYWwyLAogICAgICAgICAgcG9seWdvbk1pbmltdW1IZWlnaHQsCiAgICAgICAgICBzY3JhdGNoU2NhbGVkTm9ybWFsCiAgICAgICAgKTsKICAgICAgICBjb25zdCBtaW5IZWlnaHRQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgIHNjYWxlZE5vcm1hbCwKICAgICAgICAgIHNjcmF0Y2hNaW5IZWlnaHRQb3NpdGlvbgogICAgICAgICk7CiAgICAgICAgc2NhbGVkTm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICBub3JtYWwyLAogICAgICAgICAgcG9seWdvbk1heGltdW1IZWlnaHQsCiAgICAgICAgICBzY2FsZWROb3JtYWwKICAgICAgICApOwogICAgICAgIGNvbnN0IG1heEhlaWdodFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgc2NhbGVkTm9ybWFsLAogICAgICAgICAgc2NyYXRjaE1heEhlaWdodFBvc2l0aW9uCiAgICAgICAgKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QobWF4SGVpZ2h0UG9zaXRpb24sIGNlbnRlciwgbWF4SGVpZ2h0UG9zaXRpb24pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChtaW5IZWlnaHRQb3NpdGlvbiwgY2VudGVyLCBtaW5IZWlnaHRQb3NpdGlvbik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sobWF4SGVpZ2h0UG9zaXRpb24sIGJhdGNoZWRQb3NpdGlvbnMsIHBvc2l0aW9uSW5kZXgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKG1pbkhlaWdodFBvc2l0aW9uLCBiYXRjaGVkUG9zaXRpb25zLCBwb3NpdGlvbkluZGV4ICsgMyk7CiAgICAgICAgYmF0Y2hlZElkc1tiYXRjaElkSW5kZXhdID0gYmF0Y2hJZDsKICAgICAgICBiYXRjaGVkSWRzW2JhdGNoSWRJbmRleCArIDFdID0gYmF0Y2hJZDsKICAgICAgICBwb3NpdGlvbkluZGV4ICs9IDY7CiAgICAgICAgYmF0Y2hJZEluZGV4ICs9IDI7CiAgICAgIH0KICAgICAgcmVjdGFuZ2xlID0gc2NyYXRjaEJWUmVjdGFuZ2xlOwogICAgICByZWN0YW5nbGUud2VzdCA9IG1pbkxvbjsKICAgICAgcmVjdGFuZ2xlLmVhc3QgPSBtYXhMb247CiAgICAgIHJlY3RhbmdsZS5zb3V0aCA9IG1pbkxhdDsKICAgICAgcmVjdGFuZ2xlLm5vcnRoID0gbWF4TGF0OwogICAgICBib3VuZGluZ1ZvbHVtZXNbaV0gPSBPcmllbnRlZEJvdW5kaW5nQm94X2RlZmF1bHQuZnJvbVJlY3RhbmdsZSgKICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgbWluSGVpZ2h0LAogICAgICAgIG1heEhlaWdodCwKICAgICAgICBlbGxpcHNvaWQKICAgICAgKTsKICAgICAgbGV0IGluZGljZXNJbmRleCA9IGJ1ZmZlci5pbmRleE9mZnNldDsKICAgICAgY29uc3QgaW5kZXhPZmZzZXQgPSBpbmRleE9mZnNldHNbaV07CiAgICAgIGNvbnN0IGluZGV4Q291bnQgPSBpbmRleENvdW50c1tpXTsKICAgICAgYmF0Y2hlZEluZGV4T2Zmc2V0c1tpXSA9IGluZGljZXNJbmRleDsKICAgICAgZm9yIChqID0gMDsgaiA8IGluZGV4Q291bnQ7IGogKz0gMykgewogICAgICAgIGNvbnN0IGkwID0gaW5kaWNlc1tpbmRleE9mZnNldCArIGpdIC0gcG9seWdvbk9mZnNldDsKICAgICAgICBjb25zdCBpMSA9IGluZGljZXNbaW5kZXhPZmZzZXQgKyBqICsgMV0gLSBwb2x5Z29uT2Zmc2V0OwogICAgICAgIGNvbnN0IGkyID0gaW5kaWNlc1tpbmRleE9mZnNldCArIGogKyAyXSAtIHBvbHlnb25PZmZzZXQ7CiAgICAgICAgYmF0Y2hlZEluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaTAgKiAyICsgcG9zaXRpb25PZmZzZXQ7CiAgICAgICAgYmF0Y2hlZEluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaTEgKiAyICsgcG9zaXRpb25PZmZzZXQ7CiAgICAgICAgYmF0Y2hlZEluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaTIgKiAyICsgcG9zaXRpb25PZmZzZXQ7CiAgICAgICAgYmF0Y2hlZEluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaTIgKiAyICsgMSArIHBvc2l0aW9uT2Zmc2V0OwogICAgICAgIGJhdGNoZWRJbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGkxICogMiArIDEgKyBwb3NpdGlvbk9mZnNldDsKICAgICAgICBiYXRjaGVkSW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpMCAqIDIgKyAxICsgcG9zaXRpb25PZmZzZXQ7CiAgICAgIH0KICAgICAgZm9yIChqID0gMDsgaiA8IHBvbHlnb25Db3VudDsgKytqKSB7CiAgICAgICAgY29uc3QgdjAyID0gajsKICAgICAgICBjb25zdCB2MTIgPSAoaiArIDEpICUgcG9seWdvbkNvdW50OwogICAgICAgIGJhdGNoZWRJbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHYwMiAqIDIgKyAxICsgcG9zaXRpb25PZmZzZXQ7CiAgICAgICAgYmF0Y2hlZEluZGljZXNbaW5kaWNlc0luZGV4KytdID0gdjEyICogMiArIHBvc2l0aW9uT2Zmc2V0OwogICAgICAgIGJhdGNoZWRJbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHYwMiAqIDIgKyBwb3NpdGlvbk9mZnNldDsKICAgICAgICBiYXRjaGVkSW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSB2MDIgKiAyICsgMSArIHBvc2l0aW9uT2Zmc2V0OwogICAgICAgIGJhdGNoZWRJbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHYxMiAqIDIgKyAxICsgcG9zaXRpb25PZmZzZXQ7CiAgICAgICAgYmF0Y2hlZEluZGljZXNbaW5kaWNlc0luZGV4KytdID0gdjEyICogMiArIHBvc2l0aW9uT2Zmc2V0OwogICAgICB9CiAgICAgIGJ1ZmZlci5vZmZzZXQgKz0gcG9seWdvbkNvdW50ICogMjsKICAgICAgYnVmZmVyLmluZGV4T2Zmc2V0ID0gaW5kaWNlc0luZGV4OwogICAgICBiYXRjaGVkSW5kZXhDb3VudHNbaV0gPSBpbmRpY2VzSW5kZXggLSBiYXRjaGVkSW5kZXhPZmZzZXRzW2ldOwogICAgfQogICAgYmF0Y2hlZEluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgYmF0Y2hlZFBvc2l0aW9ucy5sZW5ndGggLyAzLAogICAgICBiYXRjaGVkSW5kaWNlcwogICAgKTsKICAgIGNvbnN0IGJhdGNoZWRJbmRpY2VzTGVuZ3RoID0gYmF0Y2hlZERyYXdDYWxscy5sZW5ndGg7CiAgICBmb3IgKGxldCBtID0gMDsgbSA8IGJhdGNoZWRJbmRpY2VzTGVuZ3RoOyArK20pIHsKICAgICAgY29uc3QgdGVtcElkcyA9IGJhdGNoZWREcmF3Q2FsbHNbbV0uYmF0Y2hJZHM7CiAgICAgIGxldCBjb3VudCA9IDA7CiAgICAgIGNvbnN0IHRlbXBJZHNMZW5ndGggPSB0ZW1wSWRzLmxlbmd0aDsKICAgICAgZm9yIChsZXQgbiA9IDA7IG4gPCB0ZW1wSWRzTGVuZ3RoOyArK24pIHsKICAgICAgICBjb3VudCArPSBiYXRjaGVkSW5kZXhDb3VudHNbdGVtcElkc1tuXV07CiAgICAgIH0KICAgICAgYmF0Y2hlZERyYXdDYWxsc1ttXS5jb3VudCA9IGNvdW50OwogICAgfQogICAgY29uc3QgaW5kZXhEYXRhdHlwZSA9IGJhdGNoZWRJbmRpY2VzLkJZVEVTX1BFUl9FTEVNRU5UID09PSAyID8gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX1NIT1JUIDogSW5kZXhEYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0lOVDsKICAgIGNvbnN0IHBhY2tlZEJ1ZmZlciA9IHBhY2tCdWZmZXIyKAogICAgICBpbmRleERhdGF0eXBlLAogICAgICBib3VuZGluZ1ZvbHVtZXMsCiAgICAgIGJhdGNoZWREcmF3Q2FsbHMKICAgICk7CiAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2goCiAgICAgIGJhdGNoZWRQb3NpdGlvbnMuYnVmZmVyLAogICAgICBiYXRjaGVkSW5kaWNlcy5idWZmZXIsCiAgICAgIGJhdGNoZWRJbmRleE9mZnNldHMuYnVmZmVyLAogICAgICBiYXRjaGVkSW5kZXhDb3VudHMuYnVmZmVyLAogICAgICBiYXRjaGVkSWRzLmJ1ZmZlciwKICAgICAgcGFja2VkQnVmZmVyLmJ1ZmZlcgogICAgKTsKICAgIHJldHVybiB7CiAgICAgIHBvc2l0aW9uczogYmF0Y2hlZFBvc2l0aW9ucy5idWZmZXIsCiAgICAgIGluZGljZXM6IGJhdGNoZWRJbmRpY2VzLmJ1ZmZlciwKICAgICAgaW5kZXhPZmZzZXRzOiBiYXRjaGVkSW5kZXhPZmZzZXRzLmJ1ZmZlciwKICAgICAgaW5kZXhDb3VudHM6IGJhdGNoZWRJbmRleENvdW50cy5idWZmZXIsCiAgICAgIGJhdGNoSWRzOiBiYXRjaGVkSWRzLmJ1ZmZlciwKICAgICAgcGFja2VkQnVmZmVyOiBwYWNrZWRCdWZmZXIuYnVmZmVyCiAgICB9OwogIH0KICB2YXIgc2NyYXRjaENlbnRlcjYsIHNjcmF0Y2hFbGxpcHNvaWQxNSwgc2NyYXRjaFJlY3RhbmdsZTUsIHNjcmF0Y2hTY2FsYXJzLCBtYXhTaG9ydDIsIHNjcmF0Y2hFbmNvZGVkUG9zaXRpb24zLCBzY3JhdGNoTm9ybWFsNywgc2NyYXRjaFNjYWxlZE5vcm1hbCwgc2NyYXRjaE1pbkhlaWdodFBvc2l0aW9uLCBzY3JhdGNoTWF4SGVpZ2h0UG9zaXRpb24sIHNjcmF0Y2hCVkNhcnRvZ3JhcGhpYzMsIHNjcmF0Y2hCVlJlY3RhbmdsZSwgY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zX2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVWZWN0b3JUaWxlUG9seWdvbnMuanMiKCkgewogICAgICBpbml0X0F0dHJpYnV0ZUNvbXByZXNzaW9uKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NvbG9yKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfT3JpZW50ZWRCb3VuZGluZ0JveCgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKTsKICAgICAgc2NyYXRjaENlbnRlcjYgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQxNSA9IG5ldyBFbGxpcHNvaWRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUmVjdGFuZ2xlNSA9IG5ldyBSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoU2NhbGFycyA9IHsKICAgICAgICBtaW46IHZvaWQgMCwKICAgICAgICBtYXg6IHZvaWQgMCwKICAgICAgICBpbmRleEJ5dGVzUGVyRWxlbWVudDogdm9pZCAwCiAgICAgIH07CiAgICAgIG1heFNob3J0MiA9IDMyNzY3OwogICAgICBzY3JhdGNoRW5jb2RlZFBvc2l0aW9uMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE5vcm1hbDcgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hTY2FsZWROb3JtYWwgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hNaW5IZWlnaHRQb3NpdGlvbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE1heEhlaWdodFBvc2l0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQlZDYXJ0b2dyYXBoaWMzID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hCVlJlY3RhbmdsZSA9IG5ldyBSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgICBjcmVhdGVWZWN0b3JUaWxlUG9seWdvbnNfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdChjcmVhdGVWZWN0b3JUaWxlUG9seWdvbnMpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvZGVjb2RlVmVjdG9yUG9seWxpbmVQb3NpdGlvbnMuanMKICBmdW5jdGlvbiBkZWNvZGVWZWN0b3JQb2x5bGluZVBvc2l0aW9ucyhwb3NpdGlvbnMsIHJlY3RhbmdsZSwgbWluaW11bUhlaWdodCwgbWF4aW11bUhlaWdodCwgZWxsaXBzb2lkKSB7CiAgICBjb25zdCBwb3NpdGlvbnNMZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgIGNvbnN0IHVCdWZmZXIgPSBwb3NpdGlvbnMuc3ViYXJyYXkoMCwgcG9zaXRpb25zTGVuZ3RoKTsKICAgIGNvbnN0IHZCdWZmZXIgPSBwb3NpdGlvbnMuc3ViYXJyYXkocG9zaXRpb25zTGVuZ3RoLCAyICogcG9zaXRpb25zTGVuZ3RoKTsKICAgIGNvbnN0IGhlaWdodEJ1ZmZlciA9IHBvc2l0aW9ucy5zdWJhcnJheSgKICAgICAgMiAqIHBvc2l0aW9uc0xlbmd0aCwKICAgICAgMyAqIHBvc2l0aW9uc0xlbmd0aAogICAgKTsKICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQuemlnWmFnRGVsdGFEZWNvZGUodUJ1ZmZlciwgdkJ1ZmZlciwgaGVpZ2h0QnVmZmVyKTsKICAgIGNvbnN0IGRlY29kZWQgPSBuZXcgRmxvYXQ2NEFycmF5KHBvc2l0aW9ucy5sZW5ndGgpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGg7ICsraSkgewogICAgICBjb25zdCB1MyA9IHVCdWZmZXJbaV07CiAgICAgIGNvbnN0IHYzID0gdkJ1ZmZlcltpXTsKICAgICAgY29uc3QgaCA9IGhlaWdodEJ1ZmZlcltpXTsKICAgICAgY29uc3QgbG9uID0gTWF0aF9kZWZhdWx0LmxlcnAocmVjdGFuZ2xlLndlc3QsIHJlY3RhbmdsZS5lYXN0LCB1MyAvIG1heFNob3J0Myk7CiAgICAgIGNvbnN0IGxhdCA9IE1hdGhfZGVmYXVsdC5sZXJwKHJlY3RhbmdsZS5zb3V0aCwgcmVjdGFuZ2xlLm5vcnRoLCB2MyAvIG1heFNob3J0Myk7CiAgICAgIGNvbnN0IGFsdCA9IE1hdGhfZGVmYXVsdC5sZXJwKG1pbmltdW1IZWlnaHQsIG1heGltdW1IZWlnaHQsIGggLyBtYXhTaG9ydDMpOwogICAgICBjb25zdCBjYXJ0b2dyYXBoaWMyID0gQ2FydG9ncmFwaGljX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgICAgbG9uLAogICAgICAgIGxhdCwKICAgICAgICBhbHQsCiAgICAgICAgc2NyYXRjaEJWQ2FydG9ncmFwaGljNAogICAgICApOwogICAgICBjb25zdCBkZWNvZGVkUG9zaXRpb24gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgY2FydG9ncmFwaGljMiwKICAgICAgICBzY3JhdGNoRW5jb2RlZFBvc2l0aW9uNAogICAgICApOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhkZWNvZGVkUG9zaXRpb24sIGRlY29kZWQsIGkgKiAzKTsKICAgIH0KICAgIHJldHVybiBkZWNvZGVkOwogIH0KICB2YXIgbWF4U2hvcnQzLCBzY3JhdGNoQlZDYXJ0b2dyYXBoaWM0LCBzY3JhdGNoRW5jb2RlZFBvc2l0aW9uNCwgZGVjb2RlVmVjdG9yUG9seWxpbmVQb3NpdGlvbnNfZGVmYXVsdDsKICB2YXIgaW5pdF9kZWNvZGVWZWN0b3JQb2x5bGluZVBvc2l0aW9ucyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvZGVjb2RlVmVjdG9yUG9seWxpbmVQb3NpdGlvbnMuanMiKCkgewogICAgICBpbml0X0F0dHJpYnV0ZUNvbXByZXNzaW9uKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgbWF4U2hvcnQzID0gMzI3Njc7CiAgICAgIHNjcmF0Y2hCVkNhcnRvZ3JhcGhpYzQgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEVuY29kZWRQb3NpdGlvbjQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGRlY29kZVZlY3RvclBvbHlsaW5lUG9zaXRpb25zX2RlZmF1bHQgPSBkZWNvZGVWZWN0b3JQb2x5bGluZVBvc2l0aW9uczsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVZlY3RvclRpbGVQb2x5bGluZXMuanMKICB2YXIgY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lc19leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lc19leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzX2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiB1bnBhY2tCdWZmZXI0KHBhY2tlZEJ1ZmZlcikgewogICAgcGFja2VkQnVmZmVyID0gbmV3IEZsb2F0NjRBcnJheShwYWNrZWRCdWZmZXIpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBzY3JhdGNoTWluTWF4SGVpZ2h0czIubWluID0gcGFja2VkQnVmZmVyW29mZnNldCsrXTsKICAgIHNjcmF0Y2hNaW5NYXhIZWlnaHRzMi5tYXggPSBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdOwogICAgUmVjdGFuZ2xlX2RlZmF1bHQudW5wYWNrKHBhY2tlZEJ1ZmZlciwgb2Zmc2V0LCBzY3JhdGNoUmVjdGFuZ2xlNik7CiAgICBvZmZzZXQgKz0gUmVjdGFuZ2xlX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKHBhY2tlZEJ1ZmZlciwgb2Zmc2V0LCBzY3JhdGNoRWxsaXBzb2lkMTYpOwogICAgb2Zmc2V0ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2socGFja2VkQnVmZmVyLCBvZmZzZXQsIHNjcmF0Y2hDZW50ZXI3KTsKICB9CiAgZnVuY3Rpb24gZ2V0UG9zaXRpb25PZmZzZXRzMihjb3VudHMpIHsKICAgIGNvbnN0IGNvdW50c0xlbmd0aCA9IGNvdW50cy5sZW5ndGg7CiAgICBjb25zdCBwb3NpdGlvbk9mZnNldHMgPSBuZXcgVWludDMyQXJyYXkoY291bnRzTGVuZ3RoICsgMSk7CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnRzTGVuZ3RoOyArK2kpIHsKICAgICAgcG9zaXRpb25PZmZzZXRzW2ldID0gb2Zmc2V0OwogICAgICBvZmZzZXQgKz0gY291bnRzW2ldOwogICAgfQogICAgcG9zaXRpb25PZmZzZXRzW2NvdW50c0xlbmd0aF0gPSBvZmZzZXQ7CiAgICByZXR1cm4gcG9zaXRpb25PZmZzZXRzOwogIH0KICBmdW5jdGlvbiBjcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IGVuY29kZWRQb3NpdGlvbnMgPSBuZXcgVWludDE2QXJyYXkocGFyYW1ldGVycy5wb3NpdGlvbnMpOwogICAgY29uc3Qgd2lkdGhzID0gbmV3IFVpbnQxNkFycmF5KHBhcmFtZXRlcnMud2lkdGhzKTsKICAgIGNvbnN0IGNvdW50cyA9IG5ldyBVaW50MzJBcnJheShwYXJhbWV0ZXJzLmNvdW50cyk7CiAgICBjb25zdCBiYXRjaElkcyA9IG5ldyBVaW50MTZBcnJheShwYXJhbWV0ZXJzLmJhdGNoSWRzKTsKICAgIHVucGFja0J1ZmZlcjQocGFyYW1ldGVycy5wYWNrZWRCdWZmZXIpOwogICAgY29uc3QgcmVjdGFuZ2xlID0gc2NyYXRjaFJlY3RhbmdsZTY7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBzY3JhdGNoRWxsaXBzb2lkMTY7CiAgICBjb25zdCBjZW50ZXIgPSBzY3JhdGNoQ2VudGVyNzsKICAgIGNvbnN0IG1pbmltdW1IZWlnaHQgPSBzY3JhdGNoTWluTWF4SGVpZ2h0czIubWluOwogICAgY29uc3QgbWF4aW11bUhlaWdodCA9IHNjcmF0Y2hNaW5NYXhIZWlnaHRzMi5tYXg7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBkZWNvZGVWZWN0b3JQb2x5bGluZVBvc2l0aW9uc19kZWZhdWx0KAogICAgICBlbmNvZGVkUG9zaXRpb25zLAogICAgICByZWN0YW5nbGUsCiAgICAgIG1pbmltdW1IZWlnaHQsCiAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgIGVsbGlwc29pZAogICAgKTsKICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgY29uc3Qgc2l6ZSA9IHBvc2l0aW9uc0xlbmd0aCAqIDQgLSA0OwogICAgY29uc3QgY3VyUG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShzaXplICogMyk7CiAgICBjb25zdCBwcmV2UG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShzaXplICogMyk7CiAgICBjb25zdCBuZXh0UG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShzaXplICogMyk7CiAgICBjb25zdCBleHBhbmRBbmRXaWR0aCA9IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDIpOwogICAgY29uc3QgdmVydGV4QmF0Y2hJZHMgPSBuZXcgVWludDE2QXJyYXkoc2l6ZSk7CiAgICBsZXQgcG9zaXRpb25JbmRleCA9IDA7CiAgICBsZXQgZXhwYW5kQW5kV2lkdGhJbmRleCA9IDA7CiAgICBsZXQgYmF0Y2hJZEluZGV4ID0gMDsKICAgIGxldCBpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBsZXQgbGVuZ3RoID0gY291bnRzLmxlbmd0aDsKICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBjb25zdCBjb3VudCA9IGNvdW50c1tpXTsKICAgICAgY29uc3Qgd2lkdGggPSB3aWR0aHNbaV07CiAgICAgIGNvbnN0IGJhdGNoSWQgPSBiYXRjaElkc1tpXTsKICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBjb3VudDsgKytqKSB7CiAgICAgICAgbGV0IHByZXZpb3VzOwogICAgICAgIGlmIChqID09PSAwKSB7CiAgICAgICAgICBjb25zdCBwMCA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2socG9zaXRpb25zLCBvZmZzZXQgKiAzLCBzY3JhdGNoUDAyKTsKICAgICAgICAgIGNvbnN0IHAxID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhwb3NpdGlvbnMsIChvZmZzZXQgKyAxKSAqIDMsIHNjcmF0Y2hQMTIpOwogICAgICAgICAgcHJldmlvdXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocDAsIHAxLCBzY3JhdGNoUHJldjIpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwMCwgcHJldmlvdXMsIHByZXZpb3VzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcHJldmlvdXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAgIChvZmZzZXQgKyBqIC0gMSkgKiAzLAogICAgICAgICAgICBzY3JhdGNoUHJldjIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGN1cnJlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgKG9mZnNldCArIGopICogMywKICAgICAgICAgIHNjcmF0Y2hDdXIKICAgICAgICApOwogICAgICAgIGxldCBuZXh0OwogICAgICAgIGlmIChqID09PSBjb3VudCAtIDEpIHsKICAgICAgICAgIGNvbnN0IHAyID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICAob2Zmc2V0ICsgY291bnQgLSAxKSAqIDMsCiAgICAgICAgICAgIHNjcmF0Y2hQMDIKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBwMyA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgICAgKG9mZnNldCArIGNvdW50IC0gMikgKiAzLAogICAgICAgICAgICBzY3JhdGNoUDEyCiAgICAgICAgICApOwogICAgICAgICAgbmV4dCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwMiwgcDMsIHNjcmF0Y2hOZXh0Mik7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHAyLCBuZXh0LCBuZXh0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbmV4dCA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2socG9zaXRpb25zLCAob2Zmc2V0ICsgaiArIDEpICogMywgc2NyYXRjaE5leHQyKTsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHByZXZpb3VzLCBjZW50ZXIsIHByZXZpb3VzKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY3VycmVudCwgY2VudGVyLCBjdXJyZW50KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QobmV4dCwgY2VudGVyLCBuZXh0KTsKICAgICAgICBjb25zdCBzdGFydEsgPSBqID09PSAwID8gMiA6IDA7CiAgICAgICAgY29uc3QgZW5kSyA9IGogPT09IGNvdW50IC0gMSA/IDIgOiA0OwogICAgICAgIGZvciAobGV0IGsgPSBzdGFydEs7IGsgPCBlbmRLOyArK2spIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGN1cnJlbnQsIGN1clBvc2l0aW9ucywgcG9zaXRpb25JbmRleCk7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhwcmV2aW91cywgcHJldlBvc2l0aW9ucywgcG9zaXRpb25JbmRleCk7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhuZXh0LCBuZXh0UG9zaXRpb25zLCBwb3NpdGlvbkluZGV4KTsKICAgICAgICAgIHBvc2l0aW9uSW5kZXggKz0gMzsKICAgICAgICAgIGNvbnN0IGRpcmVjdGlvbjIgPSBrIC0gMiA8IDAgPyAtMSA6IDE7CiAgICAgICAgICBleHBhbmRBbmRXaWR0aFtleHBhbmRBbmRXaWR0aEluZGV4KytdID0gMiAqIChrICUgMikgLSAxOwogICAgICAgICAgZXhwYW5kQW5kV2lkdGhbZXhwYW5kQW5kV2lkdGhJbmRleCsrXSA9IGRpcmVjdGlvbjIgKiB3aWR0aDsKICAgICAgICAgIHZlcnRleEJhdGNoSWRzW2JhdGNoSWRJbmRleCsrXSA9IGJhdGNoSWQ7CiAgICAgICAgfQogICAgICB9CiAgICAgIG9mZnNldCArPSBjb3VudDsKICAgIH0KICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShzaXplLCBwb3NpdGlvbnNMZW5ndGggKiA2IC0gNik7CiAgICBsZXQgaW5kZXggPSAwOwogICAgbGV0IGluZGljZXNJbmRleCA9IDA7CiAgICBsZW5ndGggPSBwb3NpdGlvbnNMZW5ndGggLSAxOwogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaW5kZXg7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaW5kZXggKyAyOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGluZGV4ICsgMTsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpbmRleCArIDE7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaW5kZXggKyAyOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGluZGV4ICsgMzsKICAgICAgaW5kZXggKz0gNDsKICAgIH0KICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaCgKICAgICAgY3VyUG9zaXRpb25zLmJ1ZmZlciwKICAgICAgcHJldlBvc2l0aW9ucy5idWZmZXIsCiAgICAgIG5leHRQb3NpdGlvbnMuYnVmZmVyCiAgICApOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKAogICAgICBleHBhbmRBbmRXaWR0aC5idWZmZXIsCiAgICAgIHZlcnRleEJhdGNoSWRzLmJ1ZmZlciwKICAgICAgaW5kaWNlcy5idWZmZXIKICAgICk7CiAgICBsZXQgcmVzdWx0cyA9IHsKICAgICAgaW5kZXhEYXRhdHlwZTogaW5kaWNlcy5CWVRFU19QRVJfRUxFTUVOVCA9PT0gMiA/IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9TSE9SVCA6IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9JTlQsCiAgICAgIGN1cnJlbnRQb3NpdGlvbnM6IGN1clBvc2l0aW9ucy5idWZmZXIsCiAgICAgIHByZXZpb3VzUG9zaXRpb25zOiBwcmV2UG9zaXRpb25zLmJ1ZmZlciwKICAgICAgbmV4dFBvc2l0aW9uczogbmV4dFBvc2l0aW9ucy5idWZmZXIsCiAgICAgIGV4cGFuZEFuZFdpZHRoOiBleHBhbmRBbmRXaWR0aC5idWZmZXIsCiAgICAgIGJhdGNoSWRzOiB2ZXJ0ZXhCYXRjaElkcy5idWZmZXIsCiAgICAgIGluZGljZXM6IGluZGljZXMuYnVmZmVyCiAgICB9OwogICAgaWYgKHBhcmFtZXRlcnMua2VlcERlY29kZWRQb3NpdGlvbnMpIHsKICAgICAgY29uc3QgcG9zaXRpb25PZmZzZXRzID0gZ2V0UG9zaXRpb25PZmZzZXRzMihjb3VudHMpOwogICAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2gocG9zaXRpb25zLmJ1ZmZlciwgcG9zaXRpb25PZmZzZXRzLmJ1ZmZlcik7CiAgICAgIHJlc3VsdHMgPSBjb21iaW5lX2RlZmF1bHQocmVzdWx0cywgewogICAgICAgIGRlY29kZWRQb3NpdGlvbnM6IHBvc2l0aW9ucy5idWZmZXIsCiAgICAgICAgZGVjb2RlZFBvc2l0aW9uT2Zmc2V0czogcG9zaXRpb25PZmZzZXRzLmJ1ZmZlcgogICAgICB9KTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH0KICB2YXIgc2NyYXRjaFJlY3RhbmdsZTYsIHNjcmF0Y2hFbGxpcHNvaWQxNiwgc2NyYXRjaENlbnRlcjcsIHNjcmF0Y2hNaW5NYXhIZWlnaHRzMiwgc2NyYXRjaFAwMiwgc2NyYXRjaFAxMiwgc2NyYXRjaFByZXYyLCBzY3JhdGNoQ3VyLCBzY3JhdGNoTmV4dDIsIGNyZWF0ZVZlY3RvclRpbGVQb2x5bGluZXNfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfY29tYmluZSgpOwogICAgICBpbml0X2RlY29kZVZlY3RvclBvbHlsaW5lUG9zaXRpb25zKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKTsKICAgICAgc2NyYXRjaFJlY3RhbmdsZTYgPSBuZXcgUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEVsbGlwc29pZDE2ID0gbmV3IEVsbGlwc29pZF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDZW50ZXI3ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTWluTWF4SGVpZ2h0czIgPSB7CiAgICAgICAgbWluOiB2b2lkIDAsCiAgICAgICAgbWF4OiB2b2lkIDAKICAgICAgfTsKICAgICAgc2NyYXRjaFAwMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFAxMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFByZXYyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ3VyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTmV4dDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNyZWF0ZVZlY3RvclRpbGVQb2x5bGluZXNfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdChjcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc29pZGFsT2NjbHVkZXIuanMKICBmdW5jdGlvbiBFbGxpcHNvaWRhbE9jY2x1ZGVyKGVsbGlwc29pZCwgY2FtZXJhUG9zaXRpb24pIHsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZWxsaXBzb2lkIiwgZWxsaXBzb2lkKTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IGVsbGlwc29pZDsKICAgIHRoaXMuX2NhbWVyYVBvc2l0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgdGhpcy5fY2FtZXJhUG9zaXRpb25JblNjYWxlZFNwYWNlID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgdGhpcy5fZGlzdGFuY2VUb0xpbWJJblNjYWxlZFNwYWNlU3F1YXJlZCA9IDA7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGNhbWVyYVBvc2l0aW9uKSkgewogICAgICB0aGlzLmNhbWVyYVBvc2l0aW9uID0gY2FtZXJhUG9zaXRpb247CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdldFBvc3NpYmx5U2hydW5rRWxsaXBzb2lkKGVsbGlwc29pZCwgbWluaW11bUhlaWdodCwgcmVzdWx0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1IZWlnaHQpICYmIG1pbmltdW1IZWlnaHQgPCAwICYmIGVsbGlwc29pZC5taW5pbXVtUmFkaXVzID4gLW1pbmltdW1IZWlnaHQpIHsKICAgICAgY29uc3QgZWxsaXBzb2lkU2hydW5rUmFkaWkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUVsZW1lbnRzKAogICAgICAgIGVsbGlwc29pZC5yYWRpaS54ICsgbWluaW11bUhlaWdodCwKICAgICAgICBlbGxpcHNvaWQucmFkaWkueSArIG1pbmltdW1IZWlnaHQsCiAgICAgICAgZWxsaXBzb2lkLnJhZGlpLnogKyBtaW5pbXVtSGVpZ2h0LAogICAgICAgIHNjcmF0Y2hFbGxpcHNvaWRTaHJ1bmtSYWRpaQogICAgICApOwogICAgICBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5mcm9tQ2FydGVzaWFuMyhlbGxpcHNvaWRTaHJ1bmtSYWRpaSwgcmVzdWx0KTsKICAgIH0KICAgIHJldHVybiBlbGxpcHNvaWQ7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVIb3Jpem9uQ3VsbGluZ1BvaW50RnJvbVBvc2l0aW9ucyhlbGxpcHNvaWQsIGRpcmVjdGlvblRvUG9pbnQsIHBvc2l0aW9ucywgcmVzdWx0KSB7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImRpcmVjdGlvblRvUG9pbnQiLCBkaXJlY3Rpb25Ub1BvaW50KTsKICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicG9zaXRpb25zIiwgcG9zaXRpb25zKTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgfQogICAgY29uc3Qgc2NhbGVkU3BhY2VEaXJlY3Rpb25Ub1BvaW50ID0gY29tcHV0ZVNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludCgKICAgICAgZWxsaXBzb2lkLAogICAgICBkaXJlY3Rpb25Ub1BvaW50CiAgICApOwogICAgbGV0IHJlc3VsdE1hZ25pdHVkZSA9IDA7CiAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gcG9zaXRpb25zLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICAgIGNvbnN0IHBvc2l0aW9uID0gcG9zaXRpb25zW2ldOwogICAgICBjb25zdCBjYW5kaWRhdGVNYWduaXR1ZGUgPSBjb21wdXRlTWFnbml0dWRlKAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICBwb3NpdGlvbiwKICAgICAgICBzY2FsZWRTcGFjZURpcmVjdGlvblRvUG9pbnQKICAgICAgKTsKICAgICAgaWYgKGNhbmRpZGF0ZU1hZ25pdHVkZSA8IDApIHsKICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICB9CiAgICAgIHJlc3VsdE1hZ25pdHVkZSA9IE1hdGgubWF4KHJlc3VsdE1hZ25pdHVkZSwgY2FuZGlkYXRlTWFnbml0dWRlKTsKICAgIH0KICAgIHJldHVybiBtYWduaXR1ZGVUb1BvaW50KHNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludCwgcmVzdWx0TWFnbml0dWRlLCByZXN1bHQpOwogIH0KICBmdW5jdGlvbiBjb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludEZyb21WZXJ0aWNlcyhlbGxpcHNvaWQsIGRpcmVjdGlvblRvUG9pbnQsIHZlcnRpY2VzLCBzdHJpZGUsIGNlbnRlciwgcmVzdWx0KSB7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImRpcmVjdGlvblRvUG9pbnQiLCBkaXJlY3Rpb25Ub1BvaW50KTsKICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidmVydGljZXMiLCB2ZXJ0aWNlcyk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInN0cmlkZSIsIHN0cmlkZSk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgIH0KICAgIHN0cmlkZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0cmlkZSwgMyk7CiAgICBjZW50ZXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjZW50ZXIsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKTsKICAgIGNvbnN0IHNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludCA9IGNvbXB1dGVTY2FsZWRTcGFjZURpcmVjdGlvblRvUG9pbnQoCiAgICAgIGVsbGlwc29pZCwKICAgICAgZGlyZWN0aW9uVG9Qb2ludAogICAgKTsKICAgIGxldCByZXN1bHRNYWduaXR1ZGUgPSAwOwogICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IHZlcnRpY2VzLmxlbmd0aDsgaSA8IGxlbjsgaSArPSBzdHJpZGUpIHsKICAgICAgcG9zaXRpb25TY3JhdGNoNS54ID0gdmVydGljZXNbaV0gKyBjZW50ZXIueDsKICAgICAgcG9zaXRpb25TY3JhdGNoNS55ID0gdmVydGljZXNbaSArIDFdICsgY2VudGVyLnk7CiAgICAgIHBvc2l0aW9uU2NyYXRjaDUueiA9IHZlcnRpY2VzW2kgKyAyXSArIGNlbnRlci56OwogICAgICBjb25zdCBjYW5kaWRhdGVNYWduaXR1ZGUgPSBjb21wdXRlTWFnbml0dWRlKAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICBwb3NpdGlvblNjcmF0Y2g1LAogICAgICAgIHNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludAogICAgICApOwogICAgICBpZiAoY2FuZGlkYXRlTWFnbml0dWRlIDwgMCkgewogICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgIH0KICAgICAgcmVzdWx0TWFnbml0dWRlID0gTWF0aC5tYXgocmVzdWx0TWFnbml0dWRlLCBjYW5kaWRhdGVNYWduaXR1ZGUpOwogICAgfQogICAgcmV0dXJuIG1hZ25pdHVkZVRvUG9pbnQoc2NhbGVkU3BhY2VEaXJlY3Rpb25Ub1BvaW50LCByZXN1bHRNYWduaXR1ZGUsIHJlc3VsdCk7CiAgfQogIGZ1bmN0aW9uIGlzU2NhbGVkU3BhY2VQb2ludFZpc2libGUob2NjbHVkZWVTY2FsZWRTcGFjZVBvc2l0aW9uLCBjYW1lcmFQb3NpdGlvbkluU2NhbGVkU3BhY2UsIGRpc3RhbmNlVG9MaW1iSW5TY2FsZWRTcGFjZVNxdWFyZWQpIHsKICAgIGNvbnN0IGN2ID0gY2FtZXJhUG9zaXRpb25JblNjYWxlZFNwYWNlOwogICAgY29uc3QgdmhNYWduaXR1ZGVTcXVhcmVkID0gZGlzdGFuY2VUb0xpbWJJblNjYWxlZFNwYWNlU3F1YXJlZDsKICAgIGNvbnN0IHZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICBvY2NsdWRlZVNjYWxlZFNwYWNlUG9zaXRpb24sCiAgICAgIGN2LAogICAgICBzY3JhdGNoQ2FydGVzaWFuMTkKICAgICk7CiAgICBjb25zdCB2dERvdFZjID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3QodnQsIGN2KTsKICAgIGNvbnN0IGlzT2NjbHVkZWQgPSB2aE1hZ25pdHVkZVNxdWFyZWQgPCAwID8gdnREb3RWYyA+IDAgOiB2dERvdFZjID4gdmhNYWduaXR1ZGVTcXVhcmVkICYmIHZ0RG90VmMgKiB2dERvdFZjIC8gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQodnQpID4gdmhNYWduaXR1ZGVTcXVhcmVkOwogICAgcmV0dXJuICFpc09jY2x1ZGVkOwogIH0KICBmdW5jdGlvbiBjb21wdXRlTWFnbml0dWRlKGVsbGlwc29pZCwgcG9zaXRpb24sIHNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludCkgewogICAgY29uc3Qgc2NhbGVkU3BhY2VQb3NpdGlvbiA9IGVsbGlwc29pZC50cmFuc2Zvcm1Qb3NpdGlvblRvU2NhbGVkU3BhY2UoCiAgICAgIHBvc2l0aW9uLAogICAgICBzY2FsZWRTcGFjZVNjcmF0Y2gKICAgICk7CiAgICBsZXQgbWFnbml0dWRlU3F1YXJlZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKHNjYWxlZFNwYWNlUG9zaXRpb24pOwogICAgbGV0IG1hZ25pdHVkZSA9IE1hdGguc3FydChtYWduaXR1ZGVTcXVhcmVkKTsKICAgIGNvbnN0IGRpcmVjdGlvbjIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZGl2aWRlQnlTY2FsYXIoCiAgICAgIHNjYWxlZFNwYWNlUG9zaXRpb24sCiAgICAgIG1hZ25pdHVkZSwKICAgICAgZGlyZWN0aW9uU2NyYXRjaAogICAgKTsKICAgIG1hZ25pdHVkZVNxdWFyZWQgPSBNYXRoLm1heCgxLCBtYWduaXR1ZGVTcXVhcmVkKTsKICAgIG1hZ25pdHVkZSA9IE1hdGgubWF4KDEsIG1hZ25pdHVkZSk7CiAgICBjb25zdCBjb3NBbHBoYSA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgc2NhbGVkU3BhY2VEaXJlY3Rpb25Ub1BvaW50KTsKICAgIGNvbnN0IHNpbkFscGhhID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSgKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKGRpcmVjdGlvbjIsIHNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludCwgZGlyZWN0aW9uMikKICAgICk7CiAgICBjb25zdCBjb3NCZXRhID0gMSAvIG1hZ25pdHVkZTsKICAgIGNvbnN0IHNpbkJldGEgPSBNYXRoLnNxcnQobWFnbml0dWRlU3F1YXJlZCAtIDEpICogY29zQmV0YTsKICAgIHJldHVybiAxIC8gKGNvc0FscGhhICogY29zQmV0YSAtIHNpbkFscGhhICogc2luQmV0YSk7CiAgfQogIGZ1bmN0aW9uIG1hZ25pdHVkZVRvUG9pbnQoc2NhbGVkU3BhY2VEaXJlY3Rpb25Ub1BvaW50LCByZXN1bHRNYWduaXR1ZGUsIHJlc3VsdCkgewogICAgaWYgKHJlc3VsdE1hZ25pdHVkZSA8PSAwIHx8IHJlc3VsdE1hZ25pdHVkZSA9PT0gMSAvIDAgfHwgcmVzdWx0TWFnbml0dWRlICE9PSByZXN1bHRNYWduaXR1ZGUpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgc2NhbGVkU3BhY2VEaXJlY3Rpb25Ub1BvaW50LAogICAgICByZXN1bHRNYWduaXR1ZGUsCiAgICAgIHJlc3VsdAogICAgKTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludChlbGxpcHNvaWQsIGRpcmVjdGlvblRvUG9pbnQpIHsKICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKGRpcmVjdGlvblRvUG9pbnQsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSkgewogICAgICByZXR1cm4gZGlyZWN0aW9uVG9Qb2ludDsKICAgIH0KICAgIGVsbGlwc29pZC50cmFuc2Zvcm1Qb3NpdGlvblRvU2NhbGVkU3BhY2UoCiAgICAgIGRpcmVjdGlvblRvUG9pbnQsCiAgICAgIGRpcmVjdGlvblRvUG9pbnRTY3JhdGNoCiAgICApOwogICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZGlyZWN0aW9uVG9Qb2ludFNjcmF0Y2gsIGRpcmVjdGlvblRvUG9pbnRTY3JhdGNoKTsKICB9CiAgdmFyIHNjcmF0Y2hDYXJ0ZXNpYW4xOSwgc2NyYXRjaENhbWVyYVBvc2l0aW9uSW5TY2FsZWRTcGFjZVNocnVuaywgc2NyYXRjaEVsbGlwc29pZFNocnVuaywgc3Vic2FtcGxlU2NyYXRjaCwgc2NyYXRjaEVsbGlwc29pZFNocnVua1JhZGlpLCBwb3NpdGlvblNjcmF0Y2g1LCBzY2FsZWRTcGFjZVNjcmF0Y2gsIGRpcmVjdGlvblNjcmF0Y2gsIGRpcmVjdGlvblRvUG9pbnRTY3JhdGNoLCBFbGxpcHNvaWRhbE9jY2x1ZGVyX2RlZmF1bHQ7CiAgdmFyIGluaXRfRWxsaXBzb2lkYWxPY2NsdWRlciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzb2lkYWxPY2NsdWRlci5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEVsbGlwc29pZGFsT2NjbHVkZXIucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgb2NjbHVkaW5nIGVsbGlwc29pZC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkYWxPY2NsdWRlci5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7RWxsaXBzb2lkfQogICAgICAgICAqLwogICAgICAgIGVsbGlwc29pZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VsbGlwc29pZDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgb3Igc2V0cyB0aGUgcG9zaXRpb24gb2YgdGhlIGNhbWVyYS4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkYWxPY2NsdWRlci5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7Q2FydGVzaWFuM30KICAgICAgICAgKi8KICAgICAgICBjYW1lcmFQb3NpdGlvbjogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2NhbWVyYVBvc2l0aW9uOwogICAgICAgICAgfSwKICAgICAgICAgIHNldDogZnVuY3Rpb24oY2FtZXJhUG9zaXRpb24pIHsKICAgICAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gdGhpcy5fZWxsaXBzb2lkOwogICAgICAgICAgICBjb25zdCBjdiA9IGVsbGlwc29pZC50cmFuc2Zvcm1Qb3NpdGlvblRvU2NhbGVkU3BhY2UoCiAgICAgICAgICAgICAgY2FtZXJhUG9zaXRpb24sCiAgICAgICAgICAgICAgdGhpcy5fY2FtZXJhUG9zaXRpb25JblNjYWxlZFNwYWNlCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbnN0IHZoTWFnbml0dWRlU3F1YXJlZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKGN2KSAtIDE7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjYW1lcmFQb3NpdGlvbiwgdGhpcy5fY2FtZXJhUG9zaXRpb24pOwogICAgICAgICAgICB0aGlzLl9jYW1lcmFQb3NpdGlvbkluU2NhbGVkU3BhY2UgPSBjdjsKICAgICAgICAgICAgdGhpcy5fZGlzdGFuY2VUb0xpbWJJblNjYWxlZFNwYWNlU3F1YXJlZCA9IHZoTWFnbml0dWRlU3F1YXJlZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMTkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEVsbGlwc29pZGFsT2NjbHVkZXIucHJvdG90eXBlLmlzUG9pbnRWaXNpYmxlID0gZnVuY3Rpb24ob2NjbHVkZWUpIHsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSB0aGlzLl9lbGxpcHNvaWQ7CiAgICAgICAgY29uc3Qgb2NjbHVkZWVTY2FsZWRTcGFjZVBvc2l0aW9uID0gZWxsaXBzb2lkLnRyYW5zZm9ybVBvc2l0aW9uVG9TY2FsZWRTcGFjZSgKICAgICAgICAgIG9jY2x1ZGVlLAogICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjE5CiAgICAgICAgKTsKICAgICAgICByZXR1cm4gaXNTY2FsZWRTcGFjZVBvaW50VmlzaWJsZSgKICAgICAgICAgIG9jY2x1ZGVlU2NhbGVkU3BhY2VQb3NpdGlvbiwKICAgICAgICAgIHRoaXMuX2NhbWVyYVBvc2l0aW9uSW5TY2FsZWRTcGFjZSwKICAgICAgICAgIHRoaXMuX2Rpc3RhbmNlVG9MaW1iSW5TY2FsZWRTcGFjZVNxdWFyZWQKICAgICAgICApOwogICAgICB9OwogICAgICBFbGxpcHNvaWRhbE9jY2x1ZGVyLnByb3RvdHlwZS5pc1NjYWxlZFNwYWNlUG9pbnRWaXNpYmxlID0gZnVuY3Rpb24ob2NjbHVkZWVTY2FsZWRTcGFjZVBvc2l0aW9uKSB7CiAgICAgICAgcmV0dXJuIGlzU2NhbGVkU3BhY2VQb2ludFZpc2libGUoCiAgICAgICAgICBvY2NsdWRlZVNjYWxlZFNwYWNlUG9zaXRpb24sCiAgICAgICAgICB0aGlzLl9jYW1lcmFQb3NpdGlvbkluU2NhbGVkU3BhY2UsCiAgICAgICAgICB0aGlzLl9kaXN0YW5jZVRvTGltYkluU2NhbGVkU3BhY2VTcXVhcmVkCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgc2NyYXRjaENhbWVyYVBvc2l0aW9uSW5TY2FsZWRTcGFjZVNocnVuayA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgRWxsaXBzb2lkYWxPY2NsdWRlci5wcm90b3R5cGUuaXNTY2FsZWRTcGFjZVBvaW50VmlzaWJsZVBvc3NpYmx5VW5kZXJFbGxpcHNvaWQgPSBmdW5jdGlvbihvY2NsdWRlZVNjYWxlZFNwYWNlUG9zaXRpb24sIG1pbmltdW1IZWlnaHQpIHsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSB0aGlzLl9lbGxpcHNvaWQ7CiAgICAgICAgbGV0IHZoTWFnbml0dWRlU3F1YXJlZDsKICAgICAgICBsZXQgY3Y7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChtaW5pbXVtSGVpZ2h0KSAmJiBtaW5pbXVtSGVpZ2h0IDwgMCAmJiBlbGxpcHNvaWQubWluaW11bVJhZGl1cyA+IC1taW5pbXVtSGVpZ2h0KSB7CiAgICAgICAgICBjdiA9IHNjcmF0Y2hDYW1lcmFQb3NpdGlvbkluU2NhbGVkU3BhY2VTaHJ1bms7CiAgICAgICAgICBjdi54ID0gdGhpcy5fY2FtZXJhUG9zaXRpb24ueCAvIChlbGxpcHNvaWQucmFkaWkueCArIG1pbmltdW1IZWlnaHQpOwogICAgICAgICAgY3YueSA9IHRoaXMuX2NhbWVyYVBvc2l0aW9uLnkgLyAoZWxsaXBzb2lkLnJhZGlpLnkgKyBtaW5pbXVtSGVpZ2h0KTsKICAgICAgICAgIGN2LnogPSB0aGlzLl9jYW1lcmFQb3NpdGlvbi56IC8gKGVsbGlwc29pZC5yYWRpaS56ICsgbWluaW11bUhlaWdodCk7CiAgICAgICAgICB2aE1hZ25pdHVkZVNxdWFyZWQgPSBjdi54ICogY3YueCArIGN2LnkgKiBjdi55ICsgY3YueiAqIGN2LnogLSAxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjdiA9IHRoaXMuX2NhbWVyYVBvc2l0aW9uSW5TY2FsZWRTcGFjZTsKICAgICAgICAgIHZoTWFnbml0dWRlU3F1YXJlZCA9IHRoaXMuX2Rpc3RhbmNlVG9MaW1iSW5TY2FsZWRTcGFjZVNxdWFyZWQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpc1NjYWxlZFNwYWNlUG9pbnRWaXNpYmxlKAogICAgICAgICAgb2NjbHVkZWVTY2FsZWRTcGFjZVBvc2l0aW9uLAogICAgICAgICAgY3YsCiAgICAgICAgICB2aE1hZ25pdHVkZVNxdWFyZWQKICAgICAgICApOwogICAgICB9OwogICAgICBFbGxpcHNvaWRhbE9jY2x1ZGVyLnByb3RvdHlwZS5jb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludCA9IGZ1bmN0aW9uKGRpcmVjdGlvblRvUG9pbnQsIHBvc2l0aW9ucywgcmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIGNvbXB1dGVIb3Jpem9uQ3VsbGluZ1BvaW50RnJvbVBvc2l0aW9ucygKICAgICAgICAgIHRoaXMuX2VsbGlwc29pZCwKICAgICAgICAgIGRpcmVjdGlvblRvUG9pbnQsCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBzY3JhdGNoRWxsaXBzb2lkU2hydW5rID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoRWxsaXBzb2lkX2RlZmF1bHQuVU5JVF9TUEhFUkUpOwogICAgICBFbGxpcHNvaWRhbE9jY2x1ZGVyLnByb3RvdHlwZS5jb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludFBvc3NpYmx5VW5kZXJFbGxpcHNvaWQgPSBmdW5jdGlvbihkaXJlY3Rpb25Ub1BvaW50LCBwb3NpdGlvbnMsIG1pbmltdW1IZWlnaHQsIHJlc3VsdCkgewogICAgICAgIGNvbnN0IHBvc3NpYmx5U2hydW5rRWxsaXBzb2lkID0gZ2V0UG9zc2libHlTaHJ1bmtFbGxpcHNvaWQoCiAgICAgICAgICB0aGlzLl9lbGxpcHNvaWQsCiAgICAgICAgICBtaW5pbXVtSGVpZ2h0LAogICAgICAgICAgc2NyYXRjaEVsbGlwc29pZFNocnVuawogICAgICAgICk7CiAgICAgICAgcmV0dXJuIGNvbXB1dGVIb3Jpem9uQ3VsbGluZ1BvaW50RnJvbVBvc2l0aW9ucygKICAgICAgICAgIHBvc3NpYmx5U2hydW5rRWxsaXBzb2lkLAogICAgICAgICAgZGlyZWN0aW9uVG9Qb2ludCwKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZGFsT2NjbHVkZXIucHJvdG90eXBlLmNvbXB1dGVIb3Jpem9uQ3VsbGluZ1BvaW50RnJvbVZlcnRpY2VzID0gZnVuY3Rpb24oZGlyZWN0aW9uVG9Qb2ludCwgdmVydGljZXMsIHN0cmlkZSwgY2VudGVyLCByZXN1bHQpIHsKICAgICAgICByZXR1cm4gY29tcHV0ZUhvcml6b25DdWxsaW5nUG9pbnRGcm9tVmVydGljZXMoCiAgICAgICAgICB0aGlzLl9lbGxpcHNvaWQsCiAgICAgICAgICBkaXJlY3Rpb25Ub1BvaW50LAogICAgICAgICAgdmVydGljZXMsCiAgICAgICAgICBzdHJpZGUsCiAgICAgICAgICBjZW50ZXIsCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBFbGxpcHNvaWRhbE9jY2x1ZGVyLnByb3RvdHlwZS5jb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludEZyb21WZXJ0aWNlc1Bvc3NpYmx5VW5kZXJFbGxpcHNvaWQgPSBmdW5jdGlvbihkaXJlY3Rpb25Ub1BvaW50LCB2ZXJ0aWNlcywgc3RyaWRlLCBjZW50ZXIsIG1pbmltdW1IZWlnaHQsIHJlc3VsdCkgewogICAgICAgIGNvbnN0IHBvc3NpYmx5U2hydW5rRWxsaXBzb2lkID0gZ2V0UG9zc2libHlTaHJ1bmtFbGxpcHNvaWQoCiAgICAgICAgICB0aGlzLl9lbGxpcHNvaWQsCiAgICAgICAgICBtaW5pbXVtSGVpZ2h0LAogICAgICAgICAgc2NyYXRjaEVsbGlwc29pZFNocnVuawogICAgICAgICk7CiAgICAgICAgcmV0dXJuIGNvbXB1dGVIb3Jpem9uQ3VsbGluZ1BvaW50RnJvbVZlcnRpY2VzKAogICAgICAgICAgcG9zc2libHlTaHJ1bmtFbGxpcHNvaWQsCiAgICAgICAgICBkaXJlY3Rpb25Ub1BvaW50LAogICAgICAgICAgdmVydGljZXMsCiAgICAgICAgICBzdHJpZGUsCiAgICAgICAgICBjZW50ZXIsCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBzdWJzYW1wbGVTY3JhdGNoID0gW107CiAgICAgIEVsbGlwc29pZGFsT2NjbHVkZXIucHJvdG90eXBlLmNvbXB1dGVIb3Jpem9uQ3VsbGluZ1BvaW50RnJvbVJlY3RhbmdsZSA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gUmVjdGFuZ2xlX2RlZmF1bHQuc3Vic2FtcGxlKAogICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgMCwKICAgICAgICAgIHN1YnNhbXBsZVNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IGJzID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tUG9pbnRzKHBvc2l0aW9ucyk7CiAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoYnMuY2VudGVyKSA8IDAuMSAqIGVsbGlwc29pZC5taW5pbXVtUmFkaXVzKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5jb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludChicy5jZW50ZXIsIHBvc2l0aW9ucywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgc2NyYXRjaEVsbGlwc29pZFNocnVua1JhZGlpID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwb3NpdGlvblNjcmF0Y2g1ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY2FsZWRTcGFjZVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGRpcmVjdGlvblNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGRpcmVjdGlvblRvUG9pbnRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBFbGxpcHNvaWRhbE9jY2x1ZGVyX2RlZmF1bHQgPSBFbGxpcHNvaWRhbE9jY2x1ZGVyOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVmVydGljYWxFeGFnZ2VyYXRpb24uanMKICB2YXIgVmVydGljYWxFeGFnZ2VyYXRpb24sIHNjcmF0Y2hDYXJ0b2dyYXBoaWM2LCBWZXJ0aWNhbEV4YWdnZXJhdGlvbl9kZWZhdWx0OwogIHZhciBpbml0X1ZlcnRpY2FsRXhhZ2dlcmF0aW9uID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9WZXJ0aWNhbEV4YWdnZXJhdGlvbi5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBWZXJ0aWNhbEV4YWdnZXJhdGlvbiA9IHt9OwogICAgICBWZXJ0aWNhbEV4YWdnZXJhdGlvbi5nZXRIZWlnaHQgPSBmdW5jdGlvbihoZWlnaHQsIHNjYWxlLCByZWxhdGl2ZUhlaWdodCkgewogICAgICAgIGlmICghTnVtYmVyLmlzRmluaXRlKHNjYWxlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInNjYWxlIG11c3QgYmUgYSBmaW5pdGUgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIU51bWJlci5pc0Zpbml0ZShyZWxhdGl2ZUhlaWdodCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyZWxhdGl2ZUhlaWdodCBtdXN0IGJlIGEgZmluaXRlIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIChoZWlnaHQgLSByZWxhdGl2ZUhlaWdodCkgKiBzY2FsZSArIHJlbGF0aXZlSGVpZ2h0OwogICAgICB9OwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgVmVydGljYWxFeGFnZ2VyYXRpb24uZ2V0UG9zaXRpb24gPSBmdW5jdGlvbihwb3NpdGlvbiwgZWxsaXBzb2lkLCB2ZXJ0aWNhbEV4YWdnZXJhdGlvbiwgdmVydGljYWxFeGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgY2FydG9ncmFwaGljMiA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzYKICAgICAgICApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNhcnRvZ3JhcGhpYzIpKSB7CiAgICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHBvc2l0aW9uLCByZXN1bHQpOwogICAgICAgIH0KICAgICAgICBjb25zdCBuZXdIZWlnaHQgPSBWZXJ0aWNhbEV4YWdnZXJhdGlvbi5nZXRIZWlnaHQoCiAgICAgICAgICBjYXJ0b2dyYXBoaWMyLmhlaWdodCwKICAgICAgICAgIHZlcnRpY2FsRXhhZ2dlcmF0aW9uLAogICAgICAgICAgdmVydGljYWxFeGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodAogICAgICAgICk7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgIGNhcnRvZ3JhcGhpYzIubG9uZ2l0dWRlLAogICAgICAgICAgY2FydG9ncmFwaGljMi5sYXRpdHVkZSwKICAgICAgICAgIG5ld0hlaWdodCwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIFZlcnRpY2FsRXhhZ2dlcmF0aW9uX2RlZmF1bHQgPSBWZXJ0aWNhbEV4YWdnZXJhdGlvbjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RlcnJhaW5RdWFudGl6YXRpb24uanMKICB2YXIgVGVycmFpblF1YW50aXphdGlvbiwgVGVycmFpblF1YW50aXphdGlvbl9kZWZhdWx0OwogIHZhciBpbml0X1RlcnJhaW5RdWFudGl6YXRpb24gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RlcnJhaW5RdWFudGl6YXRpb24uanMiKCkgewogICAgICBUZXJyYWluUXVhbnRpemF0aW9uID0gewogICAgICAgIC8qKgogICAgICAgICAqIFRoZSB2ZXJ0aWNlcyBhcmUgbm90IGNvbXByZXNzZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIE5PTkU6IDAsCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIHZlcnRpY2VzIGFyZSBjb21wcmVzc2VkIHRvIDEyIGJpdHMuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIEJJVFMxMjogMQogICAgICB9OwogICAgICBUZXJyYWluUXVhbnRpemF0aW9uX2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKFRlcnJhaW5RdWFudGl6YXRpb24pOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVGVycmFpbkVuY29kaW5nLmpzCiAgZnVuY3Rpb24gVGVycmFpbkVuY29kaW5nKGNlbnRlciwgYXhpc0FsaWduZWRCb3VuZGluZ0JveCwgbWluaW11bUhlaWdodCwgbWF4aW11bUhlaWdodCwgZnJvbUVOVSwgaGFzVmVydGV4Tm9ybWFscywgaGFzV2ViTWVyY2F0b3JULCBoYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzLCBleGFnZ2VyYXRpb24sIGV4YWdnZXJhdGlvblJlbGF0aXZlSGVpZ2h0KSB7CiAgICBsZXQgcXVhbnRpemF0aW9uID0gVGVycmFpblF1YW50aXphdGlvbl9kZWZhdWx0Lk5PTkU7CiAgICBsZXQgdG9FTlU7CiAgICBsZXQgbWF0cml4OwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChheGlzQWxpZ25lZEJvdW5kaW5nQm94KSAmJiBkZWZpbmVkX2RlZmF1bHQobWluaW11bUhlaWdodCkgJiYgZGVmaW5lZF9kZWZhdWx0KG1heGltdW1IZWlnaHQpICYmIGRlZmluZWRfZGVmYXVsdChmcm9tRU5VKSkgewogICAgICBjb25zdCBtaW5pbXVtID0gYXhpc0FsaWduZWRCb3VuZGluZ0JveC5taW5pbXVtOwogICAgICBjb25zdCBtYXhpbXVtID0gYXhpc0FsaWduZWRCb3VuZGluZ0JveC5tYXhpbXVtOwogICAgICBjb25zdCBkaW1lbnNpb25zID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgIG1heGltdW0sCiAgICAgICAgbWluaW11bSwKICAgICAgICBjYXJ0ZXNpYW4zRGltU2NyYXRjaAogICAgICApOwogICAgICBjb25zdCBoRGltID0gbWF4aW11bUhlaWdodCAtIG1pbmltdW1IZWlnaHQ7CiAgICAgIGNvbnN0IG1heERpbSA9IE1hdGgubWF4KENhcnRlc2lhbjNfZGVmYXVsdC5tYXhpbXVtQ29tcG9uZW50KGRpbWVuc2lvbnMpLCBoRGltKTsKICAgICAgaWYgKG1heERpbSA8IFNISUZUX0xFRlRfMTIgLSAxKSB7CiAgICAgICAgcXVhbnRpemF0aW9uID0gVGVycmFpblF1YW50aXphdGlvbl9kZWZhdWx0LkJJVFMxMjsKICAgICAgfSBlbHNlIHsKICAgICAgICBxdWFudGl6YXRpb24gPSBUZXJyYWluUXVhbnRpemF0aW9uX2RlZmF1bHQuTk9ORTsKICAgICAgfQogICAgICB0b0VOVSA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlVHJhbnNmb3JtYXRpb24oZnJvbUVOVSwgbmV3IE1hdHJpeDRfZGVmYXVsdCgpKTsKICAgICAgY29uc3QgdHJhbnNsYXRpb24yID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShtaW5pbXVtLCBjYXJ0ZXNpYW4zU2NyYXRjaCk7CiAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseSgKICAgICAgICBNYXRyaXg0X2RlZmF1bHQuZnJvbVRyYW5zbGF0aW9uKHRyYW5zbGF0aW9uMiwgbWF0cml4NFNjcmF0Y2gpLAogICAgICAgIHRvRU5VLAogICAgICAgIHRvRU5VCiAgICAgICk7CiAgICAgIGNvbnN0IHNjYWxlID0gY2FydGVzaWFuM1NjcmF0Y2g7CiAgICAgIHNjYWxlLnggPSAxIC8gZGltZW5zaW9ucy54OwogICAgICBzY2FsZS55ID0gMSAvIGRpbWVuc2lvbnMueTsKICAgICAgc2NhbGUueiA9IDEgLyBkaW1lbnNpb25zLno7CiAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseShNYXRyaXg0X2RlZmF1bHQuZnJvbVNjYWxlKHNjYWxlLCBtYXRyaXg0U2NyYXRjaCksIHRvRU5VLCB0b0VOVSk7CiAgICAgIG1hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC5jbG9uZShmcm9tRU5VKTsKICAgICAgTWF0cml4NF9kZWZhdWx0LnNldFRyYW5zbGF0aW9uKG1hdHJpeCwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIG1hdHJpeCk7CiAgICAgIGZyb21FTlUgPSBNYXRyaXg0X2RlZmF1bHQuY2xvbmUoZnJvbUVOVSwgbmV3IE1hdHJpeDRfZGVmYXVsdCgpKTsKICAgICAgY29uc3QgdHJhbnNsYXRpb25NYXRyaXggPSBNYXRyaXg0X2RlZmF1bHQuZnJvbVRyYW5zbGF0aW9uKG1pbmltdW0sIG1hdHJpeDRTY3JhdGNoKTsKICAgICAgY29uc3Qgc2NhbGVNYXRyaXgyID0gTWF0cml4NF9kZWZhdWx0LmZyb21TY2FsZShkaW1lbnNpb25zLCBtYXRyaXg0U2NyYXRjaDIpOwogICAgICBjb25zdCBzdCA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseSh0cmFuc2xhdGlvbk1hdHJpeCwgc2NhbGVNYXRyaXgyLCBtYXRyaXg0U2NyYXRjaCk7CiAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseShmcm9tRU5VLCBzdCwgZnJvbUVOVSk7CiAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseShtYXRyaXgsIHN0LCBtYXRyaXgpOwogICAgfQogICAgdGhpcy5xdWFudGl6YXRpb24gPSBxdWFudGl6YXRpb247CiAgICB0aGlzLm1pbmltdW1IZWlnaHQgPSBtaW5pbXVtSGVpZ2h0OwogICAgdGhpcy5tYXhpbXVtSGVpZ2h0ID0gbWF4aW11bUhlaWdodDsKICAgIHRoaXMuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlcik7CiAgICB0aGlzLnRvU2NhbGVkRU5VID0gdG9FTlU7CiAgICB0aGlzLmZyb21TY2FsZWRFTlUgPSBmcm9tRU5VOwogICAgdGhpcy5tYXRyaXggPSBtYXRyaXg7CiAgICB0aGlzLmhhc1ZlcnRleE5vcm1hbHMgPSBoYXNWZXJ0ZXhOb3JtYWxzOwogICAgdGhpcy5oYXNXZWJNZXJjYXRvclQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChoYXNXZWJNZXJjYXRvclQsIGZhbHNlKTsKICAgIHRoaXMuaGFzR2VvZGV0aWNTdXJmYWNlTm9ybWFscyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBoYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzLAogICAgICBmYWxzZQogICAgKTsKICAgIHRoaXMuZXhhZ2dlcmF0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZXhhZ2dlcmF0aW9uLCAxKTsKICAgIHRoaXMuZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQsCiAgICAgIDAKICAgICk7CiAgICB0aGlzLnN0cmlkZSA9IDA7CiAgICB0aGlzLl9vZmZzZXRHZW9kZXRpY1N1cmZhY2VOb3JtYWwgPSAwOwogICAgdGhpcy5fb2Zmc2V0VmVydGV4Tm9ybWFsID0gMDsKICAgIHRoaXMuX2NhbGN1bGF0ZVN0cmlkZUFuZE9mZnNldHMoKTsKICB9CiAgdmFyIGNhcnRlc2lhbjNTY3JhdGNoLCBjYXJ0ZXNpYW4zRGltU2NyYXRjaCwgY2FydGVzaWFuMlNjcmF0Y2gsIG1hdHJpeDRTY3JhdGNoLCBtYXRyaXg0U2NyYXRjaDIsIFNISUZUX0xFRlRfMTIsIHNjcmF0Y2hQb3NpdGlvbjYsIHNjcmF0Y2hHZW9kZXRpY1N1cmZhY2VOb3JtYWwsIGF0dHJpYnV0ZXNJbmRpY2VzTm9uZSwgYXR0cmlidXRlc0luZGljZXNCaXRzMTIsIFRlcnJhaW5FbmNvZGluZ19kZWZhdWx0OwogIHZhciBpbml0X1RlcnJhaW5FbmNvZGluZyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVGVycmFpbkVuY29kaW5nLmpzIigpIHsKICAgICAgaW5pdF9BdHRyaWJ1dGVDb21wcmVzc2lvbigpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9WZXJ0aWNhbEV4YWdnZXJhdGlvbigpOwogICAgICBpbml0X1RlcnJhaW5RdWFudGl6YXRpb24oKTsKICAgICAgY2FydGVzaWFuM1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjNEaW1TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4yU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgbWF0cml4NFNjcmF0Y2ggPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIG1hdHJpeDRTY3JhdGNoMiA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgU0hJRlRfTEVGVF8xMiA9IE1hdGgucG93KDIsIDEyKTsKICAgICAgVGVycmFpbkVuY29kaW5nLnByb3RvdHlwZS5lbmNvZGUgPSBmdW5jdGlvbih2ZXJ0ZXhCdWZmZXIsIGJ1ZmZlckluZGV4LCBwb3NpdGlvbiwgdXYsIGhlaWdodCwgbm9ybWFsVG9QYWNrLCB3ZWJNZXJjYXRvclQsIGdlb2RldGljU3VyZmFjZU5vcm1hbCkgewogICAgICAgIGNvbnN0IHUzID0gdXYueDsKICAgICAgICBjb25zdCB2MyA9IHV2Lnk7CiAgICAgICAgaWYgKHRoaXMucXVhbnRpemF0aW9uID09PSBUZXJyYWluUXVhbnRpemF0aW9uX2RlZmF1bHQuQklUUzEyKSB7CiAgICAgICAgICBwb3NpdGlvbiA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnQoCiAgICAgICAgICAgIHRoaXMudG9TY2FsZWRFTlUsCiAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICBjYXJ0ZXNpYW4zU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIHBvc2l0aW9uLnggPSBNYXRoX2RlZmF1bHQuY2xhbXAocG9zaXRpb24ueCwgMCwgMSk7CiAgICAgICAgICBwb3NpdGlvbi55ID0gTWF0aF9kZWZhdWx0LmNsYW1wKHBvc2l0aW9uLnksIDAsIDEpOwogICAgICAgICAgcG9zaXRpb24ueiA9IE1hdGhfZGVmYXVsdC5jbGFtcChwb3NpdGlvbi56LCAwLCAxKTsKICAgICAgICAgIGNvbnN0IGhEaW0gPSB0aGlzLm1heGltdW1IZWlnaHQgLSB0aGlzLm1pbmltdW1IZWlnaHQ7CiAgICAgICAgICBjb25zdCBoID0gTWF0aF9kZWZhdWx0LmNsYW1wKChoZWlnaHQgLSB0aGlzLm1pbmltdW1IZWlnaHQpIC8gaERpbSwgMCwgMSk7CiAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUVsZW1lbnRzKHBvc2l0aW9uLngsIHBvc2l0aW9uLnksIGNhcnRlc2lhbjJTY3JhdGNoKTsKICAgICAgICAgIGNvbnN0IGNvbXByZXNzZWQwID0gQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC5jb21wcmVzc1RleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgICAgY2FydGVzaWFuMlNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUVsZW1lbnRzKHBvc2l0aW9uLnosIGgsIGNhcnRlc2lhbjJTY3JhdGNoKTsKICAgICAgICAgIGNvbnN0IGNvbXByZXNzZWQxID0gQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC5jb21wcmVzc1RleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgICAgY2FydGVzaWFuMlNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUVsZW1lbnRzKHUzLCB2MywgY2FydGVzaWFuMlNjcmF0Y2gpOwogICAgICAgICAgY29uc3QgY29tcHJlc3NlZDIgPSBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0LmNvbXByZXNzVGV4dHVyZUNvb3JkaW5hdGVzKAogICAgICAgICAgICBjYXJ0ZXNpYW4yU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIHZlcnRleEJ1ZmZlcltidWZmZXJJbmRleCsrXSA9IGNvbXByZXNzZWQwOwogICAgICAgICAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gY29tcHJlc3NlZDE7CiAgICAgICAgICB2ZXJ0ZXhCdWZmZXJbYnVmZmVySW5kZXgrK10gPSBjb21wcmVzc2VkMjsKICAgICAgICAgIGlmICh0aGlzLmhhc1dlYk1lcmNhdG9yVCkgewogICAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUVsZW1lbnRzKHdlYk1lcmNhdG9yVCwgMCwgY2FydGVzaWFuMlNjcmF0Y2gpOwogICAgICAgICAgICBjb25zdCBjb21wcmVzc2VkMyA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQuY29tcHJlc3NUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICAgICAgY2FydGVzaWFuMlNjcmF0Y2gKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gY29tcHJlc3NlZDM7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwb3NpdGlvbiwgdGhpcy5jZW50ZXIsIGNhcnRlc2lhbjNTY3JhdGNoKTsKICAgICAgICAgIHZlcnRleEJ1ZmZlcltidWZmZXJJbmRleCsrXSA9IGNhcnRlc2lhbjNTY3JhdGNoLng7CiAgICAgICAgICB2ZXJ0ZXhCdWZmZXJbYnVmZmVySW5kZXgrK10gPSBjYXJ0ZXNpYW4zU2NyYXRjaC55OwogICAgICAgICAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gY2FydGVzaWFuM1NjcmF0Y2guejsKICAgICAgICAgIHZlcnRleEJ1ZmZlcltidWZmZXJJbmRleCsrXSA9IGhlaWdodDsKICAgICAgICAgIHZlcnRleEJ1ZmZlcltidWZmZXJJbmRleCsrXSA9IHUzOwogICAgICAgICAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gdjM7CiAgICAgICAgICBpZiAodGhpcy5oYXNXZWJNZXJjYXRvclQpIHsKICAgICAgICAgICAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gd2ViTWVyY2F0b3JUOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5oYXNWZXJ0ZXhOb3JtYWxzKSB7CiAgICAgICAgICB2ZXJ0ZXhCdWZmZXJbYnVmZmVySW5kZXgrK10gPSBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0Lm9jdFBhY2tGbG9hdCgKICAgICAgICAgICAgbm9ybWFsVG9QYWNrCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5oYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzKSB7CiAgICAgICAgICB2ZXJ0ZXhCdWZmZXJbYnVmZmVySW5kZXgrK10gPSBnZW9kZXRpY1N1cmZhY2VOb3JtYWwueDsKICAgICAgICAgIHZlcnRleEJ1ZmZlcltidWZmZXJJbmRleCsrXSA9IGdlb2RldGljU3VyZmFjZU5vcm1hbC55OwogICAgICAgICAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gZ2VvZGV0aWNTdXJmYWNlTm9ybWFsLno7CiAgICAgICAgfQogICAgICAgIHJldHVybiBidWZmZXJJbmRleDsKICAgICAgfTsKICAgICAgc2NyYXRjaFBvc2l0aW9uNiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEdlb2RldGljU3VyZmFjZU5vcm1hbCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgVGVycmFpbkVuY29kaW5nLnByb3RvdHlwZS5hZGRHZW9kZXRpY1N1cmZhY2VOb3JtYWxzID0gZnVuY3Rpb24ob2xkQnVmZmVyLCBuZXdCdWZmZXIsIGVsbGlwc29pZCkgewogICAgICAgIGlmICh0aGlzLmhhc0dlb2RldGljU3VyZmFjZU5vcm1hbHMpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb2xkU3RyaWRlID0gdGhpcy5zdHJpZGU7CiAgICAgICAgY29uc3QgdmVydGV4Q291bnQgPSBvbGRCdWZmZXIubGVuZ3RoIC8gb2xkU3RyaWRlOwogICAgICAgIHRoaXMuaGFzR2VvZGV0aWNTdXJmYWNlTm9ybWFscyA9IHRydWU7CiAgICAgICAgdGhpcy5fY2FsY3VsYXRlU3RyaWRlQW5kT2Zmc2V0cygpOwogICAgICAgIGNvbnN0IG5ld1N0cmlkZSA9IHRoaXMuc3RyaWRlOwogICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB2ZXJ0ZXhDb3VudDsgaW5kZXgrKykgewogICAgICAgICAgZm9yIChsZXQgb2Zmc2V0ID0gMDsgb2Zmc2V0IDwgb2xkU3RyaWRlOyBvZmZzZXQrKykgewogICAgICAgICAgICBjb25zdCBvbGRJbmRleCA9IGluZGV4ICogb2xkU3RyaWRlICsgb2Zmc2V0OwogICAgICAgICAgICBjb25zdCBuZXdJbmRleCA9IGluZGV4ICogbmV3U3RyaWRlICsgb2Zmc2V0OwogICAgICAgICAgICBuZXdCdWZmZXJbbmV3SW5kZXhdID0gb2xkQnVmZmVyW29sZEluZGV4XTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHBvc2l0aW9uID0gdGhpcy5kZWNvZGVQb3NpdGlvbihuZXdCdWZmZXIsIGluZGV4LCBzY3JhdGNoUG9zaXRpb242KTsKICAgICAgICAgIGNvbnN0IGdlb2RldGljU3VyZmFjZU5vcm1hbCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoCiAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICBzY3JhdGNoR2VvZGV0aWNTdXJmYWNlTm9ybWFsCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgYnVmZmVySW5kZXggPSBpbmRleCAqIG5ld1N0cmlkZSArIHRoaXMuX29mZnNldEdlb2RldGljU3VyZmFjZU5vcm1hbDsKICAgICAgICAgIG5ld0J1ZmZlcltidWZmZXJJbmRleF0gPSBnZW9kZXRpY1N1cmZhY2VOb3JtYWwueDsKICAgICAgICAgIG5ld0J1ZmZlcltidWZmZXJJbmRleCArIDFdID0gZ2VvZGV0aWNTdXJmYWNlTm9ybWFsLnk7CiAgICAgICAgICBuZXdCdWZmZXJbYnVmZmVySW5kZXggKyAyXSA9IGdlb2RldGljU3VyZmFjZU5vcm1hbC56OwogICAgICAgIH0KICAgICAgfTsKICAgICAgVGVycmFpbkVuY29kaW5nLnByb3RvdHlwZS5yZW1vdmVHZW9kZXRpY1N1cmZhY2VOb3JtYWxzID0gZnVuY3Rpb24ob2xkQnVmZmVyLCBuZXdCdWZmZXIpIHsKICAgICAgICBpZiAoIXRoaXMuaGFzR2VvZGV0aWNTdXJmYWNlTm9ybWFscykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBvbGRTdHJpZGUgPSB0aGlzLnN0cmlkZTsKICAgICAgICBjb25zdCB2ZXJ0ZXhDb3VudCA9IG9sZEJ1ZmZlci5sZW5ndGggLyBvbGRTdHJpZGU7CiAgICAgICAgdGhpcy5oYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzID0gZmFsc2U7CiAgICAgICAgdGhpcy5fY2FsY3VsYXRlU3RyaWRlQW5kT2Zmc2V0cygpOwogICAgICAgIGNvbnN0IG5ld1N0cmlkZSA9IHRoaXMuc3RyaWRlOwogICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB2ZXJ0ZXhDb3VudDsgaW5kZXgrKykgewogICAgICAgICAgZm9yIChsZXQgb2Zmc2V0ID0gMDsgb2Zmc2V0IDwgbmV3U3RyaWRlOyBvZmZzZXQrKykgewogICAgICAgICAgICBjb25zdCBvbGRJbmRleCA9IGluZGV4ICogb2xkU3RyaWRlICsgb2Zmc2V0OwogICAgICAgICAgICBjb25zdCBuZXdJbmRleCA9IGluZGV4ICogbmV3U3RyaWRlICsgb2Zmc2V0OwogICAgICAgICAgICBuZXdCdWZmZXJbbmV3SW5kZXhdID0gb2xkQnVmZmVyW29sZEluZGV4XTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZy5wcm90b3R5cGUuZGVjb2RlUG9zaXRpb24gPSBmdW5jdGlvbihidWZmZXIsIGluZGV4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGluZGV4ICo9IHRoaXMuc3RyaWRlOwogICAgICAgIGlmICh0aGlzLnF1YW50aXphdGlvbiA9PT0gVGVycmFpblF1YW50aXphdGlvbl9kZWZhdWx0LkJJVFMxMikgewogICAgICAgICAgY29uc3QgeHkgPSBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0LmRlY29tcHJlc3NUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICAgIGJ1ZmZlcltpbmRleF0sCiAgICAgICAgICAgIGNhcnRlc2lhbjJTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgcmVzdWx0LnggPSB4eS54OwogICAgICAgICAgcmVzdWx0LnkgPSB4eS55OwogICAgICAgICAgY29uc3QgemggPSBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0LmRlY29tcHJlc3NUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICAgIGJ1ZmZlcltpbmRleCArIDFdLAogICAgICAgICAgICBjYXJ0ZXNpYW4yU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIHJlc3VsdC56ID0gemgueDsKICAgICAgICAgIHJldHVybiBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50KHRoaXMuZnJvbVNjYWxlZEVOVSwgcmVzdWx0LCByZXN1bHQpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IGJ1ZmZlcltpbmRleF07CiAgICAgICAgcmVzdWx0LnkgPSBidWZmZXJbaW5kZXggKyAxXTsKICAgICAgICByZXN1bHQueiA9IGJ1ZmZlcltpbmRleCArIDJdOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJlc3VsdCwgdGhpcy5jZW50ZXIsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZy5wcm90b3R5cGUuZ2V0RXhhZ2dlcmF0ZWRQb3NpdGlvbiA9IGZ1bmN0aW9uKGJ1ZmZlciwgaW5kZXgsIHJlc3VsdCkgewogICAgICAgIHJlc3VsdCA9IHRoaXMuZGVjb2RlUG9zaXRpb24oYnVmZmVyLCBpbmRleCwgcmVzdWx0KTsKICAgICAgICBjb25zdCBleGFnZ2VyYXRpb24gPSB0aGlzLmV4YWdnZXJhdGlvbjsKICAgICAgICBjb25zdCBleGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodCA9IHRoaXMuZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQ7CiAgICAgICAgY29uc3QgaGFzRXhhZ2dlcmF0aW9uID0gZXhhZ2dlcmF0aW9uICE9PSAxOwogICAgICAgIGlmIChoYXNFeGFnZ2VyYXRpb24gJiYgdGhpcy5oYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzKSB7CiAgICAgICAgICBjb25zdCBnZW9kZXRpY1N1cmZhY2VOb3JtYWwgPSB0aGlzLmRlY29kZUdlb2RldGljU3VyZmFjZU5vcm1hbCgKICAgICAgICAgICAgYnVmZmVyLAogICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgc2NyYXRjaEdlb2RldGljU3VyZmFjZU5vcm1hbAogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHJhd0hlaWdodCA9IHRoaXMuZGVjb2RlSGVpZ2h0KGJ1ZmZlciwgaW5kZXgpOwogICAgICAgICAgY29uc3QgaGVpZ2h0RGlmZmVyZW5jZSA9IFZlcnRpY2FsRXhhZ2dlcmF0aW9uX2RlZmF1bHQuZ2V0SGVpZ2h0KAogICAgICAgICAgICByYXdIZWlnaHQsCiAgICAgICAgICAgIGV4YWdnZXJhdGlvbiwKICAgICAgICAgICAgZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQKICAgICAgICAgICkgLSByYXdIZWlnaHQ7CiAgICAgICAgICByZXN1bHQueCArPSBnZW9kZXRpY1N1cmZhY2VOb3JtYWwueCAqIGhlaWdodERpZmZlcmVuY2U7CiAgICAgICAgICByZXN1bHQueSArPSBnZW9kZXRpY1N1cmZhY2VOb3JtYWwueSAqIGhlaWdodERpZmZlcmVuY2U7CiAgICAgICAgICByZXN1bHQueiArPSBnZW9kZXRpY1N1cmZhY2VOb3JtYWwueiAqIGhlaWdodERpZmZlcmVuY2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZy5wcm90b3R5cGUuZGVjb2RlVGV4dHVyZUNvb3JkaW5hdGVzID0gZnVuY3Rpb24oYnVmZmVyLCBpbmRleCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBpbmRleCAqPSB0aGlzLnN0cmlkZTsKICAgICAgICBpZiAodGhpcy5xdWFudGl6YXRpb24gPT09IFRlcnJhaW5RdWFudGl6YXRpb25fZGVmYXVsdC5CSVRTMTIpIHsKICAgICAgICAgIHJldHVybiBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0LmRlY29tcHJlc3NUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICAgIGJ1ZmZlcltpbmRleCArIDJdLAogICAgICAgICAgICByZXN1bHQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUVsZW1lbnRzKGJ1ZmZlcltpbmRleCArIDRdLCBidWZmZXJbaW5kZXggKyA1XSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgVGVycmFpbkVuY29kaW5nLnByb3RvdHlwZS5kZWNvZGVIZWlnaHQgPSBmdW5jdGlvbihidWZmZXIsIGluZGV4KSB7CiAgICAgICAgaW5kZXggKj0gdGhpcy5zdHJpZGU7CiAgICAgICAgaWYgKHRoaXMucXVhbnRpemF0aW9uID09PSBUZXJyYWluUXVhbnRpemF0aW9uX2RlZmF1bHQuQklUUzEyKSB7CiAgICAgICAgICBjb25zdCB6aCA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQuZGVjb21wcmVzc1RleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgICAgYnVmZmVyW2luZGV4ICsgMV0sCiAgICAgICAgICAgIGNhcnRlc2lhbjJTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgcmV0dXJuIHpoLnkgKiAodGhpcy5tYXhpbXVtSGVpZ2h0IC0gdGhpcy5taW5pbXVtSGVpZ2h0KSArIHRoaXMubWluaW11bUhlaWdodDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGJ1ZmZlcltpbmRleCArIDNdOwogICAgICB9OwogICAgICBUZXJyYWluRW5jb2RpbmcucHJvdG90eXBlLmRlY29kZVdlYk1lcmNhdG9yVCA9IGZ1bmN0aW9uKGJ1ZmZlciwgaW5kZXgpIHsKICAgICAgICBpbmRleCAqPSB0aGlzLnN0cmlkZTsKICAgICAgICBpZiAodGhpcy5xdWFudGl6YXRpb24gPT09IFRlcnJhaW5RdWFudGl6YXRpb25fZGVmYXVsdC5CSVRTMTIpIHsKICAgICAgICAgIHJldHVybiBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0LmRlY29tcHJlc3NUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICAgIGJ1ZmZlcltpbmRleCArIDNdLAogICAgICAgICAgICBjYXJ0ZXNpYW4yU2NyYXRjaAogICAgICAgICAgKS54OwogICAgICAgIH0KICAgICAgICByZXR1cm4gYnVmZmVyW2luZGV4ICsgNl07CiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZy5wcm90b3R5cGUuZ2V0T2N0RW5jb2RlZE5vcm1hbCA9IGZ1bmN0aW9uKGJ1ZmZlciwgaW5kZXgsIHJlc3VsdCkgewogICAgICAgIGluZGV4ID0gaW5kZXggKiB0aGlzLnN0cmlkZSArIHRoaXMuX29mZnNldFZlcnRleE5vcm1hbDsKICAgICAgICBjb25zdCB0ZW1wID0gYnVmZmVyW2luZGV4XSAvIDI1NjsKICAgICAgICBjb25zdCB4ID0gTWF0aC5mbG9vcih0ZW1wKTsKICAgICAgICBjb25zdCB5ID0gKHRlbXAgLSB4KSAqIDI1NjsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21FbGVtZW50cyh4LCB5LCByZXN1bHQpOwogICAgICB9OwogICAgICBUZXJyYWluRW5jb2RpbmcucHJvdG90eXBlLmRlY29kZUdlb2RldGljU3VyZmFjZU5vcm1hbCA9IGZ1bmN0aW9uKGJ1ZmZlciwgaW5kZXgsIHJlc3VsdCkgewogICAgICAgIGluZGV4ID0gaW5kZXggKiB0aGlzLnN0cmlkZSArIHRoaXMuX29mZnNldEdlb2RldGljU3VyZmFjZU5vcm1hbDsKICAgICAgICByZXN1bHQueCA9IGJ1ZmZlcltpbmRleF07CiAgICAgICAgcmVzdWx0LnkgPSBidWZmZXJbaW5kZXggKyAxXTsKICAgICAgICByZXN1bHQueiA9IGJ1ZmZlcltpbmRleCArIDJdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZy5wcm90b3R5cGUuX2NhbGN1bGF0ZVN0cmlkZUFuZE9mZnNldHMgPSBmdW5jdGlvbigpIHsKICAgICAgICBsZXQgdmVydGV4U3RyaWRlID0gMDsKICAgICAgICBzd2l0Y2ggKHRoaXMucXVhbnRpemF0aW9uKSB7CiAgICAgICAgICBjYXNlIFRlcnJhaW5RdWFudGl6YXRpb25fZGVmYXVsdC5CSVRTMTI6CiAgICAgICAgICAgIHZlcnRleFN0cmlkZSArPSAzOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHZlcnRleFN0cmlkZSArPSA2OwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5oYXNXZWJNZXJjYXRvclQpIHsKICAgICAgICAgIHZlcnRleFN0cmlkZSArPSAxOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5oYXNWZXJ0ZXhOb3JtYWxzKSB7CiAgICAgICAgICB0aGlzLl9vZmZzZXRWZXJ0ZXhOb3JtYWwgPSB2ZXJ0ZXhTdHJpZGU7CiAgICAgICAgICB2ZXJ0ZXhTdHJpZGUgKz0gMTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuaGFzR2VvZGV0aWNTdXJmYWNlTm9ybWFscykgewogICAgICAgICAgdGhpcy5fb2Zmc2V0R2VvZGV0aWNTdXJmYWNlTm9ybWFsID0gdmVydGV4U3RyaWRlOwogICAgICAgICAgdmVydGV4U3RyaWRlICs9IDM7CiAgICAgICAgfQogICAgICAgIHRoaXMuc3RyaWRlID0gdmVydGV4U3RyaWRlOwogICAgICB9OwogICAgICBhdHRyaWJ1dGVzSW5kaWNlc05vbmUgPSB7CiAgICAgICAgcG9zaXRpb24zREFuZEhlaWdodDogMCwKICAgICAgICB0ZXh0dXJlQ29vcmRBbmRFbmNvZGVkTm9ybWFsczogMSwKICAgICAgICBnZW9kZXRpY1N1cmZhY2VOb3JtYWw6IDIKICAgICAgfTsKICAgICAgYXR0cmlidXRlc0luZGljZXNCaXRzMTIgPSB7CiAgICAgICAgY29tcHJlc3NlZDA6IDAsCiAgICAgICAgY29tcHJlc3NlZDE6IDEsCiAgICAgICAgZ2VvZGV0aWNTdXJmYWNlTm9ybWFsOiAyCiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZy5wcm90b3R5cGUuZ2V0QXR0cmlidXRlcyA9IGZ1bmN0aW9uKGJ1ZmZlcikgewogICAgICAgIGNvbnN0IGRhdGF0eXBlID0gQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVDsKICAgICAgICBjb25zdCBzaXplSW5CeXRlcyA9IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuZ2V0U2l6ZUluQnl0ZXMoZGF0YXR5cGUpOwogICAgICAgIGNvbnN0IHN0cmlkZUluQnl0ZXMgPSB0aGlzLnN0cmlkZSAqIHNpemVJbkJ5dGVzOwogICAgICAgIGxldCBvZmZzZXRJbkJ5dGVzID0gMDsKICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gW107CiAgICAgICAgZnVuY3Rpb24gYWRkQXR0cmlidXRlKGluZGV4LCBjb21wb25lbnRzUGVyQXR0cmlidXRlKSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLnB1c2goewogICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgdmVydGV4QnVmZmVyOiBidWZmZXIsCiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBkYXRhdHlwZSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZSwKICAgICAgICAgICAgb2Zmc2V0SW5CeXRlcywKICAgICAgICAgICAgc3RyaWRlSW5CeXRlcwogICAgICAgICAgfSk7CiAgICAgICAgICBvZmZzZXRJbkJ5dGVzICs9IGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUgKiBzaXplSW5CeXRlczsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMucXVhbnRpemF0aW9uID09PSBUZXJyYWluUXVhbnRpemF0aW9uX2RlZmF1bHQuTk9ORSkgewogICAgICAgICAgYWRkQXR0cmlidXRlKGF0dHJpYnV0ZXNJbmRpY2VzTm9uZS5wb3NpdGlvbjNEQW5kSGVpZ2h0LCA0KTsKICAgICAgICAgIGxldCBjb21wb25lbnRzVGV4Q29vcmRBbmROb3JtYWxzID0gMjsKICAgICAgICAgIGNvbXBvbmVudHNUZXhDb29yZEFuZE5vcm1hbHMgKz0gdGhpcy5oYXNXZWJNZXJjYXRvclQgPyAxIDogMDsKICAgICAgICAgIGNvbXBvbmVudHNUZXhDb29yZEFuZE5vcm1hbHMgKz0gdGhpcy5oYXNWZXJ0ZXhOb3JtYWxzID8gMSA6IDA7CiAgICAgICAgICBhZGRBdHRyaWJ1dGUoCiAgICAgICAgICAgIGF0dHJpYnV0ZXNJbmRpY2VzTm9uZS50ZXh0dXJlQ29vcmRBbmRFbmNvZGVkTm9ybWFscywKICAgICAgICAgICAgY29tcG9uZW50c1RleENvb3JkQW5kTm9ybWFscwogICAgICAgICAgKTsKICAgICAgICAgIGlmICh0aGlzLmhhc0dlb2RldGljU3VyZmFjZU5vcm1hbHMpIHsKICAgICAgICAgICAgYWRkQXR0cmlidXRlKGF0dHJpYnV0ZXNJbmRpY2VzTm9uZS5nZW9kZXRpY1N1cmZhY2VOb3JtYWwsIDMpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCB1c2luZ0F0dHJpYnV0ZTBDb21wb25lbnQ0ID0gdGhpcy5oYXNXZWJNZXJjYXRvclQgfHwgdGhpcy5oYXNWZXJ0ZXhOb3JtYWxzOwogICAgICAgICAgY29uc3QgdXNpbmdBdHRyaWJ1dGUxQ29tcG9uZW50MSA9IHRoaXMuaGFzV2ViTWVyY2F0b3JUICYmIHRoaXMuaGFzVmVydGV4Tm9ybWFsczsKICAgICAgICAgIGFkZEF0dHJpYnV0ZSgKICAgICAgICAgICAgYXR0cmlidXRlc0luZGljZXNCaXRzMTIuY29tcHJlc3NlZDAsCiAgICAgICAgICAgIHVzaW5nQXR0cmlidXRlMENvbXBvbmVudDQgPyA0IDogMwogICAgICAgICAgKTsKICAgICAgICAgIGlmICh1c2luZ0F0dHJpYnV0ZTFDb21wb25lbnQxKSB7CiAgICAgICAgICAgIGFkZEF0dHJpYnV0ZShhdHRyaWJ1dGVzSW5kaWNlc0JpdHMxMi5jb21wcmVzc2VkMSwgMSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy5oYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzKSB7CiAgICAgICAgICAgIGFkZEF0dHJpYnV0ZShhdHRyaWJ1dGVzSW5kaWNlc0JpdHMxMi5nZW9kZXRpY1N1cmZhY2VOb3JtYWwsIDMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gYXR0cmlidXRlczsKICAgICAgfTsKICAgICAgVGVycmFpbkVuY29kaW5nLnByb3RvdHlwZS5nZXRBdHRyaWJ1dGVMb2NhdGlvbnMgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5xdWFudGl6YXRpb24gPT09IFRlcnJhaW5RdWFudGl6YXRpb25fZGVmYXVsdC5OT05FKSB7CiAgICAgICAgICByZXR1cm4gYXR0cmlidXRlc0luZGljZXNOb25lOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXR0cmlidXRlc0luZGljZXNCaXRzMTI7CiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZy5jbG9uZSA9IGZ1bmN0aW9uKGVuY29kaW5nLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChlbmNvZGluZykpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBUZXJyYWluRW5jb2RpbmcoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnF1YW50aXphdGlvbiA9IGVuY29kaW5nLnF1YW50aXphdGlvbjsKICAgICAgICByZXN1bHQubWluaW11bUhlaWdodCA9IGVuY29kaW5nLm1pbmltdW1IZWlnaHQ7CiAgICAgICAgcmVzdWx0Lm1heGltdW1IZWlnaHQgPSBlbmNvZGluZy5tYXhpbXVtSGVpZ2h0OwogICAgICAgIHJlc3VsdC5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZW5jb2RpbmcuY2VudGVyKTsKICAgICAgICByZXN1bHQudG9TY2FsZWRFTlUgPSBNYXRyaXg0X2RlZmF1bHQuY2xvbmUoZW5jb2RpbmcudG9TY2FsZWRFTlUpOwogICAgICAgIHJlc3VsdC5mcm9tU2NhbGVkRU5VID0gTWF0cml4NF9kZWZhdWx0LmNsb25lKGVuY29kaW5nLmZyb21TY2FsZWRFTlUpOwogICAgICAgIHJlc3VsdC5tYXRyaXggPSBNYXRyaXg0X2RlZmF1bHQuY2xvbmUoZW5jb2RpbmcubWF0cml4KTsKICAgICAgICByZXN1bHQuaGFzVmVydGV4Tm9ybWFscyA9IGVuY29kaW5nLmhhc1ZlcnRleE5vcm1hbHM7CiAgICAgICAgcmVzdWx0Lmhhc1dlYk1lcmNhdG9yVCA9IGVuY29kaW5nLmhhc1dlYk1lcmNhdG9yVDsKICAgICAgICByZXN1bHQuaGFzR2VvZGV0aWNTdXJmYWNlTm9ybWFscyA9IGVuY29kaW5nLmhhc0dlb2RldGljU3VyZmFjZU5vcm1hbHM7CiAgICAgICAgcmVzdWx0LmV4YWdnZXJhdGlvbiA9IGVuY29kaW5nLmV4YWdnZXJhdGlvbjsKICAgICAgICByZXN1bHQuZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQgPSBlbmNvZGluZy5leGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodDsKICAgICAgICByZXN1bHQuX2NhbGN1bGF0ZVN0cmlkZUFuZE9mZnNldHMoKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBUZXJyYWluRW5jb2RpbmdfZGVmYXVsdCA9IFRlcnJhaW5FbmNvZGluZzsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlci5qcwogIHZhciBjcmVhdGVWZXJ0aWNlc0Zyb21Hb29nbGVFYXJ0aEVudGVycHJpc2VCdWZmZXJfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcl9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVWZXJ0aWNlc0Zyb21Hb29nbGVFYXJ0aEVudGVycHJpc2VCdWZmZXJfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGluZGV4T2ZFcHNpbG9uKGFyciwgZWxlbSwgZWxlbVR5cGUpIHsKICAgIGVsZW1UeXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxlbVR5cGUsIE1hdGhfZGVmYXVsdCk7CiAgICBjb25zdCBjb3VudCA9IGFyci5sZW5ndGg7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyArK2kpIHsKICAgICAgaWYgKGVsZW1UeXBlLmVxdWFsc0Vwc2lsb24oYXJyW2ldLCBlbGVtLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjEyKSkgewogICAgICAgIHJldHVybiBpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gLTE7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcihwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBwYXJhbWV0ZXJzLmVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKHBhcmFtZXRlcnMuZWxsaXBzb2lkKTsKICAgIHBhcmFtZXRlcnMucmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUocGFyYW1ldGVycy5yZWN0YW5nbGUpOwogICAgY29uc3Qgc3RhdGlzdGljczIgPSBwcm9jZXNzQnVmZmVyKAogICAgICBwYXJhbWV0ZXJzLmJ1ZmZlciwKICAgICAgcGFyYW1ldGVycy5yZWxhdGl2ZVRvQ2VudGVyLAogICAgICBwYXJhbWV0ZXJzLmVsbGlwc29pZCwKICAgICAgcGFyYW1ldGVycy5yZWN0YW5nbGUsCiAgICAgIHBhcmFtZXRlcnMubmF0aXZlUmVjdGFuZ2xlLAogICAgICBwYXJhbWV0ZXJzLmV4YWdnZXJhdGlvbiwKICAgICAgcGFyYW1ldGVycy5leGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodCwKICAgICAgcGFyYW1ldGVycy5za2lydEhlaWdodCwKICAgICAgcGFyYW1ldGVycy5pbmNsdWRlV2ViTWVyY2F0b3JULAogICAgICBwYXJhbWV0ZXJzLm5lZ2F0aXZlQWx0aXR1ZGVFeHBvbmVudEJpYXMsCiAgICAgIHBhcmFtZXRlcnMubmVnYXRpdmVFbGV2YXRpb25UaHJlc2hvbGQKICAgICk7CiAgICBjb25zdCB2ZXJ0aWNlcyA9IHN0YXRpc3RpY3MyLnZlcnRpY2VzOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKHZlcnRpY2VzLmJ1ZmZlcik7CiAgICBjb25zdCBpbmRpY2VzID0gc3RhdGlzdGljczIuaW5kaWNlczsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChpbmRpY2VzLmJ1ZmZlcik7CiAgICByZXR1cm4gewogICAgICB2ZXJ0aWNlczogdmVydGljZXMuYnVmZmVyLAogICAgICBpbmRpY2VzOiBpbmRpY2VzLmJ1ZmZlciwKICAgICAgbnVtYmVyT2ZBdHRyaWJ1dGVzOiBzdGF0aXN0aWNzMi5lbmNvZGluZy5zdHJpZGUsCiAgICAgIG1pbmltdW1IZWlnaHQ6IHN0YXRpc3RpY3MyLm1pbmltdW1IZWlnaHQsCiAgICAgIG1heGltdW1IZWlnaHQ6IHN0YXRpc3RpY3MyLm1heGltdW1IZWlnaHQsCiAgICAgIGJvdW5kaW5nU3BoZXJlM0Q6IHN0YXRpc3RpY3MyLmJvdW5kaW5nU3BoZXJlM0QsCiAgICAgIG9yaWVudGVkQm91bmRpbmdCb3g6IHN0YXRpc3RpY3MyLm9yaWVudGVkQm91bmRpbmdCb3gsCiAgICAgIG9jY2x1ZGVlUG9pbnRJblNjYWxlZFNwYWNlOiBzdGF0aXN0aWNzMi5vY2NsdWRlZVBvaW50SW5TY2FsZWRTcGFjZSwKICAgICAgZW5jb2Rpbmc6IHN0YXRpc3RpY3MyLmVuY29kaW5nLAogICAgICB2ZXJ0ZXhDb3VudFdpdGhvdXRTa2lydHM6IHN0YXRpc3RpY3MyLnZlcnRleENvdW50V2l0aG91dFNraXJ0cywKICAgICAgaW5kZXhDb3VudFdpdGhvdXRTa2lydHM6IHN0YXRpc3RpY3MyLmluZGV4Q291bnRXaXRob3V0U2tpcnRzLAogICAgICB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aDogc3RhdGlzdGljczIud2VzdEluZGljZXNTb3V0aFRvTm9ydGgsCiAgICAgIHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3Q6IHN0YXRpc3RpY3MyLnNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QsCiAgICAgIGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoOiBzdGF0aXN0aWNzMi5lYXN0SW5kaWNlc05vcnRoVG9Tb3V0aCwKICAgICAgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdDogc3RhdGlzdGljczIubm9ydGhJbmRpY2VzV2VzdFRvRWFzdAogICAgfTsKICB9CiAgZnVuY3Rpb24gcHJvY2Vzc0J1ZmZlcihidWZmZXIsIHJlbGF0aXZlVG9DZW50ZXIsIGVsbGlwc29pZCwgcmVjdGFuZ2xlLCBuYXRpdmVSZWN0YW5nbGUsIGV4YWdnZXJhdGlvbiwgZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQsIHNraXJ0SGVpZ2h0LCBpbmNsdWRlV2ViTWVyY2F0b3JULCBuZWdhdGl2ZUFsdGl0dWRlRXhwb25lbnRCaWFzLCBuZWdhdGl2ZUVsZXZhdGlvblRocmVzaG9sZCkgewogICAgbGV0IGdlb2dyYXBoaWNXZXN0OwogICAgbGV0IGdlb2dyYXBoaWNTb3V0aDsKICAgIGxldCBnZW9ncmFwaGljRWFzdDsKICAgIGxldCBnZW9ncmFwaGljTm9ydGg7CiAgICBsZXQgcmVjdGFuZ2xlV2lkdGgsIHJlY3RhbmdsZUhlaWdodDsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlY3RhbmdsZSkpIHsKICAgICAgZ2VvZ3JhcGhpY1dlc3QgPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKG5hdGl2ZVJlY3RhbmdsZS53ZXN0KTsKICAgICAgZ2VvZ3JhcGhpY1NvdXRoID0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhuYXRpdmVSZWN0YW5nbGUuc291dGgpOwogICAgICBnZW9ncmFwaGljRWFzdCA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMobmF0aXZlUmVjdGFuZ2xlLmVhc3QpOwogICAgICBnZW9ncmFwaGljTm9ydGggPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKG5hdGl2ZVJlY3RhbmdsZS5ub3J0aCk7CiAgICAgIHJlY3RhbmdsZVdpZHRoID0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhyZWN0YW5nbGUud2lkdGgpOwogICAgICByZWN0YW5nbGVIZWlnaHQgPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKHJlY3RhbmdsZS5oZWlnaHQpOwogICAgfSBlbHNlIHsKICAgICAgZ2VvZ3JhcGhpY1dlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgICAgZ2VvZ3JhcGhpY1NvdXRoID0gcmVjdGFuZ2xlLnNvdXRoOwogICAgICBnZW9ncmFwaGljRWFzdCA9IHJlY3RhbmdsZS5lYXN0OwogICAgICBnZW9ncmFwaGljTm9ydGggPSByZWN0YW5nbGUubm9ydGg7CiAgICAgIHJlY3RhbmdsZVdpZHRoID0gcmVjdGFuZ2xlLndpZHRoOwogICAgICByZWN0YW5nbGVIZWlnaHQgPSByZWN0YW5nbGUuaGVpZ2h0OwogICAgfQogICAgY29uc3QgcXVhZEJvcmRlckxhdGl0dWRlcyA9IFtnZW9ncmFwaGljU291dGgsIGdlb2dyYXBoaWNOb3J0aF07CiAgICBjb25zdCBxdWFkQm9yZGVyTG9uZ2l0dWRlcyA9IFtnZW9ncmFwaGljV2VzdCwgZ2VvZ3JhcGhpY0Vhc3RdOwogICAgY29uc3QgZnJvbUVOVSA9IFRyYW5zZm9ybXNfZGVmYXVsdC5lYXN0Tm9ydGhVcFRvRml4ZWRGcmFtZSgKICAgICAgcmVsYXRpdmVUb0NlbnRlciwKICAgICAgZWxsaXBzb2lkCiAgICApOwogICAgY29uc3QgdG9FTlUgPSBNYXRyaXg0X2RlZmF1bHQuaW52ZXJzZVRyYW5zZm9ybWF0aW9uKGZyb21FTlUsIG1hdHJpeDRTY3JhdGNoMyk7CiAgICBsZXQgc291dGhNZXJjYXRvclk7CiAgICBsZXQgb25lT3Zlck1lcmNhdG9ySGVpZ2h0OwogICAgaWYgKGluY2x1ZGVXZWJNZXJjYXRvclQpIHsKICAgICAgc291dGhNZXJjYXRvclkgPSBXZWJNZXJjYXRvclByb2plY3Rpb25fZGVmYXVsdC5nZW9kZXRpY0xhdGl0dWRlVG9NZXJjYXRvckFuZ2xlKAogICAgICAgIGdlb2dyYXBoaWNTb3V0aAogICAgICApOwogICAgICBvbmVPdmVyTWVyY2F0b3JIZWlnaHQgPSAxIC8gKFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0Lmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUoZ2VvZ3JhcGhpY05vcnRoKSAtIHNvdXRoTWVyY2F0b3JZKTsKICAgIH0KICAgIGNvbnN0IGhhc0V4YWdnZXJhdGlvbiA9IGV4YWdnZXJhdGlvbiAhPT0gMTsKICAgIGNvbnN0IGluY2x1ZGVHZW9kZXRpY1N1cmZhY2VOb3JtYWxzID0gaGFzRXhhZ2dlcmF0aW9uOwogICAgY29uc3QgZHYgPSBuZXcgRGF0YVZpZXcoYnVmZmVyKTsKICAgIGxldCBtaW5IZWlnaHQgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICBsZXQgbWF4SGVpZ2h0ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgY29uc3QgbWluaW11bSA9IG1pbmltdW1TY3JhdGNoOwogICAgbWluaW11bS54ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgbWluaW11bS55ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgbWluaW11bS56ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgY29uc3QgbWF4aW11bSA9IG1heGltdW1TY3JhdGNoOwogICAgbWF4aW11bS54ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgbWF4aW11bS55ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgbWF4aW11bS56ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBsZXQgc2l6ZSA9IDA7CiAgICBsZXQgaW5kaWNlc1NpemUgPSAwOwogICAgbGV0IHF1YWRTaXplOwogICAgbGV0IHF1YWQ7CiAgICBmb3IgKHF1YWQgPSAwOyBxdWFkIDwgNDsgKytxdWFkKSB7CiAgICAgIGxldCBvID0gb2Zmc2V0OwogICAgICBxdWFkU2l6ZSA9IGR2LmdldFVpbnQzMihvLCB0cnVlKTsKICAgICAgbyArPSBzaXplT2ZVaW50MzI7CiAgICAgIGNvbnN0IHggPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKGR2LmdldEZsb2F0NjQobywgdHJ1ZSkgKiAxODApOwogICAgICBvICs9IHNpemVPZkRvdWJsZTsKICAgICAgaWYgKGluZGV4T2ZFcHNpbG9uKHF1YWRCb3JkZXJMb25naXR1ZGVzLCB4KSA9PT0gLTEpIHsKICAgICAgICBxdWFkQm9yZGVyTG9uZ2l0dWRlcy5wdXNoKHgpOwogICAgICB9CiAgICAgIGNvbnN0IHkgPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKGR2LmdldEZsb2F0NjQobywgdHJ1ZSkgKiAxODApOwogICAgICBvICs9IHNpemVPZkRvdWJsZTsKICAgICAgaWYgKGluZGV4T2ZFcHNpbG9uKHF1YWRCb3JkZXJMYXRpdHVkZXMsIHkpID09PSAtMSkgewogICAgICAgIHF1YWRCb3JkZXJMYXRpdHVkZXMucHVzaCh5KTsKICAgICAgfQogICAgICBvICs9IDIgKiBzaXplT2ZEb3VibGU7CiAgICAgIGxldCBjID0gZHYuZ2V0SW50MzIobywgdHJ1ZSk7CiAgICAgIG8gKz0gc2l6ZU9mSW50MzI7CiAgICAgIHNpemUgKz0gYzsKICAgICAgYyA9IGR2LmdldEludDMyKG8sIHRydWUpOwogICAgICBpbmRpY2VzU2l6ZSArPSBjICogMzsKICAgICAgb2Zmc2V0ICs9IHF1YWRTaXplICsgc2l6ZU9mVWludDMyOwogICAgfQogICAgY29uc3QgcXVhZEJvcmRlclBvaW50cyA9IFtdOwogICAgY29uc3QgcXVhZEJvcmRlckluZGljZXMgPSBbXTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheShzaXplKTsKICAgIGNvbnN0IHV2cyA9IG5ldyBBcnJheShzaXplKTsKICAgIGNvbnN0IGhlaWdodHMgPSBuZXcgQXJyYXkoc2l6ZSk7CiAgICBjb25zdCB3ZWJNZXJjYXRvclRzID0gaW5jbHVkZVdlYk1lcmNhdG9yVCA/IG5ldyBBcnJheShzaXplKSA6IFtdOwogICAgY29uc3QgZ2VvZGV0aWNTdXJmYWNlTm9ybWFscyA9IGluY2x1ZGVHZW9kZXRpY1N1cmZhY2VOb3JtYWxzID8gbmV3IEFycmF5KHNpemUpIDogW107CiAgICBjb25zdCBpbmRpY2VzID0gbmV3IEFycmF5KGluZGljZXNTaXplKTsKICAgIGNvbnN0IHdlc3RCb3JkZXIgPSBbXTsKICAgIGNvbnN0IHNvdXRoQm9yZGVyID0gW107CiAgICBjb25zdCBlYXN0Qm9yZGVyID0gW107CiAgICBjb25zdCBub3J0aEJvcmRlciA9IFtdOwogICAgbGV0IHBvaW50T2Zmc2V0ID0gMDsKICAgIGxldCBpbmRpY2VzT2Zmc2V0ID0gMDsKICAgIG9mZnNldCA9IDA7CiAgICBmb3IgKHF1YWQgPSAwOyBxdWFkIDwgNDsgKytxdWFkKSB7CiAgICAgIHF1YWRTaXplID0gZHYuZ2V0VWludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICAgIG9mZnNldCArPSBzaXplT2ZVaW50MzI7CiAgICAgIGNvbnN0IHN0YXJ0UXVhZCA9IG9mZnNldDsKICAgICAgY29uc3Qgb3JpZ2luWCA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoZHYuZ2V0RmxvYXQ2NChvZmZzZXQsIHRydWUpICogMTgwKTsKICAgICAgb2Zmc2V0ICs9IHNpemVPZkRvdWJsZTsKICAgICAgY29uc3Qgb3JpZ2luWSA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoZHYuZ2V0RmxvYXQ2NChvZmZzZXQsIHRydWUpICogMTgwKTsKICAgICAgb2Zmc2V0ICs9IHNpemVPZkRvdWJsZTsKICAgICAgY29uc3Qgc3RlcFggPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKGR2LmdldEZsb2F0NjQob2Zmc2V0LCB0cnVlKSAqIDE4MCk7CiAgICAgIGNvbnN0IGhhbGZTdGVwWCA9IHN0ZXBYICogMC41OwogICAgICBvZmZzZXQgKz0gc2l6ZU9mRG91YmxlOwogICAgICBjb25zdCBzdGVwWSA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoZHYuZ2V0RmxvYXQ2NChvZmZzZXQsIHRydWUpICogMTgwKTsKICAgICAgY29uc3QgaGFsZlN0ZXBZID0gc3RlcFkgKiAwLjU7CiAgICAgIG9mZnNldCArPSBzaXplT2ZEb3VibGU7CiAgICAgIGNvbnN0IG51bVBvaW50cyA9IGR2LmdldEludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICAgIG9mZnNldCArPSBzaXplT2ZJbnQzMjsKICAgICAgY29uc3QgbnVtRmFjZXMgPSBkdi5nZXRJbnQzMihvZmZzZXQsIHRydWUpOwogICAgICBvZmZzZXQgKz0gc2l6ZU9mSW50MzI7CiAgICAgIG9mZnNldCArPSBzaXplT2ZJbnQzMjsKICAgICAgY29uc3QgaW5kaWNlc01hcHBpbmcgPSBuZXcgQXJyYXkobnVtUG9pbnRzKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1Qb2ludHM7ICsraSkgewogICAgICAgIGNvbnN0IGxvbmdpdHVkZSA9IG9yaWdpblggKyBkdi5nZXRVaW50OChvZmZzZXQrKykgKiBzdGVwWDsKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNy5sb25naXR1ZGUgPSBsb25naXR1ZGU7CiAgICAgICAgY29uc3QgbGF0aXR1ZGUgPSBvcmlnaW5ZICsgZHYuZ2V0VWludDgob2Zmc2V0KyspICogc3RlcFk7CiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzcubGF0aXR1ZGUgPSBsYXRpdHVkZTsKICAgICAgICBsZXQgaGVpZ2h0ID0gZHYuZ2V0RmxvYXQzMihvZmZzZXQsIHRydWUpOwogICAgICAgIG9mZnNldCArPSBzaXplT2ZGbG9hdDsKICAgICAgICBpZiAoaGVpZ2h0ICE9PSAwICYmIGhlaWdodCA8IG5lZ2F0aXZlRWxldmF0aW9uVGhyZXNob2xkKSB7CiAgICAgICAgICBoZWlnaHQgKj0gLU1hdGgucG93KDIsIG5lZ2F0aXZlQWx0aXR1ZGVFeHBvbmVudEJpYXMpOwogICAgICAgIH0KICAgICAgICBoZWlnaHQgKj0gNjM3MTAxMDsKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNy5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgaWYgKGluZGV4T2ZFcHNpbG9uKHF1YWRCb3JkZXJMb25naXR1ZGVzLCBsb25naXR1ZGUpICE9PSAtMSB8fCBpbmRleE9mRXBzaWxvbihxdWFkQm9yZGVyTGF0aXR1ZGVzLCBsYXRpdHVkZSkgIT09IC0xKSB7CiAgICAgICAgICBjb25zdCBpbmRleCA9IGluZGV4T2ZFcHNpbG9uKAogICAgICAgICAgICBxdWFkQm9yZGVyUG9pbnRzLAogICAgICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNywKICAgICAgICAgICAgQ2FydG9ncmFwaGljX2RlZmF1bHQKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoaW5kZXggPT09IC0xKSB7CiAgICAgICAgICAgIHF1YWRCb3JkZXJQb2ludHMucHVzaChDYXJ0b2dyYXBoaWNfZGVmYXVsdC5jbG9uZShzY3JhdGNoQ2FydG9ncmFwaGljNykpOwogICAgICAgICAgICBxdWFkQm9yZGVySW5kaWNlcy5wdXNoKHBvaW50T2Zmc2V0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGluZGljZXNNYXBwaW5nW2ldID0gcXVhZEJvcmRlckluZGljZXNbaW5kZXhdOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaW5kaWNlc01hcHBpbmdbaV0gPSBwb2ludE9mZnNldDsKICAgICAgICBpZiAoTWF0aC5hYnMobG9uZ2l0dWRlIC0gZ2VvZ3JhcGhpY1dlc3QpIDwgaGFsZlN0ZXBYKSB7CiAgICAgICAgICB3ZXN0Qm9yZGVyLnB1c2goewogICAgICAgICAgICBpbmRleDogcG9pbnRPZmZzZXQsCiAgICAgICAgICAgIGNhcnRvZ3JhcGhpYzogQ2FydG9ncmFwaGljX2RlZmF1bHQuY2xvbmUoc2NyYXRjaENhcnRvZ3JhcGhpYzcpCiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgaWYgKE1hdGguYWJzKGxvbmdpdHVkZSAtIGdlb2dyYXBoaWNFYXN0KSA8IGhhbGZTdGVwWCkgewogICAgICAgICAgZWFzdEJvcmRlci5wdXNoKHsKICAgICAgICAgICAgaW5kZXg6IHBvaW50T2Zmc2V0LAogICAgICAgICAgICBjYXJ0b2dyYXBoaWM6IENhcnRvZ3JhcGhpY19kZWZhdWx0LmNsb25lKHNjcmF0Y2hDYXJ0b2dyYXBoaWM3KQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmIChNYXRoLmFicyhsYXRpdHVkZSAtIGdlb2dyYXBoaWNTb3V0aCkgPCBoYWxmU3RlcFkpIHsKICAgICAgICAgIHNvdXRoQm9yZGVyLnB1c2goewogICAgICAgICAgICBpbmRleDogcG9pbnRPZmZzZXQsCiAgICAgICAgICAgIGNhcnRvZ3JhcGhpYzogQ2FydG9ncmFwaGljX2RlZmF1bHQuY2xvbmUoc2NyYXRjaENhcnRvZ3JhcGhpYzcpCiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgaWYgKE1hdGguYWJzKGxhdGl0dWRlIC0gZ2VvZ3JhcGhpY05vcnRoKSA8IGhhbGZTdGVwWSkgewogICAgICAgICAgbm9ydGhCb3JkZXIucHVzaCh7CiAgICAgICAgICAgIGluZGV4OiBwb2ludE9mZnNldCwKICAgICAgICAgICAgY2FydG9ncmFwaGljOiBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5jbG9uZShzY3JhdGNoQ2FydG9ncmFwaGljNykKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBtaW5IZWlnaHQgPSBNYXRoLm1pbihoZWlnaHQsIG1pbkhlaWdodCk7CiAgICAgICAgbWF4SGVpZ2h0ID0gTWF0aC5tYXgoaGVpZ2h0LCBtYXhIZWlnaHQpOwogICAgICAgIGhlaWdodHNbcG9pbnRPZmZzZXRdID0gaGVpZ2h0OwogICAgICAgIGNvbnN0IHBvcyA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihzY3JhdGNoQ2FydG9ncmFwaGljNyk7CiAgICAgICAgcG9zaXRpb25zW3BvaW50T2Zmc2V0XSA9IHBvczsKICAgICAgICBpZiAoaW5jbHVkZVdlYk1lcmNhdG9yVCkgewogICAgICAgICAgd2ViTWVyY2F0b3JUc1twb2ludE9mZnNldF0gPSAoV2ViTWVyY2F0b3JQcm9qZWN0aW9uX2RlZmF1bHQuZ2VvZGV0aWNMYXRpdHVkZVRvTWVyY2F0b3JBbmdsZShsYXRpdHVkZSkgLSBzb3V0aE1lcmNhdG9yWSkgKiBvbmVPdmVyTWVyY2F0b3JIZWlnaHQ7CiAgICAgICAgfQogICAgICAgIGlmIChpbmNsdWRlR2VvZGV0aWNTdXJmYWNlTm9ybWFscykgewogICAgICAgICAgY29uc3Qgbm9ybWFsMiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zKTsKICAgICAgICAgIGdlb2RldGljU3VyZmFjZU5vcm1hbHNbcG9pbnRPZmZzZXRdID0gbm9ybWFsMjsKICAgICAgICB9CiAgICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludCh0b0VOVSwgcG9zLCBzY3JhdGNoQ2FydGVzaWFuMjApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5taW5pbXVtQnlDb21wb25lbnQoc2NyYXRjaENhcnRlc2lhbjIwLCBtaW5pbXVtLCBtaW5pbXVtKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubWF4aW11bUJ5Q29tcG9uZW50KHNjcmF0Y2hDYXJ0ZXNpYW4yMCwgbWF4aW11bSwgbWF4aW11bSk7CiAgICAgICAgbGV0IHUzID0gKGxvbmdpdHVkZSAtIGdlb2dyYXBoaWNXZXN0KSAvIChnZW9ncmFwaGljRWFzdCAtIGdlb2dyYXBoaWNXZXN0KTsKICAgICAgICB1MyA9IE1hdGhfZGVmYXVsdC5jbGFtcCh1MywgMCwgMSk7CiAgICAgICAgbGV0IHYzID0gKGxhdGl0dWRlIC0gZ2VvZ3JhcGhpY1NvdXRoKSAvIChnZW9ncmFwaGljTm9ydGggLSBnZW9ncmFwaGljU291dGgpOwogICAgICAgIHYzID0gTWF0aF9kZWZhdWx0LmNsYW1wKHYzLCAwLCAxKTsKICAgICAgICB1dnNbcG9pbnRPZmZzZXRdID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCh1MywgdjMpOwogICAgICAgICsrcG9pbnRPZmZzZXQ7CiAgICAgIH0KICAgICAgY29uc3QgZmFjZXNFbGVtZW50Q291bnQgPSBudW1GYWNlcyAqIDM7CiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgZmFjZXNFbGVtZW50Q291bnQ7ICsraiwgKytpbmRpY2VzT2Zmc2V0KSB7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzT2Zmc2V0XSA9IGluZGljZXNNYXBwaW5nW2R2LmdldFVpbnQxNihvZmZzZXQsIHRydWUpXTsKICAgICAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDE2OwogICAgICB9CiAgICAgIGlmIChxdWFkU2l6ZSAhPT0gb2Zmc2V0IC0gc3RhcnRRdWFkKSB7CiAgICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJJbnZhbGlkIHRlcnJhaW4gdGlsZS4iKTsKICAgICAgfQogICAgfQogICAgcG9zaXRpb25zLmxlbmd0aCA9IHBvaW50T2Zmc2V0OwogICAgdXZzLmxlbmd0aCA9IHBvaW50T2Zmc2V0OwogICAgaGVpZ2h0cy5sZW5ndGggPSBwb2ludE9mZnNldDsKICAgIGlmIChpbmNsdWRlV2ViTWVyY2F0b3JUKSB7CiAgICAgIHdlYk1lcmNhdG9yVHMubGVuZ3RoID0gcG9pbnRPZmZzZXQ7CiAgICB9CiAgICBpZiAoaW5jbHVkZUdlb2RldGljU3VyZmFjZU5vcm1hbHMpIHsKICAgICAgZ2VvZGV0aWNTdXJmYWNlTm9ybWFscy5sZW5ndGggPSBwb2ludE9mZnNldDsKICAgIH0KICAgIGNvbnN0IHZlcnRleENvdW50V2l0aG91dFNraXJ0cyA9IHBvaW50T2Zmc2V0OwogICAgY29uc3QgaW5kZXhDb3VudFdpdGhvdXRTa2lydHMgPSBpbmRpY2VzT2Zmc2V0OwogICAgY29uc3Qgc2tpcnRPcHRpb25zID0gewogICAgICBoTWluOiBtaW5IZWlnaHQsCiAgICAgIGxhc3RCb3JkZXJQb2ludDogdm9pZCAwLAogICAgICBza2lydEhlaWdodCwKICAgICAgdG9FTlUsCiAgICAgIGVsbGlwc29pZCwKICAgICAgbWluaW11bSwKICAgICAgbWF4aW11bQogICAgfTsKICAgIHdlc3RCb3JkZXIuc29ydChmdW5jdGlvbihhMywgYikgewogICAgICByZXR1cm4gYi5jYXJ0b2dyYXBoaWMubGF0aXR1ZGUgLSBhMy5jYXJ0b2dyYXBoaWMubGF0aXR1ZGU7CiAgICB9KTsKICAgIHNvdXRoQm9yZGVyLnNvcnQoZnVuY3Rpb24oYTMsIGIpIHsKICAgICAgcmV0dXJuIGEzLmNhcnRvZ3JhcGhpYy5sb25naXR1ZGUgLSBiLmNhcnRvZ3JhcGhpYy5sb25naXR1ZGU7CiAgICB9KTsKICAgIGVhc3RCb3JkZXIuc29ydChmdW5jdGlvbihhMywgYikgewogICAgICByZXR1cm4gYTMuY2FydG9ncmFwaGljLmxhdGl0dWRlIC0gYi5jYXJ0b2dyYXBoaWMubGF0aXR1ZGU7CiAgICB9KTsKICAgIG5vcnRoQm9yZGVyLnNvcnQoZnVuY3Rpb24oYTMsIGIpIHsKICAgICAgcmV0dXJuIGIuY2FydG9ncmFwaGljLmxvbmdpdHVkZSAtIGEzLmNhcnRvZ3JhcGhpYy5sb25naXR1ZGU7CiAgICB9KTsKICAgIGNvbnN0IHBlcmNlbnRhZ2UgPSAxZS01OwogICAgYWRkU2tpcnQoCiAgICAgIHBvc2l0aW9ucywKICAgICAgaGVpZ2h0cywKICAgICAgdXZzLAogICAgICB3ZWJNZXJjYXRvclRzLAogICAgICBnZW9kZXRpY1N1cmZhY2VOb3JtYWxzLAogICAgICBpbmRpY2VzLAogICAgICBza2lydE9wdGlvbnMsCiAgICAgIHdlc3RCb3JkZXIsCiAgICAgIC1wZXJjZW50YWdlICogcmVjdGFuZ2xlV2lkdGgsCiAgICAgIHRydWUsCiAgICAgIC1wZXJjZW50YWdlICogcmVjdGFuZ2xlSGVpZ2h0CiAgICApOwogICAgYWRkU2tpcnQoCiAgICAgIHBvc2l0aW9ucywKICAgICAgaGVpZ2h0cywKICAgICAgdXZzLAogICAgICB3ZWJNZXJjYXRvclRzLAogICAgICBnZW9kZXRpY1N1cmZhY2VOb3JtYWxzLAogICAgICBpbmRpY2VzLAogICAgICBza2lydE9wdGlvbnMsCiAgICAgIHNvdXRoQm9yZGVyLAogICAgICAtcGVyY2VudGFnZSAqIHJlY3RhbmdsZUhlaWdodCwKICAgICAgZmFsc2UKICAgICk7CiAgICBhZGRTa2lydCgKICAgICAgcG9zaXRpb25zLAogICAgICBoZWlnaHRzLAogICAgICB1dnMsCiAgICAgIHdlYk1lcmNhdG9yVHMsCiAgICAgIGdlb2RldGljU3VyZmFjZU5vcm1hbHMsCiAgICAgIGluZGljZXMsCiAgICAgIHNraXJ0T3B0aW9ucywKICAgICAgZWFzdEJvcmRlciwKICAgICAgcGVyY2VudGFnZSAqIHJlY3RhbmdsZVdpZHRoLAogICAgICB0cnVlLAogICAgICBwZXJjZW50YWdlICogcmVjdGFuZ2xlSGVpZ2h0CiAgICApOwogICAgYWRkU2tpcnQoCiAgICAgIHBvc2l0aW9ucywKICAgICAgaGVpZ2h0cywKICAgICAgdXZzLAogICAgICB3ZWJNZXJjYXRvclRzLAogICAgICBnZW9kZXRpY1N1cmZhY2VOb3JtYWxzLAogICAgICBpbmRpY2VzLAogICAgICBza2lydE9wdGlvbnMsCiAgICAgIG5vcnRoQm9yZGVyLAogICAgICBwZXJjZW50YWdlICogcmVjdGFuZ2xlSGVpZ2h0LAogICAgICBmYWxzZQogICAgKTsKICAgIGlmICh3ZXN0Qm9yZGVyLmxlbmd0aCA+IDAgJiYgbm9ydGhCb3JkZXIubGVuZ3RoID4gMCkgewogICAgICBjb25zdCBmaXJzdEJvcmRlckluZGV4ID0gd2VzdEJvcmRlclswXS5pbmRleDsKICAgICAgY29uc3QgZmlyc3RTa2lydEluZGV4ID0gdmVydGV4Q291bnRXaXRob3V0U2tpcnRzOwogICAgICBjb25zdCBsYXN0Qm9yZGVySW5kZXggPSBub3J0aEJvcmRlcltub3J0aEJvcmRlci5sZW5ndGggLSAxXS5pbmRleDsKICAgICAgY29uc3QgbGFzdFNraXJ0SW5kZXggPSBwb3NpdGlvbnMubGVuZ3RoIC0gMTsKICAgICAgaW5kaWNlcy5wdXNoKAogICAgICAgIGxhc3RCb3JkZXJJbmRleCwKICAgICAgICBsYXN0U2tpcnRJbmRleCwKICAgICAgICBmaXJzdFNraXJ0SW5kZXgsCiAgICAgICAgZmlyc3RTa2lydEluZGV4LAogICAgICAgIGZpcnN0Qm9yZGVySW5kZXgsCiAgICAgICAgbGFzdEJvcmRlckluZGV4CiAgICAgICk7CiAgICB9CiAgICBzaXplID0gcG9zaXRpb25zLmxlbmd0aDsKICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlM0QgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21Qb2ludHMocG9zaXRpb25zKTsKICAgIGxldCBvcmllbnRlZEJvdW5kaW5nQm94OwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZWN0YW5nbGUpKSB7CiAgICAgIG9yaWVudGVkQm91bmRpbmdCb3ggPSBPcmllbnRlZEJvdW5kaW5nQm94X2RlZmF1bHQuZnJvbVJlY3RhbmdsZSgKICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgbWluSGVpZ2h0LAogICAgICAgIG1heEhlaWdodCwKICAgICAgICBlbGxpcHNvaWQKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IG9jY2x1ZGVyID0gbmV3IEVsbGlwc29pZGFsT2NjbHVkZXJfZGVmYXVsdChlbGxpcHNvaWQpOwogICAgY29uc3Qgb2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2UgPSBvY2NsdWRlci5jb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludFBvc3NpYmx5VW5kZXJFbGxpcHNvaWQoCiAgICAgIHJlbGF0aXZlVG9DZW50ZXIsCiAgICAgIHBvc2l0aW9ucywKICAgICAgbWluSGVpZ2h0CiAgICApOwogICAgY29uc3QgYWFCb3ggPSBuZXcgQXhpc0FsaWduZWRCb3VuZGluZ0JveF9kZWZhdWx0KG1pbmltdW0sIG1heGltdW0sIHJlbGF0aXZlVG9DZW50ZXIpOwogICAgY29uc3QgZW5jb2RpbmcgPSBuZXcgVGVycmFpbkVuY29kaW5nX2RlZmF1bHQoCiAgICAgIHJlbGF0aXZlVG9DZW50ZXIsCiAgICAgIGFhQm94LAogICAgICBza2lydE9wdGlvbnMuaE1pbiwKICAgICAgbWF4SGVpZ2h0LAogICAgICBmcm9tRU5VLAogICAgICBmYWxzZSwKICAgICAgaW5jbHVkZVdlYk1lcmNhdG9yVCwKICAgICAgaW5jbHVkZUdlb2RldGljU3VyZmFjZU5vcm1hbHMsCiAgICAgIGV4YWdnZXJhdGlvbiwKICAgICAgZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQKICAgICk7CiAgICBjb25zdCB2ZXJ0aWNlcyA9IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIGVuY29kaW5nLnN0cmlkZSk7CiAgICBsZXQgYnVmZmVySW5kZXggPSAwOwogICAgZm9yIChsZXQgayA9IDA7IGsgPCBzaXplOyArK2spIHsKICAgICAgYnVmZmVySW5kZXggPSBlbmNvZGluZy5lbmNvZGUoCiAgICAgICAgdmVydGljZXMsCiAgICAgICAgYnVmZmVySW5kZXgsCiAgICAgICAgcG9zaXRpb25zW2tdLAogICAgICAgIHV2c1trXSwKICAgICAgICBoZWlnaHRzW2tdLAogICAgICAgIHZvaWQgMCwKICAgICAgICB3ZWJNZXJjYXRvclRzW2tdLAogICAgICAgIGdlb2RldGljU3VyZmFjZU5vcm1hbHNba10KICAgICAgKTsKICAgIH0KICAgIGNvbnN0IHdlc3RJbmRpY2VzU291dGhUb05vcnRoID0gd2VzdEJvcmRlci5tYXAoZnVuY3Rpb24odmVydGV4KSB7CiAgICAgIHJldHVybiB2ZXJ0ZXguaW5kZXg7CiAgICB9KS5yZXZlcnNlKCk7CiAgICBjb25zdCBzb3V0aEluZGljZXNFYXN0VG9XZXN0ID0gc291dGhCb3JkZXIubWFwKGZ1bmN0aW9uKHZlcnRleCkgewogICAgICByZXR1cm4gdmVydGV4LmluZGV4OwogICAgfSkucmV2ZXJzZSgpOwogICAgY29uc3QgZWFzdEluZGljZXNOb3J0aFRvU291dGggPSBlYXN0Qm9yZGVyLm1hcChmdW5jdGlvbih2ZXJ0ZXgpIHsKICAgICAgcmV0dXJuIHZlcnRleC5pbmRleDsKICAgIH0pLnJldmVyc2UoKTsKICAgIGNvbnN0IG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QgPSBub3J0aEJvcmRlci5tYXAoZnVuY3Rpb24odmVydGV4KSB7CiAgICAgIHJldHVybiB2ZXJ0ZXguaW5kZXg7CiAgICB9KS5yZXZlcnNlKCk7CiAgICBzb3V0aEluZGljZXNFYXN0VG9XZXN0LnVuc2hpZnQoCiAgICAgIGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoW2Vhc3RJbmRpY2VzTm9ydGhUb1NvdXRoLmxlbmd0aCAtIDFdCiAgICApOwogICAgc291dGhJbmRpY2VzRWFzdFRvV2VzdC5wdXNoKHdlc3RJbmRpY2VzU291dGhUb05vcnRoWzBdKTsKICAgIG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QudW5zaGlmdCgKICAgICAgd2VzdEluZGljZXNTb3V0aFRvTm9ydGhbd2VzdEluZGljZXNTb3V0aFRvTm9ydGgubGVuZ3RoIC0gMV0KICAgICk7CiAgICBub3J0aEluZGljZXNXZXN0VG9FYXN0LnB1c2goZWFzdEluZGljZXNOb3J0aFRvU291dGhbMF0pOwogICAgcmV0dXJuIHsKICAgICAgdmVydGljZXMsCiAgICAgIGluZGljZXM6IG5ldyBVaW50MTZBcnJheShpbmRpY2VzKSwKICAgICAgbWF4aW11bUhlaWdodDogbWF4SGVpZ2h0LAogICAgICBtaW5pbXVtSGVpZ2h0OiBtaW5IZWlnaHQsCiAgICAgIGVuY29kaW5nLAogICAgICBib3VuZGluZ1NwaGVyZTNELAogICAgICBvcmllbnRlZEJvdW5kaW5nQm94LAogICAgICBvY2NsdWRlZVBvaW50SW5TY2FsZWRTcGFjZSwKICAgICAgdmVydGV4Q291bnRXaXRob3V0U2tpcnRzLAogICAgICBpbmRleENvdW50V2l0aG91dFNraXJ0cywKICAgICAgd2VzdEluZGljZXNTb3V0aFRvTm9ydGgsCiAgICAgIHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QsCiAgICAgIGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoLAogICAgICBub3J0aEluZGljZXNXZXN0VG9FYXN0CiAgICB9OwogIH0KICBmdW5jdGlvbiBhZGRTa2lydChwb3NpdGlvbnMsIGhlaWdodHMsIHV2cywgd2ViTWVyY2F0b3JUcywgZ2VvZGV0aWNTdXJmYWNlTm9ybWFscywgaW5kaWNlcywgc2tpcnRPcHRpb25zLCBib3JkZXJQb2ludHMsIGZ1ZGdlRmFjdG9yLCBlYXN0T3JXZXN0LCBjb3JuZXJGdWRnZSkgewogICAgY29uc3QgY291bnQgPSBib3JkZXJQb2ludHMubGVuZ3RoOwogICAgZm9yIChsZXQgaiA9IDA7IGogPCBjb3VudDsgKytqKSB7CiAgICAgIGNvbnN0IGJvcmRlclBvaW50ID0gYm9yZGVyUG9pbnRzW2pdOwogICAgICBjb25zdCBib3JkZXJDYXJ0b2dyYXBoaWMgPSBib3JkZXJQb2ludC5jYXJ0b2dyYXBoaWM7CiAgICAgIGNvbnN0IGJvcmRlckluZGV4ID0gYm9yZGVyUG9pbnQuaW5kZXg7CiAgICAgIGNvbnN0IGN1cnJlbnRJbmRleCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgIGNvbnN0IGxvbmdpdHVkZSA9IGJvcmRlckNhcnRvZ3JhcGhpYy5sb25naXR1ZGU7CiAgICAgIGxldCBsYXRpdHVkZSA9IGJvcmRlckNhcnRvZ3JhcGhpYy5sYXRpdHVkZTsKICAgICAgbGF0aXR1ZGUgPSBNYXRoX2RlZmF1bHQuY2xhbXAoCiAgICAgICAgbGF0aXR1ZGUsCiAgICAgICAgLU1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTywKICAgICAgICBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08KICAgICAgKTsKICAgICAgY29uc3QgaGVpZ2h0ID0gYm9yZGVyQ2FydG9ncmFwaGljLmhlaWdodCAtIHNraXJ0T3B0aW9ucy5za2lydEhlaWdodDsKICAgICAgc2tpcnRPcHRpb25zLmhNaW4gPSBNYXRoLm1pbihza2lydE9wdGlvbnMuaE1pbiwgaGVpZ2h0KTsKICAgICAgQ2FydG9ncmFwaGljX2RlZmF1bHQuZnJvbVJhZGlhbnMobG9uZ2l0dWRlLCBsYXRpdHVkZSwgaGVpZ2h0LCBzY3JhdGNoQ2FydG9ncmFwaGljNyk7CiAgICAgIGlmIChlYXN0T3JXZXN0KSB7CiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzcubG9uZ2l0dWRlICs9IGZ1ZGdlRmFjdG9yOwogICAgICB9CiAgICAgIGlmICghZWFzdE9yV2VzdCkgewogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWM3LmxhdGl0dWRlICs9IGZ1ZGdlRmFjdG9yOwogICAgICB9IGVsc2UgaWYgKGogPT09IGNvdW50IC0gMSkgewogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWM3LmxhdGl0dWRlICs9IGNvcm5lckZ1ZGdlOwogICAgICB9IGVsc2UgaWYgKGogPT09IDApIHsKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNy5sYXRpdHVkZSAtPSBjb3JuZXJGdWRnZTsKICAgICAgfQogICAgICBjb25zdCBwb3MgPSBza2lydE9wdGlvbnMuZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWM3CiAgICAgICk7CiAgICAgIHBvc2l0aW9ucy5wdXNoKHBvcyk7CiAgICAgIGhlaWdodHMucHVzaChoZWlnaHQpOwogICAgICB1dnMucHVzaChDYXJ0ZXNpYW4yX2RlZmF1bHQuY2xvbmUodXZzW2JvcmRlckluZGV4XSkpOwogICAgICBpZiAod2ViTWVyY2F0b3JUcy5sZW5ndGggPiAwKSB7CiAgICAgICAgd2ViTWVyY2F0b3JUcy5wdXNoKHdlYk1lcmNhdG9yVHNbYm9yZGVySW5kZXhdKTsKICAgICAgfQogICAgICBpZiAoZ2VvZGV0aWNTdXJmYWNlTm9ybWFscy5sZW5ndGggPiAwKSB7CiAgICAgICAgZ2VvZGV0aWNTdXJmYWNlTm9ybWFscy5wdXNoKGdlb2RldGljU3VyZmFjZU5vcm1hbHNbYm9yZGVySW5kZXhdKTsKICAgICAgfQogICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50KHNraXJ0T3B0aW9ucy50b0VOVSwgcG9zLCBzY3JhdGNoQ2FydGVzaWFuMjApOwogICAgICBjb25zdCBtaW5pbXVtID0gc2tpcnRPcHRpb25zLm1pbmltdW07CiAgICAgIGNvbnN0IG1heGltdW0gPSBza2lydE9wdGlvbnMubWF4aW11bTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1pbmltdW1CeUNvbXBvbmVudChzY3JhdGNoQ2FydGVzaWFuMjAsIG1pbmltdW0sIG1pbmltdW0pOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubWF4aW11bUJ5Q29tcG9uZW50KHNjcmF0Y2hDYXJ0ZXNpYW4yMCwgbWF4aW11bSwgbWF4aW11bSk7CiAgICAgIGNvbnN0IGxhc3RCb3JkZXJQb2ludCA9IHNraXJ0T3B0aW9ucy5sYXN0Qm9yZGVyUG9pbnQ7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobGFzdEJvcmRlclBvaW50KSkgewogICAgICAgIGNvbnN0IGxhc3RCb3JkZXJJbmRleCA9IGxhc3RCb3JkZXJQb2ludC5pbmRleDsKICAgICAgICBpbmRpY2VzLnB1c2goCiAgICAgICAgICBsYXN0Qm9yZGVySW5kZXgsCiAgICAgICAgICBjdXJyZW50SW5kZXggLSAxLAogICAgICAgICAgY3VycmVudEluZGV4LAogICAgICAgICAgY3VycmVudEluZGV4LAogICAgICAgICAgYm9yZGVySW5kZXgsCiAgICAgICAgICBsYXN0Qm9yZGVySW5kZXgKICAgICAgICApOwogICAgICB9CiAgICAgIHNraXJ0T3B0aW9ucy5sYXN0Qm9yZGVyUG9pbnQgPSBib3JkZXJQb2ludDsKICAgIH0KICB9CiAgdmFyIHNpemVPZlVpbnQxNiwgc2l6ZU9mSW50MzIsIHNpemVPZlVpbnQzMiwgc2l6ZU9mRmxvYXQsIHNpemVPZkRvdWJsZSwgc2NyYXRjaENhcnRvZ3JhcGhpYzcsIHNjcmF0Y2hDYXJ0ZXNpYW4yMCwgbWluaW11bVNjcmF0Y2gsIG1heGltdW1TY3JhdGNoLCBtYXRyaXg0U2NyYXRjaDMsIGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcl9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVmVydGljZXNGcm9tR29vZ2xlRWFydGhFbnRlcnByaXNlQnVmZmVyLmpzIigpIHsKICAgICAgaW5pdF9BeGlzQWxpZ25lZEJvdW5kaW5nQm94KCk7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRhbE9jY2x1ZGVyKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9PcmllbnRlZEJvdW5kaW5nQm94KCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfUnVudGltZUVycm9yKCk7CiAgICAgIGluaXRfVGVycmFpbkVuY29kaW5nKCk7CiAgICAgIGluaXRfVHJhbnNmb3JtcygpOwogICAgICBpbml0X1dlYk1lcmNhdG9yUHJvamVjdGlvbigpOwogICAgICBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKTsKICAgICAgc2l6ZU9mVWludDE2ID0gVWludDE2QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgIHNpemVPZkludDMyID0gSW50MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsKICAgICAgc2l6ZU9mVWludDMyID0gVWludDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgIHNpemVPZkZsb2F0ID0gRmxvYXQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICBzaXplT2ZEb3VibGUgPSBGbG9hdDY0QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWM3ID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4yMCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgbWluaW11bVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIG1heGltdW1TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBtYXRyaXg0U2NyYXRjaDMgPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcl9kZWZhdWx0ID0gY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0KAogICAgICAgIGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcgogICAgICApOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSGVpZ2h0bWFwRW5jb2RpbmcuanMKICB2YXIgSGVpZ2h0bWFwRW5jb2RpbmcsIEhlaWdodG1hcEVuY29kaW5nX2RlZmF1bHQ7CiAgdmFyIGluaXRfSGVpZ2h0bWFwRW5jb2RpbmcgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0hlaWdodG1hcEVuY29kaW5nLmpzIigpIHsKICAgICAgSGVpZ2h0bWFwRW5jb2RpbmcgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogTm8gZW5jb2RpbmcKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgTk9ORTogMCwKICAgICAgICAvKioKICAgICAgICAgKiBMRVJDIGVuY29kaW5nCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqCiAgICAgICAgICogQHNlZSB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL0VzcmkvbGVyY3xUaGUgTEVSQyBzcGVjaWZpY2F0aW9ufQogICAgICAgICAqLwogICAgICAgIExFUkM6IDEKICAgICAgfTsKICAgICAgSGVpZ2h0bWFwRW5jb2RpbmdfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoSGVpZ2h0bWFwRW5jb2RpbmcpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSGVpZ2h0bWFwVGVzc2VsbGF0b3IuanMKICB2YXIgSGVpZ2h0bWFwVGVzc2VsbGF0b3IsIGNhcnRlc2lhbjNTY3JhdGNoNywgbWF0cml4NFNjcmF0Y2g0LCBtaW5pbXVtU2NyYXRjaDIsIG1heGltdW1TY3JhdGNoMiwgSGVpZ2h0bWFwVGVzc2VsbGF0b3JfZGVmYXVsdDsKICB2YXIgaW5pdF9IZWlnaHRtYXBUZXNzZWxsYXRvciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSGVpZ2h0bWFwVGVzc2VsbGF0b3IuanMiKCkgewogICAgICBpbml0X0F4aXNBbGlnbmVkQm91bmRpbmdCb3goKTsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkYWxPY2NsdWRlcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIGluaXRfT3JpZW50ZWRCb3VuZGluZ0JveCgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X1RlcnJhaW5FbmNvZGluZygpOwogICAgICBpbml0X1RyYW5zZm9ybXMoKTsKICAgICAgaW5pdF9XZWJNZXJjYXRvclByb2plY3Rpb24oKTsKICAgICAgSGVpZ2h0bWFwVGVzc2VsbGF0b3IgPSB7fTsKICAgICAgSGVpZ2h0bWFwVGVzc2VsbGF0b3IuREVGQVVMVF9TVFJVQ1RVUkUgPSBPYmplY3QuZnJlZXplKHsKICAgICAgICBoZWlnaHRTY2FsZTogMSwKICAgICAgICBoZWlnaHRPZmZzZXQ6IDAsCiAgICAgICAgZWxlbWVudHNQZXJIZWlnaHQ6IDEsCiAgICAgICAgc3RyaWRlOiAxLAogICAgICAgIGVsZW1lbnRNdWx0aXBsaWVyOiAyNTYsCiAgICAgICAgaXNCaWdFbmRpYW46IGZhbHNlCiAgICAgIH0pOwogICAgICBjYXJ0ZXNpYW4zU2NyYXRjaDcgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIG1hdHJpeDRTY3JhdGNoNCA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgbWluaW11bVNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBtYXhpbXVtU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEhlaWdodG1hcFRlc3NlbGxhdG9yLmNvbXB1dGVWZXJ0aWNlcyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvcHRpb25zKSB8fCAhZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuaGVpZ2h0bWFwKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMuaGVpZ2h0bWFwIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvcHRpb25zLndpZHRoKSB8fCAhZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuaGVpZ2h0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMud2lkdGggYW5kIG9wdGlvbnMuaGVpZ2h0IGFyZSByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5uYXRpdmVSZWN0YW5nbGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5uYXRpdmVSZWN0YW5nbGUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuc2tpcnRIZWlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5za2lydEhlaWdodCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY29zNCA9IE1hdGguY29zOwogICAgICAgIGNvbnN0IHNpbjQgPSBNYXRoLnNpbjsKICAgICAgICBjb25zdCBzcXJ0MiA9IE1hdGguc3FydDsKICAgICAgICBjb25zdCBhdGFuID0gTWF0aC5hdGFuOwogICAgICAgIGNvbnN0IGV4cCA9IE1hdGguZXhwOwogICAgICAgIGNvbnN0IHBpT3ZlclR3byA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTzsKICAgICAgICBjb25zdCB0b1JhZGlhbnMgPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zOwogICAgICAgIGNvbnN0IGhlaWdodG1hcCA9IG9wdGlvbnMuaGVpZ2h0bWFwOwogICAgICAgIGNvbnN0IHdpZHRoID0gb3B0aW9ucy53aWR0aDsKICAgICAgICBjb25zdCBoZWlnaHQgPSBvcHRpb25zLmhlaWdodDsKICAgICAgICBjb25zdCBza2lydEhlaWdodCA9IG9wdGlvbnMuc2tpcnRIZWlnaHQ7CiAgICAgICAgY29uc3QgaGFzU2tpcnRzID0gc2tpcnRIZWlnaHQgPiAwOwogICAgICAgIGNvbnN0IGlzR2VvZ3JhcGhpYyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuaXNHZW9ncmFwaGljLCB0cnVlKTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgICAgIGNvbnN0IG9uZU92ZXJHbG9iZVNlbWltYWpvckF4aXMgPSAxIC8gZWxsaXBzb2lkLm1heGltdW1SYWRpdXM7CiAgICAgICAgY29uc3QgbmF0aXZlUmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUob3B0aW9ucy5uYXRpdmVSZWN0YW5nbGUpOwogICAgICAgIGNvbnN0IHJlY3RhbmdsZSA9IFJlY3RhbmdsZV9kZWZhdWx0LmNsb25lKG9wdGlvbnMucmVjdGFuZ2xlKTsKICAgICAgICBsZXQgZ2VvZ3JhcGhpY1dlc3Q7CiAgICAgICAgbGV0IGdlb2dyYXBoaWNTb3V0aDsKICAgICAgICBsZXQgZ2VvZ3JhcGhpY0Vhc3Q7CiAgICAgICAgbGV0IGdlb2dyYXBoaWNOb3J0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZWN0YW5nbGUpKSB7CiAgICAgICAgICBpZiAoaXNHZW9ncmFwaGljKSB7CiAgICAgICAgICAgIGdlb2dyYXBoaWNXZXN0ID0gdG9SYWRpYW5zKG5hdGl2ZVJlY3RhbmdsZS53ZXN0KTsKICAgICAgICAgICAgZ2VvZ3JhcGhpY1NvdXRoID0gdG9SYWRpYW5zKG5hdGl2ZVJlY3RhbmdsZS5zb3V0aCk7CiAgICAgICAgICAgIGdlb2dyYXBoaWNFYXN0ID0gdG9SYWRpYW5zKG5hdGl2ZVJlY3RhbmdsZS5lYXN0KTsKICAgICAgICAgICAgZ2VvZ3JhcGhpY05vcnRoID0gdG9SYWRpYW5zKG5hdGl2ZVJlY3RhbmdsZS5ub3J0aCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBnZW9ncmFwaGljV2VzdCA9IG5hdGl2ZVJlY3RhbmdsZS53ZXN0ICogb25lT3Zlckdsb2JlU2VtaW1ham9yQXhpczsKICAgICAgICAgICAgZ2VvZ3JhcGhpY1NvdXRoID0gcGlPdmVyVHdvIC0gMiAqIGF0YW4oZXhwKC1uYXRpdmVSZWN0YW5nbGUuc291dGggKiBvbmVPdmVyR2xvYmVTZW1pbWFqb3JBeGlzKSk7CiAgICAgICAgICAgIGdlb2dyYXBoaWNFYXN0ID0gbmF0aXZlUmVjdGFuZ2xlLmVhc3QgKiBvbmVPdmVyR2xvYmVTZW1pbWFqb3JBeGlzOwogICAgICAgICAgICBnZW9ncmFwaGljTm9ydGggPSBwaU92ZXJUd28gLSAyICogYXRhbihleHAoLW5hdGl2ZVJlY3RhbmdsZS5ub3J0aCAqIG9uZU92ZXJHbG9iZVNlbWltYWpvckF4aXMpKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZ2VvZ3JhcGhpY1dlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgICAgICAgIGdlb2dyYXBoaWNTb3V0aCA9IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgICAgIGdlb2dyYXBoaWNFYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgICBnZW9ncmFwaGljTm9ydGggPSByZWN0YW5nbGUubm9ydGg7CiAgICAgICAgfQogICAgICAgIGxldCByZWxhdGl2ZVRvQ2VudGVyID0gb3B0aW9ucy5yZWxhdGl2ZVRvQ2VudGVyOwogICAgICAgIGNvbnN0IGhhc1JlbGF0aXZlVG9DZW50ZXIgPSBkZWZpbmVkX2RlZmF1bHQocmVsYXRpdmVUb0NlbnRlcik7CiAgICAgICAgcmVsYXRpdmVUb0NlbnRlciA9IGhhc1JlbGF0aXZlVG9DZW50ZXIgPyByZWxhdGl2ZVRvQ2VudGVyIDogQ2FydGVzaWFuM19kZWZhdWx0LlpFUk87CiAgICAgICAgY29uc3QgaW5jbHVkZVdlYk1lcmNhdG9yVCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuaW5jbHVkZVdlYk1lcmNhdG9yVCwgZmFsc2UpOwogICAgICAgIGNvbnN0IGV4YWdnZXJhdGlvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZXhhZ2dlcmF0aW9uLCAxKTsKICAgICAgICBjb25zdCBleGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgb3B0aW9ucy5leGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodCwKICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIGNvbnN0IGhhc0V4YWdnZXJhdGlvbiA9IGV4YWdnZXJhdGlvbiAhPT0gMTsKICAgICAgICBjb25zdCBpbmNsdWRlR2VvZGV0aWNTdXJmYWNlTm9ybWFscyA9IGhhc0V4YWdnZXJhdGlvbjsKICAgICAgICBjb25zdCBzdHJ1Y3R1cmUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgIG9wdGlvbnMuc3RydWN0dXJlLAogICAgICAgICAgSGVpZ2h0bWFwVGVzc2VsbGF0b3IuREVGQVVMVF9TVFJVQ1RVUkUKICAgICAgICApOwogICAgICAgIGNvbnN0IGhlaWdodFNjYWxlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgICAgICBzdHJ1Y3R1cmUuaGVpZ2h0U2NhbGUsCiAgICAgICAgICBIZWlnaHRtYXBUZXNzZWxsYXRvci5ERUZBVUxUX1NUUlVDVFVSRS5oZWlnaHRTY2FsZQogICAgICAgICk7CiAgICAgICAgY29uc3QgaGVpZ2h0T2Zmc2V0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgICAgICBzdHJ1Y3R1cmUuaGVpZ2h0T2Zmc2V0LAogICAgICAgICAgSGVpZ2h0bWFwVGVzc2VsbGF0b3IuREVGQVVMVF9TVFJVQ1RVUkUuaGVpZ2h0T2Zmc2V0CiAgICAgICAgKTsKICAgICAgICBjb25zdCBlbGVtZW50c1BlckhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgc3RydWN0dXJlLmVsZW1lbnRzUGVySGVpZ2h0LAogICAgICAgICAgSGVpZ2h0bWFwVGVzc2VsbGF0b3IuREVGQVVMVF9TVFJVQ1RVUkUuZWxlbWVudHNQZXJIZWlnaHQKICAgICAgICApOwogICAgICAgIGNvbnN0IHN0cmlkZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgc3RydWN0dXJlLnN0cmlkZSwKICAgICAgICAgIEhlaWdodG1hcFRlc3NlbGxhdG9yLkRFRkFVTFRfU1RSVUNUVVJFLnN0cmlkZQogICAgICAgICk7CiAgICAgICAgY29uc3QgZWxlbWVudE11bHRpcGxpZXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgIHN0cnVjdHVyZS5lbGVtZW50TXVsdGlwbGllciwKICAgICAgICAgIEhlaWdodG1hcFRlc3NlbGxhdG9yLkRFRkFVTFRfU1RSVUNUVVJFLmVsZW1lbnRNdWx0aXBsaWVyCiAgICAgICAgKTsKICAgICAgICBjb25zdCBpc0JpZ0VuZGlhbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgc3RydWN0dXJlLmlzQmlnRW5kaWFuLAogICAgICAgICAgSGVpZ2h0bWFwVGVzc2VsbGF0b3IuREVGQVVMVF9TVFJVQ1RVUkUuaXNCaWdFbmRpYW4KICAgICAgICApOwogICAgICAgIGxldCByZWN0YW5nbGVXaWR0aCA9IFJlY3RhbmdsZV9kZWZhdWx0LmNvbXB1dGVXaWR0aChuYXRpdmVSZWN0YW5nbGUpOwogICAgICAgIGxldCByZWN0YW5nbGVIZWlnaHQgPSBSZWN0YW5nbGVfZGVmYXVsdC5jb21wdXRlSGVpZ2h0KG5hdGl2ZVJlY3RhbmdsZSk7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHlYID0gcmVjdGFuZ2xlV2lkdGggLyAod2lkdGggLSAxKTsKICAgICAgICBjb25zdCBncmFudWxhcml0eVkgPSByZWN0YW5nbGVIZWlnaHQgLyAoaGVpZ2h0IC0gMSk7CiAgICAgICAgaWYgKCFpc0dlb2dyYXBoaWMpIHsKICAgICAgICAgIHJlY3RhbmdsZVdpZHRoICo9IG9uZU92ZXJHbG9iZVNlbWltYWpvckF4aXM7CiAgICAgICAgICByZWN0YW5nbGVIZWlnaHQgKj0gb25lT3Zlckdsb2JlU2VtaW1ham9yQXhpczsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmFkaWlTcXVhcmVkID0gZWxsaXBzb2lkLnJhZGlpU3F1YXJlZDsKICAgICAgICBjb25zdCByYWRpaVNxdWFyZWRYID0gcmFkaWlTcXVhcmVkLng7CiAgICAgICAgY29uc3QgcmFkaWlTcXVhcmVkWSA9IHJhZGlpU3F1YXJlZC55OwogICAgICAgIGNvbnN0IHJhZGlpU3F1YXJlZFogPSByYWRpaVNxdWFyZWQuejsKICAgICAgICBsZXQgbWluaW11bUhlaWdodCA9IDY1NTM2OwogICAgICAgIGxldCBtYXhpbXVtSGVpZ2h0ID0gLTY1NTM2OwogICAgICAgIGNvbnN0IGZyb21FTlUgPSBUcmFuc2Zvcm1zX2RlZmF1bHQuZWFzdE5vcnRoVXBUb0ZpeGVkRnJhbWUoCiAgICAgICAgICByZWxhdGl2ZVRvQ2VudGVyLAogICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgKTsKICAgICAgICBjb25zdCB0b0VOVSA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlVHJhbnNmb3JtYXRpb24oZnJvbUVOVSwgbWF0cml4NFNjcmF0Y2g0KTsKICAgICAgICBsZXQgc291dGhNZXJjYXRvclk7CiAgICAgICAgbGV0IG9uZU92ZXJNZXJjYXRvckhlaWdodDsKICAgICAgICBpZiAoaW5jbHVkZVdlYk1lcmNhdG9yVCkgewogICAgICAgICAgc291dGhNZXJjYXRvclkgPSBXZWJNZXJjYXRvclByb2plY3Rpb25fZGVmYXVsdC5nZW9kZXRpY0xhdGl0dWRlVG9NZXJjYXRvckFuZ2xlKAogICAgICAgICAgICBnZW9ncmFwaGljU291dGgKICAgICAgICAgICk7CiAgICAgICAgICBvbmVPdmVyTWVyY2F0b3JIZWlnaHQgPSAxIC8gKFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0Lmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUoZ2VvZ3JhcGhpY05vcnRoKSAtIHNvdXRoTWVyY2F0b3JZKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbWluaW11bSA9IG1pbmltdW1TY3JhdGNoMjsKICAgICAgICBtaW5pbXVtLnggPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgICAgbWluaW11bS55ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICAgIG1pbmltdW0ueiA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgICAgICBjb25zdCBtYXhpbXVtID0gbWF4aW11bVNjcmF0Y2gyOwogICAgICAgIG1heGltdW0ueCA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgICAgICBtYXhpbXVtLnkgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgICAgbWF4aW11bS56ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgICAgIGxldCBoTWluID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICAgIGNvbnN0IGdyaWRWZXJ0ZXhDb3VudCA9IHdpZHRoICogaGVpZ2h0OwogICAgICAgIGNvbnN0IGVkZ2VWZXJ0ZXhDb3VudCA9IHNraXJ0SGVpZ2h0ID4gMCA/IHdpZHRoICogMiArIGhlaWdodCAqIDIgOiAwOwogICAgICAgIGNvbnN0IHZlcnRleENvdW50ID0gZ3JpZFZlcnRleENvdW50ICsgZWRnZVZlcnRleENvdW50OwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheSh2ZXJ0ZXhDb3VudCk7CiAgICAgICAgY29uc3QgaGVpZ2h0cyA9IG5ldyBBcnJheSh2ZXJ0ZXhDb3VudCk7CiAgICAgICAgY29uc3QgdXZzID0gbmV3IEFycmF5KHZlcnRleENvdW50KTsKICAgICAgICBjb25zdCB3ZWJNZXJjYXRvclRzID0gaW5jbHVkZVdlYk1lcmNhdG9yVCA/IG5ldyBBcnJheSh2ZXJ0ZXhDb3VudCkgOiBbXTsKICAgICAgICBjb25zdCBnZW9kZXRpY1N1cmZhY2VOb3JtYWxzID0gaW5jbHVkZUdlb2RldGljU3VyZmFjZU5vcm1hbHMgPyBuZXcgQXJyYXkodmVydGV4Q291bnQpIDogW107CiAgICAgICAgbGV0IHN0YXJ0Um93ID0gMDsKICAgICAgICBsZXQgZW5kUm93ID0gaGVpZ2h0OwogICAgICAgIGxldCBzdGFydENvbCA9IDA7CiAgICAgICAgbGV0IGVuZENvbCA9IHdpZHRoOwogICAgICAgIGlmIChoYXNTa2lydHMpIHsKICAgICAgICAgIC0tc3RhcnRSb3c7CiAgICAgICAgICArK2VuZFJvdzsKICAgICAgICAgIC0tc3RhcnRDb2w7CiAgICAgICAgICArK2VuZENvbDsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc2tpcnRPZmZzZXRQZXJjZW50YWdlID0gMWUtNTsKICAgICAgICBmb3IgKGxldCByb3dJbmRleCA9IHN0YXJ0Um93OyByb3dJbmRleCA8IGVuZFJvdzsgKytyb3dJbmRleCkgewogICAgICAgICAgbGV0IHJvdyA9IHJvd0luZGV4OwogICAgICAgICAgaWYgKHJvdyA8IDApIHsKICAgICAgICAgICAgcm93ID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyb3cgPj0gaGVpZ2h0KSB7CiAgICAgICAgICAgIHJvdyA9IGhlaWdodCAtIDE7CiAgICAgICAgICB9CiAgICAgICAgICBsZXQgbGF0aXR1ZGUgPSBuYXRpdmVSZWN0YW5nbGUubm9ydGggLSBncmFudWxhcml0eVkgKiByb3c7CiAgICAgICAgICBpZiAoIWlzR2VvZ3JhcGhpYykgewogICAgICAgICAgICBsYXRpdHVkZSA9IHBpT3ZlclR3byAtIDIgKiBhdGFuKGV4cCgtbGF0aXR1ZGUgKiBvbmVPdmVyR2xvYmVTZW1pbWFqb3JBeGlzKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsYXRpdHVkZSA9IHRvUmFkaWFucyhsYXRpdHVkZSk7CiAgICAgICAgICB9CiAgICAgICAgICBsZXQgdjMgPSAobGF0aXR1ZGUgLSBnZW9ncmFwaGljU291dGgpIC8gKGdlb2dyYXBoaWNOb3J0aCAtIGdlb2dyYXBoaWNTb3V0aCk7CiAgICAgICAgICB2MyA9IE1hdGhfZGVmYXVsdC5jbGFtcCh2MywgMCwgMSk7CiAgICAgICAgICBjb25zdCBpc05vcnRoRWRnZSA9IHJvd0luZGV4ID09PSBzdGFydFJvdzsKICAgICAgICAgIGNvbnN0IGlzU291dGhFZGdlID0gcm93SW5kZXggPT09IGVuZFJvdyAtIDE7CiAgICAgICAgICBpZiAoc2tpcnRIZWlnaHQgPiAwKSB7CiAgICAgICAgICAgIGlmIChpc05vcnRoRWRnZSkgewogICAgICAgICAgICAgIGxhdGl0dWRlICs9IHNraXJ0T2Zmc2V0UGVyY2VudGFnZSAqIHJlY3RhbmdsZUhlaWdodDsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc1NvdXRoRWRnZSkgewogICAgICAgICAgICAgIGxhdGl0dWRlIC09IHNraXJ0T2Zmc2V0UGVyY2VudGFnZSAqIHJlY3RhbmdsZUhlaWdodDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY29uc3QgY29zTGF0aXR1ZGUgPSBjb3M0KGxhdGl0dWRlKTsKICAgICAgICAgIGNvbnN0IG5aID0gc2luNChsYXRpdHVkZSk7CiAgICAgICAgICBjb25zdCBrWiA9IHJhZGlpU3F1YXJlZFogKiBuWjsKICAgICAgICAgIGxldCB3ZWJNZXJjYXRvclQ7CiAgICAgICAgICBpZiAoaW5jbHVkZVdlYk1lcmNhdG9yVCkgewogICAgICAgICAgICB3ZWJNZXJjYXRvclQgPSAoV2ViTWVyY2F0b3JQcm9qZWN0aW9uX2RlZmF1bHQuZ2VvZGV0aWNMYXRpdHVkZVRvTWVyY2F0b3JBbmdsZShsYXRpdHVkZSkgLSBzb3V0aE1lcmNhdG9yWSkgKiBvbmVPdmVyTWVyY2F0b3JIZWlnaHQ7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGxldCBjb2xJbmRleCA9IHN0YXJ0Q29sOyBjb2xJbmRleCA8IGVuZENvbDsgKytjb2xJbmRleCkgewogICAgICAgICAgICBsZXQgY29sID0gY29sSW5kZXg7CiAgICAgICAgICAgIGlmIChjb2wgPCAwKSB7CiAgICAgICAgICAgICAgY29sID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29sID49IHdpZHRoKSB7CiAgICAgICAgICAgICAgY29sID0gd2lkdGggLSAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IHRlcnJhaW5PZmZzZXQgPSByb3cgKiAod2lkdGggKiBzdHJpZGUpICsgY29sICogc3RyaWRlOwogICAgICAgICAgICBsZXQgaGVpZ2h0U2FtcGxlOwogICAgICAgICAgICBpZiAoZWxlbWVudHNQZXJIZWlnaHQgPT09IDEpIHsKICAgICAgICAgICAgICBoZWlnaHRTYW1wbGUgPSBoZWlnaHRtYXBbdGVycmFpbk9mZnNldF07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaGVpZ2h0U2FtcGxlID0gMDsKICAgICAgICAgICAgICBsZXQgZWxlbWVudE9mZnNldDsKICAgICAgICAgICAgICBpZiAoaXNCaWdFbmRpYW4pIHsKICAgICAgICAgICAgICAgIGZvciAoZWxlbWVudE9mZnNldCA9IDA7IGVsZW1lbnRPZmZzZXQgPCBlbGVtZW50c1BlckhlaWdodDsgKytlbGVtZW50T2Zmc2V0KSB7CiAgICAgICAgICAgICAgICAgIGhlaWdodFNhbXBsZSA9IGhlaWdodFNhbXBsZSAqIGVsZW1lbnRNdWx0aXBsaWVyICsgaGVpZ2h0bWFwW3RlcnJhaW5PZmZzZXQgKyBlbGVtZW50T2Zmc2V0XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZm9yIChlbGVtZW50T2Zmc2V0ID0gZWxlbWVudHNQZXJIZWlnaHQgLSAxOyBlbGVtZW50T2Zmc2V0ID49IDA7IC0tZWxlbWVudE9mZnNldCkgewogICAgICAgICAgICAgICAgICBoZWlnaHRTYW1wbGUgPSBoZWlnaHRTYW1wbGUgKiBlbGVtZW50TXVsdGlwbGllciArIGhlaWdodG1hcFt0ZXJyYWluT2Zmc2V0ICsgZWxlbWVudE9mZnNldF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGhlaWdodFNhbXBsZSA9IGhlaWdodFNhbXBsZSAqIGhlaWdodFNjYWxlICsgaGVpZ2h0T2Zmc2V0OwogICAgICAgICAgICBtYXhpbXVtSGVpZ2h0ID0gTWF0aC5tYXgobWF4aW11bUhlaWdodCwgaGVpZ2h0U2FtcGxlKTsKICAgICAgICAgICAgbWluaW11bUhlaWdodCA9IE1hdGgubWluKG1pbmltdW1IZWlnaHQsIGhlaWdodFNhbXBsZSk7CiAgICAgICAgICAgIGxldCBsb25naXR1ZGUgPSBuYXRpdmVSZWN0YW5nbGUud2VzdCArIGdyYW51bGFyaXR5WCAqIGNvbDsKICAgICAgICAgICAgaWYgKCFpc0dlb2dyYXBoaWMpIHsKICAgICAgICAgICAgICBsb25naXR1ZGUgPSBsb25naXR1ZGUgKiBvbmVPdmVyR2xvYmVTZW1pbWFqb3JBeGlzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxvbmdpdHVkZSA9IHRvUmFkaWFucyhsb25naXR1ZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCB1MyA9IChsb25naXR1ZGUgLSBnZW9ncmFwaGljV2VzdCkgLyAoZ2VvZ3JhcGhpY0Vhc3QgLSBnZW9ncmFwaGljV2VzdCk7CiAgICAgICAgICAgIHUzID0gTWF0aF9kZWZhdWx0LmNsYW1wKHUzLCAwLCAxKTsKICAgICAgICAgICAgbGV0IGluZGV4ID0gcm93ICogd2lkdGggKyBjb2w7CiAgICAgICAgICAgIGlmIChza2lydEhlaWdodCA+IDApIHsKICAgICAgICAgICAgICBjb25zdCBpc1dlc3RFZGdlID0gY29sSW5kZXggPT09IHN0YXJ0Q29sOwogICAgICAgICAgICAgIGNvbnN0IGlzRWFzdEVkZ2UgPSBjb2xJbmRleCA9PT0gZW5kQ29sIC0gMTsKICAgICAgICAgICAgICBjb25zdCBpc0VkZ2UyID0gaXNOb3J0aEVkZ2UgfHwgaXNTb3V0aEVkZ2UgfHwgaXNXZXN0RWRnZSB8fCBpc0Vhc3RFZGdlOwogICAgICAgICAgICAgIGNvbnN0IGlzQ29ybmVyID0gKGlzTm9ydGhFZGdlIHx8IGlzU291dGhFZGdlKSAmJiAoaXNXZXN0RWRnZSB8fCBpc0Vhc3RFZGdlKTsKICAgICAgICAgICAgICBpZiAoaXNDb3JuZXIpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNFZGdlMikgewogICAgICAgICAgICAgICAgaGVpZ2h0U2FtcGxlIC09IHNraXJ0SGVpZ2h0OwogICAgICAgICAgICAgICAgaWYgKGlzV2VzdEVkZ2UpIHsKICAgICAgICAgICAgICAgICAgaW5kZXggPSBncmlkVmVydGV4Q291bnQgKyAoaGVpZ2h0IC0gcm93IC0gMSk7CiAgICAgICAgICAgICAgICAgIGxvbmdpdHVkZSAtPSBza2lydE9mZnNldFBlcmNlbnRhZ2UgKiByZWN0YW5nbGVXaWR0aDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNTb3V0aEVkZ2UpIHsKICAgICAgICAgICAgICAgICAgaW5kZXggPSBncmlkVmVydGV4Q291bnQgKyBoZWlnaHQgKyAod2lkdGggLSBjb2wgLSAxKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNFYXN0RWRnZSkgewogICAgICAgICAgICAgICAgICBpbmRleCA9IGdyaWRWZXJ0ZXhDb3VudCArIGhlaWdodCArIHdpZHRoICsgcm93OwogICAgICAgICAgICAgICAgICBsb25naXR1ZGUgKz0gc2tpcnRPZmZzZXRQZXJjZW50YWdlICogcmVjdGFuZ2xlV2lkdGg7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzTm9ydGhFZGdlKSB7CiAgICAgICAgICAgICAgICAgIGluZGV4ID0gZ3JpZFZlcnRleENvdW50ICsgaGVpZ2h0ICsgd2lkdGggKyBoZWlnaHQgKyBjb2w7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IG5YID0gY29zTGF0aXR1ZGUgKiBjb3M0KGxvbmdpdHVkZSk7CiAgICAgICAgICAgIGNvbnN0IG5ZID0gY29zTGF0aXR1ZGUgKiBzaW40KGxvbmdpdHVkZSk7CiAgICAgICAgICAgIGNvbnN0IGtYID0gcmFkaWlTcXVhcmVkWCAqIG5YOwogICAgICAgICAgICBjb25zdCBrWSA9IHJhZGlpU3F1YXJlZFkgKiBuWTsKICAgICAgICAgICAgY29uc3QgZ2FtbWEgPSBzcXJ0MihrWCAqIG5YICsga1kgKiBuWSArIGtaICogblopOwogICAgICAgICAgICBjb25zdCBvbmVPdmVyR2FtbWEgPSAxIC8gZ2FtbWE7CiAgICAgICAgICAgIGNvbnN0IHJTdXJmYWNlWCA9IGtYICogb25lT3ZlckdhbW1hOwogICAgICAgICAgICBjb25zdCByU3VyZmFjZVkgPSBrWSAqIG9uZU92ZXJHYW1tYTsKICAgICAgICAgICAgY29uc3QgclN1cmZhY2VaID0ga1ogKiBvbmVPdmVyR2FtbWE7CiAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgICAgICBwb3NpdGlvbi54ID0gclN1cmZhY2VYICsgblggKiBoZWlnaHRTYW1wbGU7CiAgICAgICAgICAgIHBvc2l0aW9uLnkgPSByU3VyZmFjZVkgKyBuWSAqIGhlaWdodFNhbXBsZTsKICAgICAgICAgICAgcG9zaXRpb24ueiA9IHJTdXJmYWNlWiArIG5aICogaGVpZ2h0U2FtcGxlOwogICAgICAgICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50KHRvRU5VLCBwb3NpdGlvbiwgY2FydGVzaWFuM1NjcmF0Y2g3KTsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1pbmltdW1CeUNvbXBvbmVudChjYXJ0ZXNpYW4zU2NyYXRjaDcsIG1pbmltdW0sIG1pbmltdW0pOwogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubWF4aW11bUJ5Q29tcG9uZW50KGNhcnRlc2lhbjNTY3JhdGNoNywgbWF4aW11bSwgbWF4aW11bSk7CiAgICAgICAgICAgIGhNaW4gPSBNYXRoLm1pbihoTWluLCBoZWlnaHRTYW1wbGUpOwogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXhdID0gcG9zaXRpb247CiAgICAgICAgICAgIHV2c1tpbmRleF0gPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KHUzLCB2Myk7CiAgICAgICAgICAgIGhlaWdodHNbaW5kZXhdID0gaGVpZ2h0U2FtcGxlOwogICAgICAgICAgICBpZiAoaW5jbHVkZVdlYk1lcmNhdG9yVCkgewogICAgICAgICAgICAgIHdlYk1lcmNhdG9yVHNbaW5kZXhdID0gd2ViTWVyY2F0b3JUOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbmNsdWRlR2VvZGV0aWNTdXJmYWNlTm9ybWFscykgewogICAgICAgICAgICAgIGdlb2RldGljU3VyZmFjZU5vcm1hbHNbaW5kZXhdID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbCgKICAgICAgICAgICAgICAgIHBvc2l0aW9uCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBib3VuZGluZ1NwaGVyZTNEID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tUG9pbnRzKHBvc2l0aW9ucyk7CiAgICAgICAgbGV0IG9yaWVudGVkQm91bmRpbmdCb3g7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZWN0YW5nbGUpKSB7CiAgICAgICAgICBvcmllbnRlZEJvdW5kaW5nQm94ID0gT3JpZW50ZWRCb3VuZGluZ0JveF9kZWZhdWx0LmZyb21SZWN0YW5nbGUoCiAgICAgICAgICAgIHJlY3RhbmdsZSwKICAgICAgICAgICAgbWluaW11bUhlaWdodCwKICAgICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBsZXQgb2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2U7CiAgICAgICAgaWYgKGhhc1JlbGF0aXZlVG9DZW50ZXIpIHsKICAgICAgICAgIGNvbnN0IG9jY2x1ZGVyID0gbmV3IEVsbGlwc29pZGFsT2NjbHVkZXJfZGVmYXVsdChlbGxpcHNvaWQpOwogICAgICAgICAgb2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2UgPSBvY2NsdWRlci5jb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludFBvc3NpYmx5VW5kZXJFbGxpcHNvaWQoCiAgICAgICAgICAgIHJlbGF0aXZlVG9DZW50ZXIsCiAgICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgICAgbWluaW11bUhlaWdodAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYWFCb3ggPSBuZXcgQXhpc0FsaWduZWRCb3VuZGluZ0JveF9kZWZhdWx0KG1pbmltdW0sIG1heGltdW0sIHJlbGF0aXZlVG9DZW50ZXIpOwogICAgICAgIGNvbnN0IGVuY29kaW5nID0gbmV3IFRlcnJhaW5FbmNvZGluZ19kZWZhdWx0KAogICAgICAgICAgcmVsYXRpdmVUb0NlbnRlciwKICAgICAgICAgIGFhQm94LAogICAgICAgICAgaE1pbiwKICAgICAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgICAgICBmcm9tRU5VLAogICAgICAgICAgZmFsc2UsCiAgICAgICAgICBpbmNsdWRlV2ViTWVyY2F0b3JULAogICAgICAgICAgaW5jbHVkZUdlb2RldGljU3VyZmFjZU5vcm1hbHMsCiAgICAgICAgICBleGFnZ2VyYXRpb24sCiAgICAgICAgICBleGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodAogICAgICAgICk7CiAgICAgICAgY29uc3QgdmVydGljZXMgPSBuZXcgRmxvYXQzMkFycmF5KHZlcnRleENvdW50ICogZW5jb2Rpbmcuc3RyaWRlKTsKICAgICAgICBsZXQgYnVmZmVySW5kZXggPSAwOwogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgdmVydGV4Q291bnQ7ICsraikgewogICAgICAgICAgYnVmZmVySW5kZXggPSBlbmNvZGluZy5lbmNvZGUoCiAgICAgICAgICAgIHZlcnRpY2VzLAogICAgICAgICAgICBidWZmZXJJbmRleCwKICAgICAgICAgICAgcG9zaXRpb25zW2pdLAogICAgICAgICAgICB1dnNbal0sCiAgICAgICAgICAgIGhlaWdodHNbal0sCiAgICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgICAgd2ViTWVyY2F0b3JUc1tqXSwKICAgICAgICAgICAgZ2VvZGV0aWNTdXJmYWNlTm9ybWFsc1tqXQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHZlcnRpY2VzLAogICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgIG1pbmltdW1IZWlnaHQsCiAgICAgICAgICBlbmNvZGluZywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlM0QsCiAgICAgICAgICBvcmllbnRlZEJvdW5kaW5nQm94LAogICAgICAgICAgb2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2UKICAgICAgICB9OwogICAgICB9OwogICAgICBIZWlnaHRtYXBUZXNzZWxsYXRvcl9kZWZhdWx0ID0gSGVpZ2h0bWFwVGVzc2VsbGF0b3I7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9sZXJjL0xlcmNEZWNvZGUuanMKICB2YXIgcmVxdWlyZV9MZXJjRGVjb2RlID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL2xlcmMvTGVyY0RlY29kZS5qcyIoZXhwb3J0czIsIG1vZHVsZSkgewogICAgICAvKiBDb3B5cmlnaHQgMjAxNS0yMDE4IEVzcmkuIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdCBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAgQHByZXNlcnZlICovCiAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICB2YXIgTGVyY0RlY29kZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIENudFpJbWFnZSA9IHt9OwogICAgICAgICAgQ250WkltYWdlLmRlZmF1bHROb0RhdGFWYWx1ZSA9IC0zNDAyNzk5OTM4NzkwMTQ4NGUyMjsKICAgICAgICAgIENudFpJbWFnZS5kZWNvZGUgPSBmdW5jdGlvbihpbnB1dCwgb3B0aW9ucykgewogICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgICAgdmFyIHNraXBNYXNrID0gb3B0aW9ucy5lbmNvZGVkTWFza0RhdGEgfHwgb3B0aW9ucy5lbmNvZGVkTWFza0RhdGEgPT09IG51bGw7CiAgICAgICAgICAgIHZhciBwYXJzZWREYXRhID0gcGFyc2UoaW5wdXQsIG9wdGlvbnMuaW5wdXRPZmZzZXQgfHwgMCwgc2tpcE1hc2spOwogICAgICAgICAgICB2YXIgbm9EYXRhVmFsdWUgPSBvcHRpb25zLm5vRGF0YVZhbHVlICE9PSBudWxsID8gb3B0aW9ucy5ub0RhdGFWYWx1ZSA6IENudFpJbWFnZS5kZWZhdWx0Tm9EYXRhVmFsdWU7CiAgICAgICAgICAgIHZhciB1bmNvbXByZXNzZWREYXRhID0gdW5jb21wcmVzc1BpeGVsVmFsdWVzKAogICAgICAgICAgICAgIHBhcnNlZERhdGEsCiAgICAgICAgICAgICAgb3B0aW9ucy5waXhlbFR5cGUgfHwgRmxvYXQzMkFycmF5LAogICAgICAgICAgICAgIG9wdGlvbnMuZW5jb2RlZE1hc2tEYXRhLAogICAgICAgICAgICAgIG5vRGF0YVZhbHVlLAogICAgICAgICAgICAgIG9wdGlvbnMucmV0dXJuTWFzawogICAgICAgICAgICApOwogICAgICAgICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgICAgICAgIHdpZHRoOiBwYXJzZWREYXRhLndpZHRoLAogICAgICAgICAgICAgIGhlaWdodDogcGFyc2VkRGF0YS5oZWlnaHQsCiAgICAgICAgICAgICAgcGl4ZWxEYXRhOiB1bmNvbXByZXNzZWREYXRhLnJlc3VsdFBpeGVscywKICAgICAgICAgICAgICBtaW5WYWx1ZTogdW5jb21wcmVzc2VkRGF0YS5taW5WYWx1ZSwKICAgICAgICAgICAgICBtYXhWYWx1ZTogcGFyc2VkRGF0YS5waXhlbHMubWF4VmFsdWUsCiAgICAgICAgICAgICAgbm9EYXRhVmFsdWUKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKHVuY29tcHJlc3NlZERhdGEucmVzdWx0TWFzaykgewogICAgICAgICAgICAgIHJlc3VsdC5tYXNrRGF0YSA9IHVuY29tcHJlc3NlZERhdGEucmVzdWx0TWFzazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9ucy5yZXR1cm5FbmNvZGVkTWFzayAmJiBwYXJzZWREYXRhLm1hc2spIHsKICAgICAgICAgICAgICByZXN1bHQuZW5jb2RlZE1hc2tEYXRhID0gcGFyc2VkRGF0YS5tYXNrLmJpdHNldCA/IHBhcnNlZERhdGEubWFzay5iaXRzZXQgOiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zLnJldHVybkZpbGVJbmZvKSB7CiAgICAgICAgICAgICAgcmVzdWx0LmZpbGVJbmZvID0gZm9ybWF0RmlsZUluZm8ocGFyc2VkRGF0YSk7CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuY29tcHV0ZVVzZWRCaXREZXB0aHMpIHsKICAgICAgICAgICAgICAgIHJlc3VsdC5maWxlSW5mby5iaXREZXB0aHMgPSBjb21wdXRlVXNlZEJpdERlcHRocyhwYXJzZWREYXRhKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgdW5jb21wcmVzc1BpeGVsVmFsdWVzID0gZnVuY3Rpb24oZGF0YSwgVHlwZWRBcnJheUNsYXNzLCBtYXNrQml0c2V0LCBub0RhdGFWYWx1ZSwgc3RvcmVEZWNvZGVkTWFzaykgewogICAgICAgICAgICB2YXIgYmxvY2tJZHggPSAwOwogICAgICAgICAgICB2YXIgbnVtWCA9IGRhdGEucGl4ZWxzLm51bUJsb2Nrc1g7CiAgICAgICAgICAgIHZhciBudW1ZID0gZGF0YS5waXhlbHMubnVtQmxvY2tzWTsKICAgICAgICAgICAgdmFyIGJsb2NrV2lkdGggPSBNYXRoLmZsb29yKGRhdGEud2lkdGggLyBudW1YKTsKICAgICAgICAgICAgdmFyIGJsb2NrSGVpZ2h0ID0gTWF0aC5mbG9vcihkYXRhLmhlaWdodCAvIG51bVkpOwogICAgICAgICAgICB2YXIgc2NhbGUgPSAyICogZGF0YS5tYXhaRXJyb3I7CiAgICAgICAgICAgIHZhciBtaW5WYWx1ZSA9IE51bWJlci5NQVhfVkFMVUUsIGN1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgbWFza0JpdHNldCA9IG1hc2tCaXRzZXQgfHwgKGRhdGEubWFzayA/IGRhdGEubWFzay5iaXRzZXQgOiBudWxsKTsKICAgICAgICAgICAgdmFyIHJlc3VsdFBpeGVscywgcmVzdWx0TWFzazsKICAgICAgICAgICAgcmVzdWx0UGl4ZWxzID0gbmV3IFR5cGVkQXJyYXlDbGFzcyhkYXRhLndpZHRoICogZGF0YS5oZWlnaHQpOwogICAgICAgICAgICBpZiAoc3RvcmVEZWNvZGVkTWFzayAmJiBtYXNrQml0c2V0KSB7CiAgICAgICAgICAgICAgcmVzdWx0TWFzayA9IG5ldyBVaW50OEFycmF5KGRhdGEud2lkdGggKiBkYXRhLmhlaWdodCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGJsb2NrRGF0YUJ1ZmZlciA9IG5ldyBGbG9hdDMyQXJyYXkoYmxvY2tXaWR0aCAqIGJsb2NrSGVpZ2h0KTsKICAgICAgICAgICAgdmFyIHh4LCB5eTsKICAgICAgICAgICAgZm9yICh2YXIgeSA9IDA7IHkgPD0gbnVtWTsgeSsrKSB7CiAgICAgICAgICAgICAgdmFyIHRoaXNCbG9ja0hlaWdodCA9IHkgIT09IG51bVkgPyBibG9ja0hlaWdodCA6IGRhdGEuaGVpZ2h0ICUgbnVtWTsKICAgICAgICAgICAgICBpZiAodGhpc0Jsb2NrSGVpZ2h0ID09PSAwKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm9yICh2YXIgeCA9IDA7IHggPD0gbnVtWDsgeCsrKSB7CiAgICAgICAgICAgICAgICB2YXIgdGhpc0Jsb2NrV2lkdGggPSB4ICE9PSBudW1YID8gYmxvY2tXaWR0aCA6IGRhdGEud2lkdGggJSBudW1YOwogICAgICAgICAgICAgICAgaWYgKHRoaXNCbG9ja1dpZHRoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG91dFB0ciA9IHkgKiBkYXRhLndpZHRoICogYmxvY2tIZWlnaHQgKyB4ICogYmxvY2tXaWR0aDsKICAgICAgICAgICAgICAgIHZhciBvdXRTdHJpZGUgPSBkYXRhLndpZHRoIC0gdGhpc0Jsb2NrV2lkdGg7CiAgICAgICAgICAgICAgICB2YXIgYmxvY2sgPSBkYXRhLnBpeGVscy5ibG9ja3NbYmxvY2tJZHhdOwogICAgICAgICAgICAgICAgdmFyIGJsb2NrRGF0YSwgYmxvY2tQdHIsIGNvbnN0VmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoYmxvY2suZW5jb2RpbmcgPCAyKSB7CiAgICAgICAgICAgICAgICAgIGlmIChibG9jay5lbmNvZGluZyA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJsb2NrRGF0YSA9IGJsb2NrLnJhd0RhdGE7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdW5zdHVmZihibG9jay5zdHVmZmVkRGF0YSwgYmxvY2suYml0c1BlclBpeGVsLCBibG9jay5udW1WYWxpZFBpeGVscywgYmxvY2sub2Zmc2V0LCBzY2FsZSwgYmxvY2tEYXRhQnVmZmVyLCBkYXRhLnBpeGVscy5tYXhWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgYmxvY2tEYXRhID0gYmxvY2tEYXRhQnVmZmVyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJsb2NrUHRyID0gMDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYmxvY2suZW5jb2RpbmcgPT09IDIpIHsKICAgICAgICAgICAgICAgICAgY29uc3RWYWx1ZSA9IDA7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjb25zdFZhbHVlID0gYmxvY2sub2Zmc2V0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG1hc2tCeXRlOwogICAgICAgICAgICAgICAgaWYgKG1hc2tCaXRzZXQpIHsKICAgICAgICAgICAgICAgICAgZm9yICh5eSA9IDA7IHl5IDwgdGhpc0Jsb2NrSGVpZ2h0OyB5eSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG91dFB0ciAmIDcpIHsKICAgICAgICAgICAgICAgICAgICAgIG1hc2tCeXRlID0gbWFza0JpdHNldFtvdXRQdHIgPj4gM107CiAgICAgICAgICAgICAgICAgICAgICBtYXNrQnl0ZSA8PD0gb3V0UHRyICYgNzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZm9yICh4eCA9IDA7IHh4IDwgdGhpc0Jsb2NrV2lkdGg7IHh4KyspIHsKICAgICAgICAgICAgICAgICAgICAgIGlmICghKG91dFB0ciAmIDcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hc2tCeXRlID0gbWFza0JpdHNldFtvdXRQdHIgPj4gM107CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAobWFza0J5dGUgJiAxMjgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdE1hc2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRNYXNrW291dFB0cl0gPSAxOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9IGJsb2NrLmVuY29kaW5nIDwgMiA/IGJsb2NrRGF0YVtibG9ja1B0cisrXSA6IGNvbnN0VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIG1pblZhbHVlID0gbWluVmFsdWUgPiBjdXJyZW50VmFsdWUgPyBjdXJyZW50VmFsdWUgOiBtaW5WYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0UGl4ZWxzW291dFB0cisrXSA9IGN1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHRNYXNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0TWFza1tvdXRQdHJdID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRQaXhlbHNbb3V0UHRyKytdID0gbm9EYXRhVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBtYXNrQnl0ZSA8PD0gMTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgb3V0UHRyICs9IG91dFN0cmlkZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgaWYgKGJsb2NrLmVuY29kaW5nIDwgMikgewogICAgICAgICAgICAgICAgICAgIGZvciAoeXkgPSAwOyB5eSA8IHRoaXNCbG9ja0hlaWdodDsgeXkrKykgewogICAgICAgICAgICAgICAgICAgICAgZm9yICh4eCA9IDA7IHh4IDwgdGhpc0Jsb2NrV2lkdGg7IHh4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFZhbHVlID0gYmxvY2tEYXRhW2Jsb2NrUHRyKytdOwogICAgICAgICAgICAgICAgICAgICAgICBtaW5WYWx1ZSA9IG1pblZhbHVlID4gY3VycmVudFZhbHVlID8gY3VycmVudFZhbHVlIDogbWluVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1tvdXRQdHIrK10gPSBjdXJyZW50VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBvdXRQdHIgKz0gb3V0U3RyaWRlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtaW5WYWx1ZSA9IG1pblZhbHVlID4gY29uc3RWYWx1ZSA/IGNvbnN0VmFsdWUgOiBtaW5WYWx1ZTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHl5ID0gMDsgeXkgPCB0aGlzQmxvY2tIZWlnaHQ7IHl5KyspIHsKICAgICAgICAgICAgICAgICAgICAgIGZvciAoeHggPSAwOyB4eCA8IHRoaXNCbG9ja1dpZHRoOyB4eCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1tvdXRQdHIrK10gPSBjb25zdFZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgb3V0UHRyICs9IG91dFN0cmlkZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChibG9jay5lbmNvZGluZyA9PT0gMSAmJiBibG9ja1B0ciAhPT0gYmxvY2subnVtVmFsaWRQaXhlbHMpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgIkJsb2NrIGFuZCBNYXNrIGRvIG5vdCBtYXRjaCI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBibG9ja0lkeCsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHJlc3VsdFBpeGVscywKICAgICAgICAgICAgICByZXN1bHRNYXNrLAogICAgICAgICAgICAgIG1pblZhbHVlCiAgICAgICAgICAgIH07CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGZvcm1hdEZpbGVJbmZvID0gZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICJmaWxlSWRlbnRpZmllclN0cmluZyI6IGRhdGEuZmlsZUlkZW50aWZpZXJTdHJpbmcsCiAgICAgICAgICAgICAgImZpbGVWZXJzaW9uIjogZGF0YS5maWxlVmVyc2lvbiwKICAgICAgICAgICAgICAiaW1hZ2VUeXBlIjogZGF0YS5pbWFnZVR5cGUsCiAgICAgICAgICAgICAgImhlaWdodCI6IGRhdGEuaGVpZ2h0LAogICAgICAgICAgICAgICJ3aWR0aCI6IGRhdGEud2lkdGgsCiAgICAgICAgICAgICAgIm1heFpFcnJvciI6IGRhdGEubWF4WkVycm9yLAogICAgICAgICAgICAgICJlb2ZPZmZzZXQiOiBkYXRhLmVvZk9mZnNldCwKICAgICAgICAgICAgICAibWFzayI6IGRhdGEubWFzayA/IHsKICAgICAgICAgICAgICAgICJudW1CbG9ja3NYIjogZGF0YS5tYXNrLm51bUJsb2Nrc1gsCiAgICAgICAgICAgICAgICAibnVtQmxvY2tzWSI6IGRhdGEubWFzay5udW1CbG9ja3NZLAogICAgICAgICAgICAgICAgIm51bUJ5dGVzIjogZGF0YS5tYXNrLm51bUJ5dGVzLAogICAgICAgICAgICAgICAgIm1heFZhbHVlIjogZGF0YS5tYXNrLm1heFZhbHVlCiAgICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgICAgInBpeGVscyI6IHsKICAgICAgICAgICAgICAgICJudW1CbG9ja3NYIjogZGF0YS5waXhlbHMubnVtQmxvY2tzWCwKICAgICAgICAgICAgICAgICJudW1CbG9ja3NZIjogZGF0YS5waXhlbHMubnVtQmxvY2tzWSwKICAgICAgICAgICAgICAgICJudW1CeXRlcyI6IGRhdGEucGl4ZWxzLm51bUJ5dGVzLAogICAgICAgICAgICAgICAgIm1heFZhbHVlIjogZGF0YS5waXhlbHMubWF4VmFsdWUsCiAgICAgICAgICAgICAgICAibm9EYXRhVmFsdWUiOiBkYXRhLm5vRGF0YVZhbHVlCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb21wdXRlVXNlZEJpdERlcHRocyA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgdmFyIG51bUJsb2NrcyA9IGRhdGEucGl4ZWxzLm51bUJsb2Nrc1ggKiBkYXRhLnBpeGVscy5udW1CbG9ja3NZOwogICAgICAgICAgICB2YXIgYml0RGVwdGhzID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbnVtQmxvY2tzOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgYmxvY2sgPSBkYXRhLnBpeGVscy5ibG9ja3NbaV07CiAgICAgICAgICAgICAgaWYgKGJsb2NrLmVuY29kaW5nID09PSAwKSB7CiAgICAgICAgICAgICAgICBiaXREZXB0aHMuZmxvYXQzMiA9IHRydWU7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChibG9jay5lbmNvZGluZyA9PT0gMSkgewogICAgICAgICAgICAgICAgYml0RGVwdGhzW2Jsb2NrLmJpdHNQZXJQaXhlbF0gPSB0cnVlOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBiaXREZXB0aHNbMF0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMoYml0RGVwdGhzKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcGFyc2UgPSBmdW5jdGlvbihpbnB1dCwgZnAsIHNraXBNYXNrKSB7CiAgICAgICAgICAgIHZhciBkYXRhID0ge307CiAgICAgICAgICAgIHZhciBmaWxlSWRWaWV3ID0gbmV3IFVpbnQ4QXJyYXkoaW5wdXQsIGZwLCAxMCk7CiAgICAgICAgICAgIGRhdGEuZmlsZUlkZW50aWZpZXJTdHJpbmcgPSBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KG51bGwsIGZpbGVJZFZpZXcpOwogICAgICAgICAgICBpZiAoZGF0YS5maWxlSWRlbnRpZmllclN0cmluZy50cmltKCkgIT09ICJDbnRaSW1hZ2UiKSB7CiAgICAgICAgICAgICAgdGhyb3cgIlVuZXhwZWN0ZWQgZmlsZSBpZGVudGlmaWVyIHN0cmluZzogIiArIGRhdGEuZmlsZUlkZW50aWZpZXJTdHJpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnAgKz0gMTA7CiAgICAgICAgICAgIHZhciB2aWV3ID0gbmV3IERhdGFWaWV3KGlucHV0LCBmcCwgMjQpOwogICAgICAgICAgICBkYXRhLmZpbGVWZXJzaW9uID0gdmlldy5nZXRJbnQzMigwLCB0cnVlKTsKICAgICAgICAgICAgZGF0YS5pbWFnZVR5cGUgPSB2aWV3LmdldEludDMyKDQsIHRydWUpOwogICAgICAgICAgICBkYXRhLmhlaWdodCA9IHZpZXcuZ2V0VWludDMyKDgsIHRydWUpOwogICAgICAgICAgICBkYXRhLndpZHRoID0gdmlldy5nZXRVaW50MzIoMTIsIHRydWUpOwogICAgICAgICAgICBkYXRhLm1heFpFcnJvciA9IHZpZXcuZ2V0RmxvYXQ2NCgxNiwgdHJ1ZSk7CiAgICAgICAgICAgIGZwICs9IDI0OwogICAgICAgICAgICBpZiAoIXNraXBNYXNrKSB7CiAgICAgICAgICAgICAgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgZnAsIDE2KTsKICAgICAgICAgICAgICBkYXRhLm1hc2sgPSB7fTsKICAgICAgICAgICAgICBkYXRhLm1hc2subnVtQmxvY2tzWSA9IHZpZXcuZ2V0VWludDMyKDAsIHRydWUpOwogICAgICAgICAgICAgIGRhdGEubWFzay5udW1CbG9ja3NYID0gdmlldy5nZXRVaW50MzIoNCwgdHJ1ZSk7CiAgICAgICAgICAgICAgZGF0YS5tYXNrLm51bUJ5dGVzID0gdmlldy5nZXRVaW50MzIoOCwgdHJ1ZSk7CiAgICAgICAgICAgICAgZGF0YS5tYXNrLm1heFZhbHVlID0gdmlldy5nZXRGbG9hdDMyKDEyLCB0cnVlKTsKICAgICAgICAgICAgICBmcCArPSAxNjsKICAgICAgICAgICAgICBpZiAoZGF0YS5tYXNrLm51bUJ5dGVzID4gMCkgewogICAgICAgICAgICAgICAgdmFyIGJpdHNldCA9IG5ldyBVaW50OEFycmF5KE1hdGguY2VpbChkYXRhLndpZHRoICogZGF0YS5oZWlnaHQgLyA4KSk7CiAgICAgICAgICAgICAgICB2aWV3ID0gbmV3IERhdGFWaWV3KGlucHV0LCBmcCwgZGF0YS5tYXNrLm51bUJ5dGVzKTsKICAgICAgICAgICAgICAgIHZhciBjbnQgPSB2aWV3LmdldEludDE2KDAsIHRydWUpOwogICAgICAgICAgICAgICAgdmFyIGlwID0gMiwgb3AgPSAwOwogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICBpZiAoY250ID4gMCkgewogICAgICAgICAgICAgICAgICAgIHdoaWxlIChjbnQtLSkgewogICAgICAgICAgICAgICAgICAgICAgYml0c2V0W29wKytdID0gdmlldy5nZXRVaW50OChpcCsrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbCA9IHZpZXcuZ2V0VWludDgoaXArKyk7CiAgICAgICAgICAgICAgICAgICAgY250ID0gLWNudDsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoY250LS0pIHsKICAgICAgICAgICAgICAgICAgICAgIGJpdHNldFtvcCsrXSA9IHZhbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY250ID0gdmlldy5nZXRJbnQxNihpcCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgIGlwICs9IDI7CiAgICAgICAgICAgICAgICB9IHdoaWxlIChpcCA8IGRhdGEubWFzay5udW1CeXRlcyk7CiAgICAgICAgICAgICAgICBpZiAoY250ICE9PSAtMzI3NjggfHwgb3AgPCBiaXRzZXQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIHRocm93ICJVbmV4cGVjdGVkIGVuZCBvZiBtYXNrIFJMRSBlbmNvZGluZyI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkYXRhLm1hc2suYml0c2V0ID0gYml0c2V0OwogICAgICAgICAgICAgICAgZnAgKz0gZGF0YS5tYXNrLm51bUJ5dGVzOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGRhdGEubWFzay5udW1CeXRlcyB8IGRhdGEubWFzay5udW1CbG9ja3NZIHwgZGF0YS5tYXNrLm1heFZhbHVlKSA9PT0gMCkgewogICAgICAgICAgICAgICAgZGF0YS5tYXNrLmJpdHNldCA9IG5ldyBVaW50OEFycmF5KE1hdGguY2VpbChkYXRhLndpZHRoICogZGF0YS5oZWlnaHQgLyA4KSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZpZXcgPSBuZXcgRGF0YVZpZXcoaW5wdXQsIGZwLCAxNik7CiAgICAgICAgICAgIGRhdGEucGl4ZWxzID0ge307CiAgICAgICAgICAgIGRhdGEucGl4ZWxzLm51bUJsb2Nrc1kgPSB2aWV3LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICAgICAgZGF0YS5waXhlbHMubnVtQmxvY2tzWCA9IHZpZXcuZ2V0VWludDMyKDQsIHRydWUpOwogICAgICAgICAgICBkYXRhLnBpeGVscy5udW1CeXRlcyA9IHZpZXcuZ2V0VWludDMyKDgsIHRydWUpOwogICAgICAgICAgICBkYXRhLnBpeGVscy5tYXhWYWx1ZSA9IHZpZXcuZ2V0RmxvYXQzMigxMiwgdHJ1ZSk7CiAgICAgICAgICAgIGZwICs9IDE2OwogICAgICAgICAgICB2YXIgbnVtQmxvY2tzWCA9IGRhdGEucGl4ZWxzLm51bUJsb2Nrc1g7CiAgICAgICAgICAgIHZhciBudW1CbG9ja3NZID0gZGF0YS5waXhlbHMubnVtQmxvY2tzWTsKICAgICAgICAgICAgdmFyIGFjdHVhbE51bUJsb2Nrc1ggPSBudW1CbG9ja3NYICsgKGRhdGEud2lkdGggJSBudW1CbG9ja3NYID4gMCA/IDEgOiAwKTsKICAgICAgICAgICAgdmFyIGFjdHVhbE51bUJsb2Nrc1kgPSBudW1CbG9ja3NZICsgKGRhdGEuaGVpZ2h0ICUgbnVtQmxvY2tzWSA+IDAgPyAxIDogMCk7CiAgICAgICAgICAgIGRhdGEucGl4ZWxzLmJsb2NrcyA9IG5ldyBBcnJheShhY3R1YWxOdW1CbG9ja3NYICogYWN0dWFsTnVtQmxvY2tzWSk7CiAgICAgICAgICAgIHZhciBibG9ja0kgPSAwOwogICAgICAgICAgICBmb3IgKHZhciBibG9ja1kgPSAwOyBibG9ja1kgPCBhY3R1YWxOdW1CbG9ja3NZOyBibG9ja1krKykgewogICAgICAgICAgICAgIGZvciAodmFyIGJsb2NrWCA9IDA7IGJsb2NrWCA8IGFjdHVhbE51bUJsb2Nrc1g7IGJsb2NrWCsrKSB7CiAgICAgICAgICAgICAgICB2YXIgc2l6ZSA9IDA7CiAgICAgICAgICAgICAgICB2YXIgYnl0ZXNMZWZ0ID0gaW5wdXQuYnl0ZUxlbmd0aCAtIGZwOwogICAgICAgICAgICAgICAgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgZnAsIE1hdGgubWluKDEwLCBieXRlc0xlZnQpKTsKICAgICAgICAgICAgICAgIHZhciBibG9jayA9IHt9OwogICAgICAgICAgICAgICAgZGF0YS5waXhlbHMuYmxvY2tzW2Jsb2NrSSsrXSA9IGJsb2NrOwogICAgICAgICAgICAgICAgdmFyIGhlYWRlckJ5dGUgPSB2aWV3LmdldFVpbnQ4KDApOwogICAgICAgICAgICAgICAgc2l6ZSsrOwogICAgICAgICAgICAgICAgYmxvY2suZW5jb2RpbmcgPSBoZWFkZXJCeXRlICYgNjM7CiAgICAgICAgICAgICAgICBpZiAoYmxvY2suZW5jb2RpbmcgPiAzKSB7CiAgICAgICAgICAgICAgICAgIHRocm93ICJJbnZhbGlkIGJsb2NrIGVuY29kaW5nICgiICsgYmxvY2suZW5jb2RpbmcgKyAiKSI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoYmxvY2suZW5jb2RpbmcgPT09IDIpIHsKICAgICAgICAgICAgICAgICAgZnArKzsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaGVhZGVyQnl0ZSAhPT0gMCAmJiBoZWFkZXJCeXRlICE9PSAyKSB7CiAgICAgICAgICAgICAgICAgIGhlYWRlckJ5dGUgPj49IDY7CiAgICAgICAgICAgICAgICAgIGJsb2NrLm9mZnNldFR5cGUgPSBoZWFkZXJCeXRlOwogICAgICAgICAgICAgICAgICBpZiAoaGVhZGVyQnl0ZSA9PT0gMikgewogICAgICAgICAgICAgICAgICAgIGJsb2NrLm9mZnNldCA9IHZpZXcuZ2V0SW50OCgxKTsKICAgICAgICAgICAgICAgICAgICBzaXplKys7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGVhZGVyQnl0ZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgIGJsb2NrLm9mZnNldCA9IHZpZXcuZ2V0SW50MTYoMSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgc2l6ZSArPSAyOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhlYWRlckJ5dGUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBibG9jay5vZmZzZXQgPSB2aWV3LmdldEZsb2F0MzIoMSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgc2l6ZSArPSA0OwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRocm93ICJJbnZhbGlkIGJsb2NrIG9mZnNldCB0eXBlIjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoYmxvY2suZW5jb2RpbmcgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBoZWFkZXJCeXRlID0gdmlldy5nZXRVaW50OChzaXplKTsKICAgICAgICAgICAgICAgICAgICBzaXplKys7CiAgICAgICAgICAgICAgICAgICAgYmxvY2suYml0c1BlclBpeGVsID0gaGVhZGVyQnl0ZSAmIDYzOwogICAgICAgICAgICAgICAgICAgIGhlYWRlckJ5dGUgPj49IDY7CiAgICAgICAgICAgICAgICAgICAgYmxvY2subnVtVmFsaWRQaXhlbHNUeXBlID0gaGVhZGVyQnl0ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoaGVhZGVyQnl0ZSA9PT0gMikgewogICAgICAgICAgICAgICAgICAgICAgYmxvY2subnVtVmFsaWRQaXhlbHMgPSB2aWV3LmdldFVpbnQ4KHNpemUpOwogICAgICAgICAgICAgICAgICAgICAgc2l6ZSsrOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGVhZGVyQnl0ZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgYmxvY2subnVtVmFsaWRQaXhlbHMgPSB2aWV3LmdldFVpbnQxNihzaXplLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgIHNpemUgKz0gMjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhlYWRlckJ5dGUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgIGJsb2NrLm51bVZhbGlkUGl4ZWxzID0gdmlldy5nZXRVaW50MzIoc2l6ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICBzaXplICs9IDQ7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93ICJJbnZhbGlkIHZhbGlkIHBpeGVsIGNvdW50IHR5cGUiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZnAgKz0gc2l6ZTsKICAgICAgICAgICAgICAgIGlmIChibG9jay5lbmNvZGluZyA9PT0gMykgewogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBhcnJheUJ1Ziwgc3RvcmU4OwogICAgICAgICAgICAgICAgaWYgKGJsb2NrLmVuY29kaW5nID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIHZhciBudW1QaXhlbHMgPSAoZGF0YS5waXhlbHMubnVtQnl0ZXMgLSAxKSAvIDQ7CiAgICAgICAgICAgICAgICAgIGlmIChudW1QaXhlbHMgIT09IE1hdGguZmxvb3IobnVtUGl4ZWxzKSkgewogICAgICAgICAgICAgICAgICAgIHRocm93ICJ1bmNvbXByZXNzZWQgYmxvY2sgaGFzIGludmFsaWQgbGVuZ3RoIjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihudW1QaXhlbHMgKiA0KTsKICAgICAgICAgICAgICAgICAgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICBzdG9yZTguc2V0KG5ldyBVaW50OEFycmF5KGlucHV0LCBmcCwgbnVtUGl4ZWxzICogNCkpOwogICAgICAgICAgICAgICAgICB2YXIgcmF3RGF0YSA9IG5ldyBGbG9hdDMyQXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICBibG9jay5yYXdEYXRhID0gcmF3RGF0YTsKICAgICAgICAgICAgICAgICAgZnAgKz0gbnVtUGl4ZWxzICogNDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYmxvY2suZW5jb2RpbmcgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgdmFyIGRhdGFCeXRlcyA9IE1hdGguY2VpbChibG9jay5udW1WYWxpZFBpeGVscyAqIGJsb2NrLmJpdHNQZXJQaXhlbCAvIDgpOwogICAgICAgICAgICAgICAgICB2YXIgZGF0YVdvcmRzID0gTWF0aC5jZWlsKGRhdGFCeXRlcyAvIDQpOwogICAgICAgICAgICAgICAgICBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihkYXRhV29yZHMgKiA0KTsKICAgICAgICAgICAgICAgICAgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICBzdG9yZTguc2V0KG5ldyBVaW50OEFycmF5KGlucHV0LCBmcCwgZGF0YUJ5dGVzKSk7CiAgICAgICAgICAgICAgICAgIGJsb2NrLnN0dWZmZWREYXRhID0gbmV3IFVpbnQzMkFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgICAgZnAgKz0gZGF0YUJ5dGVzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBkYXRhLmVvZk9mZnNldCA9IGZwOwogICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgdW5zdHVmZiA9IGZ1bmN0aW9uKHNyYywgYml0c1BlclBpeGVsLCBudW1QaXhlbHMsIG9mZnNldCwgc2NhbGUsIGRlc3QsIG1heFZhbHVlKSB7CiAgICAgICAgICAgIHZhciBiaXRNYXNrID0gKDEgPDwgYml0c1BlclBpeGVsKSAtIDE7CiAgICAgICAgICAgIHZhciBpID0gMCwgbzsKICAgICAgICAgICAgdmFyIGJpdHNMZWZ0ID0gMDsKICAgICAgICAgICAgdmFyIG4sIGJ1ZmZlcjsKICAgICAgICAgICAgdmFyIG5tYXggPSBNYXRoLmNlaWwoKG1heFZhbHVlIC0gb2Zmc2V0KSAvIHNjYWxlKTsKICAgICAgICAgICAgdmFyIG51bUludmFsaWRUYWlsQnl0ZXMgPSBzcmMubGVuZ3RoICogNCAtIE1hdGguY2VpbChiaXRzUGVyUGl4ZWwgKiBudW1QaXhlbHMgLyA4KTsKICAgICAgICAgICAgc3JjW3NyYy5sZW5ndGggLSAxXSA8PD0gOCAqIG51bUludmFsaWRUYWlsQnl0ZXM7CiAgICAgICAgICAgIGZvciAobyA9IDA7IG8gPCBudW1QaXhlbHM7IG8rKykgewogICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPj0gYml0c1BlclBpeGVsKSB7CiAgICAgICAgICAgICAgICBuID0gYnVmZmVyID4+PiBiaXRzTGVmdCAtIGJpdHNQZXJQaXhlbCAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICBiaXRzTGVmdCAtPSBiaXRzUGVyUGl4ZWw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBtaXNzaW5nQml0cyA9IGJpdHNQZXJQaXhlbCAtIGJpdHNMZWZ0OwogICAgICAgICAgICAgICAgbiA9IChidWZmZXIgJiBiaXRNYXNrKSA8PCBtaXNzaW5nQml0cyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzIgLSBtaXNzaW5nQml0czsKICAgICAgICAgICAgICAgIG4gKz0gYnVmZmVyID4+PiBiaXRzTGVmdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGVzdFtvXSA9IG4gPCBubWF4ID8gb2Zmc2V0ICsgbiAqIHNjYWxlIDogbWF4VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRlc3Q7CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIENudFpJbWFnZTsKICAgICAgICB9KCk7CiAgICAgICAgdmFyIExlcmMyRGVjb2RlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgICB2YXIgQml0U3R1ZmZlciA9IHsKICAgICAgICAgICAgLy9tZXRob2RzIGVuZGluZyB3aXRoIDIgYXJlIGZvciB0aGUgbmV3IGJ5dGUgb3JkZXIgdXNlZCBieSBMZXJjMi4zIGFuZCBhYm92ZS4KICAgICAgICAgICAgLy9vcmlnaW5hbFVuc3R1ZmYgaXMgdXNlZCB0byB1bnBhY2sgSHVmZm1hbiBjb2RlIHRhYmxlLiBjb2RlIGlzIGR1cGxpY2F0ZWQgdG8gdW5zdHVmZnggZm9yIHBlcmZvcm1hbmNlIHJlYXNvbnMuCiAgICAgICAgICAgIHVuc3R1ZmY6IGZ1bmN0aW9uKHNyYywgZGVzdCwgYml0c1BlclBpeGVsLCBudW1QaXhlbHMsIGx1dEFyciwgb2Zmc2V0LCBzY2FsZSwgbWF4VmFsdWUpIHsKICAgICAgICAgICAgICB2YXIgYml0TWFzayA9ICgxIDw8IGJpdHNQZXJQaXhlbCkgLSAxOwogICAgICAgICAgICAgIHZhciBpID0gMCwgbzsKICAgICAgICAgICAgICB2YXIgYml0c0xlZnQgPSAwOwogICAgICAgICAgICAgIHZhciBuLCBidWZmZXIsIG1pc3NpbmdCaXRzLCBubWF4OwogICAgICAgICAgICAgIHZhciBudW1JbnZhbGlkVGFpbEJ5dGVzID0gc3JjLmxlbmd0aCAqIDQgLSBNYXRoLmNlaWwoYml0c1BlclBpeGVsICogbnVtUGl4ZWxzIC8gOCk7CiAgICAgICAgICAgICAgc3JjW3NyYy5sZW5ndGggLSAxXSA8PD0gOCAqIG51bUludmFsaWRUYWlsQnl0ZXM7CiAgICAgICAgICAgICAgaWYgKGx1dEFycikgewogICAgICAgICAgICAgICAgZm9yIChvID0gMDsgbyA8IG51bVBpeGVsczsgbysrKSB7CiAgICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHNyY1tpKytdOwogICAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGJpdHNMZWZ0ID49IGJpdHNQZXJQaXhlbCkgewogICAgICAgICAgICAgICAgICAgIG4gPSBidWZmZXIgPj4+IGJpdHNMZWZ0IC0gYml0c1BlclBpeGVsICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgICBiaXRzTGVmdCAtPSBiaXRzUGVyUGl4ZWw7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbWlzc2luZ0JpdHMgPSBiaXRzUGVyUGl4ZWwgLSBiaXRzTGVmdDsKICAgICAgICAgICAgICAgICAgICBuID0gKGJ1ZmZlciAmIGJpdE1hc2spIDw8IG1pc3NpbmdCaXRzICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgICAgbiArPSBidWZmZXIgPj4+IGJpdHNMZWZ0OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGRlc3Rbb10gPSBsdXRBcnJbbl07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5tYXggPSBNYXRoLmNlaWwoKG1heFZhbHVlIC0gb2Zmc2V0KSAvIHNjYWxlKTsKICAgICAgICAgICAgICAgIGZvciAobyA9IDA7IG8gPCBudW1QaXhlbHM7IG8rKykgewogICAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA+PSBiaXRzUGVyUGl4ZWwpIHsKICAgICAgICAgICAgICAgICAgICBuID0gYnVmZmVyID4+PiBiaXRzTGVmdCAtIGJpdHNQZXJQaXhlbCAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgICAgYml0c0xlZnQgLT0gYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG1pc3NpbmdCaXRzID0gYml0c1BlclBpeGVsIC0gYml0c0xlZnQ7CiAgICAgICAgICAgICAgICAgICAgbiA9IChidWZmZXIgJiBiaXRNYXNrKSA8PCBtaXNzaW5nQml0cyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgICAgYml0c0xlZnQgPSAzMiAtIG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgICAgIG4gKz0gYnVmZmVyID4+PiBiaXRzTGVmdDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBkZXN0W29dID0gbiA8IG5tYXggPyBvZmZzZXQgKyBuICogc2NhbGUgOiBtYXhWYWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3R1ZmZMVVQ6IGZ1bmN0aW9uKHNyYywgYml0c1BlclBpeGVsLCBudW1QaXhlbHMsIG9mZnNldCwgc2NhbGUsIG1heFZhbHVlKSB7CiAgICAgICAgICAgICAgdmFyIGJpdE1hc2sgPSAoMSA8PCBiaXRzUGVyUGl4ZWwpIC0gMTsKICAgICAgICAgICAgICB2YXIgaSA9IDAsIG8gPSAwLCBtaXNzaW5nQml0cyA9IDAsIGJpdHNMZWZ0ID0gMCwgbiA9IDA7CiAgICAgICAgICAgICAgdmFyIGJ1ZmZlcjsKICAgICAgICAgICAgICB2YXIgZGVzdCA9IFtdOwogICAgICAgICAgICAgIHZhciBudW1JbnZhbGlkVGFpbEJ5dGVzID0gc3JjLmxlbmd0aCAqIDQgLSBNYXRoLmNlaWwoYml0c1BlclBpeGVsICogbnVtUGl4ZWxzIC8gOCk7CiAgICAgICAgICAgICAgc3JjW3NyYy5sZW5ndGggLSAxXSA8PD0gOCAqIG51bUludmFsaWRUYWlsQnl0ZXM7CiAgICAgICAgICAgICAgdmFyIG5tYXggPSBNYXRoLmNlaWwoKG1heFZhbHVlIC0gb2Zmc2V0KSAvIHNjYWxlKTsKICAgICAgICAgICAgICBmb3IgKG8gPSAwOyBvIDwgbnVtUGl4ZWxzOyBvKyspIHsKICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgICAgYml0c0xlZnQgPSAzMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA+PSBiaXRzUGVyUGl4ZWwpIHsKICAgICAgICAgICAgICAgICAgbiA9IGJ1ZmZlciA+Pj4gYml0c0xlZnQgLSBiaXRzUGVyUGl4ZWwgJiBiaXRNYXNrOwogICAgICAgICAgICAgICAgICBiaXRzTGVmdCAtPSBiaXRzUGVyUGl4ZWw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBtaXNzaW5nQml0cyA9IGJpdHNQZXJQaXhlbCAtIGJpdHNMZWZ0OwogICAgICAgICAgICAgICAgICBuID0gKGJ1ZmZlciAmIGJpdE1hc2spIDw8IG1pc3NpbmdCaXRzICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzIgLSBtaXNzaW5nQml0czsKICAgICAgICAgICAgICAgICAgbiArPSBidWZmZXIgPj4+IGJpdHNMZWZ0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVzdFtvXSA9IG4gPCBubWF4ID8gb2Zmc2V0ICsgbiAqIHNjYWxlIDogbWF4VmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlc3QudW5zaGlmdChvZmZzZXQpOwogICAgICAgICAgICAgIHJldHVybiBkZXN0OwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0dWZmMjogZnVuY3Rpb24oc3JjLCBkZXN0LCBiaXRzUGVyUGl4ZWwsIG51bVBpeGVscywgbHV0QXJyLCBvZmZzZXQsIHNjYWxlLCBtYXhWYWx1ZSkgewogICAgICAgICAgICAgIHZhciBiaXRNYXNrID0gKDEgPDwgYml0c1BlclBpeGVsKSAtIDE7CiAgICAgICAgICAgICAgdmFyIGkgPSAwLCBvOwogICAgICAgICAgICAgIHZhciBiaXRzTGVmdCA9IDAsIGJpdFBvcyA9IDA7CiAgICAgICAgICAgICAgdmFyIG4sIGJ1ZmZlciwgbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgaWYgKGx1dEFycikgewogICAgICAgICAgICAgICAgZm9yIChvID0gMDsgbyA8IG51bVBpeGVsczsgbysrKSB7CiAgICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHNyY1tpKytdOwogICAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzI7CiAgICAgICAgICAgICAgICAgICAgYml0UG9zID0gMDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPj0gYml0c1BlclBpeGVsKSB7CiAgICAgICAgICAgICAgICAgICAgbiA9IGJ1ZmZlciA+Pj4gYml0UG9zICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgICBiaXRzTGVmdCAtPSBiaXRzUGVyUGl4ZWw7CiAgICAgICAgICAgICAgICAgICAgYml0UG9zICs9IGJpdHNQZXJQaXhlbDsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtaXNzaW5nQml0cyA9IGJpdHNQZXJQaXhlbCAtIGJpdHNMZWZ0OwogICAgICAgICAgICAgICAgICAgIG4gPSBidWZmZXIgPj4+IGJpdFBvcyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgICAgYml0c0xlZnQgPSAzMiAtIG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgICAgIG4gfD0gKGJ1ZmZlciAmICgxIDw8IG1pc3NpbmdCaXRzKSAtIDEpIDw8IGJpdHNQZXJQaXhlbCAtIG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgICAgIGJpdFBvcyA9IG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGRlc3Rbb10gPSBsdXRBcnJbbl07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBubWF4ID0gTWF0aC5jZWlsKChtYXhWYWx1ZSAtIG9mZnNldCkgLyBzY2FsZSk7CiAgICAgICAgICAgICAgICBmb3IgKG8gPSAwOyBvIDwgbnVtUGl4ZWxzOyBvKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKGJpdHNMZWZ0ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgICAgYml0c0xlZnQgPSAzMjsKICAgICAgICAgICAgICAgICAgICBiaXRQb3MgPSAwOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA+PSBiaXRzUGVyUGl4ZWwpIHsKICAgICAgICAgICAgICAgICAgICBuID0gYnVmZmVyID4+PiBiaXRQb3MgJiBiaXRNYXNrOwogICAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0IC09IGJpdHNQZXJQaXhlbDsKICAgICAgICAgICAgICAgICAgICBiaXRQb3MgKz0gYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG1pc3NpbmdCaXRzID0gYml0c1BlclBpeGVsIC0gYml0c0xlZnQ7CiAgICAgICAgICAgICAgICAgICAgbiA9IGJ1ZmZlciA+Pj4gYml0UG9zICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgICAgbiB8PSAoYnVmZmVyICYgKDEgPDwgbWlzc2luZ0JpdHMpIC0gMSkgPDwgYml0c1BlclBpeGVsIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0UG9zID0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGVzdFtvXSA9IG4gPCBubWF4ID8gb2Zmc2V0ICsgbiAqIHNjYWxlIDogbWF4VmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBkZXN0OwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0dWZmTFVUMjogZnVuY3Rpb24oc3JjLCBiaXRzUGVyUGl4ZWwsIG51bVBpeGVscywgb2Zmc2V0LCBzY2FsZSwgbWF4VmFsdWUpIHsKICAgICAgICAgICAgICB2YXIgYml0TWFzayA9ICgxIDw8IGJpdHNQZXJQaXhlbCkgLSAxOwogICAgICAgICAgICAgIHZhciBpID0gMCwgbyA9IDAsIG1pc3NpbmdCaXRzID0gMCwgYml0c0xlZnQgPSAwLCBuID0gMCwgYml0UG9zID0gMDsKICAgICAgICAgICAgICB2YXIgYnVmZmVyOwogICAgICAgICAgICAgIHZhciBkZXN0ID0gW107CiAgICAgICAgICAgICAgdmFyIG5tYXggPSBNYXRoLmNlaWwoKG1heFZhbHVlIC0gb2Zmc2V0KSAvIHNjYWxlKTsKICAgICAgICAgICAgICBmb3IgKG8gPSAwOyBvIDwgbnVtUGl4ZWxzOyBvKyspIHsKICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgICAgYml0c0xlZnQgPSAzMjsKICAgICAgICAgICAgICAgICAgYml0UG9zID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA+PSBiaXRzUGVyUGl4ZWwpIHsKICAgICAgICAgICAgICAgICAgbiA9IGJ1ZmZlciA+Pj4gYml0UG9zICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgYml0c0xlZnQgLT0gYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgICBiaXRQb3MgKz0gYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbWlzc2luZ0JpdHMgPSBiaXRzUGVyUGl4ZWwgLSBiaXRzTGVmdDsKICAgICAgICAgICAgICAgICAgbiA9IGJ1ZmZlciA+Pj4gYml0UG9zICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzIgLSBtaXNzaW5nQml0czsKICAgICAgICAgICAgICAgICAgbiB8PSAoYnVmZmVyICYgKDEgPDwgbWlzc2luZ0JpdHMpIC0gMSkgPDwgYml0c1BlclBpeGVsIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgIGJpdFBvcyA9IG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVzdFtvXSA9IG4gPCBubWF4ID8gb2Zmc2V0ICsgbiAqIHNjYWxlIDogbWF4VmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlc3QudW5zaGlmdChvZmZzZXQpOwogICAgICAgICAgICAgIHJldHVybiBkZXN0OwogICAgICAgICAgICB9LAogICAgICAgICAgICBvcmlnaW5hbFVuc3R1ZmY6IGZ1bmN0aW9uKHNyYywgZGVzdCwgYml0c1BlclBpeGVsLCBudW1QaXhlbHMpIHsKICAgICAgICAgICAgICB2YXIgYml0TWFzayA9ICgxIDw8IGJpdHNQZXJQaXhlbCkgLSAxOwogICAgICAgICAgICAgIHZhciBpID0gMCwgbzsKICAgICAgICAgICAgICB2YXIgYml0c0xlZnQgPSAwOwogICAgICAgICAgICAgIHZhciBuLCBidWZmZXIsIG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgIHZhciBudW1JbnZhbGlkVGFpbEJ5dGVzID0gc3JjLmxlbmd0aCAqIDQgLSBNYXRoLmNlaWwoYml0c1BlclBpeGVsICogbnVtUGl4ZWxzIC8gOCk7CiAgICAgICAgICAgICAgc3JjW3NyYy5sZW5ndGggLSAxXSA8PD0gOCAqIG51bUludmFsaWRUYWlsQnl0ZXM7CiAgICAgICAgICAgICAgZm9yIChvID0gMDsgbyA8IG51bVBpeGVsczsgbysrKSB7CiAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPj0gYml0c1BlclBpeGVsKSB7CiAgICAgICAgICAgICAgICAgIG4gPSBidWZmZXIgPj4+IGJpdHNMZWZ0IC0gYml0c1BlclBpeGVsICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgYml0c0xlZnQgLT0gYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbWlzc2luZ0JpdHMgPSBiaXRzUGVyUGl4ZWwgLSBiaXRzTGVmdDsKICAgICAgICAgICAgICAgICAgbiA9IChidWZmZXIgJiBiaXRNYXNrKSA8PCBtaXNzaW5nQml0cyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHNyY1tpKytdOwogICAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgIG4gKz0gYnVmZmVyID4+PiBiaXRzTGVmdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlc3Rbb10gPSBuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZGVzdDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb3JpZ2luYWxVbnN0dWZmMjogZnVuY3Rpb24oc3JjLCBkZXN0LCBiaXRzUGVyUGl4ZWwsIG51bVBpeGVscykgewogICAgICAgICAgICAgIHZhciBiaXRNYXNrID0gKDEgPDwgYml0c1BlclBpeGVsKSAtIDE7CiAgICAgICAgICAgICAgdmFyIGkgPSAwLCBvOwogICAgICAgICAgICAgIHZhciBiaXRzTGVmdCA9IDAsIGJpdFBvcyA9IDA7CiAgICAgICAgICAgICAgdmFyIG4sIGJ1ZmZlciwgbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgZm9yIChvID0gMDsgbyA8IG51bVBpeGVsczsgbysrKSB7CiAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzI7CiAgICAgICAgICAgICAgICAgIGJpdFBvcyA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPj0gYml0c1BlclBpeGVsKSB7CiAgICAgICAgICAgICAgICAgIG4gPSBidWZmZXIgPj4+IGJpdFBvcyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0IC09IGJpdHNQZXJQaXhlbDsKICAgICAgICAgICAgICAgICAgYml0UG9zICs9IGJpdHNQZXJQaXhlbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG1pc3NpbmdCaXRzID0gYml0c1BlclBpeGVsIC0gYml0c0xlZnQ7CiAgICAgICAgICAgICAgICAgIG4gPSBidWZmZXIgPj4+IGJpdFBvcyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHNyY1tpKytdOwogICAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgIG4gfD0gKGJ1ZmZlciAmICgxIDw8IG1pc3NpbmdCaXRzKSAtIDEpIDw8IGJpdHNQZXJQaXhlbCAtIG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgICBiaXRQb3MgPSBtaXNzaW5nQml0czsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlc3Rbb10gPSBuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZGVzdDsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBMZXJjMkhlbHBlcnMgPSB7CiAgICAgICAgICAgIEhVRkZNQU5fTFVUX0JJVFNfTUFYOiAxMiwKICAgICAgICAgICAgLy91c2UgMl4xMiBsdXQsIHRyZWF0IGl0IGxpa2UgY29uc3RhbnQKICAgICAgICAgICAgY29tcHV0ZUNoZWNrc3VtRmxldGNoZXIzMjogZnVuY3Rpb24oaW5wdXQpIHsKICAgICAgICAgICAgICB2YXIgc3VtMSA9IDY1NTM1LCBzdW0yID0gNjU1MzU7CiAgICAgICAgICAgICAgdmFyIGxlbiA9IGlucHV0Lmxlbmd0aDsKICAgICAgICAgICAgICB2YXIgd29yZHMgPSBNYXRoLmZsb29yKGxlbiAvIDIpOwogICAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgICB3aGlsZSAod29yZHMpIHsKICAgICAgICAgICAgICAgIHZhciB0bGVuID0gd29yZHMgPj0gMzU5ID8gMzU5IDogd29yZHM7CiAgICAgICAgICAgICAgICB3b3JkcyAtPSB0bGVuOwogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICBzdW0xICs9IGlucHV0W2krK10gPDwgODsKICAgICAgICAgICAgICAgICAgc3VtMiArPSBzdW0xICs9IGlucHV0W2krK107CiAgICAgICAgICAgICAgICB9IHdoaWxlICgtLXRsZW4pOwogICAgICAgICAgICAgICAgc3VtMSA9IChzdW0xICYgNjU1MzUpICsgKHN1bTEgPj4+IDE2KTsKICAgICAgICAgICAgICAgIHN1bTIgPSAoc3VtMiAmIDY1NTM1KSArIChzdW0yID4+PiAxNik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChsZW4gJiAxKSB7CiAgICAgICAgICAgICAgICBzdW0yICs9IHN1bTEgKz0gaW5wdXRbaV0gPDwgODsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3VtMSA9IChzdW0xICYgNjU1MzUpICsgKHN1bTEgPj4+IDE2KTsKICAgICAgICAgICAgICBzdW0yID0gKHN1bTIgJiA2NTUzNSkgKyAoc3VtMiA+Pj4gMTYpOwogICAgICAgICAgICAgIHJldHVybiAoc3VtMiA8PCAxNiB8IHN1bTEpID4+PiAwOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZWFkSGVhZGVySW5mbzogZnVuY3Rpb24oaW5wdXQsIGRhdGEpIHsKICAgICAgICAgICAgICB2YXIgcHRyID0gZGF0YS5wdHI7CiAgICAgICAgICAgICAgdmFyIGZpbGVJZFZpZXcgPSBuZXcgVWludDhBcnJheShpbnB1dCwgcHRyLCA2KTsKICAgICAgICAgICAgICB2YXIgaGVhZGVySW5mbyA9IHt9OwogICAgICAgICAgICAgIGhlYWRlckluZm8uZmlsZUlkZW50aWZpZXJTdHJpbmcgPSBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KG51bGwsIGZpbGVJZFZpZXcpOwogICAgICAgICAgICAgIGlmIChoZWFkZXJJbmZvLmZpbGVJZGVudGlmaWVyU3RyaW5nLmxhc3RJbmRleE9mKCJMZXJjMiIsIDApICE9PSAwKSB7CiAgICAgICAgICAgICAgICB0aHJvdyAiVW5leHBlY3RlZCBmaWxlIGlkZW50aWZpZXIgc3RyaW5nIChleHBlY3QgTGVyYzIgKTogIiArIGhlYWRlckluZm8uZmlsZUlkZW50aWZpZXJTdHJpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHB0ciArPSA2OwogICAgICAgICAgICAgIHZhciB2aWV3ID0gbmV3IERhdGFWaWV3KGlucHV0LCBwdHIsIDgpOwogICAgICAgICAgICAgIHZhciBmaWxlVmVyc2lvbiA9IHZpZXcuZ2V0SW50MzIoMCwgdHJ1ZSk7CiAgICAgICAgICAgICAgaGVhZGVySW5mby5maWxlVmVyc2lvbiA9IGZpbGVWZXJzaW9uOwogICAgICAgICAgICAgIHB0ciArPSA0OwogICAgICAgICAgICAgIGlmIChmaWxlVmVyc2lvbiA+PSAzKSB7CiAgICAgICAgICAgICAgICBoZWFkZXJJbmZvLmNoZWNrc3VtID0gdmlldy5nZXRVaW50MzIoNCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICBwdHIgKz0gNDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgcHRyLCAxMik7CiAgICAgICAgICAgICAgaGVhZGVySW5mby5oZWlnaHQgPSB2aWV3LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICAgICAgICBoZWFkZXJJbmZvLndpZHRoID0gdmlldy5nZXRVaW50MzIoNCwgdHJ1ZSk7CiAgICAgICAgICAgICAgcHRyICs9IDg7CiAgICAgICAgICAgICAgaWYgKGZpbGVWZXJzaW9uID49IDQpIHsKICAgICAgICAgICAgICAgIGhlYWRlckluZm8ubnVtRGltcyA9IHZpZXcuZ2V0VWludDMyKDgsIHRydWUpOwogICAgICAgICAgICAgICAgcHRyICs9IDQ7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGhlYWRlckluZm8ubnVtRGltcyA9IDE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZpZXcgPSBuZXcgRGF0YVZpZXcoaW5wdXQsIHB0ciwgNDApOwogICAgICAgICAgICAgIGhlYWRlckluZm8ubnVtVmFsaWRQaXhlbCA9IHZpZXcuZ2V0VWludDMyKDAsIHRydWUpOwogICAgICAgICAgICAgIGhlYWRlckluZm8ubWljcm9CbG9ja1NpemUgPSB2aWV3LmdldEludDMyKDQsIHRydWUpOwogICAgICAgICAgICAgIGhlYWRlckluZm8uYmxvYlNpemUgPSB2aWV3LmdldEludDMyKDgsIHRydWUpOwogICAgICAgICAgICAgIGhlYWRlckluZm8uaW1hZ2VUeXBlID0gdmlldy5nZXRJbnQzMigxMiwgdHJ1ZSk7CiAgICAgICAgICAgICAgaGVhZGVySW5mby5tYXhaRXJyb3IgPSB2aWV3LmdldEZsb2F0NjQoMTYsIHRydWUpOwogICAgICAgICAgICAgIGhlYWRlckluZm8uek1pbiA9IHZpZXcuZ2V0RmxvYXQ2NCgyNCwgdHJ1ZSk7CiAgICAgICAgICAgICAgaGVhZGVySW5mby56TWF4ID0gdmlldy5nZXRGbG9hdDY0KDMyLCB0cnVlKTsKICAgICAgICAgICAgICBwdHIgKz0gNDA7CiAgICAgICAgICAgICAgZGF0YS5oZWFkZXJJbmZvID0gaGVhZGVySW5mbzsKICAgICAgICAgICAgICBkYXRhLnB0ciA9IHB0cjsKICAgICAgICAgICAgICB2YXIgY2hlY2tzdW0sIGtleUxlbmd0aDsKICAgICAgICAgICAgICBpZiAoZmlsZVZlcnNpb24gPj0gMykgewogICAgICAgICAgICAgICAga2V5TGVuZ3RoID0gZmlsZVZlcnNpb24gPj0gNCA/IDUyIDogNDg7CiAgICAgICAgICAgICAgICBjaGVja3N1bSA9IHRoaXMuY29tcHV0ZUNoZWNrc3VtRmxldGNoZXIzMihuZXcgVWludDhBcnJheShpbnB1dCwgcHRyIC0ga2V5TGVuZ3RoLCBoZWFkZXJJbmZvLmJsb2JTaXplIC0gMTQpKTsKICAgICAgICAgICAgICAgIGlmIChjaGVja3N1bSAhPT0gaGVhZGVySW5mby5jaGVja3N1bSkgewogICAgICAgICAgICAgICAgICB0aHJvdyAiQ2hlY2tzdW0gZmFpbGVkLiI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjaGVja01pbk1heFJhbmdlczogZnVuY3Rpb24oaW5wdXQsIGRhdGEpIHsKICAgICAgICAgICAgICB2YXIgaGVhZGVySW5mbyA9IGRhdGEuaGVhZGVySW5mbzsKICAgICAgICAgICAgICB2YXIgT3V0UGl4ZWxUeXBlQXJyYXkgPSB0aGlzLmdldERhdGFUeXBlQXJyYXkoaGVhZGVySW5mby5pbWFnZVR5cGUpOwogICAgICAgICAgICAgIHZhciByYW5nZUJ5dGVzID0gaGVhZGVySW5mby5udW1EaW1zICogdGhpcy5nZXREYXRhVHlwZVNpemUoaGVhZGVySW5mby5pbWFnZVR5cGUpOwogICAgICAgICAgICAgIHZhciBtaW5WYWx1ZXMgPSB0aGlzLnJlYWRTdWJBcnJheShpbnB1dCwgZGF0YS5wdHIsIE91dFBpeGVsVHlwZUFycmF5LCByYW5nZUJ5dGVzKTsKICAgICAgICAgICAgICB2YXIgbWF4VmFsdWVzID0gdGhpcy5yZWFkU3ViQXJyYXkoaW5wdXQsIGRhdGEucHRyICsgcmFuZ2VCeXRlcywgT3V0UGl4ZWxUeXBlQXJyYXksIHJhbmdlQnl0ZXMpOwogICAgICAgICAgICAgIGRhdGEucHRyICs9IDIgKiByYW5nZUJ5dGVzOwogICAgICAgICAgICAgIHZhciBpLCBlcXVhbCA9IHRydWU7CiAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGhlYWRlckluZm8ubnVtRGltczsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAobWluVmFsdWVzW2ldICE9PSBtYXhWYWx1ZXNbaV0pIHsKICAgICAgICAgICAgICAgICAgZXF1YWwgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGhlYWRlckluZm8ubWluVmFsdWVzID0gbWluVmFsdWVzOwogICAgICAgICAgICAgIGhlYWRlckluZm8ubWF4VmFsdWVzID0gbWF4VmFsdWVzOwogICAgICAgICAgICAgIHJldHVybiBlcXVhbDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcmVhZFN1YkFycmF5OiBmdW5jdGlvbihpbnB1dCwgcHRyLCBPdXRQaXhlbFR5cGVBcnJheSwgbnVtQnl0ZXMpIHsKICAgICAgICAgICAgICB2YXIgcmF3RGF0YTsKICAgICAgICAgICAgICBpZiAoT3V0UGl4ZWxUeXBlQXJyYXkgPT09IFVpbnQ4QXJyYXkpIHsKICAgICAgICAgICAgICAgIHJhd0RhdGEgPSBuZXcgVWludDhBcnJheShpbnB1dCwgcHRyLCBudW1CeXRlcyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihudW1CeXRlcyk7CiAgICAgICAgICAgICAgICB2YXIgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgc3RvcmU4LnNldChuZXcgVWludDhBcnJheShpbnB1dCwgcHRyLCBudW1CeXRlcykpOwogICAgICAgICAgICAgICAgcmF3RGF0YSA9IG5ldyBPdXRQaXhlbFR5cGVBcnJheShhcnJheUJ1Zik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByYXdEYXRhOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZWFkTWFzazogZnVuY3Rpb24oaW5wdXQsIGRhdGEpIHsKICAgICAgICAgICAgICB2YXIgcHRyID0gZGF0YS5wdHI7CiAgICAgICAgICAgICAgdmFyIGhlYWRlckluZm8gPSBkYXRhLmhlYWRlckluZm87CiAgICAgICAgICAgICAgdmFyIG51bVBpeGVscyA9IGhlYWRlckluZm8ud2lkdGggKiBoZWFkZXJJbmZvLmhlaWdodDsKICAgICAgICAgICAgICB2YXIgbnVtVmFsaWRQaXhlbCA9IGhlYWRlckluZm8ubnVtVmFsaWRQaXhlbDsKICAgICAgICAgICAgICB2YXIgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgcHRyLCA0KTsKICAgICAgICAgICAgICB2YXIgbWFzayA9IHt9OwogICAgICAgICAgICAgIG1hc2subnVtQnl0ZXMgPSB2aWV3LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICAgICAgICBwdHIgKz0gNDsKICAgICAgICAgICAgICBpZiAoKDAgPT09IG51bVZhbGlkUGl4ZWwgfHwgbnVtUGl4ZWxzID09PSBudW1WYWxpZFBpeGVsKSAmJiAwICE9PSBtYXNrLm51bUJ5dGVzKSB7CiAgICAgICAgICAgICAgICB0aHJvdyAiaW52YWxpZCBtYXNrIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGJpdHNldCwgcmVzdWx0TWFzazsKICAgICAgICAgICAgICBpZiAobnVtVmFsaWRQaXhlbCA9PT0gMCkgewogICAgICAgICAgICAgICAgYml0c2V0ID0gbmV3IFVpbnQ4QXJyYXkoTWF0aC5jZWlsKG51bVBpeGVscyAvIDgpKTsKICAgICAgICAgICAgICAgIG1hc2suYml0c2V0ID0gYml0c2V0OwogICAgICAgICAgICAgICAgcmVzdWx0TWFzayA9IG5ldyBVaW50OEFycmF5KG51bVBpeGVscyk7CiAgICAgICAgICAgICAgICBkYXRhLnBpeGVscy5yZXN1bHRNYXNrID0gcmVzdWx0TWFzazsKICAgICAgICAgICAgICAgIHB0ciArPSBtYXNrLm51bUJ5dGVzOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobWFzay5udW1CeXRlcyA+IDApIHsKICAgICAgICAgICAgICAgIGJpdHNldCA9IG5ldyBVaW50OEFycmF5KE1hdGguY2VpbChudW1QaXhlbHMgLyA4KSk7CiAgICAgICAgICAgICAgICB2aWV3ID0gbmV3IERhdGFWaWV3KGlucHV0LCBwdHIsIG1hc2subnVtQnl0ZXMpOwogICAgICAgICAgICAgICAgdmFyIGNudCA9IHZpZXcuZ2V0SW50MTYoMCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB2YXIgaXAgPSAyLCBvcCA9IDAsIHZhbCA9IDA7CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgIGlmIChjbnQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGNudC0tKSB7CiAgICAgICAgICAgICAgICAgICAgICBiaXRzZXRbb3ArK10gPSB2aWV3LmdldFVpbnQ4KGlwKyspOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YWwgPSB2aWV3LmdldFVpbnQ4KGlwKyspOwogICAgICAgICAgICAgICAgICAgIGNudCA9IC1jbnQ7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGNudC0tKSB7CiAgICAgICAgICAgICAgICAgICAgICBiaXRzZXRbb3ArK10gPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNudCA9IHZpZXcuZ2V0SW50MTYoaXAsIHRydWUpOwogICAgICAgICAgICAgICAgICBpcCArPSAyOwogICAgICAgICAgICAgICAgfSB3aGlsZSAoaXAgPCBtYXNrLm51bUJ5dGVzKTsKICAgICAgICAgICAgICAgIGlmIChjbnQgIT09IC0zMjc2OCB8fCBvcCA8IGJpdHNldC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgIlVuZXhwZWN0ZWQgZW5kIG9mIG1hc2sgUkxFIGVuY29kaW5nIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlc3VsdE1hc2sgPSBuZXcgVWludDhBcnJheShudW1QaXhlbHMpOwogICAgICAgICAgICAgICAgdmFyIG1iID0gMCwgayA9IDA7CiAgICAgICAgICAgICAgICBmb3IgKGsgPSAwOyBrIDwgbnVtUGl4ZWxzOyBrKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKGsgJiA3KSB7CiAgICAgICAgICAgICAgICAgICAgbWIgPSBiaXRzZXRbayA+PiAzXTsKICAgICAgICAgICAgICAgICAgICBtYiA8PD0gayAmIDc7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbWIgPSBiaXRzZXRbayA+PiAzXTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAobWIgJiAxMjgpIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHRNYXNrW2tdID0gMTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGF0YS5waXhlbHMucmVzdWx0TWFzayA9IHJlc3VsdE1hc2s7CiAgICAgICAgICAgICAgICBtYXNrLmJpdHNldCA9IGJpdHNldDsKICAgICAgICAgICAgICAgIHB0ciArPSBtYXNrLm51bUJ5dGVzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkYXRhLnB0ciA9IHB0cjsKICAgICAgICAgICAgICBkYXRhLm1hc2sgPSBtYXNrOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZWFkRGF0YU9uZVN3ZWVwOiBmdW5jdGlvbihpbnB1dCwgZGF0YSwgT3V0UGl4ZWxUeXBlQXJyYXkpIHsKICAgICAgICAgICAgICB2YXIgcHRyID0gZGF0YS5wdHI7CiAgICAgICAgICAgICAgdmFyIGhlYWRlckluZm8gPSBkYXRhLmhlYWRlckluZm87CiAgICAgICAgICAgICAgdmFyIG51bURpbXMgPSBoZWFkZXJJbmZvLm51bURpbXM7CiAgICAgICAgICAgICAgdmFyIG51bVBpeGVscyA9IGhlYWRlckluZm8ud2lkdGggKiBoZWFkZXJJbmZvLmhlaWdodDsKICAgICAgICAgICAgICB2YXIgaW1hZ2VUeXBlID0gaGVhZGVySW5mby5pbWFnZVR5cGU7CiAgICAgICAgICAgICAgdmFyIG51bUJ5dGVzID0gaGVhZGVySW5mby5udW1WYWxpZFBpeGVsICogTGVyYzJIZWxwZXJzLmdldERhdGFUeXBlU2l6ZShpbWFnZVR5cGUpICogbnVtRGltczsKICAgICAgICAgICAgICB2YXIgcmF3RGF0YTsKICAgICAgICAgICAgICB2YXIgbWFzayA9IGRhdGEucGl4ZWxzLnJlc3VsdE1hc2s7CiAgICAgICAgICAgICAgaWYgKE91dFBpeGVsVHlwZUFycmF5ID09PSBVaW50OEFycmF5KSB7CiAgICAgICAgICAgICAgICByYXdEYXRhID0gbmV3IFVpbnQ4QXJyYXkoaW5wdXQsIHB0ciwgbnVtQnl0ZXMpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgYXJyYXlCdWYgPSBuZXcgQXJyYXlCdWZmZXIobnVtQnl0ZXMpOwogICAgICAgICAgICAgICAgdmFyIHN0b3JlOCA9IG5ldyBVaW50OEFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgIHN0b3JlOC5zZXQobmV3IFVpbnQ4QXJyYXkoaW5wdXQsIHB0ciwgbnVtQnl0ZXMpKTsKICAgICAgICAgICAgICAgIHJhd0RhdGEgPSBuZXcgT3V0UGl4ZWxUeXBlQXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmF3RGF0YS5sZW5ndGggPT09IG51bVBpeGVscyAqIG51bURpbXMpIHsKICAgICAgICAgICAgICAgIGRhdGEucGl4ZWxzLnJlc3VsdFBpeGVscyA9IHJhd0RhdGE7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRhdGEucGl4ZWxzLnJlc3VsdFBpeGVscyA9IG5ldyBPdXRQaXhlbFR5cGVBcnJheShudW1QaXhlbHMgKiBudW1EaW1zKTsKICAgICAgICAgICAgICAgIHZhciB6ID0gMCwgayA9IDAsIGkgPSAwLCBuU3RhcnQgPSAwOwogICAgICAgICAgICAgICAgaWYgKG51bURpbXMgPiAxKSB7CiAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1EaW1zOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBuU3RhcnQgPSBpICogbnVtUGl4ZWxzOwogICAgICAgICAgICAgICAgICAgIGZvciAoayA9IDA7IGsgPCBudW1QaXhlbHM7IGsrKykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKG1hc2tba10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5waXhlbHMucmVzdWx0UGl4ZWxzW25TdGFydCArIGtdID0gcmF3RGF0YVt6KytdOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZm9yIChrID0gMDsgayA8IG51bVBpeGVsczsgaysrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hc2tba10pIHsKICAgICAgICAgICAgICAgICAgICAgIGRhdGEucGl4ZWxzLnJlc3VsdFBpeGVsc1trXSA9IHJhd0RhdGFbeisrXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHRyICs9IG51bUJ5dGVzOwogICAgICAgICAgICAgIGRhdGEucHRyID0gcHRyOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZWFkSHVmZm1hblRyZWU6IGZ1bmN0aW9uKGlucHV0LCBkYXRhKSB7CiAgICAgICAgICAgICAgdmFyIEJJVFNfTUFYID0gdGhpcy5IVUZGTUFOX0xVVF9CSVRTX01BWDsKICAgICAgICAgICAgICB2YXIgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgZGF0YS5wdHIsIDE2KTsKICAgICAgICAgICAgICBkYXRhLnB0ciArPSAxNjsKICAgICAgICAgICAgICB2YXIgdmVyc2lvbiA9IHZpZXcuZ2V0SW50MzIoMCwgdHJ1ZSk7CiAgICAgICAgICAgICAgaWYgKHZlcnNpb24gPCAyKSB7CiAgICAgICAgICAgICAgICB0aHJvdyAidW5zdXBwb3J0ZWQgSHVmZm1hbiB2ZXJzaW9uIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHNpemUgPSB2aWV3LmdldEludDMyKDQsIHRydWUpOwogICAgICAgICAgICAgIHZhciBpMCA9IHZpZXcuZ2V0SW50MzIoOCwgdHJ1ZSk7CiAgICAgICAgICAgICAgdmFyIGkxID0gdmlldy5nZXRJbnQzMigxMiwgdHJ1ZSk7CiAgICAgICAgICAgICAgaWYgKGkwID49IGkxKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBibG9ja0RhdGFCdWZmZXIgPSBuZXcgVWludDMyQXJyYXkoaTEgLSBpMCk7CiAgICAgICAgICAgICAgTGVyYzJIZWxwZXJzLmRlY29kZUJpdHMoaW5wdXQsIGRhdGEsIGJsb2NrRGF0YUJ1ZmZlcik7CiAgICAgICAgICAgICAgdmFyIGNvZGVUYWJsZSA9IFtdOwogICAgICAgICAgICAgIHZhciBpLCBqLCBrLCBsZW47CiAgICAgICAgICAgICAgZm9yIChpID0gaTA7IGkgPCBpMTsgaSsrKSB7CiAgICAgICAgICAgICAgICBqID0gaSAtIChpIDwgc2l6ZSA/IDAgOiBzaXplKTsKICAgICAgICAgICAgICAgIGNvZGVUYWJsZVtqXSA9IHsgZmlyc3Q6IGJsb2NrRGF0YUJ1ZmZlcltpIC0gaTBdLCBzZWNvbmQ6IG51bGwgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGRhdGFCeXRlcyA9IGlucHV0LmJ5dGVMZW5ndGggLSBkYXRhLnB0cjsKICAgICAgICAgICAgICB2YXIgZGF0YVdvcmRzID0gTWF0aC5jZWlsKGRhdGFCeXRlcyAvIDQpOwogICAgICAgICAgICAgIHZhciBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihkYXRhV29yZHMgKiA0KTsKICAgICAgICAgICAgICB2YXIgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgIHN0b3JlOC5zZXQobmV3IFVpbnQ4QXJyYXkoaW5wdXQsIGRhdGEucHRyLCBkYXRhQnl0ZXMpKTsKICAgICAgICAgICAgICB2YXIgc3R1ZmZlZERhdGEgPSBuZXcgVWludDMyQXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgIHZhciBiaXRQb3MgPSAwLCB3b3JkLCBzcmNQdHIgPSAwOwogICAgICAgICAgICAgIHdvcmQgPSBzdHVmZmVkRGF0YVswXTsKICAgICAgICAgICAgICBmb3IgKGkgPSBpMDsgaSA8IGkxOyBpKyspIHsKICAgICAgICAgICAgICAgIGogPSBpIC0gKGkgPCBzaXplID8gMCA6IHNpemUpOwogICAgICAgICAgICAgICAgbGVuID0gY29kZVRhYmxlW2pdLmZpcnN0OwogICAgICAgICAgICAgICAgaWYgKGxlbiA+IDApIHsKICAgICAgICAgICAgICAgICAgY29kZVRhYmxlW2pdLnNlY29uZCA9IHdvcmQgPDwgYml0UG9zID4+PiAzMiAtIGxlbjsKICAgICAgICAgICAgICAgICAgaWYgKDMyIC0gYml0UG9zID49IGxlbikgewogICAgICAgICAgICAgICAgICAgIGJpdFBvcyArPSBsZW47CiAgICAgICAgICAgICAgICAgICAgaWYgKGJpdFBvcyA9PT0gMzIpIHsKICAgICAgICAgICAgICAgICAgICAgIGJpdFBvcyA9IDA7CiAgICAgICAgICAgICAgICAgICAgICBzcmNQdHIrKzsKICAgICAgICAgICAgICAgICAgICAgIHdvcmQgPSBzdHVmZmVkRGF0YVtzcmNQdHJdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBiaXRQb3MgKz0gbGVuIC0gMzI7CiAgICAgICAgICAgICAgICAgICAgc3JjUHRyKys7CiAgICAgICAgICAgICAgICAgICAgd29yZCA9IHN0dWZmZWREYXRhW3NyY1B0cl07CiAgICAgICAgICAgICAgICAgICAgY29kZVRhYmxlW2pdLnNlY29uZCB8PSB3b3JkID4+PiAzMiAtIGJpdFBvczsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbnVtQml0c0xVVCA9IDAsIG51bUJpdHNMVVRRaWNrID0gMDsKICAgICAgICAgICAgICB2YXIgdHJlZSA9IG5ldyBUcmVlTm9kZSgpOwogICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBjb2RlVGFibGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChjb2RlVGFibGVbaV0gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICBudW1CaXRzTFVUID0gTWF0aC5tYXgobnVtQml0c0xVVCwgY29kZVRhYmxlW2ldLmZpcnN0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG51bUJpdHNMVVQgPj0gQklUU19NQVgpIHsKICAgICAgICAgICAgICAgIG51bUJpdHNMVVRRaWNrID0gQklUU19NQVg7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG51bUJpdHNMVVRRaWNrID0gbnVtQml0c0xVVDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG51bUJpdHNMVVQgPj0gMzApIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJXQVJuaW5nLCBsYXJnZSBOVU0gTFVUIEJJVFMgSVMgIiArIG51bUJpdHNMVVQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZGVjb2RlTHV0ID0gW10sIGVudHJ5LCBjb2RlLCBudW1FbnRyaWVzLCBqaiwgY3VycmVudEJpdCwgbm9kZTsKICAgICAgICAgICAgICBmb3IgKGkgPSBpMDsgaSA8IGkxOyBpKyspIHsKICAgICAgICAgICAgICAgIGogPSBpIC0gKGkgPCBzaXplID8gMCA6IHNpemUpOwogICAgICAgICAgICAgICAgbGVuID0gY29kZVRhYmxlW2pdLmZpcnN0OwogICAgICAgICAgICAgICAgaWYgKGxlbiA+IDApIHsKICAgICAgICAgICAgICAgICAgZW50cnkgPSBbbGVuLCBqXTsKICAgICAgICAgICAgICAgICAgaWYgKGxlbiA8PSBudW1CaXRzTFVUUWljaykgewogICAgICAgICAgICAgICAgICAgIGNvZGUgPSBjb2RlVGFibGVbal0uc2Vjb25kIDw8IG51bUJpdHNMVVRRaWNrIC0gbGVuOwogICAgICAgICAgICAgICAgICAgIG51bUVudHJpZXMgPSAxIDw8IG51bUJpdHNMVVRRaWNrIC0gbGVuOwogICAgICAgICAgICAgICAgICAgIGZvciAoayA9IDA7IGsgPCBudW1FbnRyaWVzOyBrKyspIHsKICAgICAgICAgICAgICAgICAgICAgIGRlY29kZUx1dFtjb2RlIHwga10gPSBlbnRyeTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29kZSA9IGNvZGVUYWJsZVtqXS5zZWNvbmQ7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHRyZWU7CiAgICAgICAgICAgICAgICAgICAgZm9yIChqaiA9IGxlbiAtIDE7IGpqID49IDA7IGpqLS0pIHsKICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRCaXQgPSBjb2RlID4+PiBqaiAmIDE7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudEJpdCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5vZGUucmlnaHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLnJpZ2h0ID0gbmV3IFRyZWVOb2RlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmlnaHQ7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5vZGUubGVmdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubGVmdCA9IG5ldyBUcmVlTm9kZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLmxlZnQ7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoamogPT09IDAgJiYgIW5vZGUudmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUudmFsID0gZW50cnlbMV07CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBkZWNvZGVMdXQsCiAgICAgICAgICAgICAgICBudW1CaXRzTFVUUWljaywKICAgICAgICAgICAgICAgIG51bUJpdHNMVVQsCiAgICAgICAgICAgICAgICB0cmVlLAogICAgICAgICAgICAgICAgc3R1ZmZlZERhdGEsCiAgICAgICAgICAgICAgICBzcmNQdHIsCiAgICAgICAgICAgICAgICBiaXRQb3MKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9LAogICAgICAgICAgICByZWFkSHVmZm1hbjogZnVuY3Rpb24oaW5wdXQsIGRhdGEsIE91dFBpeGVsVHlwZUFycmF5KSB7CiAgICAgICAgICAgICAgdmFyIGhlYWRlckluZm8gPSBkYXRhLmhlYWRlckluZm87CiAgICAgICAgICAgICAgdmFyIG51bURpbXMgPSBoZWFkZXJJbmZvLm51bURpbXM7CiAgICAgICAgICAgICAgdmFyIGhlaWdodCA9IGRhdGEuaGVhZGVySW5mby5oZWlnaHQ7CiAgICAgICAgICAgICAgdmFyIHdpZHRoID0gZGF0YS5oZWFkZXJJbmZvLndpZHRoOwogICAgICAgICAgICAgIHZhciBudW1QaXhlbHMgPSB3aWR0aCAqIGhlaWdodDsKICAgICAgICAgICAgICB2YXIgaHVmZm1hbkluZm8gPSB0aGlzLnJlYWRIdWZmbWFuVHJlZShpbnB1dCwgZGF0YSk7CiAgICAgICAgICAgICAgdmFyIGRlY29kZUx1dCA9IGh1ZmZtYW5JbmZvLmRlY29kZUx1dDsKICAgICAgICAgICAgICB2YXIgdHJlZSA9IGh1ZmZtYW5JbmZvLnRyZWU7CiAgICAgICAgICAgICAgdmFyIHN0dWZmZWREYXRhID0gaHVmZm1hbkluZm8uc3R1ZmZlZERhdGE7CiAgICAgICAgICAgICAgdmFyIHNyY1B0ciA9IGh1ZmZtYW5JbmZvLnNyY1B0cjsKICAgICAgICAgICAgICB2YXIgYml0UG9zID0gaHVmZm1hbkluZm8uYml0UG9zOwogICAgICAgICAgICAgIHZhciBudW1CaXRzTFVUUWljayA9IGh1ZmZtYW5JbmZvLm51bUJpdHNMVVRRaWNrOwogICAgICAgICAgICAgIHZhciBudW1CaXRzTFVUID0gaHVmZm1hbkluZm8ubnVtQml0c0xVVDsKICAgICAgICAgICAgICB2YXIgb2Zmc2V0ID0gZGF0YS5oZWFkZXJJbmZvLmltYWdlVHlwZSA9PT0gMCA/IDEyOCA6IDA7CiAgICAgICAgICAgICAgdmFyIG5vZGUsIHZhbCwgZGVsdGEsIG1hc2sgPSBkYXRhLnBpeGVscy5yZXN1bHRNYXNrLCB2YWxUbXAsIHZhbFRtcFF1aWNrLCBjdXJyZW50Qml0OwogICAgICAgICAgICAgIHZhciBpLCBqLCBrLCBpaTsKICAgICAgICAgICAgICB2YXIgcHJldlZhbCA9IDA7CiAgICAgICAgICAgICAgaWYgKGJpdFBvcyA+IDApIHsKICAgICAgICAgICAgICAgIHNyY1B0cisrOwogICAgICAgICAgICAgICAgYml0UG9zID0gMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHdvcmQgPSBzdHVmZmVkRGF0YVtzcmNQdHJdOwogICAgICAgICAgICAgIHZhciBkZWx0YUVuY29kZSA9IGRhdGEuZW5jb2RlTW9kZSA9PT0gMTsKICAgICAgICAgICAgICB2YXIgcmVzdWx0UGl4ZWxzQWxsRGltID0gbmV3IE91dFBpeGVsVHlwZUFycmF5KG51bVBpeGVscyAqIG51bURpbXMpOwogICAgICAgICAgICAgIHZhciByZXN1bHRQaXhlbHMgPSByZXN1bHRQaXhlbHNBbGxEaW07CiAgICAgICAgICAgICAgdmFyIGlEaW07CiAgICAgICAgICAgICAgZm9yIChpRGltID0gMDsgaURpbSA8IGhlYWRlckluZm8ubnVtRGltczsgaURpbSsrKSB7CiAgICAgICAgICAgICAgICBpZiAobnVtRGltcyA+IDEpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0UGl4ZWxzID0gbmV3IE91dFBpeGVsVHlwZUFycmF5KHJlc3VsdFBpeGVsc0FsbERpbS5idWZmZXIsIG51bVBpeGVscyAqIGlEaW0sIG51bVBpeGVscyk7CiAgICAgICAgICAgICAgICAgIHByZXZWYWwgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGRhdGEuaGVhZGVySW5mby5udW1WYWxpZFBpeGVsID09PSB3aWR0aCAqIGhlaWdodCkgewogICAgICAgICAgICAgICAgICBmb3IgKGsgPSAwLCBpID0gMDsgaSA8IGhlaWdodDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IHdpZHRoOyBqKyssIGsrKykgewogICAgICAgICAgICAgICAgICAgICAgdmFsID0gMDsKICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcCA9IHdvcmQgPDwgYml0UG9zID4+PiAzMiAtIG51bUJpdHNMVVRRaWNrOwogICAgICAgICAgICAgICAgICAgICAgdmFsVG1wUXVpY2sgPSB2YWxUbXA7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoMzIgLSBiaXRQb3MgPCBudW1CaXRzTFVUUWljaykgewogICAgICAgICAgICAgICAgICAgICAgICB2YWxUbXAgfD0gc3R1ZmZlZERhdGFbc3JjUHRyICsgMV0gPj4+IDY0IC0gYml0UG9zIC0gbnVtQml0c0xVVFFpY2s7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcFF1aWNrID0gdmFsVG1wOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGRlY29kZUx1dFt2YWxUbXBRdWlja10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gZGVjb2RlTHV0W3ZhbFRtcFF1aWNrXVsxXTsKICAgICAgICAgICAgICAgICAgICAgICAgYml0UG9zICs9IGRlY29kZUx1dFt2YWxUbXBRdWlja11bMF07CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB2YWxUbXAgPSB3b3JkIDw8IGJpdFBvcyA+Pj4gMzIgLSBudW1CaXRzTFVUOwogICAgICAgICAgICAgICAgICAgICAgICB2YWxUbXBRdWljayA9IHZhbFRtcDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKDMyIC0gYml0UG9zIDwgbnVtQml0c0xVVCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcCB8PSBzdHVmZmVkRGF0YVtzcmNQdHIgKyAxXSA+Pj4gNjQgLSBiaXRQb3MgLSBudW1CaXRzTFVUOwogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcFF1aWNrID0gdmFsVG1wOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSB0cmVlOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGlpID0gMDsgaWkgPCBudW1CaXRzTFVUOyBpaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEJpdCA9IHZhbFRtcCA+Pj4gbnVtQml0c0xVVCAtIGlpIC0gMSAmIDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGN1cnJlbnRCaXQgPyBub2RlLnJpZ2h0IDogbm9kZS5sZWZ0OwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKG5vZGUubGVmdCB8fCBub2RlLnJpZ2h0KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gbm9kZS52YWw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaXRQb3MgPSBiaXRQb3MgKyBpaSArIDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChiaXRQb3MgPj0gMzIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYml0UG9zIC09IDMyOwogICAgICAgICAgICAgICAgICAgICAgICBzcmNQdHIrKzsKICAgICAgICAgICAgICAgICAgICAgICAgd29yZCA9IHN0dWZmZWREYXRhW3NyY1B0cl07CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBkZWx0YSA9IHZhbCAtIG9mZnNldDsKICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWx0YUVuY29kZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaiA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBkZWx0YSArPSBwcmV2VmFsOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsdGEgKz0gcmVzdWx0UGl4ZWxzW2sgLSB3aWR0aF07CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsdGEgKz0gcHJldlZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBkZWx0YSAmPSAyNTU7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1trXSA9IGRlbHRhOwogICAgICAgICAgICAgICAgICAgICAgICBwcmV2VmFsID0gZGVsdGE7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRQaXhlbHNba10gPSBkZWx0YTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGZvciAoayA9IDAsIGkgPSAwOyBpIDwgaGVpZ2h0OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgd2lkdGg7IGorKywgaysrKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAobWFza1trXSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICB2YWxUbXAgPSB3b3JkIDw8IGJpdFBvcyA+Pj4gMzIgLSBudW1CaXRzTFVUUWljazsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsVG1wUXVpY2sgPSB2YWxUbXA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgzMiAtIGJpdFBvcyA8IG51bUJpdHNMVVRRaWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsVG1wIHw9IHN0dWZmZWREYXRhW3NyY1B0ciArIDFdID4+PiA2NCAtIGJpdFBvcyAtIG51bUJpdHNMVVRRaWNrOwogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcFF1aWNrID0gdmFsVG1wOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWNvZGVMdXRbdmFsVG1wUXVpY2tdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gZGVjb2RlTHV0W3ZhbFRtcFF1aWNrXVsxXTsKICAgICAgICAgICAgICAgICAgICAgICAgICBiaXRQb3MgKz0gZGVjb2RlTHV0W3ZhbFRtcFF1aWNrXVswXTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxUbXAgPSB3b3JkIDw8IGJpdFBvcyA+Pj4gMzIgLSBudW1CaXRzTFVUOwogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcFF1aWNrID0gdmFsVG1wOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgzMiAtIGJpdFBvcyA8IG51bUJpdHNMVVQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcCB8PSBzdHVmZmVkRGF0YVtzcmNQdHIgKyAxXSA+Pj4gNjQgLSBiaXRQb3MgLSBudW1CaXRzTFVUOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsVG1wUXVpY2sgPSB2YWxUbXA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSB0cmVlOwogICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaWkgPSAwOyBpaSA8IG51bUJpdHNMVVQ7IGlpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRCaXQgPSB2YWxUbXAgPj4+IG51bUJpdHNMVVQgLSBpaSAtIDEgJiAxOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGN1cnJlbnRCaXQgPyBub2RlLnJpZ2h0IDogbm9kZS5sZWZ0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEobm9kZS5sZWZ0IHx8IG5vZGUucmlnaHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IG5vZGUudmFsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaXRQb3MgPSBiaXRQb3MgKyBpaSArIDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYml0UG9zID49IDMyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYml0UG9zIC09IDMyOwogICAgICAgICAgICAgICAgICAgICAgICAgIHNyY1B0cisrOwogICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmQgPSBzdHVmZmVkRGF0YVtzcmNQdHJdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbHRhID0gdmFsIC0gb2Zmc2V0OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVsdGFFbmNvZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaiA+IDAgJiYgbWFza1trIC0gMV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbHRhICs9IHByZXZWYWw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpID4gMCAmJiBtYXNrW2sgLSB3aWR0aF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbHRhICs9IHJlc3VsdFBpeGVsc1trIC0gd2lkdGhdOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWx0YSArPSBwcmV2VmFsOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBkZWx0YSAmPSAyNTU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0UGl4ZWxzW2tdID0gZGVsdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldlZhbCA9IGRlbHRhOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1trXSA9IGRlbHRhOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkYXRhLnB0ciA9IGRhdGEucHRyICsgKHNyY1B0ciArIDEpICogNCArIChiaXRQb3MgPiAwID8gNCA6IDApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkYXRhLnBpeGVscy5yZXN1bHRQaXhlbHMgPSByZXN1bHRQaXhlbHNBbGxEaW07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRlY29kZUJpdHM6IGZ1bmN0aW9uKGlucHV0LCBkYXRhLCBibG9ja0RhdGFCdWZmZXIsIG9mZnNldCwgaURpbSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBoZWFkZXJJbmZvID0gZGF0YS5oZWFkZXJJbmZvOwogICAgICAgICAgICAgICAgdmFyIGZpbGVWZXJzaW9uID0gaGVhZGVySW5mby5maWxlVmVyc2lvbjsKICAgICAgICAgICAgICAgIHZhciBibG9ja1B0ciA9IDA7CiAgICAgICAgICAgICAgICB2YXIgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgZGF0YS5wdHIsIDUpOwogICAgICAgICAgICAgICAgdmFyIGhlYWRlckJ5dGUgPSB2aWV3LmdldFVpbnQ4KDApOwogICAgICAgICAgICAgICAgYmxvY2tQdHIrKzsKICAgICAgICAgICAgICAgIHZhciBiaXRzNjcgPSBoZWFkZXJCeXRlID4+IDY7CiAgICAgICAgICAgICAgICB2YXIgbiA9IGJpdHM2NyA9PT0gMCA/IDQgOiAzIC0gYml0czY3OwogICAgICAgICAgICAgICAgdmFyIGRvTHV0ID0gKGhlYWRlckJ5dGUgJiAzMikgPiAwID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgICAgICAgdmFyIG51bUJpdHMgPSBoZWFkZXJCeXRlICYgMzE7CiAgICAgICAgICAgICAgICB2YXIgbnVtRWxlbWVudHMgPSAwOwogICAgICAgICAgICAgICAgaWYgKG4gPT09IDEpIHsKICAgICAgICAgICAgICAgICAgbnVtRWxlbWVudHMgPSB2aWV3LmdldFVpbnQ4KGJsb2NrUHRyKTsKICAgICAgICAgICAgICAgICAgYmxvY2tQdHIrKzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobiA9PT0gMikgewogICAgICAgICAgICAgICAgICBudW1FbGVtZW50cyA9IHZpZXcuZ2V0VWludDE2KGJsb2NrUHRyLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgYmxvY2tQdHIgKz0gMjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobiA9PT0gNCkgewogICAgICAgICAgICAgICAgICBudW1FbGVtZW50cyA9IHZpZXcuZ2V0VWludDMyKGJsb2NrUHRyLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgYmxvY2tQdHIgKz0gNDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRocm93ICJJbnZhbGlkIHZhbGlkIHBpeGVsIGNvdW50IHR5cGUiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHNjYWxlID0gMiAqIGhlYWRlckluZm8ubWF4WkVycm9yOwogICAgICAgICAgICAgICAgdmFyIHN0dWZmZWREYXRhLCBhcnJheUJ1Ziwgc3RvcmU4LCBkYXRhQnl0ZXMsIGRhdGFXb3JkczsKICAgICAgICAgICAgICAgIHZhciBsdXRBcnIsIGx1dERhdGEsIGx1dEJ5dGVzLCBsdXRCaXRzUGVyRWxlbWVudCwgYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgdmFyIHpNYXggPSBoZWFkZXJJbmZvLm51bURpbXMgPiAxID8gaGVhZGVySW5mby5tYXhWYWx1ZXNbaURpbV0gOiBoZWFkZXJJbmZvLnpNYXg7CiAgICAgICAgICAgICAgICBpZiAoZG9MdXQpIHsKICAgICAgICAgICAgICAgICAgZGF0YS5jb3VudGVyLmx1dCsrOwogICAgICAgICAgICAgICAgICBsdXRCeXRlcyA9IHZpZXcuZ2V0VWludDgoYmxvY2tQdHIpOwogICAgICAgICAgICAgICAgICBsdXRCaXRzUGVyRWxlbWVudCA9IG51bUJpdHM7CiAgICAgICAgICAgICAgICAgIGJsb2NrUHRyKys7CiAgICAgICAgICAgICAgICAgIGRhdGFCeXRlcyA9IE1hdGguY2VpbCgobHV0Qnl0ZXMgLSAxKSAqIG51bUJpdHMgLyA4KTsKICAgICAgICAgICAgICAgICAgZGF0YVdvcmRzID0gTWF0aC5jZWlsKGRhdGFCeXRlcyAvIDQpOwogICAgICAgICAgICAgICAgICBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihkYXRhV29yZHMgKiA0KTsKICAgICAgICAgICAgICAgICAgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICBkYXRhLnB0ciArPSBibG9ja1B0cjsKICAgICAgICAgICAgICAgICAgc3RvcmU4LnNldChuZXcgVWludDhBcnJheShpbnB1dCwgZGF0YS5wdHIsIGRhdGFCeXRlcykpOwogICAgICAgICAgICAgICAgICBsdXREYXRhID0gbmV3IFVpbnQzMkFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgICAgZGF0YS5wdHIgKz0gZGF0YUJ5dGVzOwogICAgICAgICAgICAgICAgICBiaXRzUGVyUGl4ZWwgPSAwOwogICAgICAgICAgICAgICAgICB3aGlsZSAobHV0Qnl0ZXMgLSAxID4+PiBiaXRzUGVyUGl4ZWwpIHsKICAgICAgICAgICAgICAgICAgICBiaXRzUGVyUGl4ZWwrKzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBkYXRhQnl0ZXMgPSBNYXRoLmNlaWwobnVtRWxlbWVudHMgKiBiaXRzUGVyUGl4ZWwgLyA4KTsKICAgICAgICAgICAgICAgICAgZGF0YVdvcmRzID0gTWF0aC5jZWlsKGRhdGFCeXRlcyAvIDQpOwogICAgICAgICAgICAgICAgICBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihkYXRhV29yZHMgKiA0KTsKICAgICAgICAgICAgICAgICAgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICBzdG9yZTguc2V0KG5ldyBVaW50OEFycmF5KGlucHV0LCBkYXRhLnB0ciwgZGF0YUJ5dGVzKSk7CiAgICAgICAgICAgICAgICAgIHN0dWZmZWREYXRhID0gbmV3IFVpbnQzMkFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgICAgZGF0YS5wdHIgKz0gZGF0YUJ5dGVzOwogICAgICAgICAgICAgICAgICBpZiAoZmlsZVZlcnNpb24gPj0gMykgewogICAgICAgICAgICAgICAgICAgIGx1dEFyciA9IEJpdFN0dWZmZXIudW5zdHVmZkxVVDIobHV0RGF0YSwgbnVtQml0cywgbHV0Qnl0ZXMgLSAxLCBvZmZzZXQsIHNjYWxlLCB6TWF4KTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsdXRBcnIgPSBCaXRTdHVmZmVyLnVuc3R1ZmZMVVQobHV0RGF0YSwgbnVtQml0cywgbHV0Qnl0ZXMgLSAxLCBvZmZzZXQsIHNjYWxlLCB6TWF4KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoZmlsZVZlcnNpb24gPj0gMykgewogICAgICAgICAgICAgICAgICAgIEJpdFN0dWZmZXIudW5zdHVmZjIoc3R1ZmZlZERhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgYml0c1BlclBpeGVsLCBudW1FbGVtZW50cywgbHV0QXJyKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBCaXRTdHVmZmVyLnVuc3R1ZmYoc3R1ZmZlZERhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgYml0c1BlclBpeGVsLCBudW1FbGVtZW50cywgbHV0QXJyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZGF0YS5jb3VudGVyLmJpdHN0dWZmZXIrKzsKICAgICAgICAgICAgICAgICAgYml0c1BlclBpeGVsID0gbnVtQml0czsKICAgICAgICAgICAgICAgICAgZGF0YS5wdHIgKz0gYmxvY2tQdHI7CiAgICAgICAgICAgICAgICAgIGlmIChiaXRzUGVyUGl4ZWwgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YUJ5dGVzID0gTWF0aC5jZWlsKG51bUVsZW1lbnRzICogYml0c1BlclBpeGVsIC8gOCk7CiAgICAgICAgICAgICAgICAgICAgZGF0YVdvcmRzID0gTWF0aC5jZWlsKGRhdGFCeXRlcyAvIDQpOwogICAgICAgICAgICAgICAgICAgIGFycmF5QnVmID0gbmV3IEFycmF5QnVmZmVyKGRhdGFXb3JkcyAqIDQpOwogICAgICAgICAgICAgICAgICAgIHN0b3JlOCA9IG5ldyBVaW50OEFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgICAgICBzdG9yZTguc2V0KG5ldyBVaW50OEFycmF5KGlucHV0LCBkYXRhLnB0ciwgZGF0YUJ5dGVzKSk7CiAgICAgICAgICAgICAgICAgICAgc3R1ZmZlZERhdGEgPSBuZXcgVWludDMyQXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICAgIGRhdGEucHRyICs9IGRhdGFCeXRlczsKICAgICAgICAgICAgICAgICAgICBpZiAoZmlsZVZlcnNpb24gPj0gMykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKG9mZnNldCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEJpdFN0dWZmZXIub3JpZ2luYWxVbnN0dWZmMihzdHVmZmVkRGF0YSwgYmxvY2tEYXRhQnVmZmVyLCBiaXRzUGVyUGl4ZWwsIG51bUVsZW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEJpdFN0dWZmZXIudW5zdHVmZjIoc3R1ZmZlZERhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgYml0c1BlclBpeGVsLCBudW1FbGVtZW50cywgZmFsc2UsIG9mZnNldCwgc2NhbGUsIHpNYXgpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAob2Zmc2V0ID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgQml0U3R1ZmZlci5vcmlnaW5hbFVuc3R1ZmYoc3R1ZmZlZERhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgYml0c1BlclBpeGVsLCBudW1FbGVtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBCaXRTdHVmZmVyLnVuc3R1ZmYoc3R1ZmZlZERhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgYml0c1BlclBpeGVsLCBudW1FbGVtZW50cywgZmFsc2UsIG9mZnNldCwgc2NhbGUsIHpNYXgpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgcmVhZFRpbGVzOiBmdW5jdGlvbihpbnB1dCwgZGF0YSwgT3V0UGl4ZWxUeXBlQXJyYXkpIHsKICAgICAgICAgICAgICB2YXIgaGVhZGVySW5mbyA9IGRhdGEuaGVhZGVySW5mbzsKICAgICAgICAgICAgICB2YXIgd2lkdGggPSBoZWFkZXJJbmZvLndpZHRoOwogICAgICAgICAgICAgIHZhciBoZWlnaHQgPSBoZWFkZXJJbmZvLmhlaWdodDsKICAgICAgICAgICAgICB2YXIgbWljcm9CbG9ja1NpemUgPSBoZWFkZXJJbmZvLm1pY3JvQmxvY2tTaXplOwogICAgICAgICAgICAgIHZhciBpbWFnZVR5cGUgPSBoZWFkZXJJbmZvLmltYWdlVHlwZTsKICAgICAgICAgICAgICB2YXIgZGF0YVR5cGVTaXplID0gTGVyYzJIZWxwZXJzLmdldERhdGFUeXBlU2l6ZShpbWFnZVR5cGUpOwogICAgICAgICAgICAgIHZhciBudW1CbG9ja3NYID0gTWF0aC5jZWlsKHdpZHRoIC8gbWljcm9CbG9ja1NpemUpOwogICAgICAgICAgICAgIHZhciBudW1CbG9ja3NZID0gTWF0aC5jZWlsKGhlaWdodCAvIG1pY3JvQmxvY2tTaXplKTsKICAgICAgICAgICAgICBkYXRhLnBpeGVscy5udW1CbG9ja3NZID0gbnVtQmxvY2tzWTsKICAgICAgICAgICAgICBkYXRhLnBpeGVscy5udW1CbG9ja3NYID0gbnVtQmxvY2tzWDsKICAgICAgICAgICAgICBkYXRhLnBpeGVscy5wdHIgPSAwOwogICAgICAgICAgICAgIHZhciByb3cgPSAwLCBjb2wgPSAwLCBibG9ja1kgPSAwLCBibG9ja1ggPSAwLCB0aGlzQmxvY2tIZWlnaHQgPSAwLCB0aGlzQmxvY2tXaWR0aCA9IDAsIGJ5dGVzTGVmdCA9IDAsIGhlYWRlckJ5dGUgPSAwLCBiaXRzNjcgPSAwLCB0ZXN0Q29kZSA9IDAsIG91dFB0ciA9IDAsIG91dFN0cmlkZSA9IDAsIG51bUJ5dGVzID0gMCwgYnl0ZXNsZWZ0ID0gMCwgeiA9IDAsIGJsb2NrUHRyID0gMDsKICAgICAgICAgICAgICB2YXIgdmlldywgYmxvY2ssIGFycmF5QnVmLCBzdG9yZTgsIHJhd0RhdGE7CiAgICAgICAgICAgICAgdmFyIGJsb2NrRW5jb2Rpbmc7CiAgICAgICAgICAgICAgdmFyIGJsb2NrRGF0YUJ1ZmZlciA9IG5ldyBPdXRQaXhlbFR5cGVBcnJheShtaWNyb0Jsb2NrU2l6ZSAqIG1pY3JvQmxvY2tTaXplKTsKICAgICAgICAgICAgICB2YXIgbGFzdEJsb2NrSGVpZ2h0ID0gaGVpZ2h0ICUgbWljcm9CbG9ja1NpemUgfHwgbWljcm9CbG9ja1NpemU7CiAgICAgICAgICAgICAgdmFyIGxhc3RCbG9ja1dpZHRoID0gd2lkdGggJSBtaWNyb0Jsb2NrU2l6ZSB8fCBtaWNyb0Jsb2NrU2l6ZTsKICAgICAgICAgICAgICB2YXIgb2Zmc2V0VHlwZSwgb2Zmc2V0OwogICAgICAgICAgICAgIHZhciBudW1EaW1zID0gaGVhZGVySW5mby5udW1EaW1zLCBpRGltOwogICAgICAgICAgICAgIHZhciBtYXNrID0gZGF0YS5waXhlbHMucmVzdWx0TWFzazsKICAgICAgICAgICAgICB2YXIgcmVzdWx0UGl4ZWxzID0gZGF0YS5waXhlbHMucmVzdWx0UGl4ZWxzOwogICAgICAgICAgICAgIGZvciAoYmxvY2tZID0gMDsgYmxvY2tZIDwgbnVtQmxvY2tzWTsgYmxvY2tZKyspIHsKICAgICAgICAgICAgICAgIHRoaXNCbG9ja0hlaWdodCA9IGJsb2NrWSAhPT0gbnVtQmxvY2tzWSAtIDEgPyBtaWNyb0Jsb2NrU2l6ZSA6IGxhc3RCbG9ja0hlaWdodDsKICAgICAgICAgICAgICAgIGZvciAoYmxvY2tYID0gMDsgYmxvY2tYIDwgbnVtQmxvY2tzWDsgYmxvY2tYKyspIHsKICAgICAgICAgICAgICAgICAgdGhpc0Jsb2NrV2lkdGggPSBibG9ja1ggIT09IG51bUJsb2Nrc1ggLSAxID8gbWljcm9CbG9ja1NpemUgOiBsYXN0QmxvY2tXaWR0aDsKICAgICAgICAgICAgICAgICAgb3V0UHRyID0gYmxvY2tZICogd2lkdGggKiBtaWNyb0Jsb2NrU2l6ZSArIGJsb2NrWCAqIG1pY3JvQmxvY2tTaXplOwogICAgICAgICAgICAgICAgICBvdXRTdHJpZGUgPSB3aWR0aCAtIHRoaXNCbG9ja1dpZHRoOwogICAgICAgICAgICAgICAgICBmb3IgKGlEaW0gPSAwOyBpRGltIDwgbnVtRGltczsgaURpbSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG51bURpbXMgPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXN1bHRQaXhlbHMgPSBuZXcgT3V0UGl4ZWxUeXBlQXJyYXkoZGF0YS5waXhlbHMucmVzdWx0UGl4ZWxzLmJ1ZmZlciwgd2lkdGggKiBoZWlnaHQgKiBpRGltICogZGF0YVR5cGVTaXplLCB3aWR0aCAqIGhlaWdodCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJ5dGVzTGVmdCA9IGlucHV0LmJ5dGVMZW5ndGggLSBkYXRhLnB0cjsKICAgICAgICAgICAgICAgICAgICB2aWV3ID0gbmV3IERhdGFWaWV3KGlucHV0LCBkYXRhLnB0ciwgTWF0aC5taW4oMTAsIGJ5dGVzTGVmdCkpOwogICAgICAgICAgICAgICAgICAgIGJsb2NrID0ge307CiAgICAgICAgICAgICAgICAgICAgYmxvY2tQdHIgPSAwOwogICAgICAgICAgICAgICAgICAgIGhlYWRlckJ5dGUgPSB2aWV3LmdldFVpbnQ4KDApOwogICAgICAgICAgICAgICAgICAgIGJsb2NrUHRyKys7CiAgICAgICAgICAgICAgICAgICAgYml0czY3ID0gaGVhZGVyQnl0ZSA+PiA2ICYgMjU1OwogICAgICAgICAgICAgICAgICAgIHRlc3RDb2RlID0gaGVhZGVyQnl0ZSA+PiAyICYgMTU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRlc3RDb2RlICE9PSAoYmxvY2tYICogbWljcm9CbG9ja1NpemUgPj4gMyAmIDE1KSkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgImludGVncml0eSBpc3N1ZSI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJsb2NrRW5jb2RpbmcgPSBoZWFkZXJCeXRlICYgMzsKICAgICAgICAgICAgICAgICAgICBpZiAoYmxvY2tFbmNvZGluZyA+IDMpIHsKICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHRyICs9IGJsb2NrUHRyOwogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgIkludmFsaWQgYmxvY2sgZW5jb2RpbmcgKCIgKyBibG9ja0VuY29kaW5nICsgIikiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYmxvY2tFbmNvZGluZyA9PT0gMikgewogICAgICAgICAgICAgICAgICAgICAgZGF0YS5jb3VudGVyLmNvbnN0YW50Kys7CiAgICAgICAgICAgICAgICAgICAgICBkYXRhLnB0ciArPSBibG9ja1B0cjsKICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYmxvY2tFbmNvZGluZyA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgZGF0YS5jb3VudGVyLnVuY29tcHJlc3NlZCsrOwogICAgICAgICAgICAgICAgICAgICAgZGF0YS5wdHIgKz0gYmxvY2tQdHI7CiAgICAgICAgICAgICAgICAgICAgICBudW1CeXRlcyA9IHRoaXNCbG9ja0hlaWdodCAqIHRoaXNCbG9ja1dpZHRoICogZGF0YVR5cGVTaXplOwogICAgICAgICAgICAgICAgICAgICAgYnl0ZXNsZWZ0ID0gaW5wdXQuYnl0ZUxlbmd0aCAtIGRhdGEucHRyOwogICAgICAgICAgICAgICAgICAgICAgbnVtQnl0ZXMgPSBudW1CeXRlcyA8IGJ5dGVzbGVmdCA/IG51bUJ5dGVzIDogYnl0ZXNsZWZ0OwogICAgICAgICAgICAgICAgICAgICAgYXJyYXlCdWYgPSBuZXcgQXJyYXlCdWZmZXIobnVtQnl0ZXMgJSBkYXRhVHlwZVNpemUgPT09IDAgPyBudW1CeXRlcyA6IG51bUJ5dGVzICsgZGF0YVR5cGVTaXplIC0gbnVtQnl0ZXMgJSBkYXRhVHlwZVNpemUpOwogICAgICAgICAgICAgICAgICAgICAgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICAgICAgc3RvcmU4LnNldChuZXcgVWludDhBcnJheShpbnB1dCwgZGF0YS5wdHIsIG51bUJ5dGVzKSk7CiAgICAgICAgICAgICAgICAgICAgICByYXdEYXRhID0gbmV3IE91dFBpeGVsVHlwZUFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgICAgICAgIHogPSAwOwogICAgICAgICAgICAgICAgICAgICAgaWYgKG1hc2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChyb3cgPSAwOyByb3cgPCB0aGlzQmxvY2tIZWlnaHQ7IHJvdysrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb2wgPSAwOyBjb2wgPCB0aGlzQmxvY2tXaWR0aDsgY29sKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXNrW291dFB0cl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0UGl4ZWxzW291dFB0cl0gPSByYXdEYXRhW3orK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRQdHIrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0UHRyICs9IG91dFN0cmlkZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChyb3cgPSAwOyByb3cgPCB0aGlzQmxvY2tIZWlnaHQ7IHJvdysrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb2wgPSAwOyBjb2wgPCB0aGlzQmxvY2tXaWR0aDsgY29sKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1tvdXRQdHIrK10gPSByYXdEYXRhW3orK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIG91dFB0ciArPSBvdXRTdHJpZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHRyICs9IHogKiBkYXRhVHlwZVNpemU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIG9mZnNldFR5cGUgPSBMZXJjMkhlbHBlcnMuZ2V0RGF0YVR5cGVVc2VkKGltYWdlVHlwZSwgYml0czY3KTsKICAgICAgICAgICAgICAgICAgICAgIG9mZnNldCA9IExlcmMySGVscGVycy5nZXRPbmVQaXhlbChibG9jaywgYmxvY2tQdHIsIG9mZnNldFR5cGUsIHZpZXcpOwogICAgICAgICAgICAgICAgICAgICAgYmxvY2tQdHIgKz0gTGVyYzJIZWxwZXJzLmdldERhdGFUeXBlU2l6ZShvZmZzZXRUeXBlKTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChibG9ja0VuY29kaW5nID09PSAzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHRyICs9IGJsb2NrUHRyOwogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmNvdW50ZXIuY29uc3RhbnRvZmZzZXQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hc2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHJvdyA9IDA7IHJvdyA8IHRoaXNCbG9ja0hlaWdodDsgcm93KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoY29sID0gMDsgY29sIDwgdGhpc0Jsb2NrV2lkdGg7IGNvbCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXNrW291dFB0cl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRQaXhlbHNbb3V0UHRyXSA9IG9mZnNldDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRQdHIrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dFB0ciArPSBvdXRTdHJpZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAocm93ID0gMDsgcm93IDwgdGhpc0Jsb2NrSGVpZ2h0OyByb3crKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb2wgPSAwOyBjb2wgPCB0aGlzQmxvY2tXaWR0aDsgY29sKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0UGl4ZWxzW291dFB0cisrXSA9IG9mZnNldDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dFB0ciArPSBvdXRTdHJpZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLnB0ciArPSBibG9ja1B0cjsKICAgICAgICAgICAgICAgICAgICAgICAgTGVyYzJIZWxwZXJzLmRlY29kZUJpdHMoaW5wdXQsIGRhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgb2Zmc2V0LCBpRGltKTsKICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2tQdHIgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWFzaykgewogICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAocm93ID0gMDsgcm93IDwgdGhpc0Jsb2NrSGVpZ2h0OyByb3crKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb2wgPSAwOyBjb2wgPCB0aGlzQmxvY2tXaWR0aDsgY29sKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hc2tbb3V0UHRyXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1tvdXRQdHJdID0gYmxvY2tEYXRhQnVmZmVyW2Jsb2NrUHRyKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dFB0cisrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0UHRyICs9IG91dFN0cmlkZTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChyb3cgPSAwOyByb3cgPCB0aGlzQmxvY2tIZWlnaHQ7IHJvdysrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbCA9IDA7IGNvbCA8IHRoaXNCbG9ja1dpZHRoOyBjb2wrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRQaXhlbHNbb3V0UHRyKytdID0gYmxvY2tEYXRhQnVmZmVyW2Jsb2NrUHRyKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0UHRyICs9IG91dFN0cmlkZTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8qKioqKioqKioqKioqKioqKgogICAgICAgICAgICAqICBwcml2YXRlIG1ldGhvZHMgKGhlbHBlciBtZXRob2RzKQogICAgICAgICAgICAqKioqKioqKioqKioqKioqKi8KICAgICAgICAgICAgZm9ybWF0RmlsZUluZm86IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgImZpbGVJZGVudGlmaWVyU3RyaW5nIjogZGF0YS5oZWFkZXJJbmZvLmZpbGVJZGVudGlmaWVyU3RyaW5nLAogICAgICAgICAgICAgICAgImZpbGVWZXJzaW9uIjogZGF0YS5oZWFkZXJJbmZvLmZpbGVWZXJzaW9uLAogICAgICAgICAgICAgICAgImltYWdlVHlwZSI6IGRhdGEuaGVhZGVySW5mby5pbWFnZVR5cGUsCiAgICAgICAgICAgICAgICAiaGVpZ2h0IjogZGF0YS5oZWFkZXJJbmZvLmhlaWdodCwKICAgICAgICAgICAgICAgICJ3aWR0aCI6IGRhdGEuaGVhZGVySW5mby53aWR0aCwKICAgICAgICAgICAgICAgICJudW1WYWxpZFBpeGVsIjogZGF0YS5oZWFkZXJJbmZvLm51bVZhbGlkUGl4ZWwsCiAgICAgICAgICAgICAgICAibWljcm9CbG9ja1NpemUiOiBkYXRhLmhlYWRlckluZm8ubWljcm9CbG9ja1NpemUsCiAgICAgICAgICAgICAgICAiYmxvYlNpemUiOiBkYXRhLmhlYWRlckluZm8uYmxvYlNpemUsCiAgICAgICAgICAgICAgICAibWF4WkVycm9yIjogZGF0YS5oZWFkZXJJbmZvLm1heFpFcnJvciwKICAgICAgICAgICAgICAgICJwaXhlbFR5cGUiOiBMZXJjMkhlbHBlcnMuZ2V0UGl4ZWxUeXBlKGRhdGEuaGVhZGVySW5mby5pbWFnZVR5cGUpLAogICAgICAgICAgICAgICAgImVvZk9mZnNldCI6IGRhdGEuZW9mT2Zmc2V0LAogICAgICAgICAgICAgICAgIm1hc2siOiBkYXRhLm1hc2sgPyB7CiAgICAgICAgICAgICAgICAgICJudW1CeXRlcyI6IGRhdGEubWFzay5udW1CeXRlcwogICAgICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgICAgICAicGl4ZWxzIjogewogICAgICAgICAgICAgICAgICAibnVtQmxvY2tzWCI6IGRhdGEucGl4ZWxzLm51bUJsb2Nrc1gsCiAgICAgICAgICAgICAgICAgICJudW1CbG9ja3NZIjogZGF0YS5waXhlbHMubnVtQmxvY2tzWSwKICAgICAgICAgICAgICAgICAgLy8ibnVtQnl0ZXMiOiBkYXRhLnBpeGVscy5udW1CeXRlcywKICAgICAgICAgICAgICAgICAgIm1heFZhbHVlIjogZGF0YS5oZWFkZXJJbmZvLnpNYXgsCiAgICAgICAgICAgICAgICAgICJtaW5WYWx1ZSI6IGRhdGEuaGVhZGVySW5mby56TWluLAogICAgICAgICAgICAgICAgICAibm9EYXRhVmFsdWUiOiBkYXRhLm5vRGF0YVZhbHVlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY29uc3RydWN0Q29uc3RhbnRTdXJmYWNlOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgdmFyIHZhbCA9IGRhdGEuaGVhZGVySW5mby56TWF4OwogICAgICAgICAgICAgIHZhciBudW1EaW1zID0gZGF0YS5oZWFkZXJJbmZvLm51bURpbXM7CiAgICAgICAgICAgICAgdmFyIG51bVBpeGVscyA9IGRhdGEuaGVhZGVySW5mby5oZWlnaHQgKiBkYXRhLmhlYWRlckluZm8ud2lkdGg7CiAgICAgICAgICAgICAgdmFyIG51bVBpeGVsQWxsRGltcyA9IG51bVBpeGVscyAqIG51bURpbXM7CiAgICAgICAgICAgICAgdmFyIGkgPSAwLCBrID0gMCwgblN0YXJ0ID0gMDsKICAgICAgICAgICAgICB2YXIgbWFzayA9IGRhdGEucGl4ZWxzLnJlc3VsdE1hc2s7CiAgICAgICAgICAgICAgaWYgKG1hc2spIHsKICAgICAgICAgICAgICAgIGlmIChudW1EaW1zID4gMSkgewogICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtRGltczsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgblN0YXJ0ID0gaSAqIG51bVBpeGVsczsKICAgICAgICAgICAgICAgICAgICBmb3IgKGsgPSAwOyBrIDwgbnVtUGl4ZWxzOyBrKyspIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXNrW2tdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucGl4ZWxzLnJlc3VsdFBpeGVsc1tuU3RhcnQgKyBrXSA9IHZhbDsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGZvciAoayA9IDA7IGsgPCBudW1QaXhlbHM7IGsrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChtYXNrW2tdKSB7CiAgICAgICAgICAgICAgICAgICAgICBkYXRhLnBpeGVscy5yZXN1bHRQaXhlbHNba10gPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChkYXRhLnBpeGVscy5yZXN1bHRQaXhlbHMuZmlsbCkgewogICAgICAgICAgICAgICAgICBkYXRhLnBpeGVscy5yZXN1bHRQaXhlbHMuZmlsbCh2YWwpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZm9yIChrID0gMDsgayA8IG51bVBpeGVsQWxsRGltczsgaysrKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YS5waXhlbHMucmVzdWx0UGl4ZWxzW2tdID0gdmFsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0RGF0YVR5cGVBcnJheTogZnVuY3Rpb24odCkgewogICAgICAgICAgICAgIHZhciB0cDsKICAgICAgICAgICAgICBzd2l0Y2ggKHQpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgdHAgPSBJbnQ4QXJyYXk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgICB0cCA9IFVpbnQ4QXJyYXk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICB0cCA9IEludDE2QXJyYXk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgICB0cCA9IFVpbnQxNkFycmF5OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgICAgdHAgPSBJbnQzMkFycmF5OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICAgICAgdHAgPSBVaW50MzJBcnJheTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICAgIHRwID0gRmxvYXQzMkFycmF5OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICAgICAgdHAgPSBGbG9hdDY0QXJyYXk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgdHAgPSBGbG9hdDMyQXJyYXk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0cDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0UGl4ZWxUeXBlOiBmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgdmFyIHRwOwogICAgICAgICAgICAgIHN3aXRjaCAodCkgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICB0cCA9ICJTOCI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgICB0cCA9ICJVOCI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICB0cCA9ICJTMTYiOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgdHAgPSAiVTE2IjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICAgIHRwID0gIlMzMiI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgICB0cCA9ICJVMzIiOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICAgICAgdHAgPSAiRjMyIjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgICAgICAgIHRwID0gIkY2NCI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgdHAgPSAiRjMyIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRwOwogICAgICAgICAgICB9LAogICAgICAgICAgICBpc1ZhbGlkUGl4ZWxWYWx1ZTogZnVuY3Rpb24odCwgdmFsKSB7CiAgICAgICAgICAgICAgaWYgKHZhbCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBpc1ZhbGlkOwogICAgICAgICAgICAgIHN3aXRjaCAodCkgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICBpc1ZhbGlkID0gdmFsID49IC0xMjggJiYgdmFsIDw9IDEyNzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgIGlzVmFsaWQgPSB2YWwgPj0gMCAmJiB2YWwgPD0gMjU1OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgICAgaXNWYWxpZCA9IHZhbCA+PSAtMzI3NjggJiYgdmFsIDw9IDMyNzY3OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgaXNWYWxpZCA9IHZhbCA+PSAwICYmIHZhbCA8PSA2NTUzNjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICAgIGlzVmFsaWQgPSB2YWwgPj0gLTIxNDc0ODM2NDggJiYgdmFsIDw9IDIxNDc0ODM2NDc7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgICBpc1ZhbGlkID0gdmFsID49IDAgJiYgdmFsIDw9IDQyOTQ5NjcyOTY7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA2OgogICAgICAgICAgICAgICAgICBpc1ZhbGlkID0gdmFsID49IC0zNDAyNzk5OTM4NzkwMTQ4NGUyMiAmJiB2YWwgPD0gMzQwMjc5OTkzODc5MDE0ODRlMjI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgICAgICBpc1ZhbGlkID0gdmFsID49IDVlLTMyNCAmJiB2YWwgPD0gMTc5NzY5MzEzNDg2MjMxNTdlMjkyOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIGlzVmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGlzVmFsaWQ7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldERhdGFUeXBlU2l6ZTogZnVuY3Rpb24odCkgewogICAgICAgICAgICAgIHZhciBzID0gMDsKICAgICAgICAgICAgICBzd2l0Y2ggKHQpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgICAgcyA9IDE7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgICBzID0gMjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICAgIHMgPSA0OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICAgICAgcyA9IDg7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgcyA9IHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBzOwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXREYXRhVHlwZVVzZWQ6IGZ1bmN0aW9uKGR0LCB0YykgewogICAgICAgICAgICAgIHZhciB0ID0gZHQ7CiAgICAgICAgICAgICAgc3dpdGNoIChkdCkgewogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgICB0ID0gZHQgLSB0YzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgICAgICAgIHQgPSBkdCAtIDIgKiB0YzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICAgIGlmICgwID09PSB0YykgewogICAgICAgICAgICAgICAgICAgIHQgPSBkdDsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgxID09PSB0YykgewogICAgICAgICAgICAgICAgICAgIHQgPSAyOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHQgPSAxOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgICAgICBpZiAoMCA9PT0gdGMpIHsKICAgICAgICAgICAgICAgICAgICB0ID0gZHQ7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdCA9IGR0IC0gMiAqIHRjICsgMTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIHQgPSBkdDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0OwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXRPbmVQaXhlbDogZnVuY3Rpb24oYmxvY2ssIGJsb2NrUHRyLCBvZmZzZXRUeXBlLCB2aWV3KSB7CiAgICAgICAgICAgICAgdmFyIHRlbXAgPSAwOwogICAgICAgICAgICAgIHN3aXRjaCAob2Zmc2V0VHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICB0ZW1wID0gdmlldy5nZXRJbnQ4KGJsb2NrUHRyKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgIHRlbXAgPSB2aWV3LmdldFVpbnQ4KGJsb2NrUHRyKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICAgIHRlbXAgPSB2aWV3LmdldEludDE2KGJsb2NrUHRyLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICAgIHRlbXAgPSB2aWV3LmdldFVpbnQxNihibG9ja1B0ciwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgICB0ZW1wID0gdmlldy5nZXRJbnQzMihibG9ja1B0ciwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgICB0ZW1wID0gdmlldy5nZXRVSW50MzIoYmxvY2tQdHIsIHRydWUpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICAgICAgdGVtcCA9IHZpZXcuZ2V0RmxvYXQzMihibG9ja1B0ciwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgICAgICB0ZW1wID0gdmlldy5nZXRGbG9hdDY0KGJsb2NrUHRyLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICB0aHJvdyAidGhlIGRlY29kZXIgZG9lcyBub3QgdW5kZXJzdGFuZCB0aGlzIHBpeGVsIHR5cGUiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdGVtcDsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBUcmVlTm9kZSA9IGZ1bmN0aW9uKHZhbCwgbGVmdCwgcmlnaHQpIHsKICAgICAgICAgICAgdGhpcy52YWwgPSB2YWw7CiAgICAgICAgICAgIHRoaXMubGVmdCA9IGxlZnQ7CiAgICAgICAgICAgIHRoaXMucmlnaHQgPSByaWdodDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgTGVyYzJEZWNvZGUyID0gewogICAgICAgICAgICAvKgogICAgICAgICAgICAqICoqKioqKioqcmVtb3ZlZCBvcHRpb25zIGNvbXBhcmVkIHRvIExFUkMxLiBXZSBjYW4gYnJpbmcgc29tZSBvZiB0aGVtIGJhY2sgaWYgbmVlZGVkLgogICAgICAgICAgICAgKiByZW1vdmVkIHBpeGVsIHR5cGUuIExFUkMyIGlzIHR5cGVkIGFuZCBkb2Vzbid0IHJlcXVpcmUgdXNlciB0byBnaXZlIHBpeGVsIHR5cGUKICAgICAgICAgICAgICogY2hhbmdlZCBlbmNvZGVkTWFza0RhdGEgdG8gbWFza0RhdGEuIExFUkMyICdzIGpzIHZlcnNpb24gbWFrZSBpdCBmYXN0ZXIgdG8gdXNlIG1hc2tEYXRhIGRpcmVjdGx5LgogICAgICAgICAgICAgKiByZW1vdmVkIHJldHVybk1hc2suIG1hc2sgaXMgdXNlZCBieSBMRVJDMiBpbnRlcm5hbGx5IGFuZCBpcyBjb3N0IGZyZWUuIEluIGNhc2Ugb2YgdXNlciBpbnB1dCBtYXNrLCBpdCdzIHJldHVybmVkIGFzIHdlbGwgYW5kIGhhcyBuZWdsaWJsZSBjb3N0LgogICAgICAgICAgICAgKiByZW1vdmVkIG5vZGF0YXZhbHVlLiBCZWNhdXNlIExFUkMyIHBpeGVscyBhcmUgdHlwZWQsIG5vZGF0YXZhbHVlIHdpbGwgc2FjcmlmeSBhIHVzZWZ1bCB2YWx1ZSBmb3IgbWFueSB0eXBlcyAoOGJpdCwgMTZiaXQpIGV0YywKICAgICAgICAgICAgICogICAgICAgdXNlciBoYXMgdG8gYmUga25vd2xlZGdhYmxlIGVub3VnaCBhYm91dCByYXN0ZXIgYW5kIHRoZWlyIGRhdGEgdG8gYXZvaWQgdXNhYmlsaXR5IGlzc3Vlcy4gc28gbm9kYXRhIHZhbHVlIGlzIHNpbXBseSByZW1vdmVkIG5vdy4KICAgICAgICAgICAgICogICAgICAgV2UgY2FuIGFkZCBpdCBiYWNrIGxhdGVyIGlmIHRoZWlyJ3MgYSBjbGVhciByZXF1aXJlbWVudC4KICAgICAgICAgICAgICogcmVtb3ZlZCBlbmNvZGVkTWFzay4gVGhpcyBvcHRpb24gd2FzIG5vdCBpbXBsZW1lbnRlZCBpbiBMZXJjRGVjb2RlLiBJdCBjYW4gYmUgZG9uZSBhZnRlciBkZWNvZGluZyAobGVzcyBlZmZpY2llbnQpCiAgICAgICAgICAgICAqIHJlbW92ZWQgY29tcHV0ZVVzZWRCaXREZXB0aHMuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIHJlc3BvbnNlIGNoYW5nZXMgY29tcGFyZWQgdG8gTEVSQzEKICAgICAgICAgICAgICogMS4gZW5jb2RlZE1hc2tEYXRhIGlzIG5vdCBhdmFpbGFibGUKICAgICAgICAgICAgICogMi4gbm9EYXRhVmFsdWUgaXMgb3B0aW9uYWwgKHJldHVybnMgb25seSBpZiB1c2VyJ3Mgbm9EYXRhVmFsdWUgaXMgd2l0aCBpbiB0aGUgdmFsaWQgZGF0YSB0eXBlIHJhbmdlKQogICAgICAgICAgICAgKiAzLiBtYXNrRGF0YSBpcyBhbHdheXMgYXZhaWxhYmxlCiAgICAgICAgICAgICovCiAgICAgICAgICAgIC8qKioqKioqKioqKioqKioqKgogICAgICAgICAgICAqICBwdWJsaWMgcHJvcGVydGllcwogICAgICAgICAgICAqKioqKioqKioqKioqKioqKiovCiAgICAgICAgICAgIC8vSFVGRk1BTl9MVVRfQklUU19NQVg6IDEyLCAvL3VzZSAyXjEyIGx1dCwgbm90IGNvbmZpZ3VyYWJsZQogICAgICAgICAgICAvKioqKioqKioqKioqKioqKioKICAgICAgICAgICAgKiAgcHVibGljIG1ldGhvZHMKICAgICAgICAgICAgKioqKioqKioqKioqKioqKiovCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBEZWNvZGUgYSBMRVJDMiBieXRlIHN0cmVhbSBhbmQgcmV0dXJuIGFuIG9iamVjdCBjb250YWluaW5nIHRoZSBwaXhlbCBkYXRhIGFuZCBvcHRpb25hbCBtZXRhZGF0YS4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtBcnJheUJ1ZmZlcn0gaW5wdXQgVGhlIExFUkMgaW5wdXQgYnl0ZSBzdHJlYW0KICAgICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSBvcHRpb25zIERlY29kaW5nIG9wdGlvbnMKICAgICAgICAgICAgICogQHBhcmFtIHtudW1iZXJ9IFtvcHRpb25zLmlucHV0T2Zmc2V0XSBUaGUgbnVtYmVyIG9mIGJ5dGVzIHRvIHNraXAgaW4gdGhlIGlucHV0IGJ5dGUgc3RyZWFtLiBBIHZhbGlkIExFUkMgZmlsZSBpcyBleHBlY3RlZCBhdCB0aGF0IHBvc2l0aW9uCiAgICAgICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wdGlvbnMucmV0dXJuRmlsZUluZm9dIElmIHRydWUsIHRoZSByZXR1cm4gdmFsdWUgd2lsbCBoYXZlIGEgZmlsZUluZm8gcHJvcGVydHkgdGhhdCBjb250YWlucyBtZXRhZGF0YSBvYnRhaW5lZCBmcm9tIHRoZSBMRVJDIGhlYWRlcnMgYW5kIHRoZSBkZWNvZGluZyBwcm9jZXNzCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBkZWNvZGU6IGZ1bmN0aW9uKGlucHV0LCBvcHRpb25zKSB7CiAgICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgICAgICAgdmFyIG5vRGF0YVZhbHVlID0gb3B0aW9ucy5ub0RhdGFWYWx1ZTsKICAgICAgICAgICAgICB2YXIgaSA9IDAsIGRhdGEgPSB7fTsKICAgICAgICAgICAgICBkYXRhLnB0ciA9IG9wdGlvbnMuaW5wdXRPZmZzZXQgfHwgMDsKICAgICAgICAgICAgICBkYXRhLnBpeGVscyA9IHt9OwogICAgICAgICAgICAgIGlmICghTGVyYzJIZWxwZXJzLnJlYWRIZWFkZXJJbmZvKGlucHV0LCBkYXRhKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgaGVhZGVySW5mbyA9IGRhdGEuaGVhZGVySW5mbzsKICAgICAgICAgICAgICB2YXIgZmlsZVZlcnNpb24gPSBoZWFkZXJJbmZvLmZpbGVWZXJzaW9uOwogICAgICAgICAgICAgIHZhciBPdXRQaXhlbFR5cGVBcnJheSA9IExlcmMySGVscGVycy5nZXREYXRhVHlwZUFycmF5KGhlYWRlckluZm8uaW1hZ2VUeXBlKTsKICAgICAgICAgICAgICBMZXJjMkhlbHBlcnMucmVhZE1hc2soaW5wdXQsIGRhdGEpOwogICAgICAgICAgICAgIGlmIChoZWFkZXJJbmZvLm51bVZhbGlkUGl4ZWwgIT09IGhlYWRlckluZm8ud2lkdGggKiBoZWFkZXJJbmZvLmhlaWdodCAmJiAhZGF0YS5waXhlbHMucmVzdWx0TWFzaykgewogICAgICAgICAgICAgICAgZGF0YS5waXhlbHMucmVzdWx0TWFzayA9IG9wdGlvbnMubWFza0RhdGE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBudW1QaXhlbHMgPSBoZWFkZXJJbmZvLndpZHRoICogaGVhZGVySW5mby5oZWlnaHQ7CiAgICAgICAgICAgICAgZGF0YS5waXhlbHMucmVzdWx0UGl4ZWxzID0gbmV3IE91dFBpeGVsVHlwZUFycmF5KG51bVBpeGVscyAqIGhlYWRlckluZm8ubnVtRGltcyk7CiAgICAgICAgICAgICAgZGF0YS5jb3VudGVyID0gewogICAgICAgICAgICAgICAgb25lc3dlZXA6IDAsCiAgICAgICAgICAgICAgICB1bmNvbXByZXNzZWQ6IDAsCiAgICAgICAgICAgICAgICBsdXQ6IDAsCiAgICAgICAgICAgICAgICBiaXRzdHVmZmVyOiAwLAogICAgICAgICAgICAgICAgY29uc3RhbnQ6IDAsCiAgICAgICAgICAgICAgICBjb25zdGFudG9mZnNldDogMAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgaWYgKGhlYWRlckluZm8ubnVtVmFsaWRQaXhlbCAhPT0gMCkgewogICAgICAgICAgICAgICAgaWYgKGhlYWRlckluZm8uek1heCA9PT0gaGVhZGVySW5mby56TWluKSB7CiAgICAgICAgICAgICAgICAgIExlcmMySGVscGVycy5jb25zdHJ1Y3RDb25zdGFudFN1cmZhY2UoZGF0YSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGZpbGVWZXJzaW9uID49IDQgJiYgTGVyYzJIZWxwZXJzLmNoZWNrTWluTWF4UmFuZ2VzKGlucHV0LCBkYXRhKSkgewogICAgICAgICAgICAgICAgICBMZXJjMkhlbHBlcnMuY29uc3RydWN0Q29uc3RhbnRTdXJmYWNlKGRhdGEpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIHZpZXcgPSBuZXcgRGF0YVZpZXcoaW5wdXQsIGRhdGEucHRyLCAyKTsKICAgICAgICAgICAgICAgICAgdmFyIGJSZWFkRGF0YU9uZVN3ZWVwID0gdmlldy5nZXRVaW50OCgwKTsKICAgICAgICAgICAgICAgICAgZGF0YS5wdHIrKzsKICAgICAgICAgICAgICAgICAgaWYgKGJSZWFkRGF0YU9uZVN3ZWVwKSB7CiAgICAgICAgICAgICAgICAgICAgTGVyYzJIZWxwZXJzLnJlYWREYXRhT25lU3dlZXAoaW5wdXQsIGRhdGEsIE91dFBpeGVsVHlwZUFycmF5KTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZmlsZVZlcnNpb24gPiAxICYmIGhlYWRlckluZm8uaW1hZ2VUeXBlIDw9IDEgJiYgTWF0aC5hYnMoaGVhZGVySW5mby5tYXhaRXJyb3IgLSAwLjUpIDwgMWUtNSkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGZsYWdIdWZmbWFuID0gdmlldy5nZXRVaW50OCgxKTsKICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHRyKys7CiAgICAgICAgICAgICAgICAgICAgICBkYXRhLmVuY29kZU1vZGUgPSBmbGFnSHVmZm1hbjsKICAgICAgICAgICAgICAgICAgICAgIGlmIChmbGFnSHVmZm1hbiA+IDIgfHwgZmlsZVZlcnNpb24gPCA0ICYmIGZsYWdIdWZmbWFuID4gMSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyAiSW52YWxpZCBIdWZmbWFuIGZsYWcgIiArIGZsYWdIdWZmbWFuOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGZsYWdIdWZmbWFuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIExlcmMySGVscGVycy5yZWFkSHVmZm1hbihpbnB1dCwgZGF0YSwgT3V0UGl4ZWxUeXBlQXJyYXkpOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgTGVyYzJIZWxwZXJzLnJlYWRUaWxlcyhpbnB1dCwgZGF0YSwgT3V0UGl4ZWxUeXBlQXJyYXkpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBMZXJjMkhlbHBlcnMucmVhZFRpbGVzKGlucHV0LCBkYXRhLCBPdXRQaXhlbFR5cGVBcnJheSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRhdGEuZW9mT2Zmc2V0ID0gZGF0YS5wdHI7CiAgICAgICAgICAgICAgdmFyIGRpZmY7CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuaW5wdXRPZmZzZXQpIHsKICAgICAgICAgICAgICAgIGRpZmYgPSBkYXRhLmhlYWRlckluZm8uYmxvYlNpemUgKyBvcHRpb25zLmlucHV0T2Zmc2V0IC0gZGF0YS5wdHI7CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoZGlmZikgPj0gMSkgewogICAgICAgICAgICAgICAgICBkYXRhLmVvZk9mZnNldCA9IG9wdGlvbnMuaW5wdXRPZmZzZXQgKyBkYXRhLmhlYWRlckluZm8uYmxvYlNpemU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRpZmYgPSBkYXRhLmhlYWRlckluZm8uYmxvYlNpemUgLSBkYXRhLnB0cjsKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhkaWZmKSA+PSAxKSB7CiAgICAgICAgICAgICAgICAgIGRhdGEuZW9mT2Zmc2V0ID0gZGF0YS5oZWFkZXJJbmZvLmJsb2JTaXplOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgICAgICAgICAgd2lkdGg6IGhlYWRlckluZm8ud2lkdGgsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IGhlYWRlckluZm8uaGVpZ2h0LAogICAgICAgICAgICAgICAgcGl4ZWxEYXRhOiBkYXRhLnBpeGVscy5yZXN1bHRQaXhlbHMsCiAgICAgICAgICAgICAgICBtaW5WYWx1ZTogaGVhZGVySW5mby56TWluLAogICAgICAgICAgICAgICAgbWF4VmFsdWU6IGhlYWRlckluZm8uek1heCwKICAgICAgICAgICAgICAgIHZhbGlkUGl4ZWxDb3VudDogaGVhZGVySW5mby5udW1WYWxpZFBpeGVsLAogICAgICAgICAgICAgICAgZGltQ291bnQ6IGhlYWRlckluZm8ubnVtRGltcywKICAgICAgICAgICAgICAgIGRpbVN0YXRzOiB7CiAgICAgICAgICAgICAgICAgIG1pblZhbHVlczogaGVhZGVySW5mby5taW5WYWx1ZXMsCiAgICAgICAgICAgICAgICAgIG1heFZhbHVlczogaGVhZGVySW5mby5tYXhWYWx1ZXMKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBtYXNrRGF0YTogZGF0YS5waXhlbHMucmVzdWx0TWFzawogICAgICAgICAgICAgICAgLy9ub0RhdGFWYWx1ZTogbm9EYXRhVmFsdWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGlmIChkYXRhLnBpeGVscy5yZXN1bHRNYXNrICYmIExlcmMySGVscGVycy5pc1ZhbGlkUGl4ZWxWYWx1ZShoZWFkZXJJbmZvLmltYWdlVHlwZSwgbm9EYXRhVmFsdWUpKSB7CiAgICAgICAgICAgICAgICB2YXIgbWFzayA9IGRhdGEucGl4ZWxzLnJlc3VsdE1hc2s7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtUGl4ZWxzOyBpKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKCFtYXNrW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnBpeGVsRGF0YVtpXSA9IG5vRGF0YVZhbHVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXN1bHQubm9EYXRhVmFsdWUgPSBub0RhdGFWYWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGF0YS5ub0RhdGFWYWx1ZSA9IG5vRGF0YVZhbHVlOwogICAgICAgICAgICAgIGlmIChvcHRpb25zLnJldHVybkZpbGVJbmZvKSB7CiAgICAgICAgICAgICAgICByZXN1bHQuZmlsZUluZm8gPSBMZXJjMkhlbHBlcnMuZm9ybWF0RmlsZUluZm8oZGF0YSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldEJhbmRDb3VudDogZnVuY3Rpb24oaW5wdXQpIHsKICAgICAgICAgICAgICB2YXIgY291bnQgPSAwOwogICAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgICB2YXIgdGVtcCA9IHt9OwogICAgICAgICAgICAgIHRlbXAucHRyID0gMDsKICAgICAgICAgICAgICB0ZW1wLnBpeGVscyA9IHt9OwogICAgICAgICAgICAgIHdoaWxlIChpIDwgaW5wdXQuYnl0ZUxlbmd0aCAtIDU4KSB7CiAgICAgICAgICAgICAgICBMZXJjMkhlbHBlcnMucmVhZEhlYWRlckluZm8oaW5wdXQsIHRlbXApOwogICAgICAgICAgICAgICAgaSArPSB0ZW1wLmhlYWRlckluZm8uYmxvYlNpemU7CiAgICAgICAgICAgICAgICBjb3VudCsrOwogICAgICAgICAgICAgICAgdGVtcC5wdHIgPSBpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gY291bnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gTGVyYzJEZWNvZGUyOwogICAgICAgIH0oKTsKICAgICAgICB2YXIgaXNQbGF0Zm9ybUxpdHRsZUVuZGlhbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGEzID0gbmV3IEFycmF5QnVmZmVyKDQpOwogICAgICAgICAgdmFyIGIgPSBuZXcgVWludDhBcnJheShhMyk7CiAgICAgICAgICB2YXIgYyA9IG5ldyBVaW50MzJBcnJheShhMyk7CiAgICAgICAgICBjWzBdID0gMTsKICAgICAgICAgIHJldHVybiBiWzBdID09PSAxOwogICAgICAgIH0oKTsKICAgICAgICB2YXIgTGVyYzIgPSB7CiAgICAgICAgICAvKioqKioqKioqKioqd3JhcHBlcioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEEgd3JhcHBlciBmb3IgZGVjb2RpbmcgYm90aCBMRVJDMSBhbmQgTEVSQzIgYnl0ZSBzdHJlYW1zIGNhcGFibGUgb2YgaGFuZGxpbmcgbXVsdGliYW5kIHBpeGVsIGJsb2NrcyBmb3IgdmFyaW91cyBwaXhlbCB0eXBlcy4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAYWxpYXMgbW9kdWxlOkxlcmMKICAgICAgICAgICAqIEBwYXJhbSB7QXJyYXlCdWZmZXJ9IGlucHV0IFRoZSBMRVJDIGlucHV0IGJ5dGUgc3RyZWFtCiAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIFRoZSBkZWNvZGluZyBvcHRpb25zIGJlbG93IGFyZSBvcHRpb25hbC4KICAgICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbb3B0aW9ucy5pbnB1dE9mZnNldF0gVGhlIG51bWJlciBvZiBieXRlcyB0byBza2lwIGluIHRoZSBpbnB1dCBieXRlIHN0cmVhbS4gQSB2YWxpZCBMZXJjIGZpbGUgaXMgZXhwZWN0ZWQgYXQgdGhhdCBwb3NpdGlvbi4KICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbb3B0aW9ucy5waXhlbFR5cGVdIChMRVJDMSBvbmx5KSBEZWZhdWx0IHZhbHVlIGlzIEYzMi4gVmFsaWQgcGl4ZWwgdHlwZXMgZm9yIGlucHV0IGFyZSBVOC9TOC9TMTYvVTE2L1MzMi9VMzIvRjMyLgogICAgICAgICAgICogQHBhcmFtIHtudW1iZXJ9IFtvcHRpb25zLm5vRGF0YVZhbHVlXSAoTEVSQzEgb25seSkuIEl0IGlzIHJlY29tbWVuZGVkIHRvIHVzZSB0aGUgcmV0dXJuZWQgbWFzayBpbnN0ZWFkIG9mIHNldHRpbmcgdGhpcyB2YWx1ZS4KICAgICAgICAgICAqIEByZXR1cm5zIHt7d2lkdGgsIGhlaWdodCwgcGl4ZWxzLCBwaXhlbFR5cGUsIG1hc2ssIHN0YXRpc3RpY3N9fQogICAgICAgICAgICAgKiBAcHJvcGVydHkge251bWJlcn0gd2lkdGggV2lkdGggb2YgZGVjb2RlZCBpbWFnZS4KICAgICAgICAgICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGhlaWdodCBIZWlnaHQgb2YgZGVjb2RlZCBpbWFnZS4KICAgICAgICAgICAgICogQHByb3BlcnR5IHthcnJheX0gcGl4ZWxzIFtiYW5kMSwgYmFuZDIsIOKApl0gRWFjaCBiYW5kIGlzIGEgdHlwZWQgYXJyYXkgb2Ygd2lkdGgqaGVpZ2h0LgogICAgICAgICAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gcGl4ZWxUeXBlIFRoZSB0eXBlIG9mIHBpeGVscyByZXByZXNlbnRlZCBpbiB0aGUgb3V0cHV0LgogICAgICAgICAgICAgKiBAcHJvcGVydHkge21hc2t9IG1hc2sgVHlwZWQgYXJyYXkgd2l0aCBhIHNpemUgb2Ygd2lkdGgqaGVpZ2h0LCBvciBudWxsIGlmIGFsbCBwaXhlbHMgYXJlIHZhbGlkLgogICAgICAgICAgICAgKiBAcHJvcGVydHkge2FycmF5fSBzdGF0aXN0aWNzIFtzdGF0aXN0aWNzX2JhbmQxLCBzdGF0aXN0aWNzX2JhbmQyLCDigKZdIEVhY2ggZWxlbWVudCBpcyBhIHN0YXRpc3RpY3Mgb2JqZWN0IHJlcHJlc2VudGluZyBtaW4gYW5kIG1heCB2YWx1ZXMKICAgICAgICAgICoqLwogICAgICAgICAgZGVjb2RlOiBmdW5jdGlvbihlbmNvZGVkRGF0YSwgb3B0aW9ucykgewogICAgICAgICAgICBpZiAoIWlzUGxhdGZvcm1MaXR0bGVFbmRpYW4pIHsKICAgICAgICAgICAgICB0aHJvdyAiQmlnIGVuZGlhbiBzeXN0ZW0gaXMgbm90IHN1cHBvcnRlZC4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgICAgICB2YXIgaW5wdXRPZmZzZXQgPSBvcHRpb25zLmlucHV0T2Zmc2V0IHx8IDA7CiAgICAgICAgICAgIHZhciBmaWxlSWRWaWV3ID0gbmV3IFVpbnQ4QXJyYXkoZW5jb2RlZERhdGEsIGlucHV0T2Zmc2V0LCAxMCk7CiAgICAgICAgICAgIHZhciBmaWxlSWRlbnRpZmllclN0cmluZyA9IFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkobnVsbCwgZmlsZUlkVmlldyk7CiAgICAgICAgICAgIHZhciBsZXJjLCBtYWpvclZlcnNpb247CiAgICAgICAgICAgIGlmIChmaWxlSWRlbnRpZmllclN0cmluZy50cmltKCkgPT09ICJDbnRaSW1hZ2UiKSB7CiAgICAgICAgICAgICAgbGVyYyA9IExlcmNEZWNvZGU7CiAgICAgICAgICAgICAgbWFqb3JWZXJzaW9uID0gMTsKICAgICAgICAgICAgfSBlbHNlIGlmIChmaWxlSWRlbnRpZmllclN0cmluZy5zdWJzdHJpbmcoMCwgNSkgPT09ICJMZXJjMiIpIHsKICAgICAgICAgICAgICBsZXJjID0gTGVyYzJEZWNvZGU7CiAgICAgICAgICAgICAgbWFqb3JWZXJzaW9uID0gMjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aHJvdyAiVW5leHBlY3RlZCBmaWxlIGlkZW50aWZpZXIgc3RyaW5nOiAiICsgZmlsZUlkZW50aWZpZXJTdHJpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGlQbGFuZSA9IDAsIGVvZiA9IGVuY29kZWREYXRhLmJ5dGVMZW5ndGggLSAxMCwgZW5jb2RlZE1hc2tEYXRhLCBiYW5kTWFza3MgPSBbXSwgYmFuZE1hc2ssIG1hc2tEYXRhOwogICAgICAgICAgICB2YXIgZGVjb2RlZFBpeGVsQmxvY2sgPSB7CiAgICAgICAgICAgICAgd2lkdGg6IDAsCiAgICAgICAgICAgICAgaGVpZ2h0OiAwLAogICAgICAgICAgICAgIHBpeGVsczogW10sCiAgICAgICAgICAgICAgcGl4ZWxUeXBlOiBvcHRpb25zLnBpeGVsVHlwZSwKICAgICAgICAgICAgICBtYXNrOiBudWxsLAogICAgICAgICAgICAgIHN0YXRpc3RpY3M6IFtdCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHdoaWxlIChpbnB1dE9mZnNldCA8IGVvZikgewogICAgICAgICAgICAgIHZhciByZXN1bHQgPSBsZXJjLmRlY29kZShlbmNvZGVkRGF0YSwgewogICAgICAgICAgICAgICAgaW5wdXRPZmZzZXQsCiAgICAgICAgICAgICAgICAvL2ZvciBib3RoIGxlcmMxIGFuZCBsZXJjMgogICAgICAgICAgICAgICAgZW5jb2RlZE1hc2tEYXRhLAogICAgICAgICAgICAgICAgLy9sZXJjMSBvbmx5CiAgICAgICAgICAgICAgICBtYXNrRGF0YSwKICAgICAgICAgICAgICAgIC8vbGVyYzIgb25seQogICAgICAgICAgICAgICAgcmV0dXJuTWFzazogaVBsYW5lID09PSAwID8gdHJ1ZSA6IGZhbHNlLAogICAgICAgICAgICAgICAgLy9sZXJjMSBvbmx5CiAgICAgICAgICAgICAgICByZXR1cm5FbmNvZGVkTWFzazogaVBsYW5lID09PSAwID8gdHJ1ZSA6IGZhbHNlLAogICAgICAgICAgICAgICAgLy9sZXJjMSBvbmx5CiAgICAgICAgICAgICAgICByZXR1cm5GaWxlSW5mbzogdHJ1ZSwKICAgICAgICAgICAgICAgIC8vZm9yIGJvdGggbGVyYzEgYW5kIGxlcmMyCiAgICAgICAgICAgICAgICBwaXhlbFR5cGU6IG9wdGlvbnMucGl4ZWxUeXBlIHx8IG51bGwsCiAgICAgICAgICAgICAgICAvL2xlcmMxIG9ubHkKICAgICAgICAgICAgICAgIG5vRGF0YVZhbHVlOiBvcHRpb25zLm5vRGF0YVZhbHVlIHx8IG51bGwKICAgICAgICAgICAgICAgIC8vbGVyYzEgb25seQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlucHV0T2Zmc2V0ID0gcmVzdWx0LmZpbGVJbmZvLmVvZk9mZnNldDsKICAgICAgICAgICAgICBpZiAoaVBsYW5lID09PSAwKSB7CiAgICAgICAgICAgICAgICBlbmNvZGVkTWFza0RhdGEgPSByZXN1bHQuZW5jb2RlZE1hc2tEYXRhOwogICAgICAgICAgICAgICAgbWFza0RhdGEgPSByZXN1bHQubWFza0RhdGE7CiAgICAgICAgICAgICAgICBkZWNvZGVkUGl4ZWxCbG9jay53aWR0aCA9IHJlc3VsdC53aWR0aDsKICAgICAgICAgICAgICAgIGRlY29kZWRQaXhlbEJsb2NrLmhlaWdodCA9IHJlc3VsdC5oZWlnaHQ7CiAgICAgICAgICAgICAgICBkZWNvZGVkUGl4ZWxCbG9jay5kaW1Db3VudCA9IHJlc3VsdC5kaW1Db3VudCB8fCAxOwogICAgICAgICAgICAgICAgZGVjb2RlZFBpeGVsQmxvY2sucGl4ZWxUeXBlID0gcmVzdWx0LnBpeGVsVHlwZSB8fCByZXN1bHQuZmlsZUluZm8ucGl4ZWxUeXBlOwogICAgICAgICAgICAgICAgZGVjb2RlZFBpeGVsQmxvY2subWFzayA9IHJlc3VsdC5tYXNrRGF0YTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG1ham9yVmVyc2lvbiA+IDEgJiYgcmVzdWx0LmZpbGVJbmZvLm1hc2sgJiYgcmVzdWx0LmZpbGVJbmZvLm1hc2subnVtQnl0ZXMgPiAwKSB7CiAgICAgICAgICAgICAgICBiYW5kTWFza3MucHVzaChyZXN1bHQubWFza0RhdGEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpUGxhbmUrKzsKICAgICAgICAgICAgICBkZWNvZGVkUGl4ZWxCbG9jay5waXhlbHMucHVzaChyZXN1bHQucGl4ZWxEYXRhKTsKICAgICAgICAgICAgICBkZWNvZGVkUGl4ZWxCbG9jay5zdGF0aXN0aWNzLnB1c2goewogICAgICAgICAgICAgICAgbWluVmFsdWU6IHJlc3VsdC5taW5WYWx1ZSwKICAgICAgICAgICAgICAgIG1heFZhbHVlOiByZXN1bHQubWF4VmFsdWUsCiAgICAgICAgICAgICAgICBub0RhdGFWYWx1ZTogcmVzdWx0Lm5vRGF0YVZhbHVlLAogICAgICAgICAgICAgICAgZGltU3RhdHM6IHJlc3VsdC5kaW1TdGF0cwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpLCBqLCBudW1QaXhlbHM7CiAgICAgICAgICAgIGlmIChtYWpvclZlcnNpb24gPiAxICYmIGJhbmRNYXNrcy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgbnVtUGl4ZWxzID0gZGVjb2RlZFBpeGVsQmxvY2sud2lkdGggKiBkZWNvZGVkUGl4ZWxCbG9jay5oZWlnaHQ7CiAgICAgICAgICAgICAgZGVjb2RlZFBpeGVsQmxvY2suYmFuZE1hc2tzID0gYmFuZE1hc2tzOwogICAgICAgICAgICAgIG1hc2tEYXRhID0gbmV3IFVpbnQ4QXJyYXkobnVtUGl4ZWxzKTsKICAgICAgICAgICAgICBtYXNrRGF0YS5zZXQoYmFuZE1hc2tzWzBdKTsKICAgICAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgYmFuZE1hc2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBiYW5kTWFzayA9IGJhbmRNYXNrc1tpXTsKICAgICAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBudW1QaXhlbHM7IGorKykgewogICAgICAgICAgICAgICAgICBtYXNrRGF0YVtqXSA9IG1hc2tEYXRhW2pdICYgYmFuZE1hc2tbal07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlY29kZWRQaXhlbEJsb2NrLm1hc2tEYXRhID0gbWFza0RhdGE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRlY29kZWRQaXhlbEJsb2NrOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgewogICAgICAgICAgZGVmaW5lKFtdLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIExlcmMyOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbW9kdWxlICE9PSAidW5kZWZpbmVkIiAmJiBtb2R1bGUuZXhwb3J0cykgewogICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBMZXJjMjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5MZXJjID0gTGVyYzI7CiAgICAgICAgfQogICAgICB9KSgpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVmVydGljZXNGcm9tSGVpZ2h0bWFwLmpzCiAgdmFyIGNyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcF9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlVmVydGljZXNGcm9tSGVpZ2h0bWFwX2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcF9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlVmVydGljZXNGcm9tSGVpZ2h0bWFwKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGlmIChwYXJhbWV0ZXJzLmVuY29kaW5nID09PSBIZWlnaHRtYXBFbmNvZGluZ19kZWZhdWx0LkxFUkMpIHsKICAgICAgbGV0IHJlc3VsdDsKICAgICAgdHJ5IHsKICAgICAgICByZXN1bHQgPSBpbXBvcnRfbGVyYy5kZWZhdWx0LmRlY29kZShwYXJhbWV0ZXJzLmhlaWdodG1hcCk7CiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KGVycm9yKTsKICAgICAgfQogICAgICBjb25zdCBsZXJjU3RhdGlzdGljcyA9IHJlc3VsdC5zdGF0aXN0aWNzWzBdOwogICAgICBpZiAobGVyY1N0YXRpc3RpY3MubWluVmFsdWUgPT09IE51bWJlci5NQVhfVkFMVUUpIHsKICAgICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIkludmFsaWQgdGlsZSBkYXRhIik7CiAgICAgIH0KICAgICAgcGFyYW1ldGVycy5oZWlnaHRtYXAgPSByZXN1bHQucGl4ZWxzWzBdOwogICAgICBwYXJhbWV0ZXJzLndpZHRoID0gcmVzdWx0LndpZHRoOwogICAgICBwYXJhbWV0ZXJzLmhlaWdodCA9IHJlc3VsdC5oZWlnaHQ7CiAgICB9CiAgICBwYXJhbWV0ZXJzLmVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKHBhcmFtZXRlcnMuZWxsaXBzb2lkKTsKICAgIHBhcmFtZXRlcnMucmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUocGFyYW1ldGVycy5yZWN0YW5nbGUpOwogICAgY29uc3Qgc3RhdGlzdGljczIgPSBIZWlnaHRtYXBUZXNzZWxsYXRvcl9kZWZhdWx0LmNvbXB1dGVWZXJ0aWNlcyhwYXJhbWV0ZXJzKTsKICAgIGNvbnN0IHZlcnRpY2VzID0gc3RhdGlzdGljczIudmVydGljZXM7CiAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2godmVydGljZXMuYnVmZmVyKTsKICAgIHJldHVybiB7CiAgICAgIHZlcnRpY2VzOiB2ZXJ0aWNlcy5idWZmZXIsCiAgICAgIG51bWJlck9mQXR0cmlidXRlczogc3RhdGlzdGljczIuZW5jb2Rpbmcuc3RyaWRlLAogICAgICBtaW5pbXVtSGVpZ2h0OiBzdGF0aXN0aWNzMi5taW5pbXVtSGVpZ2h0LAogICAgICBtYXhpbXVtSGVpZ2h0OiBzdGF0aXN0aWNzMi5tYXhpbXVtSGVpZ2h0LAogICAgICBncmlkV2lkdGg6IHBhcmFtZXRlcnMud2lkdGgsCiAgICAgIGdyaWRIZWlnaHQ6IHBhcmFtZXRlcnMuaGVpZ2h0LAogICAgICBib3VuZGluZ1NwaGVyZTNEOiBzdGF0aXN0aWNzMi5ib3VuZGluZ1NwaGVyZTNELAogICAgICBvcmllbnRlZEJvdW5kaW5nQm94OiBzdGF0aXN0aWNzMi5vcmllbnRlZEJvdW5kaW5nQm94LAogICAgICBvY2NsdWRlZVBvaW50SW5TY2FsZWRTcGFjZTogc3RhdGlzdGljczIub2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2UsCiAgICAgIGVuY29kaW5nOiBzdGF0aXN0aWNzMi5lbmNvZGluZywKICAgICAgd2VzdEluZGljZXNTb3V0aFRvTm9ydGg6IHN0YXRpc3RpY3MyLndlc3RJbmRpY2VzU291dGhUb05vcnRoLAogICAgICBzb3V0aEluZGljZXNFYXN0VG9XZXN0OiBzdGF0aXN0aWNzMi5zb3V0aEluZGljZXNFYXN0VG9XZXN0LAogICAgICBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aDogc3RhdGlzdGljczIuZWFzdEluZGljZXNOb3J0aFRvU291dGgsCiAgICAgIG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3Q6IHN0YXRpc3RpY3MyLm5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QKICAgIH07CiAgfQogIHZhciBpbXBvcnRfbGVyYywgY3JlYXRlVmVydGljZXNGcm9tSGVpZ2h0bWFwX2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlVmVydGljZXNGcm9tSGVpZ2h0bWFwID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVWZXJ0aWNlc0Zyb21IZWlnaHRtYXAuanMiKCkgewogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0hlaWdodG1hcEVuY29kaW5nKCk7CiAgICAgIGluaXRfSGVpZ2h0bWFwVGVzc2VsbGF0b3IoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9SdW50aW1lRXJyb3IoKTsKICAgICAgaW1wb3J0X2xlcmMgPSBfX3RvRVNNKHJlcXVpcmVfTGVyY0RlY29kZSgpLCAxKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIGNyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcF9kZWZhdWx0ID0gY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0KGNyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcCk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9UZXJyYWluUHJvdmlkZXIuanMKICBmdW5jdGlvbiBUZXJyYWluUHJvdmlkZXIoKSB7CiAgICBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0LnRocm93SW5zdGFudGlhdGlvbkVycm9yKCk7CiAgfQogIGZ1bmN0aW9uIGdldEVkZ2VJbmRpY2VzKHdpZHRoLCBoZWlnaHQpIHsKICAgIGNvbnN0IHdlc3RJbmRpY2VzU291dGhUb05vcnRoID0gbmV3IEFycmF5KGhlaWdodCk7CiAgICBjb25zdCBzb3V0aEluZGljZXNFYXN0VG9XZXN0ID0gbmV3IEFycmF5KHdpZHRoKTsKICAgIGNvbnN0IGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoID0gbmV3IEFycmF5KGhlaWdodCk7CiAgICBjb25zdCBub3J0aEluZGljZXNXZXN0VG9FYXN0ID0gbmV3IEFycmF5KHdpZHRoKTsKICAgIGxldCBpOwogICAgZm9yIChpID0gMDsgaSA8IHdpZHRoOyArK2kpIHsKICAgICAgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdFtpXSA9IGk7CiAgICAgIHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3RbaV0gPSB3aWR0aCAqIGhlaWdodCAtIDEgLSBpOwogICAgfQogICAgZm9yIChpID0gMDsgaSA8IGhlaWdodDsgKytpKSB7CiAgICAgIGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoW2ldID0gKGkgKyAxKSAqIHdpZHRoIC0gMTsKICAgICAgd2VzdEluZGljZXNTb3V0aFRvTm9ydGhbaV0gPSAoaGVpZ2h0IC0gaSAtIDEpICogd2lkdGg7CiAgICB9CiAgICByZXR1cm4gewogICAgICB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aCwKICAgICAgc291dGhJbmRpY2VzRWFzdFRvV2VzdCwKICAgICAgZWFzdEluZGljZXNOb3J0aFRvU291dGgsCiAgICAgIG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QKICAgIH07CiAgfQogIGZ1bmN0aW9uIGFkZFJlZ3VsYXJHcmlkSW5kaWNlcyh3aWR0aCwgaGVpZ2h0LCBpbmRpY2VzLCBvZmZzZXQpIHsKICAgIGxldCBpbmRleCA9IDA7CiAgICBmb3IgKGxldCBqID0gMDsgaiA8IGhlaWdodCAtIDE7ICsraikgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHdpZHRoIC0gMTsgKytpKSB7CiAgICAgICAgY29uc3QgdXBwZXJMZWZ0ID0gaW5kZXg7CiAgICAgICAgY29uc3QgbG93ZXJMZWZ0ID0gdXBwZXJMZWZ0ICsgd2lkdGg7CiAgICAgICAgY29uc3QgbG93ZXJSaWdodCA9IGxvd2VyTGVmdCArIDE7CiAgICAgICAgY29uc3QgdXBwZXJSaWdodCA9IHVwcGVyTGVmdCArIDE7CiAgICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSB1cHBlckxlZnQ7CiAgICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSBsb3dlckxlZnQ7CiAgICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSB1cHBlclJpZ2h0OwogICAgICAgIGluZGljZXNbb2Zmc2V0KytdID0gdXBwZXJSaWdodDsKICAgICAgICBpbmRpY2VzW29mZnNldCsrXSA9IGxvd2VyTGVmdDsKICAgICAgICBpbmRpY2VzW29mZnNldCsrXSA9IGxvd2VyUmlnaHQ7CiAgICAgICAgKytpbmRleDsKICAgICAgfQogICAgICArK2luZGV4OwogICAgfQogIH0KICBmdW5jdGlvbiBhZGRTa2lydEluZGljZXMoZWRnZUluZGljZXMsIHZlcnRleEluZGV4LCBpbmRpY2VzLCBvZmZzZXQpIHsKICAgIGxldCBwcmV2aW91c0luZGV4ID0gZWRnZUluZGljZXNbMF07CiAgICBjb25zdCBsZW5ndGggPSBlZGdlSW5kaWNlcy5sZW5ndGg7CiAgICBmb3IgKGxldCBpID0gMTsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGNvbnN0IGluZGV4ID0gZWRnZUluZGljZXNbaV07CiAgICAgIGluZGljZXNbb2Zmc2V0KytdID0gcHJldmlvdXNJbmRleDsKICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSBpbmRleDsKICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSB2ZXJ0ZXhJbmRleDsKICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSB2ZXJ0ZXhJbmRleDsKICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSBpbmRleDsKICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSB2ZXJ0ZXhJbmRleCArIDE7CiAgICAgIHByZXZpb3VzSW5kZXggPSBpbmRleDsKICAgICAgKyt2ZXJ0ZXhJbmRleDsKICAgIH0KICAgIHJldHVybiBvZmZzZXQ7CiAgfQogIHZhciByZWd1bGFyR3JpZEluZGljZXNDYWNoZSwgcmVndWxhckdyaWRBbmRFZGdlSW5kaWNlc0NhY2hlLCByZWd1bGFyR3JpZEFuZFNraXJ0QW5kRWRnZUluZGljZXNDYWNoZSwgVGVycmFpblByb3ZpZGVyX2RlZmF1bHQ7CiAgdmFyIGluaXRfVGVycmFpblByb3ZpZGVyID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9UZXJyYWluUHJvdmlkZXIuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFRlcnJhaW5Qcm92aWRlci5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIGFuIGV2ZW50IHRoYXQgaXMgcmFpc2VkIHdoZW4gdGhlIHRlcnJhaW4gcHJvdmlkZXIgZW5jb3VudGVycyBhbiBhc3luY2hyb25vdXMgZXJyb3IuICBCeSBzdWJzY3JpYmluZwogICAgICAgICAqIHRvIHRoZSBldmVudCwgeW91IHdpbGwgYmUgbm90aWZpZWQgb2YgdGhlIGVycm9yIGFuZCBjYW4gcG90ZW50aWFsbHkgcmVjb3ZlciBmcm9tIGl0LiAgRXZlbnQgbGlzdGVuZXJzCiAgICAgICAgICogYXJlIHBhc3NlZCBhbiBpbnN0YW5jZSBvZiB7QGxpbmsgVGlsZVByb3ZpZGVyRXJyb3J9LgogICAgICAgICAqIEBtZW1iZXJvZiBUZXJyYWluUHJvdmlkZXIucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0V2ZW50PFRlcnJhaW5Qcm92aWRlci5FcnJvckV2ZW50Pn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBlcnJvckV2ZW50OiB7CiAgICAgICAgICBnZXQ6IERldmVsb3BlckVycm9yX2RlZmF1bHQudGhyb3dJbnN0YW50aWF0aW9uRXJyb3IKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGNyZWRpdCB0byBkaXNwbGF5IHdoZW4gdGhpcyB0ZXJyYWluIHByb3ZpZGVyIGlzIGFjdGl2ZS4gIFR5cGljYWxseSB0aGlzIGlzIHVzZWQgdG8gY3JlZGl0CiAgICAgICAgICogdGhlIHNvdXJjZSBvZiB0aGUgdGVycmFpbi4KICAgICAgICAgKiBAbWVtYmVyb2YgVGVycmFpblByb3ZpZGVyLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDcmVkaXR9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgY3JlZGl0OiB7CiAgICAgICAgICBnZXQ6IERldmVsb3BlckVycm9yX2RlZmF1bHQudGhyb3dJbnN0YW50aWF0aW9uRXJyb3IKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHRpbGluZyBzY2hlbWUgdXNlZCBieSB0aGUgcHJvdmlkZXIuCiAgICAgICAgICogQG1lbWJlcm9mIFRlcnJhaW5Qcm92aWRlci5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7VGlsaW5nU2NoZW1lfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIHRpbGluZ1NjaGVtZTogewogICAgICAgICAgZ2V0OiBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0LnRocm93SW5zdGFudGlhdGlvbkVycm9yCiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIGEgdmFsdWUgaW5kaWNhdGluZyB3aGV0aGVyIG9yIG5vdCB0aGUgcHJvdmlkZXIgaW5jbHVkZXMgYSB3YXRlciBtYXNrLiAgVGhlIHdhdGVyIG1hc2sKICAgICAgICAgKiBpbmRpY2F0ZXMgd2hpY2ggYXJlYXMgb2YgdGhlIGdsb2JlIGFyZSB3YXRlciByYXRoZXIgdGhhbiBsYW5kLCBzbyB0aGV5IGNhbiBiZSByZW5kZXJlZAogICAgICAgICAqIGFzIGEgcmVmbGVjdGl2ZSBzdXJmYWNlIHdpdGggYW5pbWF0ZWQgd2F2ZXMuCiAgICAgICAgICogQG1lbWJlcm9mIFRlcnJhaW5Qcm92aWRlci5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7Ym9vbGVhbn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBoYXNXYXRlck1hc2s6IHsKICAgICAgICAgIGdldDogRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdC50aHJvd0luc3RhbnRpYXRpb25FcnJvcgogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyBhIHZhbHVlIGluZGljYXRpbmcgd2hldGhlciBvciBub3QgdGhlIHJlcXVlc3RlZCB0aWxlcyBpbmNsdWRlIHZlcnRleCBub3JtYWxzLgogICAgICAgICAqIEBtZW1iZXJvZiBUZXJyYWluUHJvdmlkZXIucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge2Jvb2xlYW59CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgaGFzVmVydGV4Tm9ybWFsczogewogICAgICAgICAgZ2V0OiBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0LnRocm93SW5zdGFudGlhdGlvbkVycm9yCiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIGFuIG9iamVjdCB0aGF0IGNhbiBiZSB1c2VkIHRvIGRldGVybWluZSBhdmFpbGFiaWxpdHkgb2YgdGVycmFpbiBmcm9tIHRoaXMgcHJvdmlkZXIsIHN1Y2ggYXMKICAgICAgICAgKiBhdCBwb2ludHMgYW5kIGluIHJlY3RhbmdsZXMuIFRoaXMgcHJvcGVydHkgbWF5IGJlIHVuZGVmaW5lZCBpZiBhdmFpbGFiaWxpdHkKICAgICAgICAgKiBpbmZvcm1hdGlvbiBpcyBub3QgYXZhaWxhYmxlLgogICAgICAgICAqIEBtZW1iZXJvZiBUZXJyYWluUHJvdmlkZXIucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge1RpbGVBdmFpbGFiaWxpdHl9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgYXZhaWxhYmlsaXR5OiB7CiAgICAgICAgICBnZXQ6IERldmVsb3BlckVycm9yX2RlZmF1bHQudGhyb3dJbnN0YW50aWF0aW9uRXJyb3IKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZWd1bGFyR3JpZEluZGljZXNDYWNoZSA9IFtdOwogICAgICBUZXJyYWluUHJvdmlkZXIuZ2V0UmVndWxhckdyaWRJbmRpY2VzID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCkgewogICAgICAgIGlmICh3aWR0aCAqIGhlaWdodCA+PSBNYXRoX2RlZmF1bHQuRk9VUl9HSUdBQllURVMpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiVGhlIHRvdGFsIG51bWJlciBvZiB2ZXJ0aWNlcyAod2lkdGggKiBoZWlnaHQpIG11c3QgYmUgbGVzcyB0aGFuIDQsMjk0LDk2NywyOTYuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgbGV0IGJ5V2lkdGggPSByZWd1bGFyR3JpZEluZGljZXNDYWNoZVt3aWR0aF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYnlXaWR0aCkpIHsKICAgICAgICAgIHJlZ3VsYXJHcmlkSW5kaWNlc0NhY2hlW3dpZHRoXSA9IGJ5V2lkdGggPSBbXTsKICAgICAgICB9CiAgICAgICAgbGV0IGluZGljZXMgPSBieVdpZHRoW2hlaWdodF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaW5kaWNlcykpIHsKICAgICAgICAgIGlmICh3aWR0aCAqIGhlaWdodCA8IE1hdGhfZGVmYXVsdC5TSVhUWV9GT1VSX0tJTE9CWVRFUykgewogICAgICAgICAgICBpbmRpY2VzID0gYnlXaWR0aFtoZWlnaHRdID0gbmV3IFVpbnQxNkFycmF5KAogICAgICAgICAgICAgICh3aWR0aCAtIDEpICogKGhlaWdodCAtIDEpICogNgogICAgICAgICAgICApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaW5kaWNlcyA9IGJ5V2lkdGhbaGVpZ2h0XSA9IG5ldyBVaW50MzJBcnJheSgKICAgICAgICAgICAgICAod2lkdGggLSAxKSAqIChoZWlnaHQgLSAxKSAqIDYKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIGFkZFJlZ3VsYXJHcmlkSW5kaWNlcyh3aWR0aCwgaGVpZ2h0LCBpbmRpY2VzLCAwKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGluZGljZXM7CiAgICAgIH07CiAgICAgIHJlZ3VsYXJHcmlkQW5kRWRnZUluZGljZXNDYWNoZSA9IFtdOwogICAgICBUZXJyYWluUHJvdmlkZXIuZ2V0UmVndWxhckdyaWRJbmRpY2VzQW5kRWRnZUluZGljZXMgPSBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgaWYgKHdpZHRoICogaGVpZ2h0ID49IE1hdGhfZGVmYXVsdC5GT1VSX0dJR0FCWVRFUykgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJUaGUgdG90YWwgbnVtYmVyIG9mIHZlcnRpY2VzICh3aWR0aCAqIGhlaWdodCkgbXVzdCBiZSBsZXNzIHRoYW4gNCwyOTQsOTY3LDI5Ni4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBsZXQgYnlXaWR0aCA9IHJlZ3VsYXJHcmlkQW5kRWRnZUluZGljZXNDYWNoZVt3aWR0aF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYnlXaWR0aCkpIHsKICAgICAgICAgIHJlZ3VsYXJHcmlkQW5kRWRnZUluZGljZXNDYWNoZVt3aWR0aF0gPSBieVdpZHRoID0gW107CiAgICAgICAgfQogICAgICAgIGxldCBpbmRpY2VzQW5kRWRnZXMgPSBieVdpZHRoW2hlaWdodF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaW5kaWNlc0FuZEVkZ2VzKSkgewogICAgICAgICAgY29uc3QgaW5kaWNlcyA9IFRlcnJhaW5Qcm92aWRlci5nZXRSZWd1bGFyR3JpZEluZGljZXMod2lkdGgsIGhlaWdodCk7CiAgICAgICAgICBjb25zdCBlZGdlSW5kaWNlcyA9IGdldEVkZ2VJbmRpY2VzKHdpZHRoLCBoZWlnaHQpOwogICAgICAgICAgY29uc3Qgd2VzdEluZGljZXNTb3V0aFRvTm9ydGggPSBlZGdlSW5kaWNlcy53ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aDsKICAgICAgICAgIGNvbnN0IHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QgPSBlZGdlSW5kaWNlcy5zb3V0aEluZGljZXNFYXN0VG9XZXN0OwogICAgICAgICAgY29uc3QgZWFzdEluZGljZXNOb3J0aFRvU291dGggPSBlZGdlSW5kaWNlcy5lYXN0SW5kaWNlc05vcnRoVG9Tb3V0aDsKICAgICAgICAgIGNvbnN0IG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QgPSBlZGdlSW5kaWNlcy5ub3J0aEluZGljZXNXZXN0VG9FYXN0OwogICAgICAgICAgaW5kaWNlc0FuZEVkZ2VzID0gYnlXaWR0aFtoZWlnaHRdID0gewogICAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgICB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aCwKICAgICAgICAgICAgc291dGhJbmRpY2VzRWFzdFRvV2VzdCwKICAgICAgICAgICAgZWFzdEluZGljZXNOb3J0aFRvU291dGgsCiAgICAgICAgICAgIG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBpbmRpY2VzQW5kRWRnZXM7CiAgICAgIH07CiAgICAgIHJlZ3VsYXJHcmlkQW5kU2tpcnRBbmRFZGdlSW5kaWNlc0NhY2hlID0gW107CiAgICAgIFRlcnJhaW5Qcm92aWRlci5nZXRSZWd1bGFyR3JpZEFuZFNraXJ0SW5kaWNlc0FuZEVkZ2VJbmRpY2VzID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCkgewogICAgICAgIGlmICh3aWR0aCAqIGhlaWdodCA+PSBNYXRoX2RlZmF1bHQuRk9VUl9HSUdBQllURVMpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiVGhlIHRvdGFsIG51bWJlciBvZiB2ZXJ0aWNlcyAod2lkdGggKiBoZWlnaHQpIG11c3QgYmUgbGVzcyB0aGFuIDQsMjk0LDk2NywyOTYuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgbGV0IGJ5V2lkdGggPSByZWd1bGFyR3JpZEFuZFNraXJ0QW5kRWRnZUluZGljZXNDYWNoZVt3aWR0aF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYnlXaWR0aCkpIHsKICAgICAgICAgIHJlZ3VsYXJHcmlkQW5kU2tpcnRBbmRFZGdlSW5kaWNlc0NhY2hlW3dpZHRoXSA9IGJ5V2lkdGggPSBbXTsKICAgICAgICB9CiAgICAgICAgbGV0IGluZGljZXNBbmRFZGdlcyA9IGJ5V2lkdGhbaGVpZ2h0XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbmRpY2VzQW5kRWRnZXMpKSB7CiAgICAgICAgICBjb25zdCBncmlkVmVydGV4Q291bnQgPSB3aWR0aCAqIGhlaWdodDsKICAgICAgICAgIGNvbnN0IGdyaWRJbmRleENvdW50ID0gKHdpZHRoIC0gMSkgKiAoaGVpZ2h0IC0gMSkgKiA2OwogICAgICAgICAgY29uc3QgZWRnZVZlcnRleENvdW50ID0gd2lkdGggKiAyICsgaGVpZ2h0ICogMjsKICAgICAgICAgIGNvbnN0IGVkZ2VJbmRleENvdW50ID0gTWF0aC5tYXgoMCwgZWRnZVZlcnRleENvdW50IC0gNCkgKiA2OwogICAgICAgICAgY29uc3QgdmVydGV4Q291bnQgPSBncmlkVmVydGV4Q291bnQgKyBlZGdlVmVydGV4Q291bnQ7CiAgICAgICAgICBjb25zdCBpbmRleENvdW50ID0gZ3JpZEluZGV4Q291bnQgKyBlZGdlSW5kZXhDb3VudDsKICAgICAgICAgIGNvbnN0IGVkZ2VJbmRpY2VzID0gZ2V0RWRnZUluZGljZXMod2lkdGgsIGhlaWdodCk7CiAgICAgICAgICBjb25zdCB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aCA9IGVkZ2VJbmRpY2VzLndlc3RJbmRpY2VzU291dGhUb05vcnRoOwogICAgICAgICAgY29uc3Qgc291dGhJbmRpY2VzRWFzdFRvV2VzdCA9IGVkZ2VJbmRpY2VzLnNvdXRoSW5kaWNlc0Vhc3RUb1dlc3Q7CiAgICAgICAgICBjb25zdCBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aCA9IGVkZ2VJbmRpY2VzLmVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoOwogICAgICAgICAgY29uc3Qgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdCA9IGVkZ2VJbmRpY2VzLm5vcnRoSW5kaWNlc1dlc3RUb0Vhc3Q7CiAgICAgICAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkodmVydGV4Q291bnQsIGluZGV4Q291bnQpOwogICAgICAgICAgYWRkUmVndWxhckdyaWRJbmRpY2VzKHdpZHRoLCBoZWlnaHQsIGluZGljZXMsIDApOwogICAgICAgICAgVGVycmFpblByb3ZpZGVyLmFkZFNraXJ0SW5kaWNlcygKICAgICAgICAgICAgd2VzdEluZGljZXNTb3V0aFRvTm9ydGgsCiAgICAgICAgICAgIHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QsCiAgICAgICAgICAgIGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoLAogICAgICAgICAgICBub3J0aEluZGljZXNXZXN0VG9FYXN0LAogICAgICAgICAgICBncmlkVmVydGV4Q291bnQsCiAgICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICAgIGdyaWRJbmRleENvdW50CiAgICAgICAgICApOwogICAgICAgICAgaW5kaWNlc0FuZEVkZ2VzID0gYnlXaWR0aFtoZWlnaHRdID0gewogICAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgICB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aCwKICAgICAgICAgICAgc291dGhJbmRpY2VzRWFzdFRvV2VzdCwKICAgICAgICAgICAgZWFzdEluZGljZXNOb3J0aFRvU291dGgsCiAgICAgICAgICAgIG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QsCiAgICAgICAgICAgIGluZGV4Q291bnRXaXRob3V0U2tpcnRzOiBncmlkSW5kZXhDb3VudAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGluZGljZXNBbmRFZGdlczsKICAgICAgfTsKICAgICAgVGVycmFpblByb3ZpZGVyLmFkZFNraXJ0SW5kaWNlcyA9IGZ1bmN0aW9uKHdlc3RJbmRpY2VzU291dGhUb05vcnRoLCBzb3V0aEluZGljZXNFYXN0VG9XZXN0LCBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aCwgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdCwgdmVydGV4Q291bnQsIGluZGljZXMsIG9mZnNldCkgewogICAgICAgIGxldCB2ZXJ0ZXhJbmRleCA9IHZlcnRleENvdW50OwogICAgICAgIG9mZnNldCA9IGFkZFNraXJ0SW5kaWNlcygKICAgICAgICAgIHdlc3RJbmRpY2VzU291dGhUb05vcnRoLAogICAgICAgICAgdmVydGV4SW5kZXgsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgb2Zmc2V0CiAgICAgICAgKTsKICAgICAgICB2ZXJ0ZXhJbmRleCArPSB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aC5sZW5ndGg7CiAgICAgICAgb2Zmc2V0ID0gYWRkU2tpcnRJbmRpY2VzKAogICAgICAgICAgc291dGhJbmRpY2VzRWFzdFRvV2VzdCwKICAgICAgICAgIHZlcnRleEluZGV4LAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIG9mZnNldAogICAgICAgICk7CiAgICAgICAgdmVydGV4SW5kZXggKz0gc291dGhJbmRpY2VzRWFzdFRvV2VzdC5sZW5ndGg7CiAgICAgICAgb2Zmc2V0ID0gYWRkU2tpcnRJbmRpY2VzKAogICAgICAgICAgZWFzdEluZGljZXNOb3J0aFRvU291dGgsCiAgICAgICAgICB2ZXJ0ZXhJbmRleCwKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBvZmZzZXQKICAgICAgICApOwogICAgICAgIHZlcnRleEluZGV4ICs9IGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoLmxlbmd0aDsKICAgICAgICBhZGRTa2lydEluZGljZXMobm9ydGhJbmRpY2VzV2VzdFRvRWFzdCwgdmVydGV4SW5kZXgsIGluZGljZXMsIG9mZnNldCk7CiAgICAgIH07CiAgICAgIFRlcnJhaW5Qcm92aWRlci5oZWlnaHRtYXBUZXJyYWluUXVhbGl0eSA9IDAuMjU7CiAgICAgIFRlcnJhaW5Qcm92aWRlci5nZXRFc3RpbWF0ZWRMZXZlbFplcm9HZW9tZXRyaWNFcnJvckZvckFIZWlnaHRtYXAgPSBmdW5jdGlvbihlbGxpcHNvaWQsIHRpbGVJbWFnZVdpZHRoLCBudW1iZXJPZlRpbGVzQXRMZXZlbFplcm8pIHsKICAgICAgICByZXR1cm4gZWxsaXBzb2lkLm1heGltdW1SYWRpdXMgKiAyICogTWF0aC5QSSAqIFRlcnJhaW5Qcm92aWRlci5oZWlnaHRtYXBUZXJyYWluUXVhbGl0eSAvICh0aWxlSW1hZ2VXaWR0aCAqIG51bWJlck9mVGlsZXNBdExldmVsWmVybyk7CiAgICAgIH07CiAgICAgIFRlcnJhaW5Qcm92aWRlci5wcm90b3R5cGUucmVxdWVzdFRpbGVHZW9tZXRyeSA9IERldmVsb3BlckVycm9yX2RlZmF1bHQudGhyb3dJbnN0YW50aWF0aW9uRXJyb3I7CiAgICAgIFRlcnJhaW5Qcm92aWRlci5wcm90b3R5cGUuZ2V0TGV2ZWxNYXhpbXVtR2VvbWV0cmljRXJyb3IgPSBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0LnRocm93SW5zdGFudGlhdGlvbkVycm9yOwogICAgICBUZXJyYWluUHJvdmlkZXIucHJvdG90eXBlLmdldFRpbGVEYXRhQXZhaWxhYmxlID0gRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdC50aHJvd0luc3RhbnRpYXRpb25FcnJvcjsKICAgICAgVGVycmFpblByb3ZpZGVyLnByb3RvdHlwZS5sb2FkVGlsZURhdGFBdmFpbGFiaWxpdHkgPSBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0LnRocm93SW5zdGFudGlhdGlvbkVycm9yOwogICAgICBUZXJyYWluUHJvdmlkZXJfZGVmYXVsdCA9IFRlcnJhaW5Qcm92aWRlcjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVZlcnRpY2VzRnJvbVF1YW50aXplZFRlcnJhaW5NZXNoLmpzCiAgdmFyIGNyZWF0ZVZlcnRpY2VzRnJvbVF1YW50aXplZFRlcnJhaW5NZXNoX2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaF9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaF9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlVmVydGljZXNGcm9tUXVhbnRpemVkVGVycmFpbk1lc2gocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3QgcXVhbnRpemVkVmVydGljZXMgPSBwYXJhbWV0ZXJzLnF1YW50aXplZFZlcnRpY2VzOwogICAgY29uc3QgcXVhbnRpemVkVmVydGV4Q291bnQgPSBxdWFudGl6ZWRWZXJ0aWNlcy5sZW5ndGggLyAzOwogICAgY29uc3Qgb2N0RW5jb2RlZE5vcm1hbHMgPSBwYXJhbWV0ZXJzLm9jdEVuY29kZWROb3JtYWxzOwogICAgY29uc3QgZWRnZVZlcnRleENvdW50ID0gcGFyYW1ldGVycy53ZXN0SW5kaWNlcy5sZW5ndGggKyBwYXJhbWV0ZXJzLmVhc3RJbmRpY2VzLmxlbmd0aCArIHBhcmFtZXRlcnMuc291dGhJbmRpY2VzLmxlbmd0aCArIHBhcmFtZXRlcnMubm9ydGhJbmRpY2VzLmxlbmd0aDsKICAgIGNvbnN0IGluY2x1ZGVXZWJNZXJjYXRvclQgPSBwYXJhbWV0ZXJzLmluY2x1ZGVXZWJNZXJjYXRvclQ7CiAgICBjb25zdCBleGFnZ2VyYXRpb24gPSBwYXJhbWV0ZXJzLmV4YWdnZXJhdGlvbjsKICAgIGNvbnN0IGV4YWdnZXJhdGlvblJlbGF0aXZlSGVpZ2h0ID0gcGFyYW1ldGVycy5leGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodDsKICAgIGNvbnN0IGhhc0V4YWdnZXJhdGlvbiA9IGV4YWdnZXJhdGlvbiAhPT0gMTsKICAgIGNvbnN0IGluY2x1ZGVHZW9kZXRpY1N1cmZhY2VOb3JtYWxzID0gaGFzRXhhZ2dlcmF0aW9uOwogICAgY29uc3QgcmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUocGFyYW1ldGVycy5yZWN0YW5nbGUpOwogICAgY29uc3Qgd2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogICAgY29uc3Qgc291dGggPSByZWN0YW5nbGUuc291dGg7CiAgICBjb25zdCBlYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICBjb25zdCBub3J0aCA9IHJlY3RhbmdsZS5ub3J0aDsKICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKHBhcmFtZXRlcnMuZWxsaXBzb2lkKTsKICAgIGNvbnN0IG1pbmltdW1IZWlnaHQgPSBwYXJhbWV0ZXJzLm1pbmltdW1IZWlnaHQ7CiAgICBjb25zdCBtYXhpbXVtSGVpZ2h0ID0gcGFyYW1ldGVycy5tYXhpbXVtSGVpZ2h0OwogICAgY29uc3QgY2VudGVyID0gcGFyYW1ldGVycy5yZWxhdGl2ZVRvQ2VudGVyOwogICAgY29uc3QgZnJvbUVOVSA9IFRyYW5zZm9ybXNfZGVmYXVsdC5lYXN0Tm9ydGhVcFRvRml4ZWRGcmFtZShjZW50ZXIsIGVsbGlwc29pZCk7CiAgICBjb25zdCB0b0VOVSA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlVHJhbnNmb3JtYXRpb24oZnJvbUVOVSwgbmV3IE1hdHJpeDRfZGVmYXVsdCgpKTsKICAgIGxldCBzb3V0aE1lcmNhdG9yWTsKICAgIGxldCBvbmVPdmVyTWVyY2F0b3JIZWlnaHQ7CiAgICBpZiAoaW5jbHVkZVdlYk1lcmNhdG9yVCkgewogICAgICBzb3V0aE1lcmNhdG9yWSA9IFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0Lmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUoCiAgICAgICAgc291dGgKICAgICAgKTsKICAgICAgb25lT3Zlck1lcmNhdG9ySGVpZ2h0ID0gMSAvIChXZWJNZXJjYXRvclByb2plY3Rpb25fZGVmYXVsdC5nZW9kZXRpY0xhdGl0dWRlVG9NZXJjYXRvckFuZ2xlKG5vcnRoKSAtIHNvdXRoTWVyY2F0b3JZKTsKICAgIH0KICAgIGNvbnN0IHVCdWZmZXIgPSBxdWFudGl6ZWRWZXJ0aWNlcy5zdWJhcnJheSgwLCBxdWFudGl6ZWRWZXJ0ZXhDb3VudCk7CiAgICBjb25zdCB2QnVmZmVyID0gcXVhbnRpemVkVmVydGljZXMuc3ViYXJyYXkoCiAgICAgIHF1YW50aXplZFZlcnRleENvdW50LAogICAgICAyICogcXVhbnRpemVkVmVydGV4Q291bnQKICAgICk7CiAgICBjb25zdCBoZWlnaHRCdWZmZXIgPSBxdWFudGl6ZWRWZXJ0aWNlcy5zdWJhcnJheSgKICAgICAgcXVhbnRpemVkVmVydGV4Q291bnQgKiAyLAogICAgICAzICogcXVhbnRpemVkVmVydGV4Q291bnQKICAgICk7CiAgICBjb25zdCBoYXNWZXJ0ZXhOb3JtYWxzID0gZGVmaW5lZF9kZWZhdWx0KG9jdEVuY29kZWROb3JtYWxzKTsKICAgIGNvbnN0IHV2cyA9IG5ldyBBcnJheShxdWFudGl6ZWRWZXJ0ZXhDb3VudCk7CiAgICBjb25zdCBoZWlnaHRzID0gbmV3IEFycmF5KHF1YW50aXplZFZlcnRleENvdW50KTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheShxdWFudGl6ZWRWZXJ0ZXhDb3VudCk7CiAgICBjb25zdCB3ZWJNZXJjYXRvclRzID0gaW5jbHVkZVdlYk1lcmNhdG9yVCA/IG5ldyBBcnJheShxdWFudGl6ZWRWZXJ0ZXhDb3VudCkgOiBbXTsKICAgIGNvbnN0IGdlb2RldGljU3VyZmFjZU5vcm1hbHMgPSBpbmNsdWRlR2VvZGV0aWNTdXJmYWNlTm9ybWFscyA/IG5ldyBBcnJheShxdWFudGl6ZWRWZXJ0ZXhDb3VudCkgOiBbXTsKICAgIGNvbnN0IG1pbmltdW0gPSBzY3JhdGNoTWluaW11bTsKICAgIG1pbmltdW0ueCA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIG1pbmltdW0ueSA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIG1pbmltdW0ueiA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIGNvbnN0IG1heGltdW0gPSBzY3JhdGNoTWF4aW11bTsKICAgIG1heGltdW0ueCA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIG1heGltdW0ueSA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIG1heGltdW0ueiA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIGxldCBtaW5Mb25naXR1ZGUgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICBsZXQgbWF4TG9uZ2l0dWRlID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgbGV0IG1pbkxhdGl0dWRlID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgbGV0IG1heExhdGl0dWRlID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBxdWFudGl6ZWRWZXJ0ZXhDb3VudDsgKytpKSB7CiAgICAgIGNvbnN0IHJhd1UgPSB1QnVmZmVyW2ldOwogICAgICBjb25zdCByYXdWID0gdkJ1ZmZlcltpXTsKICAgICAgY29uc3QgdTMgPSByYXdVIC8gbWF4U2hvcnQ0OwogICAgICBjb25zdCB2MyA9IHJhd1YgLyBtYXhTaG9ydDQ7CiAgICAgIGNvbnN0IGhlaWdodCA9IE1hdGhfZGVmYXVsdC5sZXJwKAogICAgICAgIG1pbmltdW1IZWlnaHQsCiAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICBoZWlnaHRCdWZmZXJbaV0gLyBtYXhTaG9ydDQKICAgICAgKTsKICAgICAgY2FydG9ncmFwaGljU2NyYXRjaC5sb25naXR1ZGUgPSBNYXRoX2RlZmF1bHQubGVycCh3ZXN0LCBlYXN0LCB1Myk7CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gubGF0aXR1ZGUgPSBNYXRoX2RlZmF1bHQubGVycChzb3V0aCwgbm9ydGgsIHYzKTsKICAgICAgY2FydG9ncmFwaGljU2NyYXRjaC5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgIG1pbkxvbmdpdHVkZSA9IE1hdGgubWluKGNhcnRvZ3JhcGhpY1NjcmF0Y2gubG9uZ2l0dWRlLCBtaW5Mb25naXR1ZGUpOwogICAgICBtYXhMb25naXR1ZGUgPSBNYXRoLm1heChjYXJ0b2dyYXBoaWNTY3JhdGNoLmxvbmdpdHVkZSwgbWF4TG9uZ2l0dWRlKTsKICAgICAgbWluTGF0aXR1ZGUgPSBNYXRoLm1pbihjYXJ0b2dyYXBoaWNTY3JhdGNoLmxhdGl0dWRlLCBtaW5MYXRpdHVkZSk7CiAgICAgIG1heExhdGl0dWRlID0gTWF0aC5tYXgoY2FydG9ncmFwaGljU2NyYXRjaC5sYXRpdHVkZSwgbWF4TGF0aXR1ZGUpOwogICAgICBjb25zdCBwb3NpdGlvbiA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihjYXJ0b2dyYXBoaWNTY3JhdGNoKTsKICAgICAgdXZzW2ldID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCh1MywgdjMpOwogICAgICBoZWlnaHRzW2ldID0gaGVpZ2h0OwogICAgICBwb3NpdGlvbnNbaV0gPSBwb3NpdGlvbjsKICAgICAgaWYgKGluY2x1ZGVXZWJNZXJjYXRvclQpIHsKICAgICAgICB3ZWJNZXJjYXRvclRzW2ldID0gKFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0Lmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUoCiAgICAgICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLmxhdGl0dWRlCiAgICAgICAgKSAtIHNvdXRoTWVyY2F0b3JZKSAqIG9uZU92ZXJNZXJjYXRvckhlaWdodDsKICAgICAgfQogICAgICBpZiAoaW5jbHVkZUdlb2RldGljU3VyZmFjZU5vcm1hbHMpIHsKICAgICAgICBnZW9kZXRpY1N1cmZhY2VOb3JtYWxzW2ldID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbik7CiAgICAgIH0KICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludCh0b0VOVSwgcG9zaXRpb24sIGNhcnRlc2lhbjNTY3JhdGNoOCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5taW5pbXVtQnlDb21wb25lbnQoY2FydGVzaWFuM1NjcmF0Y2g4LCBtaW5pbXVtLCBtaW5pbXVtKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1heGltdW1CeUNvbXBvbmVudChjYXJ0ZXNpYW4zU2NyYXRjaDgsIG1heGltdW0sIG1heGltdW0pOwogICAgfQogICAgY29uc3Qgd2VzdEluZGljZXNTb3V0aFRvTm9ydGggPSBjb3B5QW5kU29ydChwYXJhbWV0ZXJzLndlc3RJbmRpY2VzLCBmdW5jdGlvbihhMywgYikgewogICAgICByZXR1cm4gdXZzW2EzXS55IC0gdXZzW2JdLnk7CiAgICB9KTsKICAgIGNvbnN0IGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoID0gY29weUFuZFNvcnQocGFyYW1ldGVycy5lYXN0SW5kaWNlcywgZnVuY3Rpb24oYTMsIGIpIHsKICAgICAgcmV0dXJuIHV2c1tiXS55IC0gdXZzW2EzXS55OwogICAgfSk7CiAgICBjb25zdCBzb3V0aEluZGljZXNFYXN0VG9XZXN0ID0gY29weUFuZFNvcnQocGFyYW1ldGVycy5zb3V0aEluZGljZXMsIGZ1bmN0aW9uKGEzLCBiKSB7CiAgICAgIHJldHVybiB1dnNbYl0ueCAtIHV2c1thM10ueDsKICAgIH0pOwogICAgY29uc3Qgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdCA9IGNvcHlBbmRTb3J0KHBhcmFtZXRlcnMubm9ydGhJbmRpY2VzLCBmdW5jdGlvbihhMywgYikgewogICAgICByZXR1cm4gdXZzW2EzXS54IC0gdXZzW2JdLng7CiAgICB9KTsKICAgIGxldCBvY2NsdWRlZVBvaW50SW5TY2FsZWRTcGFjZTsKICAgIGlmIChtaW5pbXVtSGVpZ2h0IDwgMCkgewogICAgICBjb25zdCBvY2NsdWRlciA9IG5ldyBFbGxpcHNvaWRhbE9jY2x1ZGVyX2RlZmF1bHQoZWxsaXBzb2lkKTsKICAgICAgb2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2UgPSBvY2NsdWRlci5jb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludFBvc3NpYmx5VW5kZXJFbGxpcHNvaWQoCiAgICAgICAgY2VudGVyLAogICAgICAgIHBvc2l0aW9ucywKICAgICAgICBtaW5pbXVtSGVpZ2h0CiAgICAgICk7CiAgICB9CiAgICBsZXQgaE1pbiA9IG1pbmltdW1IZWlnaHQ7CiAgICBoTWluID0gTWF0aC5taW4oCiAgICAgIGhNaW4sCiAgICAgIGZpbmRNaW5NYXhTa2lydHMoCiAgICAgICAgcGFyYW1ldGVycy53ZXN0SW5kaWNlcywKICAgICAgICBwYXJhbWV0ZXJzLndlc3RTa2lydEhlaWdodCwKICAgICAgICBoZWlnaHRzLAogICAgICAgIHV2cywKICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgZWxsaXBzb2lkLAogICAgICAgIHRvRU5VLAogICAgICAgIG1pbmltdW0sCiAgICAgICAgbWF4aW11bQogICAgICApCiAgICApOwogICAgaE1pbiA9IE1hdGgubWluKAogICAgICBoTWluLAogICAgICBmaW5kTWluTWF4U2tpcnRzKAogICAgICAgIHBhcmFtZXRlcnMuc291dGhJbmRpY2VzLAogICAgICAgIHBhcmFtZXRlcnMuc291dGhTa2lydEhlaWdodCwKICAgICAgICBoZWlnaHRzLAogICAgICAgIHV2cywKICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgZWxsaXBzb2lkLAogICAgICAgIHRvRU5VLAogICAgICAgIG1pbmltdW0sCiAgICAgICAgbWF4aW11bQogICAgICApCiAgICApOwogICAgaE1pbiA9IE1hdGgubWluKAogICAgICBoTWluLAogICAgICBmaW5kTWluTWF4U2tpcnRzKAogICAgICAgIHBhcmFtZXRlcnMuZWFzdEluZGljZXMsCiAgICAgICAgcGFyYW1ldGVycy5lYXN0U2tpcnRIZWlnaHQsCiAgICAgICAgaGVpZ2h0cywKICAgICAgICB1dnMsCiAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICB0b0VOVSwKICAgICAgICBtaW5pbXVtLAogICAgICAgIG1heGltdW0KICAgICAgKQogICAgKTsKICAgIGhNaW4gPSBNYXRoLm1pbigKICAgICAgaE1pbiwKICAgICAgZmluZE1pbk1heFNraXJ0cygKICAgICAgICBwYXJhbWV0ZXJzLm5vcnRoSW5kaWNlcywKICAgICAgICBwYXJhbWV0ZXJzLm5vcnRoU2tpcnRIZWlnaHQsCiAgICAgICAgaGVpZ2h0cywKICAgICAgICB1dnMsCiAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICB0b0VOVSwKICAgICAgICBtaW5pbXVtLAogICAgICAgIG1heGltdW0KICAgICAgKQogICAgKTsKICAgIGNvbnN0IGFhQm94ID0gbmV3IEF4aXNBbGlnbmVkQm91bmRpbmdCb3hfZGVmYXVsdChtaW5pbXVtLCBtYXhpbXVtLCBjZW50ZXIpOwogICAgY29uc3QgZW5jb2RpbmcgPSBuZXcgVGVycmFpbkVuY29kaW5nX2RlZmF1bHQoCiAgICAgIGNlbnRlciwKICAgICAgYWFCb3gsCiAgICAgIGhNaW4sCiAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgIGZyb21FTlUsCiAgICAgIGhhc1ZlcnRleE5vcm1hbHMsCiAgICAgIGluY2x1ZGVXZWJNZXJjYXRvclQsCiAgICAgIGluY2x1ZGVHZW9kZXRpY1N1cmZhY2VOb3JtYWxzLAogICAgICBleGFnZ2VyYXRpb24sCiAgICAgIGV4YWdnZXJhdGlvblJlbGF0aXZlSGVpZ2h0CiAgICApOwogICAgY29uc3QgdmVydGV4U3RyaWRlID0gZW5jb2Rpbmcuc3RyaWRlOwogICAgY29uc3Qgc2l6ZSA9IHF1YW50aXplZFZlcnRleENvdW50ICogdmVydGV4U3RyaWRlICsgZWRnZVZlcnRleENvdW50ICogdmVydGV4U3RyaWRlOwogICAgY29uc3QgdmVydGV4QnVmZmVyID0gbmV3IEZsb2F0MzJBcnJheShzaXplKTsKICAgIGxldCBidWZmZXJJbmRleCA9IDA7CiAgICBmb3IgKGxldCBqID0gMDsgaiA8IHF1YW50aXplZFZlcnRleENvdW50OyArK2opIHsKICAgICAgaWYgKGhhc1ZlcnRleE5vcm1hbHMpIHsKICAgICAgICBjb25zdCBuID0gaiAqIDI7CiAgICAgICAgdG9QYWNrLnggPSBvY3RFbmNvZGVkTm9ybWFsc1tuXTsKICAgICAgICB0b1BhY2sueSA9IG9jdEVuY29kZWROb3JtYWxzW24gKyAxXTsKICAgICAgfQogICAgICBidWZmZXJJbmRleCA9IGVuY29kaW5nLmVuY29kZSgKICAgICAgICB2ZXJ0ZXhCdWZmZXIsCiAgICAgICAgYnVmZmVySW5kZXgsCiAgICAgICAgcG9zaXRpb25zW2pdLAogICAgICAgIHV2c1tqXSwKICAgICAgICBoZWlnaHRzW2pdLAogICAgICAgIHRvUGFjaywKICAgICAgICB3ZWJNZXJjYXRvclRzW2pdLAogICAgICAgIGdlb2RldGljU3VyZmFjZU5vcm1hbHNbal0KICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGVkZ2VUcmlhbmdsZUNvdW50ID0gTWF0aC5tYXgoMCwgKGVkZ2VWZXJ0ZXhDb3VudCAtIDQpICogMik7CiAgICBjb25zdCBpbmRleEJ1ZmZlckxlbmd0aCA9IHBhcmFtZXRlcnMuaW5kaWNlcy5sZW5ndGggKyBlZGdlVHJpYW5nbGVDb3VudCAqIDM7CiAgICBjb25zdCBpbmRleEJ1ZmZlciA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBxdWFudGl6ZWRWZXJ0ZXhDb3VudCArIGVkZ2VWZXJ0ZXhDb3VudCwKICAgICAgaW5kZXhCdWZmZXJMZW5ndGgKICAgICk7CiAgICBpbmRleEJ1ZmZlci5zZXQocGFyYW1ldGVycy5pbmRpY2VzLCAwKTsKICAgIGNvbnN0IHBlcmNlbnRhZ2UgPSAxZS00OwogICAgY29uc3QgbG9uT2Zmc2V0ID0gKG1heExvbmdpdHVkZSAtIG1pbkxvbmdpdHVkZSkgKiBwZXJjZW50YWdlOwogICAgY29uc3QgbGF0T2Zmc2V0ID0gKG1heExhdGl0dWRlIC0gbWluTGF0aXR1ZGUpICogcGVyY2VudGFnZTsKICAgIGNvbnN0IHdlc3RMb25naXR1ZGVPZmZzZXQgPSAtbG9uT2Zmc2V0OwogICAgY29uc3Qgd2VzdExhdGl0dWRlT2Zmc2V0ID0gMDsKICAgIGNvbnN0IGVhc3RMb25naXR1ZGVPZmZzZXQgPSBsb25PZmZzZXQ7CiAgICBjb25zdCBlYXN0TGF0aXR1ZGVPZmZzZXQgPSAwOwogICAgY29uc3Qgbm9ydGhMb25naXR1ZGVPZmZzZXQgPSAwOwogICAgY29uc3Qgbm9ydGhMYXRpdHVkZU9mZnNldCA9IGxhdE9mZnNldDsKICAgIGNvbnN0IHNvdXRoTG9uZ2l0dWRlT2Zmc2V0ID0gMDsKICAgIGNvbnN0IHNvdXRoTGF0aXR1ZGVPZmZzZXQgPSAtbGF0T2Zmc2V0OwogICAgbGV0IHZlcnRleEJ1ZmZlckluZGV4ID0gcXVhbnRpemVkVmVydGV4Q291bnQgKiB2ZXJ0ZXhTdHJpZGU7CiAgICBhZGRTa2lydDIoCiAgICAgIHZlcnRleEJ1ZmZlciwKICAgICAgdmVydGV4QnVmZmVySW5kZXgsCiAgICAgIHdlc3RJbmRpY2VzU291dGhUb05vcnRoLAogICAgICBlbmNvZGluZywKICAgICAgaGVpZ2h0cywKICAgICAgdXZzLAogICAgICBvY3RFbmNvZGVkTm9ybWFscywKICAgICAgZWxsaXBzb2lkLAogICAgICByZWN0YW5nbGUsCiAgICAgIHBhcmFtZXRlcnMud2VzdFNraXJ0SGVpZ2h0LAogICAgICBzb3V0aE1lcmNhdG9yWSwKICAgICAgb25lT3Zlck1lcmNhdG9ySGVpZ2h0LAogICAgICB3ZXN0TG9uZ2l0dWRlT2Zmc2V0LAogICAgICB3ZXN0TGF0aXR1ZGVPZmZzZXQKICAgICk7CiAgICB2ZXJ0ZXhCdWZmZXJJbmRleCArPSBwYXJhbWV0ZXJzLndlc3RJbmRpY2VzLmxlbmd0aCAqIHZlcnRleFN0cmlkZTsKICAgIGFkZFNraXJ0MigKICAgICAgdmVydGV4QnVmZmVyLAogICAgICB2ZXJ0ZXhCdWZmZXJJbmRleCwKICAgICAgc291dGhJbmRpY2VzRWFzdFRvV2VzdCwKICAgICAgZW5jb2RpbmcsCiAgICAgIGhlaWdodHMsCiAgICAgIHV2cywKICAgICAgb2N0RW5jb2RlZE5vcm1hbHMsCiAgICAgIGVsbGlwc29pZCwKICAgICAgcmVjdGFuZ2xlLAogICAgICBwYXJhbWV0ZXJzLnNvdXRoU2tpcnRIZWlnaHQsCiAgICAgIHNvdXRoTWVyY2F0b3JZLAogICAgICBvbmVPdmVyTWVyY2F0b3JIZWlnaHQsCiAgICAgIHNvdXRoTG9uZ2l0dWRlT2Zmc2V0LAogICAgICBzb3V0aExhdGl0dWRlT2Zmc2V0CiAgICApOwogICAgdmVydGV4QnVmZmVySW5kZXggKz0gcGFyYW1ldGVycy5zb3V0aEluZGljZXMubGVuZ3RoICogdmVydGV4U3RyaWRlOwogICAgYWRkU2tpcnQyKAogICAgICB2ZXJ0ZXhCdWZmZXIsCiAgICAgIHZlcnRleEJ1ZmZlckluZGV4LAogICAgICBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aCwKICAgICAgZW5jb2RpbmcsCiAgICAgIGhlaWdodHMsCiAgICAgIHV2cywKICAgICAgb2N0RW5jb2RlZE5vcm1hbHMsCiAgICAgIGVsbGlwc29pZCwKICAgICAgcmVjdGFuZ2xlLAogICAgICBwYXJhbWV0ZXJzLmVhc3RTa2lydEhlaWdodCwKICAgICAgc291dGhNZXJjYXRvclksCiAgICAgIG9uZU92ZXJNZXJjYXRvckhlaWdodCwKICAgICAgZWFzdExvbmdpdHVkZU9mZnNldCwKICAgICAgZWFzdExhdGl0dWRlT2Zmc2V0CiAgICApOwogICAgdmVydGV4QnVmZmVySW5kZXggKz0gcGFyYW1ldGVycy5lYXN0SW5kaWNlcy5sZW5ndGggKiB2ZXJ0ZXhTdHJpZGU7CiAgICBhZGRTa2lydDIoCiAgICAgIHZlcnRleEJ1ZmZlciwKICAgICAgdmVydGV4QnVmZmVySW5kZXgsCiAgICAgIG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QsCiAgICAgIGVuY29kaW5nLAogICAgICBoZWlnaHRzLAogICAgICB1dnMsCiAgICAgIG9jdEVuY29kZWROb3JtYWxzLAogICAgICBlbGxpcHNvaWQsCiAgICAgIHJlY3RhbmdsZSwKICAgICAgcGFyYW1ldGVycy5ub3J0aFNraXJ0SGVpZ2h0LAogICAgICBzb3V0aE1lcmNhdG9yWSwKICAgICAgb25lT3Zlck1lcmNhdG9ySGVpZ2h0LAogICAgICBub3J0aExvbmdpdHVkZU9mZnNldCwKICAgICAgbm9ydGhMYXRpdHVkZU9mZnNldAogICAgKTsKICAgIFRlcnJhaW5Qcm92aWRlcl9kZWZhdWx0LmFkZFNraXJ0SW5kaWNlcygKICAgICAgd2VzdEluZGljZXNTb3V0aFRvTm9ydGgsCiAgICAgIHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QsCiAgICAgIGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoLAogICAgICBub3J0aEluZGljZXNXZXN0VG9FYXN0LAogICAgICBxdWFudGl6ZWRWZXJ0ZXhDb3VudCwKICAgICAgaW5kZXhCdWZmZXIsCiAgICAgIHBhcmFtZXRlcnMuaW5kaWNlcy5sZW5ndGgKICAgICk7CiAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2godmVydGV4QnVmZmVyLmJ1ZmZlciwgaW5kZXhCdWZmZXIuYnVmZmVyKTsKICAgIHJldHVybiB7CiAgICAgIHZlcnRpY2VzOiB2ZXJ0ZXhCdWZmZXIuYnVmZmVyLAogICAgICBpbmRpY2VzOiBpbmRleEJ1ZmZlci5idWZmZXIsCiAgICAgIHdlc3RJbmRpY2VzU291dGhUb05vcnRoLAogICAgICBzb3V0aEluZGljZXNFYXN0VG9XZXN0LAogICAgICBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aCwKICAgICAgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdCwKICAgICAgdmVydGV4U3RyaWRlLAogICAgICBjZW50ZXIsCiAgICAgIG1pbmltdW1IZWlnaHQsCiAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgIG9jY2x1ZGVlUG9pbnRJblNjYWxlZFNwYWNlLAogICAgICBlbmNvZGluZywKICAgICAgaW5kZXhDb3VudFdpdGhvdXRTa2lydHM6IHBhcmFtZXRlcnMuaW5kaWNlcy5sZW5ndGgKICAgIH07CiAgfQogIGZ1bmN0aW9uIGZpbmRNaW5NYXhTa2lydHMoZWRnZUluZGljZXMsIGVkZ2VIZWlnaHQsIGhlaWdodHMsIHV2cywgcmVjdGFuZ2xlLCBlbGxpcHNvaWQsIHRvRU5VLCBtaW5pbXVtLCBtYXhpbXVtKSB7CiAgICBsZXQgaE1pbiA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIGNvbnN0IG5vcnRoID0gcmVjdGFuZ2xlLm5vcnRoOwogICAgY29uc3Qgc291dGggPSByZWN0YW5nbGUuc291dGg7CiAgICBsZXQgZWFzdCA9IHJlY3RhbmdsZS5lYXN0OwogICAgY29uc3Qgd2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogICAgaWYgKGVhc3QgPCB3ZXN0KSB7CiAgICAgIGVhc3QgKz0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgIH0KICAgIGNvbnN0IGxlbmd0aCA9IGVkZ2VJbmRpY2VzLmxlbmd0aDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgY29uc3QgaW5kZXggPSBlZGdlSW5kaWNlc1tpXTsKICAgICAgY29uc3QgaCA9IGhlaWdodHNbaW5kZXhdOwogICAgICBjb25zdCB1diA9IHV2c1tpbmRleF07CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gubG9uZ2l0dWRlID0gTWF0aF9kZWZhdWx0LmxlcnAod2VzdCwgZWFzdCwgdXYueCk7CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gubGF0aXR1ZGUgPSBNYXRoX2RlZmF1bHQubGVycChzb3V0aCwgbm9ydGgsIHV2LnkpOwogICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLmhlaWdodCA9IGggLSBlZGdlSGVpZ2h0OwogICAgICBjb25zdCBwb3NpdGlvbiA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLAogICAgICAgIGNhcnRlc2lhbjNTY3JhdGNoOAogICAgICApOwogICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50KHRvRU5VLCBwb3NpdGlvbiwgcG9zaXRpb24pOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubWluaW11bUJ5Q29tcG9uZW50KHBvc2l0aW9uLCBtaW5pbXVtLCBtaW5pbXVtKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1heGltdW1CeUNvbXBvbmVudChwb3NpdGlvbiwgbWF4aW11bSwgbWF4aW11bSk7CiAgICAgIGhNaW4gPSBNYXRoLm1pbihoTWluLCBjYXJ0b2dyYXBoaWNTY3JhdGNoLmhlaWdodCk7CiAgICB9CiAgICByZXR1cm4gaE1pbjsKICB9CiAgZnVuY3Rpb24gYWRkU2tpcnQyKHZlcnRleEJ1ZmZlciwgdmVydGV4QnVmZmVySW5kZXgsIGVkZ2VWZXJ0aWNlcywgZW5jb2RpbmcsIGhlaWdodHMsIHV2cywgb2N0RW5jb2RlZE5vcm1hbHMsIGVsbGlwc29pZCwgcmVjdGFuZ2xlLCBza2lydExlbmd0aCwgc291dGhNZXJjYXRvclksIG9uZU92ZXJNZXJjYXRvckhlaWdodCwgbG9uZ2l0dWRlT2Zmc2V0LCBsYXRpdHVkZU9mZnNldCkgewogICAgY29uc3QgaGFzVmVydGV4Tm9ybWFscyA9IGRlZmluZWRfZGVmYXVsdChvY3RFbmNvZGVkTm9ybWFscyk7CiAgICBjb25zdCBub3J0aCA9IHJlY3RhbmdsZS5ub3J0aDsKICAgIGNvbnN0IHNvdXRoID0gcmVjdGFuZ2xlLnNvdXRoOwogICAgbGV0IGVhc3QgPSByZWN0YW5nbGUuZWFzdDsKICAgIGNvbnN0IHdlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgIGlmIChlYXN0IDwgd2VzdCkgewogICAgICBlYXN0ICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICB9CiAgICBjb25zdCBsZW5ndGggPSBlZGdlVmVydGljZXMubGVuZ3RoOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBjb25zdCBpbmRleCA9IGVkZ2VWZXJ0aWNlc1tpXTsKICAgICAgY29uc3QgaCA9IGhlaWdodHNbaW5kZXhdOwogICAgICBjb25zdCB1diA9IHV2c1tpbmRleF07CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gubG9uZ2l0dWRlID0gTWF0aF9kZWZhdWx0LmxlcnAod2VzdCwgZWFzdCwgdXYueCkgKyBsb25naXR1ZGVPZmZzZXQ7CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gubGF0aXR1ZGUgPSBNYXRoX2RlZmF1bHQubGVycChzb3V0aCwgbm9ydGgsIHV2LnkpICsgbGF0aXR1ZGVPZmZzZXQ7CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2guaGVpZ2h0ID0gaCAtIHNraXJ0TGVuZ3RoOwogICAgICBjb25zdCBwb3NpdGlvbiA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLAogICAgICAgIGNhcnRlc2lhbjNTY3JhdGNoOAogICAgICApOwogICAgICBpZiAoaGFzVmVydGV4Tm9ybWFscykgewogICAgICAgIGNvbnN0IG4gPSBpbmRleCAqIDI7CiAgICAgICAgdG9QYWNrLnggPSBvY3RFbmNvZGVkTm9ybWFsc1tuXTsKICAgICAgICB0b1BhY2sueSA9IG9jdEVuY29kZWROb3JtYWxzW24gKyAxXTsKICAgICAgfQogICAgICBsZXQgd2ViTWVyY2F0b3JUOwogICAgICBpZiAoZW5jb2RpbmcuaGFzV2ViTWVyY2F0b3JUKSB7CiAgICAgICAgd2ViTWVyY2F0b3JUID0gKFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0Lmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUoCiAgICAgICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLmxhdGl0dWRlCiAgICAgICAgKSAtIHNvdXRoTWVyY2F0b3JZKSAqIG9uZU92ZXJNZXJjYXRvckhlaWdodDsKICAgICAgfQogICAgICBsZXQgZ2VvZGV0aWNTdXJmYWNlTm9ybWFsOwogICAgICBpZiAoZW5jb2RpbmcuaGFzR2VvZGV0aWNTdXJmYWNlTm9ybWFscykgewogICAgICAgIGdlb2RldGljU3VyZmFjZU5vcm1hbCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24pOwogICAgICB9CiAgICAgIHZlcnRleEJ1ZmZlckluZGV4ID0gZW5jb2RpbmcuZW5jb2RlKAogICAgICAgIHZlcnRleEJ1ZmZlciwKICAgICAgICB2ZXJ0ZXhCdWZmZXJJbmRleCwKICAgICAgICBwb3NpdGlvbiwKICAgICAgICB1diwKICAgICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLmhlaWdodCwKICAgICAgICB0b1BhY2ssCiAgICAgICAgd2ViTWVyY2F0b3JULAogICAgICAgIGdlb2RldGljU3VyZmFjZU5vcm1hbAogICAgICApOwogICAgfQogIH0KICBmdW5jdGlvbiBjb3B5QW5kU29ydCh0eXBlZEFycmF5LCBjb21wYXJhdG9yKSB7CiAgICBsZXQgY29weTsKICAgIGlmICh0eXBlb2YgdHlwZWRBcnJheS5zbGljZSA9PT0gImZ1bmN0aW9uIikgewogICAgICBjb3B5ID0gdHlwZWRBcnJheS5zbGljZSgpOwogICAgICBpZiAodHlwZW9mIGNvcHkuc29ydCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgIGNvcHkgPSB2b2lkIDA7CiAgICAgIH0KICAgIH0KICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNvcHkpKSB7CiAgICAgIGNvcHkgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCh0eXBlZEFycmF5KTsKICAgIH0KICAgIGNvcHkuc29ydChjb21wYXJhdG9yKTsKICAgIHJldHVybiBjb3B5OwogIH0KICB2YXIgbWF4U2hvcnQ0LCBjYXJ0ZXNpYW4zU2NyYXRjaDgsIHNjcmF0Y2hNaW5pbXVtLCBzY3JhdGNoTWF4aW11bSwgY2FydG9ncmFwaGljU2NyYXRjaCwgdG9QYWNrLCBjcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaF9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVZlcnRpY2VzRnJvbVF1YW50aXplZFRlcnJhaW5NZXNoID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaC5qcyIoKSB7CiAgICAgIGluaXRfQXhpc0FsaWduZWRCb3VuZGluZ0JveCgpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0VsbGlwc29pZGFsT2NjbHVkZXIoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9UZXJyYWluRW5jb2RpbmcoKTsKICAgICAgaW5pdF9UZXJyYWluUHJvdmlkZXIoKTsKICAgICAgaW5pdF9UcmFuc2Zvcm1zKCk7CiAgICAgIGluaXRfV2ViTWVyY2F0b3JQcm9qZWN0aW9uKCk7CiAgICAgIGluaXRfY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcigpOwogICAgICBtYXhTaG9ydDQgPSAzMjc2NzsKICAgICAgY2FydGVzaWFuM1NjcmF0Y2g4ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTWluaW11bSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE1heGltdW0gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgdG9QYWNrID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBjcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaF9kZWZhdWx0ID0gY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0KAogICAgICAgIGNyZWF0ZVZlcnRpY2VzRnJvbVF1YW50aXplZFRlcnJhaW5NZXNoCiAgICAgICk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9XYWxsR2VvbWV0cnlMaWJyYXJ5LmpzCiAgZnVuY3Rpb24gbGF0TG9uRXF1YWxzKGMwLCBjMSkgewogICAgcmV0dXJuIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGMwLmxhdGl0dWRlLCBjMS5sYXRpdHVkZSwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMCkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oYzAubG9uZ2l0dWRlLCBjMS5sb25naXR1ZGUsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTApOwogIH0KICBmdW5jdGlvbiByZW1vdmVEdXBsaWNhdGVzMihlbGxpcHNvaWQsIHBvc2l0aW9ucywgdG9wSGVpZ2h0cywgYm90dG9tSGVpZ2h0cykgewogICAgcG9zaXRpb25zID0gYXJyYXlSZW1vdmVEdXBsaWNhdGVzX2RlZmF1bHQocG9zaXRpb25zLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbik7CiAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgaWYgKGxlbmd0aCA8IDIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgaGFzQm90dG9tSGVpZ2h0cyA9IGRlZmluZWRfZGVmYXVsdChib3R0b21IZWlnaHRzKTsKICAgIGNvbnN0IGhhc1RvcEhlaWdodHMgPSBkZWZpbmVkX2RlZmF1bHQodG9wSGVpZ2h0cyk7CiAgICBjb25zdCBjbGVhbmVkUG9zaXRpb25zID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICBjb25zdCBjbGVhbmVkVG9wSGVpZ2h0cyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgY29uc3QgY2xlYW5lZEJvdHRvbUhlaWdodHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgIGNvbnN0IHYwMiA9IHBvc2l0aW9uc1swXTsKICAgIGNsZWFuZWRQb3NpdGlvbnNbMF0gPSB2MDI7CiAgICBjb25zdCBjMCA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyh2MDIsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMxMyk7CiAgICBpZiAoaGFzVG9wSGVpZ2h0cykgewogICAgICBjMC5oZWlnaHQgPSB0b3BIZWlnaHRzWzBdOwogICAgfQogICAgY2xlYW5lZFRvcEhlaWdodHNbMF0gPSBjMC5oZWlnaHQ7CiAgICBpZiAoaGFzQm90dG9tSGVpZ2h0cykgewogICAgICBjbGVhbmVkQm90dG9tSGVpZ2h0c1swXSA9IGJvdHRvbUhlaWdodHNbMF07CiAgICB9IGVsc2UgewogICAgICBjbGVhbmVkQm90dG9tSGVpZ2h0c1swXSA9IDA7CiAgICB9CiAgICBjb25zdCBzdGFydFRvcEhlaWdodCA9IGNsZWFuZWRUb3BIZWlnaHRzWzBdOwogICAgY29uc3Qgc3RhcnRCb3R0b21IZWlnaHQgPSBjbGVhbmVkQm90dG9tSGVpZ2h0c1swXTsKICAgIGxldCBoYXNBbGxTYW1lSGVpZ2h0cyA9IHN0YXJ0VG9wSGVpZ2h0ID09PSBzdGFydEJvdHRvbUhlaWdodDsKICAgIGxldCBpbmRleCA9IDE7CiAgICBmb3IgKGxldCBpID0gMTsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGNvbnN0IHYxMiA9IHBvc2l0aW9uc1tpXTsKICAgICAgY29uc3QgYzEgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWModjEyLCBzY3JhdGNoQ2FydG9ncmFwaGljMjMpOwogICAgICBpZiAoaGFzVG9wSGVpZ2h0cykgewogICAgICAgIGMxLmhlaWdodCA9IHRvcEhlaWdodHNbaV07CiAgICAgIH0KICAgICAgaGFzQWxsU2FtZUhlaWdodHMgPSBoYXNBbGxTYW1lSGVpZ2h0cyAmJiBjMS5oZWlnaHQgPT09IDA7CiAgICAgIGlmICghbGF0TG9uRXF1YWxzKGMwLCBjMSkpIHsKICAgICAgICBjbGVhbmVkUG9zaXRpb25zW2luZGV4XSA9IHYxMjsKICAgICAgICBjbGVhbmVkVG9wSGVpZ2h0c1tpbmRleF0gPSBjMS5oZWlnaHQ7CiAgICAgICAgaWYgKGhhc0JvdHRvbUhlaWdodHMpIHsKICAgICAgICAgIGNsZWFuZWRCb3R0b21IZWlnaHRzW2luZGV4XSA9IGJvdHRvbUhlaWdodHNbaV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNsZWFuZWRCb3R0b21IZWlnaHRzW2luZGV4XSA9IDA7CiAgICAgICAgfQogICAgICAgIGhhc0FsbFNhbWVIZWlnaHRzID0gaGFzQWxsU2FtZUhlaWdodHMgJiYgY2xlYW5lZFRvcEhlaWdodHNbaW5kZXhdID09PSBjbGVhbmVkQm90dG9tSGVpZ2h0c1tpbmRleF07CiAgICAgICAgQ2FydG9ncmFwaGljX2RlZmF1bHQuY2xvbmUoYzEsIGMwKTsKICAgICAgICArK2luZGV4OwogICAgICB9IGVsc2UgaWYgKGMwLmhlaWdodCA8IGMxLmhlaWdodCkgewogICAgICAgIGNsZWFuZWRUb3BIZWlnaHRzW2luZGV4IC0gMV0gPSBjMS5oZWlnaHQ7CiAgICAgIH0KICAgIH0KICAgIGlmIChoYXNBbGxTYW1lSGVpZ2h0cyB8fCBpbmRleCA8IDIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY2xlYW5lZFBvc2l0aW9ucy5sZW5ndGggPSBpbmRleDsKICAgIGNsZWFuZWRUb3BIZWlnaHRzLmxlbmd0aCA9IGluZGV4OwogICAgY2xlYW5lZEJvdHRvbUhlaWdodHMubGVuZ3RoID0gaW5kZXg7CiAgICByZXR1cm4gewogICAgICBwb3NpdGlvbnM6IGNsZWFuZWRQb3NpdGlvbnMsCiAgICAgIHRvcEhlaWdodHM6IGNsZWFuZWRUb3BIZWlnaHRzLAogICAgICBib3R0b21IZWlnaHRzOiBjbGVhbmVkQm90dG9tSGVpZ2h0cwogICAgfTsKICB9CiAgdmFyIFdhbGxHZW9tZXRyeUxpYnJhcnksIHNjcmF0Y2hDYXJ0b2dyYXBoaWMxMywgc2NyYXRjaENhcnRvZ3JhcGhpYzIzLCBwb3NpdGlvbnNBcnJheVNjcmF0Y2gsIGhlaWdodHNBcnJheVNjcmF0Y2gsIGdlbmVyYXRlQXJjT3B0aW9uc1NjcmF0Y2gyLCBXYWxsR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfV2FsbEdlb21ldHJ5TGlicmFyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvV2FsbEdlb21ldHJ5TGlicmFyeS5qcyIoKSB7CiAgICAgIGluaXRfYXJyYXlSZW1vdmVEdXBsaWNhdGVzKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUG9seWxpbmVQaXBlbGluZSgpOwogICAgICBXYWxsR2VvbWV0cnlMaWJyYXJ5ID0ge307CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWMxMyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljMjMgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgcG9zaXRpb25zQXJyYXlTY3JhdGNoID0gbmV3IEFycmF5KDIpOwogICAgICBoZWlnaHRzQXJyYXlTY3JhdGNoID0gbmV3IEFycmF5KDIpOwogICAgICBnZW5lcmF0ZUFyY09wdGlvbnNTY3JhdGNoMiA9IHsKICAgICAgICBwb3NpdGlvbnM6IHZvaWQgMCwKICAgICAgICBoZWlnaHQ6IHZvaWQgMCwKICAgICAgICBncmFudWxhcml0eTogdm9pZCAwLAogICAgICAgIGVsbGlwc29pZDogdm9pZCAwCiAgICAgIH07CiAgICAgIFdhbGxHZW9tZXRyeUxpYnJhcnkuY29tcHV0ZVBvc2l0aW9ucyA9IGZ1bmN0aW9uKGVsbGlwc29pZCwgd2FsbFBvc2l0aW9ucywgbWF4aW11bUhlaWdodHMsIG1pbmltdW1IZWlnaHRzLCBncmFudWxhcml0eSwgZHVwbGljYXRlQ29ybmVycykgewogICAgICAgIGNvbnN0IG8gPSByZW1vdmVEdXBsaWNhdGVzMigKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHdhbGxQb3NpdGlvbnMsCiAgICAgICAgICBtYXhpbXVtSGVpZ2h0cywKICAgICAgICAgIG1pbmltdW1IZWlnaHRzCiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB3YWxsUG9zaXRpb25zID0gby5wb3NpdGlvbnM7CiAgICAgICAgbWF4aW11bUhlaWdodHMgPSBvLnRvcEhlaWdodHM7CiAgICAgICAgbWluaW11bUhlaWdodHMgPSBvLmJvdHRvbUhlaWdodHM7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gd2FsbFBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgY29uc3QgbnVtQ29ybmVycyA9IGxlbmd0aCAtIDI7CiAgICAgICAgbGV0IHRvcFBvc2l0aW9uczsKICAgICAgICBsZXQgYm90dG9tUG9zaXRpb25zOwogICAgICAgIGNvbnN0IG1pbkRpc3RhbmNlID0gTWF0aF9kZWZhdWx0LmNob3JkTGVuZ3RoKAogICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICBlbGxpcHNvaWQubWF4aW11bVJhZGl1cwogICAgICAgICk7CiAgICAgICAgY29uc3QgZ2VuZXJhdGVBcmNPcHRpb25zID0gZ2VuZXJhdGVBcmNPcHRpb25zU2NyYXRjaDI7CiAgICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zLm1pbkRpc3RhbmNlID0gbWluRGlzdGFuY2U7CiAgICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zLmVsbGlwc29pZCA9IGVsbGlwc29pZDsKICAgICAgICBpZiAoZHVwbGljYXRlQ29ybmVycykgewogICAgICAgICAgbGV0IGNvdW50ID0gMDsKICAgICAgICAgIGxldCBpOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgICBjb3VudCArPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQubnVtYmVyT2ZQb2ludHMoCiAgICAgICAgICAgICAgd2FsbFBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgICB3YWxsUG9zaXRpb25zW2kgKyAxXSwKICAgICAgICAgICAgICBtaW5EaXN0YW5jZQogICAgICAgICAgICApICsgMTsKICAgICAgICAgIH0KICAgICAgICAgIHRvcFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoY291bnQgKiAzKTsKICAgICAgICAgIGJvdHRvbVBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoY291bnQgKiAzKTsKICAgICAgICAgIGNvbnN0IGdlbmVyYXRlQXJjUG9zaXRpb25zID0gcG9zaXRpb25zQXJyYXlTY3JhdGNoOwogICAgICAgICAgY29uc3QgZ2VuZXJhdGVBcmNIZWlnaHRzID0gaGVpZ2h0c0FycmF5U2NyYXRjaDsKICAgICAgICAgIGdlbmVyYXRlQXJjT3B0aW9ucy5wb3NpdGlvbnMgPSBnZW5lcmF0ZUFyY1Bvc2l0aW9uczsKICAgICAgICAgIGdlbmVyYXRlQXJjT3B0aW9ucy5oZWlnaHQgPSBnZW5lcmF0ZUFyY0hlaWdodHM7CiAgICAgICAgICBsZXQgb2Zmc2V0ID0gMDsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgICAgZ2VuZXJhdGVBcmNQb3NpdGlvbnNbMF0gPSB3YWxsUG9zaXRpb25zW2ldOwogICAgICAgICAgICBnZW5lcmF0ZUFyY1Bvc2l0aW9uc1sxXSA9IHdhbGxQb3NpdGlvbnNbaSArIDFdOwogICAgICAgICAgICBnZW5lcmF0ZUFyY0hlaWdodHNbMF0gPSBtYXhpbXVtSGVpZ2h0c1tpXTsKICAgICAgICAgICAgZ2VuZXJhdGVBcmNIZWlnaHRzWzFdID0gbWF4aW11bUhlaWdodHNbaSArIDFdOwogICAgICAgICAgICBjb25zdCBwb3MgPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQuZ2VuZXJhdGVBcmMoZ2VuZXJhdGVBcmNPcHRpb25zKTsKICAgICAgICAgICAgdG9wUG9zaXRpb25zLnNldChwb3MsIG9mZnNldCk7CiAgICAgICAgICAgIGdlbmVyYXRlQXJjSGVpZ2h0c1swXSA9IG1pbmltdW1IZWlnaHRzW2ldOwogICAgICAgICAgICBnZW5lcmF0ZUFyY0hlaWdodHNbMV0gPSBtaW5pbXVtSGVpZ2h0c1tpICsgMV07CiAgICAgICAgICAgIGJvdHRvbVBvc2l0aW9ucy5zZXQoCiAgICAgICAgICAgICAgUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmdlbmVyYXRlQXJjKGdlbmVyYXRlQXJjT3B0aW9ucyksCiAgICAgICAgICAgICAgb2Zmc2V0CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIG9mZnNldCArPSBwb3MubGVuZ3RoOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBnZW5lcmF0ZUFyY09wdGlvbnMucG9zaXRpb25zID0gd2FsbFBvc2l0aW9uczsKICAgICAgICAgIGdlbmVyYXRlQXJjT3B0aW9ucy5oZWlnaHQgPSBtYXhpbXVtSGVpZ2h0czsKICAgICAgICAgIHRvcFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoCiAgICAgICAgICAgIFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5nZW5lcmF0ZUFyYyhnZW5lcmF0ZUFyY09wdGlvbnMpCiAgICAgICAgICApOwogICAgICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zLmhlaWdodCA9IG1pbmltdW1IZWlnaHRzOwogICAgICAgICAgYm90dG9tUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheSgKICAgICAgICAgICAgUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmdlbmVyYXRlQXJjKGdlbmVyYXRlQXJjT3B0aW9ucykKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICBib3R0b21Qb3NpdGlvbnMsCiAgICAgICAgICB0b3BQb3NpdGlvbnMsCiAgICAgICAgICBudW1Db3JuZXJzCiAgICAgICAgfTsKICAgICAgfTsKICAgICAgV2FsbEdlb21ldHJ5TGlicmFyeV9kZWZhdWx0ID0gV2FsbEdlb21ldHJ5TGlicmFyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1dhbGxHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIFdhbGxHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHdhbGxQb3NpdGlvbnMgPSBvcHRpb25zLnBvc2l0aW9uczsKICAgIGNvbnN0IG1heGltdW1IZWlnaHRzID0gb3B0aW9ucy5tYXhpbXVtSGVpZ2h0czsKICAgIGNvbnN0IG1pbmltdW1IZWlnaHRzID0gb3B0aW9ucy5taW5pbXVtSGVpZ2h0czsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHdhbGxQb3NpdGlvbnMpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnBvc2l0aW9ucyBpcyByZXF1aXJlZC4iKTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWF4aW11bUhlaWdodHMpICYmIG1heGltdW1IZWlnaHRzLmxlbmd0aCAhPT0gd2FsbFBvc2l0aW9ucy5sZW5ndGgpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIm9wdGlvbnMucG9zaXRpb25zIGFuZCBvcHRpb25zLm1heGltdW1IZWlnaHRzIG11c3QgaGF2ZSB0aGUgc2FtZSBsZW5ndGguIgogICAgICApOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChtaW5pbXVtSGVpZ2h0cykgJiYgbWluaW11bUhlaWdodHMubGVuZ3RoICE9PSB3YWxsUG9zaXRpb25zLmxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAib3B0aW9ucy5wb3NpdGlvbnMgYW5kIG9wdGlvbnMubWluaW11bUhlaWdodHMgbXVzdCBoYXZlIHRoZSBzYW1lIGxlbmd0aC4iCiAgICAgICk7CiAgICB9CiAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnZlcnRleEZvcm1hdCwgVmVydGV4Rm9ybWF0X2RlZmF1bHQuREVGQVVMVCk7CiAgICBjb25zdCBncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFCiAgICApOwogICAgY29uc3QgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgIHRoaXMuX3Bvc2l0aW9ucyA9IHdhbGxQb3NpdGlvbnM7CiAgICB0aGlzLl9taW5pbXVtSGVpZ2h0cyA9IG1pbmltdW1IZWlnaHRzOwogICAgdGhpcy5fbWF4aW11bUhlaWdodHMgPSBtYXhpbXVtSGVpZ2h0czsKICAgIHRoaXMuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCk7CiAgICB0aGlzLl9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgdGhpcy5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkKTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlV2FsbEdlb21ldHJ5IjsKICAgIGxldCBudW1Db21wb25lbnRzID0gMSArIHdhbGxQb3NpdGlvbnMubGVuZ3RoICogQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCArIDI7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1IZWlnaHRzKSkgewogICAgICBudW1Db21wb25lbnRzICs9IG1pbmltdW1IZWlnaHRzLmxlbmd0aDsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWF4aW11bUhlaWdodHMpKSB7CiAgICAgIG51bUNvbXBvbmVudHMgKz0gbWF4aW11bUhlaWdodHMubGVuZ3RoOwogICAgfQogICAgdGhpcy5wYWNrZWRMZW5ndGggPSBudW1Db21wb25lbnRzICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMTsKICB9CiAgdmFyIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24xLCBzY3JhdGNoQ2FydGVzaWFuM1Bvc2l0aW9uMiwgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjQsIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb241LCBzY3JhdGNoQml0YW5nZW50NSwgc2NyYXRjaFRhbmdlbnQ1LCBzY3JhdGNoTm9ybWFsOCwgc2NyYXRjaEVsbGlwc29pZDE3LCBzY3JhdGNoVmVydGV4Rm9ybWF0MTMsIHNjcmF0Y2hPcHRpb25zMjMsIFdhbGxHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1dhbGxHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvV2FsbEdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgaW5pdF9XYWxsR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24xID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuM1Bvc2l0aW9uMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb241ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQml0YW5nZW50NSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFRhbmdlbnQ1ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTm9ybWFsOCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgV2FsbEdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2YWx1ZSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gdmFsdWUuX3Bvc2l0aW9uczsKICAgICAgICBsZXQgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhwb3NpdGlvbnNbaV0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbWluaW11bUhlaWdodHMgPSB2YWx1ZS5fbWluaW11bUhlaWdodHM7CiAgICAgICAgbGVuZ3RoID0gZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1IZWlnaHRzKSA/IG1pbmltdW1IZWlnaHRzLmxlbmd0aCA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGxlbmd0aDsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1IZWlnaHRzKSkgewogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBtaW5pbXVtSGVpZ2h0c1tpXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgbWF4aW11bUhlaWdodHMgPSB2YWx1ZS5fbWF4aW11bUhlaWdodHM7CiAgICAgICAgbGVuZ3RoID0gZGVmaW5lZF9kZWZhdWx0KG1heGltdW1IZWlnaHRzKSA/IG1heGltdW1IZWlnaHRzLmxlbmd0aCA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGxlbmd0aDsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1heGltdW1IZWlnaHRzKSkgewogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBtYXhpbXVtSGVpZ2h0c1tpXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgRWxsaXBzb2lkX2RlZmF1bHQucGFjayh2YWx1ZS5fZWxsaXBzb2lkLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFjayh2YWx1ZS5fdmVydGV4Rm9ybWF0LCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoRWxsaXBzb2lkMTcgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShFbGxpcHNvaWRfZGVmYXVsdC5VTklUX1NQSEVSRSk7CiAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQxMyA9IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoT3B0aW9uczIzID0gewogICAgICAgIHBvc2l0aW9uczogdm9pZCAwLAogICAgICAgIG1pbmltdW1IZWlnaHRzOiB2b2lkIDAsCiAgICAgICAgbWF4aW11bUhlaWdodHM6IHZvaWQgMCwKICAgICAgICBlbGxpcHNvaWQ6IHNjcmF0Y2hFbGxpcHNvaWQxNywKICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IHNjcmF0Y2hWZXJ0ZXhGb3JtYXQxMywKICAgICAgICBncmFudWxhcml0eTogdm9pZCAwCiAgICAgIH07CiAgICAgIFdhbGxHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGxldCBpOwogICAgICAgIGxldCBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBwb3NpdGlvbnNbaV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgbGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBsZXQgbWluaW11bUhlaWdodHM7CiAgICAgICAgaWYgKGxlbmd0aCA+IDApIHsKICAgICAgICAgIG1pbmltdW1IZWlnaHRzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgbWluaW11bUhlaWdodHNbaV0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGxldCBtYXhpbXVtSGVpZ2h0czsKICAgICAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICAgICAgbWF4aW11bUhlaWdodHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgICBtYXhpbXVtSGVpZ2h0c1tpXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaEVsbGlwc29pZDE3KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0MTMKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMyMy5wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIzLm1pbmltdW1IZWlnaHRzID0gbWluaW11bUhlaWdodHM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIzLm1heGltdW1IZWlnaHRzID0gbWF4aW11bUhlaWdodHM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIzLmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICByZXR1cm4gbmV3IFdhbGxHZW9tZXRyeShzY3JhdGNoT3B0aW9uczIzKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgcmVzdWx0Ll9taW5pbXVtSGVpZ2h0cyA9IG1pbmltdW1IZWlnaHRzOwogICAgICAgIHJlc3VsdC5fbWF4aW11bUhlaWdodHMgPSBtYXhpbXVtSGVpZ2h0czsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCwgcmVzdWx0Ll9lbGxpcHNvaWQpOwogICAgICAgIHJlc3VsdC5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0LCByZXN1bHQuX3ZlcnRleEZvcm1hdCk7CiAgICAgICAgcmVzdWx0Ll9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFdhbGxHZW9tZXRyeS5mcm9tQ29uc3RhbnRIZWlnaHRzID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG9wdGlvbnMucG9zaXRpb25zOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnBvc2l0aW9ucyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgbGV0IG1pbkhlaWdodHM7CiAgICAgICAgbGV0IG1heEhlaWdodHM7CiAgICAgICAgY29uc3QgbWluMyA9IG9wdGlvbnMubWluaW11bUhlaWdodDsKICAgICAgICBjb25zdCBtYXgzID0gb3B0aW9ucy5tYXhpbXVtSGVpZ2h0OwogICAgICAgIGNvbnN0IGRvTWluID0gZGVmaW5lZF9kZWZhdWx0KG1pbjMpOwogICAgICAgIGNvbnN0IGRvTWF4ID0gZGVmaW5lZF9kZWZhdWx0KG1heDMpOwogICAgICAgIGlmIChkb01pbiB8fCBkb01heCkgewogICAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgIG1pbkhlaWdodHMgPSBkb01pbiA/IG5ldyBBcnJheShsZW5ndGgpIDogdm9pZCAwOwogICAgICAgICAgbWF4SGVpZ2h0cyA9IGRvTWF4ID8gbmV3IEFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGlmIChkb01pbikgewogICAgICAgICAgICAgIG1pbkhlaWdodHNbaV0gPSBtaW4zOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkb01heCkgewogICAgICAgICAgICAgIG1heEhlaWdodHNbaV0gPSBtYXgzOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5ld09wdGlvbnMgPSB7CiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBtYXhpbXVtSGVpZ2h0czogbWF4SGVpZ2h0cywKICAgICAgICAgIG1pbmltdW1IZWlnaHRzOiBtaW5IZWlnaHRzLAogICAgICAgICAgZWxsaXBzb2lkOiBvcHRpb25zLmVsbGlwc29pZCwKICAgICAgICAgIHZlcnRleEZvcm1hdDogb3B0aW9ucy52ZXJ0ZXhGb3JtYXQKICAgICAgICB9OwogICAgICAgIHJldHVybiBuZXcgV2FsbEdlb21ldHJ5KG5ld09wdGlvbnMpOwogICAgICB9OwogICAgICBXYWxsR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbih3YWxsR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCB3YWxsUG9zaXRpb25zID0gd2FsbEdlb21ldHJ5Ll9wb3NpdGlvbnM7CiAgICAgICAgY29uc3QgbWluaW11bUhlaWdodHMgPSB3YWxsR2VvbWV0cnkuX21pbmltdW1IZWlnaHRzOwogICAgICAgIGNvbnN0IG1heGltdW1IZWlnaHRzID0gd2FsbEdlb21ldHJ5Ll9tYXhpbXVtSGVpZ2h0czsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSB3YWxsR2VvbWV0cnkuX3ZlcnRleEZvcm1hdDsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IHdhbGxHZW9tZXRyeS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gd2FsbEdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgcG9zID0gV2FsbEdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbnMoCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICB3YWxsUG9zaXRpb25zLAogICAgICAgICAgbWF4aW11bUhlaWdodHMsCiAgICAgICAgICBtaW5pbXVtSGVpZ2h0cywKICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgdHJ1ZQogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBib3R0b21Qb3NpdGlvbnMgPSBwb3MuYm90dG9tUG9zaXRpb25zOwogICAgICAgIGNvbnN0IHRvcFBvc2l0aW9ucyA9IHBvcy50b3BQb3NpdGlvbnM7CiAgICAgICAgY29uc3QgbnVtQ29ybmVycyA9IHBvcy5udW1Db3JuZXJzOwogICAgICAgIGxldCBsZW5ndGggPSB0b3BQb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGxldCBzaXplID0gbGVuZ3RoICogMjsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB2ZXJ0ZXhGb3JtYXQucG9zaXRpb24gPyBuZXcgRmxvYXQ2NEFycmF5KHNpemUpIDogdm9pZCAwOwogICAgICAgIGNvbnN0IG5vcm1hbHMgPSB2ZXJ0ZXhGb3JtYXQubm9ybWFsID8gbmV3IEZsb2F0MzJBcnJheShzaXplKSA6IHZvaWQgMDsKICAgICAgICBjb25zdCB0YW5nZW50cyA9IHZlcnRleEZvcm1hdC50YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShzaXplKSA6IHZvaWQgMDsKICAgICAgICBjb25zdCBiaXRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSkgOiB2b2lkIDA7CiAgICAgICAgY29uc3QgdGV4dHVyZUNvb3JkaW5hdGVzID0gdmVydGV4Rm9ybWF0LnN0ID8gbmV3IEZsb2F0MzJBcnJheShzaXplIC8gMyAqIDIpIDogdm9pZCAwOwogICAgICAgIGxldCBwb3NpdGlvbkluZGV4ID0gMDsKICAgICAgICBsZXQgbm9ybWFsSW5kZXggPSAwOwogICAgICAgIGxldCBiaXRhbmdlbnRJbmRleCA9IDA7CiAgICAgICAgbGV0IHRhbmdlbnRJbmRleCA9IDA7CiAgICAgICAgbGV0IHN0SW5kZXggPSAwOwogICAgICAgIGxldCBub3JtYWwyID0gc2NyYXRjaE5vcm1hbDg7CiAgICAgICAgbGV0IHRhbmdlbnQgPSBzY3JhdGNoVGFuZ2VudDU7CiAgICAgICAgbGV0IGJpdGFuZ2VudCA9IHNjcmF0Y2hCaXRhbmdlbnQ1OwogICAgICAgIGxldCByZWNvbXB1dGVOb3JtYWwgPSB0cnVlOwogICAgICAgIGxlbmd0aCAvPSAzOwogICAgICAgIGxldCBpOwogICAgICAgIGxldCBzID0gMDsKICAgICAgICBjb25zdCBkcyA9IDEgLyAobGVuZ3RoIC0gbnVtQ29ybmVycyAtIDEpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgY29uc3QgaTMgPSBpICogMzsKICAgICAgICAgIGNvbnN0IHRvcFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgdG9wUG9zaXRpb25zLAogICAgICAgICAgICBpMywKICAgICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjEKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBib3R0b21Qb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgIGJvdHRvbVBvc2l0aW9ucywKICAgICAgICAgICAgaTMsCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24yCiAgICAgICAgICApOwogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IGJvdHRvbVBvc2l0aW9uLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gYm90dG9tUG9zaXRpb24ueTsKICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBib3R0b21Qb3NpdGlvbi56OwogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHRvcFBvc2l0aW9uLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gdG9wUG9zaXRpb24ueTsKICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSB0b3BQb3NpdGlvbi56OwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbc3RJbmRleCsrXSA9IHM7CiAgICAgICAgICAgIHRleHR1cmVDb29yZGluYXRlc1tzdEluZGV4KytdID0gMDsKICAgICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3N0SW5kZXgrK10gPSBzOwogICAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbc3RJbmRleCsrXSA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCB8fCB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgIGxldCBuZXh0VG9wID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKAogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLAogICAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb241CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbnN0IGdyb3VuZFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgICAgIHRvcFBvc2l0aW9uLAogICAgICAgICAgICAgIGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoCiAgICAgICAgICAgICAgICB0b3BQb3NpdGlvbiwKICAgICAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24yCiAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuM1Bvc2l0aW9uMgogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoaSArIDEgPCBsZW5ndGgpIHsKICAgICAgICAgICAgICBuZXh0VG9wID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgICAgIHRvcFBvc2l0aW9ucywKICAgICAgICAgICAgICAgIGkzICsgMywKICAgICAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb241CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmVjb21wdXRlTm9ybWFsKSB7CiAgICAgICAgICAgICAgY29uc3Qgc2NhbGVkbmV4dFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgICAgICAgbmV4dFRvcCwKICAgICAgICAgICAgICAgIHRvcFBvc2l0aW9uLAogICAgICAgICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjQKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGNvbnN0IHNjYWxlZEdyb3VuZFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgICAgICAgZ3JvdW5kUG9zaXRpb24sCiAgICAgICAgICAgICAgICB0b3BQb3NpdGlvbiwKICAgICAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24xCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhzY2FsZWRHcm91bmRQb3NpdGlvbiwgc2NhbGVkbmV4dFBvc2l0aW9uLCBub3JtYWwyKSwKICAgICAgICAgICAgICAgIG5vcm1hbDIKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHJlY29tcHV0ZU5vcm1hbCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbih0b3BQb3NpdGlvbiwgbmV4dFRvcCwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMCkpIHsKICAgICAgICAgICAgICByZWNvbXB1dGVOb3JtYWwgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHMgKz0gZHM7CiAgICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICAgICAgICB0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG5leHRUb3AsIHRvcFBvc2l0aW9uLCB0YW5nZW50KSwKICAgICAgICAgICAgICAgICAgdGFuZ2VudAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhub3JtYWwyLCB0YW5nZW50LCBiaXRhbmdlbnQpLAogICAgICAgICAgICAgICAgICBiaXRhbmdlbnQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueDsKICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi55OwogICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLno7CiAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueDsKICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi55OwogICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLno7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC54OwogICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueTsKICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lno7CiAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC54OwogICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueTsKICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lno7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lng7CiAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQuejsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lng7CiAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQuejsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICB2YWx1ZXM6IHBvc2l0aW9ucwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLm5vcm1hbCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogbm9ybWFscwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgYXR0cmlidXRlcy50YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgdmFsdWVzOiB0YW5nZW50cwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLmJpdGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogYml0YW5nZW50cwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgIGF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgICAgICB2YWx1ZXM6IHRleHR1cmVDb29yZGluYXRlcwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG51bVZlcnRpY2VzID0gc2l6ZSAvIDM7CiAgICAgICAgc2l6ZSAtPSA2ICogKG51bUNvcm5lcnMgKyAxKTsKICAgICAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobnVtVmVydGljZXMsIHNpemUpOwogICAgICAgIGxldCBlZGdlSW5kZXggPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1WZXJ0aWNlcyAtIDI7IGkgKz0gMikgewogICAgICAgICAgY29uc3QgTEwgPSBpOwogICAgICAgICAgY29uc3QgTFIgPSBpICsgMjsKICAgICAgICAgIGNvbnN0IHBsID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICBMTCAqIDMsCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24xCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcHIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAgIExSICogMywKICAgICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjIKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24ocGwsIHByLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwKSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IFVMID0gaSArIDE7CiAgICAgICAgICBjb25zdCBVUiA9IGkgKyAzOwogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBVTDsKICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gTEw7CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IFVSOwogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBVUjsKICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gTEw7CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IExSOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21WZXJ0aWNlcyhwb3NpdGlvbnMpCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFdhbGxHZW9tZXRyeV9kZWZhdWx0ID0gV2FsbEdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlV2FsbEdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZVdhbGxHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlV2FsbEdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVdhbGxHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlV2FsbEdlb21ldHJ5KHdhbGxHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgd2FsbEdlb21ldHJ5ID0gV2FsbEdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKHdhbGxHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHdhbGxHZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUod2FsbEdlb21ldHJ5Ll9lbGxpcHNvaWQpOwogICAgcmV0dXJuIFdhbGxHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KHdhbGxHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVXYWxsR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVXYWxsR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVdhbGxHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X1dhbGxHZW9tZXRyeSgpOwogICAgICBjcmVhdGVXYWxsR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVdhbGxHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1dhbGxPdXRsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBXYWxsT3V0bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3Qgd2FsbFBvc2l0aW9ucyA9IG9wdGlvbnMucG9zaXRpb25zOwogICAgY29uc3QgbWF4aW11bUhlaWdodHMgPSBvcHRpb25zLm1heGltdW1IZWlnaHRzOwogICAgY29uc3QgbWluaW11bUhlaWdodHMgPSBvcHRpb25zLm1pbmltdW1IZWlnaHRzOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQod2FsbFBvc2l0aW9ucykpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMucG9zaXRpb25zIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChtYXhpbXVtSGVpZ2h0cykgJiYgbWF4aW11bUhlaWdodHMubGVuZ3RoICE9PSB3YWxsUG9zaXRpb25zLmxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAib3B0aW9ucy5wb3NpdGlvbnMgYW5kIG9wdGlvbnMubWF4aW11bUhlaWdodHMgbXVzdCBoYXZlIHRoZSBzYW1lIGxlbmd0aC4iCiAgICAgICk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1IZWlnaHRzKSAmJiBtaW5pbXVtSGVpZ2h0cy5sZW5ndGggIT09IHdhbGxQb3NpdGlvbnMubGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJvcHRpb25zLnBvc2l0aW9ucyBhbmQgb3B0aW9ucy5taW5pbXVtSGVpZ2h0cyBtdXN0IGhhdmUgdGhlIHNhbWUgbGVuZ3RoLiIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICk7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgdGhpcy5fcG9zaXRpb25zID0gd2FsbFBvc2l0aW9uczsKICAgIHRoaXMuX21pbmltdW1IZWlnaHRzID0gbWluaW11bUhlaWdodHM7CiAgICB0aGlzLl9tYXhpbXVtSGVpZ2h0cyA9IG1heGltdW1IZWlnaHRzOwogICAgdGhpcy5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCk7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnkiOwogICAgbGV0IG51bUNvbXBvbmVudHMgPSAxICsgd2FsbFBvc2l0aW9ucy5sZW5ndGggKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMjsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWluaW11bUhlaWdodHMpKSB7CiAgICAgIG51bUNvbXBvbmVudHMgKz0gbWluaW11bUhlaWdodHMubGVuZ3RoOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChtYXhpbXVtSGVpZ2h0cykpIHsKICAgICAgbnVtQ29tcG9uZW50cyArPSBtYXhpbXVtSGVpZ2h0cy5sZW5ndGg7CiAgICB9CiAgICB0aGlzLnBhY2tlZExlbmd0aCA9IG51bUNvbXBvbmVudHMgKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAxOwogIH0KICB2YXIgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjEyLCBzY3JhdGNoQ2FydGVzaWFuM1Bvc2l0aW9uMjIsIHNjcmF0Y2hFbGxpcHNvaWQxOCwgc2NyYXRjaE9wdGlvbnMyNCwgV2FsbE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1dhbGxPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1dhbGxPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1dhbGxHZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjEyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuM1Bvc2l0aW9uMjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFdhbGxPdXRsaW5lR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZhbHVlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInZhbHVlIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB2YWx1ZS5fcG9zaXRpb25zOwogICAgICAgIGxldCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBsZW5ndGg7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHBvc2l0aW9uc1tpXSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBtaW5pbXVtSGVpZ2h0cyA9IHZhbHVlLl9taW5pbXVtSGVpZ2h0czsKICAgICAgICBsZW5ndGggPSBkZWZpbmVkX2RlZmF1bHQobWluaW11bUhlaWdodHMpID8gbWluaW11bUhlaWdodHMubGVuZ3RoIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWluaW11bUhlaWdodHMpKSB7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IG1pbmltdW1IZWlnaHRzW2ldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBtYXhpbXVtSGVpZ2h0cyA9IHZhbHVlLl9tYXhpbXVtSGVpZ2h0czsKICAgICAgICBsZW5ndGggPSBkZWZpbmVkX2RlZmF1bHQobWF4aW11bUhlaWdodHMpID8gbWF4aW11bUhlaWdodHMubGVuZ3RoIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWF4aW11bUhlaWdodHMpKSB7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IG1heGltdW1IZWlnaHRzW2ldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQxOCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKEVsbGlwc29pZF9kZWZhdWx0LlVOSVRfU1BIRVJFKTsKICAgICAgc2NyYXRjaE9wdGlvbnMyNCA9IHsKICAgICAgICBwb3NpdGlvbnM6IHZvaWQgMCwKICAgICAgICBtaW5pbXVtSGVpZ2h0czogdm9pZCAwLAogICAgICAgIG1heGltdW1IZWlnaHRzOiB2b2lkIDAsCiAgICAgICAgZWxsaXBzb2lkOiBzY3JhdGNoRWxsaXBzb2lkMTgsCiAgICAgICAgZ3JhbnVsYXJpdHk6IHZvaWQgMAogICAgICB9OwogICAgICBXYWxsT3V0bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgbGV0IGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIHBvc2l0aW9uc1tpXSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGxldCBtaW5pbXVtSGVpZ2h0czsKICAgICAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICAgICAgbWluaW11bUhlaWdodHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgICBtaW5pbXVtSGVpZ2h0c1tpXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgbGV0IG1heGltdW1IZWlnaHRzOwogICAgICAgIGlmIChsZW5ndGggPiAwKSB7CiAgICAgICAgICBtYXhpbXVtSGVpZ2h0cyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIG1heGltdW1IZWlnaHRzW2ldID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoRWxsaXBzb2lkMTgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMyNC5wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczI0Lm1pbmltdW1IZWlnaHRzID0gbWluaW11bUhlaWdodHM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczI0Lm1heGltdW1IZWlnaHRzID0gbWF4aW11bUhlaWdodHM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczI0LmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICByZXR1cm4gbmV3IFdhbGxPdXRsaW5lR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnMyNCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgICAgIHJlc3VsdC5fbWluaW11bUhlaWdodHMgPSBtaW5pbXVtSGVpZ2h0czsKICAgICAgICByZXN1bHQuX21heGltdW1IZWlnaHRzID0gbWF4aW11bUhlaWdodHM7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQsIHJlc3VsdC5fZWxsaXBzb2lkKTsKICAgICAgICByZXN1bHQuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgV2FsbE91dGxpbmVHZW9tZXRyeS5mcm9tQ29uc3RhbnRIZWlnaHRzID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG9wdGlvbnMucG9zaXRpb25zOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnBvc2l0aW9ucyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgbGV0IG1pbkhlaWdodHM7CiAgICAgICAgbGV0IG1heEhlaWdodHM7CiAgICAgICAgY29uc3QgbWluMyA9IG9wdGlvbnMubWluaW11bUhlaWdodDsKICAgICAgICBjb25zdCBtYXgzID0gb3B0aW9ucy5tYXhpbXVtSGVpZ2h0OwogICAgICAgIGNvbnN0IGRvTWluID0gZGVmaW5lZF9kZWZhdWx0KG1pbjMpOwogICAgICAgIGNvbnN0IGRvTWF4ID0gZGVmaW5lZF9kZWZhdWx0KG1heDMpOwogICAgICAgIGlmIChkb01pbiB8fCBkb01heCkgewogICAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgIG1pbkhlaWdodHMgPSBkb01pbiA/IG5ldyBBcnJheShsZW5ndGgpIDogdm9pZCAwOwogICAgICAgICAgbWF4SGVpZ2h0cyA9IGRvTWF4ID8gbmV3IEFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGlmIChkb01pbikgewogICAgICAgICAgICAgIG1pbkhlaWdodHNbaV0gPSBtaW4zOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkb01heCkgewogICAgICAgICAgICAgIG1heEhlaWdodHNbaV0gPSBtYXgzOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5ld09wdGlvbnMgPSB7CiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBtYXhpbXVtSGVpZ2h0czogbWF4SGVpZ2h0cywKICAgICAgICAgIG1pbmltdW1IZWlnaHRzOiBtaW5IZWlnaHRzLAogICAgICAgICAgZWxsaXBzb2lkOiBvcHRpb25zLmVsbGlwc29pZAogICAgICAgIH07CiAgICAgICAgcmV0dXJuIG5ldyBXYWxsT3V0bGluZUdlb21ldHJ5KG5ld09wdGlvbnMpOwogICAgICB9OwogICAgICBXYWxsT3V0bGluZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24od2FsbEdlb21ldHJ5KSB7CiAgICAgICAgY29uc3Qgd2FsbFBvc2l0aW9ucyA9IHdhbGxHZW9tZXRyeS5fcG9zaXRpb25zOwogICAgICAgIGNvbnN0IG1pbmltdW1IZWlnaHRzID0gd2FsbEdlb21ldHJ5Ll9taW5pbXVtSGVpZ2h0czsKICAgICAgICBjb25zdCBtYXhpbXVtSGVpZ2h0cyA9IHdhbGxHZW9tZXRyeS5fbWF4aW11bUhlaWdodHM7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSB3YWxsR2VvbWV0cnkuX2dyYW51bGFyaXR5OwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHdhbGxHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IHBvcyA9IFdhbGxHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb25zKAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgd2FsbFBvc2l0aW9ucywKICAgICAgICAgIG1heGltdW1IZWlnaHRzLAogICAgICAgICAgbWluaW11bUhlaWdodHMsCiAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgIGZhbHNlCiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3MpKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGJvdHRvbVBvc2l0aW9ucyA9IHBvcy5ib3R0b21Qb3NpdGlvbnM7CiAgICAgICAgY29uc3QgdG9wUG9zaXRpb25zID0gcG9zLnRvcFBvc2l0aW9uczsKICAgICAgICBsZXQgbGVuZ3RoID0gdG9wUG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBsZXQgc2l6ZSA9IGxlbmd0aCAqIDI7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShzaXplKTsKICAgICAgICBsZXQgcG9zaXRpb25JbmRleCA9IDA7CiAgICAgICAgbGVuZ3RoIC89IDM7CiAgICAgICAgbGV0IGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBjb25zdCBpMyA9IGkgKiAzOwogICAgICAgICAgY29uc3QgdG9wUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICB0b3BQb3NpdGlvbnMsCiAgICAgICAgICAgIGkzLAogICAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuM1Bvc2l0aW9uMTIKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBib3R0b21Qb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgIGJvdHRvbVBvc2l0aW9ucywKICAgICAgICAgICAgaTMsCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24yMgogICAgICAgICAgKTsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gYm90dG9tUG9zaXRpb24ueDsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gYm90dG9tUG9zaXRpb24ueTsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gYm90dG9tUG9zaXRpb24uejsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gdG9wUG9zaXRpb24ueDsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gdG9wUG9zaXRpb24ueTsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gdG9wUG9zaXRpb24uejsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCh7CiAgICAgICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogcG9zaXRpb25zCiAgICAgICAgICB9KQogICAgICAgIH0pOwogICAgICAgIGNvbnN0IG51bVZlcnRpY2VzID0gc2l6ZSAvIDM7CiAgICAgICAgc2l6ZSA9IDIgKiBudW1WZXJ0aWNlcyAtIDQgKyBudW1WZXJ0aWNlczsKICAgICAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobnVtVmVydGljZXMsIHNpemUpOwogICAgICAgIGxldCBlZGdlSW5kZXggPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1WZXJ0aWNlcyAtIDI7IGkgKz0gMikgewogICAgICAgICAgY29uc3QgTEwgPSBpOwogICAgICAgICAgY29uc3QgTFIgPSBpICsgMjsKICAgICAgICAgIGNvbnN0IHBsID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICBMTCAqIDMsCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24xMgogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHByID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICBMUiAqIDMsCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24yMgogICAgICAgICAgKTsKICAgICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihwbCwgcHIsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTApKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgVUwgPSBpICsgMTsKICAgICAgICAgIGNvbnN0IFVSID0gaSArIDM7CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IFVMOwogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBMTDsKICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gVUw7CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IFVSOwogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBMTDsKICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gTFI7CiAgICAgICAgfQogICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gbnVtVmVydGljZXMgLSAyOwogICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gbnVtVmVydGljZXMgLSAxOwogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tVmVydGljZXMocG9zaXRpb25zKQogICAgICAgIH0pOwogICAgICB9OwogICAgICBXYWxsT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBXYWxsT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVXYWxsT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVXYWxsT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnkod2FsbEdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICB3YWxsR2VvbWV0cnkgPSBXYWxsT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKHdhbGxHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHdhbGxHZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUod2FsbEdlb21ldHJ5Ll9lbGxpcHNvaWQpOwogICAgcmV0dXJuIFdhbGxPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeSh3YWxsR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9XYWxsT3V0bGluZUdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9kcmFjbzNkL2RyYWNvX2RlY29kZXJfbm9kZWpzLmpzCiAgdmFyIHJlcXVpcmVfZHJhY29fZGVjb2Rlcl9ub2RlanMgPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvZHJhY28zZC9kcmFjb19kZWNvZGVyX25vZGVqcy5qcyIoZXhwb3J0czIsIG1vZHVsZSkgewogICAgICB2YXIgJGpzY29tcCA9ICRqc2NvbXAgfHwge307CiAgICAgICRqc2NvbXAuc2NvcGUgPSB7fTsKICAgICAgJGpzY29tcC5hcnJheUl0ZXJhdG9ySW1wbCA9IGZ1bmN0aW9uKGspIHsKICAgICAgICB2YXIgbiA9IDA7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIG4gPCBrLmxlbmd0aCA/IHsgZG9uZTogZmFsc2UsIHZhbHVlOiBrW24rK10gfSA6IHsgZG9uZTogdHJ1ZSB9OwogICAgICAgIH07CiAgICAgIH07CiAgICAgICRqc2NvbXAuYXJyYXlJdGVyYXRvciA9IGZ1bmN0aW9uKGspIHsKICAgICAgICByZXR1cm4geyBuZXh0OiAkanNjb21wLmFycmF5SXRlcmF0b3JJbXBsKGspIH07CiAgICAgIH07CiAgICAgICRqc2NvbXAubWFrZUl0ZXJhdG9yID0gZnVuY3Rpb24oaykgewogICAgICAgIHZhciBuID0gInVuZGVmaW5lZCIgIT0gdHlwZW9mIFN5bWJvbCAmJiBTeW1ib2wuaXRlcmF0b3IgJiYga1tTeW1ib2wuaXRlcmF0b3JdOwogICAgICAgIHJldHVybiBuID8gbi5jYWxsKGspIDogJGpzY29tcC5hcnJheUl0ZXJhdG9yKGspOwogICAgICB9OwogICAgICAkanNjb21wLkFTU1VNRV9FUzUgPSBmYWxzZTsKICAgICAgJGpzY29tcC5BU1NVTUVfTk9fTkFUSVZFX01BUCA9IGZhbHNlOwogICAgICAkanNjb21wLkFTU1VNRV9OT19OQVRJVkVfU0VUID0gZmFsc2U7CiAgICAgICRqc2NvbXAuU0lNUExFX0ZST1VORF9QT0xZRklMTCA9IGZhbHNlOwogICAgICAkanNjb21wLklTT0xBVEVfUE9MWUZJTExTID0gZmFsc2U7CiAgICAgICRqc2NvbXAuRk9SQ0VfUE9MWUZJTExfUFJPTUlTRSA9IGZhbHNlOwogICAgICAkanNjb21wLkZPUkNFX1BPTFlGSUxMX1BST01JU0VfV0hFTl9OT19VTkhBTkRMRURfUkVKRUNUSU9OID0gZmFsc2U7CiAgICAgICRqc2NvbXAuZ2V0R2xvYmFsID0gZnVuY3Rpb24oaykgewogICAgICAgIGsgPSBbIm9iamVjdCIgPT0gdHlwZW9mIGdsb2JhbFRoaXMgJiYgZ2xvYmFsVGhpcywgaywgIm9iamVjdCIgPT0gdHlwZW9mIHdpbmRvdyAmJiB3aW5kb3csICJvYmplY3QiID09IHR5cGVvZiBzZWxmICYmIHNlbGYsICJvYmplY3QiID09IHR5cGVvZiBnbG9iYWwgJiYgZ2xvYmFsXTsKICAgICAgICBmb3IgKHZhciBuID0gMDsgbiA8IGsubGVuZ3RoOyArK24pIHsKICAgICAgICAgIHZhciBsID0ga1tuXTsKICAgICAgICAgIGlmIChsICYmIGwuTWF0aCA9PSBNYXRoKQogICAgICAgICAgICByZXR1cm4gbDsKICAgICAgICB9CiAgICAgICAgdGhyb3cgRXJyb3IoIkNhbm5vdCBmaW5kIGdsb2JhbCBvYmplY3QiKTsKICAgICAgfTsKICAgICAgJGpzY29tcC5nbG9iYWwgPSAkanNjb21wLmdldEdsb2JhbChleHBvcnRzMik7CiAgICAgICRqc2NvbXAuZGVmaW5lUHJvcGVydHkgPSAkanNjb21wLkFTU1VNRV9FUzUgfHwgImZ1bmN0aW9uIiA9PSB0eXBlb2YgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkgOiBmdW5jdGlvbihrLCBuLCBsKSB7CiAgICAgICAgaWYgKGsgPT0gQXJyYXkucHJvdG90eXBlIHx8IGsgPT0gT2JqZWN0LnByb3RvdHlwZSkKICAgICAgICAgIHJldHVybiBrOwogICAgICAgIGtbbl0gPSBsLnZhbHVlOwogICAgICAgIHJldHVybiBrOwogICAgICB9OwogICAgICAkanNjb21wLklTX1NZTUJPTF9OQVRJVkUgPSAiZnVuY3Rpb24iID09PSB0eXBlb2YgU3ltYm9sICYmICJzeW1ib2wiID09PSB0eXBlb2YgU3ltYm9sKCJ4Iik7CiAgICAgICRqc2NvbXAuVFJVU1RfRVM2X1BPTFlGSUxMUyA9ICEkanNjb21wLklTT0xBVEVfUE9MWUZJTExTIHx8ICRqc2NvbXAuSVNfU1lNQk9MX05BVElWRTsKICAgICAgJGpzY29tcC5wb2x5ZmlsbHMgPSB7fTsKICAgICAgJGpzY29tcC5wcm9wZXJ0eVRvUG9seWZpbGxTeW1ib2wgPSB7fTsKICAgICAgJGpzY29tcC5QT0xZRklMTF9QUkVGSVggPSAiJGpzY3AkIjsKICAgICAgJGpzY29tcC5wb2x5ZmlsbCA9IGZ1bmN0aW9uKGssIG4sIGwsIHApIHsKICAgICAgICBuICYmICgkanNjb21wLklTT0xBVEVfUE9MWUZJTExTID8gJGpzY29tcC5wb2x5ZmlsbElzb2xhdGVkKGssIG4sIGwsIHApIDogJGpzY29tcC5wb2x5ZmlsbFVuaXNvbGF0ZWQoaywgbiwgbCwgcCkpOwogICAgICB9OwogICAgICAkanNjb21wLnBvbHlmaWxsVW5pc29sYXRlZCA9IGZ1bmN0aW9uKGssIG4sIGwsIHApIHsKICAgICAgICBsID0gJGpzY29tcC5nbG9iYWw7CiAgICAgICAgayA9IGsuc3BsaXQoIi4iKTsKICAgICAgICBmb3IgKHAgPSAwOyBwIDwgay5sZW5ndGggLSAxOyBwKyspIHsKICAgICAgICAgIHZhciBoID0ga1twXTsKICAgICAgICAgIGlmICghKGggaW4gbCkpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIGwgPSBsW2hdOwogICAgICAgIH0KICAgICAgICBrID0ga1trLmxlbmd0aCAtIDFdOwogICAgICAgIHAgPSBsW2tdOwogICAgICAgIG4gPSBuKHApOwogICAgICAgIG4gIT0gcCAmJiBudWxsICE9IG4gJiYgJGpzY29tcC5kZWZpbmVQcm9wZXJ0eShsLCBrLCB7IGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUsIHZhbHVlOiBuIH0pOwogICAgICB9OwogICAgICAkanNjb21wLnBvbHlmaWxsSXNvbGF0ZWQgPSBmdW5jdGlvbihrLCBuLCBsLCBwKSB7CiAgICAgICAgdmFyIGggPSBrLnNwbGl0KCIuIik7CiAgICAgICAgayA9IDEgPT09IGgubGVuZ3RoOwogICAgICAgIHAgPSBoWzBdOwogICAgICAgIHAgPSAhayAmJiBwIGluICRqc2NvbXAucG9seWZpbGxzID8gJGpzY29tcC5wb2x5ZmlsbHMgOiAkanNjb21wLmdsb2JhbDsKICAgICAgICBmb3IgKHZhciBBID0gMDsgQSA8IGgubGVuZ3RoIC0gMTsgQSsrKSB7CiAgICAgICAgICB2YXIgZiA9IGhbQV07CiAgICAgICAgICBpZiAoIShmIGluIHApKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICBwID0gcFtmXTsKICAgICAgICB9CiAgICAgICAgaCA9IGhbaC5sZW5ndGggLSAxXTsKICAgICAgICBsID0gJGpzY29tcC5JU19TWU1CT0xfTkFUSVZFICYmICJlczYiID09PSBsID8gcFtoXSA6IG51bGw7CiAgICAgICAgbiA9IG4obCk7CiAgICAgICAgbnVsbCAhPSBuICYmIChrID8gJGpzY29tcC5kZWZpbmVQcm9wZXJ0eSgkanNjb21wLnBvbHlmaWxscywgaCwgeyBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlLCB2YWx1ZTogbiB9KSA6IG4gIT09IGwgJiYgKHZvaWQgMCA9PT0gJGpzY29tcC5wcm9wZXJ0eVRvUG9seWZpbGxTeW1ib2xbaF0gJiYgKGwgPSAxZTkgKiBNYXRoLnJhbmRvbSgpID4+PiAwLCAkanNjb21wLnByb3BlcnR5VG9Qb2x5ZmlsbFN5bWJvbFtoXSA9ICRqc2NvbXAuSVNfU1lNQk9MX05BVElWRSA/ICRqc2NvbXAuZ2xvYmFsLlN5bWJvbChoKSA6ICRqc2NvbXAuUE9MWUZJTExfUFJFRklYICsgbCArICIkIiArIGgpLCAkanNjb21wLmRlZmluZVByb3BlcnR5KHAsICRqc2NvbXAucHJvcGVydHlUb1BvbHlmaWxsU3ltYm9sW2hdLCB7IGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUsIHZhbHVlOiBuIH0pKSk7CiAgICAgIH07CiAgICAgICRqc2NvbXAucG9seWZpbGwoIlByb21pc2UiLCBmdW5jdGlvbihrKSB7CiAgICAgICAgZnVuY3Rpb24gbigpIHsKICAgICAgICAgIHRoaXMuYmF0Y2hfID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbChmKSB7CiAgICAgICAgICByZXR1cm4gZiBpbnN0YW5jZW9mIGggPyBmIDogbmV3IGgoZnVuY3Rpb24ocSwgdjMpIHsKICAgICAgICAgICAgcShmKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAoayAmJiAoISgkanNjb21wLkZPUkNFX1BPTFlGSUxMX1BST01JU0UgfHwgJGpzY29tcC5GT1JDRV9QT0xZRklMTF9QUk9NSVNFX1dIRU5fTk9fVU5IQU5ETEVEX1JFSkVDVElPTiAmJiAidW5kZWZpbmVkIiA9PT0gdHlwZW9mICRqc2NvbXAuZ2xvYmFsLlByb21pc2VSZWplY3Rpb25FdmVudCkgfHwgISRqc2NvbXAuZ2xvYmFsLlByb21pc2UgfHwgLTEgPT09ICRqc2NvbXAuZ2xvYmFsLlByb21pc2UudG9TdHJpbmcoKS5pbmRleE9mKCJbbmF0aXZlIGNvZGVdIikpKQogICAgICAgICAgcmV0dXJuIGs7CiAgICAgICAgbi5wcm90b3R5cGUuYXN5bmNFeGVjdXRlID0gZnVuY3Rpb24oZikgewogICAgICAgICAgaWYgKG51bGwgPT0gdGhpcy5iYXRjaF8pIHsKICAgICAgICAgICAgdGhpcy5iYXRjaF8gPSBbXTsKICAgICAgICAgICAgdmFyIHEgPSB0aGlzOwogICAgICAgICAgICB0aGlzLmFzeW5jRXhlY3V0ZUZ1bmN0aW9uKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHEuZXhlY3V0ZUJhdGNoXygpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuYmF0Y2hfLnB1c2goZik7CiAgICAgICAgfTsKICAgICAgICB2YXIgcCA9ICRqc2NvbXAuZ2xvYmFsLnNldFRpbWVvdXQ7CiAgICAgICAgbi5wcm90b3R5cGUuYXN5bmNFeGVjdXRlRnVuY3Rpb24gPSBmdW5jdGlvbihmKSB7CiAgICAgICAgICBwKGYsIDApOwogICAgICAgIH07CiAgICAgICAgbi5wcm90b3R5cGUuZXhlY3V0ZUJhdGNoXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgZm9yICg7IHRoaXMuYmF0Y2hfICYmIHRoaXMuYmF0Y2hfLmxlbmd0aDsgKSB7CiAgICAgICAgICAgIHZhciBmID0gdGhpcy5iYXRjaF87CiAgICAgICAgICAgIHRoaXMuYmF0Y2hfID0gW107CiAgICAgICAgICAgIGZvciAodmFyIHEgPSAwOyBxIDwgZi5sZW5ndGg7ICsrcSkgewogICAgICAgICAgICAgIHZhciB2MyA9IGZbcV07CiAgICAgICAgICAgICAgZltxXSA9IG51bGw7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHYzKCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoeikgewogICAgICAgICAgICAgICAgdGhpcy5hc3luY1Rocm93Xyh6KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuYmF0Y2hfID0gbnVsbDsKICAgICAgICB9OwogICAgICAgIG4ucHJvdG90eXBlLmFzeW5jVGhyb3dfID0gZnVuY3Rpb24oZikgewogICAgICAgICAgdGhpcy5hc3luY0V4ZWN1dGVGdW5jdGlvbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhyb3cgZjsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgdmFyIGggPSBmdW5jdGlvbihmKSB7CiAgICAgICAgICB0aGlzLnN0YXRlXyA9IDA7CiAgICAgICAgICB0aGlzLnJlc3VsdF8gPSB2b2lkIDA7CiAgICAgICAgICB0aGlzLm9uU2V0dGxlZENhbGxiYWNrc18gPSBbXTsKICAgICAgICAgIHRoaXMuaXNSZWplY3Rpb25IYW5kbGVkXyA9IGZhbHNlOwogICAgICAgICAgdmFyIHEgPSB0aGlzLmNyZWF0ZVJlc29sdmVBbmRSZWplY3RfKCk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBmKHEucmVzb2x2ZSwgcS5yZWplY3QpOwogICAgICAgICAgfSBjYXRjaCAodjMpIHsKICAgICAgICAgICAgcS5yZWplY3QodjMpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgaC5wcm90b3R5cGUuY3JlYXRlUmVzb2x2ZUFuZFJlamVjdF8gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGZ1bmN0aW9uIGYoeikgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oTykgewogICAgICAgICAgICAgIHYzIHx8ICh2MyA9IHRydWUsIHouY2FsbChxLCBPKSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcSA9IHRoaXMsIHYzID0gZmFsc2U7CiAgICAgICAgICByZXR1cm4geyByZXNvbHZlOiBmKHRoaXMucmVzb2x2ZVRvXyksIHJlamVjdDogZih0aGlzLnJlamVjdF8pIH07CiAgICAgICAgfTsKICAgICAgICBoLnByb3RvdHlwZS5yZXNvbHZlVG9fID0gZnVuY3Rpb24oZikgewogICAgICAgICAgaWYgKGYgPT09IHRoaXMpCiAgICAgICAgICAgIHRoaXMucmVqZWN0XyhuZXcgVHlwZUVycm9yKCJBIFByb21pc2UgY2Fubm90IHJlc29sdmUgdG8gaXRzZWxmIikpOwogICAgICAgICAgZWxzZSBpZiAoZiBpbnN0YW5jZW9mIGgpCiAgICAgICAgICAgIHRoaXMuc2V0dGxlU2FtZUFzUHJvbWlzZV8oZik7CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgYToKICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiBmKSB7CiAgICAgICAgICAgICAgICBjYXNlICJvYmplY3QiOgogICAgICAgICAgICAgICAgICB2YXIgcSA9IG51bGwgIT0gZjsKICAgICAgICAgICAgICAgICAgYnJlYWsgYTsKICAgICAgICAgICAgICAgIGNhc2UgImZ1bmN0aW9uIjoKICAgICAgICAgICAgICAgICAgcSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGJyZWFrIGE7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICBxID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICBxID8gdGhpcy5yZXNvbHZlVG9Ob25Qcm9taXNlT2JqXyhmKSA6IHRoaXMuZnVsZmlsbF8oZik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBoLnByb3RvdHlwZS5yZXNvbHZlVG9Ob25Qcm9taXNlT2JqXyA9IGZ1bmN0aW9uKGYpIHsKICAgICAgICAgIHZhciBxID0gdm9pZCAwOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcSA9IGYudGhlbjsKICAgICAgICAgIH0gY2F0Y2ggKHYzKSB7CiAgICAgICAgICAgIHRoaXMucmVqZWN0Xyh2Myk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgICJmdW5jdGlvbiIgPT0gdHlwZW9mIHEgPyB0aGlzLnNldHRsZVNhbWVBc1RoZW5hYmxlXyhxLCBmKSA6IHRoaXMuZnVsZmlsbF8oZik7CiAgICAgICAgfTsKICAgICAgICBoLnByb3RvdHlwZS5yZWplY3RfID0gZnVuY3Rpb24oZikgewogICAgICAgICAgdGhpcy5zZXR0bGVfKDIsIGYpOwogICAgICAgIH07CiAgICAgICAgaC5wcm90b3R5cGUuZnVsZmlsbF8gPSBmdW5jdGlvbihmKSB7CiAgICAgICAgICB0aGlzLnNldHRsZV8oMSwgZik7CiAgICAgICAgfTsKICAgICAgICBoLnByb3RvdHlwZS5zZXR0bGVfID0gZnVuY3Rpb24oZiwgcSkgewogICAgICAgICAgaWYgKDAgIT0gdGhpcy5zdGF0ZV8pCiAgICAgICAgICAgIHRocm93IEVycm9yKCJDYW5ub3Qgc2V0dGxlKCIgKyBmICsgIiwgIiArIHEgKyAiKTogUHJvbWlzZSBhbHJlYWR5IHNldHRsZWQgaW4gc3RhdGUiICsgdGhpcy5zdGF0ZV8pOwogICAgICAgICAgdGhpcy5zdGF0ZV8gPSBmOwogICAgICAgICAgdGhpcy5yZXN1bHRfID0gcTsKICAgICAgICAgIDIgPT09IHRoaXMuc3RhdGVfICYmIHRoaXMuc2NoZWR1bGVVbmhhbmRsZWRSZWplY3Rpb25DaGVja18oKTsKICAgICAgICAgIHRoaXMuZXhlY3V0ZU9uU2V0dGxlZENhbGxiYWNrc18oKTsKICAgICAgICB9OwogICAgICAgIGgucHJvdG90eXBlLnNjaGVkdWxlVW5oYW5kbGVkUmVqZWN0aW9uQ2hlY2tfID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgZiA9IHRoaXM7CiAgICAgICAgICBwKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoZi5ub3RpZnlVbmhhbmRsZWRSZWplY3Rpb25fKCkpIHsKICAgICAgICAgICAgICB2YXIgcSA9ICRqc2NvbXAuZ2xvYmFsLmNvbnNvbGU7CiAgICAgICAgICAgICAgInVuZGVmaW5lZCIgIT09IHR5cGVvZiBxICYmIHEuZXJyb3IoZi5yZXN1bHRfKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwgMSk7CiAgICAgICAgfTsKICAgICAgICBoLnByb3RvdHlwZS5ub3RpZnlVbmhhbmRsZWRSZWplY3Rpb25fID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAodGhpcy5pc1JlamVjdGlvbkhhbmRsZWRfKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB2YXIgZiA9ICRqc2NvbXAuZ2xvYmFsLkN1c3RvbUV2ZW50LCBxID0gJGpzY29tcC5nbG9iYWwuRXZlbnQsIHYzID0gJGpzY29tcC5nbG9iYWwuZGlzcGF0Y2hFdmVudDsKICAgICAgICAgIGlmICgidW5kZWZpbmVkIiA9PT0gdHlwZW9mIHYzKQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICJmdW5jdGlvbiIgPT09IHR5cGVvZiBmID8gZiA9IG5ldyBmKCJ1bmhhbmRsZWRyZWplY3Rpb24iLCB7IGNhbmNlbGFibGU6IHRydWUgfSkgOiAiZnVuY3Rpb24iID09PSB0eXBlb2YgcSA/IGYgPSBuZXcgcSgidW5oYW5kbGVkcmVqZWN0aW9uIiwgeyBjYW5jZWxhYmxlOiB0cnVlIH0pIDogKGYgPSAkanNjb21wLmdsb2JhbC5kb2N1bWVudC5jcmVhdGVFdmVudCgiQ3VzdG9tRXZlbnQiKSwgZi5pbml0Q3VzdG9tRXZlbnQoInVuaGFuZGxlZHJlamVjdGlvbiIsIGZhbHNlLCB0cnVlLCBmKSk7CiAgICAgICAgICBmLnByb21pc2UgPSB0aGlzOwogICAgICAgICAgZi5yZWFzb24gPSB0aGlzLnJlc3VsdF87CiAgICAgICAgICByZXR1cm4gdjMoZik7CiAgICAgICAgfTsKICAgICAgICBoLnByb3RvdHlwZS5leGVjdXRlT25TZXR0bGVkQ2FsbGJhY2tzXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKG51bGwgIT0gdGhpcy5vblNldHRsZWRDYWxsYmFja3NfKSB7CiAgICAgICAgICAgIGZvciAodmFyIGYgPSAwOyBmIDwgdGhpcy5vblNldHRsZWRDYWxsYmFja3NfLmxlbmd0aDsgKytmKQogICAgICAgICAgICAgIEEuYXN5bmNFeGVjdXRlKHRoaXMub25TZXR0bGVkQ2FsbGJhY2tzX1tmXSk7CiAgICAgICAgICAgIHRoaXMub25TZXR0bGVkQ2FsbGJhY2tzXyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB2YXIgQSA9IG5ldyBuKCk7CiAgICAgICAgaC5wcm90b3R5cGUuc2V0dGxlU2FtZUFzUHJvbWlzZV8gPSBmdW5jdGlvbihmKSB7CiAgICAgICAgICB2YXIgcSA9IHRoaXMuY3JlYXRlUmVzb2x2ZUFuZFJlamVjdF8oKTsKICAgICAgICAgIGYuY2FsbFdoZW5TZXR0bGVkXyhxLnJlc29sdmUsIHEucmVqZWN0KTsKICAgICAgICB9OwogICAgICAgIGgucHJvdG90eXBlLnNldHRsZVNhbWVBc1RoZW5hYmxlXyA9IGZ1bmN0aW9uKGYsIHEpIHsKICAgICAgICAgIHZhciB2MyA9IHRoaXMuY3JlYXRlUmVzb2x2ZUFuZFJlamVjdF8oKTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGYuY2FsbChxLCB2My5yZXNvbHZlLCB2My5yZWplY3QpOwogICAgICAgICAgfSBjYXRjaCAoeikgewogICAgICAgICAgICB2My5yZWplY3Qoeik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBoLnByb3RvdHlwZS50aGVuID0gZnVuY3Rpb24oZiwgcSkgewogICAgICAgICAgZnVuY3Rpb24gdjModCwgeCkgewogICAgICAgICAgICByZXR1cm4gImZ1bmN0aW9uIiA9PSB0eXBlb2YgdCA/IGZ1bmN0aW9uKEQpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgeih0KEQpKTsKICAgICAgICAgICAgICB9IGNhdGNoIChSKSB7CiAgICAgICAgICAgICAgICBPKFIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSA6IHg7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgeiwgTywgYmEgPSBuZXcgaChmdW5jdGlvbih0LCB4KSB7CiAgICAgICAgICAgIHogPSB0OwogICAgICAgICAgICBPID0geDsKICAgICAgICAgIH0pOwogICAgICAgICAgdGhpcy5jYWxsV2hlblNldHRsZWRfKHYzKGYsIHopLCB2MyhxLCBPKSk7CiAgICAgICAgICByZXR1cm4gYmE7CiAgICAgICAgfTsKICAgICAgICBoLnByb3RvdHlwZS5jYXRjaCA9IGZ1bmN0aW9uKGYpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnRoZW4odm9pZCAwLCBmKTsKICAgICAgICB9OwogICAgICAgIGgucHJvdG90eXBlLmNhbGxXaGVuU2V0dGxlZF8gPSBmdW5jdGlvbihmLCBxKSB7CiAgICAgICAgICBmdW5jdGlvbiB2MygpIHsKICAgICAgICAgICAgc3dpdGNoICh6LnN0YXRlXykgewogICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgIGYoei5yZXN1bHRfKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIHEoei5yZXN1bHRfKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiVW5leHBlY3RlZCBzdGF0ZTogIiArIHouc3RhdGVfKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHogPSB0aGlzOwogICAgICAgICAgbnVsbCA9PSB0aGlzLm9uU2V0dGxlZENhbGxiYWNrc18gPyBBLmFzeW5jRXhlY3V0ZSh2MykgOiB0aGlzLm9uU2V0dGxlZENhbGxiYWNrc18ucHVzaCh2Myk7CiAgICAgICAgICB0aGlzLmlzUmVqZWN0aW9uSGFuZGxlZF8gPSB0cnVlOwogICAgICAgIH07CiAgICAgICAgaC5yZXNvbHZlID0gbDsKICAgICAgICBoLnJlamVjdCA9IGZ1bmN0aW9uKGYpIHsKICAgICAgICAgIHJldHVybiBuZXcgaChmdW5jdGlvbihxLCB2MykgewogICAgICAgICAgICB2MyhmKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgaC5yYWNlID0gZnVuY3Rpb24oZikgewogICAgICAgICAgcmV0dXJuIG5ldyBoKGZ1bmN0aW9uKHEsIHYzKSB7CiAgICAgICAgICAgIGZvciAodmFyIHogPSAkanNjb21wLm1ha2VJdGVyYXRvcihmKSwgTyA9IHoubmV4dCgpOyAhTy5kb25lOyBPID0gei5uZXh0KCkpCiAgICAgICAgICAgICAgbChPLnZhbHVlKS5jYWxsV2hlblNldHRsZWRfKHEsIHYzKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgaC5hbGwgPSBmdW5jdGlvbihmKSB7CiAgICAgICAgICB2YXIgcSA9ICRqc2NvbXAubWFrZUl0ZXJhdG9yKGYpLCB2MyA9IHEubmV4dCgpOwogICAgICAgICAgcmV0dXJuIHYzLmRvbmUgPyBsKFtdKSA6IG5ldyBoKGZ1bmN0aW9uKHosIE8pIHsKICAgICAgICAgICAgZnVuY3Rpb24gYmEoRCkgewogICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihSKSB7CiAgICAgICAgICAgICAgICB0W0RdID0gUjsKICAgICAgICAgICAgICAgIHgtLTsKICAgICAgICAgICAgICAgIDAgPT0geCAmJiB6KHQpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHQgPSBbXSwgeCA9IDA7CiAgICAgICAgICAgIGRvCiAgICAgICAgICAgICAgdC5wdXNoKHZvaWQgMCksIHgrKywgbCh2My52YWx1ZSkuY2FsbFdoZW5TZXR0bGVkXyhiYSh0Lmxlbmd0aCAtIDEpLCBPKSwgdjMgPSBxLm5leHQoKTsKICAgICAgICAgICAgd2hpbGUgKCF2My5kb25lKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGg7CiAgICAgIH0sICJlczYiLCAiZXMzIik7CiAgICAgICRqc2NvbXAub3ducyA9IGZ1bmN0aW9uKGssIG4pIHsKICAgICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGssIG4pOwogICAgICB9OwogICAgICAkanNjb21wLmFzc2lnbiA9ICRqc2NvbXAuVFJVU1RfRVM2X1BPTFlGSUxMUyAmJiAiZnVuY3Rpb24iID09IHR5cGVvZiBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbiA6IGZ1bmN0aW9uKGssIG4pIHsKICAgICAgICBmb3IgKHZhciBsID0gMTsgbCA8IGFyZ3VtZW50cy5sZW5ndGg7IGwrKykgewogICAgICAgICAgdmFyIHAgPSBhcmd1bWVudHNbbF07CiAgICAgICAgICBpZiAocCkKICAgICAgICAgICAgZm9yICh2YXIgaCBpbiBwKQogICAgICAgICAgICAgICRqc2NvbXAub3ducyhwLCBoKSAmJiAoa1toXSA9IHBbaF0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gazsKICAgICAgfTsKICAgICAgJGpzY29tcC5wb2x5ZmlsbCgiT2JqZWN0LmFzc2lnbiIsIGZ1bmN0aW9uKGspIHsKICAgICAgICByZXR1cm4gayB8fCAkanNjb21wLmFzc2lnbjsKICAgICAgfSwgImVzNiIsICJlczMiKTsKICAgICAgJGpzY29tcC5jaGVja1N0cmluZ0FyZ3MgPSBmdW5jdGlvbihrLCBuLCBsKSB7CiAgICAgICAgaWYgKG51bGwgPT0gaykKICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlRoZSAndGhpcycgdmFsdWUgZm9yIFN0cmluZy5wcm90b3R5cGUuIiArIGwgKyAiIG11c3Qgbm90IGJlIG51bGwgb3IgdW5kZWZpbmVkIik7CiAgICAgICAgaWYgKG4gaW5zdGFuY2VvZiBSZWdFeHApCiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJGaXJzdCBhcmd1bWVudCB0byBTdHJpbmcucHJvdG90eXBlLiIgKyBsICsgIiBtdXN0IG5vdCBiZSBhIHJlZ3VsYXIgZXhwcmVzc2lvbiIpOwogICAgICAgIHJldHVybiBrICsgIiI7CiAgICAgIH07CiAgICAgICRqc2NvbXAucG9seWZpbGwoIlN0cmluZy5wcm90b3R5cGUuc3RhcnRzV2l0aCIsIGZ1bmN0aW9uKGspIHsKICAgICAgICByZXR1cm4gayA/IGsgOiBmdW5jdGlvbihuLCBsKSB7CiAgICAgICAgICB2YXIgcCA9ICRqc2NvbXAuY2hlY2tTdHJpbmdBcmdzKHRoaXMsIG4sICJzdGFydHNXaXRoIik7CiAgICAgICAgICBuICs9ICIiOwogICAgICAgICAgdmFyIGggPSBwLmxlbmd0aCwgQSA9IG4ubGVuZ3RoOwogICAgICAgICAgbCA9IE1hdGgubWF4KDAsIE1hdGgubWluKGwgfCAwLCBwLmxlbmd0aCkpOwogICAgICAgICAgZm9yICh2YXIgZiA9IDA7IGYgPCBBICYmIGwgPCBoOyApCiAgICAgICAgICAgIGlmIChwW2wrK10gIT0gbltmKytdKQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIHJldHVybiBmID49IEE7CiAgICAgICAgfTsKICAgICAgfSwgImVzNiIsICJlczMiKTsKICAgICAgJGpzY29tcC5wb2x5ZmlsbCgiQXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCBmdW5jdGlvbihrKSB7CiAgICAgICAgZnVuY3Rpb24gbihsKSB7CiAgICAgICAgICBsID0gTnVtYmVyKGwpOwogICAgICAgICAgcmV0dXJuIEluZmluaXR5ID09PSBsIHx8IC1JbmZpbml0eSA9PT0gbCA/IGwgOiBsIHwgMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGsgPyBrIDogZnVuY3Rpb24obCwgcCwgaCkgewogICAgICAgICAgdmFyIEEgPSB0aGlzLmxlbmd0aDsKICAgICAgICAgIGwgPSBuKGwpOwogICAgICAgICAgcCA9IG4ocCk7CiAgICAgICAgICBoID0gdm9pZCAwID09PSBoID8gQSA6IG4oaCk7CiAgICAgICAgICBsID0gMCA+IGwgPyBNYXRoLm1heChBICsgbCwgMCkgOiBNYXRoLm1pbihsLCBBKTsKICAgICAgICAgIHAgPSAwID4gcCA/IE1hdGgubWF4KEEgKyBwLCAwKSA6IE1hdGgubWluKHAsIEEpOwogICAgICAgICAgaCA9IDAgPiBoID8gTWF0aC5tYXgoQSArIGgsIDApIDogTWF0aC5taW4oaCwgQSk7CiAgICAgICAgICBpZiAobCA8IHApCiAgICAgICAgICAgIGZvciAoOyBwIDwgaDsgKQogICAgICAgICAgICAgIHAgaW4gdGhpcyA/IHRoaXNbbCsrXSA9IHRoaXNbcCsrXSA6IChkZWxldGUgdGhpc1tsKytdLCBwKyspOwogICAgICAgICAgZWxzZQogICAgICAgICAgICBmb3IgKGggPSBNYXRoLm1pbihoLCBBICsgcCAtIGwpLCBsICs9IGggLSBwOyBoID4gcDsgKQogICAgICAgICAgICAgIC0taCBpbiB0aGlzID8gdGhpc1stLWxdID0gdGhpc1toXSA6IGRlbGV0ZSB0aGlzWy0tbF07CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICB9LCAiZXM2IiwgImVzMyIpOwogICAgICAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluID0gZnVuY3Rpb24oaykgewogICAgICAgIHJldHVybiBrID8gayA6IEFycmF5LnByb3RvdHlwZS5jb3B5V2l0aGluOwogICAgICB9OwogICAgICAkanNjb21wLnBvbHlmaWxsKCJJbnQ4QXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluLCAiZXM2IiwgImVzNSIpOwogICAgICAkanNjb21wLnBvbHlmaWxsKCJVaW50OEFycmF5LnByb3RvdHlwZS5jb3B5V2l0aGluIiwgJGpzY29tcC50eXBlZEFycmF5Q29weVdpdGhpbiwgImVzNiIsICJlczUiKTsKICAgICAgJGpzY29tcC5wb2x5ZmlsbCgiVWludDhDbGFtcGVkQXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluLCAiZXM2IiwgImVzNSIpOwogICAgICAkanNjb21wLnBvbHlmaWxsKCJJbnQxNkFycmF5LnByb3RvdHlwZS5jb3B5V2l0aGluIiwgJGpzY29tcC50eXBlZEFycmF5Q29weVdpdGhpbiwgImVzNiIsICJlczUiKTsKICAgICAgJGpzY29tcC5wb2x5ZmlsbCgiVWludDE2QXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluLCAiZXM2IiwgImVzNSIpOwogICAgICAkanNjb21wLnBvbHlmaWxsKCJJbnQzMkFycmF5LnByb3RvdHlwZS5jb3B5V2l0aGluIiwgJGpzY29tcC50eXBlZEFycmF5Q29weVdpdGhpbiwgImVzNiIsICJlczUiKTsKICAgICAgJGpzY29tcC5wb2x5ZmlsbCgiVWludDMyQXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluLCAiZXM2IiwgImVzNSIpOwogICAgICAkanNjb21wLnBvbHlmaWxsKCJGbG9hdDMyQXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluLCAiZXM2IiwgImVzNSIpOwogICAgICAkanNjb21wLnBvbHlmaWxsKCJGbG9hdDY0QXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluLCAiZXM2IiwgImVzNSIpOwogICAgICB2YXIgRHJhY29EZWNvZGVyTW9kdWxlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGsgPSAidW5kZWZpbmVkIiAhPT0gdHlwZW9mIGRvY3VtZW50ICYmIGRvY3VtZW50LmN1cnJlbnRTY3JpcHQgPyBkb2N1bWVudC5jdXJyZW50U2NyaXB0LnNyYyA6IHZvaWQgMDsKICAgICAgICAidW5kZWZpbmVkIiAhPT0gdHlwZW9mIF9fZmlsZW5hbWUgJiYgKGsgPSBrIHx8IF9fZmlsZW5hbWUpOwogICAgICAgIHJldHVybiBmdW5jdGlvbihuKSB7CiAgICAgICAgICBmdW5jdGlvbiBsKGUpIHsKICAgICAgICAgICAgcmV0dXJuIGEzLmxvY2F0ZUZpbGUgPyBhMy5sb2NhdGVGaWxlKGUsIFUpIDogVSArIGU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwKGUsIGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSBiICsgYzsKICAgICAgICAgICAgZm9yIChjID0gYjsgZVtjXSAmJiAhKGMgPj0gZCk7ICkKICAgICAgICAgICAgICArK2M7CiAgICAgICAgICAgIGlmICgxNiA8IGMgLSBiICYmIGUuYnVmZmVyICYmIHZhKQogICAgICAgICAgICAgIHJldHVybiB2YS5kZWNvZGUoZS5zdWJhcnJheShiLCBjKSk7CiAgICAgICAgICAgIGZvciAoZCA9ICIiOyBiIDwgYzsgKSB7CiAgICAgICAgICAgICAgdmFyIGcgPSBlW2IrK107CiAgICAgICAgICAgICAgaWYgKGcgJiAxMjgpIHsKICAgICAgICAgICAgICAgIHZhciB1MyA9IGVbYisrXSAmIDYzOwogICAgICAgICAgICAgICAgaWYgKDE5MiA9PSAoZyAmIDIyNCkpCiAgICAgICAgICAgICAgICAgIGQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoZyAmIDMxKSA8PCA2IHwgdTMpOwogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBYID0gZVtiKytdICYgNjM7CiAgICAgICAgICAgICAgICAgIGcgPSAyMjQgPT0gKGcgJiAyNDApID8gKGcgJiAxNSkgPDwgMTIgfCB1MyA8PCA2IHwgWCA6IChnICYgNykgPDwgMTggfCB1MyA8PCAxMiB8IFggPDwgNiB8IGVbYisrXSAmIDYzOwogICAgICAgICAgICAgICAgICA2NTUzNiA+IGcgPyBkICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoZykgOiAoZyAtPSA2NTUzNiwgZCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDU1Mjk2IHwgZyA+PiAxMCwgNTYzMjAgfCBnICYgMTAyMykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZQogICAgICAgICAgICAgICAgZCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaChlLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBlID8gcChlYSwgZSwgYikgOiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIEEoKSB7CiAgICAgICAgICAgIHZhciBlID0gamEuYnVmZmVyOwogICAgICAgICAgICBhMy5IRUFQOCA9IFkgPSBuZXcgSW50OEFycmF5KGUpOwogICAgICAgICAgICBhMy5IRUFQMTYgPSBuZXcgSW50MTZBcnJheShlKTsKICAgICAgICAgICAgYTMuSEVBUDMyID0gY2EgPSBuZXcgSW50MzJBcnJheShlKTsKICAgICAgICAgICAgYTMuSEVBUFU4ID0gZWEgPSBuZXcgVWludDhBcnJheShlKTsKICAgICAgICAgICAgYTMuSEVBUFUxNiA9IG5ldyBVaW50MTZBcnJheShlKTsKICAgICAgICAgICAgYTMuSEVBUFUzMiA9IFYgPSBuZXcgVWludDMyQXJyYXkoZSk7CiAgICAgICAgICAgIGEzLkhFQVBGMzIgPSBuZXcgRmxvYXQzMkFycmF5KGUpOwogICAgICAgICAgICBhMy5IRUFQRjY0ID0gbmV3IEZsb2F0NjRBcnJheShlKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGYoZSkgewogICAgICAgICAgICBpZiAoYTMub25BYm9ydCkKICAgICAgICAgICAgICBhMy5vbkFib3J0KGUpOwogICAgICAgICAgICBlID0gIkFib3J0ZWQoIiArIGUgKyAiKSI7CiAgICAgICAgICAgIGRhKGUpOwogICAgICAgICAgICB3YSA9IHRydWU7CiAgICAgICAgICAgIGUgPSBuZXcgV2ViQXNzZW1ibHkuUnVudGltZUVycm9yKGUgKyAiLiBCdWlsZCB3aXRoIC1zQVNTRVJUSU9OUyBmb3IgbW9yZSBpbmZvLiIpOwogICAgICAgICAgICBrYShlKTsKICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHEoZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGlmIChlID09IFAgJiYgZmEpCiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoZmEpOwogICAgICAgICAgICAgIGlmIChtYSkKICAgICAgICAgICAgICAgIHJldHVybiBtYShlKTsKICAgICAgICAgICAgICB0aHJvdyAiYm90aCBhc3luYyBhbmQgc3luYyBmZXRjaGluZyBvZiB0aGUgd2FzbSBmYWlsZWQiOwogICAgICAgICAgICB9IGNhdGNoIChiKSB7CiAgICAgICAgICAgICAgZihiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdjMoKSB7CiAgICAgICAgICAgIGlmICghZmEgJiYgKHhhIHx8IGhhKSkgewogICAgICAgICAgICAgIGlmICgiZnVuY3Rpb24iID09IHR5cGVvZiBmZXRjaCAmJiAhUC5zdGFydHNXaXRoKCJmaWxlOi8vIikpCiAgICAgICAgICAgICAgICByZXR1cm4gZmV0Y2goUCwgeyBjcmVkZW50aWFsczogInNhbWUtb3JpZ2luIiB9KS50aGVuKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFlLm9rKQogICAgICAgICAgICAgICAgICAgIHRocm93ICJmYWlsZWQgdG8gbG9hZCB3YXNtIGJpbmFyeSBmaWxlIGF0ICciICsgUCArICInIjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGUuYXJyYXlCdWZmZXIoKTsKICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gcShQKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmIChuYSkKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihlLCBiKSB7CiAgICAgICAgICAgICAgICAgIG5hKFAsIGZ1bmN0aW9uKGMpIHsKICAgICAgICAgICAgICAgICAgICBlKG5ldyBVaW50OEFycmF5KGMpKTsKICAgICAgICAgICAgICAgICAgfSwgYik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gcShQKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB6KGUpIHsKICAgICAgICAgICAgZm9yICg7IDAgPCBlLmxlbmd0aDsgKQogICAgICAgICAgICAgIGUuc2hpZnQoKShhMyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBPKGUpIHsKICAgICAgICAgICAgdGhpcy5leGNQdHIgPSBlOwogICAgICAgICAgICB0aGlzLnB0ciA9IGUgLSAyNDsKICAgICAgICAgICAgdGhpcy5zZXRfdHlwZSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgICBWW3RoaXMucHRyICsgNCA+PiAyXSA9IGI7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuZ2V0X3R5cGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gVlt0aGlzLnB0ciArIDQgPj4gMl07CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuc2V0X2Rlc3RydWN0b3IgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgICAgVlt0aGlzLnB0ciArIDggPj4gMl0gPSBiOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmdldF9kZXN0cnVjdG9yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFZbdGhpcy5wdHIgKyA4ID4+IDJdOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLnNldF9yZWZjb3VudCA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgICBjYVt0aGlzLnB0ciA+PiAyXSA9IGI7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuc2V0X2NhdWdodCA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgICBZW3RoaXMucHRyICsgMTIgPj4gMF0gPSBiID8gMSA6IDA7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuZ2V0X2NhdWdodCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAwICE9IFlbdGhpcy5wdHIgKyAxMiA+PiAwXTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5zZXRfcmV0aHJvd24gPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgICAgWVt0aGlzLnB0ciArIDEzID4+IDBdID0gYiA/IDEgOiAwOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmdldF9yZXRocm93biA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAwICE9IFlbdGhpcy5wdHIgKyAxMyA+PiAwXTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5pbml0ID0gZnVuY3Rpb24oYiwgYykgewogICAgICAgICAgICAgIHRoaXMuc2V0X2FkanVzdGVkX3B0cigwKTsKICAgICAgICAgICAgICB0aGlzLnNldF90eXBlKGIpOwogICAgICAgICAgICAgIHRoaXMuc2V0X2Rlc3RydWN0b3IoYyk7CiAgICAgICAgICAgICAgdGhpcy5zZXRfcmVmY291bnQoMCk7CiAgICAgICAgICAgICAgdGhpcy5zZXRfY2F1Z2h0KGZhbHNlKTsKICAgICAgICAgICAgICB0aGlzLnNldF9yZXRocm93bihmYWxzZSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuYWRkX3JlZiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGNhW3RoaXMucHRyID4+IDJdICs9IDE7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMucmVsZWFzZV9yZWYgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB2YXIgYiA9IGNhW3RoaXMucHRyID4+IDJdOwogICAgICAgICAgICAgIGNhW3RoaXMucHRyID4+IDJdID0gYiAtIDE7CiAgICAgICAgICAgICAgcmV0dXJuIDEgPT09IGI7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuc2V0X2FkanVzdGVkX3B0ciA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgICBWW3RoaXMucHRyICsgMTYgPj4gMl0gPSBiOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmdldF9hZGp1c3RlZF9wdHIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gVlt0aGlzLnB0ciArIDE2ID4+IDJdOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmdldF9leGNlcHRpb25fcHRyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKHlhKHRoaXMuZ2V0X3R5cGUoKSkpCiAgICAgICAgICAgICAgICByZXR1cm4gVlt0aGlzLmV4Y1B0ciA+PiAyXTsKICAgICAgICAgICAgICB2YXIgYiA9IHRoaXMuZ2V0X2FkanVzdGVkX3B0cigpOwogICAgICAgICAgICAgIHJldHVybiAwICE9PSBiID8gYiA6IHRoaXMuZXhjUHRyOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gYmEoKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIGUoKSB7CiAgICAgICAgICAgICAgaWYgKCFsYSAmJiAobGEgPSB0cnVlLCBhMy5jYWxsZWRSdW4gPSB0cnVlLCAhd2EpKSB7CiAgICAgICAgICAgICAgICB6YSA9IHRydWU7CiAgICAgICAgICAgICAgICB6KG9hKTsKICAgICAgICAgICAgICAgIEFhKGEzKTsKICAgICAgICAgICAgICAgIGlmIChhMy5vblJ1bnRpbWVJbml0aWFsaXplZCkKICAgICAgICAgICAgICAgICAgYTMub25SdW50aW1lSW5pdGlhbGl6ZWQoKTsKICAgICAgICAgICAgICAgIGlmIChhMy5wb3N0UnVuKQogICAgICAgICAgICAgICAgICBmb3IgKCJmdW5jdGlvbiIgPT0gdHlwZW9mIGEzLnBvc3RSdW4gJiYgKGEzLnBvc3RSdW4gPSBbYTMucG9zdFJ1bl0pOyBhMy5wb3N0UnVuLmxlbmd0aDsgKQogICAgICAgICAgICAgICAgICAgIEJhLnVuc2hpZnQoYTMucG9zdFJ1bi5zaGlmdCgpKTsKICAgICAgICAgICAgICAgIHooQmEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoISgwIDwgYWEpKSB7CiAgICAgICAgICAgICAgaWYgKGEzLnByZVJ1bikKICAgICAgICAgICAgICAgIGZvciAoImZ1bmN0aW9uIiA9PSB0eXBlb2YgYTMucHJlUnVuICYmIChhMy5wcmVSdW4gPSBbYTMucHJlUnVuXSk7IGEzLnByZVJ1bi5sZW5ndGg7ICkKICAgICAgICAgICAgICAgICAgQ2EudW5zaGlmdChhMy5wcmVSdW4uc2hpZnQoKSk7CiAgICAgICAgICAgICAgeihDYSk7CiAgICAgICAgICAgICAgMCA8IGFhIHx8IChhMy5zZXRTdGF0dXMgPyAoYTMuc2V0U3RhdHVzKCJSdW5uaW5nLi4uIiksIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBhMy5zZXRTdGF0dXMoIiIpOwogICAgICAgICAgICAgICAgfSwgMSk7CiAgICAgICAgICAgICAgICBlKCk7CiAgICAgICAgICAgICAgfSwgMSkpIDogZSgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdCgpIHsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHgoZSkgewogICAgICAgICAgICByZXR1cm4gKGUgfHwgdCkuX19jYWNoZV9fOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gRChlLCBiKSB7CiAgICAgICAgICAgIHZhciBjID0geChiKSwgZCA9IGNbZV07CiAgICAgICAgICAgIGlmIChkKQogICAgICAgICAgICAgIHJldHVybiBkOwogICAgICAgICAgICBkID0gT2JqZWN0LmNyZWF0ZSgoYiB8fCB0KS5wcm90b3R5cGUpOwogICAgICAgICAgICBkLnB0ciA9IGU7CiAgICAgICAgICAgIHJldHVybiBjW2VdID0gZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFIoZSkgewogICAgICAgICAgICBpZiAoInN0cmluZyIgPT09IHR5cGVvZiBlKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgYiA9IDAsIGMgPSAwOyBjIDwgZS5sZW5ndGg7ICsrYykgewogICAgICAgICAgICAgICAgdmFyIGQgPSBlLmNoYXJDb2RlQXQoYyk7CiAgICAgICAgICAgICAgICAxMjcgPj0gZCA/IGIrKyA6IDIwNDcgPj0gZCA/IGIgKz0gMiA6IDU1Mjk2IDw9IGQgJiYgNTczNDMgPj0gZCA/IChiICs9IDQsICsrYykgOiBiICs9IDM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGIgPSBBcnJheShiICsgMSk7CiAgICAgICAgICAgICAgYyA9IDA7CiAgICAgICAgICAgICAgZCA9IGIubGVuZ3RoOwogICAgICAgICAgICAgIGlmICgwIDwgZCkgewogICAgICAgICAgICAgICAgZCA9IGMgKyBkIC0gMTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGcgPSAwOyBnIDwgZS5sZW5ndGg7ICsrZykgewogICAgICAgICAgICAgICAgICB2YXIgdTMgPSBlLmNoYXJDb2RlQXQoZyk7CiAgICAgICAgICAgICAgICAgIGlmICg1NTI5NiA8PSB1MyAmJiA1NzM0MyA+PSB1MykgewogICAgICAgICAgICAgICAgICAgIHZhciBYID0gZS5jaGFyQ29kZUF0KCsrZyk7CiAgICAgICAgICAgICAgICAgICAgdTMgPSA2NTUzNiArICgodTMgJiAxMDIzKSA8PCAxMCkgfCBYICYgMTAyMzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoMTI3ID49IHUzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGMgPj0gZCkKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGJbYysrXSA9IHUzOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICgyMDQ3ID49IHUzKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoYyArIDEgPj0gZCkKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICBiW2MrK10gPSAxOTIgfCB1MyA+PiA2OwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoNjU1MzUgPj0gdTMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGMgKyAyID49IGQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGJbYysrXSA9IDIyNCB8IHUzID4+IDEyOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGMgKyAzID49IGQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGJbYysrXSA9IDI0MCB8IHUzID4+IDE4OwogICAgICAgICAgICAgICAgICAgICAgICBiW2MrK10gPSAxMjggfCB1MyA+PiAxMiAmIDYzOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgYltjKytdID0gMTI4IHwgdTMgPj4gNiAmIDYzOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBiW2MrK10gPSAxMjggfCB1MyAmIDYzOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBiW2NdID0gMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZSA9IHIuYWxsb2MoYiwgWSk7CiAgICAgICAgICAgICAgci5jb3B5KGIsIFksIGUpOwogICAgICAgICAgICAgIHJldHVybiBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcGEoZSkgewogICAgICAgICAgICBpZiAoIm9iamVjdCIgPT09IHR5cGVvZiBlKSB7CiAgICAgICAgICAgICAgdmFyIGIgPSByLmFsbG9jKGUsIFkpOwogICAgICAgICAgICAgIHIuY29weShlLCBZLCBiKTsKICAgICAgICAgICAgICByZXR1cm4gYjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFooKSB7CiAgICAgICAgICAgIHRocm93ICJjYW5ub3QgY29uc3RydWN0IGEgVm9pZFB0ciwgbm8gY29uc3RydWN0b3IgaW4gSURMIjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFMoKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gRGEoKTsKICAgICAgICAgICAgeChTKVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gUSgpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBFYSgpOwogICAgICAgICAgICB4KFEpW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBXKCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IEZhKCk7CiAgICAgICAgICAgIHgoVylbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHcoKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gR2EoKTsKICAgICAgICAgICAgeCh3KVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gQygpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBIYSgpOwogICAgICAgICAgICB4KEMpW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBGKCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IElhKCk7CiAgICAgICAgICAgIHgoRilbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIEcoKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gSmEoKTsKICAgICAgICAgICAgeChHKVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gRSgpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBLYSgpOwogICAgICAgICAgICB4KEUpW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBUKCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IExhKCk7CiAgICAgICAgICAgIHgoVClbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIEIoKSB7CiAgICAgICAgICAgIHRocm93ICJjYW5ub3QgY29uc3RydWN0IGEgU3RhdHVzLCBubyBjb25zdHJ1Y3RvciBpbiBJREwiOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gSCgpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBNYSgpOwogICAgICAgICAgICB4KEgpW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBJKCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IE5hKCk7CiAgICAgICAgICAgIHgoSSlbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIEooKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gT2EoKTsKICAgICAgICAgICAgeChKKVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gSygpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBQYSgpOwogICAgICAgICAgICB4KEspW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBMKCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IFFhKCk7CiAgICAgICAgICAgIHgoTClbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIE0oKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gUmEoKTsKICAgICAgICAgICAgeChNKVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gTigpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBTYSgpOwogICAgICAgICAgICB4KE4pW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB5KCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IFRhKCk7CiAgICAgICAgICAgIHgoeSlbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG0oKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gVWEoKTsKICAgICAgICAgICAgeChtKVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgbiA9IHZvaWQgMCA9PT0gbiA/IHt9IDogbjsKICAgICAgICAgIHZhciBhMyA9ICJ1bmRlZmluZWQiICE9IHR5cGVvZiBuID8gbiA6IHt9LCBBYSwga2E7CiAgICAgICAgICBhMy5yZWFkeSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uKGUsIGIpIHsKICAgICAgICAgICAgQWEgPSBlOwogICAgICAgICAgICBrYSA9IGI7CiAgICAgICAgICB9KTsKICAgICAgICAgIHZhciBWYSA9IGZhbHNlLCBXYSA9IGZhbHNlOwogICAgICAgICAgYTMub25SdW50aW1lSW5pdGlhbGl6ZWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgVmEgPSB0cnVlOwogICAgICAgICAgICBpZiAoV2EgJiYgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIGEzLm9uTW9kdWxlTG9hZGVkKQogICAgICAgICAgICAgIGEzLm9uTW9kdWxlTG9hZGVkKGEzKTsKICAgICAgICAgIH07CiAgICAgICAgICBhMy5vbk1vZHVsZVBhcnNlZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBXYSA9IHRydWU7CiAgICAgICAgICAgIGlmIChWYSAmJiAiZnVuY3Rpb24iID09PSB0eXBlb2YgYTMub25Nb2R1bGVMb2FkZWQpCiAgICAgICAgICAgICAgYTMub25Nb2R1bGVMb2FkZWQoYTMpOwogICAgICAgICAgfTsKICAgICAgICAgIGEzLmlzVmVyc2lvblN1cHBvcnRlZCA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgaWYgKCJzdHJpbmciICE9PSB0eXBlb2YgZSkKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGUgPSBlLnNwbGl0KCIuIik7CiAgICAgICAgICAgIHJldHVybiAyID4gZS5sZW5ndGggfHwgMyA8IGUubGVuZ3RoID8gZmFsc2UgOiAxID09IGVbMF0gJiYgMCA8PSBlWzFdICYmIDUgPj0gZVsxXSA/IHRydWUgOiAwICE9IGVbMF0gfHwgMTAgPCBlWzFdID8gZmFsc2UgOiB0cnVlOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBYYSA9IE9iamVjdC5hc3NpZ24oe30sIGEzKSwgeGEgPSAib2JqZWN0IiA9PSB0eXBlb2Ygd2luZG93LCBoYSA9ICJmdW5jdGlvbiIgPT0gdHlwZW9mIGltcG9ydFNjcmlwdHMsIFlhID0gIm9iamVjdCIgPT0gdHlwZW9mIHByb2Nlc3MgJiYgIm9iamVjdCIgPT0gdHlwZW9mIHByb2Nlc3MudmVyc2lvbnMgJiYgInN0cmluZyIgPT0gdHlwZW9mIHByb2Nlc3MudmVyc2lvbnMubm9kZSwgVSA9ICIiOwogICAgICAgICAgaWYgKFlhKSB7CiAgICAgICAgICAgIHZhciBaYSA9IF9fcmVxdWlyZSgiZnMiKSwgcWEgPSBfX3JlcXVpcmUoInBhdGgiKTsKICAgICAgICAgICAgVSA9IGhhID8gcWEuZGlybmFtZShVKSArICIvIiA6IF9fZGlybmFtZSArICIvIjsKICAgICAgICAgICAgdmFyICRhID0gZnVuY3Rpb24oZSwgYikgewogICAgICAgICAgICAgIGUgPSBlLnN0YXJ0c1dpdGgoImZpbGU6Ly8iKSA/IG5ldyBVUkwoZSkgOiBxYS5ub3JtYWxpemUoZSk7CiAgICAgICAgICAgICAgcmV0dXJuIFphLnJlYWRGaWxlU3luYyhlLCBiID8gdm9pZCAwIDogInV0ZjgiKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIG1hID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgIGUgPSAkYShlLCB0cnVlKTsKICAgICAgICAgICAgICBlLmJ1ZmZlciB8fCAoZSA9IG5ldyBVaW50OEFycmF5KGUpKTsKICAgICAgICAgICAgICByZXR1cm4gZTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIG5hID0gZnVuY3Rpb24oZSwgYiwgYykgewogICAgICAgICAgICAgIGUgPSBlLnN0YXJ0c1dpdGgoImZpbGU6Ly8iKSA/IG5ldyBVUkwoZSkgOiBxYS5ub3JtYWxpemUoZSk7CiAgICAgICAgICAgICAgWmEucmVhZEZpbGUoZSwgZnVuY3Rpb24oZCwgZykgewogICAgICAgICAgICAgICAgZCA/IGMoZCkgOiBiKGcuYnVmZmVyKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgMSA8IHByb2Nlc3MuYXJndi5sZW5ndGggJiYgcHJvY2Vzcy5hcmd2WzFdLnJlcGxhY2UoL1xcL2csICIvIik7CiAgICAgICAgICAgIHByb2Nlc3MuYXJndi5zbGljZSgyKTsKICAgICAgICAgICAgYTMuaW5zcGVjdCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAiW0Vtc2NyaXB0ZW4gTW9kdWxlIG9iamVjdF0iOwogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIGlmICh4YSB8fCBoYSkKICAgICAgICAgICAgaGEgPyBVID0gc2VsZi5sb2NhdGlvbi5ocmVmIDogInVuZGVmaW5lZCIgIT0gdHlwZW9mIGRvY3VtZW50ICYmIGRvY3VtZW50LmN1cnJlbnRTY3JpcHQgJiYgKFUgPSBkb2N1bWVudC5jdXJyZW50U2NyaXB0LnNyYyksIGsgJiYgKFUgPSBrKSwgVSA9IDAgIT09IFUuaW5kZXhPZigiYmxvYjoiKSA/IFUuc3Vic3RyKDAsIFUucmVwbGFjZSgvWz8jXS4qLywgIiIpLmxhc3RJbmRleE9mKCIvIikgKyAxKSA6ICIiLCAkYSA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICB2YXIgYiA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgICAgICAgICAgIGIub3BlbigiR0VUIiwgZSwgZmFsc2UpOwogICAgICAgICAgICAgIGIuc2VuZChudWxsKTsKICAgICAgICAgICAgICByZXR1cm4gYi5yZXNwb25zZVRleHQ7CiAgICAgICAgICAgIH0sIGhhICYmIChtYSA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICB2YXIgYiA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgICAgICAgICAgIGIub3BlbigiR0VUIiwgZSwgZmFsc2UpOwogICAgICAgICAgICAgIGIucmVzcG9uc2VUeXBlID0gImFycmF5YnVmZmVyIjsKICAgICAgICAgICAgICBiLnNlbmQobnVsbCk7CiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KGIucmVzcG9uc2UpOwogICAgICAgICAgICB9KSwgbmEgPSBmdW5jdGlvbihlLCBiLCBjKSB7CiAgICAgICAgICAgICAgdmFyIGQgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgICAgICAgICAgICBkLm9wZW4oIkdFVCIsIGUsIHRydWUpOwogICAgICAgICAgICAgIGQucmVzcG9uc2VUeXBlID0gImFycmF5YnVmZmVyIjsKICAgICAgICAgICAgICBkLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgMjAwID09IGQuc3RhdHVzIHx8IDAgPT0gZC5zdGF0dXMgJiYgZC5yZXNwb25zZSA/IGIoZC5yZXNwb25zZSkgOiBjKCk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBkLm9uZXJyb3IgPSBjOwogICAgICAgICAgICAgIGQuc2VuZChudWxsKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIHZhciB1ZCA9IGEzLnByaW50IHx8IGNvbnNvbGUubG9nLmJpbmQoY29uc29sZSksIGRhID0gYTMucHJpbnRFcnIgfHwgY29uc29sZS53YXJuLmJpbmQoY29uc29sZSk7CiAgICAgICAgICBPYmplY3QuYXNzaWduKGEzLCBYYSk7CiAgICAgICAgICBYYSA9IG51bGw7CiAgICAgICAgICB2YXIgZmE7CiAgICAgICAgICBhMy53YXNtQmluYXJ5ICYmIChmYSA9IGEzLndhc21CaW5hcnkpOwogICAgICAgICAgIm9iamVjdCIgIT0gdHlwZW9mIFdlYkFzc2VtYmx5ICYmIGYoIm5vIG5hdGl2ZSB3YXNtIHN1cHBvcnQgZGV0ZWN0ZWQiKTsKICAgICAgICAgIHZhciBqYSwgd2EgPSBmYWxzZSwgdmEgPSAidW5kZWZpbmVkIiAhPSB0eXBlb2YgVGV4dERlY29kZXIgPyBuZXcgVGV4dERlY29kZXIoInV0ZjgiKSA6IHZvaWQgMCwgWSwgZWEsIGNhLCBWLCBDYSA9IFtdLCBvYSA9IFtdLCBCYSA9IFtdLCB6YSA9IGZhbHNlLCBhYSA9IDAsIHJhID0gbnVsbCwgaWEgPSBudWxsOwogICAgICAgICAgdmFyIFAgPSAiZHJhY29fZGVjb2Rlci53YXNtIjsKICAgICAgICAgIFAuc3RhcnRzV2l0aCgiZGF0YTphcHBsaWNhdGlvbi9vY3RldC1zdHJlYW07YmFzZTY0LCIpIHx8IChQID0gbChQKSk7CiAgICAgICAgICB2YXIgdmQgPSAwLCB3ZCA9IFtudWxsLCBbXSwgW11dLCB4ZCA9IHsgYjogZnVuY3Rpb24oZSwgYiwgYykgewogICAgICAgICAgICBuZXcgTyhlKS5pbml0KGIsIGMpOwogICAgICAgICAgICB2ZCsrOwogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgfSwgYTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGYoIiIpOwogICAgICAgICAgfSwgZzogZnVuY3Rpb24oZSwgYiwgYykgewogICAgICAgICAgICBlYS5jb3B5V2l0aGluKGUsIGIsIGIgKyBjKTsKICAgICAgICAgIH0sIGU6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdmFyIGIgPSBlYS5sZW5ndGg7CiAgICAgICAgICAgIGUgPj4+PSAwOwogICAgICAgICAgICBpZiAoMjE0NzQ4MzY0OCA8IGUpCiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBmb3IgKHZhciBjID0gMTsgNCA+PSBjOyBjICo9IDIpIHsKICAgICAgICAgICAgICB2YXIgZCA9IGIgKiAoMSArIDAuMiAvIGMpOwogICAgICAgICAgICAgIGQgPSBNYXRoLm1pbihkLCBlICsgMTAwNjYzMjk2KTsKICAgICAgICAgICAgICB2YXIgZyA9IE1hdGg7CiAgICAgICAgICAgICAgZCA9IE1hdGgubWF4KGUsIGQpOwogICAgICAgICAgICAgIGcgPSBnLm1pbi5jYWxsKGcsIDIxNDc0ODM2NDgsIGQgKyAoNjU1MzYgLSBkICUgNjU1MzYpICUgNjU1MzYpOwogICAgICAgICAgICAgIGE6IHsKICAgICAgICAgICAgICAgIGQgPSBqYS5idWZmZXI7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBqYS5ncm93KGcgLSBkLmJ5dGVMZW5ndGggKyA2NTUzNSA+Pj4gMTYpOwogICAgICAgICAgICAgICAgICBBKCk7CiAgICAgICAgICAgICAgICAgIHZhciB1MyA9IDE7CiAgICAgICAgICAgICAgICAgIGJyZWFrIGE7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChYKSB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB1MyA9IHZvaWQgMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHUzKQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSwgZjogZnVuY3Rpb24oZSkgewogICAgICAgICAgICByZXR1cm4gNTI7CiAgICAgICAgICB9LCBkOiBmdW5jdGlvbihlLCBiLCBjLCBkLCBnKSB7CiAgICAgICAgICAgIHJldHVybiA3MDsKICAgICAgICAgIH0sIGM6IGZ1bmN0aW9uKGUsIGIsIGMsIGQpIHsKICAgICAgICAgICAgZm9yICh2YXIgZyA9IDAsIHUzID0gMDsgdTMgPCBjOyB1MysrKSB7CiAgICAgICAgICAgICAgdmFyIFggPSBWW2IgPj4gMl0sIGFiID0gVltiICsgNCA+PiAyXTsKICAgICAgICAgICAgICBiICs9IDg7CiAgICAgICAgICAgICAgZm9yICh2YXIgc2EgPSAwOyBzYSA8IGFiOyBzYSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgdGEgPSBlYVtYICsgc2FdLCB1YSA9IHdkW2VdOwogICAgICAgICAgICAgICAgMCA9PT0gdGEgfHwgMTAgPT09IHRhID8gKCgxID09PSBlID8gdWQgOiBkYSkocCh1YSwgMCkpLCB1YS5sZW5ndGggPSAwKSA6IHVhLnB1c2godGEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBnICs9IGFiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIFZbZCA+PiAyXSA9IGc7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgfSB9OwogICAgICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmdW5jdGlvbiBlKGcsIHUzKSB7CiAgICAgICAgICAgICAgYTMuYXNtID0gZy5leHBvcnRzOwogICAgICAgICAgICAgIGphID0gYTMuYXNtLmg7CiAgICAgICAgICAgICAgQSgpOwogICAgICAgICAgICAgIG9hLnVuc2hpZnQoYTMuYXNtLmkpOwogICAgICAgICAgICAgIGFhLS07CiAgICAgICAgICAgICAgYTMubW9uaXRvclJ1bkRlcGVuZGVuY2llcyAmJiBhMy5tb25pdG9yUnVuRGVwZW5kZW5jaWVzKGFhKTsKICAgICAgICAgICAgICAwID09IGFhICYmIChudWxsICE9PSByYSAmJiAoY2xlYXJJbnRlcnZhbChyYSksIHJhID0gbnVsbCksIGlhICYmIChnID0gaWEsIGlhID0gbnVsbCwgZygpKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gYihnKSB7CiAgICAgICAgICAgICAgZShnLmluc3RhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBjKGcpIHsKICAgICAgICAgICAgICByZXR1cm4gdjMoKS50aGVuKGZ1bmN0aW9uKHUzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gV2ViQXNzZW1ibHkuaW5zdGFudGlhdGUodTMsIGQpOwogICAgICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24odTMpIHsKICAgICAgICAgICAgICAgIHJldHVybiB1MzsKICAgICAgICAgICAgICB9KS50aGVuKGcsIGZ1bmN0aW9uKHUzKSB7CiAgICAgICAgICAgICAgICBkYSgiZmFpbGVkIHRvIGFzeW5jaHJvbm91c2x5IHByZXBhcmUgd2FzbTogIiArIHUzKTsKICAgICAgICAgICAgICAgIGYodTMpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkID0geyBhOiB4ZCB9OwogICAgICAgICAgICBhYSsrOwogICAgICAgICAgICBhMy5tb25pdG9yUnVuRGVwZW5kZW5jaWVzICYmIGEzLm1vbml0b3JSdW5EZXBlbmRlbmNpZXMoYWEpOwogICAgICAgICAgICBpZiAoYTMuaW5zdGFudGlhdGVXYXNtKQogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYTMuaW5zdGFudGlhdGVXYXNtKGQsIGUpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGcpIHsKICAgICAgICAgICAgICAgIGRhKCJNb2R1bGUuaW5zdGFudGlhdGVXYXNtIGNhbGxiYWNrIGZhaWxlZCB3aXRoIGVycm9yOiAiICsgZyksIGthKGcpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBmYSB8fCAiZnVuY3Rpb24iICE9IHR5cGVvZiBXZWJBc3NlbWJseS5pbnN0YW50aWF0ZVN0cmVhbWluZyB8fCBQLnN0YXJ0c1dpdGgoImRhdGE6YXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtO2Jhc2U2NCwiKSB8fCBQLnN0YXJ0c1dpdGgoImZpbGU6Ly8iKSB8fCBZYSB8fCAiZnVuY3Rpb24iICE9IHR5cGVvZiBmZXRjaCA/IGMoYikgOiBmZXRjaChQLCB7IGNyZWRlbnRpYWxzOiAic2FtZS1vcmlnaW4iIH0pLnRoZW4oZnVuY3Rpb24oZykgewogICAgICAgICAgICAgICAgcmV0dXJuIFdlYkFzc2VtYmx5Lmluc3RhbnRpYXRlU3RyZWFtaW5nKGcsIGQpLnRoZW4oYiwgZnVuY3Rpb24odTMpIHsKICAgICAgICAgICAgICAgICAgZGEoIndhc20gc3RyZWFtaW5nIGNvbXBpbGUgZmFpbGVkOiAiICsgdTMpOwogICAgICAgICAgICAgICAgICBkYSgiZmFsbGluZyBiYWNrIHRvIEFycmF5QnVmZmVyIGluc3RhbnRpYXRpb24iKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGMoYik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkoKS5jYXRjaChrYSk7CiAgICAgICAgICAgIHJldHVybiB7fTsKICAgICAgICAgIH0pKCk7CiAgICAgICAgICB2YXIgYmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1ZvaWRQdHJfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGJiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Wb2lkUHRyX19fZGVzdHJveV9fXzAgPSBhMy5hc20uaykuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIERhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyQnVmZmVyX0RlY29kZXJCdWZmZXJfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKERhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyQnVmZmVyX0RlY29kZXJCdWZmZXJfMCA9IGEzLmFzbS5sKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgY2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJCdWZmZXJfSW5pdF8yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoY2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJCdWZmZXJfSW5pdF8yID0gYTMuYXNtLm0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBkYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2RlckJ1ZmZlcl9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoZGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJCdWZmZXJfX19kZXN0cm95X19fMCA9IGEzLmFzbS5uKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgRWEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVRyYW5zZm9ybURhdGFfQXR0cmlidXRlVHJhbnNmb3JtRGF0YV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoRWEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVRyYW5zZm9ybURhdGFfQXR0cmlidXRlVHJhbnNmb3JtRGF0YV8wID0gYTMuYXNtLm8pLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBlYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlVHJhbnNmb3JtRGF0YV90cmFuc2Zvcm1fdHlwZV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoZWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVRyYW5zZm9ybURhdGFfdHJhbnNmb3JtX3R5cGVfMCA9IGEzLmFzbS5wKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgZmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVRyYW5zZm9ybURhdGFfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGZiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVUcmFuc2Zvcm1EYXRhX19fZGVzdHJveV9fXzAgPSBhMy5hc20ucSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEZhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9HZW9tZXRyeUF0dHJpYnV0ZV9HZW9tZXRyeUF0dHJpYnV0ZV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoRmEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0dlb21ldHJ5QXR0cmlidXRlX0dlb21ldHJ5QXR0cmlidXRlXzAgPSBhMy5hc20ucikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGdiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9HZW9tZXRyeUF0dHJpYnV0ZV9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoZ2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0dlb21ldHJ5QXR0cmlidXRlX19fZGVzdHJveV9fXzAgPSBhMy5hc20ucykuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEdhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9Qb2ludEF0dHJpYnV0ZV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoR2EgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX1BvaW50QXR0cmlidXRlXzAgPSBhMy5hc20udCkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGhiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9zaXplXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChoYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfc2l6ZV8wID0gYTMuYXNtLnUpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBpYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfR2V0QXR0cmlidXRlVHJhbnNmb3JtRGF0YV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoaWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX0dldEF0dHJpYnV0ZVRyYW5zZm9ybURhdGFfMCA9IGEzLmFzbS52KS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgamIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX2F0dHJpYnV0ZV90eXBlXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChqYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfYXR0cmlidXRlX3R5cGVfMCA9IGEzLmFzbS53KS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwga2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX2RhdGFfdHlwZV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoa2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX2RhdGFfdHlwZV8wID0gYTMuYXNtLngpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBsYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfbnVtX2NvbXBvbmVudHNfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGxiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9udW1fY29tcG9uZW50c18wID0gYTMuYXNtLnkpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBtYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfbm9ybWFsaXplZF8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAobWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX25vcm1hbGl6ZWRfMCA9IGEzLmFzbS56KS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgbmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX2J5dGVfc3RyaWRlXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChuYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfYnl0ZV9zdHJpZGVfMCA9IGEzLmFzbS5BKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgb2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX2J5dGVfb2Zmc2V0XzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChvYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfYnl0ZV9vZmZzZXRfMCA9IGEzLmFzbS5CKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgcGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX3VuaXF1ZV9pZF8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAocGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX3VuaXF1ZV9pZF8wID0gYTMuYXNtLkMpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBxYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHFiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLkQpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBIYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtX0F0dHJpYnV0ZVF1YW50aXphdGlvblRyYW5zZm9ybV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoSGEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVF1YW50aXphdGlvblRyYW5zZm9ybV9BdHRyaWJ1dGVRdWFudGl6YXRpb25UcmFuc2Zvcm1fMCA9IGEzLmFzbS5FKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgcmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVF1YW50aXphdGlvblRyYW5zZm9ybV9Jbml0RnJvbUF0dHJpYnV0ZV8xID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAocmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVF1YW50aXphdGlvblRyYW5zZm9ybV9Jbml0RnJvbUF0dHJpYnV0ZV8xID0gYTMuYXNtLkYpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBzYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtX3F1YW50aXphdGlvbl9iaXRzXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChzYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtX3F1YW50aXphdGlvbl9iaXRzXzAgPSBhMy5hc20uRykuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHRiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVRdWFudGl6YXRpb25UcmFuc2Zvcm1fbWluX3ZhbHVlXzEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh0YiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtX21pbl92YWx1ZV8xID0gYTMuYXNtLkgpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCB1YiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtX3JhbmdlXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh1YiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtX3JhbmdlXzAgPSBhMy5hc20uSSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHZiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVRdWFudGl6YXRpb25UcmFuc2Zvcm1fX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHZiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVRdWFudGl6YXRpb25UcmFuc2Zvcm1fX19kZXN0cm95X19fMCA9IGEzLmFzbS5KKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgSWEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZU9jdGFoZWRyb25UcmFuc2Zvcm1fQXR0cmlidXRlT2N0YWhlZHJvblRyYW5zZm9ybV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoSWEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZU9jdGFoZWRyb25UcmFuc2Zvcm1fQXR0cmlidXRlT2N0YWhlZHJvblRyYW5zZm9ybV8wID0gYTMuYXNtLkspLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCB3YiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlT2N0YWhlZHJvblRyYW5zZm9ybV9Jbml0RnJvbUF0dHJpYnV0ZV8xID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAod2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZU9jdGFoZWRyb25UcmFuc2Zvcm1fSW5pdEZyb21BdHRyaWJ1dGVfMSA9IGEzLmFzbS5MKS5hcHBseSgKICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgIGFyZ3VtZW50cwogICAgICAgICAgICApOwogICAgICAgICAgfSwgeGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZU9jdGFoZWRyb25UcmFuc2Zvcm1fcXVhbnRpemF0aW9uX2JpdHNfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHhiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVPY3RhaGVkcm9uVHJhbnNmb3JtX3F1YW50aXphdGlvbl9iaXRzXzAgPSBhMy5hc20uTSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHliID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVPY3RhaGVkcm9uVHJhbnNmb3JtX19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh5YiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlT2N0YWhlZHJvblRyYW5zZm9ybV9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLk4pLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBKYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRDbG91ZF9Qb2ludENsb3VkXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChKYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRDbG91ZF9Qb2ludENsb3VkXzAgPSBhMy5hc20uTykuYXBwbHkoCiAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICBhcmd1bWVudHMKICAgICAgICAgICAgKTsKICAgICAgICAgIH0sIHpiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludENsb3VkX251bV9hdHRyaWJ1dGVzXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh6YiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRDbG91ZF9udW1fYXR0cmlidXRlc18wID0gYTMuYXNtLlApLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBBYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRDbG91ZF9udW1fcG9pbnRzXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChBYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRDbG91ZF9udW1fcG9pbnRzXzAgPSBhMy5hc20uUSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEJiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludENsb3VkX19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChCYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRDbG91ZF9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLlIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBLYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWVzaF9NZXNoXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChLYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWVzaF9NZXNoXzAgPSBhMy5hc20uUykuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIENiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXNoX251bV9mYWNlc18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoQ2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01lc2hfbnVtX2ZhY2VzXzAgPSBhMy5hc20uVCkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIERiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXNoX251bV9hdHRyaWJ1dGVzXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChEYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWVzaF9udW1fYXR0cmlidXRlc18wID0gYTMuYXNtLlUpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBFYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWVzaF9udW1fcG9pbnRzXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChFYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWVzaF9udW1fcG9pbnRzXzAgPSBhMy5hc20uVikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEZiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXNoX19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChGYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWVzaF9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLlcpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBMYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFfTWV0YWRhdGFfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKExhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YV9NZXRhZGF0YV8wID0gYTMuYXNtLlgpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBHYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEdiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YV9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLlkpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBIYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfU3RhdHVzX2NvZGVfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEhiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9TdGF0dXNfY29kZV8wID0gYTMuYXNtLlopLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBJYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfU3RhdHVzX29rXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChJYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfU3RhdHVzX29rXzAgPSBhMy5hc20uXykuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEpiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9TdGF0dXNfZXJyb3JfbXNnXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChKYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfU3RhdHVzX2Vycm9yX21zZ18wID0gYTMuYXNtLiQpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBLYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfU3RhdHVzX19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChLYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfU3RhdHVzX19fZGVzdHJveV9fXzAgPSBhMy5hc20uYWEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBNYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29GbG9hdDMyQXJyYXlfRHJhY29GbG9hdDMyQXJyYXlfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKE1hID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0Zsb2F0MzJBcnJheV9EcmFjb0Zsb2F0MzJBcnJheV8wID0gYTMuYXNtLmJhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgTGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvRmxvYXQzMkFycmF5X0dldFZhbHVlXzEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChMYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29GbG9hdDMyQXJyYXlfR2V0VmFsdWVfMSA9IGEzLmFzbS5jYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIE1iID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0Zsb2F0MzJBcnJheV9zaXplXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChNYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29GbG9hdDMyQXJyYXlfc2l6ZV8wID0gYTMuYXNtLmRhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgTmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvRmxvYXQzMkFycmF5X19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChOYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29GbG9hdDMyQXJyYXlfX19kZXN0cm95X19fMCA9IGEzLmFzbS5lYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIE5hID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDhBcnJheV9EcmFjb0ludDhBcnJheV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoTmEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50OEFycmF5X0RyYWNvSW50OEFycmF5XzAgPSBhMy5hc20uZmEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBPYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQ4QXJyYXlfR2V0VmFsdWVfMSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKE9iID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDhBcnJheV9HZXRWYWx1ZV8xID0gYTMuYXNtLmdhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgUGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50OEFycmF5X3NpemVfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFBiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDhBcnJheV9zaXplXzAgPSBhMy5hc20uaGEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBRYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQ4QXJyYXlfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFFiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDhBcnJheV9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLmlhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgT2EgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDhBcnJheV9EcmFjb1VJbnQ4QXJyYXlfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKE9hID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQ4QXJyYXlfRHJhY29VSW50OEFycmF5XzAgPSBhMy5hc20uamEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBSYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50OEFycmF5X0dldFZhbHVlXzEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChSYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50OEFycmF5X0dldFZhbHVlXzEgPSBhMy5hc20ua2EpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBTYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50OEFycmF5X3NpemVfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFNiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQ4QXJyYXlfc2l6ZV8wID0gYTMuYXNtLmxhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgVGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDhBcnJheV9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoVGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDhBcnJheV9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLm1hKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgUGEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50MTZBcnJheV9EcmFjb0ludDE2QXJyYXlfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFBhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDE2QXJyYXlfRHJhY29JbnQxNkFycmF5XzAgPSBhMy5hc20ubmEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBVYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQxNkFycmF5X0dldFZhbHVlXzEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChVYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQxNkFycmF5X0dldFZhbHVlXzEgPSBhMy5hc20ub2EpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBWYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQxNkFycmF5X3NpemVfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFZiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDE2QXJyYXlfc2l6ZV8wID0gYTMuYXNtLnBhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgV2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50MTZBcnJheV9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoV2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50MTZBcnJheV9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLnFhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgUWEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDE2QXJyYXlfRHJhY29VSW50MTZBcnJheV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoUWEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDE2QXJyYXlfRHJhY29VSW50MTZBcnJheV8wID0gYTMuYXNtLnJhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgWGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDE2QXJyYXlfR2V0VmFsdWVfMSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFhiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQxNkFycmF5X0dldFZhbHVlXzEgPSBhMy5hc20uc2EpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBZYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50MTZBcnJheV9zaXplXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChZYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50MTZBcnJheV9zaXplXzAgPSBhMy5hc20udGEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBaYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50MTZBcnJheV9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoWmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDE2QXJyYXlfX19kZXN0cm95X19fMCA9IGEzLmFzbS51YSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFJhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDMyQXJyYXlfRHJhY29JbnQzMkFycmF5XzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChSYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQzMkFycmF5X0RyYWNvSW50MzJBcnJheV8wID0gYTMuYXNtLnZhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgJGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50MzJBcnJheV9HZXRWYWx1ZV8xID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoJGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50MzJBcnJheV9HZXRWYWx1ZV8xID0gYTMuYXNtLndhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgYWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50MzJBcnJheV9zaXplXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChhYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQzMkFycmF5X3NpemVfMCA9IGEzLmFzbS54YSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGJjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDMyQXJyYXlfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGJjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDMyQXJyYXlfX19kZXN0cm95X19fMCA9IGEzLmFzbS55YSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFNhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQzMkFycmF5X0RyYWNvVUludDMyQXJyYXlfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFNhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQzMkFycmF5X0RyYWNvVUludDMyQXJyYXlfMCA9IGEzLmFzbS56YSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGNjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQzMkFycmF5X0dldFZhbHVlXzEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChjYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50MzJBcnJheV9HZXRWYWx1ZV8xID0gYTMuYXNtLkFhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgZGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDMyQXJyYXlfc2l6ZV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoZGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDMyQXJyYXlfc2l6ZV8wID0gYTMuYXNtLkJhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgZWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDMyQXJyYXlfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGVjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQzMkFycmF5X19fZGVzdHJveV9fXzAgPSBhMy5hc20uQ2EpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBUYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX01ldGFkYXRhUXVlcmllcl8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoVGEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhUXVlcmllcl9NZXRhZGF0YVF1ZXJpZXJfMCA9IGEzLmFzbS5EYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGZjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfSGFzRW50cnlfMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGZjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfSGFzRW50cnlfMiA9IGEzLmFzbS5FYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGdjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfR2V0SW50RW50cnlfMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGdjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfR2V0SW50RW50cnlfMiA9IGEzLmFzbS5GYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGhjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfR2V0SW50RW50cnlBcnJheV8zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoaGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhUXVlcmllcl9HZXRJbnRFbnRyeUFycmF5XzMgPSBhMy5hc20uR2EpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBpYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX0dldERvdWJsZUVudHJ5XzIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChpYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX0dldERvdWJsZUVudHJ5XzIgPSBhMy5hc20uSGEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBqYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX0dldFN0cmluZ0VudHJ5XzIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChqYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX0dldFN0cmluZ0VudHJ5XzIgPSBhMy5hc20uSWEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBrYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX051bUVudHJpZXNfMSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGtjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfTnVtRW50cmllc18xID0gYTMuYXNtLkphKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgbGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhUXVlcmllcl9HZXRFbnRyeU5hbWVfMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGxjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfR2V0RW50cnlOYW1lXzIgPSBhMy5hc20uS2EpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBtYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChtYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX19fZGVzdHJveV9fXzAgPSBhMy5hc20uTGEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBVYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9EZWNvZGVyXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChVYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9EZWNvZGVyXzAgPSBhMy5hc20uTWEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBuYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9EZWNvZGVBcnJheVRvUG9pbnRDbG91ZF8zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAobmMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfRGVjb2RlQXJyYXlUb1BvaW50Q2xvdWRfMyA9IGEzLmFzbS5OYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIG9jID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0RlY29kZUFycmF5VG9NZXNoXzMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChvYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9EZWNvZGVBcnJheVRvTWVzaF8zID0gYTMuYXNtLk9hKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgcGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlSWRfMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHBjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUlkXzIgPSBhMy5hc20uUGEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBxYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVJZEJ5TmFtZV8yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAocWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlSWRCeU5hbWVfMiA9IGEzLmFzbS5RYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHJjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUlkQnlNZXRhZGF0YUVudHJ5XzMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChyYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVJZEJ5TWV0YWRhdGFFbnRyeV8zID0gYTMuYXNtLlJhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgc2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlXzIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChzYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVfMiA9IGEzLmFzbS5TYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHRjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUJ5VW5pcXVlSWRfMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHRjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUJ5VW5pcXVlSWRfMiA9IGEzLmFzbS5UYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHVjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldE1ldGFkYXRhXzEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh1YyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRNZXRhZGF0YV8xID0gYTMuYXNtLlVhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgdmMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlTWV0YWRhdGFfMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHZjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZU1ldGFkYXRhXzIgPSBhMy5hc20uVmEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCB3YyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRGYWNlRnJvbU1lc2hfMyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHdjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEZhY2VGcm9tTWVzaF8zID0gYTMuYXNtLldhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgeGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0VHJpYW5nbGVTdHJpcHNGcm9tTWVzaF8yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoeGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0VHJpYW5nbGVTdHJpcHNGcm9tTWVzaF8yID0gYTMuYXNtLlhhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgeWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0VHJpYW5nbGVzVUludDE2QXJyYXlfMyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHljID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldFRyaWFuZ2xlc1VJbnQxNkFycmF5XzMgPSBhMy5hc20uWWEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCB6YyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRUcmlhbmdsZXNVSW50MzJBcnJheV8zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoemMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0VHJpYW5nbGVzVUludDMyQXJyYXlfMyA9IGEzLmFzbS5aYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEFjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUZsb2F0XzMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChBYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVGbG9hdF8zID0gYTMuYXNtLl9hKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgQmMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlRmxvYXRGb3JBbGxQb2ludHNfMyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEJjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUZsb2F0Rm9yQWxsUG9pbnRzXzMgPSBhMy5hc20uJGEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBDYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVJbnRGb3JBbGxQb2ludHNfMyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKENjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUludEZvckFsbFBvaW50c18zID0gYTMuYXNtLmFiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgRGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlSW50OEZvckFsbFBvaW50c18zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoRGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlSW50OEZvckFsbFBvaW50c18zID0gYTMuYXNtLmJiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgRWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlVUludDhGb3JBbGxQb2ludHNfMyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEVjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZVVJbnQ4Rm9yQWxsUG9pbnRzXzMgPSBhMy5hc20uY2IpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBGYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVJbnQxNkZvckFsbFBvaW50c18zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoRmMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlSW50MTZGb3JBbGxQb2ludHNfMyA9IGEzLmFzbS5kYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEdjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZVVJbnQxNkZvckFsbFBvaW50c18zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoR2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlVUludDE2Rm9yQWxsUG9pbnRzXzMgPSBhMy5hc20uZWIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBIYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVJbnQzMkZvckFsbFBvaW50c18zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoSGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlSW50MzJGb3JBbGxQb2ludHNfMyA9IGEzLmFzbS5mYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEljID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZVVJbnQzMkZvckFsbFBvaW50c18zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoSWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlVUludDMyRm9yQWxsUG9pbnRzXzMgPSBhMy5hc20uZ2IpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBKYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVEYXRhQXJyYXlGb3JBbGxQb2ludHNfNSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEpjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZURhdGFBcnJheUZvckFsbFBvaW50c181ID0gYTMuYXNtLmhiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgS2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfU2tpcEF0dHJpYnV0ZVRyYW5zZm9ybV8xID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoS2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfU2tpcEF0dHJpYnV0ZVRyYW5zZm9ybV8xID0gYTMuYXNtLmliKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgTGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0RW5jb2RlZEdlb21ldHJ5VHlwZV9EZXByZWNhdGVkXzEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChMYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRFbmNvZGVkR2VvbWV0cnlUeXBlX0RlcHJlY2F0ZWRfMSA9IGEzLmFzbS5qYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIE1jID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0RlY29kZUJ1ZmZlclRvUG9pbnRDbG91ZF8yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoTWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfRGVjb2RlQnVmZmVyVG9Qb2ludENsb3VkXzIgPSBhMy5hc20ua2IpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBOYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9EZWNvZGVCdWZmZXJUb01lc2hfMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKE5jID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0RlY29kZUJ1ZmZlclRvTWVzaF8yID0gYTMuYXNtLmxiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgT2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKE9jID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX19fZGVzdHJveV9fXzAgPSBhMy5hc20ubWIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBQYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fQXR0cmlidXRlVHJhbnNmb3JtVHlwZV9BVFRSSUJVVEVfSU5WQUxJRF9UUkFOU0ZPUk0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChQYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fQXR0cmlidXRlVHJhbnNmb3JtVHlwZV9BVFRSSUJVVEVfSU5WQUxJRF9UUkFOU0ZPUk0gPSBhMy5hc20ubmIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBRYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fQXR0cmlidXRlVHJhbnNmb3JtVHlwZV9BVFRSSUJVVEVfTk9fVFJBTlNGT1JNID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoUWMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0F0dHJpYnV0ZVRyYW5zZm9ybVR5cGVfQVRUUklCVVRFX05PX1RSQU5TRk9STSA9IGEzLmFzbS5vYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFJjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19BdHRyaWJ1dGVUcmFuc2Zvcm1UeXBlX0FUVFJJQlVURV9RVUFOVElaQVRJT05fVFJBTlNGT1JNID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoUmMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0F0dHJpYnV0ZVRyYW5zZm9ybVR5cGVfQVRUUklCVVRFX1FVQU5USVpBVElPTl9UUkFOU0ZPUk0gPSBhMy5hc20ucGIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBTYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fQXR0cmlidXRlVHJhbnNmb3JtVHlwZV9BVFRSSUJVVEVfT0NUQUhFRFJPTl9UUkFOU0ZPUk0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChTYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fQXR0cmlidXRlVHJhbnNmb3JtVHlwZV9BVFRSSUJVVEVfT0NUQUhFRFJPTl9UUkFOU0ZPUk0gPSBhMy5hc20ucWIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBUYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fR2VvbWV0cnlBdHRyaWJ1dGVfVHlwZV9JTlZBTElEID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoVGMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0dlb21ldHJ5QXR0cmlidXRlX1R5cGVfSU5WQUxJRCA9IGEzLmFzbS5yYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFVjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19HZW9tZXRyeUF0dHJpYnV0ZV9UeXBlX1BPU0lUSU9OID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoVWMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0dlb21ldHJ5QXR0cmlidXRlX1R5cGVfUE9TSVRJT04gPSBhMy5hc20uc2IpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBWYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fR2VvbWV0cnlBdHRyaWJ1dGVfVHlwZV9OT1JNQUwgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChWYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fR2VvbWV0cnlBdHRyaWJ1dGVfVHlwZV9OT1JNQUwgPSBhMy5hc20udGIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBXYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fR2VvbWV0cnlBdHRyaWJ1dGVfVHlwZV9DT0xPUiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFdjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19HZW9tZXRyeUF0dHJpYnV0ZV9UeXBlX0NPTE9SID0gYTMuYXNtLnViKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgWGMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0dlb21ldHJ5QXR0cmlidXRlX1R5cGVfVEVYX0NPT1JEID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoWGMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0dlb21ldHJ5QXR0cmlidXRlX1R5cGVfVEVYX0NPT1JEID0gYTMuYXNtLnZiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgWWMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0dlb21ldHJ5QXR0cmlidXRlX1R5cGVfR0VORVJJQyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFljID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19HZW9tZXRyeUF0dHJpYnV0ZV9UeXBlX0dFTkVSSUMgPSBhMy5hc20ud2IpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBaYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRW5jb2RlZEdlb21ldHJ5VHlwZV9JTlZBTElEX0dFT01FVFJZX1RZUEUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChaYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRW5jb2RlZEdlb21ldHJ5VHlwZV9JTlZBTElEX0dFT01FVFJZX1RZUEUgPSBhMy5hc20ueGIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCAkYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRW5jb2RlZEdlb21ldHJ5VHlwZV9QT0lOVF9DTE9VRCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKCRjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19FbmNvZGVkR2VvbWV0cnlUeXBlX1BPSU5UX0NMT1VEID0gYTMuYXNtLnliKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgYWQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0VuY29kZWRHZW9tZXRyeVR5cGVfVFJJQU5HVUxBUl9NRVNIID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoYWQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0VuY29kZWRHZW9tZXRyeVR5cGVfVFJJQU5HVUxBUl9NRVNIID0gYTMuYXNtLnpiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgYmQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX0lOVkFMSUQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChiZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfSU5WQUxJRCA9IGEzLmFzbS5BYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGNkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9JTlQ4ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoY2QgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX0lOVDggPSBhMy5hc20uQmIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBkZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfVUlOVDggPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChkZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfVUlOVDggPSBhMy5hc20uQ2IpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBlZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfSU5UMTYgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChlZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfSU5UMTYgPSBhMy5hc20uRGIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBmZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfVUlOVDE2ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoZmQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX1VJTlQxNiA9IGEzLmFzbS5FYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGdkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9JTlQzMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGdkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9JTlQzMiA9IGEzLmFzbS5GYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGhkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9VSU5UMzIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChoZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfVUlOVDMyID0gYTMuYXNtLkdiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgaWQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX0lOVDY0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoaWQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX0lOVDY0ID0gYTMuYXNtLkhiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgamQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX1VJTlQ2NCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGpkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9VSU5UNjQgPSBhMy5hc20uSWIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBrZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfRkxPQVQzMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGtkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9GTE9BVDMyID0gYTMuYXNtLkpiKS5hcHBseSgKICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgIGFyZ3VtZW50cwogICAgICAgICAgICApOwogICAgICAgICAgfSwgbGQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX0ZMT0FUNjQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChsZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfRkxPQVQ2NCA9IGEzLmFzbS5LYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIG1kID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9CT09MID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAobWQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX0JPT0wgPSBhMy5hc20uTGIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBuZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfVFlQRVNfQ09VTlQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChuZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfVFlQRVNfQ09VTlQgPSBhMy5hc20uTWIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBvZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fU3RhdHVzQ29kZV9PSyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKG9kID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19TdGF0dXNDb2RlX09LID0gYTMuYXNtLk5iKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgcGQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX1N0YXR1c0NvZGVfRFJBQ09fRVJST1IgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChwZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fU3RhdHVzQ29kZV9EUkFDT19FUlJPUiA9IGEzLmFzbS5PYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHFkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19TdGF0dXNDb2RlX0lPX0VSUk9SID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAocWQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX1N0YXR1c0NvZGVfSU9fRVJST1IgPSBhMy5hc20uUGIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCByZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fU3RhdHVzQ29kZV9JTlZBTElEX1BBUkFNRVRFUiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHJkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19TdGF0dXNDb2RlX0lOVkFMSURfUEFSQU1FVEVSID0gYTMuYXNtLlFiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgc2QgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX1N0YXR1c0NvZGVfVU5TVVBQT1JURURfVkVSU0lPTiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHNkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19TdGF0dXNDb2RlX1VOU1VQUE9SVEVEX1ZFUlNJT04gPSBhMy5hc20uUmIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCB0ZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fU3RhdHVzQ29kZV9VTktOT1dOX1ZFUlNJT04gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh0ZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fU3RhdHVzQ29kZV9VTktOT1dOX1ZFUlNJT04gPSBhMy5hc20uU2IpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9OwogICAgICAgICAgYTMuX21hbGxvYyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGEzLl9tYWxsb2MgPSBhMy5hc20uVGIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9OwogICAgICAgICAgYTMuX2ZyZWUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChhMy5fZnJlZSA9IGEzLmFzbS5VYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgeWEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh5YSA9IGEzLmFzbS5WYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH07CiAgICAgICAgICBhMy5fX19zdGFydF9lbV9qcyA9IDE1ODU2OwogICAgICAgICAgYTMuX19fc3RvcF9lbV9qcyA9IDE1OTU0OwogICAgICAgICAgdmFyIGxhOwogICAgICAgICAgaWEgPSBmdW5jdGlvbiBiKCkgewogICAgICAgICAgICBsYSB8fCBiYSgpOwogICAgICAgICAgICBsYSB8fCAoaWEgPSBiKTsKICAgICAgICAgIH07CiAgICAgICAgICBpZiAoYTMucHJlSW5pdCkKICAgICAgICAgICAgZm9yICgiZnVuY3Rpb24iID09IHR5cGVvZiBhMy5wcmVJbml0ICYmIChhMy5wcmVJbml0ID0gW2EzLnByZUluaXRdKTsgMCA8IGEzLnByZUluaXQubGVuZ3RoOyApCiAgICAgICAgICAgICAgYTMucHJlSW5pdC5wb3AoKSgpOwogICAgICAgICAgYmEoKTsKICAgICAgICAgIHQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICB0LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IHQ7CiAgICAgICAgICB0LnByb3RvdHlwZS5fX2NsYXNzX18gPSB0OwogICAgICAgICAgdC5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLldyYXBwZXJPYmplY3QgPSB0OwogICAgICAgICAgYTMuZ2V0Q2FjaGUgPSB4OwogICAgICAgICAgYTMud3JhcFBvaW50ZXIgPSBEOwogICAgICAgICAgYTMuY2FzdE9iamVjdCA9IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgcmV0dXJuIEQoYi5wdHIsIGMpOwogICAgICAgICAgfTsKICAgICAgICAgIGEzLk5VTEwgPSBEKDApOwogICAgICAgICAgYTMuZGVzdHJveSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgaWYgKCFiLl9fZGVzdHJveV9fKQogICAgICAgICAgICAgIHRocm93ICJFcnJvcjogQ2Fubm90IGRlc3Ryb3kgb2JqZWN0LiAoRGlkIHlvdSBjcmVhdGUgaXQgeW91cnNlbGY/KSI7CiAgICAgICAgICAgIGIuX19kZXN0cm95X18oKTsKICAgICAgICAgICAgZGVsZXRlIHgoYi5fX2NsYXNzX18pW2IucHRyXTsKICAgICAgICAgIH07CiAgICAgICAgICBhMy5jb21wYXJlID0gZnVuY3Rpb24oYiwgYykgewogICAgICAgICAgICByZXR1cm4gYi5wdHIgPT09IGMucHRyOwogICAgICAgICAgfTsKICAgICAgICAgIGEzLmdldFBvaW50ZXIgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHJldHVybiBiLnB0cjsKICAgICAgICAgIH07CiAgICAgICAgICBhMy5nZXRDbGFzcyA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgcmV0dXJuIGIuX19jbGFzc19fOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciByID0geyBidWZmZXI6IDAsIHNpemU6IDAsIHBvczogMCwgdGVtcHM6IFtdLCBuZWVkZWQ6IDAsIHByZXBhcmU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoci5uZWVkZWQpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBiID0gMDsgYiA8IHIudGVtcHMubGVuZ3RoOyBiKyspCiAgICAgICAgICAgICAgICBhMy5fZnJlZShyLnRlbXBzW2JdKTsKICAgICAgICAgICAgICByLnRlbXBzLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgYTMuX2ZyZWUoci5idWZmZXIpOwogICAgICAgICAgICAgIHIuYnVmZmVyID0gMDsKICAgICAgICAgICAgICByLnNpemUgKz0gci5uZWVkZWQ7CiAgICAgICAgICAgICAgci5uZWVkZWQgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHIuYnVmZmVyIHx8IChyLnNpemUgKz0gMTI4LCByLmJ1ZmZlciA9IGEzLl9tYWxsb2Moci5zaXplKSwgci5idWZmZXIgfHwgZih2b2lkIDApKTsKICAgICAgICAgICAgci5wb3MgPSAwOwogICAgICAgICAgfSwgYWxsb2M6IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgci5idWZmZXIgfHwgZih2b2lkIDApOwogICAgICAgICAgICBiID0gYi5sZW5ndGggKiBjLkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICAgICAgICBiID0gYiArIDcgJiAtODsKICAgICAgICAgICAgci5wb3MgKyBiID49IHIuc2l6ZSA/ICgwIDwgYiB8fCBmKHZvaWQgMCksIHIubmVlZGVkICs9IGIsIGMgPSBhMy5fbWFsbG9jKGIpLCByLnRlbXBzLnB1c2goYykpIDogKGMgPSByLmJ1ZmZlciArIHIucG9zLCByLnBvcyArPSBiKTsKICAgICAgICAgICAgcmV0dXJuIGM7CiAgICAgICAgICB9LCBjb3B5OiBmdW5jdGlvbihiLCBjLCBkKSB7CiAgICAgICAgICAgIGQgPj4+PSAwOwogICAgICAgICAgICBzd2l0Y2ggKGMuQllURVNfUEVSX0VMRU1FTlQpIHsKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICBkID4+Pj0gMTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgIGQgPj4+PSAyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgICAgZCA+Pj49IDM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgZyA9IDA7IGcgPCBiLmxlbmd0aDsgZysrKQogICAgICAgICAgICAgIGNbZCArIGddID0gYltnXTsKICAgICAgICAgIH0gfTsKICAgICAgICAgIFoucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBaLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFo7CiAgICAgICAgICBaLnByb3RvdHlwZS5fX2NsYXNzX18gPSBaOwogICAgICAgICAgWi5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLlZvaWRQdHIgPSBaOwogICAgICAgICAgWi5wcm90b3R5cGUuX19kZXN0cm95X18gPSBaLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBiYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgUy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIFMucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUzsKICAgICAgICAgIFMucHJvdG90eXBlLl9fY2xhc3NfXyA9IFM7CiAgICAgICAgICBTLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuRGVjb2RlckJ1ZmZlciA9IFM7CiAgICAgICAgICBTLnByb3RvdHlwZS5Jbml0ID0gUy5wcm90b3R5cGUuSW5pdCA9IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSB0aGlzLnB0cjsKICAgICAgICAgICAgci5wcmVwYXJlKCk7CiAgICAgICAgICAgICJvYmplY3QiID09IHR5cGVvZiBiICYmIChiID0gcGEoYikpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgY2IoZCwgYiwgYyk7CiAgICAgICAgICB9OwogICAgICAgICAgUy5wcm90b3R5cGUuX19kZXN0cm95X18gPSBTLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBkYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgUS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIFEucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUTsKICAgICAgICAgIFEucHJvdG90eXBlLl9fY2xhc3NfXyA9IFE7CiAgICAgICAgICBRLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuQXR0cmlidXRlVHJhbnNmb3JtRGF0YSA9IFE7CiAgICAgICAgICBRLnByb3RvdHlwZS50cmFuc2Zvcm1fdHlwZSA9IFEucHJvdG90eXBlLnRyYW5zZm9ybV90eXBlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBlYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgUS5wcm90b3R5cGUuX19kZXN0cm95X18gPSBRLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgVy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIFcucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVzsKICAgICAgICAgIFcucHJvdG90eXBlLl9fY2xhc3NfXyA9IFc7CiAgICAgICAgICBXLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuR2VvbWV0cnlBdHRyaWJ1dGUgPSBXOwogICAgICAgICAgVy5wcm90b3R5cGUuX19kZXN0cm95X18gPSBXLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBnYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgdy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIHcucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gdzsKICAgICAgICAgIHcucHJvdG90eXBlLl9fY2xhc3NfXyA9IHc7CiAgICAgICAgICB3Ll9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuUG9pbnRBdHRyaWJ1dGUgPSB3OwogICAgICAgICAgdy5wcm90b3R5cGUuc2l6ZSA9IHcucHJvdG90eXBlLnNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGhiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICB3LnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVUcmFuc2Zvcm1EYXRhID0gdy5wcm90b3R5cGUuR2V0QXR0cmlidXRlVHJhbnNmb3JtRGF0YSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gRChpYih0aGlzLnB0ciksIFEpOwogICAgICAgICAgfTsKICAgICAgICAgIHcucHJvdG90eXBlLmF0dHJpYnV0ZV90eXBlID0gdy5wcm90b3R5cGUuYXR0cmlidXRlX3R5cGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGpiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICB3LnByb3RvdHlwZS5kYXRhX3R5cGUgPSB3LnByb3RvdHlwZS5kYXRhX3R5cGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGtiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICB3LnByb3RvdHlwZS5udW1fY29tcG9uZW50cyA9IHcucHJvdG90eXBlLm51bV9jb21wb25lbnRzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBsYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgdy5wcm90b3R5cGUubm9ybWFsaXplZCA9IHcucHJvdG90eXBlLm5vcm1hbGl6ZWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICEhbWIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIHcucHJvdG90eXBlLmJ5dGVfc3RyaWRlID0gdy5wcm90b3R5cGUuYnl0ZV9zdHJpZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIG5iKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICB3LnByb3RvdHlwZS5ieXRlX29mZnNldCA9IHcucHJvdG90eXBlLmJ5dGVfb2Zmc2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBvYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgdy5wcm90b3R5cGUudW5pcXVlX2lkID0gdy5wcm90b3R5cGUudW5pcXVlX2lkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBwYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgdy5wcm90b3R5cGUuX19kZXN0cm95X18gPSB3LnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBxYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgQy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIEMucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQzsKICAgICAgICAgIEMucHJvdG90eXBlLl9fY2xhc3NfXyA9IEM7CiAgICAgICAgICBDLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtID0gQzsKICAgICAgICAgIEMucHJvdG90eXBlLkluaXRGcm9tQXR0cmlidXRlID0gQy5wcm90b3R5cGUuSW5pdEZyb21BdHRyaWJ1dGUgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHZhciBjID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICByZXR1cm4gISFyYihjLCBiKTsKICAgICAgICAgIH07CiAgICAgICAgICBDLnByb3RvdHlwZS5xdWFudGl6YXRpb25fYml0cyA9IEMucHJvdG90eXBlLnF1YW50aXphdGlvbl9iaXRzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBzYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgQy5wcm90b3R5cGUubWluX3ZhbHVlID0gQy5wcm90b3R5cGUubWluX3ZhbHVlID0gZnVuY3Rpb24oYikgewogICAgICAgICAgICB2YXIgYyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgcmV0dXJuIHRiKGMsIGIpOwogICAgICAgICAgfTsKICAgICAgICAgIEMucHJvdG90eXBlLnJhbmdlID0gQy5wcm90b3R5cGUucmFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHViKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBDLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IEMucHJvdG90eXBlLl9fZGVzdHJveV9fID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBGLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUodC5wcm90b3R5cGUpOwogICAgICAgICAgRi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBGOwogICAgICAgICAgRi5wcm90b3R5cGUuX19jbGFzc19fID0gRjsKICAgICAgICAgIEYuX19jYWNoZV9fID0ge307CiAgICAgICAgICBhMy5BdHRyaWJ1dGVPY3RhaGVkcm9uVHJhbnNmb3JtID0gRjsKICAgICAgICAgIEYucHJvdG90eXBlLkluaXRGcm9tQXR0cmlidXRlID0gRi5wcm90b3R5cGUuSW5pdEZyb21BdHRyaWJ1dGUgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHZhciBjID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICByZXR1cm4gISF3YihjLCBiKTsKICAgICAgICAgIH07CiAgICAgICAgICBGLnByb3RvdHlwZS5xdWFudGl6YXRpb25fYml0cyA9IEYucHJvdG90eXBlLnF1YW50aXphdGlvbl9iaXRzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB4Yih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgRi5wcm90b3R5cGUuX19kZXN0cm95X18gPSBGLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB5Yih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgRy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIEcucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRzsKICAgICAgICAgIEcucHJvdG90eXBlLl9fY2xhc3NfXyA9IEc7CiAgICAgICAgICBHLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuUG9pbnRDbG91ZCA9IEc7CiAgICAgICAgICBHLnByb3RvdHlwZS5udW1fYXR0cmlidXRlcyA9IEcucHJvdG90eXBlLm51bV9hdHRyaWJ1dGVzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB6Yih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgRy5wcm90b3R5cGUubnVtX3BvaW50cyA9IEcucHJvdG90eXBlLm51bV9wb2ludHMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBHLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IEcucHJvdG90eXBlLl9fZGVzdHJveV9fID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIEJiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBFLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUodC5wcm90b3R5cGUpOwogICAgICAgICAgRS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBFOwogICAgICAgICAgRS5wcm90b3R5cGUuX19jbGFzc19fID0gRTsKICAgICAgICAgIEUuX19jYWNoZV9fID0ge307CiAgICAgICAgICBhMy5NZXNoID0gRTsKICAgICAgICAgIEUucHJvdG90eXBlLm51bV9mYWNlcyA9IEUucHJvdG90eXBlLm51bV9mYWNlcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQ2IodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEUucHJvdG90eXBlLm51bV9hdHRyaWJ1dGVzID0gRS5wcm90b3R5cGUubnVtX2F0dHJpYnV0ZXMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIERiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBFLnByb3RvdHlwZS5udW1fcG9pbnRzID0gRS5wcm90b3R5cGUubnVtX3BvaW50cyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gRWIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEUucHJvdG90eXBlLl9fZGVzdHJveV9fID0gRS5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgRmIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIFQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBULnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFQ7CiAgICAgICAgICBULnByb3RvdHlwZS5fX2NsYXNzX18gPSBUOwogICAgICAgICAgVC5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLk1ldGFkYXRhID0gVDsKICAgICAgICAgIFQucHJvdG90eXBlLl9fZGVzdHJveV9fID0gVC5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgR2IodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBCLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEI7CiAgICAgICAgICBCLnByb3RvdHlwZS5fX2NsYXNzX18gPSBCOwogICAgICAgICAgQi5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLlN0YXR1cyA9IEI7CiAgICAgICAgICBCLnByb3RvdHlwZS5jb2RlID0gQi5wcm90b3R5cGUuY29kZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gSGIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEIucHJvdG90eXBlLm9rID0gQi5wcm90b3R5cGUub2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICEhSWIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEIucHJvdG90eXBlLmVycm9yX21zZyA9IEIucHJvdG90eXBlLmVycm9yX21zZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gaChKYih0aGlzLnB0cikpOwogICAgICAgICAgfTsKICAgICAgICAgIEIucHJvdG90eXBlLl9fZGVzdHJveV9fID0gQi5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgS2IodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEgucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBILnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEg7CiAgICAgICAgICBILnByb3RvdHlwZS5fX2NsYXNzX18gPSBIOwogICAgICAgICAgSC5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLkRyYWNvRmxvYXQzMkFycmF5ID0gSDsKICAgICAgICAgIEgucHJvdG90eXBlLkdldFZhbHVlID0gSC5wcm90b3R5cGUuR2V0VmFsdWUgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHZhciBjID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICByZXR1cm4gTGIoYywgYik7CiAgICAgICAgICB9OwogICAgICAgICAgSC5wcm90b3R5cGUuc2l6ZSA9IEgucHJvdG90eXBlLnNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIE1iKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBILnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IEgucHJvdG90eXBlLl9fZGVzdHJveV9fID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIE5iKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBJLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUodC5wcm90b3R5cGUpOwogICAgICAgICAgSS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBJOwogICAgICAgICAgSS5wcm90b3R5cGUuX19jbGFzc19fID0gSTsKICAgICAgICAgIEkuX19jYWNoZV9fID0ge307CiAgICAgICAgICBhMy5EcmFjb0ludDhBcnJheSA9IEk7CiAgICAgICAgICBJLnByb3RvdHlwZS5HZXRWYWx1ZSA9IEkucHJvdG90eXBlLkdldFZhbHVlID0gZnVuY3Rpb24oYikgewogICAgICAgICAgICB2YXIgYyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgcmV0dXJuIE9iKGMsIGIpOwogICAgICAgICAgfTsKICAgICAgICAgIEkucHJvdG90eXBlLnNpemUgPSBJLnByb3RvdHlwZS5zaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBQYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgSS5wcm90b3R5cGUuX19kZXN0cm95X18gPSBJLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBRYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgSi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIEoucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gSjsKICAgICAgICAgIEoucHJvdG90eXBlLl9fY2xhc3NfXyA9IEo7CiAgICAgICAgICBKLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuRHJhY29VSW50OEFycmF5ID0gSjsKICAgICAgICAgIEoucHJvdG90eXBlLkdldFZhbHVlID0gSi5wcm90b3R5cGUuR2V0VmFsdWUgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHZhciBjID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICByZXR1cm4gUmIoYywgYik7CiAgICAgICAgICB9OwogICAgICAgICAgSi5wcm90b3R5cGUuc2l6ZSA9IEoucHJvdG90eXBlLnNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIFNiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBKLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IEoucHJvdG90eXBlLl9fZGVzdHJveV9fID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIFRiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBLLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUodC5wcm90b3R5cGUpOwogICAgICAgICAgSy5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBLOwogICAgICAgICAgSy5wcm90b3R5cGUuX19jbGFzc19fID0gSzsKICAgICAgICAgIEsuX19jYWNoZV9fID0ge307CiAgICAgICAgICBhMy5EcmFjb0ludDE2QXJyYXkgPSBLOwogICAgICAgICAgSy5wcm90b3R5cGUuR2V0VmFsdWUgPSBLLnByb3RvdHlwZS5HZXRWYWx1ZSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgdmFyIGMgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIHJldHVybiBVYihjLCBiKTsKICAgICAgICAgIH07CiAgICAgICAgICBLLnByb3RvdHlwZS5zaXplID0gSy5wcm90b3R5cGUuc2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gVmIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEsucHJvdG90eXBlLl9fZGVzdHJveV9fID0gSy5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgV2IodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEwucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBMLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEw7CiAgICAgICAgICBMLnByb3RvdHlwZS5fX2NsYXNzX18gPSBMOwogICAgICAgICAgTC5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLkRyYWNvVUludDE2QXJyYXkgPSBMOwogICAgICAgICAgTC5wcm90b3R5cGUuR2V0VmFsdWUgPSBMLnByb3RvdHlwZS5HZXRWYWx1ZSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgdmFyIGMgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIHJldHVybiBYYihjLCBiKTsKICAgICAgICAgIH07CiAgICAgICAgICBMLnByb3RvdHlwZS5zaXplID0gTC5wcm90b3R5cGUuc2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gWWIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEwucHJvdG90eXBlLl9fZGVzdHJveV9fID0gTC5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgWmIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIE0ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBNLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IE07CiAgICAgICAgICBNLnByb3RvdHlwZS5fX2NsYXNzX18gPSBNOwogICAgICAgICAgTS5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLkRyYWNvSW50MzJBcnJheSA9IE07CiAgICAgICAgICBNLnByb3RvdHlwZS5HZXRWYWx1ZSA9IE0ucHJvdG90eXBlLkdldFZhbHVlID0gZnVuY3Rpb24oYikgewogICAgICAgICAgICB2YXIgYyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgcmV0dXJuICRiKGMsIGIpOwogICAgICAgICAgfTsKICAgICAgICAgIE0ucHJvdG90eXBlLnNpemUgPSBNLnByb3RvdHlwZS5zaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBhYyh0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgTS5wcm90b3R5cGUuX19kZXN0cm95X18gPSBNLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBiYyh0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgTi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIE4ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gTjsKICAgICAgICAgIE4ucHJvdG90eXBlLl9fY2xhc3NfXyA9IE47CiAgICAgICAgICBOLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuRHJhY29VSW50MzJBcnJheSA9IE47CiAgICAgICAgICBOLnByb3RvdHlwZS5HZXRWYWx1ZSA9IE4ucHJvdG90eXBlLkdldFZhbHVlID0gZnVuY3Rpb24oYikgewogICAgICAgICAgICB2YXIgYyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgcmV0dXJuIGNjKGMsIGIpOwogICAgICAgICAgfTsKICAgICAgICAgIE4ucHJvdG90eXBlLnNpemUgPSBOLnByb3RvdHlwZS5zaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBkYyh0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgTi5wcm90b3R5cGUuX19kZXN0cm95X18gPSBOLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlYyh0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgeS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIHkucHJvdG90eXBlLmNvbnN0cnVjdG9yID0geTsKICAgICAgICAgIHkucHJvdG90eXBlLl9fY2xhc3NfXyA9IHk7CiAgICAgICAgICB5Ll9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuTWV0YWRhdGFRdWVyaWVyID0geTsKICAgICAgICAgIHkucHJvdG90eXBlLkhhc0VudHJ5ID0geS5wcm90b3R5cGUuSGFzRW50cnkgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIHIucHJlcGFyZSgpOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyA9IGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjID8gYy5wdHIgOiBSKGMpOwogICAgICAgICAgICByZXR1cm4gISFmYyhkLCBiLCBjKTsKICAgICAgICAgIH07CiAgICAgICAgICB5LnByb3RvdHlwZS5HZXRJbnRFbnRyeSA9IHkucHJvdG90eXBlLkdldEludEVudHJ5ID0gZnVuY3Rpb24oYiwgYykgewogICAgICAgICAgICB2YXIgZCA9IHRoaXMucHRyOwogICAgICAgICAgICByLnByZXBhcmUoKTsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgPSBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyA/IGMucHRyIDogUihjKTsKICAgICAgICAgICAgcmV0dXJuIGdjKGQsIGIsIGMpOwogICAgICAgICAgfTsKICAgICAgICAgIHkucHJvdG90eXBlLkdldEludEVudHJ5QXJyYXkgPSB5LnByb3RvdHlwZS5HZXRJbnRFbnRyeUFycmF5ID0gZnVuY3Rpb24oYiwgYywgZCkgewogICAgICAgICAgICB2YXIgZyA9IHRoaXMucHRyOwogICAgICAgICAgICByLnByZXBhcmUoKTsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgPSBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyA/IGMucHRyIDogUihjKTsKICAgICAgICAgICAgZCAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGQgJiYgKGQgPSBkLnB0cik7CiAgICAgICAgICAgIGhjKGcsIGIsIGMsIGQpOwogICAgICAgICAgfTsKICAgICAgICAgIHkucHJvdG90eXBlLkdldERvdWJsZUVudHJ5ID0geS5wcm90b3R5cGUuR2V0RG91YmxlRW50cnkgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIHIucHJlcGFyZSgpOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyA9IGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjID8gYy5wdHIgOiBSKGMpOwogICAgICAgICAgICByZXR1cm4gaWMoZCwgYiwgYyk7CiAgICAgICAgICB9OwogICAgICAgICAgeS5wcm90b3R5cGUuR2V0U3RyaW5nRW50cnkgPSB5LnByb3RvdHlwZS5HZXRTdHJpbmdFbnRyeSA9IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSB0aGlzLnB0cjsKICAgICAgICAgICAgci5wcmVwYXJlKCk7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjID0gYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgPyBjLnB0ciA6IFIoYyk7CiAgICAgICAgICAgIHJldHVybiBoKGpjKGQsIGIsIGMpKTsKICAgICAgICAgIH07CiAgICAgICAgICB5LnByb3RvdHlwZS5OdW1FbnRyaWVzID0geS5wcm90b3R5cGUuTnVtRW50cmllcyA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgdmFyIGMgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIHJldHVybiBrYyhjLCBiKTsKICAgICAgICAgIH07CiAgICAgICAgICB5LnByb3RvdHlwZS5HZXRFbnRyeU5hbWUgPSB5LnByb3RvdHlwZS5HZXRFbnRyeU5hbWUgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgcmV0dXJuIGgobGMoZCwgYiwgYykpOwogICAgICAgICAgfTsKICAgICAgICAgIHkucHJvdG90eXBlLl9fZGVzdHJveV9fID0geS5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgbWModGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBtLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IG07CiAgICAgICAgICBtLnByb3RvdHlwZS5fX2NsYXNzX18gPSBtOwogICAgICAgICAgbS5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLkRlY29kZXIgPSBtOwogICAgICAgICAgbS5wcm90b3R5cGUuRGVjb2RlQXJyYXlUb1BvaW50Q2xvdWQgPSBtLnByb3RvdHlwZS5EZWNvZGVBcnJheVRvUG9pbnRDbG91ZCA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgci5wcmVwYXJlKCk7CiAgICAgICAgICAgICJvYmplY3QiID09IHR5cGVvZiBiICYmIChiID0gcGEoYikpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgZCAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGQgJiYgKGQgPSBkLnB0cik7CiAgICAgICAgICAgIHJldHVybiBEKG5jKGcsIGIsIGMsIGQpLCBCKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5EZWNvZGVBcnJheVRvTWVzaCA9IG0ucHJvdG90eXBlLkRlY29kZUFycmF5VG9NZXNoID0gZnVuY3Rpb24oYiwgYywgZCkgewogICAgICAgICAgICB2YXIgZyA9IHRoaXMucHRyOwogICAgICAgICAgICByLnByZXBhcmUoKTsKICAgICAgICAgICAgIm9iamVjdCIgPT0gdHlwZW9mIGIgJiYgKGIgPSBwYShiKSk7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuIEQob2MoZywgYiwgYywgZCksIEIpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZUlkID0gbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSWQgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgcmV0dXJuIHBjKGQsIGIsIGMpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZUlkQnlOYW1lID0gbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSWRCeU5hbWUgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIHIucHJlcGFyZSgpOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyA9IGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjID8gYy5wdHIgOiBSKGMpOwogICAgICAgICAgICByZXR1cm4gcWMoZCwgYiwgYyk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSWRCeU1ldGFkYXRhRW50cnkgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVJZEJ5TWV0YWRhdGFFbnRyeSA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgci5wcmVwYXJlKCk7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjID0gYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgPyBjLnB0ciA6IFIoYyk7CiAgICAgICAgICAgIGQgPSBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCA/IGQucHRyIDogUihkKTsKICAgICAgICAgICAgcmV0dXJuIHJjKGcsIGIsIGMsIGQpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZSA9IG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICByZXR1cm4gRChzYyhkLCBiLCBjKSwgdyk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlQnlVbmlxdWVJZCA9IG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZUJ5VW5pcXVlSWQgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgcmV0dXJuIEQodGMoZCwgYiwgYyksIHcpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldE1ldGFkYXRhID0gbS5wcm90b3R5cGUuR2V0TWV0YWRhdGEgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHZhciBjID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICByZXR1cm4gRCh1YyhjLCBiKSwgVCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlTWV0YWRhdGEgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVNZXRhZGF0YSA9IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICByZXR1cm4gRCh2YyhkLCBiLCBjKSwgVCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0RmFjZUZyb21NZXNoID0gbS5wcm90b3R5cGUuR2V0RmFjZUZyb21NZXNoID0gZnVuY3Rpb24oYiwgYywgZCkgewogICAgICAgICAgICB2YXIgZyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgJiYgKGMgPSBjLnB0cik7CiAgICAgICAgICAgIGQgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBkICYmIChkID0gZC5wdHIpOwogICAgICAgICAgICByZXR1cm4gISF3YyhnLCBiLCBjLCBkKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5HZXRUcmlhbmdsZVN0cmlwc0Zyb21NZXNoID0gbS5wcm90b3R5cGUuR2V0VHJpYW5nbGVTdHJpcHNGcm9tTWVzaCA9IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICByZXR1cm4geGMoZCwgYiwgYyk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0VHJpYW5nbGVzVUludDE2QXJyYXkgPSBtLnByb3RvdHlwZS5HZXRUcmlhbmdsZXNVSW50MTZBcnJheSA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEheWMoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0VHJpYW5nbGVzVUludDMyQXJyYXkgPSBtLnByb3RvdHlwZS5HZXRUcmlhbmdsZXNVSW50MzJBcnJheSA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhemMoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlRmxvYXQgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVGbG9hdCA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhQWMoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlRmxvYXRGb3JBbGxQb2ludHMgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVGbG9hdEZvckFsbFBvaW50cyA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhQmMoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSW50Rm9yQWxsUG9pbnRzID0gbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSW50Rm9yQWxsUG9pbnRzID0gZnVuY3Rpb24oYiwgYywgZCkgewogICAgICAgICAgICB2YXIgZyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgJiYgKGMgPSBjLnB0cik7CiAgICAgICAgICAgIGQgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBkICYmIChkID0gZC5wdHIpOwogICAgICAgICAgICByZXR1cm4gISFDYyhnLCBiLCBjLCBkKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVJbnQ4Rm9yQWxsUG9pbnRzID0gbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSW50OEZvckFsbFBvaW50cyA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhRGMoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlVUludDhGb3JBbGxQb2ludHMgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVVSW50OEZvckFsbFBvaW50cyA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhRWMoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSW50MTZGb3JBbGxQb2ludHMgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVJbnQxNkZvckFsbFBvaW50cyA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhRmMoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlVUludDE2Rm9yQWxsUG9pbnRzID0gbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlVUludDE2Rm9yQWxsUG9pbnRzID0gZnVuY3Rpb24oYiwgYywgZCkgewogICAgICAgICAgICB2YXIgZyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgJiYgKGMgPSBjLnB0cik7CiAgICAgICAgICAgIGQgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBkICYmIChkID0gZC5wdHIpOwogICAgICAgICAgICByZXR1cm4gISFHYyhnLCBiLCBjLCBkKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVJbnQzMkZvckFsbFBvaW50cyA9IG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZUludDMyRm9yQWxsUG9pbnRzID0gZnVuY3Rpb24oYiwgYywgZCkgewogICAgICAgICAgICB2YXIgZyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgJiYgKGMgPSBjLnB0cik7CiAgICAgICAgICAgIGQgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBkICYmIChkID0gZC5wdHIpOwogICAgICAgICAgICByZXR1cm4gISFIYyhnLCBiLCBjLCBkKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVVSW50MzJGb3JBbGxQb2ludHMgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVVSW50MzJGb3JBbGxQb2ludHMgPSBmdW5jdGlvbihiLCBjLCBkKSB7CiAgICAgICAgICAgIHZhciBnID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgZCAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGQgJiYgKGQgPSBkLnB0cik7CiAgICAgICAgICAgIHJldHVybiAhIUljKGcsIGIsIGMsIGQpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZURhdGFBcnJheUZvckFsbFBvaW50cyA9IG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZURhdGFBcnJheUZvckFsbFBvaW50cyA9IGZ1bmN0aW9uKGIsIGMsIGQsIGcsIHUzKSB7CiAgICAgICAgICAgIHZhciBYID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgZCAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGQgJiYgKGQgPSBkLnB0cik7CiAgICAgICAgICAgIGcgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBnICYmIChnID0gZy5wdHIpOwogICAgICAgICAgICB1MyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIHUzICYmICh1MyA9IHUzLnB0cik7CiAgICAgICAgICAgIHJldHVybiAhIUpjKFgsIGIsIGMsIGQsIGcsIHUzKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5Ta2lwQXR0cmlidXRlVHJhbnNmb3JtID0gbS5wcm90b3R5cGUuU2tpcEF0dHJpYnV0ZVRyYW5zZm9ybSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgdmFyIGMgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIEtjKGMsIGIpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEVuY29kZWRHZW9tZXRyeVR5cGVfRGVwcmVjYXRlZCA9IG0ucHJvdG90eXBlLkdldEVuY29kZWRHZW9tZXRyeVR5cGVfRGVwcmVjYXRlZCA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgdmFyIGMgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIHJldHVybiBMYyhjLCBiKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5EZWNvZGVCdWZmZXJUb1BvaW50Q2xvdWQgPSBtLnByb3RvdHlwZS5EZWNvZGVCdWZmZXJUb1BvaW50Q2xvdWQgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgcmV0dXJuIEQoTWMoZCwgYiwgYyksIEIpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkRlY29kZUJ1ZmZlclRvTWVzaCA9IG0ucHJvdG90eXBlLkRlY29kZUJ1ZmZlclRvTWVzaCA9IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICByZXR1cm4gRChOYyhkLCBiLCBjKSwgQik7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuX19kZXN0cm95X18gPSBtLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBPYyh0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmdW5jdGlvbiBiKCkgewogICAgICAgICAgICAgIGEzLkFUVFJJQlVURV9JTlZBTElEX1RSQU5TRk9STSA9IFBjKCk7CiAgICAgICAgICAgICAgYTMuQVRUUklCVVRFX05PX1RSQU5TRk9STSA9IFFjKCk7CiAgICAgICAgICAgICAgYTMuQVRUUklCVVRFX1FVQU5USVpBVElPTl9UUkFOU0ZPUk0gPSBSYygpOwogICAgICAgICAgICAgIGEzLkFUVFJJQlVURV9PQ1RBSEVEUk9OX1RSQU5TRk9STSA9IFNjKCk7CiAgICAgICAgICAgICAgYTMuSU5WQUxJRCA9IFRjKCk7CiAgICAgICAgICAgICAgYTMuUE9TSVRJT04gPSBVYygpOwogICAgICAgICAgICAgIGEzLk5PUk1BTCA9IFZjKCk7CiAgICAgICAgICAgICAgYTMuQ09MT1IgPSBXYygpOwogICAgICAgICAgICAgIGEzLlRFWF9DT09SRCA9IFhjKCk7CiAgICAgICAgICAgICAgYTMuR0VORVJJQyA9IFljKCk7CiAgICAgICAgICAgICAgYTMuSU5WQUxJRF9HRU9NRVRSWV9UWVBFID0gWmMoKTsKICAgICAgICAgICAgICBhMy5QT0lOVF9DTE9VRCA9ICRjKCk7CiAgICAgICAgICAgICAgYTMuVFJJQU5HVUxBUl9NRVNIID0gYWQoKTsKICAgICAgICAgICAgICBhMy5EVF9JTlZBTElEID0gYmQoKTsKICAgICAgICAgICAgICBhMy5EVF9JTlQ4ID0gY2QoKTsKICAgICAgICAgICAgICBhMy5EVF9VSU5UOCA9IGRkKCk7CiAgICAgICAgICAgICAgYTMuRFRfSU5UMTYgPSBlZCgpOwogICAgICAgICAgICAgIGEzLkRUX1VJTlQxNiA9IGZkKCk7CiAgICAgICAgICAgICAgYTMuRFRfSU5UMzIgPSBnZCgpOwogICAgICAgICAgICAgIGEzLkRUX1VJTlQzMiA9IGhkKCk7CiAgICAgICAgICAgICAgYTMuRFRfSU5UNjQgPSBpZCgpOwogICAgICAgICAgICAgIGEzLkRUX1VJTlQ2NCA9IGpkKCk7CiAgICAgICAgICAgICAgYTMuRFRfRkxPQVQzMiA9IGtkKCk7CiAgICAgICAgICAgICAgYTMuRFRfRkxPQVQ2NCA9IGxkKCk7CiAgICAgICAgICAgICAgYTMuRFRfQk9PTCA9IG1kKCk7CiAgICAgICAgICAgICAgYTMuRFRfVFlQRVNfQ09VTlQgPSBuZCgpOwogICAgICAgICAgICAgIGEzLk9LID0gb2QoKTsKICAgICAgICAgICAgICBhMy5EUkFDT19FUlJPUiA9IHBkKCk7CiAgICAgICAgICAgICAgYTMuSU9fRVJST1IgPSBxZCgpOwogICAgICAgICAgICAgIGEzLklOVkFMSURfUEFSQU1FVEVSID0gcmQoKTsKICAgICAgICAgICAgICBhMy5VTlNVUFBPUlRFRF9WRVJTSU9OID0gc2QoKTsKICAgICAgICAgICAgICBhMy5VTktOT1dOX1ZFUlNJT04gPSB0ZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHphID8gYigpIDogb2EudW5zaGlmdChiKTsKICAgICAgICAgIH0pKCk7CiAgICAgICAgICBpZiAoImZ1bmN0aW9uIiA9PT0gdHlwZW9mIGEzLm9uTW9kdWxlUGFyc2VkKQogICAgICAgICAgICBhMy5vbk1vZHVsZVBhcnNlZCgpOwogICAgICAgICAgYTMuRGVjb2Rlci5wcm90b3R5cGUuR2V0RW5jb2RlZEdlb21ldHJ5VHlwZSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgaWYgKGIuX19jbGFzc19fICYmIGIuX19jbGFzc19fID09PSBhMy5EZWNvZGVyQnVmZmVyKQogICAgICAgICAgICAgIHJldHVybiBhMy5EZWNvZGVyLnByb3RvdHlwZS5HZXRFbmNvZGVkR2VvbWV0cnlUeXBlX0RlcHJlY2F0ZWQoYik7CiAgICAgICAgICAgIGlmICg4ID4gYi5ieXRlTGVuZ3RoKQogICAgICAgICAgICAgIHJldHVybiBhMy5JTlZBTElEX0dFT01FVFJZX1RZUEU7CiAgICAgICAgICAgIHN3aXRjaCAoYls3XSkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIHJldHVybiBhMy5QT0lOVF9DTE9VRDsKICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICByZXR1cm4gYTMuVFJJQU5HVUxBUl9NRVNIOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gYTMuSU5WQUxJRF9HRU9NRVRSWV9UWVBFOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIG4ucmVhZHk7CiAgICAgICAgfTsKICAgICAgfSgpOwogICAgICAib2JqZWN0IiA9PT0gdHlwZW9mIGV4cG9ydHMyICYmICJvYmplY3QiID09PSB0eXBlb2YgbW9kdWxlID8gbW9kdWxlLmV4cG9ydHMgPSBEcmFjb0RlY29kZXJNb2R1bGUgOiAiZnVuY3Rpb24iID09PSB0eXBlb2YgZGVmaW5lICYmIGRlZmluZS5hbWQgPyBkZWZpbmUoW10sIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBEcmFjb0RlY29kZXJNb2R1bGU7CiAgICAgIH0pIDogIm9iamVjdCIgPT09IHR5cGVvZiBleHBvcnRzMiAmJiAoZXhwb3J0czIuRHJhY29EZWNvZGVyTW9kdWxlID0gRHJhY29EZWNvZGVyTW9kdWxlKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2RlY29kZURyYWNvLmpzCiAgdmFyIGRlY29kZURyYWNvX2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChkZWNvZGVEcmFjb19leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBkZWNvZGVEcmFjb19kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gZGVjb2RlSW5kZXhBcnJheShkcmFjb0dlb21ldHJ5LCBkcmFjb0RlY29kZXIpIHsKICAgIGNvbnN0IG51bVBvaW50cyA9IGRyYWNvR2VvbWV0cnkubnVtX3BvaW50cygpOwogICAgY29uc3QgbnVtRmFjZXMgPSBkcmFjb0dlb21ldHJ5Lm51bV9mYWNlcygpOwogICAgY29uc3QgZmFjZUluZGljZXMgPSBuZXcgZHJhY28uRHJhY29JbnQzMkFycmF5KCk7CiAgICBjb25zdCBudW1JbmRpY2VzID0gbnVtRmFjZXMgKiAzOwogICAgY29uc3QgaW5kZXhBcnJheSA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KG51bVBvaW50cywgbnVtSW5kaWNlcyk7CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtRmFjZXM7ICsraSkgewogICAgICBkcmFjb0RlY29kZXIuR2V0RmFjZUZyb21NZXNoKGRyYWNvR2VvbWV0cnksIGksIGZhY2VJbmRpY2VzKTsKICAgICAgaW5kZXhBcnJheVtvZmZzZXQgKyAwXSA9IGZhY2VJbmRpY2VzLkdldFZhbHVlKDApOwogICAgICBpbmRleEFycmF5W29mZnNldCArIDFdID0gZmFjZUluZGljZXMuR2V0VmFsdWUoMSk7CiAgICAgIGluZGV4QXJyYXlbb2Zmc2V0ICsgMl0gPSBmYWNlSW5kaWNlcy5HZXRWYWx1ZSgyKTsKICAgICAgb2Zmc2V0ICs9IDM7CiAgICB9CiAgICBkcmFjby5kZXN0cm95KGZhY2VJbmRpY2VzKTsKICAgIHJldHVybiB7CiAgICAgIHR5cGVkQXJyYXk6IGluZGV4QXJyYXksCiAgICAgIG51bWJlck9mSW5kaWNlczogbnVtSW5kaWNlcwogICAgfTsKICB9CiAgZnVuY3Rpb24gZGVjb2RlUXVhbnRpemVkRHJhY29UeXBlZEFycmF5KGRyYWNvR2VvbWV0cnksIGRyYWNvRGVjb2RlciwgZHJhY29BdHRyaWJ1dGUsIHF1YW50aXphdGlvbiwgdmVydGV4QXJyYXlMZW5ndGgpIHsKICAgIGxldCB2ZXJ0ZXhBcnJheTsKICAgIGxldCBhdHRyaWJ1dGVEYXRhOwogICAgaWYgKHF1YW50aXphdGlvbi5xdWFudGl6YXRpb25CaXRzIDw9IDgpIHsKICAgICAgYXR0cmlidXRlRGF0YSA9IG5ldyBkcmFjby5EcmFjb1VJbnQ4QXJyYXkoKTsKICAgICAgdmVydGV4QXJyYXkgPSBuZXcgVWludDhBcnJheSh2ZXJ0ZXhBcnJheUxlbmd0aCk7CiAgICAgIGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGVVSW50OEZvckFsbFBvaW50cygKICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgIGF0dHJpYnV0ZURhdGEKICAgICAgKTsKICAgIH0gZWxzZSBpZiAocXVhbnRpemF0aW9uLnF1YW50aXphdGlvbkJpdHMgPD0gMTYpIHsKICAgICAgYXR0cmlidXRlRGF0YSA9IG5ldyBkcmFjby5EcmFjb1VJbnQxNkFycmF5KCk7CiAgICAgIHZlcnRleEFycmF5ID0gbmV3IFVpbnQxNkFycmF5KHZlcnRleEFycmF5TGVuZ3RoKTsKICAgICAgZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZVVJbnQxNkZvckFsbFBvaW50cygKICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgIGF0dHJpYnV0ZURhdGEKICAgICAgKTsKICAgIH0gZWxzZSB7CiAgICAgIGF0dHJpYnV0ZURhdGEgPSBuZXcgZHJhY28uRHJhY29GbG9hdDMyQXJyYXkoKTsKICAgICAgdmVydGV4QXJyYXkgPSBuZXcgRmxvYXQzMkFycmF5KHZlcnRleEFycmF5TGVuZ3RoKTsKICAgICAgZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUZsb2F0Rm9yQWxsUG9pbnRzKAogICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgYXR0cmlidXRlRGF0YQogICAgICApOwogICAgfQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2ZXJ0ZXhBcnJheUxlbmd0aDsgKytpKSB7CiAgICAgIHZlcnRleEFycmF5W2ldID0gYXR0cmlidXRlRGF0YS5HZXRWYWx1ZShpKTsKICAgIH0KICAgIGRyYWNvLmRlc3Ryb3koYXR0cmlidXRlRGF0YSk7CiAgICByZXR1cm4gdmVydGV4QXJyYXk7CiAgfQogIGZ1bmN0aW9uIGRlY29kZURyYWNvVHlwZWRBcnJheShkcmFjb0dlb21ldHJ5LCBkcmFjb0RlY29kZXIsIGRyYWNvQXR0cmlidXRlLCB2ZXJ0ZXhBcnJheUxlbmd0aCkgewogICAgbGV0IHZlcnRleEFycmF5OwogICAgbGV0IGF0dHJpYnV0ZURhdGE7CiAgICBzd2l0Y2ggKGRyYWNvQXR0cmlidXRlLmRhdGFfdHlwZSgpKSB7CiAgICAgIGNhc2UgMToKICAgICAgY2FzZSAxMToKICAgICAgICBhdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvLkRyYWNvSW50OEFycmF5KCk7CiAgICAgICAgdmVydGV4QXJyYXkgPSBuZXcgSW50OEFycmF5KHZlcnRleEFycmF5TGVuZ3RoKTsKICAgICAgICBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlSW50OEZvckFsbFBvaW50cygKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICAgIGF0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDI6CiAgICAgICAgYXR0cmlidXRlRGF0YSA9IG5ldyBkcmFjby5EcmFjb1VJbnQ4QXJyYXkoKTsKICAgICAgICB2ZXJ0ZXhBcnJheSA9IG5ldyBVaW50OEFycmF5KHZlcnRleEFycmF5TGVuZ3RoKTsKICAgICAgICBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlVUludDhGb3JBbGxQb2ludHMoCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgICBhdHRyaWJ1dGVEYXRhCiAgICAgICAgKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAzOgogICAgICAgIGF0dHJpYnV0ZURhdGEgPSBuZXcgZHJhY28uRHJhY29JbnQxNkFycmF5KCk7CiAgICAgICAgdmVydGV4QXJyYXkgPSBuZXcgSW50MTZBcnJheSh2ZXJ0ZXhBcnJheUxlbmd0aCk7CiAgICAgICAgZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUludDE2Rm9yQWxsUG9pbnRzKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgYXR0cmlidXRlRGF0YQogICAgICAgICk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgNDoKICAgICAgICBhdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvLkRyYWNvVUludDE2QXJyYXkoKTsKICAgICAgICB2ZXJ0ZXhBcnJheSA9IG5ldyBVaW50MTZBcnJheSh2ZXJ0ZXhBcnJheUxlbmd0aCk7CiAgICAgICAgZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZVVJbnQxNkZvckFsbFBvaW50cygKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICAgIGF0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDU6CiAgICAgIGNhc2UgNzoKICAgICAgICBhdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvLkRyYWNvSW50MzJBcnJheSgpOwogICAgICAgIHZlcnRleEFycmF5ID0gbmV3IEludDMyQXJyYXkodmVydGV4QXJyYXlMZW5ndGgpOwogICAgICAgIGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGVJbnQzMkZvckFsbFBvaW50cygKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICAgIGF0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDY6CiAgICAgIGNhc2UgODoKICAgICAgICBhdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvLkRyYWNvVUludDMyQXJyYXkoKTsKICAgICAgICB2ZXJ0ZXhBcnJheSA9IG5ldyBVaW50MzJBcnJheSh2ZXJ0ZXhBcnJheUxlbmd0aCk7CiAgICAgICAgZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZVVJbnQzMkZvckFsbFBvaW50cygKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICAgIGF0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDk6CiAgICAgIGNhc2UgMTA6CiAgICAgICAgYXR0cmlidXRlRGF0YSA9IG5ldyBkcmFjby5EcmFjb0Zsb2F0MzJBcnJheSgpOwogICAgICAgIHZlcnRleEFycmF5ID0gbmV3IEZsb2F0MzJBcnJheSh2ZXJ0ZXhBcnJheUxlbmd0aCk7CiAgICAgICAgZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUZsb2F0Rm9yQWxsUG9pbnRzKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgYXR0cmlidXRlRGF0YQogICAgICAgICk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZlcnRleEFycmF5TGVuZ3RoOyArK2kpIHsKICAgICAgdmVydGV4QXJyYXlbaV0gPSBhdHRyaWJ1dGVEYXRhLkdldFZhbHVlKGkpOwogICAgfQogICAgZHJhY28uZGVzdHJveShhdHRyaWJ1dGVEYXRhKTsKICAgIHJldHVybiB2ZXJ0ZXhBcnJheTsKICB9CiAgZnVuY3Rpb24gZGVjb2RlQXR0cmlidXRlKGRyYWNvR2VvbWV0cnksIGRyYWNvRGVjb2RlciwgZHJhY29BdHRyaWJ1dGUpIHsKICAgIGNvbnN0IG51bVBvaW50cyA9IGRyYWNvR2VvbWV0cnkubnVtX3BvaW50cygpOwogICAgY29uc3QgbnVtQ29tcG9uZW50cyA9IGRyYWNvQXR0cmlidXRlLm51bV9jb21wb25lbnRzKCk7CiAgICBsZXQgcXVhbnRpemF0aW9uOwogICAgbGV0IHRyYW5zZm9ybTIgPSBuZXcgZHJhY28uQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtKCk7CiAgICBpZiAodHJhbnNmb3JtMi5Jbml0RnJvbUF0dHJpYnV0ZShkcmFjb0F0dHJpYnV0ZSkpIHsKICAgICAgY29uc3QgbWluVmFsdWVzID0gbmV3IEFycmF5KG51bUNvbXBvbmVudHMpOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bUNvbXBvbmVudHM7ICsraSkgewogICAgICAgIG1pblZhbHVlc1tpXSA9IHRyYW5zZm9ybTIubWluX3ZhbHVlKGkpOwogICAgICB9CiAgICAgIHF1YW50aXphdGlvbiA9IHsKICAgICAgICBxdWFudGl6YXRpb25CaXRzOiB0cmFuc2Zvcm0yLnF1YW50aXphdGlvbl9iaXRzKCksCiAgICAgICAgbWluVmFsdWVzLAogICAgICAgIHJhbmdlOiB0cmFuc2Zvcm0yLnJhbmdlKCksCiAgICAgICAgb2N0RW5jb2RlZDogZmFsc2UKICAgICAgfTsKICAgIH0KICAgIGRyYWNvLmRlc3Ryb3kodHJhbnNmb3JtMik7CiAgICB0cmFuc2Zvcm0yID0gbmV3IGRyYWNvLkF0dHJpYnV0ZU9jdGFoZWRyb25UcmFuc2Zvcm0oKTsKICAgIGlmICh0cmFuc2Zvcm0yLkluaXRGcm9tQXR0cmlidXRlKGRyYWNvQXR0cmlidXRlKSkgewogICAgICBxdWFudGl6YXRpb24gPSB7CiAgICAgICAgcXVhbnRpemF0aW9uQml0czogdHJhbnNmb3JtMi5xdWFudGl6YXRpb25fYml0cygpLAogICAgICAgIG9jdEVuY29kZWQ6IHRydWUKICAgICAgfTsKICAgIH0KICAgIGRyYWNvLmRlc3Ryb3kodHJhbnNmb3JtMik7CiAgICBjb25zdCB2ZXJ0ZXhBcnJheUxlbmd0aCA9IG51bVBvaW50cyAqIG51bUNvbXBvbmVudHM7CiAgICBsZXQgdmVydGV4QXJyYXk7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHF1YW50aXphdGlvbikpIHsKICAgICAgdmVydGV4QXJyYXkgPSBkZWNvZGVRdWFudGl6ZWREcmFjb1R5cGVkQXJyYXkoCiAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICBkcmFjb0RlY29kZXIsCiAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgcXVhbnRpemF0aW9uLAogICAgICAgIHZlcnRleEFycmF5TGVuZ3RoCiAgICAgICk7CiAgICB9IGVsc2UgewogICAgICB2ZXJ0ZXhBcnJheSA9IGRlY29kZURyYWNvVHlwZWRBcnJheSgKICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgIGRyYWNvRGVjb2RlciwKICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICB2ZXJ0ZXhBcnJheUxlbmd0aAogICAgICApOwogICAgfQogICAgY29uc3QgY29tcG9uZW50RGF0YXR5cGUgPSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LmZyb21UeXBlZEFycmF5KHZlcnRleEFycmF5KTsKICAgIHJldHVybiB7CiAgICAgIGFycmF5OiB2ZXJ0ZXhBcnJheSwKICAgICAgZGF0YTogewogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IG51bUNvbXBvbmVudHMsCiAgICAgICAgY29tcG9uZW50RGF0YXR5cGUsCiAgICAgICAgYnl0ZU9mZnNldDogZHJhY29BdHRyaWJ1dGUuYnl0ZV9vZmZzZXQoKSwKICAgICAgICBieXRlU3RyaWRlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LmdldFNpemVJbkJ5dGVzKGNvbXBvbmVudERhdGF0eXBlKSAqIG51bUNvbXBvbmVudHMsCiAgICAgICAgbm9ybWFsaXplZDogZHJhY29BdHRyaWJ1dGUubm9ybWFsaXplZCgpLAogICAgICAgIHF1YW50aXphdGlvbgogICAgICB9CiAgICB9OwogIH0KICBmdW5jdGlvbiBkZWNvZGVQb2ludENsb3VkKHBhcmFtZXRlcnMpIHsKICAgIGNvbnN0IGRyYWNvRGVjb2RlciA9IG5ldyBkcmFjby5EZWNvZGVyKCk7CiAgICBpZiAocGFyYW1ldGVycy5kZXF1YW50aXplSW5TaGFkZXIpIHsKICAgICAgZHJhY29EZWNvZGVyLlNraXBBdHRyaWJ1dGVUcmFuc2Zvcm0oZHJhY28uUE9TSVRJT04pOwogICAgICBkcmFjb0RlY29kZXIuU2tpcEF0dHJpYnV0ZVRyYW5zZm9ybShkcmFjby5OT1JNQUwpOwogICAgfQogICAgY29uc3QgYnVmZmVyID0gbmV3IGRyYWNvLkRlY29kZXJCdWZmZXIoKTsKICAgIGJ1ZmZlci5Jbml0KHBhcmFtZXRlcnMuYnVmZmVyLCBwYXJhbWV0ZXJzLmJ1ZmZlci5sZW5ndGgpOwogICAgY29uc3QgZ2VvbWV0cnlUeXBlID0gZHJhY29EZWNvZGVyLkdldEVuY29kZWRHZW9tZXRyeVR5cGUoYnVmZmVyKTsKICAgIGlmIChnZW9tZXRyeVR5cGUgIT09IGRyYWNvLlBPSU5UX0NMT1VEKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgiRHJhY28gZ2VvbWV0cnkgdHlwZSBtdXN0IGJlIFBPSU5UX0NMT1VELiIpOwogICAgfQogICAgY29uc3QgZHJhY29Qb2ludENsb3VkID0gbmV3IGRyYWNvLlBvaW50Q2xvdWQoKTsKICAgIGNvbnN0IGRlY29kaW5nU3RhdHVzID0gZHJhY29EZWNvZGVyLkRlY29kZUJ1ZmZlclRvUG9pbnRDbG91ZCgKICAgICAgYnVmZmVyLAogICAgICBkcmFjb1BvaW50Q2xvdWQKICAgICk7CiAgICBpZiAoIWRlY29kaW5nU3RhdHVzLm9rKCkgfHwgZHJhY29Qb2ludENsb3VkLnB0ciA9PT0gMCkgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoCiAgICAgICAgYEVycm9yIGRlY29kaW5nIGRyYWNvIHBvaW50IGNsb3VkOiAke2RlY29kaW5nU3RhdHVzLmVycm9yX21zZygpfWAKICAgICAgKTsKICAgIH0KICAgIGRyYWNvLmRlc3Ryb3koYnVmZmVyKTsKICAgIGNvbnN0IHJlc3VsdCA9IHt9OwogICAgY29uc3QgcHJvcGVydGllcyA9IHBhcmFtZXRlcnMucHJvcGVydGllczsKICAgIGZvciAoY29uc3QgcHJvcGVydHlOYW1lIGluIHByb3BlcnRpZXMpIHsKICAgICAgaWYgKHByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkocHJvcGVydHlOYW1lKSkgewogICAgICAgIGxldCBkcmFjb0F0dHJpYnV0ZTsKICAgICAgICBpZiAocHJvcGVydHlOYW1lID09PSAiUE9TSVRJT04iIHx8IHByb3BlcnR5TmFtZSA9PT0gIk5PUk1BTCIpIHsKICAgICAgICAgIGNvbnN0IGRyYWNvQXR0cmlidXRlSWQgPSBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlSWQoCiAgICAgICAgICAgIGRyYWNvUG9pbnRDbG91ZCwKICAgICAgICAgICAgZHJhY29bcHJvcGVydHlOYW1lXQogICAgICAgICAgKTsKICAgICAgICAgIGRyYWNvQXR0cmlidXRlID0gZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZSgKICAgICAgICAgICAgZHJhY29Qb2ludENsb3VkLAogICAgICAgICAgICBkcmFjb0F0dHJpYnV0ZUlkCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVJZCA9IHByb3BlcnRpZXNbcHJvcGVydHlOYW1lXTsKICAgICAgICAgIGRyYWNvQXR0cmlidXRlID0gZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUJ5VW5pcXVlSWQoCiAgICAgICAgICAgIGRyYWNvUG9pbnRDbG91ZCwKICAgICAgICAgICAgYXR0cmlidXRlSWQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFtwcm9wZXJ0eU5hbWVdID0gZGVjb2RlQXR0cmlidXRlKAogICAgICAgICAgZHJhY29Qb2ludENsb3VkLAogICAgICAgICAgZHJhY29EZWNvZGVyLAogICAgICAgICAgZHJhY29BdHRyaWJ1dGUKICAgICAgICApOwogICAgICB9CiAgICB9CiAgICBkcmFjby5kZXN0cm95KGRyYWNvUG9pbnRDbG91ZCk7CiAgICBkcmFjby5kZXN0cm95KGRyYWNvRGVjb2Rlcik7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBkZWNvZGVQcmltaXRpdmUocGFyYW1ldGVycykgewogICAgY29uc3QgZHJhY29EZWNvZGVyID0gbmV3IGRyYWNvLkRlY29kZXIoKTsKICAgIGNvbnN0IGF0dHJpYnV0ZXNUb1NraXAgPSBbIlBPU0lUSU9OIiwgIk5PUk1BTCIsICJDT0xPUiIsICJURVhfQ09PUkQiXTsKICAgIGlmIChwYXJhbWV0ZXJzLmRlcXVhbnRpemVJblNoYWRlcikgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGF0dHJpYnV0ZXNUb1NraXAubGVuZ3RoOyArK2kpIHsKICAgICAgICBkcmFjb0RlY29kZXIuU2tpcEF0dHJpYnV0ZVRyYW5zZm9ybShkcmFjb1thdHRyaWJ1dGVzVG9Ta2lwW2ldXSk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGJ1ZmZlclZpZXcgPSBwYXJhbWV0ZXJzLmJ1ZmZlclZpZXc7CiAgICBjb25zdCBidWZmZXIgPSBuZXcgZHJhY28uRGVjb2RlckJ1ZmZlcigpOwogICAgYnVmZmVyLkluaXQocGFyYW1ldGVycy5hcnJheSwgYnVmZmVyVmlldy5ieXRlTGVuZ3RoKTsKICAgIGNvbnN0IGdlb21ldHJ5VHlwZSA9IGRyYWNvRGVjb2Rlci5HZXRFbmNvZGVkR2VvbWV0cnlUeXBlKGJ1ZmZlcik7CiAgICBpZiAoZ2VvbWV0cnlUeXBlICE9PSBkcmFjby5UUklBTkdVTEFSX01FU0gpIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJVbnN1cHBvcnRlZCBkcmFjbyBtZXNoIGdlb21ldHJ5IHR5cGUuIik7CiAgICB9CiAgICBjb25zdCBkcmFjb0dlb21ldHJ5ID0gbmV3IGRyYWNvLk1lc2goKTsKICAgIGNvbnN0IGRlY29kaW5nU3RhdHVzID0gZHJhY29EZWNvZGVyLkRlY29kZUJ1ZmZlclRvTWVzaChidWZmZXIsIGRyYWNvR2VvbWV0cnkpOwogICAgaWYgKCFkZWNvZGluZ1N0YXR1cy5vaygpIHx8IGRyYWNvR2VvbWV0cnkucHRyID09PSAwKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgKICAgICAgICBgRXJyb3IgZGVjb2RpbmcgZHJhY28gbWVzaCBnZW9tZXRyeTogJHtkZWNvZGluZ1N0YXR1cy5lcnJvcl9tc2coKX1gCiAgICAgICk7CiAgICB9CiAgICBkcmFjby5kZXN0cm95KGJ1ZmZlcik7CiAgICBjb25zdCBhdHRyaWJ1dGVEYXRhID0ge307CiAgICBjb25zdCBjb21wcmVzc2VkQXR0cmlidXRlcyA9IHBhcmFtZXRlcnMuY29tcHJlc3NlZEF0dHJpYnV0ZXM7CiAgICBmb3IgKGNvbnN0IGF0dHJpYnV0ZU5hbWUgaW4gY29tcHJlc3NlZEF0dHJpYnV0ZXMpIHsKICAgICAgaWYgKGNvbXByZXNzZWRBdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgY29uc3QgY29tcHJlc3NlZEF0dHJpYnV0ZSA9IGNvbXByZXNzZWRBdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdOwogICAgICAgIGNvbnN0IGRyYWNvQXR0cmlidXRlID0gZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUJ5VW5pcXVlSWQoCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgY29tcHJlc3NlZEF0dHJpYnV0ZQogICAgICAgICk7CiAgICAgICAgYXR0cmlidXRlRGF0YVthdHRyaWJ1dGVOYW1lXSA9IGRlY29kZUF0dHJpYnV0ZSgKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0RlY29kZXIsCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZQogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHJlc3VsdCA9IHsKICAgICAgaW5kZXhBcnJheTogZGVjb2RlSW5kZXhBcnJheShkcmFjb0dlb21ldHJ5LCBkcmFjb0RlY29kZXIpLAogICAgICBhdHRyaWJ1dGVEYXRhCiAgICB9OwogICAgZHJhY28uZGVzdHJveShkcmFjb0dlb21ldHJ5KTsKICAgIGRyYWNvLmRlc3Ryb3koZHJhY29EZWNvZGVyKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGFzeW5jIGZ1bmN0aW9uIGRlY29kZShwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHBhcmFtZXRlcnMuYnVmZmVyVmlldykpIHsKICAgICAgcmV0dXJuIGRlY29kZVByaW1pdGl2ZShwYXJhbWV0ZXJzKTsKICAgIH0KICAgIHJldHVybiBkZWNvZGVQb2ludENsb3VkKHBhcmFtZXRlcnMpOwogIH0KICBhc3luYyBmdW5jdGlvbiBpbml0V29ya2VyKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IHdhc21Db25maWcgPSBwYXJhbWV0ZXJzLndlYkFzc2VtYmx5Q29uZmlnOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdCh3YXNtQ29uZmlnKSAmJiBkZWZpbmVkX2RlZmF1bHQod2FzbUNvbmZpZy53YXNtQmluYXJ5RmlsZSkpIHsKICAgICAgZHJhY28gPSBhd2FpdCAoMCwgaW1wb3J0X2RyYWNvX2RlY29kZXJfbm9kZWpzLmRlZmF1bHQpKHdhc21Db25maWcpOwogICAgfSBlbHNlIHsKICAgICAgZHJhY28gPSBhd2FpdCAoMCwgaW1wb3J0X2RyYWNvX2RlY29kZXJfbm9kZWpzLmRlZmF1bHQpKCk7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgYXN5bmMgZnVuY3Rpb24gZGVjb2RlRHJhY28ocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3Qgd2FzbUNvbmZpZyA9IHBhcmFtZXRlcnMud2ViQXNzZW1ibHlDb25maWc7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHdhc21Db25maWcpKSB7CiAgICAgIHJldHVybiBpbml0V29ya2VyKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpOwogICAgfQogICAgcmV0dXJuIGRlY29kZShwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKTsKICB9CiAgdmFyIGltcG9ydF9kcmFjb19kZWNvZGVyX25vZGVqcywgZHJhY28sIGRlY29kZURyYWNvX2RlZmF1bHQ7CiAgdmFyIGluaXRfZGVjb2RlRHJhY28gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2RlY29kZURyYWNvLmpzIigpIHsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfUnVudGltZUVycm9yKCk7CiAgICAgIGluaXRfY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcigpOwogICAgICBpbXBvcnRfZHJhY29fZGVjb2Rlcl9ub2RlanMgPSBfX3RvRVNNKHJlcXVpcmVfZHJhY29fZGVjb2Rlcl9ub2RlanMoKSwgMSk7CiAgICAgIGRlY29kZURyYWNvX2RlZmF1bHQgPSBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2RlZmF1bHQoZGVjb2RlRHJhY28pOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlRGF0YS5qcwogIGZ1bmN0aW9uIGRlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZURhdGEoa2V5LCBkYXRhKSB7CiAgICBpZiAoZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlRGF0YS5wYXNzVGhyb3VnaERhdGFGb3JUZXN0aW5nKSB7CiAgICAgIHJldHVybiBkYXRhOwogICAgfQogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJrZXkiLCBrZXkpOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJkYXRhIiwgZGF0YSk7CiAgICBjb25zdCBrZXlMZW5ndGggPSBrZXkuYnl0ZUxlbmd0aDsKICAgIGlmIChrZXlMZW5ndGggPT09IDAgfHwga2V5TGVuZ3RoICUgNCAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoCiAgICAgICAgIlRoZSBsZW5ndGggb2Yga2V5IG11c3QgYmUgZ3JlYXRlciB0aGFuIDAgYW5kIGEgbXVsdGlwbGUgb2YgNC4iCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBkYXRhVmlldyA9IG5ldyBEYXRhVmlldyhkYXRhKTsKICAgIGNvbnN0IG1hZ2ljID0gZGF0YVZpZXcuZ2V0VWludDMyKDAsIHRydWUpOwogICAgaWYgKG1hZ2ljID09PSBjb21wcmVzc2VkTWFnaWMgfHwgbWFnaWMgPT09IGNvbXByZXNzZWRNYWdpY1N3YXApIHsKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9CiAgICBjb25zdCBrZXlWaWV3ID0gbmV3IERhdGFWaWV3KGtleSk7CiAgICBsZXQgZHAgPSAwOwogICAgY29uc3QgZHBlbmQgPSBkYXRhLmJ5dGVMZW5ndGg7CiAgICBjb25zdCBkcGVuZDY0ID0gZHBlbmQgLSBkcGVuZCAlIDg7CiAgICBjb25zdCBrcGVuZCA9IGtleUxlbmd0aDsKICAgIGxldCBrcDsKICAgIGxldCBvZmYgPSA4OwogICAgd2hpbGUgKGRwIDwgZHBlbmQ2NCkgewogICAgICBvZmYgPSAob2ZmICsgOCkgJSAyNDsKICAgICAga3AgPSBvZmY7CiAgICAgIHdoaWxlIChkcCA8IGRwZW5kNjQgJiYga3AgPCBrcGVuZCkgewogICAgICAgIGRhdGFWaWV3LnNldFVpbnQzMigKICAgICAgICAgIGRwLAogICAgICAgICAgZGF0YVZpZXcuZ2V0VWludDMyKGRwLCB0cnVlKSBeIGtleVZpZXcuZ2V0VWludDMyKGtwLCB0cnVlKSwKICAgICAgICAgIHRydWUKICAgICAgICApOwogICAgICAgIGRhdGFWaWV3LnNldFVpbnQzMigKICAgICAgICAgIGRwICsgNCwKICAgICAgICAgIGRhdGFWaWV3LmdldFVpbnQzMihkcCArIDQsIHRydWUpIF4ga2V5Vmlldy5nZXRVaW50MzIoa3AgKyA0LCB0cnVlKSwKICAgICAgICAgIHRydWUKICAgICAgICApOwogICAgICAgIGRwICs9IDg7CiAgICAgICAga3AgKz0gMjQ7CiAgICAgIH0KICAgIH0KICAgIGlmIChkcCA8IGRwZW5kKSB7CiAgICAgIGlmIChrcCA+PSBrcGVuZCkgewogICAgICAgIG9mZiA9IChvZmYgKyA4KSAlIDI0OwogICAgICAgIGtwID0gb2ZmOwogICAgICB9CiAgICAgIHdoaWxlIChkcCA8IGRwZW5kKSB7CiAgICAgICAgZGF0YVZpZXcuc2V0VWludDgoZHAsIGRhdGFWaWV3LmdldFVpbnQ4KGRwKSBeIGtleVZpZXcuZ2V0VWludDgoa3ApKTsKICAgICAgICBkcCsrOwogICAgICAgIGtwKys7CiAgICAgIH0KICAgIH0KICB9CiAgdmFyIGNvbXByZXNzZWRNYWdpYywgY29tcHJlc3NlZE1hZ2ljU3dhcCwgZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlRGF0YV9kZWZhdWx0OwogIHZhciBpbml0X2RlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZURhdGEgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2RlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZURhdGEuanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfUnVudGltZUVycm9yKCk7CiAgICAgIGNvbXByZXNzZWRNYWdpYyA9IDE5NTMwMjk4MDU7CiAgICAgIGNvbXByZXNzZWRNYWdpY1N3YXAgPSAyOTE3MDM0MTAwOwogICAgICBkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VEYXRhLnBhc3NUaHJvdWdoRGF0YUZvclRlc3RpbmcgPSBmYWxzZTsKICAgICAgZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlRGF0YV9kZWZhdWx0ID0gZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlRGF0YTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2lzQml0U2V0LmpzCiAgZnVuY3Rpb24gaXNCaXRTZXQoYml0cywgbWFzaykgewogICAgcmV0dXJuIChiaXRzICYgbWFzaykgIT09IDA7CiAgfQogIHZhciBpc0JpdFNldF9kZWZhdWx0OwogIHZhciBpbml0X2lzQml0U2V0ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9pc0JpdFNldC5qcyIoKSB7CiAgICAgIGlzQml0U2V0X2RlZmF1bHQgPSBpc0JpdFNldDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbi5qcwogIGZ1bmN0aW9uIEdvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbihiaXRzLCBjbm9kZVZlcnNpb24sIGltYWdlcnlWZXJzaW9uLCB0ZXJyYWluVmVyc2lvbiwgaW1hZ2VyeVByb3ZpZGVyLCB0ZXJyYWluUHJvdmlkZXIpIHsKICAgIHRoaXMuX2JpdHMgPSBiaXRzOwogICAgdGhpcy5jbm9kZVZlcnNpb24gPSBjbm9kZVZlcnNpb247CiAgICB0aGlzLmltYWdlcnlWZXJzaW9uID0gaW1hZ2VyeVZlcnNpb247CiAgICB0aGlzLnRlcnJhaW5WZXJzaW9uID0gdGVycmFpblZlcnNpb247CiAgICB0aGlzLmltYWdlcnlQcm92aWRlciA9IGltYWdlcnlQcm92aWRlcjsKICAgIHRoaXMudGVycmFpblByb3ZpZGVyID0gdGVycmFpblByb3ZpZGVyOwogICAgdGhpcy5hbmNlc3Rvckhhc1RlcnJhaW4gPSBmYWxzZTsKICAgIHRoaXMudGVycmFpblN0YXRlID0gdm9pZCAwOwogIH0KICB2YXIgY2hpbGRyZW5CaXRtYXNrcywgYW55Q2hpbGRCaXRtYXNrLCBjYWNoZUZsYWdCaXRtYXNrLCBpbWFnZUJpdG1hc2ssIHRlcnJhaW5CaXRtYXNrLCBHb29nbGVFYXJ0aEVudGVycHJpc2VUaWxlSW5mb3JtYXRpb25fZGVmYXVsdDsKICB2YXIgaW5pdF9Hb29nbGVFYXJ0aEVudGVycHJpc2VUaWxlSW5mb3JtYXRpb24gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbi5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X2lzQml0U2V0KCk7CiAgICAgIGNoaWxkcmVuQml0bWFza3MgPSBbMSwgMiwgNCwgOF07CiAgICAgIGFueUNoaWxkQml0bWFzayA9IDE1OwogICAgICBjYWNoZUZsYWdCaXRtYXNrID0gMTY7CiAgICAgIGltYWdlQml0bWFzayA9IDY0OwogICAgICB0ZXJyYWluQml0bWFzayA9IDEyODsKICAgICAgR29vZ2xlRWFydGhFbnRlcnByaXNlVGlsZUluZm9ybWF0aW9uLmNsb25lID0gZnVuY3Rpb24oaW5mbywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEdvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbigKICAgICAgICAgICAgaW5mby5fYml0cywKICAgICAgICAgICAgaW5mby5jbm9kZVZlcnNpb24sCiAgICAgICAgICAgIGluZm8uaW1hZ2VyeVZlcnNpb24sCiAgICAgICAgICAgIGluZm8udGVycmFpblZlcnNpb24sCiAgICAgICAgICAgIGluZm8uaW1hZ2VyeVByb3ZpZGVyLAogICAgICAgICAgICBpbmZvLnRlcnJhaW5Qcm92aWRlcgogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0Ll9iaXRzID0gaW5mby5fYml0czsKICAgICAgICAgIHJlc3VsdC5jbm9kZVZlcnNpb24gPSBpbmZvLmNub2RlVmVyc2lvbjsKICAgICAgICAgIHJlc3VsdC5pbWFnZXJ5VmVyc2lvbiA9IGluZm8uaW1hZ2VyeVZlcnNpb247CiAgICAgICAgICByZXN1bHQudGVycmFpblZlcnNpb24gPSBpbmZvLnRlcnJhaW5WZXJzaW9uOwogICAgICAgICAgcmVzdWx0LmltYWdlcnlQcm92aWRlciA9IGluZm8uaW1hZ2VyeVByb3ZpZGVyOwogICAgICAgICAgcmVzdWx0LnRlcnJhaW5Qcm92aWRlciA9IGluZm8udGVycmFpblByb3ZpZGVyOwogICAgICAgIH0KICAgICAgICByZXN1bHQuYW5jZXN0b3JIYXNUZXJyYWluID0gaW5mby5hbmNlc3Rvckhhc1RlcnJhaW47CiAgICAgICAgcmVzdWx0LnRlcnJhaW5TdGF0ZSA9IGluZm8udGVycmFpblN0YXRlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEdvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbi5wcm90b3R5cGUuc2V0UGFyZW50ID0gZnVuY3Rpb24ocGFyZW50KSB7CiAgICAgICAgdGhpcy5hbmNlc3Rvckhhc1RlcnJhaW4gPSBwYXJlbnQuYW5jZXN0b3JIYXNUZXJyYWluIHx8IHRoaXMuaGFzVGVycmFpbigpOwogICAgICB9OwogICAgICBHb29nbGVFYXJ0aEVudGVycHJpc2VUaWxlSW5mb3JtYXRpb24ucHJvdG90eXBlLmhhc1N1YnRyZWUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gaXNCaXRTZXRfZGVmYXVsdCh0aGlzLl9iaXRzLCBjYWNoZUZsYWdCaXRtYXNrKTsKICAgICAgfTsKICAgICAgR29vZ2xlRWFydGhFbnRlcnByaXNlVGlsZUluZm9ybWF0aW9uLnByb3RvdHlwZS5oYXNJbWFnZXJ5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGlzQml0U2V0X2RlZmF1bHQodGhpcy5fYml0cywgaW1hZ2VCaXRtYXNrKTsKICAgICAgfTsKICAgICAgR29vZ2xlRWFydGhFbnRlcnByaXNlVGlsZUluZm9ybWF0aW9uLnByb3RvdHlwZS5oYXNUZXJyYWluID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGlzQml0U2V0X2RlZmF1bHQodGhpcy5fYml0cywgdGVycmFpbkJpdG1hc2spOwogICAgICB9OwogICAgICBHb29nbGVFYXJ0aEVudGVycHJpc2VUaWxlSW5mb3JtYXRpb24ucHJvdG90eXBlLmhhc0NoaWxkcmVuID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGlzQml0U2V0X2RlZmF1bHQodGhpcy5fYml0cywgYW55Q2hpbGRCaXRtYXNrKTsKICAgICAgfTsKICAgICAgR29vZ2xlRWFydGhFbnRlcnByaXNlVGlsZUluZm9ybWF0aW9uLnByb3RvdHlwZS5oYXNDaGlsZCA9IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgcmV0dXJuIGlzQml0U2V0X2RlZmF1bHQodGhpcy5fYml0cywgY2hpbGRyZW5CaXRtYXNrc1tpbmRleF0pOwogICAgICB9OwogICAgICBHb29nbGVFYXJ0aEVudGVycHJpc2VUaWxlSW5mb3JtYXRpb24ucHJvdG90eXBlLmdldENoaWxkQml0bWFzayA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLl9iaXRzICYgYW55Q2hpbGRCaXRtYXNrOwogICAgICB9OwogICAgICBHb29nbGVFYXJ0aEVudGVycHJpc2VUaWxlSW5mb3JtYXRpb25fZGVmYXVsdCA9IEdvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbjsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvYWRsZXIzMi5qcwogIHZhciByZXF1aXJlX2FkbGVyMzIgPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi9hZGxlcjMyLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgdmFyIGFkbGVyMzIgPSAoYWRsZXIsIGJ1ZiwgbGVuLCBwb3MpID0+IHsKICAgICAgICBsZXQgczEgPSBhZGxlciAmIDY1NTM1IHwgMCwgczIgPSBhZGxlciA+Pj4gMTYgJiA2NTUzNSB8IDAsIG4gPSAwOwogICAgICAgIHdoaWxlIChsZW4gIT09IDApIHsKICAgICAgICAgIG4gPSBsZW4gPiAyZTMgPyAyZTMgOiBsZW47CiAgICAgICAgICBsZW4gLT0gbjsKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgczEgPSBzMSArIGJ1Zltwb3MrK10gfCAwOwogICAgICAgICAgICBzMiA9IHMyICsgczEgfCAwOwogICAgICAgICAgfSB3aGlsZSAoLS1uKTsKICAgICAgICAgIHMxICU9IDY1NTIxOwogICAgICAgICAgczIgJT0gNjU1MjE7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzMSB8IHMyIDw8IDE2IHwgMDsKICAgICAgfTsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBhZGxlcjMyOwogICAgfQogIH0pOwoKICAvLyBub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi9jcmMzMi5qcwogIHZhciByZXF1aXJlX2NyYzMyID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvY3JjMzIuanMiKGV4cG9ydHMyLCBtb2R1bGUpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICB2YXIgbWFrZVRhYmxlID0gKCkgPT4gewogICAgICAgIGxldCBjLCB0YWJsZSA9IFtdOwogICAgICAgIGZvciAodmFyIG4gPSAwOyBuIDwgMjU2OyBuKyspIHsKICAgICAgICAgIGMgPSBuOwogICAgICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCA4OyBrKyspIHsKICAgICAgICAgICAgYyA9IGMgJiAxID8gMzk4ODI5MjM4NCBeIGMgPj4+IDEgOiBjID4+PiAxOwogICAgICAgICAgfQogICAgICAgICAgdGFibGVbbl0gPSBjOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGFibGU7CiAgICAgIH07CiAgICAgIHZhciBjcmNUYWJsZSA9IG5ldyBVaW50MzJBcnJheShtYWtlVGFibGUoKSk7CiAgICAgIHZhciBjcmMzMiA9IChjcmMsIGJ1ZiwgbGVuLCBwb3MpID0+IHsKICAgICAgICBjb25zdCB0ID0gY3JjVGFibGU7CiAgICAgICAgY29uc3QgZW5kID0gcG9zICsgbGVuOwogICAgICAgIGNyYyBePSAtMTsKICAgICAgICBmb3IgKGxldCBpID0gcG9zOyBpIDwgZW5kOyBpKyspIHsKICAgICAgICAgIGNyYyA9IGNyYyA+Pj4gOCBeIHRbKGNyYyBeIGJ1ZltpXSkgJiAyNTVdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY3JjIF4gLTE7CiAgICAgIH07CiAgICAgIG1vZHVsZS5leHBvcnRzID0gY3JjMzI7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9wYWtvL2xpYi96bGliL2luZmZhc3QuanMKICB2YXIgcmVxdWlyZV9pbmZmYXN0ID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvaW5mZmFzdC5qcyIoZXhwb3J0czIsIG1vZHVsZSkgewogICAgICAidXNlIHN0cmljdCI7CiAgICAgIHZhciBCQUQgPSAxNjIwOTsKICAgICAgdmFyIFRZUEUgPSAxNjE5MTsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBpbmZsYXRlX2Zhc3Qoc3RybSwgc3RhcnQpIHsKICAgICAgICBsZXQgX2luOwogICAgICAgIGxldCBsYXN0OwogICAgICAgIGxldCBfb3V0OwogICAgICAgIGxldCBiZWc7CiAgICAgICAgbGV0IGVuZDsKICAgICAgICBsZXQgZG1heDsKICAgICAgICBsZXQgd3NpemU7CiAgICAgICAgbGV0IHdoYXZlOwogICAgICAgIGxldCB3bmV4dDsKICAgICAgICBsZXQgc193aW5kb3c7CiAgICAgICAgbGV0IGhvbGQ7CiAgICAgICAgbGV0IGJpdHM7CiAgICAgICAgbGV0IGxjb2RlOwogICAgICAgIGxldCBkY29kZTsKICAgICAgICBsZXQgbG1hc2s7CiAgICAgICAgbGV0IGRtYXNrOwogICAgICAgIGxldCBoZXJlOwogICAgICAgIGxldCBvcDsKICAgICAgICBsZXQgbGVuOwogICAgICAgIGxldCBkaXN0OwogICAgICAgIGxldCBmcm9tOwogICAgICAgIGxldCBmcm9tX3NvdXJjZTsKICAgICAgICBsZXQgaW5wdXQsIG91dHB1dDsKICAgICAgICBjb25zdCBzdGF0ZSA9IHN0cm0uc3RhdGU7CiAgICAgICAgX2luID0gc3RybS5uZXh0X2luOwogICAgICAgIGlucHV0ID0gc3RybS5pbnB1dDsKICAgICAgICBsYXN0ID0gX2luICsgKHN0cm0uYXZhaWxfaW4gLSA1KTsKICAgICAgICBfb3V0ID0gc3RybS5uZXh0X291dDsKICAgICAgICBvdXRwdXQgPSBzdHJtLm91dHB1dDsKICAgICAgICBiZWcgPSBfb3V0IC0gKHN0YXJ0IC0gc3RybS5hdmFpbF9vdXQpOwogICAgICAgIGVuZCA9IF9vdXQgKyAoc3RybS5hdmFpbF9vdXQgLSAyNTcpOwogICAgICAgIGRtYXggPSBzdGF0ZS5kbWF4OwogICAgICAgIHdzaXplID0gc3RhdGUud3NpemU7CiAgICAgICAgd2hhdmUgPSBzdGF0ZS53aGF2ZTsKICAgICAgICB3bmV4dCA9IHN0YXRlLnduZXh0OwogICAgICAgIHNfd2luZG93ID0gc3RhdGUud2luZG93OwogICAgICAgIGhvbGQgPSBzdGF0ZS5ob2xkOwogICAgICAgIGJpdHMgPSBzdGF0ZS5iaXRzOwogICAgICAgIGxjb2RlID0gc3RhdGUubGVuY29kZTsKICAgICAgICBkY29kZSA9IHN0YXRlLmRpc3Rjb2RlOwogICAgICAgIGxtYXNrID0gKDEgPDwgc3RhdGUubGVuYml0cykgLSAxOwogICAgICAgIGRtYXNrID0gKDEgPDwgc3RhdGUuZGlzdGJpdHMpIC0gMTsKICAgICAgICB0b3A6CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIGlmIChiaXRzIDwgMTUpIHsKICAgICAgICAgICAgICBob2xkICs9IGlucHV0W19pbisrXSA8PCBiaXRzOwogICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICBob2xkICs9IGlucHV0W19pbisrXSA8PCBiaXRzOwogICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgfQogICAgICAgICAgICBoZXJlID0gbGNvZGVbaG9sZCAmIGxtYXNrXTsKICAgICAgICAgICAgZG9sZW46CiAgICAgICAgICAgICAgZm9yICg7IDsgKSB7CiAgICAgICAgICAgICAgICBvcCA9IGhlcmUgPj4+IDI0OwogICAgICAgICAgICAgICAgaG9sZCA+Pj49IG9wOwogICAgICAgICAgICAgICAgYml0cyAtPSBvcDsKICAgICAgICAgICAgICAgIG9wID0gaGVyZSA+Pj4gMTYgJiAyNTU7CiAgICAgICAgICAgICAgICBpZiAob3AgPT09IDApIHsKICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBoZXJlICYgNjU1MzU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wICYgMTYpIHsKICAgICAgICAgICAgICAgICAgbGVuID0gaGVyZSAmIDY1NTM1OwogICAgICAgICAgICAgICAgICBvcCAmPSAxNTsKICAgICAgICAgICAgICAgICAgaWYgKG9wKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJpdHMgPCBvcCkgewogICAgICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtfaW4rK10gPDwgYml0czsKICAgICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbGVuICs9IGhvbGQgJiAoMSA8PCBvcCkgLSAxOwogICAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBvcDsKICAgICAgICAgICAgICAgICAgICBiaXRzIC09IG9wOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChiaXRzIDwgMTUpIHsKICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W19pbisrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W19pbisrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoZXJlID0gZGNvZGVbaG9sZCAmIGRtYXNrXTsKICAgICAgICAgICAgICAgICAgZG9kaXN0OgogICAgICAgICAgICAgICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgICAgICAgICAgICAgb3AgPSBoZXJlID4+PiAyNDsKICAgICAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBvcDsKICAgICAgICAgICAgICAgICAgICAgIGJpdHMgLT0gb3A7CiAgICAgICAgICAgICAgICAgICAgICBvcCA9IGhlcmUgPj4+IDE2ICYgMjU1OwogICAgICAgICAgICAgICAgICAgICAgaWYgKG9wICYgMTYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGlzdCA9IGhlcmUgJiA2NTUzNTsKICAgICAgICAgICAgICAgICAgICAgICAgb3AgJj0gMTU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiaXRzIDwgb3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W19pbisrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYml0cyA8IG9wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W19pbisrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBkaXN0ICs9IGhvbGQgJiAoMSA8PCBvcCkgLSAxOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IGRtYXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIGRpc3RhbmNlIHRvbyBmYXIgYmFjayI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhayB0b3A7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaG9sZCA+Pj49IG9wOwogICAgICAgICAgICAgICAgICAgICAgICBiaXRzIC09IG9wOwogICAgICAgICAgICAgICAgICAgICAgICBvcCA9IF9vdXQgLSBiZWc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXN0ID4gb3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBvcCA9IGRpc3QgLSBvcDsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3AgPiB3aGF2ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnNhbmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW52YWxpZCBkaXN0YW5jZSB0b28gZmFyIGJhY2siOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhayB0b3A7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIGZyb20gPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgIGZyb21fc291cmNlID0gc193aW5kb3c7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHduZXh0ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tICs9IHdzaXplIC0gb3A7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3AgPCBsZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuIC09IG9wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBzX3dpbmRvd1tmcm9tKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlICgtLW9wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbSA9IF9vdXQgLSBkaXN0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tX3NvdXJjZSA9IG91dHB1dDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHduZXh0IDwgb3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb20gKz0gd3NpemUgKyB3bmV4dCAtIG9wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3AgLT0gd25leHQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3AgPCBsZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuIC09IG9wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBzX3dpbmRvd1tmcm9tKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlICgtLW9wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3bmV4dCA8IGxlbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wID0gd25leHQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuIC09IG9wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dFtfb3V0KytdID0gc193aW5kb3dbZnJvbSsrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlICgtLW9wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tID0gX291dCAtIGRpc3Q7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbV9zb3VyY2UgPSBvdXRwdXQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbSArPSB3bmV4dCAtIG9wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wIDwgbGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbiAtPSBvcDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dFtfb3V0KytdID0gc193aW5kb3dbZnJvbSsrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAoLS1vcCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb20gPSBfb3V0IC0gZGlzdDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbV9zb3VyY2UgPSBvdXRwdXQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChsZW4gPiAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXRbX291dCsrXSA9IGZyb21fc291cmNlW2Zyb20rK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXRbX291dCsrXSA9IGZyb21fc291cmNlW2Zyb20rK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXRbX291dCsrXSA9IGZyb21fc291cmNlW2Zyb20rK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW4gLT0gMzsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxlbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBmcm9tX3NvdXJjZVtmcm9tKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxlbiA+IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBmcm9tX3NvdXJjZVtmcm9tKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tID0gX291dCAtIGRpc3Q7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBvdXRwdXRbZnJvbSsrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dFtfb3V0KytdID0gb3V0cHV0W2Zyb20rK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXRbX291dCsrXSA9IG91dHB1dFtmcm9tKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuIC09IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAobGVuID4gMik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxlbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBvdXRwdXRbZnJvbSsrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsZW4gPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dFtfb3V0KytdID0gb3V0cHV0W2Zyb20rK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChvcCAmIDY0KSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBoZXJlID0gZGNvZGVbKGhlcmUgJiA2NTUzNSkgKyAoaG9sZCAmICgxIDw8IG9wKSAtIDEpXTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUgZG9kaXN0OwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW52YWxpZCBkaXN0YW5jZSBjb2RlIjsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsgdG9wOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgob3AgJiA2NCkgPT09IDApIHsKICAgICAgICAgICAgICAgICAgaGVyZSA9IGxjb2RlWyhoZXJlICYgNjU1MzUpICsgKGhvbGQgJiAoMSA8PCBvcCkgLSAxKV07CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlIGRvbGVuOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcCAmIDMyKSB7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBUWVBFOwogICAgICAgICAgICAgICAgICBicmVhayB0b3A7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIGxpdGVyYWwvbGVuZ3RoIGNvZGUiOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICBicmVhayB0b3A7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9IHdoaWxlIChfaW4gPCBsYXN0ICYmIF9vdXQgPCBlbmQpOwogICAgICAgIGxlbiA9IGJpdHMgPj4gMzsKICAgICAgICBfaW4gLT0gbGVuOwogICAgICAgIGJpdHMgLT0gbGVuIDw8IDM7CiAgICAgICAgaG9sZCAmPSAoMSA8PCBiaXRzKSAtIDE7CiAgICAgICAgc3RybS5uZXh0X2luID0gX2luOwogICAgICAgIHN0cm0ubmV4dF9vdXQgPSBfb3V0OwogICAgICAgIHN0cm0uYXZhaWxfaW4gPSBfaW4gPCBsYXN0ID8gNSArIChsYXN0IC0gX2luKSA6IDUgLSAoX2luIC0gbGFzdCk7CiAgICAgICAgc3RybS5hdmFpbF9vdXQgPSBfb3V0IDwgZW5kID8gMjU3ICsgKGVuZCAtIF9vdXQpIDogMjU3IC0gKF9vdXQgLSBlbmQpOwogICAgICAgIHN0YXRlLmhvbGQgPSBob2xkOwogICAgICAgIHN0YXRlLmJpdHMgPSBiaXRzOwogICAgICAgIHJldHVybjsKICAgICAgfTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvaW5mdHJlZXMuanMKICB2YXIgcmVxdWlyZV9pbmZ0cmVlcyA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy9wYWtvL2xpYi96bGliL2luZnRyZWVzLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgdmFyIE1BWEJJVFMgPSAxNTsKICAgICAgdmFyIEVOT1VHSF9MRU5TID0gODUyOwogICAgICB2YXIgRU5PVUdIX0RJU1RTID0gNTkyOwogICAgICB2YXIgQ09ERVMgPSAwOwogICAgICB2YXIgTEVOUyA9IDE7CiAgICAgIHZhciBESVNUUyA9IDI7CiAgICAgIHZhciBsYmFzZSA9IG5ldyBVaW50MTZBcnJheShbCiAgICAgICAgLyogTGVuZ3RoIGNvZGVzIDI1Ny4uMjg1IGJhc2UgKi8KICAgICAgICAzLAogICAgICAgIDQsCiAgICAgICAgNSwKICAgICAgICA2LAogICAgICAgIDcsCiAgICAgICAgOCwKICAgICAgICA5LAogICAgICAgIDEwLAogICAgICAgIDExLAogICAgICAgIDEzLAogICAgICAgIDE1LAogICAgICAgIDE3LAogICAgICAgIDE5LAogICAgICAgIDIzLAogICAgICAgIDI3LAogICAgICAgIDMxLAogICAgICAgIDM1LAogICAgICAgIDQzLAogICAgICAgIDUxLAogICAgICAgIDU5LAogICAgICAgIDY3LAogICAgICAgIDgzLAogICAgICAgIDk5LAogICAgICAgIDExNSwKICAgICAgICAxMzEsCiAgICAgICAgMTYzLAogICAgICAgIDE5NSwKICAgICAgICAyMjcsCiAgICAgICAgMjU4LAogICAgICAgIDAsCiAgICAgICAgMAogICAgICBdKTsKICAgICAgdmFyIGxleHQgPSBuZXcgVWludDhBcnJheShbCiAgICAgICAgLyogTGVuZ3RoIGNvZGVzIDI1Ny4uMjg1IGV4dHJhICovCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTcsCiAgICAgICAgMTcsCiAgICAgICAgMTcsCiAgICAgICAgMTcsCiAgICAgICAgMTgsCiAgICAgICAgMTgsCiAgICAgICAgMTgsCiAgICAgICAgMTgsCiAgICAgICAgMTksCiAgICAgICAgMTksCiAgICAgICAgMTksCiAgICAgICAgMTksCiAgICAgICAgMjAsCiAgICAgICAgMjAsCiAgICAgICAgMjAsCiAgICAgICAgMjAsCiAgICAgICAgMjEsCiAgICAgICAgMjEsCiAgICAgICAgMjEsCiAgICAgICAgMjEsCiAgICAgICAgMTYsCiAgICAgICAgNzIsCiAgICAgICAgNzgKICAgICAgXSk7CiAgICAgIHZhciBkYmFzZSA9IG5ldyBVaW50MTZBcnJheShbCiAgICAgICAgLyogRGlzdGFuY2UgY29kZXMgMC4uMjkgYmFzZSAqLwogICAgICAgIDEsCiAgICAgICAgMiwKICAgICAgICAzLAogICAgICAgIDQsCiAgICAgICAgNSwKICAgICAgICA3LAogICAgICAgIDksCiAgICAgICAgMTMsCiAgICAgICAgMTcsCiAgICAgICAgMjUsCiAgICAgICAgMzMsCiAgICAgICAgNDksCiAgICAgICAgNjUsCiAgICAgICAgOTcsCiAgICAgICAgMTI5LAogICAgICAgIDE5MywKICAgICAgICAyNTcsCiAgICAgICAgMzg1LAogICAgICAgIDUxMywKICAgICAgICA3NjksCiAgICAgICAgMTAyNSwKICAgICAgICAxNTM3LAogICAgICAgIDIwNDksCiAgICAgICAgMzA3MywKICAgICAgICA0MDk3LAogICAgICAgIDYxNDUsCiAgICAgICAgODE5MywKICAgICAgICAxMjI4OSwKICAgICAgICAxNjM4NSwKICAgICAgICAyNDU3NywKICAgICAgICAwLAogICAgICAgIDAKICAgICAgXSk7CiAgICAgIHZhciBkZXh0ID0gbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIC8qIERpc3RhbmNlIGNvZGVzIDAuLjI5IGV4dHJhICovCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTcsCiAgICAgICAgMTcsCiAgICAgICAgMTgsCiAgICAgICAgMTgsCiAgICAgICAgMTksCiAgICAgICAgMTksCiAgICAgICAgMjAsCiAgICAgICAgMjAsCiAgICAgICAgMjEsCiAgICAgICAgMjEsCiAgICAgICAgMjIsCiAgICAgICAgMjIsCiAgICAgICAgMjMsCiAgICAgICAgMjMsCiAgICAgICAgMjQsCiAgICAgICAgMjQsCiAgICAgICAgMjUsCiAgICAgICAgMjUsCiAgICAgICAgMjYsCiAgICAgICAgMjYsCiAgICAgICAgMjcsCiAgICAgICAgMjcsCiAgICAgICAgMjgsCiAgICAgICAgMjgsCiAgICAgICAgMjksCiAgICAgICAgMjksCiAgICAgICAgNjQsCiAgICAgICAgNjQKICAgICAgXSk7CiAgICAgIHZhciBpbmZsYXRlX3RhYmxlID0gKHR5cGUsIGxlbnMsIGxlbnNfaW5kZXgsIGNvZGVzLCB0YWJsZSwgdGFibGVfaW5kZXgsIHdvcmssIG9wdHMpID0+IHsKICAgICAgICBjb25zdCBiaXRzID0gb3B0cy5iaXRzOwogICAgICAgIGxldCBsZW4gPSAwOwogICAgICAgIGxldCBzeW0gPSAwOwogICAgICAgIGxldCBtaW4zID0gMCwgbWF4MyA9IDA7CiAgICAgICAgbGV0IHJvb3QgPSAwOwogICAgICAgIGxldCBjdXJyID0gMDsKICAgICAgICBsZXQgZHJvcCA9IDA7CiAgICAgICAgbGV0IGxlZnQgPSAwOwogICAgICAgIGxldCB1c2VkID0gMDsKICAgICAgICBsZXQgaHVmZiA9IDA7CiAgICAgICAgbGV0IGluY3I7CiAgICAgICAgbGV0IGZpbGw7CiAgICAgICAgbGV0IGxvdzsKICAgICAgICBsZXQgbWFzazsKICAgICAgICBsZXQgbmV4dDsKICAgICAgICBsZXQgYmFzZSA9IG51bGw7CiAgICAgICAgbGV0IG1hdGNoOwogICAgICAgIGNvbnN0IGNvdW50ID0gbmV3IFVpbnQxNkFycmF5KE1BWEJJVFMgKyAxKTsKICAgICAgICBjb25zdCBvZmZzID0gbmV3IFVpbnQxNkFycmF5KE1BWEJJVFMgKyAxKTsKICAgICAgICBsZXQgZXh0cmEgPSBudWxsOwogICAgICAgIGxldCBoZXJlX2JpdHMsIGhlcmVfb3AsIGhlcmVfdmFsOwogICAgICAgIGZvciAobGVuID0gMDsgbGVuIDw9IE1BWEJJVFM7IGxlbisrKSB7CiAgICAgICAgICBjb3VudFtsZW5dID0gMDsKICAgICAgICB9CiAgICAgICAgZm9yIChzeW0gPSAwOyBzeW0gPCBjb2Rlczsgc3ltKyspIHsKICAgICAgICAgIGNvdW50W2xlbnNbbGVuc19pbmRleCArIHN5bV1dKys7CiAgICAgICAgfQogICAgICAgIHJvb3QgPSBiaXRzOwogICAgICAgIGZvciAobWF4MyA9IE1BWEJJVFM7IG1heDMgPj0gMTsgbWF4My0tKSB7CiAgICAgICAgICBpZiAoY291bnRbbWF4M10gIT09IDApIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChyb290ID4gbWF4MykgewogICAgICAgICAgcm9vdCA9IG1heDM7CiAgICAgICAgfQogICAgICAgIGlmIChtYXgzID09PSAwKSB7CiAgICAgICAgICB0YWJsZVt0YWJsZV9pbmRleCsrXSA9IDEgPDwgMjQgfCA2NCA8PCAxNiB8IDA7CiAgICAgICAgICB0YWJsZVt0YWJsZV9pbmRleCsrXSA9IDEgPDwgMjQgfCA2NCA8PCAxNiB8IDA7CiAgICAgICAgICBvcHRzLmJpdHMgPSAxOwogICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICAgIGZvciAobWluMyA9IDE7IG1pbjMgPCBtYXgzOyBtaW4zKyspIHsKICAgICAgICAgIGlmIChjb3VudFttaW4zXSAhPT0gMCkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHJvb3QgPCBtaW4zKSB7CiAgICAgICAgICByb290ID0gbWluMzsKICAgICAgICB9CiAgICAgICAgbGVmdCA9IDE7CiAgICAgICAgZm9yIChsZW4gPSAxOyBsZW4gPD0gTUFYQklUUzsgbGVuKyspIHsKICAgICAgICAgIGxlZnQgPDw9IDE7CiAgICAgICAgICBsZWZ0IC09IGNvdW50W2xlbl07CiAgICAgICAgICBpZiAobGVmdCA8IDApIHsKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAobGVmdCA+IDAgJiYgKHR5cGUgPT09IENPREVTIHx8IG1heDMgIT09IDEpKSB7CiAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgICAgIG9mZnNbMV0gPSAwOwogICAgICAgIGZvciAobGVuID0gMTsgbGVuIDwgTUFYQklUUzsgbGVuKyspIHsKICAgICAgICAgIG9mZnNbbGVuICsgMV0gPSBvZmZzW2xlbl0gKyBjb3VudFtsZW5dOwogICAgICAgIH0KICAgICAgICBmb3IgKHN5bSA9IDA7IHN5bSA8IGNvZGVzOyBzeW0rKykgewogICAgICAgICAgaWYgKGxlbnNbbGVuc19pbmRleCArIHN5bV0gIT09IDApIHsKICAgICAgICAgICAgd29ya1tvZmZzW2xlbnNbbGVuc19pbmRleCArIHN5bV1dKytdID0gc3ltOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodHlwZSA9PT0gQ09ERVMpIHsKICAgICAgICAgIGJhc2UgPSBleHRyYSA9IHdvcms7CiAgICAgICAgICBtYXRjaCA9IDIwOwogICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gTEVOUykgewogICAgICAgICAgYmFzZSA9IGxiYXNlOwogICAgICAgICAgZXh0cmEgPSBsZXh0OwogICAgICAgICAgbWF0Y2ggPSAyNTc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJhc2UgPSBkYmFzZTsKICAgICAgICAgIGV4dHJhID0gZGV4dDsKICAgICAgICAgIG1hdGNoID0gMDsKICAgICAgICB9CiAgICAgICAgaHVmZiA9IDA7CiAgICAgICAgc3ltID0gMDsKICAgICAgICBsZW4gPSBtaW4zOwogICAgICAgIG5leHQgPSB0YWJsZV9pbmRleDsKICAgICAgICBjdXJyID0gcm9vdDsKICAgICAgICBkcm9wID0gMDsKICAgICAgICBsb3cgPSAtMTsKICAgICAgICB1c2VkID0gMSA8PCByb290OwogICAgICAgIG1hc2sgPSB1c2VkIC0gMTsKICAgICAgICBpZiAodHlwZSA9PT0gTEVOUyAmJiB1c2VkID4gRU5PVUdIX0xFTlMgfHwgdHlwZSA9PT0gRElTVFMgJiYgdXNlZCA+IEVOT1VHSF9ESVNUUykgewogICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgfQogICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgaGVyZV9iaXRzID0gbGVuIC0gZHJvcDsKICAgICAgICAgIGlmICh3b3JrW3N5bV0gKyAxIDwgbWF0Y2gpIHsKICAgICAgICAgICAgaGVyZV9vcCA9IDA7CiAgICAgICAgICAgIGhlcmVfdmFsID0gd29ya1tzeW1dOwogICAgICAgICAgfSBlbHNlIGlmICh3b3JrW3N5bV0gPj0gbWF0Y2gpIHsKICAgICAgICAgICAgaGVyZV9vcCA9IGV4dHJhW3dvcmtbc3ltXSAtIG1hdGNoXTsKICAgICAgICAgICAgaGVyZV92YWwgPSBiYXNlW3dvcmtbc3ltXSAtIG1hdGNoXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGhlcmVfb3AgPSAzMiArIDY0OwogICAgICAgICAgICBoZXJlX3ZhbCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICBpbmNyID0gMSA8PCBsZW4gLSBkcm9wOwogICAgICAgICAgZmlsbCA9IDEgPDwgY3VycjsKICAgICAgICAgIG1pbjMgPSBmaWxsOwogICAgICAgICAgZG8gewogICAgICAgICAgICBmaWxsIC09IGluY3I7CiAgICAgICAgICAgIHRhYmxlW25leHQgKyAoaHVmZiA+PiBkcm9wKSArIGZpbGxdID0gaGVyZV9iaXRzIDw8IDI0IHwgaGVyZV9vcCA8PCAxNiB8IGhlcmVfdmFsIHwgMDsKICAgICAgICAgIH0gd2hpbGUgKGZpbGwgIT09IDApOwogICAgICAgICAgaW5jciA9IDEgPDwgbGVuIC0gMTsKICAgICAgICAgIHdoaWxlIChodWZmICYgaW5jcikgewogICAgICAgICAgICBpbmNyID4+PSAxOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGluY3IgIT09IDApIHsKICAgICAgICAgICAgaHVmZiAmPSBpbmNyIC0gMTsKICAgICAgICAgICAgaHVmZiArPSBpbmNyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaHVmZiA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICBzeW0rKzsKICAgICAgICAgIGlmICgtLWNvdW50W2xlbl0gPT09IDApIHsKICAgICAgICAgICAgaWYgKGxlbiA9PT0gbWF4MykgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxlbiA9IGxlbnNbbGVuc19pbmRleCArIHdvcmtbc3ltXV07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobGVuID4gcm9vdCAmJiAoaHVmZiAmIG1hc2spICE9PSBsb3cpIHsKICAgICAgICAgICAgaWYgKGRyb3AgPT09IDApIHsKICAgICAgICAgICAgICBkcm9wID0gcm9vdDsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0ICs9IG1pbjM7CiAgICAgICAgICAgIGN1cnIgPSBsZW4gLSBkcm9wOwogICAgICAgICAgICBsZWZ0ID0gMSA8PCBjdXJyOwogICAgICAgICAgICB3aGlsZSAoY3VyciArIGRyb3AgPCBtYXgzKSB7CiAgICAgICAgICAgICAgbGVmdCAtPSBjb3VudFtjdXJyICsgZHJvcF07CiAgICAgICAgICAgICAgaWYgKGxlZnQgPD0gMCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnIrKzsKICAgICAgICAgICAgICBsZWZ0IDw8PSAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVzZWQgKz0gMSA8PCBjdXJyOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gTEVOUyAmJiB1c2VkID4gRU5PVUdIX0xFTlMgfHwgdHlwZSA9PT0gRElTVFMgJiYgdXNlZCA+IEVOT1VHSF9ESVNUUykgewogICAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxvdyA9IGh1ZmYgJiBtYXNrOwogICAgICAgICAgICB0YWJsZVtsb3ddID0gcm9vdCA8PCAyNCB8IGN1cnIgPDwgMTYgfCBuZXh0IC0gdGFibGVfaW5kZXggfCAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaHVmZiAhPT0gMCkgewogICAgICAgICAgdGFibGVbbmV4dCArIGh1ZmZdID0gbGVuIC0gZHJvcCA8PCAyNCB8IDY0IDw8IDE2IHwgMDsKICAgICAgICB9CiAgICAgICAgb3B0cy5iaXRzID0gcm9vdDsKICAgICAgICByZXR1cm4gMDsKICAgICAgfTsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBpbmZsYXRlX3RhYmxlOwogICAgfQogIH0pOwoKICAvLyBub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi9jb25zdGFudHMuanMKICB2YXIgcmVxdWlyZV9jb25zdGFudHMgPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi9jb25zdGFudHMuanMiKGV4cG9ydHMyLCBtb2R1bGUpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgICAvKiBBbGxvd2VkIGZsdXNoIHZhbHVlczsgc2VlIGRlZmxhdGUoKSBhbmQgaW5mbGF0ZSgpIGJlbG93IGZvciBkZXRhaWxzICovCiAgICAgICAgWl9OT19GTFVTSDogMCwKICAgICAgICBaX1BBUlRJQUxfRkxVU0g6IDEsCiAgICAgICAgWl9TWU5DX0ZMVVNIOiAyLAogICAgICAgIFpfRlVMTF9GTFVTSDogMywKICAgICAgICBaX0ZJTklTSDogNCwKICAgICAgICBaX0JMT0NLOiA1LAogICAgICAgIFpfVFJFRVM6IDYsCiAgICAgICAgLyogUmV0dXJuIGNvZGVzIGZvciB0aGUgY29tcHJlc3Npb24vZGVjb21wcmVzc2lvbiBmdW5jdGlvbnMuIE5lZ2F0aXZlIHZhbHVlcwogICAgICAgICogYXJlIGVycm9ycywgcG9zaXRpdmUgdmFsdWVzIGFyZSB1c2VkIGZvciBzcGVjaWFsIGJ1dCBub3JtYWwgZXZlbnRzLgogICAgICAgICovCiAgICAgICAgWl9PSzogMCwKICAgICAgICBaX1NUUkVBTV9FTkQ6IDEsCiAgICAgICAgWl9ORUVEX0RJQ1Q6IDIsCiAgICAgICAgWl9FUlJOTzogLTEsCiAgICAgICAgWl9TVFJFQU1fRVJST1I6IC0yLAogICAgICAgIFpfREFUQV9FUlJPUjogLTMsCiAgICAgICAgWl9NRU1fRVJST1I6IC00LAogICAgICAgIFpfQlVGX0VSUk9SOiAtNSwKICAgICAgICAvL1pfVkVSU0lPTl9FUlJPUjogLTYsCiAgICAgICAgLyogY29tcHJlc3Npb24gbGV2ZWxzICovCiAgICAgICAgWl9OT19DT01QUkVTU0lPTjogMCwKICAgICAgICBaX0JFU1RfU1BFRUQ6IDEsCiAgICAgICAgWl9CRVNUX0NPTVBSRVNTSU9OOiA5LAogICAgICAgIFpfREVGQVVMVF9DT01QUkVTU0lPTjogLTEsCiAgICAgICAgWl9GSUxURVJFRDogMSwKICAgICAgICBaX0hVRkZNQU5fT05MWTogMiwKICAgICAgICBaX1JMRTogMywKICAgICAgICBaX0ZJWEVEOiA0LAogICAgICAgIFpfREVGQVVMVF9TVFJBVEVHWTogMCwKICAgICAgICAvKiBQb3NzaWJsZSB2YWx1ZXMgb2YgdGhlIGRhdGFfdHlwZSBmaWVsZCAodGhvdWdoIHNlZSBpbmZsYXRlKCkpICovCiAgICAgICAgWl9CSU5BUlk6IDAsCiAgICAgICAgWl9URVhUOiAxLAogICAgICAgIC8vWl9BU0NJSTogICAgICAgICAgICAgICAgMSwgLy8gPSBaX1RFWFQgKGRlcHJlY2F0ZWQpCiAgICAgICAgWl9VTktOT1dOOiAyLAogICAgICAgIC8qIFRoZSBkZWZsYXRlIGNvbXByZXNzaW9uIG1ldGhvZCAqLwogICAgICAgIFpfREVGTEFURUQ6IDgKICAgICAgICAvL1pfTlVMTDogICAgICAgICAgICAgICAgIG51bGwgLy8gVXNlIC0xIG9yIG51bGwgaW5saW5lLCBkZXBlbmRpbmcgb24gdmFyIHR5cGUKICAgICAgfTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvaW5mbGF0ZS5qcwogIHZhciByZXF1aXJlX2luZmxhdGUgPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi9pbmZsYXRlLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgdmFyIGFkbGVyMzIgPSByZXF1aXJlX2FkbGVyMzIoKTsKICAgICAgdmFyIGNyYzMyID0gcmVxdWlyZV9jcmMzMigpOwogICAgICB2YXIgaW5mbGF0ZV9mYXN0ID0gcmVxdWlyZV9pbmZmYXN0KCk7CiAgICAgIHZhciBpbmZsYXRlX3RhYmxlID0gcmVxdWlyZV9pbmZ0cmVlcygpOwogICAgICB2YXIgQ09ERVMgPSAwOwogICAgICB2YXIgTEVOUyA9IDE7CiAgICAgIHZhciBESVNUUyA9IDI7CiAgICAgIHZhciB7CiAgICAgICAgWl9GSU5JU0gsCiAgICAgICAgWl9CTE9DSywKICAgICAgICBaX1RSRUVTLAogICAgICAgIFpfT0ssCiAgICAgICAgWl9TVFJFQU1fRU5ELAogICAgICAgIFpfTkVFRF9ESUNULAogICAgICAgIFpfU1RSRUFNX0VSUk9SLAogICAgICAgIFpfREFUQV9FUlJPUiwKICAgICAgICBaX01FTV9FUlJPUiwKICAgICAgICBaX0JVRl9FUlJPUiwKICAgICAgICBaX0RFRkxBVEVECiAgICAgIH0gPSByZXF1aXJlX2NvbnN0YW50cygpOwogICAgICB2YXIgSEVBRCA9IDE2MTgwOwogICAgICB2YXIgRkxBR1MgPSAxNjE4MTsKICAgICAgdmFyIFRJTUUgPSAxNjE4MjsKICAgICAgdmFyIE9TID0gMTYxODM7CiAgICAgIHZhciBFWExFTiA9IDE2MTg0OwogICAgICB2YXIgRVhUUkEgPSAxNjE4NTsKICAgICAgdmFyIE5BTUUgPSAxNjE4NjsKICAgICAgdmFyIENPTU1FTlQgPSAxNjE4NzsKICAgICAgdmFyIEhDUkMgPSAxNjE4ODsKICAgICAgdmFyIERJQ1RJRCA9IDE2MTg5OwogICAgICB2YXIgRElDVCA9IDE2MTkwOwogICAgICB2YXIgVFlQRSA9IDE2MTkxOwogICAgICB2YXIgVFlQRURPID0gMTYxOTI7CiAgICAgIHZhciBTVE9SRUQgPSAxNjE5MzsKICAgICAgdmFyIENPUFlfID0gMTYxOTQ7CiAgICAgIHZhciBDT1BZID0gMTYxOTU7CiAgICAgIHZhciBUQUJMRSA9IDE2MTk2OwogICAgICB2YXIgTEVOTEVOUyA9IDE2MTk3OwogICAgICB2YXIgQ09ERUxFTlMgPSAxNjE5ODsKICAgICAgdmFyIExFTl8gPSAxNjE5OTsKICAgICAgdmFyIExFTiA9IDE2MjAwOwogICAgICB2YXIgTEVORVhUID0gMTYyMDE7CiAgICAgIHZhciBESVNUID0gMTYyMDI7CiAgICAgIHZhciBESVNURVhUID0gMTYyMDM7CiAgICAgIHZhciBNQVRDSCA9IDE2MjA0OwogICAgICB2YXIgTElUID0gMTYyMDU7CiAgICAgIHZhciBDSEVDSyA9IDE2MjA2OwogICAgICB2YXIgTEVOR1RIID0gMTYyMDc7CiAgICAgIHZhciBET05FID0gMTYyMDg7CiAgICAgIHZhciBCQUQgPSAxNjIwOTsKICAgICAgdmFyIE1FTSA9IDE2MjEwOwogICAgICB2YXIgU1lOQyA9IDE2MjExOwogICAgICB2YXIgRU5PVUdIX0xFTlMgPSA4NTI7CiAgICAgIHZhciBFTk9VR0hfRElTVFMgPSA1OTI7CiAgICAgIHZhciBNQVhfV0JJVFMgPSAxNTsKICAgICAgdmFyIERFRl9XQklUUyA9IE1BWF9XQklUUzsKICAgICAgdmFyIHpzd2FwMzIgPSAocSkgPT4gewogICAgICAgIHJldHVybiAocSA+Pj4gMjQgJiAyNTUpICsgKHEgPj4+IDggJiA2NTI4MCkgKyAoKHEgJiA2NTI4MCkgPDwgOCkgKyAoKHEgJiAyNTUpIDw8IDI0KTsKICAgICAgfTsKICAgICAgZnVuY3Rpb24gSW5mbGF0ZVN0YXRlKCkgewogICAgICAgIHRoaXMuc3RybSA9IG51bGw7CiAgICAgICAgdGhpcy5tb2RlID0gMDsKICAgICAgICB0aGlzLmxhc3QgPSBmYWxzZTsKICAgICAgICB0aGlzLndyYXAgPSAwOwogICAgICAgIHRoaXMuaGF2ZWRpY3QgPSBmYWxzZTsKICAgICAgICB0aGlzLmZsYWdzID0gMDsKICAgICAgICB0aGlzLmRtYXggPSAwOwogICAgICAgIHRoaXMuY2hlY2sgPSAwOwogICAgICAgIHRoaXMudG90YWwgPSAwOwogICAgICAgIHRoaXMuaGVhZCA9IG51bGw7CiAgICAgICAgdGhpcy53Yml0cyA9IDA7CiAgICAgICAgdGhpcy53c2l6ZSA9IDA7CiAgICAgICAgdGhpcy53aGF2ZSA9IDA7CiAgICAgICAgdGhpcy53bmV4dCA9IDA7CiAgICAgICAgdGhpcy53aW5kb3cgPSBudWxsOwogICAgICAgIHRoaXMuaG9sZCA9IDA7CiAgICAgICAgdGhpcy5iaXRzID0gMDsKICAgICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICAgICAgdGhpcy5vZmZzZXQgPSAwOwogICAgICAgIHRoaXMuZXh0cmEgPSAwOwogICAgICAgIHRoaXMubGVuY29kZSA9IG51bGw7CiAgICAgICAgdGhpcy5kaXN0Y29kZSA9IG51bGw7CiAgICAgICAgdGhpcy5sZW5iaXRzID0gMDsKICAgICAgICB0aGlzLmRpc3RiaXRzID0gMDsKICAgICAgICB0aGlzLm5jb2RlID0gMDsKICAgICAgICB0aGlzLm5sZW4gPSAwOwogICAgICAgIHRoaXMubmRpc3QgPSAwOwogICAgICAgIHRoaXMuaGF2ZSA9IDA7CiAgICAgICAgdGhpcy5uZXh0ID0gbnVsbDsKICAgICAgICB0aGlzLmxlbnMgPSBuZXcgVWludDE2QXJyYXkoMzIwKTsKICAgICAgICB0aGlzLndvcmsgPSBuZXcgVWludDE2QXJyYXkoMjg4KTsKICAgICAgICB0aGlzLmxlbmR5biA9IG51bGw7CiAgICAgICAgdGhpcy5kaXN0ZHluID0gbnVsbDsKICAgICAgICB0aGlzLnNhbmUgPSAwOwogICAgICAgIHRoaXMuYmFjayA9IDA7CiAgICAgICAgdGhpcy53YXMgPSAwOwogICAgICB9CiAgICAgIHZhciBpbmZsYXRlU3RhdGVDaGVjayA9IChzdHJtKSA9PiB7CiAgICAgICAgaWYgKCFzdHJtKSB7CiAgICAgICAgICByZXR1cm4gMTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc3RhdGUgPSBzdHJtLnN0YXRlOwogICAgICAgIGlmICghc3RhdGUgfHwgc3RhdGUuc3RybSAhPT0gc3RybSB8fCBzdGF0ZS5tb2RlIDwgSEVBRCB8fCBzdGF0ZS5tb2RlID4gU1lOQykgewogICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgfQogICAgICAgIHJldHVybiAwOwogICAgICB9OwogICAgICB2YXIgaW5mbGF0ZVJlc2V0S2VlcCA9IChzdHJtKSA9PiB7CiAgICAgICAgaWYgKGluZmxhdGVTdGF0ZUNoZWNrKHN0cm0pKSB7CiAgICAgICAgICByZXR1cm4gWl9TVFJFQU1fRVJST1I7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHN0YXRlID0gc3RybS5zdGF0ZTsKICAgICAgICBzdHJtLnRvdGFsX2luID0gc3RybS50b3RhbF9vdXQgPSBzdGF0ZS50b3RhbCA9IDA7CiAgICAgICAgc3RybS5tc2cgPSAiIjsKICAgICAgICBpZiAoc3RhdGUud3JhcCkgewogICAgICAgICAgc3RybS5hZGxlciA9IHN0YXRlLndyYXAgJiAxOwogICAgICAgIH0KICAgICAgICBzdGF0ZS5tb2RlID0gSEVBRDsKICAgICAgICBzdGF0ZS5sYXN0ID0gMDsKICAgICAgICBzdGF0ZS5oYXZlZGljdCA9IDA7CiAgICAgICAgc3RhdGUuZmxhZ3MgPSAtMTsKICAgICAgICBzdGF0ZS5kbWF4ID0gMzI3Njg7CiAgICAgICAgc3RhdGUuaGVhZCA9IG51bGw7CiAgICAgICAgc3RhdGUuaG9sZCA9IDA7CiAgICAgICAgc3RhdGUuYml0cyA9IDA7CiAgICAgICAgc3RhdGUubGVuY29kZSA9IHN0YXRlLmxlbmR5biA9IG5ldyBJbnQzMkFycmF5KEVOT1VHSF9MRU5TKTsKICAgICAgICBzdGF0ZS5kaXN0Y29kZSA9IHN0YXRlLmRpc3RkeW4gPSBuZXcgSW50MzJBcnJheShFTk9VR0hfRElTVFMpOwogICAgICAgIHN0YXRlLnNhbmUgPSAxOwogICAgICAgIHN0YXRlLmJhY2sgPSAtMTsKICAgICAgICByZXR1cm4gWl9PSzsKICAgICAgfTsKICAgICAgdmFyIGluZmxhdGVSZXNldCA9IChzdHJtKSA9PiB7CiAgICAgICAgaWYgKGluZmxhdGVTdGF0ZUNoZWNrKHN0cm0pKSB7CiAgICAgICAgICByZXR1cm4gWl9TVFJFQU1fRVJST1I7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHN0YXRlID0gc3RybS5zdGF0ZTsKICAgICAgICBzdGF0ZS53c2l6ZSA9IDA7CiAgICAgICAgc3RhdGUud2hhdmUgPSAwOwogICAgICAgIHN0YXRlLnduZXh0ID0gMDsKICAgICAgICByZXR1cm4gaW5mbGF0ZVJlc2V0S2VlcChzdHJtKTsKICAgICAgfTsKICAgICAgdmFyIGluZmxhdGVSZXNldDIgPSAoc3RybSwgd2luZG93Qml0cykgPT4gewogICAgICAgIGxldCB3cmFwOwogICAgICAgIGlmIChpbmZsYXRlU3RhdGVDaGVjayhzdHJtKSkgewogICAgICAgICAgcmV0dXJuIFpfU1RSRUFNX0VSUk9SOwogICAgICAgIH0KICAgICAgICBjb25zdCBzdGF0ZSA9IHN0cm0uc3RhdGU7CiAgICAgICAgaWYgKHdpbmRvd0JpdHMgPCAwKSB7CiAgICAgICAgICB3cmFwID0gMDsKICAgICAgICAgIHdpbmRvd0JpdHMgPSAtd2luZG93Qml0czsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgd3JhcCA9ICh3aW5kb3dCaXRzID4+IDQpICsgNTsKICAgICAgICAgIGlmICh3aW5kb3dCaXRzIDwgNDgpIHsKICAgICAgICAgICAgd2luZG93Qml0cyAmPSAxNTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHdpbmRvd0JpdHMgJiYgKHdpbmRvd0JpdHMgPCA4IHx8IHdpbmRvd0JpdHMgPiAxNSkpIHsKICAgICAgICAgIHJldHVybiBaX1NUUkVBTV9FUlJPUjsKICAgICAgICB9CiAgICAgICAgaWYgKHN0YXRlLndpbmRvdyAhPT0gbnVsbCAmJiBzdGF0ZS53Yml0cyAhPT0gd2luZG93Qml0cykgewogICAgICAgICAgc3RhdGUud2luZG93ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgc3RhdGUud3JhcCA9IHdyYXA7CiAgICAgICAgc3RhdGUud2JpdHMgPSB3aW5kb3dCaXRzOwogICAgICAgIHJldHVybiBpbmZsYXRlUmVzZXQoc3RybSk7CiAgICAgIH07CiAgICAgIHZhciBpbmZsYXRlSW5pdDIgPSAoc3RybSwgd2luZG93Qml0cykgPT4gewogICAgICAgIGlmICghc3RybSkgewogICAgICAgICAgcmV0dXJuIFpfU1RSRUFNX0VSUk9SOwogICAgICAgIH0KICAgICAgICBjb25zdCBzdGF0ZSA9IG5ldyBJbmZsYXRlU3RhdGUoKTsKICAgICAgICBzdHJtLnN0YXRlID0gc3RhdGU7CiAgICAgICAgc3RhdGUuc3RybSA9IHN0cm07CiAgICAgICAgc3RhdGUud2luZG93ID0gbnVsbDsKICAgICAgICBzdGF0ZS5tb2RlID0gSEVBRDsKICAgICAgICBjb25zdCByZXQgPSBpbmZsYXRlUmVzZXQyKHN0cm0sIHdpbmRvd0JpdHMpOwogICAgICAgIGlmIChyZXQgIT09IFpfT0spIHsKICAgICAgICAgIHN0cm0uc3RhdGUgPSBudWxsOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0OwogICAgICB9OwogICAgICB2YXIgaW5mbGF0ZUluaXQgPSAoc3RybSkgPT4gewogICAgICAgIHJldHVybiBpbmZsYXRlSW5pdDIoc3RybSwgREVGX1dCSVRTKTsKICAgICAgfTsKICAgICAgdmFyIHZpcmdpbiA9IHRydWU7CiAgICAgIHZhciBsZW5maXg7CiAgICAgIHZhciBkaXN0Zml4OwogICAgICB2YXIgZml4ZWR0YWJsZXMgPSAoc3RhdGUpID0+IHsKICAgICAgICBpZiAodmlyZ2luKSB7CiAgICAgICAgICBsZW5maXggPSBuZXcgSW50MzJBcnJheSg1MTIpOwogICAgICAgICAgZGlzdGZpeCA9IG5ldyBJbnQzMkFycmF5KDMyKTsKICAgICAgICAgIGxldCBzeW0gPSAwOwogICAgICAgICAgd2hpbGUgKHN5bSA8IDE0NCkgewogICAgICAgICAgICBzdGF0ZS5sZW5zW3N5bSsrXSA9IDg7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoc3ltIDwgMjU2KSB7CiAgICAgICAgICAgIHN0YXRlLmxlbnNbc3ltKytdID0gOTsKICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChzeW0gPCAyODApIHsKICAgICAgICAgICAgc3RhdGUubGVuc1tzeW0rK10gPSA3OwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKHN5bSA8IDI4OCkgewogICAgICAgICAgICBzdGF0ZS5sZW5zW3N5bSsrXSA9IDg7CiAgICAgICAgICB9CiAgICAgICAgICBpbmZsYXRlX3RhYmxlKExFTlMsIHN0YXRlLmxlbnMsIDAsIDI4OCwgbGVuZml4LCAwLCBzdGF0ZS53b3JrLCB7IGJpdHM6IDkgfSk7CiAgICAgICAgICBzeW0gPSAwOwogICAgICAgICAgd2hpbGUgKHN5bSA8IDMyKSB7CiAgICAgICAgICAgIHN0YXRlLmxlbnNbc3ltKytdID0gNTsKICAgICAgICAgIH0KICAgICAgICAgIGluZmxhdGVfdGFibGUoRElTVFMsIHN0YXRlLmxlbnMsIDAsIDMyLCBkaXN0Zml4LCAwLCBzdGF0ZS53b3JrLCB7IGJpdHM6IDUgfSk7CiAgICAgICAgICB2aXJnaW4gPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgc3RhdGUubGVuY29kZSA9IGxlbmZpeDsKICAgICAgICBzdGF0ZS5sZW5iaXRzID0gOTsKICAgICAgICBzdGF0ZS5kaXN0Y29kZSA9IGRpc3RmaXg7CiAgICAgICAgc3RhdGUuZGlzdGJpdHMgPSA1OwogICAgICB9OwogICAgICB2YXIgdXBkYXRld2luZG93ID0gKHN0cm0sIHNyYywgZW5kLCBjb3B5KSA9PiB7CiAgICAgICAgbGV0IGRpc3Q7CiAgICAgICAgY29uc3Qgc3RhdGUgPSBzdHJtLnN0YXRlOwogICAgICAgIGlmIChzdGF0ZS53aW5kb3cgPT09IG51bGwpIHsKICAgICAgICAgIHN0YXRlLndzaXplID0gMSA8PCBzdGF0ZS53Yml0czsKICAgICAgICAgIHN0YXRlLnduZXh0ID0gMDsKICAgICAgICAgIHN0YXRlLndoYXZlID0gMDsKICAgICAgICAgIHN0YXRlLndpbmRvdyA9IG5ldyBVaW50OEFycmF5KHN0YXRlLndzaXplKTsKICAgICAgICB9CiAgICAgICAgaWYgKGNvcHkgPj0gc3RhdGUud3NpemUpIHsKICAgICAgICAgIHN0YXRlLndpbmRvdy5zZXQoc3JjLnN1YmFycmF5KGVuZCAtIHN0YXRlLndzaXplLCBlbmQpLCAwKTsKICAgICAgICAgIHN0YXRlLnduZXh0ID0gMDsKICAgICAgICAgIHN0YXRlLndoYXZlID0gc3RhdGUud3NpemU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRpc3QgPSBzdGF0ZS53c2l6ZSAtIHN0YXRlLnduZXh0OwogICAgICAgICAgaWYgKGRpc3QgPiBjb3B5KSB7CiAgICAgICAgICAgIGRpc3QgPSBjb3B5OwogICAgICAgICAgfQogICAgICAgICAgc3RhdGUud2luZG93LnNldChzcmMuc3ViYXJyYXkoZW5kIC0gY29weSwgZW5kIC0gY29weSArIGRpc3QpLCBzdGF0ZS53bmV4dCk7CiAgICAgICAgICBjb3B5IC09IGRpc3Q7CiAgICAgICAgICBpZiAoY29weSkgewogICAgICAgICAgICBzdGF0ZS53aW5kb3cuc2V0KHNyYy5zdWJhcnJheShlbmQgLSBjb3B5LCBlbmQpLCAwKTsKICAgICAgICAgICAgc3RhdGUud25leHQgPSBjb3B5OwogICAgICAgICAgICBzdGF0ZS53aGF2ZSA9IHN0YXRlLndzaXplOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhdGUud25leHQgKz0gZGlzdDsKICAgICAgICAgICAgaWYgKHN0YXRlLnduZXh0ID09PSBzdGF0ZS53c2l6ZSkgewogICAgICAgICAgICAgIHN0YXRlLnduZXh0ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc3RhdGUud2hhdmUgPCBzdGF0ZS53c2l6ZSkgewogICAgICAgICAgICAgIHN0YXRlLndoYXZlICs9IGRpc3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH07CiAgICAgIHZhciBpbmZsYXRlID0gKHN0cm0sIGZsdXNoKSA9PiB7CiAgICAgICAgbGV0IHN0YXRlOwogICAgICAgIGxldCBpbnB1dCwgb3V0cHV0OwogICAgICAgIGxldCBuZXh0OwogICAgICAgIGxldCBwdXQ7CiAgICAgICAgbGV0IGhhdmUsIGxlZnQ7CiAgICAgICAgbGV0IGhvbGQ7CiAgICAgICAgbGV0IGJpdHM7CiAgICAgICAgbGV0IF9pbiwgX291dDsKICAgICAgICBsZXQgY29weTsKICAgICAgICBsZXQgZnJvbTsKICAgICAgICBsZXQgZnJvbV9zb3VyY2U7CiAgICAgICAgbGV0IGhlcmUgPSAwOwogICAgICAgIGxldCBoZXJlX2JpdHMsIGhlcmVfb3AsIGhlcmVfdmFsOwogICAgICAgIGxldCBsYXN0X2JpdHMsIGxhc3Rfb3AsIGxhc3RfdmFsOwogICAgICAgIGxldCBsZW47CiAgICAgICAgbGV0IHJldDsKICAgICAgICBjb25zdCBoYnVmID0gbmV3IFVpbnQ4QXJyYXkoNCk7CiAgICAgICAgbGV0IG9wdHM7CiAgICAgICAgbGV0IG47CiAgICAgICAgY29uc3Qgb3JkZXIgPSAoCiAgICAgICAgICAvKiBwZXJtdXRhdGlvbiBvZiBjb2RlIGxlbmd0aHMgKi8KICAgICAgICAgIG5ldyBVaW50OEFycmF5KFsxNiwgMTcsIDE4LCAwLCA4LCA3LCA5LCA2LCAxMCwgNSwgMTEsIDQsIDEyLCAzLCAxMywgMiwgMTQsIDEsIDE1XSkKICAgICAgICApOwogICAgICAgIGlmIChpbmZsYXRlU3RhdGVDaGVjayhzdHJtKSB8fCAhc3RybS5vdXRwdXQgfHwgIXN0cm0uaW5wdXQgJiYgc3RybS5hdmFpbF9pbiAhPT0gMCkgewogICAgICAgICAgcmV0dXJuIFpfU1RSRUFNX0VSUk9SOwogICAgICAgIH0KICAgICAgICBzdGF0ZSA9IHN0cm0uc3RhdGU7CiAgICAgICAgaWYgKHN0YXRlLm1vZGUgPT09IFRZUEUpIHsKICAgICAgICAgIHN0YXRlLm1vZGUgPSBUWVBFRE87CiAgICAgICAgfQogICAgICAgIHB1dCA9IHN0cm0ubmV4dF9vdXQ7CiAgICAgICAgb3V0cHV0ID0gc3RybS5vdXRwdXQ7CiAgICAgICAgbGVmdCA9IHN0cm0uYXZhaWxfb3V0OwogICAgICAgIG5leHQgPSBzdHJtLm5leHRfaW47CiAgICAgICAgaW5wdXQgPSBzdHJtLmlucHV0OwogICAgICAgIGhhdmUgPSBzdHJtLmF2YWlsX2luOwogICAgICAgIGhvbGQgPSBzdGF0ZS5ob2xkOwogICAgICAgIGJpdHMgPSBzdGF0ZS5iaXRzOwogICAgICAgIF9pbiA9IGhhdmU7CiAgICAgICAgX291dCA9IGxlZnQ7CiAgICAgICAgcmV0ID0gWl9PSzsKICAgICAgICBpbmZfbGVhdmU6CiAgICAgICAgICBmb3IgKDsgOyApIHsKICAgICAgICAgICAgc3dpdGNoIChzdGF0ZS5tb2RlKSB7CiAgICAgICAgICAgICAgY2FzZSBIRUFEOgogICAgICAgICAgICAgICAgaWYgKHN0YXRlLndyYXAgPT09IDApIHsKICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IFRZUEVETzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB3aGlsZSAoYml0cyA8IDE2KSB7CiAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhhdmUtLTsKICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChzdGF0ZS53cmFwICYgMiAmJiBob2xkID09PSAzNTYxNSkgewogICAgICAgICAgICAgICAgICBpZiAoc3RhdGUud2JpdHMgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBzdGF0ZS53Yml0cyA9IDE1OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHN0YXRlLmNoZWNrID0gMDsKICAgICAgICAgICAgICAgICAgaGJ1ZlswXSA9IGhvbGQgJiAyNTU7CiAgICAgICAgICAgICAgICAgIGhidWZbMV0gPSBob2xkID4+PiA4ICYgMjU1OwogICAgICAgICAgICAgICAgICBzdGF0ZS5jaGVjayA9IGNyYzMyKHN0YXRlLmNoZWNrLCBoYnVmLCAyLCAwKTsKICAgICAgICAgICAgICAgICAgaG9sZCA9IDA7CiAgICAgICAgICAgICAgICAgIGJpdHMgPSAwOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gRkxBR1M7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmhlYWQpIHsKICAgICAgICAgICAgICAgICAgc3RhdGUuaGVhZC5kb25lID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIShzdGF0ZS53cmFwICYgMSkgfHwgLyogY2hlY2sgaWYgemxpYiBoZWFkZXIgYWxsb3dlZCAqLwogICAgICAgICAgICAgICAgKCgoaG9sZCAmIDI1NSkgPDwgOCkgKyAoaG9sZCA+PiA4KSkgJSAzMSkgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbmNvcnJlY3QgaGVhZGVyIGNoZWNrIjsKICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoKGhvbGQgJiAxNSkgIT09IFpfREVGTEFURUQpIHsKICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAidW5rbm93biBjb21wcmVzc2lvbiBtZXRob2QiOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhvbGQgPj4+PSA0OwogICAgICAgICAgICAgICAgYml0cyAtPSA0OwogICAgICAgICAgICAgICAgbGVuID0gKGhvbGQgJiAxNSkgKyA4OwogICAgICAgICAgICAgICAgaWYgKHN0YXRlLndiaXRzID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIHN0YXRlLndiaXRzID0gbGVuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGxlbiA+IDE1IHx8IGxlbiA+IHN0YXRlLndiaXRzKSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImludmFsaWQgd2luZG93IHNpemUiOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLmRtYXggPSAxIDw8IHN0YXRlLndiaXRzOwogICAgICAgICAgICAgICAgc3RhdGUuZmxhZ3MgPSAwOwogICAgICAgICAgICAgICAgc3RybS5hZGxlciA9IHN0YXRlLmNoZWNrID0gMTsKICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBob2xkICYgNTEyID8gRElDVElEIDogVFlQRTsKICAgICAgICAgICAgICAgIGhvbGQgPSAwOwogICAgICAgICAgICAgICAgYml0cyA9IDA7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEZMQUdTOgogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAxNikgewogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdGF0ZS5mbGFncyA9IGhvbGQ7CiAgICAgICAgICAgICAgICBpZiAoKHN0YXRlLmZsYWdzICYgMjU1KSAhPT0gWl9ERUZMQVRFRCkgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJ1bmtub3duIGNvbXByZXNzaW9uIG1ldGhvZCI7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmZsYWdzICYgNTczNDQpIHsKICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAidW5rbm93biBoZWFkZXIgZmxhZ3Mgc2V0IjsKICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuaGVhZCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLnRleHQgPSBob2xkID4+IDggJiAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmZsYWdzICYgNTEyICYmIHN0YXRlLndyYXAgJiA0KSB7CiAgICAgICAgICAgICAgICAgIGhidWZbMF0gPSBob2xkICYgMjU1OwogICAgICAgICAgICAgICAgICBoYnVmWzFdID0gaG9sZCA+Pj4gOCAmIDI1NTsKICAgICAgICAgICAgICAgICAgc3RhdGUuY2hlY2sgPSBjcmMzMihzdGF0ZS5jaGVjaywgaGJ1ZiwgMiwgMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBob2xkID0gMDsKICAgICAgICAgICAgICAgIGJpdHMgPSAwOwogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IFRJTUU7CiAgICAgICAgICAgICAgY2FzZSBUSU1FOgogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAzMikgewogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuaGVhZCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLnRpbWUgPSBob2xkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmZsYWdzICYgNTEyICYmIHN0YXRlLndyYXAgJiA0KSB7CiAgICAgICAgICAgICAgICAgIGhidWZbMF0gPSBob2xkICYgMjU1OwogICAgICAgICAgICAgICAgICBoYnVmWzFdID0gaG9sZCA+Pj4gOCAmIDI1NTsKICAgICAgICAgICAgICAgICAgaGJ1ZlsyXSA9IGhvbGQgPj4+IDE2ICYgMjU1OwogICAgICAgICAgICAgICAgICBoYnVmWzNdID0gaG9sZCA+Pj4gMjQgJiAyNTU7CiAgICAgICAgICAgICAgICAgIHN0YXRlLmNoZWNrID0gY3JjMzIoc3RhdGUuY2hlY2ssIGhidWYsIDQsIDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaG9sZCA9IDA7CiAgICAgICAgICAgICAgICBiaXRzID0gMDsKICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBPUzsKICAgICAgICAgICAgICBjYXNlIE9TOgogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAxNikgewogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuaGVhZCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLnhmbGFncyA9IGhvbGQgJiAyNTU7CiAgICAgICAgICAgICAgICAgIHN0YXRlLmhlYWQub3MgPSBob2xkID4+IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZmxhZ3MgJiA1MTIgJiYgc3RhdGUud3JhcCAmIDQpIHsKICAgICAgICAgICAgICAgICAgaGJ1ZlswXSA9IGhvbGQgJiAyNTU7CiAgICAgICAgICAgICAgICAgIGhidWZbMV0gPSBob2xkID4+PiA4ICYgMjU1OwogICAgICAgICAgICAgICAgICBzdGF0ZS5jaGVjayA9IGNyYzMyKHN0YXRlLmNoZWNrLCBoYnVmLCAyLCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhvbGQgPSAwOwogICAgICAgICAgICAgICAgYml0cyA9IDA7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gRVhMRU47CiAgICAgICAgICAgICAgY2FzZSBFWExFTjoKICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5mbGFncyAmIDEwMjQpIHsKICAgICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAxNikgewogICAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGhhdmUtLTsKICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W25leHQrK10gPDwgYml0czsKICAgICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc3RhdGUubGVuZ3RoID0gaG9sZDsKICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmhlYWQpIHsKICAgICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLmV4dHJhX2xlbiA9IGhvbGQ7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmZsYWdzICYgNTEyICYmIHN0YXRlLndyYXAgJiA0KSB7CiAgICAgICAgICAgICAgICAgICAgaGJ1ZlswXSA9IGhvbGQgJiAyNTU7CiAgICAgICAgICAgICAgICAgICAgaGJ1ZlsxXSA9IGhvbGQgPj4+IDggJiAyNTU7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUuY2hlY2sgPSBjcmMzMihzdGF0ZS5jaGVjaywgaGJ1ZiwgMiwgMCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaG9sZCA9IDA7CiAgICAgICAgICAgICAgICAgIGJpdHMgPSAwOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZS5oZWFkKSB7CiAgICAgICAgICAgICAgICAgIHN0YXRlLmhlYWQuZXh0cmEgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEVYVFJBOwogICAgICAgICAgICAgIGNhc2UgRVhUUkE6CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZmxhZ3MgJiAxMDI0KSB7CiAgICAgICAgICAgICAgICAgIGNvcHkgPSBzdGF0ZS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgIGlmIChjb3B5ID4gaGF2ZSkgewogICAgICAgICAgICAgICAgICAgIGNvcHkgPSBoYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChjb3B5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmhlYWQpIHsKICAgICAgICAgICAgICAgICAgICAgIGxlbiA9IHN0YXRlLmhlYWQuZXh0cmFfbGVuIC0gc3RhdGUubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgaWYgKCFzdGF0ZS5oZWFkLmV4dHJhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmhlYWQuZXh0cmEgPSBuZXcgVWludDhBcnJheShzdGF0ZS5oZWFkLmV4dHJhX2xlbik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLmV4dHJhLnNldCgKICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQuc3ViYXJyYXkoCiAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dCwKICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBleHRyYSBmaWVsZCBpcyBsaW1pdGVkIHRvIDY1NTM2IGJ5dGVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSBubyBuZWVkIGZvciBhZGRpdGlvbmFsIHNpemUgY2hlY2sKICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0ICsgY29weQogICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICAvKmxlbiArIGNvcHkgPiBzdGF0ZS5oZWFkLmV4dHJhX21heCAtIGxlbiA/IHN0YXRlLmhlYWQuZXh0cmFfbWF4IDogY29weSwqLwogICAgICAgICAgICAgICAgICAgICAgICBsZW4KICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5mbGFncyAmIDUxMiAmJiBzdGF0ZS53cmFwICYgNCkgewogICAgICAgICAgICAgICAgICAgICAgc3RhdGUuY2hlY2sgPSBjcmMzMihzdGF0ZS5jaGVjaywgaW5wdXQsIGNvcHksIG5leHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYXZlIC09IGNvcHk7CiAgICAgICAgICAgICAgICAgICAgbmV4dCArPSBjb3B5OwogICAgICAgICAgICAgICAgICAgIHN0YXRlLmxlbmd0aCAtPSBjb3B5OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gTkFNRTsKICAgICAgICAgICAgICBjYXNlIE5BTUU6CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZmxhZ3MgJiAyMDQ4KSB7CiAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNvcHkgPSAwOwogICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgbGVuID0gaW5wdXRbbmV4dCArIGNvcHkrK107CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmhlYWQgJiYgbGVuICYmIHN0YXRlLmxlbmd0aCA8IDY1NTM2KSB7CiAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLm5hbWUgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShsZW4pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSB3aGlsZSAobGVuICYmIGNvcHkgPCBoYXZlKTsKICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmZsYWdzICYgNTEyICYmIHN0YXRlLndyYXAgJiA0KSB7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUuY2hlY2sgPSBjcmMzMihzdGF0ZS5jaGVjaywgaW5wdXQsIGNvcHksIG5leHQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhhdmUgLT0gY29weTsKICAgICAgICAgICAgICAgICAgbmV4dCArPSBjb3B5OwogICAgICAgICAgICAgICAgICBpZiAobGVuKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLmhlYWQpIHsKICAgICAgICAgICAgICAgICAgc3RhdGUuaGVhZC5uYW1lID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQ09NTUVOVDsKICAgICAgICAgICAgICBjYXNlIENPTU1FTlQ6CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZmxhZ3MgJiA0MDk2KSB7CiAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNvcHkgPSAwOwogICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgbGVuID0gaW5wdXRbbmV4dCArIGNvcHkrK107CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmhlYWQgJiYgbGVuICYmIHN0YXRlLmxlbmd0aCA8IDY1NTM2KSB7CiAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLmNvbW1lbnQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShsZW4pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSB3aGlsZSAobGVuICYmIGNvcHkgPCBoYXZlKTsKICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmZsYWdzICYgNTEyICYmIHN0YXRlLndyYXAgJiA0KSB7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUuY2hlY2sgPSBjcmMzMihzdGF0ZS5jaGVjaywgaW5wdXQsIGNvcHksIG5leHQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhhdmUgLT0gY29weTsKICAgICAgICAgICAgICAgICAgbmV4dCArPSBjb3B5OwogICAgICAgICAgICAgICAgICBpZiAobGVuKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLmhlYWQpIHsKICAgICAgICAgICAgICAgICAgc3RhdGUuaGVhZC5jb21tZW50ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBIQ1JDOwogICAgICAgICAgICAgIGNhc2UgSENSQzoKICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5mbGFncyAmIDUxMikgewogICAgICAgICAgICAgICAgICB3aGlsZSAoYml0cyA8IDE2KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhdmUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaGF2ZS0tOwogICAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoc3RhdGUud3JhcCAmIDQgJiYgaG9sZCAhPT0gKHN0YXRlLmNoZWNrICYgNjU1MzUpKSB7CiAgICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaGVhZGVyIGNyYyBtaXNtYXRjaCI7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBob2xkID0gMDsKICAgICAgICAgICAgICAgICAgYml0cyA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuaGVhZCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLmhjcmMgPSBzdGF0ZS5mbGFncyA+PiA5ICYgMTsKICAgICAgICAgICAgICAgICAgc3RhdGUuaGVhZC5kb25lID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0cm0uYWRsZXIgPSBzdGF0ZS5jaGVjayA9IDA7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gVFlQRTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgRElDVElEOgogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAzMikgewogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdHJtLmFkbGVyID0gc3RhdGUuY2hlY2sgPSB6c3dhcDMyKGhvbGQpOwogICAgICAgICAgICAgICAgaG9sZCA9IDA7CiAgICAgICAgICAgICAgICBiaXRzID0gMDsKICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBESUNUOwogICAgICAgICAgICAgIGNhc2UgRElDVDoKICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5oYXZlZGljdCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBzdHJtLm5leHRfb3V0ID0gcHV0OwogICAgICAgICAgICAgICAgICBzdHJtLmF2YWlsX291dCA9IGxlZnQ7CiAgICAgICAgICAgICAgICAgIHN0cm0ubmV4dF9pbiA9IG5leHQ7CiAgICAgICAgICAgICAgICAgIHN0cm0uYXZhaWxfaW4gPSBoYXZlOwogICAgICAgICAgICAgICAgICBzdGF0ZS5ob2xkID0gaG9sZDsKICAgICAgICAgICAgICAgICAgc3RhdGUuYml0cyA9IGJpdHM7CiAgICAgICAgICAgICAgICAgIHJldHVybiBaX05FRURfRElDVDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0cm0uYWRsZXIgPSBzdGF0ZS5jaGVjayA9IDE7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gVFlQRTsKICAgICAgICAgICAgICBjYXNlIFRZUEU6CiAgICAgICAgICAgICAgICBpZiAoZmx1c2ggPT09IFpfQkxPQ0sgfHwgZmx1c2ggPT09IFpfVFJFRVMpIHsKICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgVFlQRURPOgogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmxhc3QpIHsKICAgICAgICAgICAgICAgICAgaG9sZCA+Pj49IGJpdHMgJiA3OwogICAgICAgICAgICAgICAgICBiaXRzIC09IGJpdHMgJiA3OwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQ0hFQ0s7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAzKSB7CiAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhhdmUtLTsKICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLmxhc3QgPSBob2xkICYgMTsKICAgICAgICAgICAgICAgIGhvbGQgPj4+PSAxOwogICAgICAgICAgICAgICAgYml0cyAtPSAxOwogICAgICAgICAgICAgICAgc3dpdGNoIChob2xkICYgMykgewogICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IFNUT1JFRDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgICAgIGZpeGVkdGFibGVzKHN0YXRlKTsKICAgICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gTEVOXzsKICAgICAgICAgICAgICAgICAgICBpZiAoZmx1c2ggPT09IFpfVFJFRVMpIHsKICAgICAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSAyOwogICAgICAgICAgICAgICAgICAgICAgYml0cyAtPSAyOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBUQUJMRTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImludmFsaWQgYmxvY2sgdHlwZSI7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhvbGQgPj4+PSAyOwogICAgICAgICAgICAgICAgYml0cyAtPSAyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBTVE9SRUQ6CiAgICAgICAgICAgICAgICBob2xkID4+Pj0gYml0cyAmIDc7CiAgICAgICAgICAgICAgICBiaXRzIC09IGJpdHMgJiA3OwogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAzMikgewogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoKGhvbGQgJiA2NTUzNSkgIT09IChob2xkID4+PiAxNiBeIDY1NTM1KSkgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIHN0b3JlZCBibG9jayBsZW5ndGhzIjsKICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdGF0ZS5sZW5ndGggPSBob2xkICYgNjU1MzU7CiAgICAgICAgICAgICAgICBob2xkID0gMDsKICAgICAgICAgICAgICAgIGJpdHMgPSAwOwogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IENPUFlfOwogICAgICAgICAgICAgICAgaWYgKGZsdXNoID09PSBaX1RSRUVTKSB7CiAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENPUFlfOgogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IENPUFk7CiAgICAgICAgICAgICAgY2FzZSBDT1BZOgogICAgICAgICAgICAgICAgY29weSA9IHN0YXRlLmxlbmd0aDsKICAgICAgICAgICAgICAgIGlmIChjb3B5KSB7CiAgICAgICAgICAgICAgICAgIGlmIChjb3B5ID4gaGF2ZSkgewogICAgICAgICAgICAgICAgICAgIGNvcHkgPSBoYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChjb3B5ID4gbGVmdCkgewogICAgICAgICAgICAgICAgICAgIGNvcHkgPSBsZWZ0OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChjb3B5ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIG91dHB1dC5zZXQoaW5wdXQuc3ViYXJyYXkobmV4dCwgbmV4dCArIGNvcHkpLCBwdXQpOwogICAgICAgICAgICAgICAgICBoYXZlIC09IGNvcHk7CiAgICAgICAgICAgICAgICAgIG5leHQgKz0gY29weTsKICAgICAgICAgICAgICAgICAgbGVmdCAtPSBjb3B5OwogICAgICAgICAgICAgICAgICBwdXQgKz0gY29weTsKICAgICAgICAgICAgICAgICAgc3RhdGUubGVuZ3RoIC09IGNvcHk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IFRZUEU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIFRBQkxFOgogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAxNCkgewogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdGF0ZS5ubGVuID0gKGhvbGQgJiAzMSkgKyAyNTc7CiAgICAgICAgICAgICAgICBob2xkID4+Pj0gNTsKICAgICAgICAgICAgICAgIGJpdHMgLT0gNTsKICAgICAgICAgICAgICAgIHN0YXRlLm5kaXN0ID0gKGhvbGQgJiAzMSkgKyAxOwogICAgICAgICAgICAgICAgaG9sZCA+Pj49IDU7CiAgICAgICAgICAgICAgICBiaXRzIC09IDU7CiAgICAgICAgICAgICAgICBzdGF0ZS5uY29kZSA9IChob2xkICYgMTUpICsgNDsKICAgICAgICAgICAgICAgIGhvbGQgPj4+PSA0OwogICAgICAgICAgICAgICAgYml0cyAtPSA0OwogICAgICAgICAgICAgICAgaWYgKHN0YXRlLm5sZW4gPiAyODYgfHwgc3RhdGUubmRpc3QgPiAzMCkgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJ0b28gbWFueSBsZW5ndGggb3IgZGlzdGFuY2Ugc3ltYm9scyI7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUuaGF2ZSA9IDA7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gTEVOTEVOUzsKICAgICAgICAgICAgICBjYXNlIExFTkxFTlM6CiAgICAgICAgICAgICAgICB3aGlsZSAoc3RhdGUuaGF2ZSA8IHN0YXRlLm5jb2RlKSB7CiAgICAgICAgICAgICAgICAgIHdoaWxlIChiaXRzIDwgMykgewogICAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGhhdmUtLTsKICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W25leHQrK10gPDwgYml0czsKICAgICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc3RhdGUubGVuc1tvcmRlcltzdGF0ZS5oYXZlKytdXSA9IGhvbGQgJiA3OwogICAgICAgICAgICAgICAgICBob2xkID4+Pj0gMzsKICAgICAgICAgICAgICAgICAgYml0cyAtPSAzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2hpbGUgKHN0YXRlLmhhdmUgPCAxOSkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5sZW5zW29yZGVyW3N0YXRlLmhhdmUrK11dID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLmxlbmNvZGUgPSBzdGF0ZS5sZW5keW47CiAgICAgICAgICAgICAgICBzdGF0ZS5sZW5iaXRzID0gNzsKICAgICAgICAgICAgICAgIG9wdHMgPSB7IGJpdHM6IHN0YXRlLmxlbmJpdHMgfTsKICAgICAgICAgICAgICAgIHJldCA9IGluZmxhdGVfdGFibGUoQ09ERVMsIHN0YXRlLmxlbnMsIDAsIDE5LCBzdGF0ZS5sZW5jb2RlLCAwLCBzdGF0ZS53b3JrLCBvcHRzKTsKICAgICAgICAgICAgICAgIHN0YXRlLmxlbmJpdHMgPSBvcHRzLmJpdHM7CiAgICAgICAgICAgICAgICBpZiAocmV0KSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImludmFsaWQgY29kZSBsZW5ndGhzIHNldCI7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUuaGF2ZSA9IDA7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQ09ERUxFTlM7CiAgICAgICAgICAgICAgY2FzZSBDT0RFTEVOUzoKICAgICAgICAgICAgICAgIHdoaWxlIChzdGF0ZS5oYXZlIDwgc3RhdGUubmxlbiArIHN0YXRlLm5kaXN0KSB7CiAgICAgICAgICAgICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgICAgICAgICAgIGhlcmUgPSBzdGF0ZS5sZW5jb2RlW2hvbGQgJiAoMSA8PCBzdGF0ZS5sZW5iaXRzKSAtIDFdOwogICAgICAgICAgICAgICAgICAgIGhlcmVfYml0cyA9IGhlcmUgPj4+IDI0OwogICAgICAgICAgICAgICAgICAgIGhlcmVfb3AgPSBoZXJlID4+PiAxNiAmIDI1NTsKICAgICAgICAgICAgICAgICAgICBoZXJlX3ZhbCA9IGhlcmUgJiA2NTUzNTsKICAgICAgICAgICAgICAgICAgICBpZiAoaGVyZV9iaXRzIDw9IGJpdHMpIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChoZXJlX3ZhbCA8IDE2KSB7CiAgICAgICAgICAgICAgICAgICAgaG9sZCA+Pj49IGhlcmVfYml0czsKICAgICAgICAgICAgICAgICAgICBiaXRzIC09IGhlcmVfYml0czsKICAgICAgICAgICAgICAgICAgICBzdGF0ZS5sZW5zW3N0YXRlLmhhdmUrK10gPSBoZXJlX3ZhbDsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaGVyZV92YWwgPT09IDE2KSB7CiAgICAgICAgICAgICAgICAgICAgICBuID0gaGVyZV9iaXRzICsgMjsKICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChiaXRzIDwgbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBob2xkID4+Pj0gaGVyZV9iaXRzOwogICAgICAgICAgICAgICAgICAgICAgYml0cyAtPSBoZXJlX2JpdHM7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIGJpdCBsZW5ndGggcmVwZWF0IjsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBsZW4gPSBzdGF0ZS5sZW5zW3N0YXRlLmhhdmUgLSAxXTsKICAgICAgICAgICAgICAgICAgICAgIGNvcHkgPSAzICsgKGhvbGQgJiAzKTsKICAgICAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSAyOwogICAgICAgICAgICAgICAgICAgICAgYml0cyAtPSAyOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGVyZV92YWwgPT09IDE3KSB7CiAgICAgICAgICAgICAgICAgICAgICBuID0gaGVyZV9iaXRzICsgMzsKICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChiaXRzIDwgbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBob2xkID4+Pj0gaGVyZV9iaXRzOwogICAgICAgICAgICAgICAgICAgICAgYml0cyAtPSBoZXJlX2JpdHM7CiAgICAgICAgICAgICAgICAgICAgICBsZW4gPSAwOwogICAgICAgICAgICAgICAgICAgICAgY29weSA9IDMgKyAoaG9sZCAmIDcpOwogICAgICAgICAgICAgICAgICAgICAgaG9sZCA+Pj49IDM7CiAgICAgICAgICAgICAgICAgICAgICBiaXRzIC09IDM7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIG4gPSBoZXJlX2JpdHMgKyA3OwogICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCBuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGhhdmUtLTsKICAgICAgICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBoZXJlX2JpdHM7CiAgICAgICAgICAgICAgICAgICAgICBiaXRzIC09IGhlcmVfYml0czsKICAgICAgICAgICAgICAgICAgICAgIGxlbiA9IDA7CiAgICAgICAgICAgICAgICAgICAgICBjb3B5ID0gMTEgKyAoaG9sZCAmIDEyNyk7CiAgICAgICAgICAgICAgICAgICAgICBob2xkID4+Pj0gNzsKICAgICAgICAgICAgICAgICAgICAgIGJpdHMgLT0gNzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmhhdmUgKyBjb3B5ID4gc3RhdGUubmxlbiArIHN0YXRlLm5kaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIGJpdCBsZW5ndGggcmVwZWF0IjsKICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGNvcHktLSkgewogICAgICAgICAgICAgICAgICAgICAgc3RhdGUubGVuc1tzdGF0ZS5oYXZlKytdID0gbGVuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlLm1vZGUgPT09IEJBRCkgewogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5sZW5zWzI1Nl0gPT09IDApIHsKICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW52YWxpZCBjb2RlIC0tIG1pc3NpbmcgZW5kLW9mLWJsb2NrIjsKICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdGF0ZS5sZW5iaXRzID0gOTsKICAgICAgICAgICAgICAgIG9wdHMgPSB7IGJpdHM6IHN0YXRlLmxlbmJpdHMgfTsKICAgICAgICAgICAgICAgIHJldCA9IGluZmxhdGVfdGFibGUoTEVOUywgc3RhdGUubGVucywgMCwgc3RhdGUubmxlbiwgc3RhdGUubGVuY29kZSwgMCwgc3RhdGUud29yaywgb3B0cyk7CiAgICAgICAgICAgICAgICBzdGF0ZS5sZW5iaXRzID0gb3B0cy5iaXRzOwogICAgICAgICAgICAgICAgaWYgKHJldCkgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIGxpdGVyYWwvbGVuZ3RocyBzZXQiOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLmRpc3RiaXRzID0gNjsKICAgICAgICAgICAgICAgIHN0YXRlLmRpc3Rjb2RlID0gc3RhdGUuZGlzdGR5bjsKICAgICAgICAgICAgICAgIG9wdHMgPSB7IGJpdHM6IHN0YXRlLmRpc3RiaXRzIH07CiAgICAgICAgICAgICAgICByZXQgPSBpbmZsYXRlX3RhYmxlKERJU1RTLCBzdGF0ZS5sZW5zLCBzdGF0ZS5ubGVuLCBzdGF0ZS5uZGlzdCwgc3RhdGUuZGlzdGNvZGUsIDAsIHN0YXRlLndvcmssIG9wdHMpOwogICAgICAgICAgICAgICAgc3RhdGUuZGlzdGJpdHMgPSBvcHRzLmJpdHM7CiAgICAgICAgICAgICAgICBpZiAocmV0KSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImludmFsaWQgZGlzdGFuY2VzIHNldCI7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IExFTl87CiAgICAgICAgICAgICAgICBpZiAoZmx1c2ggPT09IFpfVFJFRVMpIHsKICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgTEVOXzoKICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBMRU47CiAgICAgICAgICAgICAgY2FzZSBMRU46CiAgICAgICAgICAgICAgICBpZiAoaGF2ZSA+PSA2ICYmIGxlZnQgPj0gMjU4KSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubmV4dF9vdXQgPSBwdXQ7CiAgICAgICAgICAgICAgICAgIHN0cm0uYXZhaWxfb3V0ID0gbGVmdDsKICAgICAgICAgICAgICAgICAgc3RybS5uZXh0X2luID0gbmV4dDsKICAgICAgICAgICAgICAgICAgc3RybS5hdmFpbF9pbiA9IGhhdmU7CiAgICAgICAgICAgICAgICAgIHN0YXRlLmhvbGQgPSBob2xkOwogICAgICAgICAgICAgICAgICBzdGF0ZS5iaXRzID0gYml0czsKICAgICAgICAgICAgICAgICAgaW5mbGF0ZV9mYXN0KHN0cm0sIF9vdXQpOwogICAgICAgICAgICAgICAgICBwdXQgPSBzdHJtLm5leHRfb3V0OwogICAgICAgICAgICAgICAgICBvdXRwdXQgPSBzdHJtLm91dHB1dDsKICAgICAgICAgICAgICAgICAgbGVmdCA9IHN0cm0uYXZhaWxfb3V0OwogICAgICAgICAgICAgICAgICBuZXh0ID0gc3RybS5uZXh0X2luOwogICAgICAgICAgICAgICAgICBpbnB1dCA9IHN0cm0uaW5wdXQ7CiAgICAgICAgICAgICAgICAgIGhhdmUgPSBzdHJtLmF2YWlsX2luOwogICAgICAgICAgICAgICAgICBob2xkID0gc3RhdGUuaG9sZDsKICAgICAgICAgICAgICAgICAgYml0cyA9IHN0YXRlLmJpdHM7CiAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5tb2RlID09PSBUWVBFKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUuYmFjayA9IC0xOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUuYmFjayA9IDA7CiAgICAgICAgICAgICAgICBmb3IgKDsgOyApIHsKICAgICAgICAgICAgICAgICAgaGVyZSA9IHN0YXRlLmxlbmNvZGVbaG9sZCAmICgxIDw8IHN0YXRlLmxlbmJpdHMpIC0gMV07CiAgICAgICAgICAgICAgICAgIGhlcmVfYml0cyA9IGhlcmUgPj4+IDI0OwogICAgICAgICAgICAgICAgICBoZXJlX29wID0gaGVyZSA+Pj4gMTYgJiAyNTU7CiAgICAgICAgICAgICAgICAgIGhlcmVfdmFsID0gaGVyZSAmIDY1NTM1OwogICAgICAgICAgICAgICAgICBpZiAoaGVyZV9iaXRzIDw9IGJpdHMpIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaGVyZV9vcCAmJiAoaGVyZV9vcCAmIDI0MCkgPT09IDApIHsKICAgICAgICAgICAgICAgICAgbGFzdF9iaXRzID0gaGVyZV9iaXRzOwogICAgICAgICAgICAgICAgICBsYXN0X29wID0gaGVyZV9vcDsKICAgICAgICAgICAgICAgICAgbGFzdF92YWwgPSBoZXJlX3ZhbDsKICAgICAgICAgICAgICAgICAgZm9yICg7IDsgKSB7CiAgICAgICAgICAgICAgICAgICAgaGVyZSA9IHN0YXRlLmxlbmNvZGVbbGFzdF92YWwgKyAoKGhvbGQgJiAoMSA8PCBsYXN0X2JpdHMgKyBsYXN0X29wKSAtIDEpID4+IGxhc3RfYml0cyldOwogICAgICAgICAgICAgICAgICAgIGhlcmVfYml0cyA9IGhlcmUgPj4+IDI0OwogICAgICAgICAgICAgICAgICAgIGhlcmVfb3AgPSBoZXJlID4+PiAxNiAmIDI1NTsKICAgICAgICAgICAgICAgICAgICBoZXJlX3ZhbCA9IGhlcmUgJiA2NTUzNTsKICAgICAgICAgICAgICAgICAgICBpZiAobGFzdF9iaXRzICsgaGVyZV9iaXRzIDw9IGJpdHMpIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBsYXN0X2JpdHM7CiAgICAgICAgICAgICAgICAgIGJpdHMgLT0gbGFzdF9iaXRzOwogICAgICAgICAgICAgICAgICBzdGF0ZS5iYWNrICs9IGxhc3RfYml0czsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBoZXJlX2JpdHM7CiAgICAgICAgICAgICAgICBiaXRzIC09IGhlcmVfYml0czsKICAgICAgICAgICAgICAgIHN0YXRlLmJhY2sgKz0gaGVyZV9iaXRzOwogICAgICAgICAgICAgICAgc3RhdGUubGVuZ3RoID0gaGVyZV92YWw7CiAgICAgICAgICAgICAgICBpZiAoaGVyZV9vcCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gTElUOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChoZXJlX29wICYgMzIpIHsKICAgICAgICAgICAgICAgICAgc3RhdGUuYmFjayA9IC0xOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gVFlQRTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaGVyZV9vcCAmIDY0KSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImludmFsaWQgbGl0ZXJhbC9sZW5ndGggY29kZSI7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUuZXh0cmEgPSBoZXJlX29wICYgMTU7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gTEVORVhUOwogICAgICAgICAgICAgIGNhc2UgTEVORVhUOgogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmV4dHJhKSB7CiAgICAgICAgICAgICAgICAgIG4gPSBzdGF0ZS5leHRyYTsKICAgICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCBuKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhdmUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaGF2ZS0tOwogICAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzdGF0ZS5sZW5ndGggKz0gaG9sZCAmICgxIDw8IHN0YXRlLmV4dHJhKSAtIDE7CiAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBzdGF0ZS5leHRyYTsKICAgICAgICAgICAgICAgICAgYml0cyAtPSBzdGF0ZS5leHRyYTsKICAgICAgICAgICAgICAgICAgc3RhdGUuYmFjayArPSBzdGF0ZS5leHRyYTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLndhcyA9IHN0YXRlLmxlbmd0aDsKICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBESVNUOwogICAgICAgICAgICAgIGNhc2UgRElTVDoKICAgICAgICAgICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgICAgICAgICBoZXJlID0gc3RhdGUuZGlzdGNvZGVbaG9sZCAmICgxIDw8IHN0YXRlLmRpc3RiaXRzKSAtIDFdOwogICAgICAgICAgICAgICAgICBoZXJlX2JpdHMgPSBoZXJlID4+PiAyNDsKICAgICAgICAgICAgICAgICAgaGVyZV9vcCA9IGhlcmUgPj4+IDE2ICYgMjU1OwogICAgICAgICAgICAgICAgICBoZXJlX3ZhbCA9IGhlcmUgJiA2NTUzNTsKICAgICAgICAgICAgICAgICAgaWYgKGhlcmVfYml0cyA8PSBiaXRzKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGhhdmUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaGF2ZS0tOwogICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W25leHQrK10gPDwgYml0czsKICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKChoZXJlX29wICYgMjQwKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICBsYXN0X2JpdHMgPSBoZXJlX2JpdHM7CiAgICAgICAgICAgICAgICAgIGxhc3Rfb3AgPSBoZXJlX29wOwogICAgICAgICAgICAgICAgICBsYXN0X3ZhbCA9IGhlcmVfdmFsOwogICAgICAgICAgICAgICAgICBmb3IgKDsgOyApIHsKICAgICAgICAgICAgICAgICAgICBoZXJlID0gc3RhdGUuZGlzdGNvZGVbbGFzdF92YWwgKyAoKGhvbGQgJiAoMSA8PCBsYXN0X2JpdHMgKyBsYXN0X29wKSAtIDEpID4+IGxhc3RfYml0cyldOwogICAgICAgICAgICAgICAgICAgIGhlcmVfYml0cyA9IGhlcmUgPj4+IDI0OwogICAgICAgICAgICAgICAgICAgIGhlcmVfb3AgPSBoZXJlID4+PiAxNiAmIDI1NTsKICAgICAgICAgICAgICAgICAgICBoZXJlX3ZhbCA9IGhlcmUgJiA2NTUzNTsKICAgICAgICAgICAgICAgICAgICBpZiAobGFzdF9iaXRzICsgaGVyZV9iaXRzIDw9IGJpdHMpIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBsYXN0X2JpdHM7CiAgICAgICAgICAgICAgICAgIGJpdHMgLT0gbGFzdF9iaXRzOwogICAgICAgICAgICAgICAgICBzdGF0ZS5iYWNrICs9IGxhc3RfYml0czsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBoZXJlX2JpdHM7CiAgICAgICAgICAgICAgICBiaXRzIC09IGhlcmVfYml0czsKICAgICAgICAgICAgICAgIHN0YXRlLmJhY2sgKz0gaGVyZV9iaXRzOwogICAgICAgICAgICAgICAgaWYgKGhlcmVfb3AgJiA2NCkgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIGRpc3RhbmNlIGNvZGUiOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLm9mZnNldCA9IGhlcmVfdmFsOwogICAgICAgICAgICAgICAgc3RhdGUuZXh0cmEgPSBoZXJlX29wICYgMTU7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gRElTVEVYVDsKICAgICAgICAgICAgICBjYXNlIERJU1RFWFQ6CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZXh0cmEpIHsKICAgICAgICAgICAgICAgICAgbiA9IHN0YXRlLmV4dHJhOwogICAgICAgICAgICAgICAgICB3aGlsZSAoYml0cyA8IG4pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHN0YXRlLm9mZnNldCArPSBob2xkICYgKDEgPDwgc3RhdGUuZXh0cmEpIC0gMTsKICAgICAgICAgICAgICAgICAgaG9sZCA+Pj49IHN0YXRlLmV4dHJhOwogICAgICAgICAgICAgICAgICBiaXRzIC09IHN0YXRlLmV4dHJhOwogICAgICAgICAgICAgICAgICBzdGF0ZS5iYWNrICs9IHN0YXRlLmV4dHJhOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlLm9mZnNldCA+IHN0YXRlLmRtYXgpIHsKICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW52YWxpZCBkaXN0YW5jZSB0b28gZmFyIGJhY2siOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBNQVRDSDsKICAgICAgICAgICAgICBjYXNlIE1BVENIOgogICAgICAgICAgICAgICAgaWYgKGxlZnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29weSA9IF9vdXQgLSBsZWZ0OwogICAgICAgICAgICAgICAgaWYgKHN0YXRlLm9mZnNldCA+IGNvcHkpIHsKICAgICAgICAgICAgICAgICAgY29weSA9IHN0YXRlLm9mZnNldCAtIGNvcHk7CiAgICAgICAgICAgICAgICAgIGlmIChjb3B5ID4gc3RhdGUud2hhdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuc2FuZSkgewogICAgICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW52YWxpZCBkaXN0YW5jZSB0b28gZmFyIGJhY2siOwogICAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoY29weSA+IHN0YXRlLnduZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgY29weSAtPSBzdGF0ZS53bmV4dDsKICAgICAgICAgICAgICAgICAgICBmcm9tID0gc3RhdGUud3NpemUgLSBjb3B5OwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZyb20gPSBzdGF0ZS53bmV4dCAtIGNvcHk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGNvcHkgPiBzdGF0ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjb3B5ID0gc3RhdGUubGVuZ3RoOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGZyb21fc291cmNlID0gc3RhdGUud2luZG93OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZnJvbV9zb3VyY2UgPSBvdXRwdXQ7CiAgICAgICAgICAgICAgICAgIGZyb20gPSBwdXQgLSBzdGF0ZS5vZmZzZXQ7CiAgICAgICAgICAgICAgICAgIGNvcHkgPSBzdGF0ZS5sZW5ndGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY29weSA+IGxlZnQpIHsKICAgICAgICAgICAgICAgICAgY29weSA9IGxlZnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsZWZ0IC09IGNvcHk7CiAgICAgICAgICAgICAgICBzdGF0ZS5sZW5ndGggLT0gY29weTsKICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgb3V0cHV0W3B1dCsrXSA9IGZyb21fc291cmNlW2Zyb20rK107CiAgICAgICAgICAgICAgICB9IHdoaWxlICgtLWNvcHkpOwogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gTEVOOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBMSVQ6CiAgICAgICAgICAgICAgICBpZiAobGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvdXRwdXRbcHV0KytdID0gc3RhdGUubGVuZ3RoOwogICAgICAgICAgICAgICAgbGVmdC0tOwogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IExFTjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgQ0hFQ0s6CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUud3JhcCkgewogICAgICAgICAgICAgICAgICB3aGlsZSAoYml0cyA8IDMyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhdmUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaGF2ZS0tOwogICAgICAgICAgICAgICAgICAgIGhvbGQgfD0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBfb3V0IC09IGxlZnQ7CiAgICAgICAgICAgICAgICAgIHN0cm0udG90YWxfb3V0ICs9IF9vdXQ7CiAgICAgICAgICAgICAgICAgIHN0YXRlLnRvdGFsICs9IF9vdXQ7CiAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS53cmFwICYgNCAmJiBfb3V0KSB7CiAgICAgICAgICAgICAgICAgICAgc3RybS5hZGxlciA9IHN0YXRlLmNoZWNrID0gLypVUERBVEVfQ0hFQ0soc3RhdGUuY2hlY2ssIHB1dCAtIF9vdXQsIF9vdXQpOyovCiAgICAgICAgICAgICAgICAgICAgc3RhdGUuZmxhZ3MgPyBjcmMzMihzdGF0ZS5jaGVjaywgb3V0cHV0LCBfb3V0LCBwdXQgLSBfb3V0KSA6IGFkbGVyMzIoc3RhdGUuY2hlY2ssIG91dHB1dCwgX291dCwgcHV0IC0gX291dCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgX291dCA9IGxlZnQ7CiAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS53cmFwICYgNCAmJiAoc3RhdGUuZmxhZ3MgPyBob2xkIDogenN3YXAzMihob2xkKSkgIT09IHN0YXRlLmNoZWNrKSB7CiAgICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW5jb3JyZWN0IGRhdGEgY2hlY2siOwogICAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaG9sZCA9IDA7CiAgICAgICAgICAgICAgICAgIGJpdHMgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IExFTkdUSDsKICAgICAgICAgICAgICBjYXNlIExFTkdUSDoKICAgICAgICAgICAgICAgIGlmIChzdGF0ZS53cmFwICYmIHN0YXRlLmZsYWdzKSB7CiAgICAgICAgICAgICAgICAgIHdoaWxlIChiaXRzIDwgMzIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS53cmFwICYgNCAmJiBob2xkICE9PSAoc3RhdGUudG90YWwgJiA0Mjk0OTY3Mjk1KSkgewogICAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImluY29ycmVjdCBsZW5ndGggY2hlY2siOwogICAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaG9sZCA9IDA7CiAgICAgICAgICAgICAgICAgIGJpdHMgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IERPTkU7CiAgICAgICAgICAgICAgY2FzZSBET05FOgogICAgICAgICAgICAgICAgcmV0ID0gWl9TVFJFQU1fRU5EOwogICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgIGNhc2UgQkFEOgogICAgICAgICAgICAgICAgcmV0ID0gWl9EQVRBX0VSUk9SOwogICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgIGNhc2UgTUVNOgogICAgICAgICAgICAgICAgcmV0dXJuIFpfTUVNX0VSUk9SOwogICAgICAgICAgICAgIGNhc2UgU1lOQzoKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuIFpfU1RSRUFNX0VSUk9SOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgc3RybS5uZXh0X291dCA9IHB1dDsKICAgICAgICBzdHJtLmF2YWlsX291dCA9IGxlZnQ7CiAgICAgICAgc3RybS5uZXh0X2luID0gbmV4dDsKICAgICAgICBzdHJtLmF2YWlsX2luID0gaGF2ZTsKICAgICAgICBzdGF0ZS5ob2xkID0gaG9sZDsKICAgICAgICBzdGF0ZS5iaXRzID0gYml0czsKICAgICAgICBpZiAoc3RhdGUud3NpemUgfHwgX291dCAhPT0gc3RybS5hdmFpbF9vdXQgJiYgc3RhdGUubW9kZSA8IEJBRCAmJiAoc3RhdGUubW9kZSA8IENIRUNLIHx8IGZsdXNoICE9PSBaX0ZJTklTSCkpIHsKICAgICAgICAgIGlmICh1cGRhdGV3aW5kb3coc3RybSwgc3RybS5vdXRwdXQsIHN0cm0ubmV4dF9vdXQsIF9vdXQgLSBzdHJtLmF2YWlsX291dCkpIHsKICAgICAgICAgICAgc3RhdGUubW9kZSA9IE1FTTsKICAgICAgICAgICAgcmV0dXJuIFpfTUVNX0VSUk9SOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBfaW4gLT0gc3RybS5hdmFpbF9pbjsKICAgICAgICBfb3V0IC09IHN0cm0uYXZhaWxfb3V0OwogICAgICAgIHN0cm0udG90YWxfaW4gKz0gX2luOwogICAgICAgIHN0cm0udG90YWxfb3V0ICs9IF9vdXQ7CiAgICAgICAgc3RhdGUudG90YWwgKz0gX291dDsKICAgICAgICBpZiAoc3RhdGUud3JhcCAmIDQgJiYgX291dCkgewogICAgICAgICAgc3RybS5hZGxlciA9IHN0YXRlLmNoZWNrID0gLypVUERBVEVfQ0hFQ0soc3RhdGUuY2hlY2ssIHN0cm0ubmV4dF9vdXQgLSBfb3V0LCBfb3V0KTsqLwogICAgICAgICAgc3RhdGUuZmxhZ3MgPyBjcmMzMihzdGF0ZS5jaGVjaywgb3V0cHV0LCBfb3V0LCBzdHJtLm5leHRfb3V0IC0gX291dCkgOiBhZGxlcjMyKHN0YXRlLmNoZWNrLCBvdXRwdXQsIF9vdXQsIHN0cm0ubmV4dF9vdXQgLSBfb3V0KTsKICAgICAgICB9CiAgICAgICAgc3RybS5kYXRhX3R5cGUgPSBzdGF0ZS5iaXRzICsgKHN0YXRlLmxhc3QgPyA2NCA6IDApICsgKHN0YXRlLm1vZGUgPT09IFRZUEUgPyAxMjggOiAwKSArIChzdGF0ZS5tb2RlID09PSBMRU5fIHx8IHN0YXRlLm1vZGUgPT09IENPUFlfID8gMjU2IDogMCk7CiAgICAgICAgaWYgKChfaW4gPT09IDAgJiYgX291dCA9PT0gMCB8fCBmbHVzaCA9PT0gWl9GSU5JU0gpICYmIHJldCA9PT0gWl9PSykgewogICAgICAgICAgcmV0ID0gWl9CVUZfRVJST1I7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXQ7CiAgICAgIH07CiAgICAgIHZhciBpbmZsYXRlRW5kID0gKHN0cm0pID0+IHsKICAgICAgICBpZiAoaW5mbGF0ZVN0YXRlQ2hlY2soc3RybSkpIHsKICAgICAgICAgIHJldHVybiBaX1NUUkVBTV9FUlJPUjsKICAgICAgICB9CiAgICAgICAgbGV0IHN0YXRlID0gc3RybS5zdGF0ZTsKICAgICAgICBpZiAoc3RhdGUud2luZG93KSB7CiAgICAgICAgICBzdGF0ZS53aW5kb3cgPSBudWxsOwogICAgICAgIH0KICAgICAgICBzdHJtLnN0YXRlID0gbnVsbDsKICAgICAgICByZXR1cm4gWl9PSzsKICAgICAgfTsKICAgICAgdmFyIGluZmxhdGVHZXRIZWFkZXIgPSAoc3RybSwgaGVhZCkgPT4gewogICAgICAgIGlmIChpbmZsYXRlU3RhdGVDaGVjayhzdHJtKSkgewogICAgICAgICAgcmV0dXJuIFpfU1RSRUFNX0VSUk9SOwogICAgICAgIH0KICAgICAgICBjb25zdCBzdGF0ZSA9IHN0cm0uc3RhdGU7CiAgICAgICAgaWYgKChzdGF0ZS53cmFwICYgMikgPT09IDApIHsKICAgICAgICAgIHJldHVybiBaX1NUUkVBTV9FUlJPUjsKICAgICAgICB9CiAgICAgICAgc3RhdGUuaGVhZCA9IGhlYWQ7CiAgICAgICAgaGVhZC5kb25lID0gZmFsc2U7CiAgICAgICAgcmV0dXJuIFpfT0s7CiAgICAgIH07CiAgICAgIHZhciBpbmZsYXRlU2V0RGljdGlvbmFyeSA9IChzdHJtLCBkaWN0aW9uYXJ5KSA9PiB7CiAgICAgICAgY29uc3QgZGljdExlbmd0aCA9IGRpY3Rpb25hcnkubGVuZ3RoOwogICAgICAgIGxldCBzdGF0ZTsKICAgICAgICBsZXQgZGljdGlkOwogICAgICAgIGxldCByZXQ7CiAgICAgICAgaWYgKGluZmxhdGVTdGF0ZUNoZWNrKHN0cm0pKSB7CiAgICAgICAgICByZXR1cm4gWl9TVFJFQU1fRVJST1I7CiAgICAgICAgfQogICAgICAgIHN0YXRlID0gc3RybS5zdGF0ZTsKICAgICAgICBpZiAoc3RhdGUud3JhcCAhPT0gMCAmJiBzdGF0ZS5tb2RlICE9PSBESUNUKSB7CiAgICAgICAgICByZXR1cm4gWl9TVFJFQU1fRVJST1I7CiAgICAgICAgfQogICAgICAgIGlmIChzdGF0ZS5tb2RlID09PSBESUNUKSB7CiAgICAgICAgICBkaWN0aWQgPSAxOwogICAgICAgICAgZGljdGlkID0gYWRsZXIzMihkaWN0aWQsIGRpY3Rpb25hcnksIGRpY3RMZW5ndGgsIDApOwogICAgICAgICAgaWYgKGRpY3RpZCAhPT0gc3RhdGUuY2hlY2spIHsKICAgICAgICAgICAgcmV0dXJuIFpfREFUQV9FUlJPUjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0ID0gdXBkYXRld2luZG93KHN0cm0sIGRpY3Rpb25hcnksIGRpY3RMZW5ndGgsIGRpY3RMZW5ndGgpOwogICAgICAgIGlmIChyZXQpIHsKICAgICAgICAgIHN0YXRlLm1vZGUgPSBNRU07CiAgICAgICAgICByZXR1cm4gWl9NRU1fRVJST1I7CiAgICAgICAgfQogICAgICAgIHN0YXRlLmhhdmVkaWN0ID0gMTsKICAgICAgICByZXR1cm4gWl9PSzsKICAgICAgfTsKICAgICAgbW9kdWxlLmV4cG9ydHMuaW5mbGF0ZVJlc2V0ID0gaW5mbGF0ZVJlc2V0OwogICAgICBtb2R1bGUuZXhwb3J0cy5pbmZsYXRlUmVzZXQyID0gaW5mbGF0ZVJlc2V0MjsKICAgICAgbW9kdWxlLmV4cG9ydHMuaW5mbGF0ZVJlc2V0S2VlcCA9IGluZmxhdGVSZXNldEtlZXA7CiAgICAgIG1vZHVsZS5leHBvcnRzLmluZmxhdGVJbml0ID0gaW5mbGF0ZUluaXQ7CiAgICAgIG1vZHVsZS5leHBvcnRzLmluZmxhdGVJbml0MiA9IGluZmxhdGVJbml0MjsKICAgICAgbW9kdWxlLmV4cG9ydHMuaW5mbGF0ZSA9IGluZmxhdGU7CiAgICAgIG1vZHVsZS5leHBvcnRzLmluZmxhdGVFbmQgPSBpbmZsYXRlRW5kOwogICAgICBtb2R1bGUuZXhwb3J0cy5pbmZsYXRlR2V0SGVhZGVyID0gaW5mbGF0ZUdldEhlYWRlcjsKICAgICAgbW9kdWxlLmV4cG9ydHMuaW5mbGF0ZVNldERpY3Rpb25hcnkgPSBpbmZsYXRlU2V0RGljdGlvbmFyeTsKICAgICAgbW9kdWxlLmV4cG9ydHMuaW5mbGF0ZUluZm8gPSAicGFrbyBpbmZsYXRlIChmcm9tIE5vZGVjYSBwcm9qZWN0KSI7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9wYWtvL2xpYi91dGlscy9jb21tb24uanMKICB2YXIgcmVxdWlyZV9jb21tb24gPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvcGFrby9saWIvdXRpbHMvY29tbW9uLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgdmFyIF9oYXMgPSAob2JqLCBrZXkpID0+IHsKICAgICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KTsKICAgICAgfTsKICAgICAgbW9kdWxlLmV4cG9ydHMuYXNzaWduID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgY29uc3Qgc291cmNlcyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgd2hpbGUgKHNvdXJjZXMubGVuZ3RoKSB7CiAgICAgICAgICBjb25zdCBzb3VyY2UgPSBzb3VyY2VzLnNoaWZ0KCk7CiAgICAgICAgICBpZiAoIXNvdXJjZSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2Ygc291cmNlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKHNvdXJjZSArICJtdXN0IGJlIG5vbi1vYmplY3QiKTsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAoY29uc3QgcCBpbiBzb3VyY2UpIHsKICAgICAgICAgICAgaWYgKF9oYXMoc291cmNlLCBwKSkgewogICAgICAgICAgICAgIG9ialtwXSA9IHNvdXJjZVtwXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gb2JqOwogICAgICB9OwogICAgICBtb2R1bGUuZXhwb3J0cy5mbGF0dGVuQ2h1bmtzID0gKGNodW5rcykgPT4gewogICAgICAgIGxldCBsZW4gPSAwOwogICAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gY2h1bmtzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgbGVuICs9IGNodW5rc1tpXS5sZW5ndGg7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBVaW50OEFycmF5KGxlbik7CiAgICAgICAgZm9yIChsZXQgaSA9IDAsIHBvcyA9IDAsIGwgPSBjaHVua3MubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICBsZXQgY2h1bmsgPSBjaHVua3NbaV07CiAgICAgICAgICByZXN1bHQuc2V0KGNodW5rLCBwb3MpOwogICAgICAgICAgcG9zICs9IGNodW5rLmxlbmd0aDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3Bha28vbGliL3V0aWxzL3N0cmluZ3MuanMKICB2YXIgcmVxdWlyZV9zdHJpbmdzID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3Bha28vbGliL3V0aWxzL3N0cmluZ3MuanMiKGV4cG9ydHMyLCBtb2R1bGUpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICB2YXIgU1RSX0FQUExZX1VJQV9PSyA9IHRydWU7CiAgICAgIHRyeSB7CiAgICAgICAgU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShudWxsLCBuZXcgVWludDhBcnJheSgxKSk7CiAgICAgIH0gY2F0Y2ggKF9fKSB7CiAgICAgICAgU1RSX0FQUExZX1VJQV9PSyA9IGZhbHNlOwogICAgICB9CiAgICAgIHZhciBfdXRmOGxlbiA9IG5ldyBVaW50OEFycmF5KDI1Nik7CiAgICAgIGZvciAobGV0IHEgPSAwOyBxIDwgMjU2OyBxKyspIHsKICAgICAgICBfdXRmOGxlbltxXSA9IHEgPj0gMjUyID8gNiA6IHEgPj0gMjQ4ID8gNSA6IHEgPj0gMjQwID8gNCA6IHEgPj0gMjI0ID8gMyA6IHEgPj0gMTkyID8gMiA6IDE7CiAgICAgIH0KICAgICAgX3V0ZjhsZW5bMjU0XSA9IF91dGY4bGVuWzI1NF0gPSAxOwogICAgICBtb2R1bGUuZXhwb3J0cy5zdHJpbmcyYnVmID0gKHN0cikgPT4gewogICAgICAgIGlmICh0eXBlb2YgVGV4dEVuY29kZXIgPT09ICJmdW5jdGlvbiIgJiYgVGV4dEVuY29kZXIucHJvdG90eXBlLmVuY29kZSkgewogICAgICAgICAgcmV0dXJuIG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZShzdHIpOwogICAgICAgIH0KICAgICAgICBsZXQgYnVmLCBjLCBjMiwgbV9wb3MsIGksIHN0cl9sZW4gPSBzdHIubGVuZ3RoLCBidWZfbGVuID0gMDsKICAgICAgICBmb3IgKG1fcG9zID0gMDsgbV9wb3MgPCBzdHJfbGVuOyBtX3BvcysrKSB7CiAgICAgICAgICBjID0gc3RyLmNoYXJDb2RlQXQobV9wb3MpOwogICAgICAgICAgaWYgKChjICYgNjQ1MTIpID09PSA1NTI5NiAmJiBtX3BvcyArIDEgPCBzdHJfbGVuKSB7CiAgICAgICAgICAgIGMyID0gc3RyLmNoYXJDb2RlQXQobV9wb3MgKyAxKTsKICAgICAgICAgICAgaWYgKChjMiAmIDY0NTEyKSA9PT0gNTYzMjApIHsKICAgICAgICAgICAgICBjID0gNjU1MzYgKyAoYyAtIDU1Mjk2IDw8IDEwKSArIChjMiAtIDU2MzIwKTsKICAgICAgICAgICAgICBtX3BvcysrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBidWZfbGVuICs9IGMgPCAxMjggPyAxIDogYyA8IDIwNDggPyAyIDogYyA8IDY1NTM2ID8gMyA6IDQ7CiAgICAgICAgfQogICAgICAgIGJ1ZiA9IG5ldyBVaW50OEFycmF5KGJ1Zl9sZW4pOwogICAgICAgIGZvciAoaSA9IDAsIG1fcG9zID0gMDsgaSA8IGJ1Zl9sZW47IG1fcG9zKyspIHsKICAgICAgICAgIGMgPSBzdHIuY2hhckNvZGVBdChtX3Bvcyk7CiAgICAgICAgICBpZiAoKGMgJiA2NDUxMikgPT09IDU1Mjk2ICYmIG1fcG9zICsgMSA8IHN0cl9sZW4pIHsKICAgICAgICAgICAgYzIgPSBzdHIuY2hhckNvZGVBdChtX3BvcyArIDEpOwogICAgICAgICAgICBpZiAoKGMyICYgNjQ1MTIpID09PSA1NjMyMCkgewogICAgICAgICAgICAgIGMgPSA2NTUzNiArIChjIC0gNTUyOTYgPDwgMTApICsgKGMyIC0gNTYzMjApOwogICAgICAgICAgICAgIG1fcG9zKys7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChjIDwgMTI4KSB7CiAgICAgICAgICAgIGJ1ZltpKytdID0gYzsKICAgICAgICAgIH0gZWxzZSBpZiAoYyA8IDIwNDgpIHsKICAgICAgICAgICAgYnVmW2krK10gPSAxOTIgfCBjID4+PiA2OwogICAgICAgICAgICBidWZbaSsrXSA9IDEyOCB8IGMgJiA2MzsKICAgICAgICAgIH0gZWxzZSBpZiAoYyA8IDY1NTM2KSB7CiAgICAgICAgICAgIGJ1ZltpKytdID0gMjI0IHwgYyA+Pj4gMTI7CiAgICAgICAgICAgIGJ1ZltpKytdID0gMTI4IHwgYyA+Pj4gNiAmIDYzOwogICAgICAgICAgICBidWZbaSsrXSA9IDEyOCB8IGMgJiA2MzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJ1ZltpKytdID0gMjQwIHwgYyA+Pj4gMTg7CiAgICAgICAgICAgIGJ1ZltpKytdID0gMTI4IHwgYyA+Pj4gMTIgJiA2MzsKICAgICAgICAgICAgYnVmW2krK10gPSAxMjggfCBjID4+PiA2ICYgNjM7CiAgICAgICAgICAgIGJ1ZltpKytdID0gMTI4IHwgYyAmIDYzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gYnVmOwogICAgICB9OwogICAgICB2YXIgYnVmMmJpbnN0cmluZyA9IChidWYsIGxlbikgPT4gewogICAgICAgIGlmIChsZW4gPCA2NTUzNCkgewogICAgICAgICAgaWYgKGJ1Zi5zdWJhcnJheSAmJiBTVFJfQVBQTFlfVUlBX09LKSB7CiAgICAgICAgICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KG51bGwsIGJ1Zi5sZW5ndGggPT09IGxlbiA/IGJ1ZiA6IGJ1Zi5zdWJhcnJheSgwLCBsZW4pKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGV0IHJlc3VsdCA9ICIiOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIHJlc3VsdCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ1ZltpXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIG1vZHVsZS5leHBvcnRzLmJ1ZjJzdHJpbmcgPSAoYnVmLCBtYXgzKSA9PiB7CiAgICAgICAgY29uc3QgbGVuID0gbWF4MyB8fCBidWYubGVuZ3RoOwogICAgICAgIGlmICh0eXBlb2YgVGV4dERlY29kZXIgPT09ICJmdW5jdGlvbiIgJiYgVGV4dERlY29kZXIucHJvdG90eXBlLmRlY29kZSkgewogICAgICAgICAgcmV0dXJuIG5ldyBUZXh0RGVjb2RlcigpLmRlY29kZShidWYuc3ViYXJyYXkoMCwgbWF4MykpOwogICAgICAgIH0KICAgICAgICBsZXQgaSwgb3V0OwogICAgICAgIGNvbnN0IHV0ZjE2YnVmID0gbmV3IEFycmF5KGxlbiAqIDIpOwogICAgICAgIGZvciAob3V0ID0gMCwgaSA9IDA7IGkgPCBsZW47ICkgewogICAgICAgICAgbGV0IGMgPSBidWZbaSsrXTsKICAgICAgICAgIGlmIChjIDwgMTI4KSB7CiAgICAgICAgICAgIHV0ZjE2YnVmW291dCsrXSA9IGM7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgbGV0IGNfbGVuID0gX3V0ZjhsZW5bY107CiAgICAgICAgICBpZiAoY19sZW4gPiA0KSB7CiAgICAgICAgICAgIHV0ZjE2YnVmW291dCsrXSA9IDY1NTMzOwogICAgICAgICAgICBpICs9IGNfbGVuIC0gMTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBjICY9IGNfbGVuID09PSAyID8gMzEgOiBjX2xlbiA9PT0gMyA/IDE1IDogNzsKICAgICAgICAgIHdoaWxlIChjX2xlbiA+IDEgJiYgaSA8IGxlbikgewogICAgICAgICAgICBjID0gYyA8PCA2IHwgYnVmW2krK10gJiA2MzsKICAgICAgICAgICAgY19sZW4tLTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjX2xlbiA+IDEpIHsKICAgICAgICAgICAgdXRmMTZidWZbb3V0KytdID0gNjU1MzM7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGMgPCA2NTUzNikgewogICAgICAgICAgICB1dGYxNmJ1ZltvdXQrK10gPSBjOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYyAtPSA2NTUzNjsKICAgICAgICAgICAgdXRmMTZidWZbb3V0KytdID0gNTUyOTYgfCBjID4+IDEwICYgMTAyMzsKICAgICAgICAgICAgdXRmMTZidWZbb3V0KytdID0gNTYzMjAgfCBjICYgMTAyMzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGJ1ZjJiaW5zdHJpbmcodXRmMTZidWYsIG91dCk7CiAgICAgIH07CiAgICAgIG1vZHVsZS5leHBvcnRzLnV0Zjhib3JkZXIgPSAoYnVmLCBtYXgzKSA9PiB7CiAgICAgICAgbWF4MyA9IG1heDMgfHwgYnVmLmxlbmd0aDsKICAgICAgICBpZiAobWF4MyA+IGJ1Zi5sZW5ndGgpIHsKICAgICAgICAgIG1heDMgPSBidWYubGVuZ3RoOwogICAgICAgIH0KICAgICAgICBsZXQgcG9zID0gbWF4MyAtIDE7CiAgICAgICAgd2hpbGUgKHBvcyA+PSAwICYmIChidWZbcG9zXSAmIDE5MikgPT09IDEyOCkgewogICAgICAgICAgcG9zLS07CiAgICAgICAgfQogICAgICAgIGlmIChwb3MgPCAwKSB7CiAgICAgICAgICByZXR1cm4gbWF4MzsKICAgICAgICB9CiAgICAgICAgaWYgKHBvcyA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIG1heDM7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwb3MgKyBfdXRmOGxlbltidWZbcG9zXV0gPiBtYXgzID8gcG9zIDogbWF4MzsKICAgICAgfTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvbWVzc2FnZXMuanMKICB2YXIgcmVxdWlyZV9tZXNzYWdlcyA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy9wYWtvL2xpYi96bGliL21lc3NhZ2VzLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgICAgMjogIm5lZWQgZGljdGlvbmFyeSIsCiAgICAgICAgLyogWl9ORUVEX0RJQ1QgICAgICAgMiAgKi8KICAgICAgICAxOiAic3RyZWFtIGVuZCIsCiAgICAgICAgLyogWl9TVFJFQU1fRU5EICAgICAgMSAgKi8KICAgICAgICAwOiAiIiwKICAgICAgICAvKiBaX09LICAgICAgICAgICAgICAwICAqLwogICAgICAgICItMSI6ICJmaWxlIGVycm9yIiwKICAgICAgICAvKiBaX0VSUk5PICAgICAgICAgKC0xKSAqLwogICAgICAgICItMiI6ICJzdHJlYW0gZXJyb3IiLAogICAgICAgIC8qIFpfU1RSRUFNX0VSUk9SICAoLTIpICovCiAgICAgICAgIi0zIjogImRhdGEgZXJyb3IiLAogICAgICAgIC8qIFpfREFUQV9FUlJPUiAgICAoLTMpICovCiAgICAgICAgIi00IjogImluc3VmZmljaWVudCBtZW1vcnkiLAogICAgICAgIC8qIFpfTUVNX0VSUk9SICAgICAoLTQpICovCiAgICAgICAgIi01IjogImJ1ZmZlciBlcnJvciIsCiAgICAgICAgLyogWl9CVUZfRVJST1IgICAgICgtNSkgKi8KICAgICAgICAiLTYiOiAiaW5jb21wYXRpYmxlIHZlcnNpb24iCiAgICAgICAgLyogWl9WRVJTSU9OX0VSUk9SICgtNikgKi8KICAgICAgfTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvenN0cmVhbS5qcwogIHZhciByZXF1aXJlX3pzdHJlYW0gPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi96c3RyZWFtLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgZnVuY3Rpb24gWlN0cmVhbSgpIHsKICAgICAgICB0aGlzLmlucHV0ID0gbnVsbDsKICAgICAgICB0aGlzLm5leHRfaW4gPSAwOwogICAgICAgIHRoaXMuYXZhaWxfaW4gPSAwOwogICAgICAgIHRoaXMudG90YWxfaW4gPSAwOwogICAgICAgIHRoaXMub3V0cHV0ID0gbnVsbDsKICAgICAgICB0aGlzLm5leHRfb3V0ID0gMDsKICAgICAgICB0aGlzLmF2YWlsX291dCA9IDA7CiAgICAgICAgdGhpcy50b3RhbF9vdXQgPSAwOwogICAgICAgIHRoaXMubXNnID0gIiI7CiAgICAgICAgdGhpcy5zdGF0ZSA9IG51bGw7CiAgICAgICAgdGhpcy5kYXRhX3R5cGUgPSAyOwogICAgICAgIHRoaXMuYWRsZXIgPSAwOwogICAgICB9CiAgICAgIG1vZHVsZS5leHBvcnRzID0gWlN0cmVhbTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvZ3poZWFkZXIuanMKICB2YXIgcmVxdWlyZV9nemhlYWRlciA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy9wYWtvL2xpYi96bGliL2d6aGVhZGVyLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgZnVuY3Rpb24gR1poZWFkZXIoKSB7CiAgICAgICAgdGhpcy50ZXh0ID0gMDsKICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgIHRoaXMueGZsYWdzID0gMDsKICAgICAgICB0aGlzLm9zID0gMDsKICAgICAgICB0aGlzLmV4dHJhID0gbnVsbDsKICAgICAgICB0aGlzLmV4dHJhX2xlbiA9IDA7CiAgICAgICAgdGhpcy5uYW1lID0gIiI7CiAgICAgICAgdGhpcy5jb21tZW50ID0gIiI7CiAgICAgICAgdGhpcy5oY3JjID0gMDsKICAgICAgICB0aGlzLmRvbmUgPSBmYWxzZTsKICAgICAgfQogICAgICBtb2R1bGUuZXhwb3J0cyA9IEdaaGVhZGVyOwogICAgfQogIH0pOwoKICAvLyBub2RlX21vZHVsZXMvcGFrby9saWIvaW5mbGF0ZS5qcwogIHZhciByZXF1aXJlX2luZmxhdGUyID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3Bha28vbGliL2luZmxhdGUuanMiKGV4cG9ydHMyLCBtb2R1bGUpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICB2YXIgemxpYl9pbmZsYXRlID0gcmVxdWlyZV9pbmZsYXRlKCk7CiAgICAgIHZhciB1dGlscyA9IHJlcXVpcmVfY29tbW9uKCk7CiAgICAgIHZhciBzdHJpbmdzID0gcmVxdWlyZV9zdHJpbmdzKCk7CiAgICAgIHZhciBtc2cgPSByZXF1aXJlX21lc3NhZ2VzKCk7CiAgICAgIHZhciBaU3RyZWFtID0gcmVxdWlyZV96c3RyZWFtKCk7CiAgICAgIHZhciBHWmhlYWRlciA9IHJlcXVpcmVfZ3poZWFkZXIoKTsKICAgICAgdmFyIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKICAgICAgdmFyIHsKICAgICAgICBaX05PX0ZMVVNILAogICAgICAgIFpfRklOSVNILAogICAgICAgIFpfT0ssCiAgICAgICAgWl9TVFJFQU1fRU5ELAogICAgICAgIFpfTkVFRF9ESUNULAogICAgICAgIFpfU1RSRUFNX0VSUk9SLAogICAgICAgIFpfREFUQV9FUlJPUiwKICAgICAgICBaX01FTV9FUlJPUgogICAgICB9ID0gcmVxdWlyZV9jb25zdGFudHMoKTsKICAgICAgZnVuY3Rpb24gSW5mbGF0ZShvcHRpb25zKSB7CiAgICAgICAgdGhpcy5vcHRpb25zID0gdXRpbHMuYXNzaWduKHsKICAgICAgICAgIGNodW5rU2l6ZTogMTAyNCAqIDY0LAogICAgICAgICAgd2luZG93Qml0czogMTUsCiAgICAgICAgICB0bzogIiIKICAgICAgICB9LCBvcHRpb25zIHx8IHt9KTsKICAgICAgICBjb25zdCBvcHQgPSB0aGlzLm9wdGlvbnM7CiAgICAgICAgaWYgKG9wdC5yYXcgJiYgb3B0LndpbmRvd0JpdHMgPj0gMCAmJiBvcHQud2luZG93Qml0cyA8IDE2KSB7CiAgICAgICAgICBvcHQud2luZG93Qml0cyA9IC1vcHQud2luZG93Qml0czsKICAgICAgICAgIGlmIChvcHQud2luZG93Qml0cyA9PT0gMCkgewogICAgICAgICAgICBvcHQud2luZG93Qml0cyA9IC0xNTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKG9wdC53aW5kb3dCaXRzID49IDAgJiYgb3B0LndpbmRvd0JpdHMgPCAxNiAmJiAhKG9wdGlvbnMgJiYgb3B0aW9ucy53aW5kb3dCaXRzKSkgewogICAgICAgICAgb3B0LndpbmRvd0JpdHMgKz0gMzI7CiAgICAgICAgfQogICAgICAgIGlmIChvcHQud2luZG93Qml0cyA+IDE1ICYmIG9wdC53aW5kb3dCaXRzIDwgNDgpIHsKICAgICAgICAgIGlmICgob3B0LndpbmRvd0JpdHMgJiAxNSkgPT09IDApIHsKICAgICAgICAgICAgb3B0LndpbmRvd0JpdHMgfD0gMTU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuZXJyID0gMDsKICAgICAgICB0aGlzLm1zZyA9ICIiOwogICAgICAgIHRoaXMuZW5kZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLmNodW5rcyA9IFtdOwogICAgICAgIHRoaXMuc3RybSA9IG5ldyBaU3RyZWFtKCk7CiAgICAgICAgdGhpcy5zdHJtLmF2YWlsX291dCA9IDA7CiAgICAgICAgbGV0IHN0YXR1cyA9IHpsaWJfaW5mbGF0ZS5pbmZsYXRlSW5pdDIoCiAgICAgICAgICB0aGlzLnN0cm0sCiAgICAgICAgICBvcHQud2luZG93Qml0cwogICAgICAgICk7CiAgICAgICAgaWYgKHN0YXR1cyAhPT0gWl9PSykgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZ1tzdGF0dXNdKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5oZWFkZXIgPSBuZXcgR1poZWFkZXIoKTsKICAgICAgICB6bGliX2luZmxhdGUuaW5mbGF0ZUdldEhlYWRlcih0aGlzLnN0cm0sIHRoaXMuaGVhZGVyKTsKICAgICAgICBpZiAob3B0LmRpY3Rpb25hcnkpIHsKICAgICAgICAgIGlmICh0eXBlb2Ygb3B0LmRpY3Rpb25hcnkgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIG9wdC5kaWN0aW9uYXJ5ID0gc3RyaW5ncy5zdHJpbmcyYnVmKG9wdC5kaWN0aW9uYXJ5KTsKICAgICAgICAgIH0gZWxzZSBpZiAodG9TdHJpbmcuY2FsbChvcHQuZGljdGlvbmFyeSkgPT09ICJbb2JqZWN0IEFycmF5QnVmZmVyXSIpIHsKICAgICAgICAgICAgb3B0LmRpY3Rpb25hcnkgPSBuZXcgVWludDhBcnJheShvcHQuZGljdGlvbmFyeSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob3B0LnJhdykgewogICAgICAgICAgICBzdGF0dXMgPSB6bGliX2luZmxhdGUuaW5mbGF0ZVNldERpY3Rpb25hcnkodGhpcy5zdHJtLCBvcHQuZGljdGlvbmFyeSk7CiAgICAgICAgICAgIGlmIChzdGF0dXMgIT09IFpfT0spIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IobXNnW3N0YXR1c10pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIEluZmxhdGUucHJvdG90eXBlLnB1c2ggPSBmdW5jdGlvbihkYXRhLCBmbHVzaF9tb2RlKSB7CiAgICAgICAgY29uc3Qgc3RybSA9IHRoaXMuc3RybTsKICAgICAgICBjb25zdCBjaHVua1NpemUgPSB0aGlzLm9wdGlvbnMuY2h1bmtTaXplOwogICAgICAgIGNvbnN0IGRpY3Rpb25hcnkgPSB0aGlzLm9wdGlvbnMuZGljdGlvbmFyeTsKICAgICAgICBsZXQgc3RhdHVzLCBfZmx1c2hfbW9kZSwgbGFzdF9hdmFpbF9vdXQ7CiAgICAgICAgaWYgKHRoaXMuZW5kZWQpCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKGZsdXNoX21vZGUgPT09IH5+Zmx1c2hfbW9kZSkKICAgICAgICAgIF9mbHVzaF9tb2RlID0gZmx1c2hfbW9kZTsKICAgICAgICBlbHNlCiAgICAgICAgICBfZmx1c2hfbW9kZSA9IGZsdXNoX21vZGUgPT09IHRydWUgPyBaX0ZJTklTSCA6IFpfTk9fRkxVU0g7CiAgICAgICAgaWYgKHRvU3RyaW5nLmNhbGwoZGF0YSkgPT09ICJbb2JqZWN0IEFycmF5QnVmZmVyXSIpIHsKICAgICAgICAgIHN0cm0uaW5wdXQgPSBuZXcgVWludDhBcnJheShkYXRhKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RybS5pbnB1dCA9IGRhdGE7CiAgICAgICAgfQogICAgICAgIHN0cm0ubmV4dF9pbiA9IDA7CiAgICAgICAgc3RybS5hdmFpbF9pbiA9IHN0cm0uaW5wdXQubGVuZ3RoOwogICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgaWYgKHN0cm0uYXZhaWxfb3V0ID09PSAwKSB7CiAgICAgICAgICAgIHN0cm0ub3V0cHV0ID0gbmV3IFVpbnQ4QXJyYXkoY2h1bmtTaXplKTsKICAgICAgICAgICAgc3RybS5uZXh0X291dCA9IDA7CiAgICAgICAgICAgIHN0cm0uYXZhaWxfb3V0ID0gY2h1bmtTaXplOwogICAgICAgICAgfQogICAgICAgICAgc3RhdHVzID0gemxpYl9pbmZsYXRlLmluZmxhdGUoc3RybSwgX2ZsdXNoX21vZGUpOwogICAgICAgICAgaWYgKHN0YXR1cyA9PT0gWl9ORUVEX0RJQ1QgJiYgZGljdGlvbmFyeSkgewogICAgICAgICAgICBzdGF0dXMgPSB6bGliX2luZmxhdGUuaW5mbGF0ZVNldERpY3Rpb25hcnkoc3RybSwgZGljdGlvbmFyeSk7CiAgICAgICAgICAgIGlmIChzdGF0dXMgPT09IFpfT0spIHsKICAgICAgICAgICAgICBzdGF0dXMgPSB6bGliX2luZmxhdGUuaW5mbGF0ZShzdHJtLCBfZmx1c2hfbW9kZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdHVzID09PSBaX0RBVEFfRVJST1IpIHsKICAgICAgICAgICAgICBzdGF0dXMgPSBaX05FRURfRElDVDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKHN0cm0uYXZhaWxfaW4gPiAwICYmIHN0YXR1cyA9PT0gWl9TVFJFQU1fRU5EICYmIHN0cm0uc3RhdGUud3JhcCA+IDAgJiYgZGF0YVtzdHJtLm5leHRfaW5dICE9PSAwKSB7CiAgICAgICAgICAgIHpsaWJfaW5mbGF0ZS5pbmZsYXRlUmVzZXQoc3RybSk7CiAgICAgICAgICAgIHN0YXR1cyA9IHpsaWJfaW5mbGF0ZS5pbmZsYXRlKHN0cm0sIF9mbHVzaF9tb2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAoc3RhdHVzKSB7CiAgICAgICAgICAgIGNhc2UgWl9TVFJFQU1fRVJST1I6CiAgICAgICAgICAgIGNhc2UgWl9EQVRBX0VSUk9SOgogICAgICAgICAgICBjYXNlIFpfTkVFRF9ESUNUOgogICAgICAgICAgICBjYXNlIFpfTUVNX0VSUk9SOgogICAgICAgICAgICAgIHRoaXMub25FbmQoc3RhdHVzKTsKICAgICAgICAgICAgICB0aGlzLmVuZGVkID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBsYXN0X2F2YWlsX291dCA9IHN0cm0uYXZhaWxfb3V0OwogICAgICAgICAgaWYgKHN0cm0ubmV4dF9vdXQpIHsKICAgICAgICAgICAgaWYgKHN0cm0uYXZhaWxfb3V0ID09PSAwIHx8IHN0YXR1cyA9PT0gWl9TVFJFQU1fRU5EKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy50byA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIGxldCBuZXh0X291dF91dGY4ID0gc3RyaW5ncy51dGY4Ym9yZGVyKHN0cm0ub3V0cHV0LCBzdHJtLm5leHRfb3V0KTsKICAgICAgICAgICAgICAgIGxldCB0YWlsID0gc3RybS5uZXh0X291dCAtIG5leHRfb3V0X3V0Zjg7CiAgICAgICAgICAgICAgICBsZXQgdXRmOHN0ciA9IHN0cmluZ3MuYnVmMnN0cmluZyhzdHJtLm91dHB1dCwgbmV4dF9vdXRfdXRmOCk7CiAgICAgICAgICAgICAgICBzdHJtLm5leHRfb3V0ID0gdGFpbDsKICAgICAgICAgICAgICAgIHN0cm0uYXZhaWxfb3V0ID0gY2h1bmtTaXplIC0gdGFpbDsKICAgICAgICAgICAgICAgIGlmICh0YWlsKQogICAgICAgICAgICAgICAgICBzdHJtLm91dHB1dC5zZXQoc3RybS5vdXRwdXQuc3ViYXJyYXkobmV4dF9vdXRfdXRmOCwgbmV4dF9vdXRfdXRmOCArIHRhaWwpLCAwKTsKICAgICAgICAgICAgICAgIHRoaXMub25EYXRhKHV0ZjhzdHIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLm9uRGF0YShzdHJtLm91dHB1dC5sZW5ndGggPT09IHN0cm0ubmV4dF9vdXQgPyBzdHJtLm91dHB1dCA6IHN0cm0ub3V0cHV0LnN1YmFycmF5KDAsIHN0cm0ubmV4dF9vdXQpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChzdGF0dXMgPT09IFpfT0sgJiYgbGFzdF9hdmFpbF9vdXQgPT09IDApCiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgaWYgKHN0YXR1cyA9PT0gWl9TVFJFQU1fRU5EKSB7CiAgICAgICAgICAgIHN0YXR1cyA9IHpsaWJfaW5mbGF0ZS5pbmZsYXRlRW5kKHRoaXMuc3RybSk7CiAgICAgICAgICAgIHRoaXMub25FbmQoc3RhdHVzKTsKICAgICAgICAgICAgdGhpcy5lbmRlZCA9IHRydWU7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHN0cm0uYXZhaWxfaW4gPT09IDApCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfTsKICAgICAgSW5mbGF0ZS5wcm90b3R5cGUub25EYXRhID0gZnVuY3Rpb24oY2h1bmspIHsKICAgICAgICB0aGlzLmNodW5rcy5wdXNoKGNodW5rKTsKICAgICAgfTsKICAgICAgSW5mbGF0ZS5wcm90b3R5cGUub25FbmQgPSBmdW5jdGlvbihzdGF0dXMpIHsKICAgICAgICBpZiAoc3RhdHVzID09PSBaX09LKSB7CiAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLnRvID09PSAic3RyaW5nIikgewogICAgICAgICAgICB0aGlzLnJlc3VsdCA9IHRoaXMuY2h1bmtzLmpvaW4oIiIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5yZXN1bHQgPSB1dGlscy5mbGF0dGVuQ2h1bmtzKHRoaXMuY2h1bmtzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5jaHVua3MgPSBbXTsKICAgICAgICB0aGlzLmVyciA9IHN0YXR1czsKICAgICAgICB0aGlzLm1zZyA9IHRoaXMuc3RybS5tc2c7CiAgICAgIH07CiAgICAgIGZ1bmN0aW9uIGluZmxhdGUoaW5wdXQsIG9wdGlvbnMpIHsKICAgICAgICBjb25zdCBpbmZsYXRvciA9IG5ldyBJbmZsYXRlKG9wdGlvbnMpOwogICAgICAgIGluZmxhdG9yLnB1c2goaW5wdXQpOwogICAgICAgIGlmIChpbmZsYXRvci5lcnIpCiAgICAgICAgICB0aHJvdyBpbmZsYXRvci5tc2cgfHwgbXNnW2luZmxhdG9yLmVycl07CiAgICAgICAgcmV0dXJuIGluZmxhdG9yLnJlc3VsdDsKICAgICAgfQogICAgICBmdW5jdGlvbiBpbmZsYXRlUmF3KGlucHV0LCBvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgb3B0aW9ucy5yYXcgPSB0cnVlOwogICAgICAgIHJldHVybiBpbmZsYXRlKGlucHV0LCBvcHRpb25zKTsKICAgICAgfQogICAgICBtb2R1bGUuZXhwb3J0cy5JbmZsYXRlID0gSW5mbGF0ZTsKICAgICAgbW9kdWxlLmV4cG9ydHMuaW5mbGF0ZSA9IGluZmxhdGU7CiAgICAgIG1vZHVsZS5leHBvcnRzLmluZmxhdGVSYXcgPSBpbmZsYXRlUmF3OwogICAgICBtb2R1bGUuZXhwb3J0cy51bmd6aXAgPSBpbmZsYXRlOwogICAgICBtb2R1bGUuZXhwb3J0cy5jb25zdGFudHMgPSByZXF1aXJlX2NvbnN0YW50cygpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlUGFja2V0LmpzCiAgdmFyIGRlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZVBhY2tldF9leHBvcnRzID0ge307CiAgX19leHBvcnQoZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlUGFja2V0X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGRlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZVBhY2tldF9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlUGFja2V0KHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IHR5cGUgPSBUeXBlcy5mcm9tU3RyaW5nKHBhcmFtZXRlcnMudHlwZSk7CiAgICBsZXQgYnVmZmVyID0gcGFyYW1ldGVycy5idWZmZXI7CiAgICBkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VEYXRhX2RlZmF1bHQocGFyYW1ldGVycy5rZXksIGJ1ZmZlcik7CiAgICBjb25zdCB1bmNvbXByZXNzZWRUZXJyYWluID0gdW5jb21wcmVzc1BhY2tldChidWZmZXIpOwogICAgYnVmZmVyID0gdW5jb21wcmVzc2VkVGVycmFpbi5idWZmZXI7CiAgICBjb25zdCBsZW5ndGggPSB1bmNvbXByZXNzZWRUZXJyYWluLmxlbmd0aDsKICAgIHN3aXRjaCAodHlwZSkgewogICAgICBjYXNlIFR5cGVzLk1FVEFEQVRBOgogICAgICAgIHJldHVybiBwcm9jZXNzTWV0YWRhdGEoYnVmZmVyLCBsZW5ndGgsIHBhcmFtZXRlcnMucXVhZEtleSk7CiAgICAgIGNhc2UgVHlwZXMuVEVSUkFJTjoKICAgICAgICByZXR1cm4gcHJvY2Vzc1RlcnJhaW4oYnVmZmVyLCBsZW5ndGgsIHRyYW5zZmVyYWJsZU9iamVjdHMpOwogICAgICBjYXNlIFR5cGVzLkRCUk9PVDoKICAgICAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2goYnVmZmVyKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgYnVmZmVyCiAgICAgICAgfTsKICAgIH0KICB9CiAgZnVuY3Rpb24gcHJvY2Vzc01ldGFkYXRhKGJ1ZmZlciwgdG90YWxTaXplLCBxdWFkS2V5KSB7CiAgICBjb25zdCBkdiA9IG5ldyBEYXRhVmlldyhidWZmZXIpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBjb25zdCBtYWdpYyA9IGR2LmdldFVpbnQzMihvZmZzZXQsIHRydWUpOwogICAgb2Zmc2V0ICs9IHNpemVPZlVpbnQzMjI7CiAgICBpZiAobWFnaWMgIT09IHF0TWFnaWMpIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJJbnZhbGlkIG1hZ2ljIik7CiAgICB9CiAgICBjb25zdCBkYXRhVHlwZUlkID0gZHYuZ2V0VWludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDMyMjsKICAgIGlmIChkYXRhVHlwZUlkICE9PSAxKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgiSW52YWxpZCBkYXRhIHR5cGUuIE11c3QgYmUgMSBmb3IgUXVhZFRyZWVQYWNrZXQiKTsKICAgIH0KICAgIGNvbnN0IHF1YWRWZXJzaW9uID0gZHYuZ2V0VWludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDMyMjsKICAgIGlmIChxdWFkVmVyc2lvbiAhPT0gMikgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoCiAgICAgICAgIkludmFsaWQgUXVhZFRyZWVQYWNrZXQgdmVyc2lvbi4gT25seSB2ZXJzaW9uIDIgaXMgc3VwcG9ydGVkLiIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IG51bUluc3RhbmNlcyA9IGR2LmdldEludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICBvZmZzZXQgKz0gc2l6ZU9mSW50MzIyOwogICAgY29uc3QgZGF0YUluc3RhbmNlU2l6ZSA9IGR2LmdldEludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICBvZmZzZXQgKz0gc2l6ZU9mSW50MzIyOwogICAgaWYgKGRhdGFJbnN0YW5jZVNpemUgIT09IDMyKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgiSW52YWxpZCBpbnN0YW5jZSBzaXplLiIpOwogICAgfQogICAgY29uc3QgZGF0YUJ1ZmZlck9mZnNldCA9IGR2LmdldEludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICBvZmZzZXQgKz0gc2l6ZU9mSW50MzIyOwogICAgY29uc3QgZGF0YUJ1ZmZlclNpemUgPSBkdi5nZXRJbnQzMihvZmZzZXQsIHRydWUpOwogICAgb2Zmc2V0ICs9IHNpemVPZkludDMyMjsKICAgIGNvbnN0IG1ldGFCdWZmZXJTaXplID0gZHYuZ2V0SW50MzIob2Zmc2V0LCB0cnVlKTsKICAgIG9mZnNldCArPSBzaXplT2ZJbnQzMjI7CiAgICBpZiAoZGF0YUJ1ZmZlck9mZnNldCAhPT0gbnVtSW5zdGFuY2VzICogZGF0YUluc3RhbmNlU2l6ZSArIG9mZnNldCkgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIkludmFsaWQgZGF0YUJ1ZmZlck9mZnNldCIpOwogICAgfQogICAgaWYgKGRhdGFCdWZmZXJPZmZzZXQgKyBkYXRhQnVmZmVyU2l6ZSArIG1ldGFCdWZmZXJTaXplICE9PSB0b3RhbFNpemUpIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJJbnZhbGlkIHBhY2tldCBvZmZzZXRzIik7CiAgICB9CiAgICBjb25zdCBpbnN0YW5jZXMgPSBbXTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtSW5zdGFuY2VzOyArK2kpIHsKICAgICAgY29uc3QgYml0ZmllbGQgPSBkdi5nZXRVaW50OChvZmZzZXQpOwogICAgICArK29mZnNldDsKICAgICAgKytvZmZzZXQ7CiAgICAgIGNvbnN0IGNub2RlVmVyc2lvbiA9IGR2LmdldFVpbnQxNihvZmZzZXQsIHRydWUpOwogICAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDE2MjsKICAgICAgY29uc3QgaW1hZ2VWZXJzaW9uID0gZHYuZ2V0VWludDE2KG9mZnNldCwgdHJ1ZSk7CiAgICAgIG9mZnNldCArPSBzaXplT2ZVaW50MTYyOwogICAgICBjb25zdCB0ZXJyYWluVmVyc2lvbiA9IGR2LmdldFVpbnQxNihvZmZzZXQsIHRydWUpOwogICAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDE2MjsKICAgICAgb2Zmc2V0ICs9IHNpemVPZlVpbnQxNjI7CiAgICAgIG9mZnNldCArPSBzaXplT2ZVaW50MTYyOwogICAgICBvZmZzZXQgKz0gc2l6ZU9mSW50MzIyOwogICAgICBvZmZzZXQgKz0gc2l6ZU9mSW50MzIyOwogICAgICBvZmZzZXQgKz0gODsKICAgICAgY29uc3QgaW1hZ2VQcm92aWRlciA9IGR2LmdldFVpbnQ4KG9mZnNldCsrKTsKICAgICAgY29uc3QgdGVycmFpblByb3ZpZGVyID0gZHYuZ2V0VWludDgob2Zmc2V0KyspOwogICAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDE2MjsKICAgICAgaW5zdGFuY2VzLnB1c2goCiAgICAgICAgbmV3IEdvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbl9kZWZhdWx0KAogICAgICAgICAgYml0ZmllbGQsCiAgICAgICAgICBjbm9kZVZlcnNpb24sCiAgICAgICAgICBpbWFnZVZlcnNpb24sCiAgICAgICAgICB0ZXJyYWluVmVyc2lvbiwKICAgICAgICAgIGltYWdlUHJvdmlkZXIsCiAgICAgICAgICB0ZXJyYWluUHJvdmlkZXIKICAgICAgICApCiAgICAgICk7CiAgICB9CiAgICBjb25zdCB0aWxlSW5mbyA9IFtdOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGZ1bmN0aW9uIHBvcHVsYXRlVGlsZXMocGFyZW50S2V5LCBwYXJlbnQsIGxldmVsMikgewogICAgICBsZXQgaXNMZWFmID0gZmFsc2U7CiAgICAgIGlmIChsZXZlbDIgPT09IDQpIHsKICAgICAgICBpZiAocGFyZW50Lmhhc1N1YnRyZWUoKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpc0xlYWYgPSB0cnVlOwogICAgICB9CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgKytpKSB7CiAgICAgICAgY29uc3QgY2hpbGRLZXkgPSBwYXJlbnRLZXkgKyBpLnRvU3RyaW5nKCk7CiAgICAgICAgaWYgKGlzTGVhZikgewogICAgICAgICAgdGlsZUluZm9bY2hpbGRLZXldID0gbnVsbDsKICAgICAgICB9IGVsc2UgaWYgKGxldmVsMiA8IDQpIHsKICAgICAgICAgIGlmICghcGFyZW50Lmhhc0NoaWxkKGkpKSB7CiAgICAgICAgICAgIHRpbGVJbmZvW2NoaWxkS2V5XSA9IG51bGw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoaW5kZXggPT09IG51bUluc3RhbmNlcykgewogICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJJbmNvcnJlY3QgbnVtYmVyIG9mIGluc3RhbmNlcyIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBpbnN0YW5jZSA9IGluc3RhbmNlc1tpbmRleCsrXTsKICAgICAgICAgICAgdGlsZUluZm9bY2hpbGRLZXldID0gaW5zdGFuY2U7CiAgICAgICAgICAgIHBvcHVsYXRlVGlsZXMoY2hpbGRLZXksIGluc3RhbmNlLCBsZXZlbDIgKyAxKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGxldCBsZXZlbCA9IDA7CiAgICBjb25zdCByb290ID0gaW5zdGFuY2VzW2luZGV4KytdOwogICAgaWYgKHF1YWRLZXkgPT09ICIiKSB7CiAgICAgICsrbGV2ZWw7CiAgICB9IGVsc2UgewogICAgICB0aWxlSW5mb1txdWFkS2V5XSA9IHJvb3Q7CiAgICB9CiAgICBwb3B1bGF0ZVRpbGVzKHF1YWRLZXksIHJvb3QsIGxldmVsKTsKICAgIHJldHVybiB0aWxlSW5mbzsKICB9CiAgZnVuY3Rpb24gcHJvY2Vzc1RlcnJhaW4oYnVmZmVyLCB0b3RhbFNpemUsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IGR2ID0gbmV3IERhdGFWaWV3KGJ1ZmZlcik7CiAgICBjb25zdCBhZHZhbmNlTWVzaCA9IGZ1bmN0aW9uKHBvcykgewogICAgICBmb3IgKGxldCBzdWIgPSAwOyBzdWIgPCBudW1TdWJNZXNoZXNQZXJNZXNoOyArK3N1YikgewogICAgICAgIGNvbnN0IHNpemUgPSBkdi5nZXRVaW50MzIocG9zLCB0cnVlKTsKICAgICAgICBwb3MgKz0gc2l6ZU9mVWludDMyMjsKICAgICAgICBwb3MgKz0gc2l6ZTsKICAgICAgICBpZiAocG9zID4gdG90YWxTaXplKSB7CiAgICAgICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIk1hbGZvcm1lZCB0ZXJyYWluIHBhY2tldCBmb3VuZC4iKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHBvczsKICAgIH07CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIGNvbnN0IHRlcnJhaW5NZXNoZXMgPSBbXTsKICAgIHdoaWxlICh0ZXJyYWluTWVzaGVzLmxlbmd0aCA8IG51bU1lc2hlc1BlclBhY2tldCkgewogICAgICBjb25zdCBzdGFydCA9IG9mZnNldDsKICAgICAgb2Zmc2V0ID0gYWR2YW5jZU1lc2gob2Zmc2V0KTsKICAgICAgY29uc3QgbWVzaCA9IGJ1ZmZlci5zbGljZShzdGFydCwgb2Zmc2V0KTsKICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKG1lc2gpOwogICAgICB0ZXJyYWluTWVzaGVzLnB1c2gobWVzaCk7CiAgICB9CiAgICByZXR1cm4gdGVycmFpbk1lc2hlczsKICB9CiAgZnVuY3Rpb24gdW5jb21wcmVzc1BhY2tldChkYXRhKSB7CiAgICBjb25zdCBkdiA9IG5ldyBEYXRhVmlldyhkYXRhKTsKICAgIGxldCBvZmZzZXQgPSAwOwogICAgY29uc3QgbWFnaWMgPSBkdi5nZXRVaW50MzIob2Zmc2V0LCB0cnVlKTsKICAgIG9mZnNldCArPSBzaXplT2ZVaW50MzIyOwogICAgaWYgKG1hZ2ljICE9PSBjb21wcmVzc2VkTWFnaWMyICYmIG1hZ2ljICE9PSBjb21wcmVzc2VkTWFnaWNTd2FwMikgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIkludmFsaWQgbWFnaWMiKTsKICAgIH0KICAgIGNvbnN0IHNpemUgPSBkdi5nZXRVaW50MzIob2Zmc2V0LCBtYWdpYyA9PT0gY29tcHJlc3NlZE1hZ2ljMik7CiAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDMyMjsKICAgIGNvbnN0IGNvbXByZXNzZWRQYWNrZXQgPSBuZXcgVWludDhBcnJheShkYXRhLCBvZmZzZXQpOwogICAgY29uc3QgdW5jb21wcmVzc2VkUGFja2V0ID0gaW1wb3J0X2luZmxhdGUuZGVmYXVsdC5pbmZsYXRlKGNvbXByZXNzZWRQYWNrZXQpOwogICAgaWYgKHVuY29tcHJlc3NlZFBhY2tldC5sZW5ndGggIT09IHNpemUpIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJTaXplIG9mIHBhY2tldCBkb2Vzbid0IG1hdGNoIGhlYWRlciIpOwogICAgfQogICAgcmV0dXJuIHVuY29tcHJlc3NlZFBhY2tldDsKICB9CiAgdmFyIGltcG9ydF9pbmZsYXRlLCBzaXplT2ZVaW50MTYyLCBzaXplT2ZJbnQzMjIsIHNpemVPZlVpbnQzMjIsIFR5cGVzLCBxdE1hZ2ljLCBudW1NZXNoZXNQZXJQYWNrZXQsIG51bVN1Yk1lc2hlc1Blck1lc2gsIGNvbXByZXNzZWRNYWdpYzIsIGNvbXByZXNzZWRNYWdpY1N3YXAyLCBkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXRfZGVmYXVsdDsKICB2YXIgaW5pdF9kZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2RlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZVBhY2tldC5qcyIoKSB7CiAgICAgIGluaXRfZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlRGF0YSgpOwogICAgICBpbml0X0dvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbigpOwogICAgICBpbml0X1J1bnRpbWVFcnJvcigpOwogICAgICBpbXBvcnRfaW5mbGF0ZSA9IF9fdG9FU00ocmVxdWlyZV9pbmZsYXRlMigpLCAxKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIHNpemVPZlVpbnQxNjIgPSBVaW50MTZBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsKICAgICAgc2l6ZU9mSW50MzIyID0gSW50MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsKICAgICAgc2l6ZU9mVWludDMyMiA9IFVpbnQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICBUeXBlcyA9IHsKICAgICAgICBNRVRBREFUQTogMCwKICAgICAgICBURVJSQUlOOiAxLAogICAgICAgIERCUk9PVDogMgogICAgICB9OwogICAgICBUeXBlcy5mcm9tU3RyaW5nID0gZnVuY3Rpb24ocykgewogICAgICAgIGlmIChzID09PSAiTWV0YWRhdGEiKSB7CiAgICAgICAgICByZXR1cm4gVHlwZXMuTUVUQURBVEE7CiAgICAgICAgfSBlbHNlIGlmIChzID09PSAiVGVycmFpbiIpIHsKICAgICAgICAgIHJldHVybiBUeXBlcy5URVJSQUlOOwogICAgICAgIH0gZWxzZSBpZiAocyA9PT0gIkRiUm9vdCIpIHsKICAgICAgICAgIHJldHVybiBUeXBlcy5EQlJPT1Q7CiAgICAgICAgfQogICAgICB9OwogICAgICBxdE1hZ2ljID0gMzIzMDE7CiAgICAgIG51bU1lc2hlc1BlclBhY2tldCA9IDU7CiAgICAgIG51bVN1Yk1lc2hlc1Blck1lc2ggPSA0OwogICAgICBjb21wcmVzc2VkTWFnaWMyID0gMTk1MzAyOTgwNTsKICAgICAgY29tcHJlc3NlZE1hZ2ljU3dhcDIgPSAyOTE3MDM0MTAwOwogICAgICBkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXRfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdChkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXQpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvc3JnYlRvTGluZWFyLmpzCiAgZnVuY3Rpb24gc3JnYlRvTGluZWFyKHZhbHVlKSB7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInZhbHVlIiwgdmFsdWUpOwogICAgaWYgKHZhbHVlIDw9IDAuMDQwNDUpIHsKICAgICAgcmV0dXJuIHZhbHVlICogMC4wNzczOTkzODA4MDQ5NTM1NzsKICAgIH0KICAgIHJldHVybiBNYXRoLnBvdygKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWxvc3Mtb2YtcHJlY2lzaW9uCiAgICAgICh2YWx1ZSArIDAuMDU1KSAqIDAuOTQ3ODY3Mjk4NTc4MTk5MSwKICAgICAgMi40CiAgICApOwogIH0KICB2YXIgc3JnYlRvTGluZWFyX2RlZmF1bHQ7CiAgdmFyIGluaXRfc3JnYlRvTGluZWFyID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9zcmdiVG9MaW5lYXIuanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIHNyZ2JUb0xpbmVhcl9kZWZhdWx0ID0gc3JnYlRvTGluZWFyOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvZGVjb2RlSTNTLmpzCiAgdmFyIGRlY29kZUkzU19leHBvcnRzID0ge307CiAgX19leHBvcnQoZGVjb2RlSTNTX2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGRlY29kZUkzU19kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gYmlsaW5lYXJJbnRlcnBvbGF0ZSh0eCwgdHksIGgwMCwgaDEwLCBoMDEsIGgxMSkgewogICAgY29uc3QgYTMgPSBoMDAgKiAoMSAtIHR4KSArIGgxMCAqIHR4OwogICAgY29uc3QgYiA9IGgwMSAqICgxIC0gdHgpICsgaDExICogdHg7CiAgICByZXR1cm4gYTMgKiAoMSAtIHR5KSArIGIgKiB0eTsKICB9CiAgZnVuY3Rpb24gc2FtcGxlTWFwKHUzLCB2Mywgd2lkdGgsIGRhdGEpIHsKICAgIGNvbnN0IGFkZHJlc3MgPSB1MyArIHYzICogd2lkdGg7CiAgICByZXR1cm4gZGF0YVthZGRyZXNzXTsKICB9CiAgZnVuY3Rpb24gc2FtcGxlR2VvaWQoc2FtcGxlWCwgc2FtcGxlWSwgZ2VvaWREYXRhKSB7CiAgICBjb25zdCBleHRlbnQgPSBnZW9pZERhdGEubmF0aXZlRXh0ZW50OwogICAgbGV0IHggPSAoc2FtcGxlWCAtIGV4dGVudC53ZXN0KSAvIChleHRlbnQuZWFzdCAtIGV4dGVudC53ZXN0KSAqIChnZW9pZERhdGEud2lkdGggLSAxKTsKICAgIGxldCB5ID0gKHNhbXBsZVkgLSBleHRlbnQuc291dGgpIC8gKGV4dGVudC5ub3J0aCAtIGV4dGVudC5zb3V0aCkgKiAoZ2VvaWREYXRhLmhlaWdodCAtIDEpOwogICAgY29uc3QgeGkgPSBNYXRoLmZsb29yKHgpOwogICAgbGV0IHlpID0gTWF0aC5mbG9vcih5KTsKICAgIHggLT0geGk7CiAgICB5IC09IHlpOwogICAgY29uc3QgeE5leHQgPSB4aSA8IGdlb2lkRGF0YS53aWR0aCA/IHhpICsgMSA6IHhpOwogICAgbGV0IHlOZXh0ID0geWkgPCBnZW9pZERhdGEuaGVpZ2h0ID8geWkgKyAxIDogeWk7CiAgICB5aSA9IGdlb2lkRGF0YS5oZWlnaHQgLSAxIC0geWk7CiAgICB5TmV4dCA9IGdlb2lkRGF0YS5oZWlnaHQgLSAxIC0geU5leHQ7CiAgICBjb25zdCBoMDAgPSBzYW1wbGVNYXAoeGksIHlpLCBnZW9pZERhdGEud2lkdGgsIGdlb2lkRGF0YS5idWZmZXIpOwogICAgY29uc3QgaDEwID0gc2FtcGxlTWFwKHhOZXh0LCB5aSwgZ2VvaWREYXRhLndpZHRoLCBnZW9pZERhdGEuYnVmZmVyKTsKICAgIGNvbnN0IGgwMSA9IHNhbXBsZU1hcCh4aSwgeU5leHQsIGdlb2lkRGF0YS53aWR0aCwgZ2VvaWREYXRhLmJ1ZmZlcik7CiAgICBjb25zdCBoMTEgPSBzYW1wbGVNYXAoeE5leHQsIHlOZXh0LCBnZW9pZERhdGEud2lkdGgsIGdlb2lkRGF0YS5idWZmZXIpOwogICAgbGV0IGZpbmFsSGVpZ2h0ID0gYmlsaW5lYXJJbnRlcnBvbGF0ZSh4LCB5LCBoMDAsIGgxMCwgaDAxLCBoMTEpOwogICAgZmluYWxIZWlnaHQgPSBmaW5hbEhlaWdodCAqIGdlb2lkRGF0YS5zY2FsZSArIGdlb2lkRGF0YS5vZmZzZXQ7CiAgICByZXR1cm4gZmluYWxIZWlnaHQ7CiAgfQogIGZ1bmN0aW9uIHNhbXBsZUdlb2lkRnJvbUxpc3QobG9uLCBsYXQsIGdlb2lkRGF0YUxpc3QpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZ2VvaWREYXRhTGlzdC5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBsb2NhbEV4dGVudCA9IGdlb2lkRGF0YUxpc3RbaV0ubmF0aXZlRXh0ZW50OwogICAgICBsZXQgbG9jYWxQdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgaWYgKGdlb2lkRGF0YUxpc3RbaV0ucHJvamVjdGlvblR5cGUgPT09ICJXZWJNZXJjYXRvciIpIHsKICAgICAgICBjb25zdCByYWRpaSA9IGdlb2lkRGF0YUxpc3RbaV0ucHJvamVjdGlvbi5fZWxsaXBzb2lkLl9yYWRpaTsKICAgICAgICBjb25zdCB3ZWJNZXJjYXRvclByb2ogPSBuZXcgV2ViTWVyY2F0b3JQcm9qZWN0aW9uX2RlZmF1bHQoCiAgICAgICAgICBuZXcgRWxsaXBzb2lkX2RlZmF1bHQocmFkaWkueCwgcmFkaWkueSwgcmFkaWkueikKICAgICAgICApOwogICAgICAgIGxvY2FsUHQgPSB3ZWJNZXJjYXRvclByb2oucHJvamVjdChuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQobG9uLCBsYXQsIDApKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBsb2NhbFB0LnggPSBsb247CiAgICAgICAgbG9jYWxQdC55ID0gbGF0OwogICAgICB9CiAgICAgIGlmIChsb2NhbFB0LnggPiBsb2NhbEV4dGVudC53ZXN0ICYmIGxvY2FsUHQueCA8IGxvY2FsRXh0ZW50LmVhc3QgJiYgbG9jYWxQdC55ID4gbG9jYWxFeHRlbnQuc291dGggJiYgbG9jYWxQdC55IDwgbG9jYWxFeHRlbnQubm9ydGgpIHsKICAgICAgICByZXR1cm4gc2FtcGxlR2VvaWQobG9jYWxQdC54LCBsb2NhbFB0LnksIGdlb2lkRGF0YUxpc3RbaV0pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gMDsKICB9CiAgZnVuY3Rpb24gb3J0aG9tZXRyaWNUb0VsbGlwc29pZGFsKHZlcnRleENvdW50LCBwb3NpdGlvbiwgc2NhbGVfeCwgc2NhbGVfeSwgY2VudGVyLCBnZW9pZERhdGFMaXN0LCBmYXN0KSB7CiAgICBpZiAoZmFzdCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBjZW50ZXJIZWlnaHQgPSBzYW1wbGVHZW9pZEZyb21MaXN0KAogICAgICBjZW50ZXIubG9uZ2l0dWRlLAogICAgICBjZW50ZXIubGF0aXR1ZGUsCiAgICAgIGdlb2lkRGF0YUxpc3QKICAgICk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZlcnRleENvdW50OyArK2kpIHsKICAgICAgY29uc3QgaGVpZ2h0ID0gc2FtcGxlR2VvaWRGcm9tTGlzdCgKICAgICAgICBjZW50ZXIubG9uZ2l0dWRlICsgTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhzY2FsZV94ICogcG9zaXRpb25baSAqIDNdKSwKICAgICAgICBjZW50ZXIubGF0aXR1ZGUgKyBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKHNjYWxlX3kgKiBwb3NpdGlvbltpICogMyArIDFdKSwKICAgICAgICBnZW9pZERhdGFMaXN0CiAgICAgICk7CiAgICAgIHBvc2l0aW9uW2kgKiAzICsgMl0gKz0gaGVpZ2h0IC0gY2VudGVySGVpZ2h0OwogICAgfQogIH0KICBmdW5jdGlvbiB0cmFuc2Zvcm1Ub0xvY2FsKHZlcnRleENvdW50LCBwb3NpdGlvbnMsIG5vcm1hbHMsIGNhcnRvZ3JhcGhpY0NlbnRlciwgY2FydGVzaWFuQ2VudGVyLCBwYXJlbnRSb3RhdGlvbiwgZWxsaXBzb2lkUmFkaWlTcXVhcmUsIHNjYWxlX3gsIHNjYWxlX3kpIHsKICAgIGlmICh2ZXJ0ZXhDb3VudCA9PT0gMCB8fCAhZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgfHwgcG9zaXRpb25zLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBlbGxpcHNvaWQgPSBuZXcgRWxsaXBzb2lkX2RlZmF1bHQoCiAgICAgIE1hdGguc3FydChlbGxpcHNvaWRSYWRpaVNxdWFyZS54KSwKICAgICAgTWF0aC5zcXJ0KGVsbGlwc29pZFJhZGlpU3F1YXJlLnkpLAogICAgICBNYXRoLnNxcnQoZWxsaXBzb2lkUmFkaWlTcXVhcmUueikKICAgICk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZlcnRleENvdW50OyArK2kpIHsKICAgICAgY29uc3QgaW5kZXhPZmZzZXQgPSBpICogMzsKICAgICAgY29uc3QgaW5kZXhPZmZzZXQxID0gaW5kZXhPZmZzZXQgKyAxOwogICAgICBjb25zdCBpbmRleE9mZnNldDIgPSBpbmRleE9mZnNldCArIDI7CiAgICAgIGNvbnN0IGNhcnRvZ3JhcGhpYzIgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgY2FydG9ncmFwaGljMi5sb25naXR1ZGUgPSBjYXJ0b2dyYXBoaWNDZW50ZXIubG9uZ2l0dWRlICsgTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhzY2FsZV94ICogcG9zaXRpb25zW2luZGV4T2Zmc2V0XSk7CiAgICAgIGNhcnRvZ3JhcGhpYzIubGF0aXR1ZGUgPSBjYXJ0b2dyYXBoaWNDZW50ZXIubGF0aXR1ZGUgKyBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKHNjYWxlX3kgKiBwb3NpdGlvbnNbaW5kZXhPZmZzZXQxXSk7CiAgICAgIGNhcnRvZ3JhcGhpYzIuaGVpZ2h0ID0gY2FydG9ncmFwaGljQ2VudGVyLmhlaWdodCArIHBvc2l0aW9uc1tpbmRleE9mZnNldDJdOwogICAgICBjb25zdCBwb3NpdGlvbiA9IHt9OwogICAgICBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oY2FydG9ncmFwaGljMiwgcG9zaXRpb24pOwogICAgICBwb3NpdGlvbi54IC09IGNhcnRlc2lhbkNlbnRlci54OwogICAgICBwb3NpdGlvbi55IC09IGNhcnRlc2lhbkNlbnRlci55OwogICAgICBwb3NpdGlvbi56IC09IGNhcnRlc2lhbkNlbnRlci56OwogICAgICBjb25zdCByb3RhdGVkUG9zaXRpb24gPSB7fTsKICAgICAgTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IocGFyZW50Um90YXRpb24sIHBvc2l0aW9uLCByb3RhdGVkUG9zaXRpb24pOwogICAgICBwb3NpdGlvbnNbaW5kZXhPZmZzZXRdID0gcm90YXRlZFBvc2l0aW9uLng7CiAgICAgIHBvc2l0aW9uc1tpbmRleE9mZnNldDFdID0gcm90YXRlZFBvc2l0aW9uLnk7CiAgICAgIHBvc2l0aW9uc1tpbmRleE9mZnNldDJdID0gcm90YXRlZFBvc2l0aW9uLno7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobm9ybWFscykpIHsKICAgICAgICBjb25zdCBub3JtYWwyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgKICAgICAgICAgIG5vcm1hbHNbaW5kZXhPZmZzZXRdLAogICAgICAgICAgbm9ybWFsc1tpbmRleE9mZnNldDFdLAogICAgICAgICAgbm9ybWFsc1tpbmRleE9mZnNldDJdCiAgICAgICAgKTsKICAgICAgICBjb25zdCByb3RhdGVkTm9ybWFsID0ge307CiAgICAgICAgTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IocGFyZW50Um90YXRpb24sIG5vcm1hbDIsIHJvdGF0ZWROb3JtYWwpOwogICAgICAgIG5vcm1hbHNbaW5kZXhPZmZzZXRdID0gcm90YXRlZE5vcm1hbC54OwogICAgICAgIG5vcm1hbHNbaW5kZXhPZmZzZXQxXSA9IHJvdGF0ZWROb3JtYWwueTsKICAgICAgICBub3JtYWxzW2luZGV4T2Zmc2V0Ml0gPSByb3RhdGVkTm9ybWFsLno7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gY3JvcFVWcyh2ZXJ0ZXhDb3VudCwgdXYwcywgdXZSZWdpb25zKSB7CiAgICBmb3IgKGxldCB2ZXJ0ZXhJbmRleCA9IDA7IHZlcnRleEluZGV4IDwgdmVydGV4Q291bnQ7ICsrdmVydGV4SW5kZXgpIHsKICAgICAgY29uc3QgbWluVSA9IHV2UmVnaW9uc1t2ZXJ0ZXhJbmRleCAqIDRdIC8gNjU1MzU7CiAgICAgIGNvbnN0IG1pblYgPSB1dlJlZ2lvbnNbdmVydGV4SW5kZXggKiA0ICsgMV0gLyA2NTUzNTsKICAgICAgY29uc3Qgc2NhbGVVID0gKHV2UmVnaW9uc1t2ZXJ0ZXhJbmRleCAqIDQgKyAyXSAtIHV2UmVnaW9uc1t2ZXJ0ZXhJbmRleCAqIDRdKSAvIDY1NTM1OwogICAgICBjb25zdCBzY2FsZVYgPSAodXZSZWdpb25zW3ZlcnRleEluZGV4ICogNCArIDNdIC0gdXZSZWdpb25zW3ZlcnRleEluZGV4ICogNCArIDFdKSAvIDY1NTM1OwogICAgICB1djBzW3ZlcnRleEluZGV4ICogMl0gKj0gc2NhbGVVOwogICAgICB1djBzW3ZlcnRleEluZGV4ICogMl0gKz0gbWluVTsKICAgICAgdXYwc1t2ZXJ0ZXhJbmRleCAqIDIgKyAxXSAqPSBzY2FsZVY7CiAgICAgIHV2MHNbdmVydGV4SW5kZXggKiAyICsgMV0gKz0gbWluVjsKICAgIH0KICB9CiAgZnVuY3Rpb24gZ2VuZXJhdGVJbmRleEFycmF5KHZlcnRleENvdW50LCBpbmRpY2VzLCBjb2xvcnMsIHNwbGl0R2VvbWV0cnlCeUNvbG9yVHJhbnNwYXJlbmN5KSB7CiAgICBjb25zdCBpbmRleEFycmF5ID0gbmV3IFVpbnQzMkFycmF5KHZlcnRleENvdW50KTsKICAgIGNvbnN0IHZlcnRleEluZGV4Rm4gPSBkZWZpbmVkX2RlZmF1bHQoaW5kaWNlcykgPyAodmVydGV4SW5kZXgpID0+IGluZGljZXNbdmVydGV4SW5kZXhdIDogKHZlcnRleEluZGV4KSA9PiB2ZXJ0ZXhJbmRleDsKICAgIGxldCB0cmFuc3BhcmVudFZlcnRleE9mZnNldCA9IDA7CiAgICBpZiAoc3BsaXRHZW9tZXRyeUJ5Q29sb3JUcmFuc3BhcmVuY3kgJiYgZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykpIHsKICAgICAgY29uc3QgaXNWZXJ0ZXhUcmFuc3BhcmVudEZuID0gKHZlcnRleEluZGV4KSA9PiBjb2xvcnNbdmVydGV4SW5kZXhGbih2ZXJ0ZXhJbmRleCkgKiA0ICsgM10gPCAyNTU7CiAgICAgIGZvciAobGV0IHZlcnRleEluZGV4ID0gMDsgdmVydGV4SW5kZXggPCB2ZXJ0ZXhDb3VudDsgdmVydGV4SW5kZXggKz0gMykgewogICAgICAgIGlmICghaXNWZXJ0ZXhUcmFuc3BhcmVudEZuKHZlcnRleEluZGV4KSAmJiAhaXNWZXJ0ZXhUcmFuc3BhcmVudEZuKHZlcnRleEluZGV4ICsgMSkgJiYgIWlzVmVydGV4VHJhbnNwYXJlbnRGbih2ZXJ0ZXhJbmRleCArIDIpKSB7CiAgICAgICAgICBpbmRleEFycmF5W3RyYW5zcGFyZW50VmVydGV4T2Zmc2V0KytdID0gdmVydGV4SW5kZXhGbih2ZXJ0ZXhJbmRleCk7CiAgICAgICAgICBpbmRleEFycmF5W3RyYW5zcGFyZW50VmVydGV4T2Zmc2V0KytdID0gdmVydGV4SW5kZXhGbih2ZXJ0ZXhJbmRleCArIDEpOwogICAgICAgICAgaW5kZXhBcnJheVt0cmFuc3BhcmVudFZlcnRleE9mZnNldCsrXSA9IHZlcnRleEluZGV4Rm4odmVydGV4SW5kZXggKyAyKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHRyYW5zcGFyZW50VmVydGV4T2Zmc2V0ID4gMCkgewogICAgICAgIGxldCBvZmZzZXQgPSB0cmFuc3BhcmVudFZlcnRleE9mZnNldDsKICAgICAgICBmb3IgKGxldCB2ZXJ0ZXhJbmRleCA9IDA7IHZlcnRleEluZGV4IDwgdmVydGV4Q291bnQ7IHZlcnRleEluZGV4ICs9IDMpIHsKICAgICAgICAgIGlmIChpc1ZlcnRleFRyYW5zcGFyZW50Rm4odmVydGV4SW5kZXgpIHx8IGlzVmVydGV4VHJhbnNwYXJlbnRGbih2ZXJ0ZXhJbmRleCArIDEpIHx8IGlzVmVydGV4VHJhbnNwYXJlbnRGbih2ZXJ0ZXhJbmRleCArIDIpKSB7CiAgICAgICAgICAgIGluZGV4QXJyYXlbb2Zmc2V0KytdID0gdmVydGV4SW5kZXhGbih2ZXJ0ZXhJbmRleCk7CiAgICAgICAgICAgIGluZGV4QXJyYXlbb2Zmc2V0KytdID0gdmVydGV4SW5kZXhGbih2ZXJ0ZXhJbmRleCArIDEpOwogICAgICAgICAgICBpbmRleEFycmF5W29mZnNldCsrXSA9IHZlcnRleEluZGV4Rm4odmVydGV4SW5kZXggKyAyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yIChsZXQgdmVydGV4SW5kZXggPSAwOyB2ZXJ0ZXhJbmRleCA8IHZlcnRleENvdW50OyArK3ZlcnRleEluZGV4KSB7CiAgICAgICAgICBpbmRleEFycmF5W3ZlcnRleEluZGV4XSA9IHZlcnRleEluZGV4Rm4odmVydGV4SW5kZXgpOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdHJhbnNwYXJlbnRWZXJ0ZXhPZmZzZXQgPSB2ZXJ0ZXhDb3VudDsKICAgICAgZm9yIChsZXQgdmVydGV4SW5kZXggPSAwOyB2ZXJ0ZXhJbmRleCA8IHZlcnRleENvdW50OyArK3ZlcnRleEluZGV4KSB7CiAgICAgICAgaW5kZXhBcnJheVt2ZXJ0ZXhJbmRleF0gPSB2ZXJ0ZXhJbmRleEZuKHZlcnRleEluZGV4KTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHsKICAgICAgaW5kZXhBcnJheSwKICAgICAgdHJhbnNwYXJlbnRWZXJ0ZXhPZmZzZXQKICAgIH07CiAgfQogIGZ1bmN0aW9uIGdldEZlYXR1cmVIYXNoKHN5bWJvbG9neURhdGEsIG91dGxpbmVzSGFzaCwgZmVhdHVyZUluZGV4KSB7CiAgICBjb25zdCBmZWF0dXJlSGFzaCA9IG91dGxpbmVzSGFzaFtmZWF0dXJlSW5kZXhdOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChmZWF0dXJlSGFzaCkpIHsKICAgICAgcmV0dXJuIGZlYXR1cmVIYXNoOwogICAgfQogICAgY29uc3QgbmV3RmVhdHVyZUhhc2ggPSBvdXRsaW5lc0hhc2hbZmVhdHVyZUluZGV4XSA9IHsKICAgICAgcG9zaXRpb25zOiB7fSwKICAgICAgaW5kaWNlczoge30sCiAgICAgIGVkZ2VzOiB7fQogICAgfTsKICAgIGNvbnN0IGZlYXR1cmVTeW1ib2xvZ3kgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgc3ltYm9sb2d5RGF0YVtmZWF0dXJlSW5kZXhdLAogICAgICBzeW1ib2xvZ3lEYXRhLmRlZmF1bHQKICAgICk7CiAgICBuZXdGZWF0dXJlSGFzaC5oYXNPdXRsaW5lID0gZGVmaW5lZF9kZWZhdWx0KGZlYXR1cmVTeW1ib2xvZ3k/LmVkZ2VzKTsKICAgIHJldHVybiBuZXdGZWF0dXJlSGFzaDsKICB9CiAgZnVuY3Rpb24gYWRkVmVydGV4VG9IYXNoKGluZGV4SGFzaCwgcG9zaXRpb25IYXNoLCB2ZXJ0ZXhJbmRleCwgcG9zaXRpb25zKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbmRleEhhc2hbdmVydGV4SW5kZXhdKSkgewogICAgICBjb25zdCBzdGFydFBvc2l0aW9uSW5kZXggPSB2ZXJ0ZXhJbmRleCAqIDM7CiAgICAgIGxldCBjb29yZGluYXRlSGFzaCA9IHBvc2l0aW9uSGFzaDsKICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IDM7IGluZGV4KyspIHsKICAgICAgICBjb25zdCBjb29yZGluYXRlID0gcG9zaXRpb25zW3N0YXJ0UG9zaXRpb25JbmRleCArIGluZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjb29yZGluYXRlSGFzaFtjb29yZGluYXRlXSkpIHsKICAgICAgICAgIGNvb3JkaW5hdGVIYXNoW2Nvb3JkaW5hdGVdID0ge307CiAgICAgICAgfQogICAgICAgIGNvb3JkaW5hdGVIYXNoID0gY29vcmRpbmF0ZUhhc2hbY29vcmRpbmF0ZV07CiAgICAgIH0KICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY29vcmRpbmF0ZUhhc2guaW5kZXgpKSB7CiAgICAgICAgY29vcmRpbmF0ZUhhc2guaW5kZXggPSB2ZXJ0ZXhJbmRleDsKICAgICAgfQogICAgICBpbmRleEhhc2hbdmVydGV4SW5kZXhdID0gY29vcmRpbmF0ZUhhc2guaW5kZXg7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGFkZEVkZ2VUb0hhc2goZWRnZUhhc2gsIHZlcnRleEFJbmRleCwgdmVydGV4QkluZGV4LCB2ZXJ0ZXhBSW5kZXhVbmlxdWUsIHZlcnRleEJJbmRleFVuaXF1ZSwgbm9ybWFsSW5kZXgpIHsKICAgIGxldCBzdGFydFZlcnRleEluZGV4OwogICAgbGV0IGVuZFZlcnRleEluZGV4OwogICAgaWYgKHZlcnRleEFJbmRleFVuaXF1ZSA8IHZlcnRleEJJbmRleFVuaXF1ZSkgewogICAgICBzdGFydFZlcnRleEluZGV4ID0gdmVydGV4QUluZGV4VW5pcXVlOwogICAgICBlbmRWZXJ0ZXhJbmRleCA9IHZlcnRleEJJbmRleFVuaXF1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHN0YXJ0VmVydGV4SW5kZXggPSB2ZXJ0ZXhCSW5kZXhVbmlxdWU7CiAgICAgIGVuZFZlcnRleEluZGV4ID0gdmVydGV4QUluZGV4VW5pcXVlOwogICAgfQogICAgbGV0IGVkZ2VTdGFydCA9IGVkZ2VIYXNoW3N0YXJ0VmVydGV4SW5kZXhdOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZWRnZVN0YXJ0KSkgewogICAgICBlZGdlU3RhcnQgPSBlZGdlSGFzaFtzdGFydFZlcnRleEluZGV4XSA9IHt9OwogICAgfQogICAgbGV0IGVkZ2VFbmQgPSBlZGdlU3RhcnRbZW5kVmVydGV4SW5kZXhdOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZWRnZUVuZCkpIHsKICAgICAgZWRnZUVuZCA9IGVkZ2VTdGFydFtlbmRWZXJ0ZXhJbmRleF0gPSB7CiAgICAgICAgbm9ybWFsc0luZGV4OiBbXSwKICAgICAgICBvdXRsaW5lczogW10KICAgICAgfTsKICAgIH0KICAgIGVkZ2VFbmQubm9ybWFsc0luZGV4LnB1c2gobm9ybWFsSW5kZXgpOwogICAgaWYgKGVkZ2VFbmQub3V0bGluZXMubGVuZ3RoID09PSAwIHx8IHZlcnRleEFJbmRleCAhPT0gdmVydGV4QUluZGV4VW5pcXVlIHx8IHZlcnRleEJJbmRleCAhPT0gdmVydGV4QkluZGV4VW5pcXVlKSB7CiAgICAgIGVkZ2VFbmQub3V0bGluZXMucHVzaCh2ZXJ0ZXhBSW5kZXgsIHZlcnRleEJJbmRleCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdlbmVyYXRlT3V0bGluZXNIYXNoKHN5bWJvbG9neURhdGEsIGZlYXR1cmVJbmRleEFycmF5LCBpbmRleEFycmF5LCBwb3NpdGlvbnMpIHsKICAgIGNvbnN0IG91dGxpbmVzSGFzaCA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmRleEFycmF5Lmxlbmd0aDsgaSArPSAzKSB7CiAgICAgIGNvbnN0IGZlYXR1cmVJbmRleCA9IGRlZmluZWRfZGVmYXVsdChmZWF0dXJlSW5kZXhBcnJheSkgPyBmZWF0dXJlSW5kZXhBcnJheVtpbmRleEFycmF5W2ldXSA6ICJkZWZhdWx0IjsKICAgICAgY29uc3QgZmVhdHVyZUhhc2ggPSBnZXRGZWF0dXJlSGFzaCgKICAgICAgICBzeW1ib2xvZ3lEYXRhLAogICAgICAgIG91dGxpbmVzSGFzaCwKICAgICAgICBmZWF0dXJlSW5kZXgKICAgICAgKTsKICAgICAgaWYgKCFmZWF0dXJlSGFzaC5oYXNPdXRsaW5lKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29uc3QgaW5kZXhIYXNoID0gZmVhdHVyZUhhc2guaW5kaWNlczsKICAgICAgY29uc3QgcG9zaXRpb25IYXNoID0gZmVhdHVyZUhhc2gucG9zaXRpb25zOwogICAgICBmb3IgKGxldCB2ZXJ0ZXggPSAwOyB2ZXJ0ZXggPCAzOyB2ZXJ0ZXgrKykgewogICAgICAgIGNvbnN0IHZlcnRleEluZGV4ID0gaW5kZXhBcnJheVtpICsgdmVydGV4XTsKICAgICAgICBhZGRWZXJ0ZXhUb0hhc2goaW5kZXhIYXNoLCBwb3NpdGlvbkhhc2gsIHZlcnRleEluZGV4LCBwb3NpdGlvbnMpOwogICAgICB9CiAgICAgIGNvbnN0IGVkZ2VIYXNoID0gZmVhdHVyZUhhc2guZWRnZXM7CiAgICAgIGZvciAobGV0IHZlcnRleCA9IDA7IHZlcnRleCA8IDM7IHZlcnRleCsrKSB7CiAgICAgICAgY29uc3QgdmVydGV4SW5kZXggPSBpbmRleEFycmF5W2kgKyB2ZXJ0ZXhdOwogICAgICAgIGNvbnN0IG5leHRWZXJ0ZXhJbmRleCA9IGluZGV4QXJyYXlbaSArICh2ZXJ0ZXggKyAxKSAlIDNdOwogICAgICAgIGNvbnN0IHVuaXF1ZVZlcnRleEluZGV4ID0gaW5kZXhIYXNoW3ZlcnRleEluZGV4XTsKICAgICAgICBjb25zdCB1bmlxdWVOZXh0VmVydGV4SW5kZXggPSBpbmRleEhhc2hbbmV4dFZlcnRleEluZGV4XTsKICAgICAgICBhZGRFZGdlVG9IYXNoKAogICAgICAgICAgZWRnZUhhc2gsCiAgICAgICAgICB2ZXJ0ZXhJbmRleCwKICAgICAgICAgIG5leHRWZXJ0ZXhJbmRleCwKICAgICAgICAgIHVuaXF1ZVZlcnRleEluZGV4LAogICAgICAgICAgdW5pcXVlTmV4dFZlcnRleEluZGV4LAogICAgICAgICAgaQogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBvdXRsaW5lc0hhc2g7CiAgfQogIGZ1bmN0aW9uIGNhbGN1bGF0ZUZhY2VOb3JtYWwobm9ybWFscywgdmVydGV4QUluZGV4LCBpbmRleEFycmF5LCBwb3NpdGlvbnMpIHsKICAgIGNvbnN0IHBvc2l0aW9uQUluZGV4ID0gaW5kZXhBcnJheVt2ZXJ0ZXhBSW5kZXhdICogMzsKICAgIGNvbnN0IHBvc2l0aW9uQkluZGV4ID0gaW5kZXhBcnJheVt2ZXJ0ZXhBSW5kZXggKyAxXSAqIDM7CiAgICBjb25zdCBwb3NpdGlvbkNJbmRleCA9IGluZGV4QXJyYXlbdmVydGV4QUluZGV4ICsgMl0gKiAzOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIHBvc2l0aW9uQUluZGV4LCBjYWxjdWxhdGVGYWNlTm9ybWFsQSk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgcG9zaXRpb25CSW5kZXgsIGNhbGN1bGF0ZUZhY2VOb3JtYWxCKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBwb3NpdGlvbkNJbmRleCwgY2FsY3VsYXRlRmFjZU5vcm1hbEMpOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICBjYWxjdWxhdGVGYWNlTm9ybWFsQiwKICAgICAgY2FsY3VsYXRlRmFjZU5vcm1hbEEsCiAgICAgIGNhbGN1bGF0ZUZhY2VOb3JtYWxCCiAgICApOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICBjYWxjdWxhdGVGYWNlTm9ybWFsQywKICAgICAgY2FsY3VsYXRlRmFjZU5vcm1hbEEsCiAgICAgIGNhbGN1bGF0ZUZhY2VOb3JtYWxDCiAgICApOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKAogICAgICBjYWxjdWxhdGVGYWNlTm9ybWFsQiwKICAgICAgY2FsY3VsYXRlRmFjZU5vcm1hbEMsCiAgICAgIGNhbGN1bGF0ZUZhY2VOb3JtYWxBCiAgICApOwogICAgY29uc3QgbWFnbml0dWRlID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZShjYWxjdWxhdGVGYWNlTm9ybWFsQSk7CiAgICBpZiAobWFnbml0dWRlICE9PSAwKSB7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5kaXZpZGVCeVNjYWxhcigKICAgICAgICBjYWxjdWxhdGVGYWNlTm9ybWFsQSwKICAgICAgICBtYWduaXR1ZGUsCiAgICAgICAgY2FsY3VsYXRlRmFjZU5vcm1hbEEKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IG5vcm1hbEFJbmRleCA9IHZlcnRleEFJbmRleCAqIDM7CiAgICBjb25zdCBub3JtYWxCSW5kZXggPSAodmVydGV4QUluZGV4ICsgMSkgKiAzOwogICAgY29uc3Qgbm9ybWFsQ0luZGV4ID0gKHZlcnRleEFJbmRleCArIDIpICogMzsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGNhbGN1bGF0ZUZhY2VOb3JtYWxBLCBub3JtYWxzLCBub3JtYWxBSW5kZXgpOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soY2FsY3VsYXRlRmFjZU5vcm1hbEEsIG5vcm1hbHMsIG5vcm1hbEJJbmRleCk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhjYWxjdWxhdGVGYWNlTm9ybWFsQSwgbm9ybWFscywgbm9ybWFsQ0luZGV4KTsKICB9CiAgZnVuY3Rpb24gaXNFZGdlU21vb3RoKG5vcm1hbHMsIG5vcm1hbEFJbmRleCwgbm9ybWFsQkluZGV4KSB7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KG5vcm1hbHMsIG5vcm1hbEFJbmRleCwgaXNFZGdlU21vb3RoQSk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KG5vcm1hbHMsIG5vcm1hbEJJbmRleCwgaXNFZGdlU21vb3RoQik7CiAgICBjb25zdCBjb3NpbmUgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGlzRWRnZVNtb290aEEsIGlzRWRnZVNtb290aEIpOwogICAgY29uc3Qgc2luZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhpc0VkZ2VTbW9vdGhBLCBpc0VkZ2VTbW9vdGhCLCBpc0VkZ2VTbW9vdGhBKQogICAgKTsKICAgIHJldHVybiBNYXRoLmF0YW4yKHNpbmUsIGNvc2luZSkgPCAwLjI1OwogIH0KICBmdW5jdGlvbiBhZGRPdXRsaW5lc0ZvckVkZ2Uob3V0bGluZXMsIGVkZ2VEYXRhLCBpbmRleEFycmF5LCBwb3NpdGlvbnMsIG5vcm1hbHMpIHsKICAgIGlmIChlZGdlRGF0YS5ub3JtYWxzSW5kZXgubGVuZ3RoID4gMSkgewogICAgICBjb25zdCBub3JtYWxzQnlJbmRleCA9IHBvc2l0aW9ucy5sZW5ndGggPT09IG5vcm1hbHMubGVuZ3RoOwogICAgICBmb3IgKGxldCBpbmRleEEgPSAwOyBpbmRleEEgPCBlZGdlRGF0YS5ub3JtYWxzSW5kZXgubGVuZ3RoOyBpbmRleEErKykgewogICAgICAgIGNvbnN0IHZlcnRleEFJbmRleCA9IGVkZ2VEYXRhLm5vcm1hbHNJbmRleFtpbmRleEFdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG5vcm1hbHNbdmVydGV4QUluZGV4ICogM10pKSB7CiAgICAgICAgICBjYWxjdWxhdGVGYWNlTm9ybWFsKG5vcm1hbHMsIHZlcnRleEFJbmRleCwgaW5kZXhBcnJheSwgcG9zaXRpb25zKTsKICAgICAgICB9CiAgICAgICAgaWYgKGluZGV4QSA9PT0gMCkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGluZGV4QiA9IDA7IGluZGV4QiA8IGluZGV4QTsgaW5kZXhCKyspIHsKICAgICAgICAgIGNvbnN0IHZlcnRleEJJbmRleCA9IGVkZ2VEYXRhLm5vcm1hbHNJbmRleFtpbmRleEJdOwogICAgICAgICAgY29uc3Qgbm9ybWFsQUluZGV4ID0gbm9ybWFsc0J5SW5kZXggPyBpbmRleEFycmF5W3ZlcnRleEFJbmRleF0gKiAzIDogdmVydGV4QUluZGV4ICogMzsKICAgICAgICAgIGNvbnN0IG5vcm1hbEJJbmRleCA9IG5vcm1hbHNCeUluZGV4ID8gaW5kZXhBcnJheVt2ZXJ0ZXhCSW5kZXhdICogMyA6IHZlcnRleEJJbmRleCAqIDM7CiAgICAgICAgICBpZiAoaXNFZGdlU21vb3RoKG5vcm1hbHMsIG5vcm1hbEFJbmRleCwgbm9ybWFsQkluZGV4KSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBvdXRsaW5lcy5wdXNoKC4uLmVkZ2VEYXRhLm91dGxpbmVzKTsKICB9CiAgZnVuY3Rpb24gYWRkT3V0bGluZXNGb3JGZWF0dXJlKG91dGxpbmVzLCBlZGdlSGFzaCwgaW5kZXhBcnJheSwgcG9zaXRpb25zLCBub3JtYWxzKSB7CiAgICBjb25zdCBlZGdlU3RhcnRLZXlzID0gT2JqZWN0LmtleXMoZWRnZUhhc2gpOwogICAgZm9yIChsZXQgc3RhcnRJbmRleCA9IDA7IHN0YXJ0SW5kZXggPCBlZGdlU3RhcnRLZXlzLmxlbmd0aDsgc3RhcnRJbmRleCsrKSB7CiAgICAgIGNvbnN0IGVkZ2VFbmRzID0gZWRnZUhhc2hbZWRnZVN0YXJ0S2V5c1tzdGFydEluZGV4XV07CiAgICAgIGNvbnN0IGVkZ2VFbmRLZXlzID0gT2JqZWN0LmtleXMoZWRnZUVuZHMpOwogICAgICBmb3IgKGxldCBlbmRJbmRleCA9IDA7IGVuZEluZGV4IDwgZWRnZUVuZEtleXMubGVuZ3RoOyBlbmRJbmRleCsrKSB7CiAgICAgICAgY29uc3QgZWRnZURhdGEgPSBlZGdlRW5kc1tlZGdlRW5kS2V5c1tlbmRJbmRleF1dOwogICAgICAgIGFkZE91dGxpbmVzRm9yRWRnZShvdXRsaW5lcywgZWRnZURhdGEsIGluZGV4QXJyYXksIHBvc2l0aW9ucywgbm9ybWFscyk7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gZ2VuZXJhdGVPdXRsaW5lc0Zyb21IYXNoKG91dGxpbmVzSGFzaCwgaW5kZXhBcnJheSwgcG9zaXRpb25zLCBub3JtYWxzKSB7CiAgICBjb25zdCBvdXRsaW5lcyA9IFtdOwogICAgY29uc3QgZmVhdHVyZXMgPSBPYmplY3Qua2V5cyhvdXRsaW5lc0hhc2gpOwogICAgZm9yIChsZXQgZmVhdHVyZUluZGV4ID0gMDsgZmVhdHVyZUluZGV4IDwgZmVhdHVyZXMubGVuZ3RoOyBmZWF0dXJlSW5kZXgrKykgewogICAgICBjb25zdCBlZGdlSGFzaCA9IG91dGxpbmVzSGFzaFtmZWF0dXJlc1tmZWF0dXJlSW5kZXhdXS5lZGdlczsKICAgICAgYWRkT3V0bGluZXNGb3JGZWF0dXJlKG91dGxpbmVzLCBlZGdlSGFzaCwgaW5kZXhBcnJheSwgcG9zaXRpb25zLCBub3JtYWxzKTsKICAgIH0KICAgIHJldHVybiBvdXRsaW5lczsKICB9CiAgZnVuY3Rpb24gZ2VuZXJhdGVPdXRsaW5lc0luZGV4QXJyYXkoc3ltYm9sb2d5RGF0YSwgZmVhdHVyZUluZGV4QXJyYXksIGluZGV4QXJyYXksIHBvc2l0aW9ucywgbm9ybWFscykgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc3ltYm9sb2d5RGF0YSkgfHwgT2JqZWN0LmtleXMoc3ltYm9sb2d5RGF0YSkubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICBjb25zdCBvdXRsaW5lc0hhc2ggPSBnZW5lcmF0ZU91dGxpbmVzSGFzaCgKICAgICAgc3ltYm9sb2d5RGF0YSwKICAgICAgZmVhdHVyZUluZGV4QXJyYXksCiAgICAgIGluZGV4QXJyYXksCiAgICAgIHBvc2l0aW9ucwogICAgKTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG5vcm1hbHMpIHx8IGluZGV4QXJyYXkubGVuZ3RoICogMyAhPT0gbm9ybWFscy5sZW5ndGgpIHsKICAgICAgbm9ybWFscyA9IFtdOwogICAgfQogICAgY29uc3Qgb3V0bGluZXMgPSBnZW5lcmF0ZU91dGxpbmVzRnJvbUhhc2goCiAgICAgIG91dGxpbmVzSGFzaCwKICAgICAgaW5kZXhBcnJheSwKICAgICAgcG9zaXRpb25zLAogICAgICBub3JtYWxzCiAgICApOwogICAgY29uc3Qgb3V0bGluZXNJbmRleEFycmF5ID0gb3V0bGluZXMubGVuZ3RoID4gMCA/IG5ldyBVaW50MzJBcnJheShvdXRsaW5lcykgOiB2b2lkIDA7CiAgICByZXR1cm4gb3V0bGluZXNJbmRleEFycmF5OwogIH0KICBmdW5jdGlvbiBjb252ZXJ0Q29sb3JzQXJyYXkoY29sb3JzKSB7CiAgICBjb25zdCBjb2xvcnNBcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkoY29sb3JzLmxlbmd0aCk7CiAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgY29sb3JzLmxlbmd0aDsgaW5kZXggKz0gNCkgewogICAgICBjb2xvcnNBcnJheVtpbmRleF0gPSBzcmdiVG9MaW5lYXJfZGVmYXVsdChDb2xvcl9kZWZhdWx0LmJ5dGVUb0Zsb2F0KGNvbG9yc1tpbmRleF0pKTsKICAgICAgY29sb3JzQXJyYXlbaW5kZXggKyAxXSA9IHNyZ2JUb0xpbmVhcl9kZWZhdWx0KENvbG9yX2RlZmF1bHQuYnl0ZVRvRmxvYXQoY29sb3JzW2luZGV4ICsgMV0pKTsKICAgICAgY29sb3JzQXJyYXlbaW5kZXggKyAyXSA9IHNyZ2JUb0xpbmVhcl9kZWZhdWx0KENvbG9yX2RlZmF1bHQuYnl0ZVRvRmxvYXQoY29sb3JzW2luZGV4ICsgMl0pKTsKICAgICAgY29sb3JzQXJyYXlbaW5kZXggKyAzXSA9IENvbG9yX2RlZmF1bHQuYnl0ZVRvRmxvYXQoY29sb3JzW2luZGV4ICsgM10pOwogICAgfQogICAgcmV0dXJuIGNvbG9yc0FycmF5OwogIH0KICBmdW5jdGlvbiBnZW5lcmF0ZU5vcm1hbHModmVydGV4Q291bnQsIGluZGljZXMsIHBvc2l0aW9ucywgbm9ybWFscywgdXYwcywgY29sb3JzLCBmZWF0dXJlSW5kZXgpIHsKICAgIGNvbnN0IHJlc3VsdCA9IHsKICAgICAgbm9ybWFsczogdm9pZCAwLAogICAgICBwb3NpdGlvbnM6IHZvaWQgMCwKICAgICAgdXYwczogdm9pZCAwLAogICAgICBjb2xvcnM6IHZvaWQgMCwKICAgICAgZmVhdHVyZUluZGV4OiB2b2lkIDAsCiAgICAgIHZlcnRleENvdW50OiB2b2lkIDAKICAgIH07CiAgICBpZiAodmVydGV4Q291bnQgPT09IDAgfHwgIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMpIHx8IHBvc2l0aW9ucy5sZW5ndGggPT09IDAgfHwgZGVmaW5lZF9kZWZhdWx0KG5vcm1hbHMpKSB7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGluZGljZXMpKSB7CiAgICAgIHJlc3VsdC52ZXJ0ZXhDb3VudCA9IGluZGljZXMubGVuZ3RoOwogICAgICByZXN1bHQucG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShpbmRpY2VzLmxlbmd0aCAqIDMpOwogICAgICByZXN1bHQudXYwcyA9IGRlZmluZWRfZGVmYXVsdCh1djBzKSA/IG5ldyBGbG9hdDMyQXJyYXkoaW5kaWNlcy5sZW5ndGggKiAyKSA6IHZvaWQgMDsKICAgICAgcmVzdWx0LmNvbG9ycyA9IGRlZmluZWRfZGVmYXVsdChjb2xvcnMpID8gbmV3IFVpbnQ4QXJyYXkoaW5kaWNlcy5sZW5ndGggKiA0KSA6IHZvaWQgMDsKICAgICAgcmVzdWx0LmZlYXR1cmVJbmRleCA9IGRlZmluZWRfZGVmYXVsdChmZWF0dXJlSW5kZXgpID8gbmV3IEFycmF5KGluZGljZXMubGVuZ3RoKSA6IHZvaWQgMDsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmRpY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgaW5kZXggPSBpbmRpY2VzW2ldOwogICAgICAgIHJlc3VsdC5wb3NpdGlvbnNbaSAqIDNdID0gcG9zaXRpb25zW2luZGV4ICogM107CiAgICAgICAgcmVzdWx0LnBvc2l0aW9uc1tpICogMyArIDFdID0gcG9zaXRpb25zW2luZGV4ICogMyArIDFdOwogICAgICAgIHJlc3VsdC5wb3NpdGlvbnNbaSAqIDMgKyAyXSA9IHBvc2l0aW9uc1tpbmRleCAqIDMgKyAyXTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlc3VsdC51djBzKSkgewogICAgICAgICAgcmVzdWx0LnV2MHNbaSAqIDJdID0gdXYwc1tpbmRleCAqIDJdOwogICAgICAgICAgcmVzdWx0LnV2MHNbaSAqIDIgKyAxXSA9IHV2MHNbaW5kZXggKiAyICsgMV07CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVzdWx0LmNvbG9ycykpIHsKICAgICAgICAgIHJlc3VsdC5jb2xvcnNbaSAqIDRdID0gY29sb3JzW2luZGV4ICogNF07CiAgICAgICAgICByZXN1bHQuY29sb3JzW2kgKiA0ICsgMV0gPSBjb2xvcnNbaW5kZXggKiA0ICsgMV07CiAgICAgICAgICByZXN1bHQuY29sb3JzW2kgKiA0ICsgMl0gPSBjb2xvcnNbaW5kZXggKiA0ICsgMl07CiAgICAgICAgICByZXN1bHQuY29sb3JzW2kgKiA0ICsgM10gPSBjb2xvcnNbaW5kZXggKiA0ICsgM107CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVzdWx0LmZlYXR1cmVJbmRleCkpIHsKICAgICAgICAgIHJlc3VsdC5mZWF0dXJlSW5kZXhbaV0gPSBmZWF0dXJlSW5kZXhbaW5kZXhdOwogICAgICAgIH0KICAgICAgfQogICAgICB2ZXJ0ZXhDb3VudCA9IGluZGljZXMubGVuZ3RoOwogICAgICBwb3NpdGlvbnMgPSByZXN1bHQucG9zaXRpb25zOwogICAgfQogICAgaW5kaWNlcyA9IG5ldyBBcnJheSh2ZXJ0ZXhDb3VudCk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZlcnRleENvdW50OyBpKyspIHsKICAgICAgaW5kaWNlc1tpXSA9IGk7CiAgICB9CiAgICByZXN1bHQubm9ybWFscyA9IG5ldyBGbG9hdDMyQXJyYXkoaW5kaWNlcy5sZW5ndGggKiAzKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5kaWNlcy5sZW5ndGg7IGkgKz0gMykgewogICAgICBjYWxjdWxhdGVGYWNlTm9ybWFsKHJlc3VsdC5ub3JtYWxzLCBpLCBpbmRpY2VzLCBwb3NpdGlvbnMpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gZ2VuZXJhdGVHbHRmQnVmZmVyKHZlcnRleENvdW50LCBpbmRpY2VzLCBwb3NpdGlvbnMsIG5vcm1hbHMsIHV2MHMsIGNvbG9ycywgZmVhdHVyZUluZGV4LCBwYXJhbWV0ZXJzKSB7CiAgICBpZiAodmVydGV4Q291bnQgPT09IDAgfHwgIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMpIHx8IHBvc2l0aW9ucy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBidWZmZXJzOiBbXSwKICAgICAgICBidWZmZXJWaWV3czogW10sCiAgICAgICAgYWNjZXNzb3JzOiBbXSwKICAgICAgICBtZXNoZXM6IFtdLAogICAgICAgIG5vZGVzOiBbXSwKICAgICAgICBub2Rlc0luU2NlbmU6IFtdCiAgICAgIH07CiAgICB9CiAgICBjb25zdCBidWZmZXJzID0gW107CiAgICBjb25zdCBidWZmZXJWaWV3cyA9IFtdOwogICAgY29uc3QgYWNjZXNzb3JzID0gW107CiAgICBjb25zdCBtZXNoZXMgPSBbXTsKICAgIGNvbnN0IG5vZGVzID0gW107CiAgICBjb25zdCBub2Rlc0luU2NlbmUgPSBbXTsKICAgIGNvbnN0IHJvb3RFeHRlbnNpb25zID0ge307CiAgICBjb25zdCBleHRlbnNpb25zVXNlZCA9IFtdOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbmRpY2VzKSkgewogICAgICB2ZXJ0ZXhDb3VudCA9IGluZGljZXMubGVuZ3RoOwogICAgfQogICAgY29uc3QgeyBpbmRleEFycmF5LCB0cmFuc3BhcmVudFZlcnRleE9mZnNldCB9ID0gZ2VuZXJhdGVJbmRleEFycmF5KAogICAgICB2ZXJ0ZXhDb3VudCwKICAgICAgaW5kaWNlcywKICAgICAgY29sb3JzLAogICAgICBwYXJhbWV0ZXJzLnNwbGl0R2VvbWV0cnlCeUNvbG9yVHJhbnNwYXJlbmN5CiAgICApOwogICAgY29uc3QgaW5kaWNlc0Jsb2IgPSBuZXcgQmxvYihbaW5kZXhBcnJheV0sIHsgdHlwZTogImFwcGxpY2F0aW9uL2JpbmFyeSIgfSk7CiAgICBjb25zdCBpbmRpY2VzVVJMID0gVVJMLmNyZWF0ZU9iamVjdFVSTChpbmRpY2VzQmxvYik7CiAgICBjb25zdCBlbmRJbmRleCA9IHZlcnRleENvdW50OwogICAgY29uc3QgZmVhdHVyZUluZGV4QXJyYXkgPSBwYXJhbWV0ZXJzLmVuYWJsZUZlYXR1cmVzICYmIGRlZmluZWRfZGVmYXVsdChmZWF0dXJlSW5kZXgpID8gbmV3IEZsb2F0MzJBcnJheShmZWF0dXJlSW5kZXgubGVuZ3RoKSA6IHZvaWQgMDsKICAgIGxldCBmZWF0dXJlQ291bnQgPSAwOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChmZWF0dXJlSW5kZXhBcnJheSkpIHsKICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGZlYXR1cmVJbmRleC5sZW5ndGg7ICsraW5kZXgpIHsKICAgICAgICBmZWF0dXJlSW5kZXhBcnJheVtpbmRleF0gPSBmZWF0dXJlSW5kZXhbaW5kZXhdOwogICAgICAgIGNvbnN0IGNvdW50QnlJbmRleCA9IGZlYXR1cmVJbmRleFtpbmRleF0gKyAxOwogICAgICAgIGlmIChmZWF0dXJlQ291bnQgPCBjb3VudEJ5SW5kZXgpIHsKICAgICAgICAgIGZlYXR1cmVDb3VudCA9IGNvdW50QnlJbmRleDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGxldCBvdXRsaW5lc0luZGljZXNVUkw7CiAgICBjb25zdCBvdXRsaW5lc0luZGV4QXJyYXkgPSBnZW5lcmF0ZU91dGxpbmVzSW5kZXhBcnJheSgKICAgICAgcGFyYW1ldGVycy5zeW1ib2xvZ3lEYXRhLAogICAgICBmZWF0dXJlSW5kZXgsCiAgICAgIGluZGV4QXJyYXksCiAgICAgIHBvc2l0aW9ucywKICAgICAgbm9ybWFscwogICAgKTsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3V0bGluZXNJbmRleEFycmF5KSkgewogICAgICBjb25zdCBvdXRsaW5lc0luZGljZXNCbG9iID0gbmV3IEJsb2IoW291dGxpbmVzSW5kZXhBcnJheV0sIHsKICAgICAgICB0eXBlOiAiYXBwbGljYXRpb24vYmluYXJ5IgogICAgICB9KTsKICAgICAgb3V0bGluZXNJbmRpY2VzVVJMID0gVVJMLmNyZWF0ZU9iamVjdFVSTChvdXRsaW5lc0luZGljZXNCbG9iKTsKICAgIH0KICAgIGNvbnN0IG1lc2hQb3NpdGlvbnMgPSBwb3NpdGlvbnMuc3ViYXJyYXkoMCwgZW5kSW5kZXggKiAzKTsKICAgIGNvbnN0IHBvc2l0aW9uc0Jsb2IgPSBuZXcgQmxvYihbbWVzaFBvc2l0aW9uc10sIHsKICAgICAgdHlwZTogImFwcGxpY2F0aW9uL2JpbmFyeSIKICAgIH0pOwogICAgY29uc3QgcG9zaXRpb25zVVJMID0gVVJMLmNyZWF0ZU9iamVjdFVSTChwb3NpdGlvbnNCbG9iKTsKICAgIGxldCBtaW5YID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgbGV0IG1heFggPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICBsZXQgbWluWSA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIGxldCBtYXhZID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgbGV0IG1pblogPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICBsZXQgbWF4WiA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbWVzaFBvc2l0aW9ucy5sZW5ndGggLyAzOyBpKyspIHsKICAgICAgbWluWCA9IE1hdGgubWluKG1pblgsIG1lc2hQb3NpdGlvbnNbaSAqIDMgKyAwXSk7CiAgICAgIG1heFggPSBNYXRoLm1heChtYXhYLCBtZXNoUG9zaXRpb25zW2kgKiAzICsgMF0pOwogICAgICBtaW5ZID0gTWF0aC5taW4obWluWSwgbWVzaFBvc2l0aW9uc1tpICogMyArIDFdKTsKICAgICAgbWF4WSA9IE1hdGgubWF4KG1heFksIG1lc2hQb3NpdGlvbnNbaSAqIDMgKyAxXSk7CiAgICAgIG1pblogPSBNYXRoLm1pbihtaW5aLCBtZXNoUG9zaXRpb25zW2kgKiAzICsgMl0pOwogICAgICBtYXhaID0gTWF0aC5tYXgobWF4WiwgbWVzaFBvc2l0aW9uc1tpICogMyArIDJdKTsKICAgIH0KICAgIGNvbnN0IG1lc2hOb3JtYWxzID0gbm9ybWFscyA/IG5vcm1hbHMuc3ViYXJyYXkoMCwgZW5kSW5kZXggKiAzKSA6IHZvaWQgMDsKICAgIGxldCBub3JtYWxzVVJMOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChtZXNoTm9ybWFscykpIHsKICAgICAgY29uc3Qgbm9ybWFsc0Jsb2IgPSBuZXcgQmxvYihbbWVzaE5vcm1hbHNdLCB7CiAgICAgICAgdHlwZTogImFwcGxpY2F0aW9uL2JpbmFyeSIKICAgICAgfSk7CiAgICAgIG5vcm1hbHNVUkwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKG5vcm1hbHNCbG9iKTsKICAgIH0KICAgIGNvbnN0IG1lc2hVdjBzID0gdXYwcyA/IHV2MHMuc3ViYXJyYXkoMCwgZW5kSW5kZXggKiAyKSA6IHZvaWQgMDsKICAgIGxldCB1djBVUkw7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1lc2hVdjBzKSkgewogICAgICBjb25zdCB1djBCbG9iID0gbmV3IEJsb2IoW21lc2hVdjBzXSwgeyB0eXBlOiAiYXBwbGljYXRpb24vYmluYXJ5IiB9KTsKICAgICAgdXYwVVJMID0gVVJMLmNyZWF0ZU9iamVjdFVSTCh1djBCbG9iKTsKICAgIH0KICAgIGNvbnN0IG1lc2hDb2xvcnNJbkJ5dGVzID0gZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykgPyBjb252ZXJ0Q29sb3JzQXJyYXkoY29sb3JzLnN1YmFycmF5KDAsIGVuZEluZGV4ICogNCkpIDogdm9pZCAwOwogICAgbGV0IGNvbG9yc1VSTDsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWVzaENvbG9yc0luQnl0ZXMpKSB7CiAgICAgIGNvbnN0IGNvbG9yc0Jsb2IgPSBuZXcgQmxvYihbbWVzaENvbG9yc0luQnl0ZXNdLCB7CiAgICAgICAgdHlwZTogImFwcGxpY2F0aW9uL2JpbmFyeSIKICAgICAgfSk7CiAgICAgIGNvbG9yc1VSTCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoY29sb3JzQmxvYik7CiAgICB9CiAgICBjb25zdCBtZXNoRmVhdHVyZUlkMCA9IGRlZmluZWRfZGVmYXVsdChmZWF0dXJlSW5kZXhBcnJheSkgPyBmZWF0dXJlSW5kZXhBcnJheS5zdWJhcnJheSgwLCBlbmRJbmRleCkgOiB2b2lkIDA7CiAgICBsZXQgZmVhdHVyZUlkMFVSTDsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWVzaEZlYXR1cmVJZDApKSB7CiAgICAgIGNvbnN0IGZlYXR1cmVJZDBCbG9iID0gbmV3IEJsb2IoW21lc2hGZWF0dXJlSWQwXSwgewogICAgICAgIHR5cGU6ICJhcHBsaWNhdGlvbi9iaW5hcnkiCiAgICAgIH0pOwogICAgICBmZWF0dXJlSWQwVVJMID0gVVJMLmNyZWF0ZU9iamVjdFVSTChmZWF0dXJlSWQwQmxvYik7CiAgICB9CiAgICBjb25zdCBtZXNoUHJvcGVydHlUYWJsZTAgPSBkZWZpbmVkX2RlZmF1bHQoZmVhdHVyZUluZGV4QXJyYXkpID8gbmV3IEZsb2F0MzJBcnJheShmZWF0dXJlQ291bnQpIDogdm9pZCAwOwogICAgbGV0IHByb3BlcnR5VGFibGUwVVJMOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChtZXNoUHJvcGVydHlUYWJsZTApKSB7CiAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBtZXNoUHJvcGVydHlUYWJsZTAubGVuZ3RoOyArK2luZGV4KSB7CiAgICAgICAgbWVzaFByb3BlcnR5VGFibGUwW2luZGV4XSA9IGluZGV4OwogICAgICB9CiAgICAgIGNvbnN0IHByb3BlcnR5VGFibGUwQmxvYiA9IG5ldyBCbG9iKFttZXNoUHJvcGVydHlUYWJsZTBdLCB7CiAgICAgICAgdHlwZTogImFwcGxpY2F0aW9uL2JpbmFyeSIKICAgICAgfSk7CiAgICAgIHByb3BlcnR5VGFibGUwVVJMID0gVVJMLmNyZWF0ZU9iamVjdFVSTChwcm9wZXJ0eVRhYmxlMEJsb2IpOwogICAgfQogICAgY29uc3QgYXR0cmlidXRlcyA9IHt9OwogICAgY29uc3QgZXh0ZW5zaW9ucyA9IHt9OwogICAgYXR0cmlidXRlcy5QT1NJVElPTiA9IGFjY2Vzc29ycy5sZW5ndGg7CiAgICBidWZmZXJzLnB1c2goewogICAgICB1cmk6IHBvc2l0aW9uc1VSTCwKICAgICAgYnl0ZUxlbmd0aDogbWVzaFBvc2l0aW9ucy5ieXRlTGVuZ3RoCiAgICB9KTsKICAgIGJ1ZmZlclZpZXdzLnB1c2goewogICAgICBidWZmZXI6IGJ1ZmZlcnMubGVuZ3RoIC0gMSwKICAgICAgYnl0ZU9mZnNldDogMCwKICAgICAgYnl0ZUxlbmd0aDogbWVzaFBvc2l0aW9ucy5ieXRlTGVuZ3RoLAogICAgICB0YXJnZXQ6IDM0OTYyCiAgICB9KTsKICAgIGFjY2Vzc29ycy5wdXNoKHsKICAgICAgYnVmZmVyVmlldzogYnVmZmVyVmlld3MubGVuZ3RoIC0gMSwKICAgICAgYnl0ZU9mZnNldDogMCwKICAgICAgY29tcG9uZW50VHlwZTogNTEyNiwKICAgICAgY291bnQ6IG1lc2hQb3NpdGlvbnMubGVuZ3RoIC8gMywKICAgICAgdHlwZTogIlZFQzMiLAogICAgICBtYXg6IFttaW5YLCBtaW5ZLCBtaW5aXSwKICAgICAgbWluOiBbbWF4WCwgbWF4WSwgbWF4Wl0KICAgIH0pOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChub3JtYWxzVVJMKSkgewogICAgICBhdHRyaWJ1dGVzLk5PUk1BTCA9IGFjY2Vzc29ycy5sZW5ndGg7CiAgICAgIGJ1ZmZlcnMucHVzaCh7CiAgICAgICAgdXJpOiBub3JtYWxzVVJMLAogICAgICAgIGJ5dGVMZW5ndGg6IG1lc2hOb3JtYWxzLmJ5dGVMZW5ndGgKICAgICAgfSk7CiAgICAgIGJ1ZmZlclZpZXdzLnB1c2goewogICAgICAgIGJ1ZmZlcjogYnVmZmVycy5sZW5ndGggLSAxLAogICAgICAgIGJ5dGVPZmZzZXQ6IDAsCiAgICAgICAgYnl0ZUxlbmd0aDogbWVzaE5vcm1hbHMuYnl0ZUxlbmd0aCwKICAgICAgICB0YXJnZXQ6IDM0OTYyCiAgICAgIH0pOwogICAgICBhY2Nlc3NvcnMucHVzaCh7CiAgICAgICAgYnVmZmVyVmlldzogYnVmZmVyVmlld3MubGVuZ3RoIC0gMSwKICAgICAgICBieXRlT2Zmc2V0OiAwLAogICAgICAgIGNvbXBvbmVudFR5cGU6IDUxMjYsCiAgICAgICAgY291bnQ6IG1lc2hOb3JtYWxzLmxlbmd0aCAvIDMsCiAgICAgICAgdHlwZTogIlZFQzMiCiAgICAgIH0pOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdCh1djBVUkwpKSB7CiAgICAgIGF0dHJpYnV0ZXMuVEVYQ09PUkRfMCA9IGFjY2Vzc29ycy5sZW5ndGg7CiAgICAgIGJ1ZmZlcnMucHVzaCh7CiAgICAgICAgdXJpOiB1djBVUkwsCiAgICAgICAgYnl0ZUxlbmd0aDogbWVzaFV2MHMuYnl0ZUxlbmd0aAogICAgICB9KTsKICAgICAgYnVmZmVyVmlld3MucHVzaCh7CiAgICAgICAgYnVmZmVyOiBidWZmZXJzLmxlbmd0aCAtIDEsCiAgICAgICAgYnl0ZU9mZnNldDogMCwKICAgICAgICBieXRlTGVuZ3RoOiBtZXNoVXYwcy5ieXRlTGVuZ3RoLAogICAgICAgIHRhcmdldDogMzQ5NjIKICAgICAgfSk7CiAgICAgIGFjY2Vzc29ycy5wdXNoKHsKICAgICAgICBidWZmZXJWaWV3OiBidWZmZXJWaWV3cy5sZW5ndGggLSAxLAogICAgICAgIGJ5dGVPZmZzZXQ6IDAsCiAgICAgICAgY29tcG9uZW50VHlwZTogNTEyNiwKICAgICAgICBjb3VudDogbWVzaFV2MHMubGVuZ3RoIC8gMiwKICAgICAgICB0eXBlOiAiVkVDMiIKICAgICAgfSk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGNvbG9yc1VSTCkpIHsKICAgICAgYXR0cmlidXRlcy5DT0xPUl8wID0gYWNjZXNzb3JzLmxlbmd0aDsKICAgICAgYnVmZmVycy5wdXNoKHsKICAgICAgICB1cmk6IGNvbG9yc1VSTCwKICAgICAgICBieXRlTGVuZ3RoOiBtZXNoQ29sb3JzSW5CeXRlcy5ieXRlTGVuZ3RoCiAgICAgIH0pOwogICAgICBidWZmZXJWaWV3cy5wdXNoKHsKICAgICAgICBidWZmZXI6IGJ1ZmZlcnMubGVuZ3RoIC0gMSwKICAgICAgICBieXRlT2Zmc2V0OiAwLAogICAgICAgIGJ5dGVMZW5ndGg6IG1lc2hDb2xvcnNJbkJ5dGVzLmJ5dGVMZW5ndGgsCiAgICAgICAgdGFyZ2V0OiAzNDk2MgogICAgICB9KTsKICAgICAgYWNjZXNzb3JzLnB1c2goewogICAgICAgIGJ1ZmZlclZpZXc6IGJ1ZmZlclZpZXdzLmxlbmd0aCAtIDEsCiAgICAgICAgYnl0ZU9mZnNldDogMCwKICAgICAgICBjb21wb25lbnRUeXBlOiA1MTI2LAogICAgICAgIGNvdW50OiBtZXNoQ29sb3JzSW5CeXRlcy5sZW5ndGggLyA0LAogICAgICAgIHR5cGU6ICJWRUM0IgogICAgICB9KTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZmVhdHVyZUlkMFVSTCkpIHsKICAgICAgYXR0cmlidXRlcy5fRkVBVFVSRV9JRF8wID0gYWNjZXNzb3JzLmxlbmd0aDsKICAgICAgYnVmZmVycy5wdXNoKHsKICAgICAgICB1cmk6IGZlYXR1cmVJZDBVUkwsCiAgICAgICAgYnl0ZUxlbmd0aDogbWVzaEZlYXR1cmVJZDAuYnl0ZUxlbmd0aAogICAgICB9KTsKICAgICAgYnVmZmVyVmlld3MucHVzaCh7CiAgICAgICAgYnVmZmVyOiBidWZmZXJzLmxlbmd0aCAtIDEsCiAgICAgICAgYnl0ZU9mZnNldDogMCwKICAgICAgICBieXRlTGVuZ3RoOiBtZXNoRmVhdHVyZUlkMC5ieXRlTGVuZ3RoLAogICAgICAgIHRhcmdldDogMzQ5NjMKICAgICAgfSk7CiAgICAgIGFjY2Vzc29ycy5wdXNoKHsKICAgICAgICBidWZmZXJWaWV3OiBidWZmZXJWaWV3cy5sZW5ndGggLSAxLAogICAgICAgIGJ5dGVPZmZzZXQ6IDAsCiAgICAgICAgY29tcG9uZW50VHlwZTogNTEyNiwKICAgICAgICBjb3VudDogbWVzaEZlYXR1cmVJZDAubGVuZ3RoLAogICAgICAgIHR5cGU6ICJTQ0FMQVIiCiAgICAgIH0pOwogICAgICBleHRlbnNpb25zLkVYVF9tZXNoX2ZlYXR1cmVzID0gewogICAgICAgIGZlYXR1cmVJZHM6IFsKICAgICAgICAgIHsKICAgICAgICAgICAgYXR0cmlidXRlOiAwLAogICAgICAgICAgICBwcm9wZXJ0eVRhYmxlOiAwLAogICAgICAgICAgICBmZWF0dXJlQ291bnQKICAgICAgICAgIH0KICAgICAgICBdCiAgICAgIH07CiAgICAgIGV4dGVuc2lvbnNVc2VkLnB1c2goIkVYVF9tZXNoX2ZlYXR1cmVzIik7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHByb3BlcnR5VGFibGUwVVJMKSkgewogICAgICBidWZmZXJzLnB1c2goewogICAgICAgIHVyaTogcHJvcGVydHlUYWJsZTBVUkwsCiAgICAgICAgYnl0ZUxlbmd0aDogbWVzaFByb3BlcnR5VGFibGUwLmJ5dGVMZW5ndGgKICAgICAgfSk7CiAgICAgIGJ1ZmZlclZpZXdzLnB1c2goewogICAgICAgIGJ1ZmZlcjogYnVmZmVycy5sZW5ndGggLSAxLAogICAgICAgIGJ5dGVPZmZzZXQ6IDAsCiAgICAgICAgYnl0ZUxlbmd0aDogbWVzaFByb3BlcnR5VGFibGUwLmJ5dGVMZW5ndGgsCiAgICAgICAgdGFyZ2V0OiAzNDk2MwogICAgICB9KTsKICAgICAgcm9vdEV4dGVuc2lvbnMuRVhUX3N0cnVjdHVyYWxfbWV0YWRhdGEgPSB7CiAgICAgICAgc2NoZW1hOiB7CiAgICAgICAgICBpZDogImkzcy1tZXRhZGF0YS1zY2hlbWEtMDAxIiwKICAgICAgICAgIG5hbWU6ICJJM1MgbWV0YWRhdGEgc2NoZW1hIDAwMSIsCiAgICAgICAgICBkZXNjcmlwdGlvbjogIlRoZSBzY2hlbWEgZm9yIEkzUyBtZXRhZGF0YSIsCiAgICAgICAgICB2ZXJzaW9uOiAiMS4wIiwKICAgICAgICAgIGNsYXNzZXM6IHsKICAgICAgICAgICAgZmVhdHVyZTogewogICAgICAgICAgICAgIG5hbWU6ICJmZWF0dXJlIiwKICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogIkZlYXR1cmUgbWV0YWRhdGEiLAogICAgICAgICAgICAgIHByb3BlcnRpZXM6IHsKICAgICAgICAgICAgICAgIGluZGV4OiB7CiAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAiVGhlIGZlYXR1cmUgaW5kZXgiLAogICAgICAgICAgICAgICAgICB0eXBlOiAiU0NBTEFSIiwKICAgICAgICAgICAgICAgICAgY29tcG9uZW50VHlwZTogIkZMT0FUMzIiLAogICAgICAgICAgICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcHJvcGVydHlUYWJsZXM6IFsKICAgICAgICAgIHsKICAgICAgICAgICAgbmFtZTogImZlYXR1cmUtaW5kaWNlcy1tYXBwaW5nIiwKICAgICAgICAgICAgY2xhc3M6ICJmZWF0dXJlIiwKICAgICAgICAgICAgY291bnQ6IGZlYXR1cmVDb3VudCwKICAgICAgICAgICAgcHJvcGVydGllczogewogICAgICAgICAgICAgIGluZGV4OiB7CiAgICAgICAgICAgICAgICB2YWx1ZXM6IGJ1ZmZlclZpZXdzLmxlbmd0aCAtIDEKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICBdCiAgICAgIH07CiAgICAgIGV4dGVuc2lvbnNVc2VkLnB1c2goIkVYVF9zdHJ1Y3R1cmFsX21ldGFkYXRhIik7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG91dGxpbmVzSW5kaWNlc1VSTCkpIHsKICAgICAgYnVmZmVycy5wdXNoKHsKICAgICAgICB1cmk6IG91dGxpbmVzSW5kaWNlc1VSTCwKICAgICAgICBieXRlTGVuZ3RoOiBvdXRsaW5lc0luZGV4QXJyYXkuYnl0ZUxlbmd0aAogICAgICB9KTsKICAgICAgYnVmZmVyVmlld3MucHVzaCh7CiAgICAgICAgYnVmZmVyOiBidWZmZXJzLmxlbmd0aCAtIDEsCiAgICAgICAgYnl0ZU9mZnNldDogMCwKICAgICAgICBieXRlTGVuZ3RoOiBvdXRsaW5lc0luZGV4QXJyYXkuYnl0ZUxlbmd0aCwKICAgICAgICB0YXJnZXQ6IDM0OTYzCiAgICAgIH0pOwogICAgICBhY2Nlc3NvcnMucHVzaCh7CiAgICAgICAgYnVmZmVyVmlldzogYnVmZmVyVmlld3MubGVuZ3RoIC0gMSwKICAgICAgICBieXRlT2Zmc2V0OiAwLAogICAgICAgIGNvbXBvbmVudFR5cGU6IDUxMjUsCiAgICAgICAgY291bnQ6IG91dGxpbmVzSW5kZXhBcnJheS5sZW5ndGgsCiAgICAgICAgdHlwZTogIlNDQUxBUiIKICAgICAgfSk7CiAgICAgIGV4dGVuc2lvbnMuQ0VTSVVNX3ByaW1pdGl2ZV9vdXRsaW5lID0gewogICAgICAgIGluZGljZXM6IGFjY2Vzc29ycy5sZW5ndGggLSAxCiAgICAgIH07CiAgICAgIGV4dGVuc2lvbnNVc2VkLnB1c2goIkNFU0lVTV9wcmltaXRpdmVfb3V0bGluZSIpOwogICAgfQogICAgYnVmZmVycy5wdXNoKHsKICAgICAgdXJpOiBpbmRpY2VzVVJMLAogICAgICBieXRlTGVuZ3RoOiBpbmRleEFycmF5LmJ5dGVMZW5ndGgKICAgIH0pOwogICAgYnVmZmVyVmlld3MucHVzaCh7CiAgICAgIGJ1ZmZlcjogYnVmZmVycy5sZW5ndGggLSAxLAogICAgICBieXRlT2Zmc2V0OiAwLAogICAgICBieXRlTGVuZ3RoOiBpbmRleEFycmF5LmJ5dGVMZW5ndGgsCiAgICAgIHRhcmdldDogMzQ5NjMKICAgIH0pOwogICAgY29uc3QgbWVzaFByaW1pdGl2ZXMgPSBbXTsKICAgIGlmICh0cmFuc3BhcmVudFZlcnRleE9mZnNldCA+IDApIHsKICAgICAgYWNjZXNzb3JzLnB1c2goewogICAgICAgIGJ1ZmZlclZpZXc6IGJ1ZmZlclZpZXdzLmxlbmd0aCAtIDEsCiAgICAgICAgYnl0ZU9mZnNldDogMCwKICAgICAgICBjb21wb25lbnRUeXBlOiA1MTI1LAogICAgICAgIGNvdW50OiB0cmFuc3BhcmVudFZlcnRleE9mZnNldCwKICAgICAgICB0eXBlOiAiU0NBTEFSIgogICAgICB9KTsKICAgICAgbWVzaFByaW1pdGl2ZXMucHVzaCh7CiAgICAgICAgYXR0cmlidXRlcywKICAgICAgICBpbmRpY2VzOiBhY2Nlc3NvcnMubGVuZ3RoIC0gMSwKICAgICAgICBtYXRlcmlhbDogbWVzaFByaW1pdGl2ZXMubGVuZ3RoLAogICAgICAgIGV4dGVuc2lvbnMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodHJhbnNwYXJlbnRWZXJ0ZXhPZmZzZXQgPCB2ZXJ0ZXhDb3VudCkgewogICAgICBhY2Nlc3NvcnMucHVzaCh7CiAgICAgICAgYnVmZmVyVmlldzogYnVmZmVyVmlld3MubGVuZ3RoIC0gMSwKICAgICAgICBieXRlT2Zmc2V0OiA0ICogdHJhbnNwYXJlbnRWZXJ0ZXhPZmZzZXQsCiAgICAgICAgLy8gc2tpcCA0IGJ5dGVzIGZvciBlYWNoIG9wYXF1ZSB2ZXJ0ZXgKICAgICAgICBjb21wb25lbnRUeXBlOiA1MTI1LAogICAgICAgIGNvdW50OiB2ZXJ0ZXhDb3VudCAtIHRyYW5zcGFyZW50VmVydGV4T2Zmc2V0LAogICAgICAgIHR5cGU6ICJTQ0FMQVIiCiAgICAgIH0pOwogICAgICBtZXNoUHJpbWl0aXZlcy5wdXNoKHsKICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgIGluZGljZXM6IGFjY2Vzc29ycy5sZW5ndGggLSAxLAogICAgICAgIG1hdGVyaWFsOiBtZXNoUHJpbWl0aXZlcy5sZW5ndGgsCiAgICAgICAgZXh0ZW5zaW9ucywKICAgICAgICBleHRyYTogewogICAgICAgICAgaXNUcmFuc3BhcmVudDogdHJ1ZQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICBtZXNoZXMucHVzaCh7CiAgICAgIHByaW1pdGl2ZXM6IG1lc2hQcmltaXRpdmVzCiAgICB9KTsKICAgIG5vZGVzSW5TY2VuZS5wdXNoKDApOwogICAgbm9kZXMucHVzaCh7IG1lc2g6IDAgfSk7CiAgICByZXR1cm4gewogICAgICBidWZmZXJzLAogICAgICBidWZmZXJWaWV3cywKICAgICAgYWNjZXNzb3JzLAogICAgICBtZXNoZXMsCiAgICAgIG5vZGVzLAogICAgICBub2Rlc0luU2NlbmUsCiAgICAgIHJvb3RFeHRlbnNpb25zLAogICAgICBleHRlbnNpb25zVXNlZAogICAgfTsKICB9CiAgZnVuY3Rpb24gZGVjb2RlMihkYXRhLCBzY2hlbWEsIGJ1ZmZlckluZm8sIGZlYXR1cmVEYXRhKSB7CiAgICBjb25zdCBtYWdpY051bWJlciA9IG5ldyBVaW50OEFycmF5KGRhdGEsIDAsIDUpOwogICAgaWYgKG1hZ2ljTnVtYmVyWzBdID09PSAiRCIuY2hhckNvZGVBdCgpICYmIG1hZ2ljTnVtYmVyWzFdID09PSAiUiIuY2hhckNvZGVBdCgpICYmIG1hZ2ljTnVtYmVyWzJdID09PSAiQSIuY2hhckNvZGVBdCgpICYmIG1hZ2ljTnVtYmVyWzNdID09PSAiQyIuY2hhckNvZGVBdCgpICYmIG1hZ2ljTnVtYmVyWzRdID09PSAiTyIuY2hhckNvZGVBdCgpKSB7CiAgICAgIHJldHVybiBkZWNvZGVEcmFjb0VuY29kZWRHZW9tZXRyeShkYXRhLCBidWZmZXJJbmZvKTsKICAgIH0KICAgIHJldHVybiBkZWNvZGVCaW5hcnlHZW9tZXRyeShkYXRhLCBzY2hlbWEsIGJ1ZmZlckluZm8sIGZlYXR1cmVEYXRhKTsKICB9CiAgZnVuY3Rpb24gZGVjb2RlRHJhY29FbmNvZGVkR2VvbWV0cnkoZGF0YSkgewogICAgY29uc3QgZHJhY29EZWNvZGVyTW9kdWxlID0gZHJhY28yOwogICAgY29uc3QgYnVmZmVyID0gbmV3IGRyYWNvRGVjb2Rlck1vZHVsZS5EZWNvZGVyQnVmZmVyKCk7CiAgICBjb25zdCBieXRlQXJyYXkgPSBuZXcgVWludDhBcnJheShkYXRhKTsKICAgIGJ1ZmZlci5Jbml0KGJ5dGVBcnJheSwgYnl0ZUFycmF5Lmxlbmd0aCk7CiAgICBjb25zdCBkcmFjb0RlY29kZXIgPSBuZXcgZHJhY29EZWNvZGVyTW9kdWxlLkRlY29kZXIoKTsKICAgIGNvbnN0IGdlb21ldHJ5VHlwZSA9IGRyYWNvRGVjb2Rlci5HZXRFbmNvZGVkR2VvbWV0cnlUeXBlKGJ1ZmZlcik7CiAgICBjb25zdCBtZXRhZGF0YVF1ZXJpZXIgPSBuZXcgZHJhY29EZWNvZGVyTW9kdWxlLk1ldGFkYXRhUXVlcmllcigpOwogICAgbGV0IGRyYWNvR2VvbWV0cnk7CiAgICBsZXQgc3RhdHVzOwogICAgaWYgKGdlb21ldHJ5VHlwZSA9PT0gZHJhY29EZWNvZGVyTW9kdWxlLlRSSUFOR1VMQVJfTUVTSCkgewogICAgICBkcmFjb0dlb21ldHJ5ID0gbmV3IGRyYWNvRGVjb2Rlck1vZHVsZS5NZXNoKCk7CiAgICAgIHN0YXR1cyA9IGRyYWNvRGVjb2Rlci5EZWNvZGVCdWZmZXJUb01lc2goYnVmZmVyLCBkcmFjb0dlb21ldHJ5KTsKICAgIH0KICAgIGNvbnN0IGRlY29kZWRHZW9tZXRyeSA9IHsKICAgICAgdmVydGV4Q291bnQ6IFswXSwKICAgICAgZmVhdHVyZUNvdW50OiAwCiAgICB9OwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChzdGF0dXMpICYmIHN0YXR1cy5vaygpICYmIGRyYWNvR2VvbWV0cnkucHRyICE9PSAwKSB7CiAgICAgIGNvbnN0IGZhY2VDb3VudCA9IGRyYWNvR2VvbWV0cnkubnVtX2ZhY2VzKCk7CiAgICAgIGNvbnN0IGF0dHJpYnV0ZXNDb3VudCA9IGRyYWNvR2VvbWV0cnkubnVtX2F0dHJpYnV0ZXMoKTsKICAgICAgY29uc3QgdmVydGV4Q291bnQgPSBkcmFjb0dlb21ldHJ5Lm51bV9wb2ludHMoKTsKICAgICAgZGVjb2RlZEdlb21ldHJ5LmluZGljZXMgPSBuZXcgVWludDMyQXJyYXkoZmFjZUNvdW50ICogMyk7CiAgICAgIGNvbnN0IGZhY2VzMiA9IGRlY29kZWRHZW9tZXRyeS5pbmRpY2VzOwogICAgICBkZWNvZGVkR2VvbWV0cnkudmVydGV4Q291bnRbMF0gPSB2ZXJ0ZXhDb3VudDsKICAgICAgZGVjb2RlZEdlb21ldHJ5LnNjYWxlX3ggPSAxOwogICAgICBkZWNvZGVkR2VvbWV0cnkuc2NhbGVfeSA9IDE7CiAgICAgIGNvbnN0IGZhY2UgPSBuZXcgZHJhY29EZWNvZGVyTW9kdWxlLkRyYWNvSW50MzJBcnJheSgzKTsKICAgICAgZm9yIChsZXQgZmFjZUluZGV4ID0gMDsgZmFjZUluZGV4IDwgZmFjZUNvdW50OyArK2ZhY2VJbmRleCkgewogICAgICAgIGRyYWNvRGVjb2Rlci5HZXRGYWNlRnJvbU1lc2goZHJhY29HZW9tZXRyeSwgZmFjZUluZGV4LCBmYWNlKTsKICAgICAgICBmYWNlczJbZmFjZUluZGV4ICogM10gPSBmYWNlLkdldFZhbHVlKDApOwogICAgICAgIGZhY2VzMltmYWNlSW5kZXggKiAzICsgMV0gPSBmYWNlLkdldFZhbHVlKDEpOwogICAgICAgIGZhY2VzMltmYWNlSW5kZXggKiAzICsgMl0gPSBmYWNlLkdldFZhbHVlKDIpOwogICAgICB9CiAgICAgIGRyYWNvRGVjb2Rlck1vZHVsZS5kZXN0cm95KGZhY2UpOwogICAgICBmb3IgKGxldCBhdHRySW5kZXggPSAwOyBhdHRySW5kZXggPCBhdHRyaWJ1dGVzQ291bnQ7ICsrYXR0ckluZGV4KSB7CiAgICAgICAgY29uc3QgZHJhY29BdHRyaWJ1dGUgPSBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGF0dHJJbmRleAogICAgICAgICk7CiAgICAgICAgY29uc3QgYXR0cmlidXRlRGF0YSA9IGRlY29kZURyYWNvQXR0cmlidXRlKAogICAgICAgICAgZHJhY29EZWNvZGVyTW9kdWxlLAogICAgICAgICAgZHJhY29EZWNvZGVyLAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgdmVydGV4Q291bnQKICAgICAgICApOwogICAgICAgIGNvbnN0IGRyYWNvQXR0cmlidXRlVHlwZSA9IGRyYWNvQXR0cmlidXRlLmF0dHJpYnV0ZV90eXBlKCk7CiAgICAgICAgbGV0IGF0dHJpYnV0ZWkzc05hbWUgPSAidW5rbm93biI7CiAgICAgICAgaWYgKGRyYWNvQXR0cmlidXRlVHlwZSA9PT0gZHJhY29EZWNvZGVyTW9kdWxlLlBPU0lUSU9OKSB7CiAgICAgICAgICBhdHRyaWJ1dGVpM3NOYW1lID0gInBvc2l0aW9ucyI7CiAgICAgICAgfSBlbHNlIGlmIChkcmFjb0F0dHJpYnV0ZVR5cGUgPT09IGRyYWNvRGVjb2Rlck1vZHVsZS5OT1JNQUwpIHsKICAgICAgICAgIGF0dHJpYnV0ZWkzc05hbWUgPSAibm9ybWFscyI7CiAgICAgICAgfSBlbHNlIGlmIChkcmFjb0F0dHJpYnV0ZVR5cGUgPT09IGRyYWNvRGVjb2Rlck1vZHVsZS5DT0xPUikgewogICAgICAgICAgYXR0cmlidXRlaTNzTmFtZSA9ICJjb2xvcnMiOwogICAgICAgIH0gZWxzZSBpZiAoZHJhY29BdHRyaWJ1dGVUeXBlID09PSBkcmFjb0RlY29kZXJNb2R1bGUuVEVYX0NPT1JEKSB7CiAgICAgICAgICBhdHRyaWJ1dGVpM3NOYW1lID0gInV2MHMiOwogICAgICAgIH0KICAgICAgICBjb25zdCBtZXRhZGF0YSA9IGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGVNZXRhZGF0YSgKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBhdHRySW5kZXgKICAgICAgICApOwogICAgICAgIGlmIChtZXRhZGF0YS5wdHIgIT09IDApIHsKICAgICAgICAgIGNvbnN0IG51bUVudHJpZXMgPSBtZXRhZGF0YVF1ZXJpZXIuTnVtRW50cmllcyhtZXRhZGF0YSk7CiAgICAgICAgICBmb3IgKGxldCBlbnRyeSA9IDA7IGVudHJ5IDwgbnVtRW50cmllczsgKytlbnRyeSkgewogICAgICAgICAgICBjb25zdCBlbnRyeU5hbWUgPSBtZXRhZGF0YVF1ZXJpZXIuR2V0RW50cnlOYW1lKG1ldGFkYXRhLCBlbnRyeSk7CiAgICAgICAgICAgIGlmIChlbnRyeU5hbWUgPT09ICJpM3Mtc2NhbGVfeCIpIHsKICAgICAgICAgICAgICBkZWNvZGVkR2VvbWV0cnkuc2NhbGVfeCA9IG1ldGFkYXRhUXVlcmllci5HZXREb3VibGVFbnRyeSgKICAgICAgICAgICAgICAgIG1ldGFkYXRhLAogICAgICAgICAgICAgICAgImkzcy1zY2FsZV94IgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZW50cnlOYW1lID09PSAiaTNzLXNjYWxlX3kiKSB7CiAgICAgICAgICAgICAgZGVjb2RlZEdlb21ldHJ5LnNjYWxlX3kgPSBtZXRhZGF0YVF1ZXJpZXIuR2V0RG91YmxlRW50cnkoCiAgICAgICAgICAgICAgICBtZXRhZGF0YSwKICAgICAgICAgICAgICAgICJpM3Mtc2NhbGVfeSIKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9IGVsc2UgaWYgKGVudHJ5TmFtZSA9PT0gImkzcy1hdHRyaWJ1dGUtdHlwZSIpIHsKICAgICAgICAgICAgICBhdHRyaWJ1dGVpM3NOYW1lID0gbWV0YWRhdGFRdWVyaWVyLkdldFN0cmluZ0VudHJ5KAogICAgICAgICAgICAgICAgbWV0YWRhdGEsCiAgICAgICAgICAgICAgICAiaTNzLWF0dHJpYnV0ZS10eXBlIgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChkZWNvZGVkR2VvbWV0cnlbYXR0cmlidXRlaTNzTmFtZV0pKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygiQXR0cmlidXRlIGFscmVhZHkgZXhpc3RzIiwgYXR0cmlidXRlaTNzTmFtZSk7CiAgICAgICAgfQogICAgICAgIGRlY29kZWRHZW9tZXRyeVthdHRyaWJ1dGVpM3NOYW1lXSA9IGF0dHJpYnV0ZURhdGE7CiAgICAgICAgaWYgKGF0dHJpYnV0ZWkzc05hbWUgPT09ICJmZWF0dXJlLWluZGV4IikgewogICAgICAgICAgZGVjb2RlZEdlb21ldHJ5LmZlYXR1cmVDb3VudCsrOwogICAgICAgIH0KICAgICAgfQogICAgICBkcmFjb0RlY29kZXJNb2R1bGUuZGVzdHJveShkcmFjb0dlb21ldHJ5KTsKICAgIH0KICAgIGRyYWNvRGVjb2Rlck1vZHVsZS5kZXN0cm95KG1ldGFkYXRhUXVlcmllcik7CiAgICBkcmFjb0RlY29kZXJNb2R1bGUuZGVzdHJveShkcmFjb0RlY29kZXIpOwogICAgcmV0dXJuIGRlY29kZWRHZW9tZXRyeTsKICB9CiAgZnVuY3Rpb24gZGVjb2RlRHJhY29BdHRyaWJ1dGUoZHJhY29EZWNvZGVyTW9kdWxlLCBkcmFjb0RlY29kZXIsIGRyYWNvR2VvbWV0cnksIGRyYWNvQXR0cmlidXRlLCB2ZXJ0ZXhDb3VudCkgewogICAgY29uc3QgYnVmZmVyU2l6ZSA9IGRyYWNvQXR0cmlidXRlLm51bV9jb21wb25lbnRzKCkgKiB2ZXJ0ZXhDb3VudDsKICAgIGxldCBkcmFjb0F0dHJpYnV0ZURhdGE7CiAgICBjb25zdCBoYW5kbGVycyA9IFsKICAgICAgZnVuY3Rpb24oKSB7CiAgICAgIH0sCiAgICAgIC8vIERUX0lOVkFMSUQgLSAwCiAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgIGRyYWNvQXR0cmlidXRlRGF0YSA9IG5ldyBkcmFjb0RlY29kZXJNb2R1bGUuRHJhY29JbnQ4QXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgY29uc3Qgc3VjY2VzcyA9IGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGVJbnQ4Rm9yQWxsUG9pbnRzKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhCiAgICAgICAgKTsKICAgICAgICBpZiAoIXN1Y2Nlc3MpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkJhZCBzdHJlYW0iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlRGF0YTIgPSBuZXcgSW50OEFycmF5KGJ1ZmZlclNpemUpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYnVmZmVyU2l6ZTsgKytpKSB7CiAgICAgICAgICBhdHRyaWJ1dGVEYXRhMltpXSA9IGRyYWNvQXR0cmlidXRlRGF0YS5HZXRWYWx1ZShpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGF0dHJpYnV0ZURhdGEyOwogICAgICB9LAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEgPSBuZXcgZHJhY29EZWNvZGVyTW9kdWxlLkRyYWNvSW50OEFycmF5KGJ1ZmZlclNpemUpOwogICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlVUludDhGb3JBbGxQb2ludHMoCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGlmICghc3VjY2VzcykgewogICAgICAgICAgY29uc29sZS5lcnJvcigiQmFkIHN0cmVhbSIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVEYXRhMiA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlclNpemUpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYnVmZmVyU2l6ZTsgKytpKSB7CiAgICAgICAgICBhdHRyaWJ1dGVEYXRhMltpXSA9IGRyYWNvQXR0cmlidXRlRGF0YS5HZXRWYWx1ZShpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGF0dHJpYnV0ZURhdGEyOwogICAgICB9LAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEgPSBuZXcgZHJhY29EZWNvZGVyTW9kdWxlLkRyYWNvSW50MTZBcnJheShidWZmZXJTaXplKTsKICAgICAgICBjb25zdCBzdWNjZXNzID0gZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUludDE2Rm9yQWxsUG9pbnRzKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhCiAgICAgICAgKTsKICAgICAgICBpZiAoIXN1Y2Nlc3MpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkJhZCBzdHJlYW0iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlRGF0YTIgPSBuZXcgSW50MTZBcnJheShidWZmZXJTaXplKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJ1ZmZlclNpemU7ICsraSkgewogICAgICAgICAgYXR0cmlidXRlRGF0YTJbaV0gPSBkcmFjb0F0dHJpYnV0ZURhdGEuR2V0VmFsdWUoaSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhdHRyaWJ1dGVEYXRhMjsKICAgICAgfSwKICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvRGVjb2Rlck1vZHVsZS5EcmFjb0ludDE2QXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgY29uc3Qgc3VjY2VzcyA9IGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGVVSW50MTZGb3JBbGxQb2ludHMoCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGlmICghc3VjY2VzcykgewogICAgICAgICAgY29uc29sZS5lcnJvcigiQmFkIHN0cmVhbSIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVEYXRhMiA9IG5ldyBVaW50MTZBcnJheShidWZmZXJTaXplKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJ1ZmZlclNpemU7ICsraSkgewogICAgICAgICAgYXR0cmlidXRlRGF0YTJbaV0gPSBkcmFjb0F0dHJpYnV0ZURhdGEuR2V0VmFsdWUoaSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhdHRyaWJ1dGVEYXRhMjsKICAgICAgfSwKICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvRGVjb2Rlck1vZHVsZS5EcmFjb0ludDMyQXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgY29uc3Qgc3VjY2VzcyA9IGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGVJbnQzMkZvckFsbFBvaW50cygKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlRGF0YQogICAgICAgICk7CiAgICAgICAgaWYgKCFzdWNjZXNzKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKCJCYWQgc3RyZWFtIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZURhdGEyID0gbmV3IEludDMyQXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBidWZmZXJTaXplOyArK2kpIHsKICAgICAgICAgIGF0dHJpYnV0ZURhdGEyW2ldID0gZHJhY29BdHRyaWJ1dGVEYXRhLkdldFZhbHVlKGkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXR0cmlidXRlRGF0YTI7CiAgICAgIH0sCiAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgIGRyYWNvQXR0cmlidXRlRGF0YSA9IG5ldyBkcmFjb0RlY29kZXJNb2R1bGUuRHJhY29JbnQzMkFycmF5KGJ1ZmZlclNpemUpOwogICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlVUludDMyRm9yQWxsUG9pbnRzKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhCiAgICAgICAgKTsKICAgICAgICBpZiAoIXN1Y2Nlc3MpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkJhZCBzdHJlYW0iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlRGF0YTIgPSBuZXcgVWludDMyQXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBidWZmZXJTaXplOyArK2kpIHsKICAgICAgICAgIGF0dHJpYnV0ZURhdGEyW2ldID0gZHJhY29BdHRyaWJ1dGVEYXRhLkdldFZhbHVlKGkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXR0cmlidXRlRGF0YTI7CiAgICAgIH0sCiAgICAgIGZ1bmN0aW9uKCkgewogICAgICB9LAogICAgICBmdW5jdGlvbigpIHsKICAgICAgfSwKICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvRGVjb2Rlck1vZHVsZS5EcmFjb0Zsb2F0MzJBcnJheShidWZmZXJTaXplKTsKICAgICAgICBjb25zdCBzdWNjZXNzID0gZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUZsb2F0Rm9yQWxsUG9pbnRzKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhCiAgICAgICAgKTsKICAgICAgICBpZiAoIXN1Y2Nlc3MpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkJhZCBzdHJlYW0iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlRGF0YTIgPSBuZXcgRmxvYXQzMkFycmF5KGJ1ZmZlclNpemUpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYnVmZmVyU2l6ZTsgKytpKSB7CiAgICAgICAgICBhdHRyaWJ1dGVEYXRhMltpXSA9IGRyYWNvQXR0cmlidXRlRGF0YS5HZXRWYWx1ZShpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGF0dHJpYnV0ZURhdGEyOwogICAgICB9LAogICAgICBmdW5jdGlvbigpIHsKICAgICAgfSwKICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvRGVjb2Rlck1vZHVsZS5EcmFjb1VJbnQ4QXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgY29uc3Qgc3VjY2VzcyA9IGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGVVSW50OEZvckFsbFBvaW50cygKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlRGF0YQogICAgICAgICk7CiAgICAgICAgaWYgKCFzdWNjZXNzKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKCJCYWQgc3RyZWFtIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZURhdGEyID0gbmV3IFVpbnQ4QXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBidWZmZXJTaXplOyArK2kpIHsKICAgICAgICAgIGF0dHJpYnV0ZURhdGEyW2ldID0gZHJhY29BdHRyaWJ1dGVEYXRhLkdldFZhbHVlKGkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXR0cmlidXRlRGF0YTI7CiAgICAgIH0KICAgIF07CiAgICBjb25zdCBhdHRyaWJ1dGVEYXRhID0gaGFuZGxlcnNbZHJhY29BdHRyaWJ1dGUuZGF0YV90eXBlKCldKCk7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGRyYWNvQXR0cmlidXRlRGF0YSkpIHsKICAgICAgZHJhY29EZWNvZGVyTW9kdWxlLmRlc3Ryb3koZHJhY29BdHRyaWJ1dGVEYXRhKTsKICAgIH0KICAgIHJldHVybiBhdHRyaWJ1dGVEYXRhOwogIH0KICBmdW5jdGlvbiBkZWNvZGVCaW5hcnlHZW9tZXRyeShkYXRhLCBzY2hlbWEsIGJ1ZmZlckluZm8sIGZlYXR1cmVEYXRhKSB7CiAgICBjb25zdCBkZWNvZGVkR2VvbWV0cnkgPSB7CiAgICAgIHZlcnRleENvdW50OiAwCiAgICB9OwogICAgY29uc3QgZGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcoZGF0YSk7CiAgICB0cnkgewogICAgICBsZXQgb2Zmc2V0ID0gMDsKICAgICAgZGVjb2RlZEdlb21ldHJ5LnZlcnRleENvdW50ID0gZGF0YVZpZXcuZ2V0VWludDMyKG9mZnNldCwgMSk7CiAgICAgIG9mZnNldCArPSA0OwogICAgICBkZWNvZGVkR2VvbWV0cnkuZmVhdHVyZUNvdW50ID0gZGF0YVZpZXcuZ2V0VWludDMyKG9mZnNldCwgMSk7CiAgICAgIG9mZnNldCArPSA0OwogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGJ1ZmZlckluZm8pKSB7CiAgICAgICAgZm9yIChsZXQgYXR0ckluZGV4ID0gMDsgYXR0ckluZGV4IDwgYnVmZmVySW5mby5hdHRyaWJ1dGVzLmxlbmd0aDsgYXR0ckluZGV4KyspIHsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYmluYXJ5QXR0cmlidXRlRGVjb2RlcnNbYnVmZmVySW5mby5hdHRyaWJ1dGVzW2F0dHJJbmRleF1dKSkgewogICAgICAgICAgICBvZmZzZXQgPSBiaW5hcnlBdHRyaWJ1dGVEZWNvZGVyc1tidWZmZXJJbmZvLmF0dHJpYnV0ZXNbYXR0ckluZGV4XV0oCiAgICAgICAgICAgICAgZGVjb2RlZEdlb21ldHJ5LAogICAgICAgICAgICAgIGRhdGEsCiAgICAgICAgICAgICAgb2Zmc2V0CiAgICAgICAgICAgICk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKAogICAgICAgICAgICAgICJVbmtub3duIGRlY29kZXIgZm9yIiwKICAgICAgICAgICAgICBidWZmZXJJbmZvLmF0dHJpYnV0ZXNbYXR0ckluZGV4XQogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBsZXQgb3JkZXJpbmcgPSBzY2hlbWEub3JkZXJpbmc7CiAgICAgICAgbGV0IGZlYXR1cmVBdHRyaWJ1dGVPcmRlciA9IHNjaGVtYS5mZWF0dXJlQXR0cmlidXRlT3JkZXI7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChmZWF0dXJlRGF0YSkgJiYgZGVmaW5lZF9kZWZhdWx0KGZlYXR1cmVEYXRhLmdlb21ldHJ5RGF0YSkgJiYgZGVmaW5lZF9kZWZhdWx0KGZlYXR1cmVEYXRhLmdlb21ldHJ5RGF0YVswXSkgJiYgZGVmaW5lZF9kZWZhdWx0KGZlYXR1cmVEYXRhLmdlb21ldHJ5RGF0YVswXS5wYXJhbXMpKSB7CiAgICAgICAgICBvcmRlcmluZyA9IE9iamVjdC5rZXlzKAogICAgICAgICAgICBmZWF0dXJlRGF0YS5nZW9tZXRyeURhdGFbMF0ucGFyYW1zLnZlcnRleEF0dHJpYnV0ZXMKICAgICAgICAgICk7CiAgICAgICAgICBmZWF0dXJlQXR0cmlidXRlT3JkZXIgPSBPYmplY3Qua2V5cygKICAgICAgICAgICAgZmVhdHVyZURhdGEuZ2VvbWV0cnlEYXRhWzBdLnBhcmFtcy5mZWF0dXJlQXR0cmlidXRlcwogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvcmRlcmluZy5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgZGVjb2RlciA9IGJpbmFyeUF0dHJpYnV0ZURlY29kZXJzW29yZGVyaW5nW2ldXTsKICAgICAgICAgIG9mZnNldCA9IGRlY29kZXIoZGVjb2RlZEdlb21ldHJ5LCBkYXRhLCBvZmZzZXQpOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGZlYXR1cmVBdHRyaWJ1dGVPcmRlci5sZW5ndGg7IGorKykgewogICAgICAgICAgY29uc3QgY3VyRGVjb2RlciA9IGJpbmFyeUF0dHJpYnV0ZURlY29kZXJzW2ZlYXR1cmVBdHRyaWJ1dGVPcmRlcltqXV07CiAgICAgICAgICBvZmZzZXQgPSBjdXJEZWNvZGVyKGRlY29kZWRHZW9tZXRyeSwgZGF0YSwgb2Zmc2V0KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgY29uc29sZS5lcnJvcihlKTsKICAgIH0KICAgIGRlY29kZWRHZW9tZXRyeS5zY2FsZV94ID0gMTsKICAgIGRlY29kZWRHZW9tZXRyeS5zY2FsZV95ID0gMTsKICAgIHJldHVybiBkZWNvZGVkR2VvbWV0cnk7CiAgfQogIGZ1bmN0aW9uIGRlY29kZUFuZENyZWF0ZUdsdGYocGFyYW1ldGVycykgewogICAgY29uc3QgZ2VvbWV0cnlEYXRhID0gZGVjb2RlMigKICAgICAgcGFyYW1ldGVycy5iaW5hcnlEYXRhLAogICAgICBwYXJhbWV0ZXJzLnNjaGVtYSwKICAgICAgcGFyYW1ldGVycy5idWZmZXJJbmZvLAogICAgICBwYXJhbWV0ZXJzLmZlYXR1cmVEYXRhCiAgICApOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChwYXJhbWV0ZXJzLmdlb2lkRGF0YUxpc3QpICYmIHBhcmFtZXRlcnMuZ2VvaWREYXRhTGlzdC5sZW5ndGggPiAwKSB7CiAgICAgIG9ydGhvbWV0cmljVG9FbGxpcHNvaWRhbCgKICAgICAgICBnZW9tZXRyeURhdGEudmVydGV4Q291bnQsCiAgICAgICAgZ2VvbWV0cnlEYXRhLnBvc2l0aW9ucywKICAgICAgICBnZW9tZXRyeURhdGEuc2NhbGVfeCwKICAgICAgICBnZW9tZXRyeURhdGEuc2NhbGVfeSwKICAgICAgICBwYXJhbWV0ZXJzLmNhcnRvZ3JhcGhpY0NlbnRlciwKICAgICAgICBwYXJhbWV0ZXJzLmdlb2lkRGF0YUxpc3QsCiAgICAgICAgZmFsc2UKICAgICAgKTsKICAgIH0KICAgIHRyYW5zZm9ybVRvTG9jYWwoCiAgICAgIGdlb21ldHJ5RGF0YS52ZXJ0ZXhDb3VudCwKICAgICAgZ2VvbWV0cnlEYXRhLnBvc2l0aW9ucywKICAgICAgZ2VvbWV0cnlEYXRhLm5vcm1hbHMsCiAgICAgIHBhcmFtZXRlcnMuY2FydG9ncmFwaGljQ2VudGVyLAogICAgICBwYXJhbWV0ZXJzLmNhcnRlc2lhbkNlbnRlciwKICAgICAgcGFyYW1ldGVycy5wYXJlbnRSb3RhdGlvbiwKICAgICAgcGFyYW1ldGVycy5lbGxpcHNvaWRSYWRpaVNxdWFyZSwKICAgICAgZ2VvbWV0cnlEYXRhLnNjYWxlX3gsCiAgICAgIGdlb21ldHJ5RGF0YS5zY2FsZV95CiAgICApOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeURhdGEudXYwcykgJiYgZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5RGF0YVsidXYtcmVnaW9uIl0pKSB7CiAgICAgIGNyb3BVVnMoCiAgICAgICAgZ2VvbWV0cnlEYXRhLnZlcnRleENvdW50LAogICAgICAgIGdlb21ldHJ5RGF0YS51djBzLAogICAgICAgIGdlb21ldHJ5RGF0YVsidXYtcmVnaW9uIl0KICAgICAgKTsKICAgIH0KICAgIGxldCBmZWF0dXJlSW5kZXg7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5RGF0YVsiZmVhdHVyZS1pbmRleCJdKSkgewogICAgICBmZWF0dXJlSW5kZXggPSBnZW9tZXRyeURhdGFbImZlYXR1cmUtaW5kZXgiXTsKICAgIH0gZWxzZSBpZiAoZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5RGF0YVsiZmFjZVJhbmdlIl0pKSB7CiAgICAgIGZlYXR1cmVJbmRleCA9IG5ldyBBcnJheShnZW9tZXRyeURhdGEudmVydGV4Q291bnQpOwogICAgICBmb3IgKGxldCByYW5nZSA9IDA7IHJhbmdlIDwgZ2VvbWV0cnlEYXRhWyJmYWNlUmFuZ2UiXS5sZW5ndGggLSAxOyByYW5nZSArPSAyKSB7CiAgICAgICAgY29uc3QgY3VySW5kZXggPSByYW5nZSAvIDI7CiAgICAgICAgY29uc3QgcmFuZ2VTdGFydCA9IGdlb21ldHJ5RGF0YVsiZmFjZVJhbmdlIl1bcmFuZ2VdOwogICAgICAgIGNvbnN0IHJhbmdlRW5kID0gZ2VvbWV0cnlEYXRhWyJmYWNlUmFuZ2UiXVtyYW5nZSArIDFdOwogICAgICAgIGZvciAobGV0IGkgPSByYW5nZVN0YXJ0OyBpIDw9IHJhbmdlRW5kOyBpKyspIHsKICAgICAgICAgIGZlYXR1cmVJbmRleFtpICogM10gPSBjdXJJbmRleDsKICAgICAgICAgIGZlYXR1cmVJbmRleFtpICogMyArIDFdID0gY3VySW5kZXg7CiAgICAgICAgICBmZWF0dXJlSW5kZXhbaSAqIDMgKyAyXSA9IGN1ckluZGV4OwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKHBhcmFtZXRlcnMuY2FsY3VsYXRlTm9ybWFscykgewogICAgICBjb25zdCBkYXRhID0gZ2VuZXJhdGVOb3JtYWxzKAogICAgICAgIGdlb21ldHJ5RGF0YS52ZXJ0ZXhDb3VudCwKICAgICAgICBnZW9tZXRyeURhdGEuaW5kaWNlcywKICAgICAgICBnZW9tZXRyeURhdGEucG9zaXRpb25zLAogICAgICAgIGdlb21ldHJ5RGF0YS5ub3JtYWxzLAogICAgICAgIGdlb21ldHJ5RGF0YS51djBzLAogICAgICAgIGdlb21ldHJ5RGF0YS5jb2xvcnMsCiAgICAgICAgZmVhdHVyZUluZGV4CiAgICAgICk7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZGF0YS5ub3JtYWxzKSkgewogICAgICAgIGdlb21ldHJ5RGF0YS5ub3JtYWxzID0gZGF0YS5ub3JtYWxzOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZGF0YS52ZXJ0ZXhDb3VudCkpIHsKICAgICAgICAgIGdlb21ldHJ5RGF0YS52ZXJ0ZXhDb3VudCA9IGRhdGEudmVydGV4Q291bnQ7CiAgICAgICAgICBnZW9tZXRyeURhdGEuaW5kaWNlcyA9IGRhdGEuaW5kaWNlczsKICAgICAgICAgIGdlb21ldHJ5RGF0YS5wb3NpdGlvbnMgPSBkYXRhLnBvc2l0aW9uczsKICAgICAgICAgIGdlb21ldHJ5RGF0YS51djBzID0gZGF0YS51djBzOwogICAgICAgICAgZ2VvbWV0cnlEYXRhLmNvbG9ycyA9IGRhdGEuY29sb3JzOwogICAgICAgICAgZmVhdHVyZUluZGV4ID0gZGF0YS5mZWF0dXJlSW5kZXg7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBjb25zdCBtZXNoRGF0YSA9IGdlbmVyYXRlR2x0ZkJ1ZmZlcigKICAgICAgZ2VvbWV0cnlEYXRhLnZlcnRleENvdW50LAogICAgICBnZW9tZXRyeURhdGEuaW5kaWNlcywKICAgICAgZ2VvbWV0cnlEYXRhLnBvc2l0aW9ucywKICAgICAgZ2VvbWV0cnlEYXRhLm5vcm1hbHMsCiAgICAgIGdlb21ldHJ5RGF0YS51djBzLAogICAgICBnZW9tZXRyeURhdGEuY29sb3JzLAogICAgICBmZWF0dXJlSW5kZXgsCiAgICAgIHBhcmFtZXRlcnMKICAgICk7CiAgICBjb25zdCBjdXN0b21BdHRyaWJ1dGVzID0gewogICAgICBwb3NpdGlvbnM6IGdlb21ldHJ5RGF0YS5wb3NpdGlvbnMsCiAgICAgIGluZGljZXM6IGdlb21ldHJ5RGF0YS5pbmRpY2VzLAogICAgICBmZWF0dXJlSW5kZXgsCiAgICAgIHNvdXJjZVVSTDogcGFyYW1ldGVycy51cmwsCiAgICAgIGNhcnRlc2lhbkNlbnRlcjogcGFyYW1ldGVycy5jYXJ0ZXNpYW5DZW50ZXIsCiAgICAgIHBhcmVudFJvdGF0aW9uOiBwYXJhbWV0ZXJzLnBhcmVudFJvdGF0aW9uCiAgICB9OwogICAgbWVzaERhdGEuX2N1c3RvbUF0dHJpYnV0ZXMgPSBjdXN0b21BdHRyaWJ1dGVzOwogICAgY29uc3QgcmVzdWx0cyA9IHsKICAgICAgbWVzaERhdGEKICAgIH07CiAgICByZXR1cm4gcmVzdWx0czsKICB9CiAgYXN5bmMgZnVuY3Rpb24gaW5pdFdvcmtlcjIocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3Qgd2FzbUNvbmZpZyA9IHBhcmFtZXRlcnMud2ViQXNzZW1ibHlDb25maWc7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHdhc21Db25maWcpICYmIGRlZmluZWRfZGVmYXVsdCh3YXNtQ29uZmlnLndhc21CaW5hcnlGaWxlKSkgewogICAgICBkcmFjbzIgPSBhd2FpdCAoMCwgaW1wb3J0X2RyYWNvX2RlY29kZXJfbm9kZWpzMi5kZWZhdWx0KSh3YXNtQ29uZmlnKTsKICAgIH0gZWxzZSB7CiAgICAgIGRyYWNvMiA9IGF3YWl0ICgwLCBpbXBvcnRfZHJhY29fZGVjb2Rlcl9ub2RlanMyLmRlZmF1bHQpKCk7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZnVuY3Rpb24gZGVjb2RlSTNTKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IHdhc21Db25maWcgPSBwYXJhbWV0ZXJzLndlYkFzc2VtYmx5Q29uZmlnOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdCh3YXNtQ29uZmlnKSkgewogICAgICByZXR1cm4gaW5pdFdvcmtlcjIocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cyk7CiAgICB9CiAgICByZXR1cm4gZGVjb2RlQW5kQ3JlYXRlR2x0ZihwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKTsKICB9CiAgdmFyIGltcG9ydF9kcmFjb19kZWNvZGVyX25vZGVqczIsIGRyYWNvMiwgY2FsY3VsYXRlRmFjZU5vcm1hbEEsIGNhbGN1bGF0ZUZhY2VOb3JtYWxCLCBjYWxjdWxhdGVGYWNlTm9ybWFsQywgaXNFZGdlU21vb3RoQSwgaXNFZGdlU21vb3RoQiwgYmluYXJ5QXR0cmlidXRlRGVjb2RlcnMsIGRlY29kZUkzU19kZWZhdWx0OwogIHZhciBpbml0X2RlY29kZUkzUyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvZGVjb2RlSTNTLmpzIigpIHsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X1dlYk1lcmNhdG9yUHJvamVjdGlvbigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9Db2xvcigpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGltcG9ydF9kcmFjb19kZWNvZGVyX25vZGVqczIgPSBfX3RvRVNNKHJlcXVpcmVfZHJhY29fZGVjb2Rlcl9ub2RlanMoKSwgMSk7CiAgICAgIGluaXRfc3JnYlRvTGluZWFyKCk7CiAgICAgIGNhbGN1bGF0ZUZhY2VOb3JtYWxBID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYWxjdWxhdGVGYWNlTm9ybWFsQiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FsY3VsYXRlRmFjZU5vcm1hbEMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGlzRWRnZVNtb290aEEgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGlzRWRnZVNtb290aEIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGJpbmFyeUF0dHJpYnV0ZURlY29kZXJzID0gewogICAgICAgIHBvc2l0aW9uOiBmdW5jdGlvbihkZWNvZGVkR2VvbWV0cnksIGRhdGEsIG9mZnNldCkgewogICAgICAgICAgY29uc3QgY291bnQgPSBkZWNvZGVkR2VvbWV0cnkudmVydGV4Q291bnQgKiAzOwogICAgICAgICAgZGVjb2RlZEdlb21ldHJ5LnBvc2l0aW9ucyA9IG5ldyBGbG9hdDMyQXJyYXkoZGF0YSwgb2Zmc2V0LCBjb3VudCk7CiAgICAgICAgICBvZmZzZXQgKz0gY291bnQgKiA0OwogICAgICAgICAgcmV0dXJuIG9mZnNldDsKICAgICAgICB9LAogICAgICAgIG5vcm1hbDogZnVuY3Rpb24oZGVjb2RlZEdlb21ldHJ5LCBkYXRhLCBvZmZzZXQpIHsKICAgICAgICAgIGNvbnN0IGNvdW50ID0gZGVjb2RlZEdlb21ldHJ5LnZlcnRleENvdW50ICogMzsKICAgICAgICAgIGRlY29kZWRHZW9tZXRyeS5ub3JtYWxzID0gbmV3IEZsb2F0MzJBcnJheShkYXRhLCBvZmZzZXQsIGNvdW50KTsKICAgICAgICAgIG9mZnNldCArPSBjb3VudCAqIDQ7CiAgICAgICAgICByZXR1cm4gb2Zmc2V0OwogICAgICAgIH0sCiAgICAgICAgdXYwOiBmdW5jdGlvbihkZWNvZGVkR2VvbWV0cnksIGRhdGEsIG9mZnNldCkgewogICAgICAgICAgY29uc3QgY291bnQgPSBkZWNvZGVkR2VvbWV0cnkudmVydGV4Q291bnQgKiAyOwogICAgICAgICAgZGVjb2RlZEdlb21ldHJ5LnV2MHMgPSBuZXcgRmxvYXQzMkFycmF5KGRhdGEsIG9mZnNldCwgY291bnQpOwogICAgICAgICAgb2Zmc2V0ICs9IGNvdW50ICogNDsKICAgICAgICAgIHJldHVybiBvZmZzZXQ7CiAgICAgICAgfSwKICAgICAgICBjb2xvcjogZnVuY3Rpb24oZGVjb2RlZEdlb21ldHJ5LCBkYXRhLCBvZmZzZXQpIHsKICAgICAgICAgIGNvbnN0IGNvdW50ID0gZGVjb2RlZEdlb21ldHJ5LnZlcnRleENvdW50ICogNDsKICAgICAgICAgIGRlY29kZWRHZW9tZXRyeS5jb2xvcnMgPSBuZXcgVWludDhBcnJheShkYXRhLCBvZmZzZXQsIGNvdW50KTsKICAgICAgICAgIG9mZnNldCArPSBjb3VudDsKICAgICAgICAgIHJldHVybiBvZmZzZXQ7CiAgICAgICAgfSwKICAgICAgICBmZWF0dXJlSWQ6IGZ1bmN0aW9uKGRlY29kZWRHZW9tZXRyeSwgZGF0YSwgb2Zmc2V0KSB7CiAgICAgICAgICBjb25zdCBjb3VudCA9IGRlY29kZWRHZW9tZXRyeS5mZWF0dXJlQ291bnQ7CiAgICAgICAgICBvZmZzZXQgKz0gY291bnQgKiA4OwogICAgICAgICAgcmV0dXJuIG9mZnNldDsKICAgICAgICB9LAogICAgICAgIGlkOiBmdW5jdGlvbihkZWNvZGVkR2VvbWV0cnksIGRhdGEsIG9mZnNldCkgewogICAgICAgICAgY29uc3QgY291bnQgPSBkZWNvZGVkR2VvbWV0cnkuZmVhdHVyZUNvdW50OwogICAgICAgICAgb2Zmc2V0ICs9IGNvdW50ICogODsKICAgICAgICAgIHJldHVybiBvZmZzZXQ7CiAgICAgICAgfSwKICAgICAgICBmYWNlUmFuZ2U6IGZ1bmN0aW9uKGRlY29kZWRHZW9tZXRyeSwgZGF0YSwgb2Zmc2V0KSB7CiAgICAgICAgICBjb25zdCBjb3VudCA9IGRlY29kZWRHZW9tZXRyeS5mZWF0dXJlQ291bnQgKiAyOwogICAgICAgICAgZGVjb2RlZEdlb21ldHJ5LmZhY2VSYW5nZSA9IG5ldyBVaW50MzJBcnJheShkYXRhLCBvZmZzZXQsIGNvdW50KTsKICAgICAgICAgIG9mZnNldCArPSBjb3VudCAqIDQ7CiAgICAgICAgICByZXR1cm4gb2Zmc2V0OwogICAgICAgIH0sCiAgICAgICAgdXZSZWdpb246IGZ1bmN0aW9uKGRlY29kZWRHZW9tZXRyeSwgZGF0YSwgb2Zmc2V0KSB7CiAgICAgICAgICBjb25zdCBjb3VudCA9IGRlY29kZWRHZW9tZXRyeS52ZXJ0ZXhDb3VudCAqIDQ7CiAgICAgICAgICBkZWNvZGVkR2VvbWV0cnlbInV2LXJlZ2lvbiJdID0gbmV3IFVpbnQxNkFycmF5KGRhdGEsIG9mZnNldCwgY291bnQpOwogICAgICAgICAgb2Zmc2V0ICs9IGNvdW50ICogMjsKICAgICAgICAgIHJldHVybiBvZmZzZXQ7CiAgICAgICAgfSwKICAgICAgICByZWdpb246IGZ1bmN0aW9uKGRlY29kZWRHZW9tZXRyeSwgZGF0YSwgb2Zmc2V0KSB7CiAgICAgICAgICBjb25zdCBjb3VudCA9IGRlY29kZWRHZW9tZXRyeS52ZXJ0ZXhDb3VudCAqIDQ7CiAgICAgICAgICBkZWNvZGVkR2VvbWV0cnlbInV2LXJlZ2lvbiJdID0gbmV3IFVpbnQxNkFycmF5KGRhdGEsIG9mZnNldCwgY291bnQpOwogICAgICAgICAgb2Zmc2V0ICs9IGNvdW50ICogMjsKICAgICAgICAgIHJldHVybiBvZmZzZXQ7CiAgICAgICAgfQogICAgICB9OwogICAgICBkZWNvZGVJM1NfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdChkZWNvZGVJM1MpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1JlbmRlcmVyL1BpeGVsRGF0YXR5cGUuanMKICB2YXIgUGl4ZWxEYXRhdHlwZSwgUGl4ZWxEYXRhdHlwZV9kZWZhdWx0OwogIHZhciBpbml0X1BpeGVsRGF0YXR5cGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9SZW5kZXJlci9QaXhlbERhdGF0eXBlLmpzIigpIHsKICAgICAgaW5pdF9XZWJHTENvbnN0YW50cygpOwogICAgICBQaXhlbERhdGF0eXBlID0gewogICAgICAgIFVOU0lHTkVEX0JZVEU6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICBVTlNJR05FRF9TSE9SVDogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9TSE9SVCwKICAgICAgICBVTlNJR05FRF9JTlQ6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfSU5ULAogICAgICAgIEZMT0FUOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkZMT0FULAogICAgICAgIEhBTEZfRkxPQVQ6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuSEFMRl9GTE9BVF9PRVMsCiAgICAgICAgVU5TSUdORURfSU5UXzI0Xzg6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfSU5UXzI0XzgsCiAgICAgICAgVU5TSUdORURfU0hPUlRfNF80XzRfNDogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9TSE9SVF80XzRfNF80LAogICAgICAgIFVOU0lHTkVEX1NIT1JUXzVfNV81XzE6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfU0hPUlRfNV81XzVfMSwKICAgICAgICBVTlNJR05FRF9TSE9SVF81XzZfNTogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9TSE9SVF81XzZfNQogICAgICB9OwogICAgICBQaXhlbERhdGF0eXBlLnRvV2ViR0xDb25zdGFudCA9IGZ1bmN0aW9uKHBpeGVsRGF0YXR5cGUsIGNvbnRleHQpIHsKICAgICAgICBzd2l0Y2ggKHBpeGVsRGF0YXR5cGUpIHsKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9CWVRFOgogICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9CWVRFOwogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUOgogICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9TSE9SVDsKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9JTlQ6CiAgICAgICAgICAgIHJldHVybiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlVOU0lHTkVEX0lOVDsKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5GTE9BVDoKICAgICAgICAgICAgcmV0dXJuIFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuRkxPQVQ7CiAgICAgICAgICBjYXNlIFBpeGVsRGF0YXR5cGUuSEFMRl9GTE9BVDoKICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQud2ViZ2wyID8gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5IQUxGX0ZMT0FUIDogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5IQUxGX0ZMT0FUX09FUzsKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9JTlRfMjRfODoKICAgICAgICAgICAgcmV0dXJuIFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfSU5UXzI0Xzg7CiAgICAgICAgICBjYXNlIFBpeGVsRGF0YXR5cGUuVU5TSUdORURfU0hPUlRfNF80XzRfNDoKICAgICAgICAgICAgcmV0dXJuIFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfU0hPUlRfNF80XzRfNDsKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9TSE9SVF81XzVfNV8xOgogICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9TSE9SVF81XzVfNV8xOwogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUXzVfNl81OgogICAgICAgICAgICByZXR1cm4gUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9TSE9SVF81XzZfNTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIFBpeGVsRGF0YXR5cGUuaXNQYWNrZWQgPSBmdW5jdGlvbihwaXhlbERhdGF0eXBlKSB7CiAgICAgICAgcmV0dXJuIHBpeGVsRGF0YXR5cGUgPT09IFBpeGVsRGF0YXR5cGUuVU5TSUdORURfSU5UXzI0XzggfHwgcGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9TSE9SVF80XzRfNF80IHx8IHBpeGVsRGF0YXR5cGUgPT09IFBpeGVsRGF0YXR5cGUuVU5TSUdORURfU0hPUlRfNV81XzVfMSB8fCBwaXhlbERhdGF0eXBlID09PSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUXzVfNl81OwogICAgICB9OwogICAgICBQaXhlbERhdGF0eXBlLnNpemVJbkJ5dGVzID0gZnVuY3Rpb24ocGl4ZWxEYXRhdHlwZSkgewogICAgICAgIHN3aXRjaCAocGl4ZWxEYXRhdHlwZSkgewogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX0JZVEU6CiAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUOgogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUXzRfNF80XzQ6CiAgICAgICAgICBjYXNlIFBpeGVsRGF0YXR5cGUuVU5TSUdORURfU0hPUlRfNV81XzVfMToKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9TSE9SVF81XzZfNToKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5IQUxGX0ZMT0FUOgogICAgICAgICAgICByZXR1cm4gMjsKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9JTlQ6CiAgICAgICAgICBjYXNlIFBpeGVsRGF0YXR5cGUuRkxPQVQ6CiAgICAgICAgICBjYXNlIFBpeGVsRGF0YXR5cGUuVU5TSUdORURfSU5UXzI0Xzg6CiAgICAgICAgICAgIHJldHVybiA0OwogICAgICAgIH0KICAgICAgfTsKICAgICAgUGl4ZWxEYXRhdHlwZS52YWxpZGF0ZSA9IGZ1bmN0aW9uKHBpeGVsRGF0YXR5cGUpIHsKICAgICAgICByZXR1cm4gcGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9CWVRFIHx8IHBpeGVsRGF0YXR5cGUgPT09IFBpeGVsRGF0YXR5cGUuVU5TSUdORURfU0hPUlQgfHwgcGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9JTlQgfHwgcGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZS5GTE9BVCB8fCBwaXhlbERhdGF0eXBlID09PSBQaXhlbERhdGF0eXBlLkhBTEZfRkxPQVQgfHwgcGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9JTlRfMjRfOCB8fCBwaXhlbERhdGF0eXBlID09PSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUXzRfNF80XzQgfHwgcGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9TSE9SVF81XzVfNV8xIHx8IHBpeGVsRGF0YXR5cGUgPT09IFBpeGVsRGF0YXR5cGUuVU5TSUdORURfU0hPUlRfNV82XzU7CiAgICAgIH07CiAgICAgIFBpeGVsRGF0YXR5cGVfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoUGl4ZWxEYXRhdHlwZSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9QaXhlbEZvcm1hdC5qcwogIHZhciBQaXhlbEZvcm1hdCwgUGl4ZWxGb3JtYXRfZGVmYXVsdDsKICB2YXIgaW5pdF9QaXhlbEZvcm1hdCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUGl4ZWxGb3JtYXQuanMiKCkgewogICAgICBpbml0X1BpeGVsRGF0YXR5cGUoKTsKICAgICAgaW5pdF9XZWJHTENvbnN0YW50cygpOwogICAgICBQaXhlbEZvcm1hdCA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIGEgZGVwdGggdmFsdWUuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIERFUFRIX0NPTVBPTkVOVDogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5ERVBUSF9DT01QT05FTlQsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyBhIGRlcHRoIGFuZCBzdGVuY2lsIHZhbHVlLCBtb3N0IG9mdGVuIHVzZWQgd2l0aCB7QGxpbmsgUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9JTlRfMjRfOH0uCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIERFUFRIX1NURU5DSUw6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuREVQVEhfU1RFTkNJTCwKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIGFuIGFscGhhIGNoYW5uZWwuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIEFMUEhBOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkFMUEhBLAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgYSByZWQgY2hhbm5lbAogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSRUQ6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuUkVELAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgcmVkIGFuZCBncmVlbiBjaGFubmVscy4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUkc6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuUkcsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQsIGdyZWVuLCBhbmQgYmx1ZSBjaGFubmVscy4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUkdCOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlJHQiwKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIHJlZCwgZ3JlZW4sIGJsdWUsIGFuZCBhbHBoYSBjaGFubmVscy4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUkdCQTogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5SR0JBLAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgYSBsdW1pbmFuY2UgKGludGVuc2l0eSkgY2hhbm5lbC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgTFVNSU5BTkNFOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkxVTUlOQU5DRSwKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIGx1bWluYW5jZSAoaW50ZW5zaXR5KSBhbmQgYWxwaGEgY2hhbm5lbHMuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIExVTUlOQU5DRV9BTFBIQTogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5MVU1JTkFOQ0VfQUxQSEEsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQsIGdyZWVuLCBhbmQgYmx1ZSBjaGFubmVscyB0aGF0IGlzIERYVDEgY29tcHJlc3NlZC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUkdCX0RYVDE6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ09NUFJFU1NFRF9SR0JfUzNUQ19EWFQxX0VYVCwKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIHJlZCwgZ3JlZW4sIGJsdWUsIGFuZCBhbHBoYSBjaGFubmVscyB0aGF0IGlzIERYVDEgY29tcHJlc3NlZC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUkdCQV9EWFQxOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkNPTVBSRVNTRURfUkdCQV9TM1RDX0RYVDFfRVhULAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgcmVkLCBncmVlbiwgYmx1ZSwgYW5kIGFscGhhIGNoYW5uZWxzIHRoYXQgaXMgRFhUMyBjb21wcmVzc2VkLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSR0JBX0RYVDM6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ09NUFJFU1NFRF9SR0JBX1MzVENfRFhUM19FWFQsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQsIGdyZWVuLCBibHVlLCBhbmQgYWxwaGEgY2hhbm5lbHMgdGhhdCBpcyBEWFQ1IGNvbXByZXNzZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJHQkFfRFhUNTogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5DT01QUkVTU0VEX1JHQkFfUzNUQ19EWFQ1X0VYVCwKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIHJlZCwgZ3JlZW4sIGFuZCBibHVlIGNoYW5uZWxzIHRoYXQgaXMgUFZSIDRicHAgY29tcHJlc3NlZC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUkdCX1BWUlRDXzRCUFBWMTogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5DT01QUkVTU0VEX1JHQl9QVlJUQ180QlBQVjFfSU1HLAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgcmVkLCBncmVlbiwgYW5kIGJsdWUgY2hhbm5lbHMgdGhhdCBpcyBQVlIgMmJwcCBjb21wcmVzc2VkLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSR0JfUFZSVENfMkJQUFYxOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkNPTVBSRVNTRURfUkdCX1BWUlRDXzJCUFBWMV9JTUcsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQsIGdyZWVuLCBibHVlLCBhbmQgYWxwaGEgY2hhbm5lbHMgdGhhdCBpcyBQVlIgNGJwcCBjb21wcmVzc2VkLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSR0JBX1BWUlRDXzRCUFBWMTogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5DT01QUkVTU0VEX1JHQkFfUFZSVENfNEJQUFYxX0lNRywKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIHJlZCwgZ3JlZW4sIGJsdWUsIGFuZCBhbHBoYSBjaGFubmVscyB0aGF0IGlzIFBWUiAyYnBwIGNvbXByZXNzZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJHQkFfUFZSVENfMkJQUFYxOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkNPTVBSRVNTRURfUkdCQV9QVlJUQ18yQlBQVjFfSU1HLAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgcmVkLCBncmVlbiwgYmx1ZSwgYW5kIGFscGhhIGNoYW5uZWxzIHRoYXQgaXMgQVNUQyBjb21wcmVzc2VkLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSR0JBX0FTVEM6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ09NUFJFU1NFRF9SR0JBX0FTVENfNHg0X1dFQkdMLAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgcmVkLCBncmVlbiwgYW5kIGJsdWUgY2hhbm5lbHMgdGhhdCBpcyBFVEMxIGNvbXByZXNzZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJHQl9FVEMxOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkNPTVBSRVNTRURfUkdCX0VUQzFfV0VCR0wsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQsIGdyZWVuLCBhbmQgYmx1ZSBjaGFubmVscyB0aGF0IGlzIEVUQzIgY29tcHJlc3NlZC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUkdCOF9FVEMyOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkNPTVBSRVNTRURfUkdCOF9FVEMyLAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgcmVkLCBncmVlbiwgYmx1ZSwgYW5kIGFscGhhIGNoYW5uZWxzIHRoYXQgaXMgRVRDMiBjb21wcmVzc2VkLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSR0JBOF9FVEMyX0VBQzogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5DT01QUkVTU0VEX1JHQkE4X0VUQzJfRUFDLAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgcmVkLCBncmVlbiwgYmx1ZSwgYW5kIGFscGhhIGNoYW5uZWxzIHRoYXQgaXMgQkM3IGNvbXByZXNzZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJHQkFfQkM3OiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkNPTVBSRVNTRURfUkdCQV9CUFRDX1VOT1JNCiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0LmNvbXBvbmVudHNMZW5ndGggPSBmdW5jdGlvbihwaXhlbEZvcm1hdCkgewogICAgICAgIHN3aXRjaCAocGl4ZWxGb3JtYXQpIHsKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCOgogICAgICAgICAgICByZXR1cm4gMzsKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCQToKICAgICAgICAgICAgcmV0dXJuIDQ7CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LkxVTUlOQU5DRV9BTFBIQToKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkc6CiAgICAgICAgICAgIHJldHVybiAyOwogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5BTFBIQToKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkVEOgogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5MVU1JTkFOQ0U6CiAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgfQogICAgICB9OwogICAgICBQaXhlbEZvcm1hdC52YWxpZGF0ZSA9IGZ1bmN0aW9uKHBpeGVsRm9ybWF0KSB7CiAgICAgICAgcmV0dXJuIHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5ERVBUSF9DT01QT05FTlQgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LkRFUFRIX1NURU5DSUwgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LkFMUEhBIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SRUQgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0IgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LkxVTUlOQU5DRSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuTFVNSU5BTkNFX0FMUEhBIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JfRFhUMSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9EWFQxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX0RYVDMgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfRFhUNSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCX1BWUlRDXzRCUFBWMSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCX1BWUlRDXzJCUFBWMSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9QVlJUQ180QlBQVjEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfUFZSVENfMkJQUFYxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX0FTVEMgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQl9FVEMxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0I4X0VUQzIgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkE4X0VUQzJfRUFDIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX0JDNzsKICAgICAgfTsKICAgICAgUGl4ZWxGb3JtYXQuaXNDb2xvckZvcm1hdCA9IGZ1bmN0aW9uKHBpeGVsRm9ybWF0KSB7CiAgICAgICAgcmV0dXJuIHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5BTFBIQSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5MVU1JTkFOQ0UgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LkxVTUlOQU5DRV9BTFBIQTsKICAgICAgfTsKICAgICAgUGl4ZWxGb3JtYXQuaXNEZXB0aEZvcm1hdCA9IGZ1bmN0aW9uKHBpeGVsRm9ybWF0KSB7CiAgICAgICAgcmV0dXJuIHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5ERVBUSF9DT01QT05FTlQgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LkRFUFRIX1NURU5DSUw7CiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0LmlzQ29tcHJlc3NlZEZvcm1hdCA9IGZ1bmN0aW9uKHBpeGVsRm9ybWF0KSB7CiAgICAgICAgcmV0dXJuIHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JfRFhUMSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9EWFQxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX0RYVDMgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfRFhUNSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCX1BWUlRDXzRCUFBWMSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCX1BWUlRDXzJCUFBWMSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9QVlJUQ180QlBQVjEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfUFZSVENfMkJQUFYxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX0FTVEMgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQl9FVEMxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0I4X0VUQzIgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkE4X0VUQzJfRUFDIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX0JDNzsKICAgICAgfTsKICAgICAgUGl4ZWxGb3JtYXQuaXNEWFRGb3JtYXQgPSBmdW5jdGlvbihwaXhlbEZvcm1hdCkgewogICAgICAgIHJldHVybiBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCX0RYVDEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfRFhUMSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9EWFQzIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX0RYVDU7CiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0LmlzUFZSVENGb3JtYXQgPSBmdW5jdGlvbihwaXhlbEZvcm1hdCkgewogICAgICAgIHJldHVybiBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCX1BWUlRDXzRCUFBWMSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCX1BWUlRDXzJCUFBWMSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9QVlJUQ180QlBQVjEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfUFZSVENfMkJQUFYxOwogICAgICB9OwogICAgICBQaXhlbEZvcm1hdC5pc0FTVENGb3JtYXQgPSBmdW5jdGlvbihwaXhlbEZvcm1hdCkgewogICAgICAgIHJldHVybiBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9BU1RDOwogICAgICB9OwogICAgICBQaXhlbEZvcm1hdC5pc0VUQzFGb3JtYXQgPSBmdW5jdGlvbihwaXhlbEZvcm1hdCkgewogICAgICAgIHJldHVybiBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCX0VUQzE7CiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0LmlzRVRDMkZvcm1hdCA9IGZ1bmN0aW9uKHBpeGVsRm9ybWF0KSB7CiAgICAgICAgcmV0dXJuIHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0I4X0VUQzIgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkE4X0VUQzJfRUFDOwogICAgICB9OwogICAgICBQaXhlbEZvcm1hdC5pc0JDN0Zvcm1hdCA9IGZ1bmN0aW9uKHBpeGVsRm9ybWF0KSB7CiAgICAgICAgcmV0dXJuIHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX0JDNzsKICAgICAgfTsKICAgICAgUGl4ZWxGb3JtYXQuY29tcHJlc3NlZFRleHR1cmVTaXplSW5CeXRlcyA9IGZ1bmN0aW9uKHBpeGVsRm9ybWF0LCB3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgc3dpdGNoIChwaXhlbEZvcm1hdCkgewogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0JfRFhUMToKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCQV9EWFQxOgogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0JfRVRDMToKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCOF9FVEMyOgogICAgICAgICAgICByZXR1cm4gTWF0aC5mbG9vcigod2lkdGggKyAzKSAvIDQpICogTWF0aC5mbG9vcigoaGVpZ2h0ICsgMykgLyA0KSAqIDg7CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQkFfRFhUMzoKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCQV9EWFQ1OgogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0JBX0FTVEM6CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQkE4X0VUQzJfRUFDOgogICAgICAgICAgICByZXR1cm4gTWF0aC5mbG9vcigod2lkdGggKyAzKSAvIDQpICogTWF0aC5mbG9vcigoaGVpZ2h0ICsgMykgLyA0KSAqIDE2OwogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0JfUFZSVENfNEJQUFYxOgogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0JBX1BWUlRDXzRCUFBWMToKICAgICAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IoKE1hdGgubWF4KHdpZHRoLCA4KSAqIE1hdGgubWF4KGhlaWdodCwgOCkgKiA0ICsgNykgLyA4KTsKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCX1BWUlRDXzJCUFBWMToKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCQV9QVlJUQ18yQlBQVjE6CiAgICAgICAgICAgIHJldHVybiBNYXRoLmZsb29yKAogICAgICAgICAgICAgIChNYXRoLm1heCh3aWR0aCwgMTYpICogTWF0aC5tYXgoaGVpZ2h0LCA4KSAqIDIgKyA3KSAvIDgKICAgICAgICAgICAgKTsKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCQV9CQzc6CiAgICAgICAgICAgIHJldHVybiBNYXRoLmNlaWwod2lkdGggLyA0KSAqIE1hdGguY2VpbChoZWlnaHQgLyA0KSAqIDE2OwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICB9OwogICAgICBQaXhlbEZvcm1hdC50ZXh0dXJlU2l6ZUluQnl0ZXMgPSBmdW5jdGlvbihwaXhlbEZvcm1hdCwgcGl4ZWxEYXRhdHlwZSwgd2lkdGgsIGhlaWdodCkgewogICAgICAgIGxldCBjb21wb25lbnRzTGVuZ3RoID0gUGl4ZWxGb3JtYXQuY29tcG9uZW50c0xlbmd0aChwaXhlbEZvcm1hdCk7CiAgICAgICAgaWYgKFBpeGVsRGF0YXR5cGVfZGVmYXVsdC5pc1BhY2tlZChwaXhlbERhdGF0eXBlKSkgewogICAgICAgICAgY29tcG9uZW50c0xlbmd0aCA9IDE7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjb21wb25lbnRzTGVuZ3RoICogUGl4ZWxEYXRhdHlwZV9kZWZhdWx0LnNpemVJbkJ5dGVzKHBpeGVsRGF0YXR5cGUpICogd2lkdGggKiBoZWlnaHQ7CiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0LmFsaWdubWVudEluQnl0ZXMgPSBmdW5jdGlvbihwaXhlbEZvcm1hdCwgcGl4ZWxEYXRhdHlwZSwgd2lkdGgpIHsKICAgICAgICBjb25zdCBtb2QgPSBQaXhlbEZvcm1hdC50ZXh0dXJlU2l6ZUluQnl0ZXMocGl4ZWxGb3JtYXQsIHBpeGVsRGF0YXR5cGUsIHdpZHRoLCAxKSAlIDQ7CiAgICAgICAgcmV0dXJuIG1vZCA9PT0gMCA/IDQgOiBtb2QgPT09IDIgPyAyIDogMTsKICAgICAgfTsKICAgICAgUGl4ZWxGb3JtYXQuY3JlYXRlVHlwZWRBcnJheSA9IGZ1bmN0aW9uKHBpeGVsRm9ybWF0LCBwaXhlbERhdGF0eXBlLCB3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgbGV0IGNvbnN0cnVjdG9yOwogICAgICAgIGNvbnN0IHNpemVJbkJ5dGVzID0gUGl4ZWxEYXRhdHlwZV9kZWZhdWx0LnNpemVJbkJ5dGVzKHBpeGVsRGF0YXR5cGUpOwogICAgICAgIGlmIChzaXplSW5CeXRlcyA9PT0gVWludDhBcnJheS5CWVRFU19QRVJfRUxFTUVOVCkgewogICAgICAgICAgY29uc3RydWN0b3IgPSBVaW50OEFycmF5OwogICAgICAgIH0gZWxzZSBpZiAoc2l6ZUluQnl0ZXMgPT09IFVpbnQxNkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UKSB7CiAgICAgICAgICBjb25zdHJ1Y3RvciA9IFVpbnQxNkFycmF5OwogICAgICAgIH0gZWxzZSBpZiAoc2l6ZUluQnl0ZXMgPT09IEZsb2F0MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVCAmJiBwaXhlbERhdGF0eXBlID09PSBQaXhlbERhdGF0eXBlX2RlZmF1bHQuRkxPQVQpIHsKICAgICAgICAgIGNvbnN0cnVjdG9yID0gRmxvYXQzMkFycmF5OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdHJ1Y3RvciA9IFVpbnQzMkFycmF5OwogICAgICAgIH0KICAgICAgICBjb25zdCBzaXplID0gUGl4ZWxGb3JtYXQuY29tcG9uZW50c0xlbmd0aChwaXhlbEZvcm1hdCkgKiB3aWR0aCAqIGhlaWdodDsKICAgICAgICByZXR1cm4gbmV3IGNvbnN0cnVjdG9yKHNpemUpOwogICAgICB9OwogICAgICBQaXhlbEZvcm1hdC5mbGlwWSA9IGZ1bmN0aW9uKGJ1ZmZlclZpZXcsIHBpeGVsRm9ybWF0LCBwaXhlbERhdGF0eXBlLCB3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgaWYgKGhlaWdodCA9PT0gMSkgewogICAgICAgICAgcmV0dXJuIGJ1ZmZlclZpZXc7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGZsaXBwZWQgPSBQaXhlbEZvcm1hdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICAgICAgcGl4ZWxGb3JtYXQsCiAgICAgICAgICBwaXhlbERhdGF0eXBlLAogICAgICAgICAgd2lkdGgsCiAgICAgICAgICBoZWlnaHQKICAgICAgICApOwogICAgICAgIGNvbnN0IG51bWJlck9mQ29tcG9uZW50cyA9IFBpeGVsRm9ybWF0LmNvbXBvbmVudHNMZW5ndGgocGl4ZWxGb3JtYXQpOwogICAgICAgIGNvbnN0IHRleHR1cmVXaWR0aCA9IHdpZHRoICogbnVtYmVyT2ZDb21wb25lbnRzOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGVpZ2h0OyArK2kpIHsKICAgICAgICAgIGNvbnN0IHJvdyA9IGkgKiB3aWR0aCAqIG51bWJlck9mQ29tcG9uZW50czsKICAgICAgICAgIGNvbnN0IGZsaXBwZWRSb3cgPSAoaGVpZ2h0IC0gaSAtIDEpICogd2lkdGggKiBudW1iZXJPZkNvbXBvbmVudHM7CiAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHRleHR1cmVXaWR0aDsgKytqKSB7CiAgICAgICAgICAgIGZsaXBwZWRbZmxpcHBlZFJvdyArIGpdID0gYnVmZmVyVmlld1tyb3cgKyBqXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZsaXBwZWQ7CiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0LnRvSW50ZXJuYWxGb3JtYXQgPSBmdW5jdGlvbihwaXhlbEZvcm1hdCwgcGl4ZWxEYXRhdHlwZSwgY29udGV4dCkgewogICAgICAgIGlmICghY29udGV4dC53ZWJnbDIpIHsKICAgICAgICAgIHJldHVybiBwaXhlbEZvcm1hdDsKICAgICAgICB9CiAgICAgICAgaWYgKHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5ERVBUSF9TVEVOQ0lMKSB7CiAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5ERVBUSDI0X1NURU5DSUw4OwogICAgICAgIH0KICAgICAgICBpZiAocGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LkRFUFRIX0NPTVBPTkVOVCkgewogICAgICAgICAgaWYgKHBpeGVsRGF0YXR5cGUgPT09IFBpeGVsRGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9TSE9SVCkgewogICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5ERVBUSF9DT01QT05FTlQxNjsKICAgICAgICAgIH0gZWxzZSBpZiAocGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0lOVCkgewogICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5ERVBUSF9DT01QT05FTlQyNDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHBpeGVsRGF0YXR5cGUgPT09IFBpeGVsRGF0YXR5cGVfZGVmYXVsdC5GTE9BVCkgewogICAgICAgICAgc3dpdGNoIChwaXhlbEZvcm1hdCkgewogICAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQkE6CiAgICAgICAgICAgICAgcmV0dXJuIFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuUkdCQTMyRjsKICAgICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0I6CiAgICAgICAgICAgICAgcmV0dXJuIFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuUkdCMzJGOwogICAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHOgogICAgICAgICAgICAgIHJldHVybiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlJHMzJGOwogICAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJFRDoKICAgICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5SMzJGOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAocGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZV9kZWZhdWx0LkhBTEZfRkxPQVQpIHsKICAgICAgICAgIHN3aXRjaCAocGl4ZWxGb3JtYXQpIHsKICAgICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0JBOgogICAgICAgICAgICAgIHJldHVybiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlJHQkExNkY7CiAgICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCOgogICAgICAgICAgICAgIHJldHVybiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlJHQjE2RjsKICAgICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SRzoKICAgICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5SRzE2RjsKICAgICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SRUQ6CiAgICAgICAgICAgICAgcmV0dXJuIFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuUjE2RjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBpeGVsRm9ybWF0OwogICAgICB9OwogICAgICBQaXhlbEZvcm1hdF9kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShQaXhlbEZvcm1hdCk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9WdWxrYW5Db25zdGFudHMuanMKICB2YXIgVnVsa2FuQ29uc3RhbnRzLCBWdWxrYW5Db25zdGFudHNfZGVmYXVsdDsKICB2YXIgaW5pdF9WdWxrYW5Db25zdGFudHMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1Z1bGthbkNvbnN0YW50cy5qcyIoKSB7CiAgICAgIFZ1bGthbkNvbnN0YW50cyA9IHsKICAgICAgICBWS19GT1JNQVRfVU5ERUZJTkVEOiAwLAogICAgICAgIFZLX0ZPUk1BVF9SNEc0X1VOT1JNX1BBQ0s4OiAxLAogICAgICAgIFZLX0ZPUk1BVF9SNEc0QjRBNF9VTk9STV9QQUNLMTY6IDIsCiAgICAgICAgVktfRk9STUFUX0I0RzRSNEE0X1VOT1JNX1BBQ0sxNjogMywKICAgICAgICBWS19GT1JNQVRfUjVHNkI1X1VOT1JNX1BBQ0sxNjogNCwKICAgICAgICBWS19GT1JNQVRfQjVHNlI1X1VOT1JNX1BBQ0sxNjogNSwKICAgICAgICBWS19GT1JNQVRfUjVHNUI1QTFfVU5PUk1fUEFDSzE2OiA2LAogICAgICAgIFZLX0ZPUk1BVF9CNUc1UjVBMV9VTk9STV9QQUNLMTY6IDcsCiAgICAgICAgVktfRk9STUFUX0ExUjVHNUI1X1VOT1JNX1BBQ0sxNjogOCwKICAgICAgICBWS19GT1JNQVRfUjhfVU5PUk06IDksCiAgICAgICAgVktfRk9STUFUX1I4X1NOT1JNOiAxMCwKICAgICAgICBWS19GT1JNQVRfUjhfVVNDQUxFRDogMTEsCiAgICAgICAgVktfRk9STUFUX1I4X1NTQ0FMRUQ6IDEyLAogICAgICAgIFZLX0ZPUk1BVF9SOF9VSU5UOiAxMywKICAgICAgICBWS19GT1JNQVRfUjhfU0lOVDogMTQsCiAgICAgICAgVktfRk9STUFUX1I4X1NSR0I6IDE1LAogICAgICAgIFZLX0ZPUk1BVF9SOEc4X1VOT1JNOiAxNiwKICAgICAgICBWS19GT1JNQVRfUjhHOF9TTk9STTogMTcsCiAgICAgICAgVktfRk9STUFUX1I4RzhfVVNDQUxFRDogMTgsCiAgICAgICAgVktfRk9STUFUX1I4RzhfU1NDQUxFRDogMTksCiAgICAgICAgVktfRk9STUFUX1I4RzhfVUlOVDogMjAsCiAgICAgICAgVktfRk9STUFUX1I4RzhfU0lOVDogMjEsCiAgICAgICAgVktfRk9STUFUX1I4RzhfU1JHQjogMjIsCiAgICAgICAgVktfRk9STUFUX1I4RzhCOF9VTk9STTogMjMsCiAgICAgICAgVktfRk9STUFUX1I4RzhCOF9TTk9STTogMjQsCiAgICAgICAgVktfRk9STUFUX1I4RzhCOF9VU0NBTEVEOiAyNSwKICAgICAgICBWS19GT1JNQVRfUjhHOEI4X1NTQ0FMRUQ6IDI2LAogICAgICAgIFZLX0ZPUk1BVF9SOEc4QjhfVUlOVDogMjcsCiAgICAgICAgVktfRk9STUFUX1I4RzhCOF9TSU5UOiAyOCwKICAgICAgICBWS19GT1JNQVRfUjhHOEI4X1NSR0I6IDI5LAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhfVU5PUk06IDMwLAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhfU05PUk06IDMxLAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhfVVNDQUxFRDogMzIsCiAgICAgICAgVktfRk9STUFUX0I4RzhSOF9TU0NBTEVEOiAzMywKICAgICAgICBWS19GT1JNQVRfQjhHOFI4X1VJTlQ6IDM0LAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhfU0lOVDogMzUsCiAgICAgICAgVktfRk9STUFUX0I4RzhSOF9TUkdCOiAzNiwKICAgICAgICBWS19GT1JNQVRfUjhHOEI4QThfVU5PUk06IDM3LAogICAgICAgIFZLX0ZPUk1BVF9SOEc4QjhBOF9TTk9STTogMzgsCiAgICAgICAgVktfRk9STUFUX1I4RzhCOEE4X1VTQ0FMRUQ6IDM5LAogICAgICAgIFZLX0ZPUk1BVF9SOEc4QjhBOF9TU0NBTEVEOiA0MCwKICAgICAgICBWS19GT1JNQVRfUjhHOEI4QThfVUlOVDogNDEsCiAgICAgICAgVktfRk9STUFUX1I4RzhCOEE4X1NJTlQ6IDQyLAogICAgICAgIFZLX0ZPUk1BVF9SOEc4QjhBOF9TUkdCOiA0MywKICAgICAgICBWS19GT1JNQVRfQjhHOFI4QThfVU5PUk06IDQ0LAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhBOF9TTk9STTogNDUsCiAgICAgICAgVktfRk9STUFUX0I4RzhSOEE4X1VTQ0FMRUQ6IDQ2LAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhBOF9TU0NBTEVEOiA0NywKICAgICAgICBWS19GT1JNQVRfQjhHOFI4QThfVUlOVDogNDgsCiAgICAgICAgVktfRk9STUFUX0I4RzhSOEE4X1NJTlQ6IDQ5LAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhBOF9TUkdCOiA1MCwKICAgICAgICBWS19GT1JNQVRfQThCOEc4UjhfVU5PUk1fUEFDSzMyOiA1MSwKICAgICAgICBWS19GT1JNQVRfQThCOEc4UjhfU05PUk1fUEFDSzMyOiA1MiwKICAgICAgICBWS19GT1JNQVRfQThCOEc4UjhfVVNDQUxFRF9QQUNLMzI6IDUzLAogICAgICAgIFZLX0ZPUk1BVF9BOEI4RzhSOF9TU0NBTEVEX1BBQ0szMjogNTQsCiAgICAgICAgVktfRk9STUFUX0E4QjhHOFI4X1VJTlRfUEFDSzMyOiA1NSwKICAgICAgICBWS19GT1JNQVRfQThCOEc4UjhfU0lOVF9QQUNLMzI6IDU2LAogICAgICAgIFZLX0ZPUk1BVF9BOEI4RzhSOF9TUkdCX1BBQ0szMjogNTcsCiAgICAgICAgVktfRk9STUFUX0EyUjEwRzEwQjEwX1VOT1JNX1BBQ0szMjogNTgsCiAgICAgICAgVktfRk9STUFUX0EyUjEwRzEwQjEwX1NOT1JNX1BBQ0szMjogNTksCiAgICAgICAgVktfRk9STUFUX0EyUjEwRzEwQjEwX1VTQ0FMRURfUEFDSzMyOiA2MCwKICAgICAgICBWS19GT1JNQVRfQTJSMTBHMTBCMTBfU1NDQUxFRF9QQUNLMzI6IDYxLAogICAgICAgIFZLX0ZPUk1BVF9BMlIxMEcxMEIxMF9VSU5UX1BBQ0szMjogNjIsCiAgICAgICAgVktfRk9STUFUX0EyUjEwRzEwQjEwX1NJTlRfUEFDSzMyOiA2MywKICAgICAgICBWS19GT1JNQVRfQTJCMTBHMTBSMTBfVU5PUk1fUEFDSzMyOiA2NCwKICAgICAgICBWS19GT1JNQVRfQTJCMTBHMTBSMTBfU05PUk1fUEFDSzMyOiA2NSwKICAgICAgICBWS19GT1JNQVRfQTJCMTBHMTBSMTBfVVNDQUxFRF9QQUNLMzI6IDY2LAogICAgICAgIFZLX0ZPUk1BVF9BMkIxMEcxMFIxMF9TU0NBTEVEX1BBQ0szMjogNjcsCiAgICAgICAgVktfRk9STUFUX0EyQjEwRzEwUjEwX1VJTlRfUEFDSzMyOiA2OCwKICAgICAgICBWS19GT1JNQVRfQTJCMTBHMTBSMTBfU0lOVF9QQUNLMzI6IDY5LAogICAgICAgIFZLX0ZPUk1BVF9SMTZfVU5PUk06IDcwLAogICAgICAgIFZLX0ZPUk1BVF9SMTZfU05PUk06IDcxLAogICAgICAgIFZLX0ZPUk1BVF9SMTZfVVNDQUxFRDogNzIsCiAgICAgICAgVktfRk9STUFUX1IxNl9TU0NBTEVEOiA3MywKICAgICAgICBWS19GT1JNQVRfUjE2X1VJTlQ6IDc0LAogICAgICAgIFZLX0ZPUk1BVF9SMTZfU0lOVDogNzUsCiAgICAgICAgVktfRk9STUFUX1IxNl9TRkxPQVQ6IDc2LAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZfVU5PUk06IDc3LAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZfU05PUk06IDc4LAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZfVVNDQUxFRDogNzksCiAgICAgICAgVktfRk9STUFUX1IxNkcxNl9TU0NBTEVEOiA4MCwKICAgICAgICBWS19GT1JNQVRfUjE2RzE2X1VJTlQ6IDgxLAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZfU0lOVDogODIsCiAgICAgICAgVktfRk9STUFUX1IxNkcxNl9TRkxPQVQ6IDgzLAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZCMTZfVU5PUk06IDg0LAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZCMTZfU05PUk06IDg1LAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZCMTZfVVNDQUxFRDogODYsCiAgICAgICAgVktfRk9STUFUX1IxNkcxNkIxNl9TU0NBTEVEOiA4NywKICAgICAgICBWS19GT1JNQVRfUjE2RzE2QjE2X1VJTlQ6IDg4LAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZCMTZfU0lOVDogODksCiAgICAgICAgVktfRk9STUFUX1IxNkcxNkIxNl9TRkxPQVQ6IDkwLAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZCMTZBMTZfVU5PUk06IDkxLAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZCMTZBMTZfU05PUk06IDkyLAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZCMTZBMTZfVVNDQUxFRDogOTMsCiAgICAgICAgVktfRk9STUFUX1IxNkcxNkIxNkExNl9TU0NBTEVEOiA5NCwKICAgICAgICBWS19GT1JNQVRfUjE2RzE2QjE2QTE2X1VJTlQ6IDk1LAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZCMTZBMTZfU0lOVDogOTYsCiAgICAgICAgVktfRk9STUFUX1IxNkcxNkIxNkExNl9TRkxPQVQ6IDk3LAogICAgICAgIFZLX0ZPUk1BVF9SMzJfVUlOVDogOTgsCiAgICAgICAgVktfRk9STUFUX1IzMl9TSU5UOiA5OSwKICAgICAgICBWS19GT1JNQVRfUjMyX1NGTE9BVDogMTAwLAogICAgICAgIFZLX0ZPUk1BVF9SMzJHMzJfVUlOVDogMTAxLAogICAgICAgIFZLX0ZPUk1BVF9SMzJHMzJfU0lOVDogMTAyLAogICAgICAgIFZLX0ZPUk1BVF9SMzJHMzJfU0ZMT0FUOiAxMDMsCiAgICAgICAgVktfRk9STUFUX1IzMkczMkIzMl9VSU5UOiAxMDQsCiAgICAgICAgVktfRk9STUFUX1IzMkczMkIzMl9TSU5UOiAxMDUsCiAgICAgICAgVktfRk9STUFUX1IzMkczMkIzMl9TRkxPQVQ6IDEwNiwKICAgICAgICBWS19GT1JNQVRfUjMyRzMyQjMyQTMyX1VJTlQ6IDEwNywKICAgICAgICBWS19GT1JNQVRfUjMyRzMyQjMyQTMyX1NJTlQ6IDEwOCwKICAgICAgICBWS19GT1JNQVRfUjMyRzMyQjMyQTMyX1NGTE9BVDogMTA5LAogICAgICAgIFZLX0ZPUk1BVF9SNjRfVUlOVDogMTEwLAogICAgICAgIFZLX0ZPUk1BVF9SNjRfU0lOVDogMTExLAogICAgICAgIFZLX0ZPUk1BVF9SNjRfU0ZMT0FUOiAxMTIsCiAgICAgICAgVktfRk9STUFUX1I2NEc2NF9VSU5UOiAxMTMsCiAgICAgICAgVktfRk9STUFUX1I2NEc2NF9TSU5UOiAxMTQsCiAgICAgICAgVktfRk9STUFUX1I2NEc2NF9TRkxPQVQ6IDExNSwKICAgICAgICBWS19GT1JNQVRfUjY0RzY0QjY0X1VJTlQ6IDExNiwKICAgICAgICBWS19GT1JNQVRfUjY0RzY0QjY0X1NJTlQ6IDExNywKICAgICAgICBWS19GT1JNQVRfUjY0RzY0QjY0X1NGTE9BVDogMTE4LAogICAgICAgIFZLX0ZPUk1BVF9SNjRHNjRCNjRBNjRfVUlOVDogMTE5LAogICAgICAgIFZLX0ZPUk1BVF9SNjRHNjRCNjRBNjRfU0lOVDogMTIwLAogICAgICAgIFZLX0ZPUk1BVF9SNjRHNjRCNjRBNjRfU0ZMT0FUOiAxMjEsCiAgICAgICAgVktfRk9STUFUX0IxMEcxMVIxMV9VRkxPQVRfUEFDSzMyOiAxMjIsCiAgICAgICAgVktfRk9STUFUX0U1QjlHOVI5X1VGTE9BVF9QQUNLMzI6IDEyMywKICAgICAgICBWS19GT1JNQVRfRDE2X1VOT1JNOiAxMjQsCiAgICAgICAgVktfRk9STUFUX1g4X0QyNF9VTk9STV9QQUNLMzI6IDEyNSwKICAgICAgICBWS19GT1JNQVRfRDMyX1NGTE9BVDogMTI2LAogICAgICAgIFZLX0ZPUk1BVF9TOF9VSU5UOiAxMjcsCiAgICAgICAgVktfRk9STUFUX0QxNl9VTk9STV9TOF9VSU5UOiAxMjgsCiAgICAgICAgVktfRk9STUFUX0QyNF9VTk9STV9TOF9VSU5UOiAxMjksCiAgICAgICAgVktfRk9STUFUX0QzMl9TRkxPQVRfUzhfVUlOVDogMTMwLAogICAgICAgIFZLX0ZPUk1BVF9CQzFfUkdCX1VOT1JNX0JMT0NLOiAxMzEsCiAgICAgICAgVktfRk9STUFUX0JDMV9SR0JfU1JHQl9CTE9DSzogMTMyLAogICAgICAgIFZLX0ZPUk1BVF9CQzFfUkdCQV9VTk9STV9CTE9DSzogMTMzLAogICAgICAgIFZLX0ZPUk1BVF9CQzFfUkdCQV9TUkdCX0JMT0NLOiAxMzQsCiAgICAgICAgVktfRk9STUFUX0JDMl9VTk9STV9CTE9DSzogMTM1LAogICAgICAgIFZLX0ZPUk1BVF9CQzJfU1JHQl9CTE9DSzogMTM2LAogICAgICAgIFZLX0ZPUk1BVF9CQzNfVU5PUk1fQkxPQ0s6IDEzNywKICAgICAgICBWS19GT1JNQVRfQkMzX1NSR0JfQkxPQ0s6IDEzOCwKICAgICAgICBWS19GT1JNQVRfQkM0X1VOT1JNX0JMT0NLOiAxMzksCiAgICAgICAgVktfRk9STUFUX0JDNF9TTk9STV9CTE9DSzogMTQwLAogICAgICAgIFZLX0ZPUk1BVF9CQzVfVU5PUk1fQkxPQ0s6IDE0MSwKICAgICAgICBWS19GT1JNQVRfQkM1X1NOT1JNX0JMT0NLOiAxNDIsCiAgICAgICAgVktfRk9STUFUX0JDNkhfVUZMT0FUX0JMT0NLOiAxNDMsCiAgICAgICAgVktfRk9STUFUX0JDNkhfU0ZMT0FUX0JMT0NLOiAxNDQsCiAgICAgICAgVktfRk9STUFUX0JDN19VTk9STV9CTE9DSzogMTQ1LAogICAgICAgIFZLX0ZPUk1BVF9CQzdfU1JHQl9CTE9DSzogMTQ2LAogICAgICAgIFZLX0ZPUk1BVF9FVEMyX1I4RzhCOF9VTk9STV9CTE9DSzogMTQ3LAogICAgICAgIFZLX0ZPUk1BVF9FVEMyX1I4RzhCOF9TUkdCX0JMT0NLOiAxNDgsCiAgICAgICAgVktfRk9STUFUX0VUQzJfUjhHOEI4QTFfVU5PUk1fQkxPQ0s6IDE0OSwKICAgICAgICBWS19GT1JNQVRfRVRDMl9SOEc4QjhBMV9TUkdCX0JMT0NLOiAxNTAsCiAgICAgICAgVktfRk9STUFUX0VUQzJfUjhHOEI4QThfVU5PUk1fQkxPQ0s6IDE1MSwKICAgICAgICBWS19GT1JNQVRfRVRDMl9SOEc4QjhBOF9TUkdCX0JMT0NLOiAxNTIsCiAgICAgICAgVktfRk9STUFUX0VBQ19SMTFfVU5PUk1fQkxPQ0s6IDE1MywKICAgICAgICBWS19GT1JNQVRfRUFDX1IxMV9TTk9STV9CTE9DSzogMTU0LAogICAgICAgIFZLX0ZPUk1BVF9FQUNfUjExRzExX1VOT1JNX0JMT0NLOiAxNTUsCiAgICAgICAgVktfRk9STUFUX0VBQ19SMTFHMTFfU05PUk1fQkxPQ0s6IDE1NiwKICAgICAgICBWS19GT1JNQVRfQVNUQ180eDRfVU5PUk1fQkxPQ0s6IDE1NywKICAgICAgICBWS19GT1JNQVRfQVNUQ180eDRfU1JHQl9CTE9DSzogMTU4LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzV4NF9VTk9STV9CTE9DSzogMTU5LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzV4NF9TUkdCX0JMT0NLOiAxNjAsCiAgICAgICAgVktfRk9STUFUX0FTVENfNXg1X1VOT1JNX0JMT0NLOiAxNjEsCiAgICAgICAgVktfRk9STUFUX0FTVENfNXg1X1NSR0JfQkxPQ0s6IDE2MiwKICAgICAgICBWS19GT1JNQVRfQVNUQ182eDVfVU5PUk1fQkxPQ0s6IDE2MywKICAgICAgICBWS19GT1JNQVRfQVNUQ182eDVfU1JHQl9CTE9DSzogMTY0LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzZ4Nl9VTk9STV9CTE9DSzogMTY1LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzZ4Nl9TUkdCX0JMT0NLOiAxNjYsCiAgICAgICAgVktfRk9STUFUX0FTVENfOHg1X1VOT1JNX0JMT0NLOiAxNjcsCiAgICAgICAgVktfRk9STUFUX0FTVENfOHg1X1NSR0JfQkxPQ0s6IDE2OCwKICAgICAgICBWS19GT1JNQVRfQVNUQ184eDZfVU5PUk1fQkxPQ0s6IDE2OSwKICAgICAgICBWS19GT1JNQVRfQVNUQ184eDZfU1JHQl9CTE9DSzogMTcwLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzh4OF9VTk9STV9CTE9DSzogMTcxLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzh4OF9TUkdCX0JMT0NLOiAxNzIsCiAgICAgICAgVktfRk9STUFUX0FTVENfMTB4NV9VTk9STV9CTE9DSzogMTczLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzEweDVfU1JHQl9CTE9DSzogMTc0LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzEweDZfVU5PUk1fQkxPQ0s6IDE3NSwKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMHg2X1NSR0JfQkxPQ0s6IDE3NiwKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMHg4X1VOT1JNX0JMT0NLOiAxNzcsCiAgICAgICAgVktfRk9STUFUX0FTVENfMTB4OF9TUkdCX0JMT0NLOiAxNzgsCiAgICAgICAgVktfRk9STUFUX0FTVENfMTB4MTBfVU5PUk1fQkxPQ0s6IDE3OSwKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMHgxMF9TUkdCX0JMT0NLOiAxODAsCiAgICAgICAgVktfRk9STUFUX0FTVENfMTJ4MTBfVU5PUk1fQkxPQ0s6IDE4MSwKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMngxMF9TUkdCX0JMT0NLOiAxODIsCiAgICAgICAgVktfRk9STUFUX0FTVENfMTJ4MTJfVU5PUk1fQkxPQ0s6IDE4MywKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMngxMl9TUkdCX0JMT0NLOiAxODQsCiAgICAgICAgVktfRk9STUFUX0c4QjhHOFI4XzQyMl9VTk9STTogMTAwMDE1NmUzLAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhHOF80MjJfVU5PUk06IDEwMDAxNTYwMDEsCiAgICAgICAgVktfRk9STUFUX0c4X0I4X1I4XzNQTEFORV80MjBfVU5PUk06IDEwMDAxNTYwMDIsCiAgICAgICAgVktfRk9STUFUX0c4X0I4UjhfMlBMQU5FXzQyMF9VTk9STTogMTAwMDE1NjAwMywKICAgICAgICBWS19GT1JNQVRfRzhfQjhfUjhfM1BMQU5FXzQyMl9VTk9STTogMTAwMDE1NjAwNCwKICAgICAgICBWS19GT1JNQVRfRzhfQjhSOF8yUExBTkVfNDIyX1VOT1JNOiAxMDAwMTU2MDA1LAogICAgICAgIFZLX0ZPUk1BVF9HOF9COF9SOF8zUExBTkVfNDQ0X1VOT1JNOiAxMDAwMTU2MDA2LAogICAgICAgIFZLX0ZPUk1BVF9SMTBYNl9VTk9STV9QQUNLMTY6IDEwMDAxNTYwMDcsCiAgICAgICAgVktfRk9STUFUX1IxMFg2RzEwWDZfVU5PUk1fMlBBQ0sxNjogMTAwMDE1NjAwOCwKICAgICAgICBWS19GT1JNQVRfUjEwWDZHMTBYNkIxMFg2QTEwWDZfVU5PUk1fNFBBQ0sxNjogMTAwMDE1NjAwOSwKICAgICAgICBWS19GT1JNQVRfRzEwWDZCMTBYNkcxMFg2UjEwWDZfNDIyX1VOT1JNXzRQQUNLMTY6IDEwMDAxNTYwMTAsCiAgICAgICAgVktfRk9STUFUX0IxMFg2RzEwWDZSMTBYNkcxMFg2XzQyMl9VTk9STV80UEFDSzE2OiAxMDAwMTU2MDExLAogICAgICAgIFZLX0ZPUk1BVF9HMTBYNl9CMTBYNl9SMTBYNl8zUExBTkVfNDIwX1VOT1JNXzNQQUNLMTY6IDEwMDAxNTYwMTIsCiAgICAgICAgVktfRk9STUFUX0cxMFg2X0IxMFg2UjEwWDZfMlBMQU5FXzQyMF9VTk9STV8zUEFDSzE2OiAxMDAwMTU2MDEzLAogICAgICAgIFZLX0ZPUk1BVF9HMTBYNl9CMTBYNl9SMTBYNl8zUExBTkVfNDIyX1VOT1JNXzNQQUNLMTY6IDEwMDAxNTYwMTQsCiAgICAgICAgVktfRk9STUFUX0cxMFg2X0IxMFg2UjEwWDZfMlBMQU5FXzQyMl9VTk9STV8zUEFDSzE2OiAxMDAwMTU2MDE1LAogICAgICAgIFZLX0ZPUk1BVF9HMTBYNl9CMTBYNl9SMTBYNl8zUExBTkVfNDQ0X1VOT1JNXzNQQUNLMTY6IDEwMDAxNTYwMTYsCiAgICAgICAgVktfRk9STUFUX1IxMlg0X1VOT1JNX1BBQ0sxNjogMTAwMDE1NjAxNywKICAgICAgICBWS19GT1JNQVRfUjEyWDRHMTJYNF9VTk9STV8yUEFDSzE2OiAxMDAwMTU2MDE4LAogICAgICAgIFZLX0ZPUk1BVF9SMTJYNEcxMlg0QjEyWDRBMTJYNF9VTk9STV80UEFDSzE2OiAxMDAwMTU2MDE5LAogICAgICAgIFZLX0ZPUk1BVF9HMTJYNEIxMlg0RzEyWDRSMTJYNF80MjJfVU5PUk1fNFBBQ0sxNjogMTAwMDE1NjAyMCwKICAgICAgICBWS19GT1JNQVRfQjEyWDRHMTJYNFIxMlg0RzEyWDRfNDIyX1VOT1JNXzRQQUNLMTY6IDEwMDAxNTYwMjEsCiAgICAgICAgVktfRk9STUFUX0cxMlg0X0IxMlg0X1IxMlg0XzNQTEFORV80MjBfVU5PUk1fM1BBQ0sxNjogMTAwMDE1NjAyMiwKICAgICAgICBWS19GT1JNQVRfRzEyWDRfQjEyWDRSMTJYNF8yUExBTkVfNDIwX1VOT1JNXzNQQUNLMTY6IDEwMDAxNTYwMjMsCiAgICAgICAgVktfRk9STUFUX0cxMlg0X0IxMlg0X1IxMlg0XzNQTEFORV80MjJfVU5PUk1fM1BBQ0sxNjogMTAwMDE1NjAyNCwKICAgICAgICBWS19GT1JNQVRfRzEyWDRfQjEyWDRSMTJYNF8yUExBTkVfNDIyX1VOT1JNXzNQQUNLMTY6IDEwMDAxNTYwMjUsCiAgICAgICAgVktfRk9STUFUX0cxMlg0X0IxMlg0X1IxMlg0XzNQTEFORV80NDRfVU5PUk1fM1BBQ0sxNjogMTAwMDE1NjAyNiwKICAgICAgICBWS19GT1JNQVRfRzE2QjE2RzE2UjE2XzQyMl9VTk9STTogMTAwMDE1NjAyNywKICAgICAgICBWS19GT1JNQVRfQjE2RzE2UjE2RzE2XzQyMl9VTk9STTogMTAwMDE1NjAyOCwKICAgICAgICBWS19GT1JNQVRfRzE2X0IxNl9SMTZfM1BMQU5FXzQyMF9VTk9STTogMTAwMDE1NjAyOSwKICAgICAgICBWS19GT1JNQVRfRzE2X0IxNlIxNl8yUExBTkVfNDIwX1VOT1JNOiAxMDAwMTU2MDMwLAogICAgICAgIFZLX0ZPUk1BVF9HMTZfQjE2X1IxNl8zUExBTkVfNDIyX1VOT1JNOiAxMDAwMTU2MDMxLAogICAgICAgIFZLX0ZPUk1BVF9HMTZfQjE2UjE2XzJQTEFORV80MjJfVU5PUk06IDEwMDAxNTYwMzIsCiAgICAgICAgVktfRk9STUFUX0cxNl9CMTZfUjE2XzNQTEFORV80NDRfVU5PUk06IDEwMDAxNTYwMzMsCiAgICAgICAgVktfRk9STUFUX1BWUlRDMV8yQlBQX1VOT1JNX0JMT0NLX0lNRzogMTAwMDA1NGUzLAogICAgICAgIFZLX0ZPUk1BVF9QVlJUQzFfNEJQUF9VTk9STV9CTE9DS19JTUc6IDEwMDAwNTQwMDEsCiAgICAgICAgVktfRk9STUFUX1BWUlRDMl8yQlBQX1VOT1JNX0JMT0NLX0lNRzogMTAwMDA1NDAwMiwKICAgICAgICBWS19GT1JNQVRfUFZSVEMyXzRCUFBfVU5PUk1fQkxPQ0tfSU1HOiAxMDAwMDU0MDAzLAogICAgICAgIFZLX0ZPUk1BVF9QVlJUQzFfMkJQUF9TUkdCX0JMT0NLX0lNRzogMTAwMDA1NDAwNCwKICAgICAgICBWS19GT1JNQVRfUFZSVEMxXzRCUFBfU1JHQl9CTE9DS19JTUc6IDEwMDAwNTQwMDUsCiAgICAgICAgVktfRk9STUFUX1BWUlRDMl8yQlBQX1NSR0JfQkxPQ0tfSU1HOiAxMDAwMDU0MDA2LAogICAgICAgIFZLX0ZPUk1BVF9QVlJUQzJfNEJQUF9TUkdCX0JMT0NLX0lNRzogMTAwMDA1NDAwNywKICAgICAgICBWS19GT1JNQVRfQVNUQ180eDRfU0ZMT0FUX0JMT0NLX0VYVDogMTAwMDA2NmUzLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzV4NF9TRkxPQVRfQkxPQ0tfRVhUOiAxMDAwMDY2MDAxLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzV4NV9TRkxPQVRfQkxPQ0tfRVhUOiAxMDAwMDY2MDAyLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzZ4NV9TRkxPQVRfQkxPQ0tfRVhUOiAxMDAwMDY2MDAzLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzZ4Nl9TRkxPQVRfQkxPQ0tfRVhUOiAxMDAwMDY2MDA0LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzh4NV9TRkxPQVRfQkxPQ0tfRVhUOiAxMDAwMDY2MDA1LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzh4Nl9TRkxPQVRfQkxPQ0tfRVhUOiAxMDAwMDY2MDA2LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzh4OF9TRkxPQVRfQkxPQ0tfRVhUOiAxMDAwMDY2MDA3LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzEweDVfU0ZMT0FUX0JMT0NLX0VYVDogMTAwMDA2NjAwOCwKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMHg2X1NGTE9BVF9CTE9DS19FWFQ6IDEwMDAwNjYwMDksCiAgICAgICAgVktfRk9STUFUX0FTVENfMTB4OF9TRkxPQVRfQkxPQ0tfRVhUOiAxMDAwMDY2MDEwLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzEweDEwX1NGTE9BVF9CTE9DS19FWFQ6IDEwMDAwNjYwMTEsCiAgICAgICAgVktfRk9STUFUX0FTVENfMTJ4MTBfU0ZMT0FUX0JMT0NLX0VYVDogMTAwMDA2NjAxMiwKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMngxMl9TRkxPQVRfQkxPQ0tfRVhUOiAxMDAwMDY2MDEzLAogICAgICAgIFZLX0ZPUk1BVF9HOEI4RzhSOF80MjJfVU5PUk1fS0hSOiAxMDAwMTU2ZTMsCiAgICAgICAgVktfRk9STUFUX0I4RzhSOEc4XzQyMl9VTk9STV9LSFI6IDEwMDAxNTYwMDEsCiAgICAgICAgVktfRk9STUFUX0c4X0I4X1I4XzNQTEFORV80MjBfVU5PUk1fS0hSOiAxMDAwMTU2MDAyLAogICAgICAgIFZLX0ZPUk1BVF9HOF9COFI4XzJQTEFORV80MjBfVU5PUk1fS0hSOiAxMDAwMTU2MDAzLAogICAgICAgIFZLX0ZPUk1BVF9HOF9COF9SOF8zUExBTkVfNDIyX1VOT1JNX0tIUjogMTAwMDE1NjAwNCwKICAgICAgICBWS19GT1JNQVRfRzhfQjhSOF8yUExBTkVfNDIyX1VOT1JNX0tIUjogMTAwMDE1NjAwNSwKICAgICAgICBWS19GT1JNQVRfRzhfQjhfUjhfM1BMQU5FXzQ0NF9VTk9STV9LSFI6IDEwMDAxNTYwMDYsCiAgICAgICAgVktfRk9STUFUX1IxMFg2X1VOT1JNX1BBQ0sxNl9LSFI6IDEwMDAxNTYwMDcsCiAgICAgICAgVktfRk9STUFUX1IxMFg2RzEwWDZfVU5PUk1fMlBBQ0sxNl9LSFI6IDEwMDAxNTYwMDgsCiAgICAgICAgVktfRk9STUFUX1IxMFg2RzEwWDZCMTBYNkExMFg2X1VOT1JNXzRQQUNLMTZfS0hSOiAxMDAwMTU2MDA5LAogICAgICAgIFZLX0ZPUk1BVF9HMTBYNkIxMFg2RzEwWDZSMTBYNl80MjJfVU5PUk1fNFBBQ0sxNl9LSFI6IDEwMDAxNTYwMTAsCiAgICAgICAgVktfRk9STUFUX0IxMFg2RzEwWDZSMTBYNkcxMFg2XzQyMl9VTk9STV80UEFDSzE2X0tIUjogMTAwMDE1NjAxMSwKICAgICAgICBWS19GT1JNQVRfRzEwWDZfQjEwWDZfUjEwWDZfM1BMQU5FXzQyMF9VTk9STV8zUEFDSzE2X0tIUjogMTAwMDE1NjAxMiwKICAgICAgICBWS19GT1JNQVRfRzEwWDZfQjEwWDZSMTBYNl8yUExBTkVfNDIwX1VOT1JNXzNQQUNLMTZfS0hSOiAxMDAwMTU2MDEzLAogICAgICAgIFZLX0ZPUk1BVF9HMTBYNl9CMTBYNl9SMTBYNl8zUExBTkVfNDIyX1VOT1JNXzNQQUNLMTZfS0hSOiAxMDAwMTU2MDE0LAogICAgICAgIFZLX0ZPUk1BVF9HMTBYNl9CMTBYNlIxMFg2XzJQTEFORV80MjJfVU5PUk1fM1BBQ0sxNl9LSFI6IDEwMDAxNTYwMTUsCiAgICAgICAgVktfRk9STUFUX0cxMFg2X0IxMFg2X1IxMFg2XzNQTEFORV80NDRfVU5PUk1fM1BBQ0sxNl9LSFI6IDEwMDAxNTYwMTYsCiAgICAgICAgVktfRk9STUFUX1IxMlg0X1VOT1JNX1BBQ0sxNl9LSFI6IDEwMDAxNTYwMTcsCiAgICAgICAgVktfRk9STUFUX1IxMlg0RzEyWDRfVU5PUk1fMlBBQ0sxNl9LSFI6IDEwMDAxNTYwMTgsCiAgICAgICAgVktfRk9STUFUX1IxMlg0RzEyWDRCMTJYNEExMlg0X1VOT1JNXzRQQUNLMTZfS0hSOiAxMDAwMTU2MDE5LAogICAgICAgIFZLX0ZPUk1BVF9HMTJYNEIxMlg0RzEyWDRSMTJYNF80MjJfVU5PUk1fNFBBQ0sxNl9LSFI6IDEwMDAxNTYwMjAsCiAgICAgICAgVktfRk9STUFUX0IxMlg0RzEyWDRSMTJYNEcxMlg0XzQyMl9VTk9STV80UEFDSzE2X0tIUjogMTAwMDE1NjAyMSwKICAgICAgICBWS19GT1JNQVRfRzEyWDRfQjEyWDRfUjEyWDRfM1BMQU5FXzQyMF9VTk9STV8zUEFDSzE2X0tIUjogMTAwMDE1NjAyMiwKICAgICAgICBWS19GT1JNQVRfRzEyWDRfQjEyWDRSMTJYNF8yUExBTkVfNDIwX1VOT1JNXzNQQUNLMTZfS0hSOiAxMDAwMTU2MDIzLAogICAgICAgIFZLX0ZPUk1BVF9HMTJYNF9CMTJYNF9SMTJYNF8zUExBTkVfNDIyX1VOT1JNXzNQQUNLMTZfS0hSOiAxMDAwMTU2MDI0LAogICAgICAgIFZLX0ZPUk1BVF9HMTJYNF9CMTJYNFIxMlg0XzJQTEFORV80MjJfVU5PUk1fM1BBQ0sxNl9LSFI6IDEwMDAxNTYwMjUsCiAgICAgICAgVktfRk9STUFUX0cxMlg0X0IxMlg0X1IxMlg0XzNQTEFORV80NDRfVU5PUk1fM1BBQ0sxNl9LSFI6IDEwMDAxNTYwMjYsCiAgICAgICAgVktfRk9STUFUX0cxNkIxNkcxNlIxNl80MjJfVU5PUk1fS0hSOiAxMDAwMTU2MDI3LAogICAgICAgIFZLX0ZPUk1BVF9CMTZHMTZSMTZHMTZfNDIyX1VOT1JNX0tIUjogMTAwMDE1NjAyOCwKICAgICAgICBWS19GT1JNQVRfRzE2X0IxNl9SMTZfM1BMQU5FXzQyMF9VTk9STV9LSFI6IDEwMDAxNTYwMjksCiAgICAgICAgVktfRk9STUFUX0cxNl9CMTZSMTZfMlBMQU5FXzQyMF9VTk9STV9LSFI6IDEwMDAxNTYwMzAsCiAgICAgICAgVktfRk9STUFUX0cxNl9CMTZfUjE2XzNQTEFORV80MjJfVU5PUk1fS0hSOiAxMDAwMTU2MDMxLAogICAgICAgIFZLX0ZPUk1BVF9HMTZfQjE2UjE2XzJQTEFORV80MjJfVU5PUk1fS0hSOiAxMDAwMTU2MDMyLAogICAgICAgIFZLX0ZPUk1BVF9HMTZfQjE2X1IxNl8zUExBTkVfNDQ0X1VOT1JNX0tIUjogMTAwMDE1NjAzMwogICAgICB9OwogICAgICBWdWxrYW5Db25zdGFudHNfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoVnVsa2FuQ29uc3RhbnRzKTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL2t0eC1wYXJzZS9kaXN0L2t0eC1wYXJzZS5tb2Rlcm4uanMKICBmdW5jdGlvbiBkZWNvZGVUZXh0KGJ1ZmZlcikgewogICAgaWYgKHR5cGVvZiBUZXh0RGVjb2RlciAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgcmV0dXJuIG5ldyBUZXh0RGVjb2RlcigpLmRlY29kZShidWZmZXIpOwogICAgfQogICAgcmV0dXJuIEJ1ZmZlci5mcm9tKGJ1ZmZlcikudG9TdHJpbmcoInV0ZjgiKTsKICB9CiAgZnVuY3Rpb24gcmVhZDIoZGF0YSkgewogICAgY29uc3QgaWQgPSBuZXcgVWludDhBcnJheShkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0LCBLVFgyX0lELmxlbmd0aCk7CiAgICBpZiAoaWRbMF0gIT09IEtUWDJfSURbMF0gfHwgLy8gJ8K0JwogICAgaWRbMV0gIT09IEtUWDJfSURbMV0gfHwgLy8gJ0snCiAgICBpZFsyXSAhPT0gS1RYMl9JRFsyXSB8fCAvLyAnVCcKICAgIGlkWzNdICE9PSBLVFgyX0lEWzNdIHx8IC8vICdYJwogICAgaWRbNF0gIT09IEtUWDJfSURbNF0gfHwgLy8gJyAnCiAgICBpZFs1XSAhPT0gS1RYMl9JRFs1XSB8fCAvLyAnMicKICAgIGlkWzZdICE9PSBLVFgyX0lEWzZdIHx8IC8vICcwJwogICAgaWRbN10gIT09IEtUWDJfSURbN10gfHwgLy8gJ8KqJwogICAgaWRbOF0gIT09IEtUWDJfSURbOF0gfHwgLy8gJ1xyJwogICAgaWRbOV0gIT09IEtUWDJfSURbOV0gfHwgLy8gJ1xuJwogICAgaWRbMTBdICE9PSBLVFgyX0lEWzEwXSB8fCAvLyAnXHgxQScKICAgIGlkWzExXSAhPT0gS1RYMl9JRFsxMV0pIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJNaXNzaW5nIEtUWCAyLjAgaWRlbnRpZmllci4iKTsKICAgIH0KICAgIGNvbnN0IGNvbnRhaW5lciA9IG5ldyBLVFgyQ29udGFpbmVyKCk7CiAgICBjb25zdCBoZWFkZXJCeXRlTGVuZ3RoID0gMTcgKiBVaW50MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsKICAgIGNvbnN0IGhlYWRlclJlYWRlciA9IG5ldyBCdWZmZXJSZWFkZXIoZGF0YSwgS1RYMl9JRC5sZW5ndGgsIGhlYWRlckJ5dGVMZW5ndGgsIHRydWUpOwogICAgY29udGFpbmVyLnZrRm9ybWF0ID0gaGVhZGVyUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICBjb250YWluZXIudHlwZVNpemUgPSBoZWFkZXJSZWFkZXIuX25leHRVaW50MzIoKTsKICAgIGNvbnRhaW5lci5waXhlbFdpZHRoID0gaGVhZGVyUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICBjb250YWluZXIucGl4ZWxIZWlnaHQgPSBoZWFkZXJSZWFkZXIuX25leHRVaW50MzIoKTsKICAgIGNvbnRhaW5lci5waXhlbERlcHRoID0gaGVhZGVyUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICBjb250YWluZXIubGF5ZXJDb3VudCA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29udGFpbmVyLmZhY2VDb3VudCA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29uc3QgbGV2ZWxDb3VudCA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29udGFpbmVyLnN1cGVyY29tcHJlc3Npb25TY2hlbWUgPSBoZWFkZXJSZWFkZXIuX25leHRVaW50MzIoKTsKICAgIGNvbnN0IGRmZEJ5dGVPZmZzZXQgPSBoZWFkZXJSZWFkZXIuX25leHRVaW50MzIoKTsKICAgIGNvbnN0IGRmZEJ5dGVMZW5ndGggPSBoZWFkZXJSZWFkZXIuX25leHRVaW50MzIoKTsKICAgIGNvbnN0IGt2ZEJ5dGVPZmZzZXQgPSBoZWFkZXJSZWFkZXIuX25leHRVaW50MzIoKTsKICAgIGNvbnN0IGt2ZEJ5dGVMZW5ndGggPSBoZWFkZXJSZWFkZXIuX25leHRVaW50MzIoKTsKICAgIGNvbnN0IHNnZEJ5dGVPZmZzZXQgPSBoZWFkZXJSZWFkZXIuX25leHRVaW50NjQoKTsKICAgIGNvbnN0IHNnZEJ5dGVMZW5ndGggPSBoZWFkZXJSZWFkZXIuX25leHRVaW50NjQoKTsKICAgIGNvbnN0IGxldmVsQnl0ZUxlbmd0aCA9IGxldmVsQ291bnQgKiAzICogODsKICAgIGNvbnN0IGxldmVsUmVhZGVyID0gbmV3IEJ1ZmZlclJlYWRlcihkYXRhLCBLVFgyX0lELmxlbmd0aCArIGhlYWRlckJ5dGVMZW5ndGgsIGxldmVsQnl0ZUxlbmd0aCwgdHJ1ZSk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxldmVsQ291bnQ7IGkrKykgewogICAgICBjb250YWluZXIubGV2ZWxzLnB1c2goewogICAgICAgIGxldmVsRGF0YTogbmV3IFVpbnQ4QXJyYXkoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCArIGxldmVsUmVhZGVyLl9uZXh0VWludDY0KCksIGxldmVsUmVhZGVyLl9uZXh0VWludDY0KCkpLAogICAgICAgIHVuY29tcHJlc3NlZEJ5dGVMZW5ndGg6IGxldmVsUmVhZGVyLl9uZXh0VWludDY0KCkKICAgICAgfSk7CiAgICB9CiAgICBjb25zdCBkZmRSZWFkZXIgPSBuZXcgQnVmZmVyUmVhZGVyKGRhdGEsIGRmZEJ5dGVPZmZzZXQsIGRmZEJ5dGVMZW5ndGgsIHRydWUpOwogICAgY29uc3QgZGZkID0gewogICAgICB2ZW5kb3JJZDogZGZkUmVhZGVyLl9za2lwKAogICAgICAgIDQKICAgICAgICAvKiB0b3RhbFNpemUgKi8KICAgICAgKS5fbmV4dFVpbnQxNigpLAogICAgICBkZXNjcmlwdG9yVHlwZTogZGZkUmVhZGVyLl9uZXh0VWludDE2KCksCiAgICAgIHZlcnNpb25OdW1iZXI6IGRmZFJlYWRlci5fbmV4dFVpbnQxNigpLAogICAgICBkZXNjcmlwdG9yQmxvY2tTaXplOiBkZmRSZWFkZXIuX25leHRVaW50MTYoKSwKICAgICAgY29sb3JNb2RlbDogZGZkUmVhZGVyLl9uZXh0VWludDgoKSwKICAgICAgY29sb3JQcmltYXJpZXM6IGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksCiAgICAgIHRyYW5zZmVyRnVuY3Rpb246IGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksCiAgICAgIGZsYWdzOiBkZmRSZWFkZXIuX25leHRVaW50OCgpLAogICAgICB0ZXhlbEJsb2NrRGltZW5zaW9uOiBbZGZkUmVhZGVyLl9uZXh0VWludDgoKSwgZGZkUmVhZGVyLl9uZXh0VWludDgoKSwgZGZkUmVhZGVyLl9uZXh0VWludDgoKSwgZGZkUmVhZGVyLl9uZXh0VWludDgoKV0sCiAgICAgIGJ5dGVzUGxhbmU6IFtkZmRSZWFkZXIuX25leHRVaW50OCgpLCBkZmRSZWFkZXIuX25leHRVaW50OCgpLCBkZmRSZWFkZXIuX25leHRVaW50OCgpLCBkZmRSZWFkZXIuX25leHRVaW50OCgpLCBkZmRSZWFkZXIuX25leHRVaW50OCgpLCBkZmRSZWFkZXIuX25leHRVaW50OCgpLCBkZmRSZWFkZXIuX25leHRVaW50OCgpLCBkZmRSZWFkZXIuX25leHRVaW50OCgpXSwKICAgICAgc2FtcGxlczogW10KICAgIH07CiAgICBjb25zdCBzYW1wbGVTdGFydCA9IDY7CiAgICBjb25zdCBzYW1wbGVXb3JkcyA9IDQ7CiAgICBjb25zdCBudW1TYW1wbGVzID0gKGRmZC5kZXNjcmlwdG9yQmxvY2tTaXplIC8gNCAtIHNhbXBsZVN0YXJ0KSAvIHNhbXBsZVdvcmRzOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1TYW1wbGVzOyBpKyspIHsKICAgICAgY29uc3Qgc2FtcGxlID0gewogICAgICAgIGJpdE9mZnNldDogZGZkUmVhZGVyLl9uZXh0VWludDE2KCksCiAgICAgICAgYml0TGVuZ3RoOiBkZmRSZWFkZXIuX25leHRVaW50OCgpLAogICAgICAgIGNoYW5uZWxUeXBlOiBkZmRSZWFkZXIuX25leHRVaW50OCgpLAogICAgICAgIHNhbXBsZVBvc2l0aW9uOiBbZGZkUmVhZGVyLl9uZXh0VWludDgoKSwgZGZkUmVhZGVyLl9uZXh0VWludDgoKSwgZGZkUmVhZGVyLl9uZXh0VWludDgoKSwgZGZkUmVhZGVyLl9uZXh0VWludDgoKV0sCiAgICAgICAgc2FtcGxlTG93ZXI6IC1JbmZpbml0eSwKICAgICAgICBzYW1wbGVVcHBlcjogSW5maW5pdHkKICAgICAgfTsKICAgICAgaWYgKHNhbXBsZS5jaGFubmVsVHlwZSAmIEtIUl9ERl9TQU1QTEVfREFUQVRZUEVfU0lHTkVEKSB7CiAgICAgICAgc2FtcGxlLnNhbXBsZUxvd2VyID0gZGZkUmVhZGVyLl9uZXh0SW50MzIoKTsKICAgICAgICBzYW1wbGUuc2FtcGxlVXBwZXIgPSBkZmRSZWFkZXIuX25leHRJbnQzMigpOwogICAgICB9IGVsc2UgewogICAgICAgIHNhbXBsZS5zYW1wbGVMb3dlciA9IGRmZFJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgICAgIHNhbXBsZS5zYW1wbGVVcHBlciA9IGRmZFJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgICB9CiAgICAgIGRmZC5zYW1wbGVzW2ldID0gc2FtcGxlOwogICAgfQogICAgY29udGFpbmVyLmRhdGFGb3JtYXREZXNjcmlwdG9yLmxlbmd0aCA9IDA7CiAgICBjb250YWluZXIuZGF0YUZvcm1hdERlc2NyaXB0b3IucHVzaChkZmQpOwogICAgY29uc3Qga3ZkUmVhZGVyID0gbmV3IEJ1ZmZlclJlYWRlcihkYXRhLCBrdmRCeXRlT2Zmc2V0LCBrdmRCeXRlTGVuZ3RoLCB0cnVlKTsKICAgIHdoaWxlIChrdmRSZWFkZXIuX29mZnNldCA8IGt2ZEJ5dGVMZW5ndGgpIHsKICAgICAgY29uc3Qga2V5VmFsdWVCeXRlTGVuZ3RoID0ga3ZkUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICAgIGNvbnN0IGtleURhdGEgPSBrdmRSZWFkZXIuX3NjYW4oa2V5VmFsdWVCeXRlTGVuZ3RoKTsKICAgICAgY29uc3Qga2V5ID0gZGVjb2RlVGV4dChrZXlEYXRhKTsKICAgICAgY29udGFpbmVyLmtleVZhbHVlW2tleV0gPSBrdmRSZWFkZXIuX25leHRVaW50OEFycmF5KGtleVZhbHVlQnl0ZUxlbmd0aCAtIGtleURhdGEuYnl0ZUxlbmd0aCAtIDEpOwogICAgICBpZiAoa2V5Lm1hdGNoKC9ea3R4L2kpKSB7CiAgICAgICAgY29uc3QgdGV4dCA9IGRlY29kZVRleHQoY29udGFpbmVyLmtleVZhbHVlW2tleV0pOwogICAgICAgIGNvbnRhaW5lci5rZXlWYWx1ZVtrZXldID0gdGV4dC5zdWJzdHJpbmcoMCwgdGV4dC5sYXN0SW5kZXhPZigiXDAiKSk7CiAgICAgIH0KICAgICAgY29uc3Qga3ZQYWRkaW5nID0ga2V5VmFsdWVCeXRlTGVuZ3RoICUgNCA/IDQgLSBrZXlWYWx1ZUJ5dGVMZW5ndGggJSA0IDogMDsKICAgICAga3ZkUmVhZGVyLl9za2lwKGt2UGFkZGluZyk7CiAgICB9CiAgICBpZiAoc2dkQnl0ZUxlbmd0aCA8PSAwKQogICAgICByZXR1cm4gY29udGFpbmVyOwogICAgY29uc3Qgc2dkUmVhZGVyID0gbmV3IEJ1ZmZlclJlYWRlcihkYXRhLCBzZ2RCeXRlT2Zmc2V0LCBzZ2RCeXRlTGVuZ3RoLCB0cnVlKTsKICAgIGNvbnN0IGVuZHBvaW50Q291bnQgPSBzZ2RSZWFkZXIuX25leHRVaW50MTYoKTsKICAgIGNvbnN0IHNlbGVjdG9yQ291bnQgPSBzZ2RSZWFkZXIuX25leHRVaW50MTYoKTsKICAgIGNvbnN0IGVuZHBvaW50c0J5dGVMZW5ndGggPSBzZ2RSZWFkZXIuX25leHRVaW50MzIoKTsKICAgIGNvbnN0IHNlbGVjdG9yc0J5dGVMZW5ndGggPSBzZ2RSZWFkZXIuX25leHRVaW50MzIoKTsKICAgIGNvbnN0IHRhYmxlc0J5dGVMZW5ndGggPSBzZ2RSZWFkZXIuX25leHRVaW50MzIoKTsKICAgIGNvbnN0IGV4dGVuZGVkQnl0ZUxlbmd0aCA9IHNnZFJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29uc3QgaW1hZ2VEZXNjcyA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZXZlbENvdW50OyBpKyspIHsKICAgICAgaW1hZ2VEZXNjcy5wdXNoKHsKICAgICAgICBpbWFnZUZsYWdzOiBzZ2RSZWFkZXIuX25leHRVaW50MzIoKSwKICAgICAgICByZ2JTbGljZUJ5dGVPZmZzZXQ6IHNnZFJlYWRlci5fbmV4dFVpbnQzMigpLAogICAgICAgIHJnYlNsaWNlQnl0ZUxlbmd0aDogc2dkUmVhZGVyLl9uZXh0VWludDMyKCksCiAgICAgICAgYWxwaGFTbGljZUJ5dGVPZmZzZXQ6IHNnZFJlYWRlci5fbmV4dFVpbnQzMigpLAogICAgICAgIGFscGhhU2xpY2VCeXRlTGVuZ3RoOiBzZ2RSZWFkZXIuX25leHRVaW50MzIoKQogICAgICB9KTsKICAgIH0KICAgIGNvbnN0IGVuZHBvaW50c0J5dGVPZmZzZXQgPSBzZ2RCeXRlT2Zmc2V0ICsgc2dkUmVhZGVyLl9vZmZzZXQ7CiAgICBjb25zdCBzZWxlY3RvcnNCeXRlT2Zmc2V0ID0gZW5kcG9pbnRzQnl0ZU9mZnNldCArIGVuZHBvaW50c0J5dGVMZW5ndGg7CiAgICBjb25zdCB0YWJsZXNCeXRlT2Zmc2V0ID0gc2VsZWN0b3JzQnl0ZU9mZnNldCArIHNlbGVjdG9yc0J5dGVMZW5ndGg7CiAgICBjb25zdCBleHRlbmRlZEJ5dGVPZmZzZXQgPSB0YWJsZXNCeXRlT2Zmc2V0ICsgdGFibGVzQnl0ZUxlbmd0aDsKICAgIGNvbnN0IGVuZHBvaW50c0RhdGEgPSBuZXcgVWludDhBcnJheShkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0ICsgZW5kcG9pbnRzQnl0ZU9mZnNldCwgZW5kcG9pbnRzQnl0ZUxlbmd0aCk7CiAgICBjb25zdCBzZWxlY3RvcnNEYXRhID0gbmV3IFVpbnQ4QXJyYXkoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCArIHNlbGVjdG9yc0J5dGVPZmZzZXQsIHNlbGVjdG9yc0J5dGVMZW5ndGgpOwogICAgY29uc3QgdGFibGVzRGF0YSA9IG5ldyBVaW50OEFycmF5KGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQgKyB0YWJsZXNCeXRlT2Zmc2V0LCB0YWJsZXNCeXRlTGVuZ3RoKTsKICAgIGNvbnN0IGV4dGVuZGVkRGF0YSA9IG5ldyBVaW50OEFycmF5KGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQgKyBleHRlbmRlZEJ5dGVPZmZzZXQsIGV4dGVuZGVkQnl0ZUxlbmd0aCk7CiAgICBjb250YWluZXIuZ2xvYmFsRGF0YSA9IHsKICAgICAgZW5kcG9pbnRDb3VudCwKICAgICAgc2VsZWN0b3JDb3VudCwKICAgICAgaW1hZ2VEZXNjcywKICAgICAgZW5kcG9pbnRzRGF0YSwKICAgICAgc2VsZWN0b3JzRGF0YSwKICAgICAgdGFibGVzRGF0YSwKICAgICAgZXh0ZW5kZWREYXRhCiAgICB9OwogICAgcmV0dXJuIGNvbnRhaW5lcjsKICB9CiAgdmFyIEtIUl9TVVBFUkNPTVBSRVNTSU9OX05PTkUsIEtIUl9ERl9LSFJfREVTQ1JJUFRPUlRZUEVfQkFTSUNGT1JNQVQsIEtIUl9ERl9WRU5ET1JJRF9LSFJPTk9TLCBLSFJfREZfVkVSU0lPTiwgS0hSX0RGX01PREVMX1VOU1BFQ0lGSUVELCBLSFJfREZfRkxBR19BTFBIQV9TVFJBSUdIVCwgS0hSX0RGX1RSQU5TRkVSX1NSR0IsIEtIUl9ERl9QUklNQVJJRVNfQlQ3MDksIEtIUl9ERl9TQU1QTEVfREFUQVRZUEVfU0lHTkVELCBWS19GT1JNQVRfVU5ERUZJTkVELCBLVFgyQ29udGFpbmVyLCBCdWZmZXJSZWFkZXIsIE5VTCwgS1RYMl9JRDsKICB2YXIgaW5pdF9rdHhfcGFyc2VfbW9kZXJuID0gX19lc20oewogICAgIm5vZGVfbW9kdWxlcy9rdHgtcGFyc2UvZGlzdC9rdHgtcGFyc2UubW9kZXJuLmpzIigpIHsKICAgICAgS0hSX1NVUEVSQ09NUFJFU1NJT05fTk9ORSA9IDA7CiAgICAgIEtIUl9ERl9LSFJfREVTQ1JJUFRPUlRZUEVfQkFTSUNGT1JNQVQgPSAwOwogICAgICBLSFJfREZfVkVORE9SSURfS0hST05PUyA9IDA7CiAgICAgIEtIUl9ERl9WRVJTSU9OID0gMjsKICAgICAgS0hSX0RGX01PREVMX1VOU1BFQ0lGSUVEID0gMDsKICAgICAgS0hSX0RGX0ZMQUdfQUxQSEFfU1RSQUlHSFQgPSAwOwogICAgICBLSFJfREZfVFJBTlNGRVJfU1JHQiA9IDI7CiAgICAgIEtIUl9ERl9QUklNQVJJRVNfQlQ3MDkgPSAxOwogICAgICBLSFJfREZfU0FNUExFX0RBVEFUWVBFX1NJR05FRCA9IDY0OwogICAgICBWS19GT1JNQVRfVU5ERUZJTkVEID0gMDsKICAgICAgS1RYMkNvbnRhaW5lciA9IGNsYXNzIHsKICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgIHRoaXMudmtGb3JtYXQgPSBWS19GT1JNQVRfVU5ERUZJTkVEOwogICAgICAgICAgdGhpcy50eXBlU2l6ZSA9IDE7CiAgICAgICAgICB0aGlzLnBpeGVsV2lkdGggPSAwOwogICAgICAgICAgdGhpcy5waXhlbEhlaWdodCA9IDA7CiAgICAgICAgICB0aGlzLnBpeGVsRGVwdGggPSAwOwogICAgICAgICAgdGhpcy5sYXllckNvdW50ID0gMDsKICAgICAgICAgIHRoaXMuZmFjZUNvdW50ID0gMTsKICAgICAgICAgIHRoaXMuc3VwZXJjb21wcmVzc2lvblNjaGVtZSA9IEtIUl9TVVBFUkNPTVBSRVNTSU9OX05PTkU7CiAgICAgICAgICB0aGlzLmxldmVscyA9IFtdOwogICAgICAgICAgdGhpcy5kYXRhRm9ybWF0RGVzY3JpcHRvciA9IFt7CiAgICAgICAgICAgIHZlbmRvcklkOiBLSFJfREZfVkVORE9SSURfS0hST05PUywKICAgICAgICAgICAgZGVzY3JpcHRvclR5cGU6IEtIUl9ERl9LSFJfREVTQ1JJUFRPUlRZUEVfQkFTSUNGT1JNQVQsCiAgICAgICAgICAgIGRlc2NyaXB0b3JCbG9ja1NpemU6IDAsCiAgICAgICAgICAgIHZlcnNpb25OdW1iZXI6IEtIUl9ERl9WRVJTSU9OLAogICAgICAgICAgICBjb2xvck1vZGVsOiBLSFJfREZfTU9ERUxfVU5TUEVDSUZJRUQsCiAgICAgICAgICAgIGNvbG9yUHJpbWFyaWVzOiBLSFJfREZfUFJJTUFSSUVTX0JUNzA5LAogICAgICAgICAgICB0cmFuc2ZlckZ1bmN0aW9uOiBLSFJfREZfVFJBTlNGRVJfU1JHQiwKICAgICAgICAgICAgZmxhZ3M6IEtIUl9ERl9GTEFHX0FMUEhBX1NUUkFJR0hULAogICAgICAgICAgICB0ZXhlbEJsb2NrRGltZW5zaW9uOiBbMCwgMCwgMCwgMF0sCiAgICAgICAgICAgIGJ5dGVzUGxhbmU6IFswLCAwLCAwLCAwLCAwLCAwLCAwLCAwXSwKICAgICAgICAgICAgc2FtcGxlczogW10KICAgICAgICAgIH1dOwogICAgICAgICAgdGhpcy5rZXlWYWx1ZSA9IHt9OwogICAgICAgICAgdGhpcy5nbG9iYWxEYXRhID0gbnVsbDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIEJ1ZmZlclJlYWRlciA9IGNsYXNzIHsKICAgICAgICBjb25zdHJ1Y3RvcihkYXRhLCBieXRlT2Zmc2V0LCBieXRlTGVuZ3RoLCBsaXR0bGVFbmRpYW4yKSB7CiAgICAgICAgICB0aGlzLl9kYXRhVmlldyA9IHZvaWQgMDsKICAgICAgICAgIHRoaXMuX2xpdHRsZUVuZGlhbiA9IHZvaWQgMDsKICAgICAgICAgIHRoaXMuX29mZnNldCA9IHZvaWQgMDsKICAgICAgICAgIHRoaXMuX2RhdGFWaWV3ID0gbmV3IERhdGFWaWV3KGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQgKyBieXRlT2Zmc2V0LCBieXRlTGVuZ3RoKTsKICAgICAgICAgIHRoaXMuX2xpdHRsZUVuZGlhbiA9IGxpdHRsZUVuZGlhbjI7CiAgICAgICAgICB0aGlzLl9vZmZzZXQgPSAwOwogICAgICAgIH0KICAgICAgICBfbmV4dFVpbnQ4KCkgewogICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLl9kYXRhVmlldy5nZXRVaW50OCh0aGlzLl9vZmZzZXQpOwogICAgICAgICAgdGhpcy5fb2Zmc2V0ICs9IDE7CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIF9uZXh0VWludDE2KCkgewogICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLl9kYXRhVmlldy5nZXRVaW50MTYodGhpcy5fb2Zmc2V0LCB0aGlzLl9saXR0bGVFbmRpYW4pOwogICAgICAgICAgdGhpcy5fb2Zmc2V0ICs9IDI7CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIF9uZXh0VWludDMyKCkgewogICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLl9kYXRhVmlldy5nZXRVaW50MzIodGhpcy5fb2Zmc2V0LCB0aGlzLl9saXR0bGVFbmRpYW4pOwogICAgICAgICAgdGhpcy5fb2Zmc2V0ICs9IDQ7CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIF9uZXh0VWludDY0KCkgewogICAgICAgICAgY29uc3QgbGVmdCA9IHRoaXMuX2RhdGFWaWV3LmdldFVpbnQzMih0aGlzLl9vZmZzZXQsIHRoaXMuX2xpdHRsZUVuZGlhbik7CiAgICAgICAgICBjb25zdCByaWdodCA9IHRoaXMuX2RhdGFWaWV3LmdldFVpbnQzMih0aGlzLl9vZmZzZXQgKyA0LCB0aGlzLl9saXR0bGVFbmRpYW4pOwogICAgICAgICAgY29uc3QgdmFsdWUgPSBsZWZ0ICsgMiAqKiAzMiAqIHJpZ2h0OwogICAgICAgICAgdGhpcy5fb2Zmc2V0ICs9IDg7CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIF9uZXh0SW50MzIoKSB7CiAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuX2RhdGFWaWV3LmdldEludDMyKHRoaXMuX29mZnNldCwgdGhpcy5fbGl0dGxlRW5kaWFuKTsKICAgICAgICAgIHRoaXMuX29mZnNldCArPSA0OwogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBfbmV4dFVpbnQ4QXJyYXkobGVuKSB7CiAgICAgICAgICBjb25zdCB2YWx1ZSA9IG5ldyBVaW50OEFycmF5KHRoaXMuX2RhdGFWaWV3LmJ1ZmZlciwgdGhpcy5fZGF0YVZpZXcuYnl0ZU9mZnNldCArIHRoaXMuX29mZnNldCwgbGVuKTsKICAgICAgICAgIHRoaXMuX29mZnNldCArPSBsZW47CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIF9za2lwKGJ5dGVzKSB7CiAgICAgICAgICB0aGlzLl9vZmZzZXQgKz0gYnl0ZXM7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICAgICAgX3NjYW4obWF4Qnl0ZUxlbmd0aCwgdGVybSA9IDApIHsKICAgICAgICAgIGNvbnN0IGJ5dGVPZmZzZXQgPSB0aGlzLl9vZmZzZXQ7CiAgICAgICAgICBsZXQgYnl0ZUxlbmd0aCA9IDA7CiAgICAgICAgICB3aGlsZSAodGhpcy5fZGF0YVZpZXcuZ2V0VWludDgodGhpcy5fb2Zmc2V0KSAhPT0gdGVybSAmJiBieXRlTGVuZ3RoIDwgbWF4Qnl0ZUxlbmd0aCkgewogICAgICAgICAgICBieXRlTGVuZ3RoKys7CiAgICAgICAgICAgIHRoaXMuX29mZnNldCsrOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJ5dGVMZW5ndGggPCBtYXhCeXRlTGVuZ3RoKQogICAgICAgICAgICB0aGlzLl9vZmZzZXQrKzsKICAgICAgICAgIHJldHVybiBuZXcgVWludDhBcnJheSh0aGlzLl9kYXRhVmlldy5idWZmZXIsIHRoaXMuX2RhdGFWaWV3LmJ5dGVPZmZzZXQgKyBieXRlT2Zmc2V0LCBieXRlTGVuZ3RoKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIE5VTCA9IG5ldyBVaW50OEFycmF5KFswXSk7CiAgICAgIEtUWDJfSUQgPSBbCiAgICAgICAgLy8gJ8K0JywgJ0snLCAnVCcsICdYJywgJzInLCAnMCcsICfCqicsICdccicsICdcbicsICdceDFBJywgJ1xuJwogICAgICAgIDE3MSwKICAgICAgICA3NSwKICAgICAgICA4NCwKICAgICAgICA4OCwKICAgICAgICAzMiwKICAgICAgICA1MCwKICAgICAgICA0OCwKICAgICAgICAxODcsCiAgICAgICAgMTMsCiAgICAgICAgMTAsCiAgICAgICAgMjYsCiAgICAgICAgMTAKICAgICAgXTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9UaGlyZFBhcnR5L1dvcmtlcnMvYmFzaXNfdHJhbnNjb2Rlci5qcwogIHZhciByZXF1aXJlX2Jhc2lzX3RyYW5zY29kZXIgPSBfX2NvbW1vbkpTKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1RoaXJkUGFydHkvV29ya2Vycy9iYXNpc190cmFuc2NvZGVyLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgIHZhciBCQVNJUyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBfc2NyaXB0RGlyID0gdHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiBkb2N1bWVudC5jdXJyZW50U2NyaXB0ID8gZG9jdW1lbnQuY3VycmVudFNjcmlwdC5zcmMgOiB2b2lkIDA7CiAgICAgICAgaWYgKHR5cGVvZiBfX2ZpbGVuYW1lICE9PSAidW5kZWZpbmVkIikKICAgICAgICAgIF9zY3JpcHREaXIgPSBfc2NyaXB0RGlyIHx8IF9fZmlsZW5hbWU7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKEJBU0lTMikgewogICAgICAgICAgQkFTSVMyID0gQkFTSVMyIHx8IHt9OwogICAgICAgICAgdmFyIE1vZHVsZSA9IHR5cGVvZiBCQVNJUzIgIT09ICJ1bmRlZmluZWQiID8gQkFTSVMyIDoge307CiAgICAgICAgICB2YXIgcmVhZHlQcm9taXNlUmVzb2x2ZSwgcmVhZHlQcm9taXNlUmVqZWN0OwogICAgICAgICAgTW9kdWxlWyJyZWFkeSJdID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgIHJlYWR5UHJvbWlzZVJlc29sdmUgPSByZXNvbHZlOwogICAgICAgICAgICByZWFkeVByb21pc2VSZWplY3QgPSByZWplY3Q7CiAgICAgICAgICB9KTsKICAgICAgICAgIHZhciBtb2R1bGVPdmVycmlkZXMgPSB7fTsKICAgICAgICAgIHZhciBrZXk7CiAgICAgICAgICBmb3IgKGtleSBpbiBNb2R1bGUpIHsKICAgICAgICAgICAgaWYgKE1vZHVsZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgbW9kdWxlT3ZlcnJpZGVzW2tleV0gPSBNb2R1bGVba2V5XTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGFyZ3VtZW50c18gPSBbXTsKICAgICAgICAgIHZhciB0aGlzUHJvZ3JhbSA9ICIuL3RoaXMucHJvZ3JhbSI7CiAgICAgICAgICB2YXIgcXVpdF8gPSBmdW5jdGlvbihzdGF0dXMsIHRvVGhyb3cpIHsKICAgICAgICAgICAgdGhyb3cgdG9UaHJvdzsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgRU5WSVJPTk1FTlRfSVNfV0VCID0gZmFsc2U7CiAgICAgICAgICB2YXIgRU5WSVJPTk1FTlRfSVNfV09SS0VSID0gZmFsc2U7CiAgICAgICAgICB2YXIgRU5WSVJPTk1FTlRfSVNfTk9ERSA9IGZhbHNlOwogICAgICAgICAgdmFyIEVOVklST05NRU5UX0lTX1NIRUxMID0gZmFsc2U7CiAgICAgICAgICBFTlZJUk9OTUVOVF9JU19XRUIgPSB0eXBlb2Ygd2luZG93ID09PSAib2JqZWN0IjsKICAgICAgICAgIEVOVklST05NRU5UX0lTX1dPUktFUiA9IHR5cGVvZiBpbXBvcnRTY3JpcHRzID09PSAiZnVuY3Rpb24iOwogICAgICAgICAgRU5WSVJPTk1FTlRfSVNfTk9ERSA9IHR5cGVvZiBwcm9jZXNzID09PSAib2JqZWN0IiAmJiB0eXBlb2YgcHJvY2Vzcy52ZXJzaW9ucyA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHByb2Nlc3MudmVyc2lvbnMubm9kZSA9PT0gInN0cmluZyI7CiAgICAgICAgICBFTlZJUk9OTUVOVF9JU19TSEVMTCA9ICFFTlZJUk9OTUVOVF9JU19XRUIgJiYgIUVOVklST05NRU5UX0lTX05PREUgJiYgIUVOVklST05NRU5UX0lTX1dPUktFUjsKICAgICAgICAgIHZhciBzY3JpcHREaXJlY3RvcnkgPSAiIjsKICAgICAgICAgIGZ1bmN0aW9uIGxvY2F0ZUZpbGUocGF0aCkgewogICAgICAgICAgICBpZiAoTW9kdWxlWyJsb2NhdGVGaWxlIl0pIHsKICAgICAgICAgICAgICByZXR1cm4gTW9kdWxlWyJsb2NhdGVGaWxlIl0ocGF0aCwgc2NyaXB0RGlyZWN0b3J5KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc2NyaXB0RGlyZWN0b3J5ICsgcGF0aDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciByZWFkXywgcmVhZEFzeW5jLCByZWFkQmluYXJ5LCBzZXRXaW5kb3dUaXRsZTsKICAgICAgICAgIHZhciBub2RlRlM7CiAgICAgICAgICB2YXIgbm9kZVBhdGg7CiAgICAgICAgICBpZiAoRU5WSVJPTk1FTlRfSVNfTk9ERSkgewogICAgICAgICAgICBpZiAoRU5WSVJPTk1FTlRfSVNfV09SS0VSKSB7CiAgICAgICAgICAgICAgc2NyaXB0RGlyZWN0b3J5ID0gX19yZXF1aXJlKCJwYXRoIikuZGlybmFtZShzY3JpcHREaXJlY3RvcnkpICsgIi8iOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNjcmlwdERpcmVjdG9yeSA9IF9fZGlybmFtZSArICIvIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZWFkXyA9IGZ1bmN0aW9uIHNoZWxsX3JlYWQoZmlsZW5hbWUsIGJpbmFyeSkgewogICAgICAgICAgICAgIGlmICghbm9kZUZTKQogICAgICAgICAgICAgICAgbm9kZUZTID0gX19yZXF1aXJlKCJmcyIpOwogICAgICAgICAgICAgIGlmICghbm9kZVBhdGgpCiAgICAgICAgICAgICAgICBub2RlUGF0aCA9IF9fcmVxdWlyZSgicGF0aCIpOwogICAgICAgICAgICAgIGZpbGVuYW1lID0gbm9kZVBhdGhbIm5vcm1hbGl6ZSJdKGZpbGVuYW1lKTsKICAgICAgICAgICAgICByZXR1cm4gbm9kZUZTWyJyZWFkRmlsZVN5bmMiXShmaWxlbmFtZSwgYmluYXJ5ID8gbnVsbCA6ICJ1dGY4Iik7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJlYWRCaW5hcnkgPSBmdW5jdGlvbiByZWFkQmluYXJ5MihmaWxlbmFtZSkgewogICAgICAgICAgICAgIHZhciByZXQgPSByZWFkXyhmaWxlbmFtZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgaWYgKCFyZXQuYnVmZmVyKSB7CiAgICAgICAgICAgICAgICByZXQgPSBuZXcgVWludDhBcnJheShyZXQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBhc3NlcnQocmV0LmJ1ZmZlcik7CiAgICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKHByb2Nlc3NbImFyZ3YiXS5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgdGhpc1Byb2dyYW0gPSBwcm9jZXNzWyJhcmd2Il1bMV0ucmVwbGFjZSgvXFwvZywgIi8iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhcmd1bWVudHNfID0gcHJvY2Vzc1siYXJndiJdLnNsaWNlKDIpOwogICAgICAgICAgICBwcm9jZXNzWyJvbiJdKCJ1bmNhdWdodEV4Y2VwdGlvbiIsIGZ1bmN0aW9uKGV4KSB7CiAgICAgICAgICAgICAgaWYgKCEoZXggaW5zdGFuY2VvZiBFeGl0U3RhdHVzKSkgewogICAgICAgICAgICAgICAgdGhyb3cgZXg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcHJvY2Vzc1sib24iXSgidW5oYW5kbGVkUmVqZWN0aW9uIiwgYWJvcnQpOwogICAgICAgICAgICBxdWl0XyA9IGZ1bmN0aW9uKHN0YXR1cykgewogICAgICAgICAgICAgIHByb2Nlc3NbImV4aXQiXShzdGF0dXMpOwogICAgICAgICAgICB9OwogICAgICAgICAgICBNb2R1bGVbImluc3BlY3QiXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAiW0Vtc2NyaXB0ZW4gTW9kdWxlIG9iamVjdF0iOwogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIGlmIChFTlZJUk9OTUVOVF9JU19TSEVMTCkgewogICAgICAgICAgICBpZiAodHlwZW9mIHJlYWQgIT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICByZWFkXyA9IGZ1bmN0aW9uIHNoZWxsX3JlYWQoZikgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlYWQoZik7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZWFkQmluYXJ5ID0gZnVuY3Rpb24gcmVhZEJpbmFyeTIoZikgewogICAgICAgICAgICAgIHZhciBkYXRhOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgcmVhZGJ1ZmZlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KHJlYWRidWZmZXIoZikpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkYXRhID0gcmVhZChmLCAiYmluYXJ5Iik7CiAgICAgICAgICAgICAgYXNzZXJ0KHR5cGVvZiBkYXRhID09PSAib2JqZWN0Iik7CiAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmICh0eXBlb2Ygc2NyaXB0QXJncyAhPSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIGFyZ3VtZW50c18gPSBzY3JpcHRBcmdzOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmd1bWVudHMgIT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICBhcmd1bWVudHNfID0gYXJndW1lbnRzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgcXVpdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHF1aXRfID0gZnVuY3Rpb24oc3RhdHVzKSB7CiAgICAgICAgICAgICAgICBxdWl0KHN0YXR1cyk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHByaW50ICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgY29uc29sZSA9PT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICBjb25zb2xlID0ge307CiAgICAgICAgICAgICAgY29uc29sZS5sb2cgPSBwcmludDsKICAgICAgICAgICAgICBjb25zb2xlLndhcm4gPSBjb25zb2xlLmVycm9yID0gdHlwZW9mIHByaW50RXJyICE9PSAidW5kZWZpbmVkIiA/IHByaW50RXJyIDogcHJpbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoRU5WSVJPTk1FTlRfSVNfV0VCIHx8IEVOVklST05NRU5UX0lTX1dPUktFUikgewogICAgICAgICAgICBpZiAoRU5WSVJPTk1FTlRfSVNfV09SS0VSKSB7CiAgICAgICAgICAgICAgc2NyaXB0RGlyZWN0b3J5ID0gc2VsZi5sb2NhdGlvbi5ocmVmOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgZG9jdW1lbnQuY3VycmVudFNjcmlwdCkgewogICAgICAgICAgICAgIHNjcmlwdERpcmVjdG9yeSA9IGRvY3VtZW50LmN1cnJlbnRTY3JpcHQuc3JjOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChfc2NyaXB0RGlyKSB7CiAgICAgICAgICAgICAgc2NyaXB0RGlyZWN0b3J5ID0gX3NjcmlwdERpcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2NyaXB0RGlyZWN0b3J5LmluZGV4T2YoImJsb2I6IikgIT09IDApIHsKICAgICAgICAgICAgICBzY3JpcHREaXJlY3RvcnkgPSBzY3JpcHREaXJlY3Rvcnkuc3Vic3RyKDAsIHNjcmlwdERpcmVjdG9yeS5sYXN0SW5kZXhPZigiLyIpICsgMSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2NyaXB0RGlyZWN0b3J5ID0gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHJlYWRfID0gZnVuY3Rpb24odXJsKSB7CiAgICAgICAgICAgICAgICB2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICAgICAgICAgICAgICB4aHIub3BlbigiR0VUIiwgdXJsLCBmYWxzZSk7CiAgICAgICAgICAgICAgICB4aHIuc2VuZChudWxsKTsKICAgICAgICAgICAgICAgIHJldHVybiB4aHIucmVzcG9uc2VUZXh0OwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgaWYgKEVOVklST05NRU5UX0lTX1dPUktFUikgewogICAgICAgICAgICAgICAgcmVhZEJpbmFyeSA9IGZ1bmN0aW9uKHVybCkgewogICAgICAgICAgICAgICAgICB2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICAgICAgICAgICAgICAgIHhoci5vcGVuKCJHRVQiLCB1cmwsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgeGhyLnJlc3BvbnNlVHlwZSA9ICJhcnJheWJ1ZmZlciI7CiAgICAgICAgICAgICAgICAgIHhoci5zZW5kKG51bGwpOwogICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoeGhyLnJlc3BvbnNlKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlYWRBc3luYyA9IGZ1bmN0aW9uKHVybCwgb25sb2FkLCBvbmVycm9yKSB7CiAgICAgICAgICAgICAgICB2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICAgICAgICAgICAgICB4aHIub3BlbigiR0VUIiwgdXJsLCB0cnVlKTsKICAgICAgICAgICAgICAgIHhoci5yZXNwb25zZVR5cGUgPSAiYXJyYXlidWZmZXIiOwogICAgICAgICAgICAgICAgeGhyLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpZiAoeGhyLnN0YXR1cyA9PSAyMDAgfHwgeGhyLnN0YXR1cyA9PSAwICYmIHhoci5yZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgIG9ubG9hZCh4aHIucmVzcG9uc2UpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBvbmVycm9yKCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgeGhyLm9uZXJyb3IgPSBvbmVycm9yOwogICAgICAgICAgICAgICAgeGhyLnNlbmQobnVsbCk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRXaW5kb3dUaXRsZSA9IGZ1bmN0aW9uKHRpdGxlKSB7CiAgICAgICAgICAgICAgZG9jdW1lbnQudGl0bGUgPSB0aXRsZTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgb3V0ID0gTW9kdWxlWyJwcmludCJdIHx8IGNvbnNvbGUubG9nLmJpbmQoY29uc29sZSk7CiAgICAgICAgICB2YXIgZXJyID0gTW9kdWxlWyJwcmludEVyciJdIHx8IGNvbnNvbGUud2Fybi5iaW5kKGNvbnNvbGUpOwogICAgICAgICAgZm9yIChrZXkgaW4gbW9kdWxlT3ZlcnJpZGVzKSB7CiAgICAgICAgICAgIGlmIChtb2R1bGVPdmVycmlkZXMuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgIE1vZHVsZVtrZXldID0gbW9kdWxlT3ZlcnJpZGVzW2tleV07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG1vZHVsZU92ZXJyaWRlcyA9IG51bGw7CiAgICAgICAgICBpZiAoTW9kdWxlWyJhcmd1bWVudHMiXSkKICAgICAgICAgICAgYXJndW1lbnRzXyA9IE1vZHVsZVsiYXJndW1lbnRzIl07CiAgICAgICAgICBpZiAoTW9kdWxlWyJ0aGlzUHJvZ3JhbSJdKQogICAgICAgICAgICB0aGlzUHJvZ3JhbSA9IE1vZHVsZVsidGhpc1Byb2dyYW0iXTsKICAgICAgICAgIGlmIChNb2R1bGVbInF1aXQiXSkKICAgICAgICAgICAgcXVpdF8gPSBNb2R1bGVbInF1aXQiXTsKICAgICAgICAgIHZhciB0ZW1wUmV0MCA9IDA7CiAgICAgICAgICB2YXIgc2V0VGVtcFJldDAgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICB0ZW1wUmV0MCA9IHZhbHVlOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciB3YXNtQmluYXJ5OwogICAgICAgICAgaWYgKE1vZHVsZVsid2FzbUJpbmFyeSJdKQogICAgICAgICAgICB3YXNtQmluYXJ5ID0gTW9kdWxlWyJ3YXNtQmluYXJ5Il07CiAgICAgICAgICB2YXIgbm9FeGl0UnVudGltZSA9IE1vZHVsZVsibm9FeGl0UnVudGltZSJdIHx8IHRydWU7CiAgICAgICAgICBpZiAodHlwZW9mIFdlYkFzc2VtYmx5ICE9PSAib2JqZWN0IikgewogICAgICAgICAgICBhYm9ydCgibm8gbmF0aXZlIHdhc20gc3VwcG9ydCBkZXRlY3RlZCIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHdhc21NZW1vcnk7CiAgICAgICAgICB2YXIgQUJPUlQgPSBmYWxzZTsKICAgICAgICAgIHZhciBFWElUU1RBVFVTOwogICAgICAgICAgZnVuY3Rpb24gYXNzZXJ0KGNvbmRpdGlvbiwgdGV4dCkgewogICAgICAgICAgICBpZiAoIWNvbmRpdGlvbikgewogICAgICAgICAgICAgIGFib3J0KCJBc3NlcnRpb24gZmFpbGVkOiAiICsgdGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBVVEY4RGVjb2RlciA9IHR5cGVvZiBUZXh0RGVjb2RlciAhPT0gInVuZGVmaW5lZCIgPyBuZXcgVGV4dERlY29kZXIoInV0ZjgiKSA6IHZvaWQgMDsKICAgICAgICAgIGZ1bmN0aW9uIFVURjhBcnJheVRvU3RyaW5nKGhlYXAsIGlkeCwgbWF4Qnl0ZXNUb1JlYWQpIHsKICAgICAgICAgICAgdmFyIGVuZElkeCA9IGlkeCArIG1heEJ5dGVzVG9SZWFkOwogICAgICAgICAgICB2YXIgZW5kUHRyID0gaWR4OwogICAgICAgICAgICB3aGlsZSAoaGVhcFtlbmRQdHJdICYmICEoZW5kUHRyID49IGVuZElkeCkpCiAgICAgICAgICAgICAgKytlbmRQdHI7CiAgICAgICAgICAgIGlmIChlbmRQdHIgLSBpZHggPiAxNiAmJiBoZWFwLnN1YmFycmF5ICYmIFVURjhEZWNvZGVyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFVURjhEZWNvZGVyLmRlY29kZShoZWFwLnN1YmFycmF5KGlkeCwgZW5kUHRyKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHN0ciA9ICIiOwogICAgICAgICAgICAgIHdoaWxlIChpZHggPCBlbmRQdHIpIHsKICAgICAgICAgICAgICAgIHZhciB1MCA9IGhlYXBbaWR4KytdOwogICAgICAgICAgICAgICAgaWYgKCEodTAgJiAxMjgpKSB7CiAgICAgICAgICAgICAgICAgIHN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKHUwKTsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgdTEyID0gaGVhcFtpZHgrK10gJiA2MzsKICAgICAgICAgICAgICAgIGlmICgodTAgJiAyMjQpID09IDE5MikgewogICAgICAgICAgICAgICAgICBzdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgodTAgJiAzMSkgPDwgNiB8IHUxMik7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHUyMiA9IGhlYXBbaWR4KytdICYgNjM7CiAgICAgICAgICAgICAgICBpZiAoKHUwICYgMjQwKSA9PSAyMjQpIHsKICAgICAgICAgICAgICAgICAgdTAgPSAodTAgJiAxNSkgPDwgMTIgfCB1MTIgPDwgNiB8IHUyMjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHUwID0gKHUwICYgNykgPDwgMTggfCB1MTIgPDwgMTIgfCB1MjIgPDwgNiB8IGhlYXBbaWR4KytdICYgNjM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodTAgPCA2NTUzNikgewogICAgICAgICAgICAgICAgICBzdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSh1MCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgY2ggPSB1MCAtIDY1NTM2OwogICAgICAgICAgICAgICAgICBzdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSg1NTI5NiB8IGNoID4+IDEwLCA1NjMyMCB8IGNoICYgMTAyMyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzdHI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBVVEY4VG9TdHJpbmcocHRyLCBtYXhCeXRlc1RvUmVhZCkgewogICAgICAgICAgICByZXR1cm4gcHRyID8gVVRGOEFycmF5VG9TdHJpbmcoSEVBUFU4LCBwdHIsIG1heEJ5dGVzVG9SZWFkKSA6ICIiOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gc3RyaW5nVG9VVEY4QXJyYXkoc3RyLCBoZWFwLCBvdXRJZHgsIG1heEJ5dGVzVG9Xcml0ZSkgewogICAgICAgICAgICBpZiAoIShtYXhCeXRlc1RvV3JpdGUgPiAwKSkKICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgdmFyIHN0YXJ0SWR4ID0gb3V0SWR4OwogICAgICAgICAgICB2YXIgZW5kSWR4ID0gb3V0SWR4ICsgbWF4Qnl0ZXNUb1dyaXRlIC0gMTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICB2YXIgdTMgPSBzdHIuY2hhckNvZGVBdChpKTsKICAgICAgICAgICAgICBpZiAodTMgPj0gNTUyOTYgJiYgdTMgPD0gNTczNDMpIHsKICAgICAgICAgICAgICAgIHZhciB1MTIgPSBzdHIuY2hhckNvZGVBdCgrK2kpOwogICAgICAgICAgICAgICAgdTMgPSA2NTUzNiArICgodTMgJiAxMDIzKSA8PCAxMCkgfCB1MTIgJiAxMDIzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodTMgPD0gMTI3KSB7CiAgICAgICAgICAgICAgICBpZiAob3V0SWR4ID49IGVuZElkeCkKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBoZWFwW291dElkeCsrXSA9IHUzOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodTMgPD0gMjA0NykgewogICAgICAgICAgICAgICAgaWYgKG91dElkeCArIDEgPj0gZW5kSWR4KQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGhlYXBbb3V0SWR4KytdID0gMTkyIHwgdTMgPj4gNjsKICAgICAgICAgICAgICAgIGhlYXBbb3V0SWR4KytdID0gMTI4IHwgdTMgJiA2MzsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHUzIDw9IDY1NTM1KSB7CiAgICAgICAgICAgICAgICBpZiAob3V0SWR4ICsgMiA+PSBlbmRJZHgpCiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAyMjQgfCB1MyA+PiAxMjsKICAgICAgICAgICAgICAgIGhlYXBbb3V0SWR4KytdID0gMTI4IHwgdTMgPj4gNiAmIDYzOwogICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAxMjggfCB1MyAmIDYzOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAob3V0SWR4ICsgMyA+PSBlbmRJZHgpCiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAyNDAgfCB1MyA+PiAxODsKICAgICAgICAgICAgICAgIGhlYXBbb3V0SWR4KytdID0gMTI4IHwgdTMgPj4gMTIgJiA2MzsKICAgICAgICAgICAgICAgIGhlYXBbb3V0SWR4KytdID0gMTI4IHwgdTMgPj4gNiAmIDYzOwogICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAxMjggfCB1MyAmIDYzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBoZWFwW291dElkeF0gPSAwOwogICAgICAgICAgICByZXR1cm4gb3V0SWR4IC0gc3RhcnRJZHg7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzdHJpbmdUb1VURjgoc3RyLCBvdXRQdHIsIG1heEJ5dGVzVG9Xcml0ZSkgewogICAgICAgICAgICByZXR1cm4gc3RyaW5nVG9VVEY4QXJyYXkoc3RyLCBIRUFQVTgsIG91dFB0ciwgbWF4Qnl0ZXNUb1dyaXRlKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGxlbmd0aEJ5dGVzVVRGOChzdHIpIHsKICAgICAgICAgICAgdmFyIGxlbiA9IDA7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgdmFyIHUzID0gc3RyLmNoYXJDb2RlQXQoaSk7CiAgICAgICAgICAgICAgaWYgKHUzID49IDU1Mjk2ICYmIHUzIDw9IDU3MzQzKQogICAgICAgICAgICAgICAgdTMgPSA2NTUzNiArICgodTMgJiAxMDIzKSA8PCAxMCkgfCBzdHIuY2hhckNvZGVBdCgrK2kpICYgMTAyMzsKICAgICAgICAgICAgICBpZiAodTMgPD0gMTI3KQogICAgICAgICAgICAgICAgKytsZW47CiAgICAgICAgICAgICAgZWxzZSBpZiAodTMgPD0gMjA0NykKICAgICAgICAgICAgICAgIGxlbiArPSAyOwogICAgICAgICAgICAgIGVsc2UgaWYgKHUzIDw9IDY1NTM1KQogICAgICAgICAgICAgICAgbGVuICs9IDM7CiAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgbGVuICs9IDQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlbjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBVVEYxNkRlY29kZXIgPSB0eXBlb2YgVGV4dERlY29kZXIgIT09ICJ1bmRlZmluZWQiID8gbmV3IFRleHREZWNvZGVyKCJ1dGYtMTZsZSIpIDogdm9pZCAwOwogICAgICAgICAgZnVuY3Rpb24gVVRGMTZUb1N0cmluZyhwdHIsIG1heEJ5dGVzVG9SZWFkKSB7CiAgICAgICAgICAgIHZhciBlbmRQdHIgPSBwdHI7CiAgICAgICAgICAgIHZhciBpZHggPSBlbmRQdHIgPj4gMTsKICAgICAgICAgICAgdmFyIG1heElkeCA9IGlkeCArIG1heEJ5dGVzVG9SZWFkIC8gMjsKICAgICAgICAgICAgd2hpbGUgKCEoaWR4ID49IG1heElkeCkgJiYgSEVBUFUxNltpZHhdKQogICAgICAgICAgICAgICsraWR4OwogICAgICAgICAgICBlbmRQdHIgPSBpZHggPDwgMTsKICAgICAgICAgICAgaWYgKGVuZFB0ciAtIHB0ciA+IDMyICYmIFVURjE2RGVjb2RlcikgewogICAgICAgICAgICAgIHJldHVybiBVVEYxNkRlY29kZXIuZGVjb2RlKEhFQVBVOC5zdWJhcnJheShwdHIsIGVuZFB0cikpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBzdHIgPSAiIjsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgIShpID49IG1heEJ5dGVzVG9SZWFkIC8gMik7ICsraSkgewogICAgICAgICAgICAgICAgdmFyIGNvZGVVbml0ID0gSEVBUDE2W3B0ciArIGkgKiAyID4+IDFdOwogICAgICAgICAgICAgICAgaWYgKGNvZGVVbml0ID09IDApCiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgc3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoY29kZVVuaXQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gc3RyOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzdHJpbmdUb1VURjE2KHN0ciwgb3V0UHRyLCBtYXhCeXRlc1RvV3JpdGUpIHsKICAgICAgICAgICAgaWYgKG1heEJ5dGVzVG9Xcml0ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgbWF4Qnl0ZXNUb1dyaXRlID0gMjE0NzQ4MzY0NzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobWF4Qnl0ZXNUb1dyaXRlIDwgMikKICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgbWF4Qnl0ZXNUb1dyaXRlIC09IDI7CiAgICAgICAgICAgIHZhciBzdGFydFB0ciA9IG91dFB0cjsKICAgICAgICAgICAgdmFyIG51bUNoYXJzVG9Xcml0ZSA9IG1heEJ5dGVzVG9Xcml0ZSA8IHN0ci5sZW5ndGggKiAyID8gbWF4Qnl0ZXNUb1dyaXRlIC8gMiA6IHN0ci5sZW5ndGg7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbnVtQ2hhcnNUb1dyaXRlOyArK2kpIHsKICAgICAgICAgICAgICB2YXIgY29kZVVuaXQgPSBzdHIuY2hhckNvZGVBdChpKTsKICAgICAgICAgICAgICBIRUFQMTZbb3V0UHRyID4+IDFdID0gY29kZVVuaXQ7CiAgICAgICAgICAgICAgb3V0UHRyICs9IDI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgSEVBUDE2W291dFB0ciA+PiAxXSA9IDA7CiAgICAgICAgICAgIHJldHVybiBvdXRQdHIgLSBzdGFydFB0cjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGxlbmd0aEJ5dGVzVVRGMTYoc3RyKSB7CiAgICAgICAgICAgIHJldHVybiBzdHIubGVuZ3RoICogMjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFVURjMyVG9TdHJpbmcocHRyLCBtYXhCeXRlc1RvUmVhZCkgewogICAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICAgIHZhciBzdHIgPSAiIjsKICAgICAgICAgICAgd2hpbGUgKCEoaSA+PSBtYXhCeXRlc1RvUmVhZCAvIDQpKSB7CiAgICAgICAgICAgICAgdmFyIHV0ZjMyID0gSEVBUDMyW3B0ciArIGkgKiA0ID4+IDJdOwogICAgICAgICAgICAgIGlmICh1dGYzMiA9PSAwKQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgKytpOwogICAgICAgICAgICAgIGlmICh1dGYzMiA+PSA2NTUzNikgewogICAgICAgICAgICAgICAgdmFyIGNoID0gdXRmMzIgLSA2NTUzNjsKICAgICAgICAgICAgICAgIHN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDU1Mjk2IHwgY2ggPj4gMTAsIDU2MzIwIHwgY2ggJiAxMDIzKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUodXRmMzIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc3RyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gc3RyaW5nVG9VVEYzMihzdHIsIG91dFB0ciwgbWF4Qnl0ZXNUb1dyaXRlKSB7CiAgICAgICAgICAgIGlmIChtYXhCeXRlc1RvV3JpdGUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIG1heEJ5dGVzVG9Xcml0ZSA9IDIxNDc0ODM2NDc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG1heEJ5dGVzVG9Xcml0ZSA8IDQpCiAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIHZhciBzdGFydFB0ciA9IG91dFB0cjsKICAgICAgICAgICAgdmFyIGVuZFB0ciA9IHN0YXJ0UHRyICsgbWF4Qnl0ZXNUb1dyaXRlIC0gNDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICB2YXIgY29kZVVuaXQgPSBzdHIuY2hhckNvZGVBdChpKTsKICAgICAgICAgICAgICBpZiAoY29kZVVuaXQgPj0gNTUyOTYgJiYgY29kZVVuaXQgPD0gNTczNDMpIHsKICAgICAgICAgICAgICAgIHZhciB0cmFpbFN1cnJvZ2F0ZSA9IHN0ci5jaGFyQ29kZUF0KCsraSk7CiAgICAgICAgICAgICAgICBjb2RlVW5pdCA9IDY1NTM2ICsgKChjb2RlVW5pdCAmIDEwMjMpIDw8IDEwKSB8IHRyYWlsU3Vycm9nYXRlICYgMTAyMzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgSEVBUDMyW291dFB0ciA+PiAyXSA9IGNvZGVVbml0OwogICAgICAgICAgICAgIG91dFB0ciArPSA0OwogICAgICAgICAgICAgIGlmIChvdXRQdHIgKyA0ID4gZW5kUHRyKQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgSEVBUDMyW291dFB0ciA+PiAyXSA9IDA7CiAgICAgICAgICAgIHJldHVybiBvdXRQdHIgLSBzdGFydFB0cjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGxlbmd0aEJ5dGVzVVRGMzIoc3RyKSB7CiAgICAgICAgICAgIHZhciBsZW4gPSAwOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgIHZhciBjb2RlVW5pdCA9IHN0ci5jaGFyQ29kZUF0KGkpOwogICAgICAgICAgICAgIGlmIChjb2RlVW5pdCA+PSA1NTI5NiAmJiBjb2RlVW5pdCA8PSA1NzM0MykKICAgICAgICAgICAgICAgICsraTsKICAgICAgICAgICAgICBsZW4gKz0gNDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbGVuOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gYWxpZ25VcCh4LCBtdWx0aXBsZSkgewogICAgICAgICAgICBpZiAoeCAlIG11bHRpcGxlID4gMCkgewogICAgICAgICAgICAgIHggKz0gbXVsdGlwbGUgLSB4ICUgbXVsdGlwbGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHg7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgYnVmZmVyLCBIRUFQOCwgSEVBUFU4LCBIRUFQMTYsIEhFQVBVMTYsIEhFQVAzMiwgSEVBUFUzMiwgSEVBUEYzMiwgSEVBUEY2NDsKICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUdsb2JhbEJ1ZmZlckFuZFZpZXdzKGJ1ZikgewogICAgICAgICAgICBidWZmZXIgPSBidWY7CiAgICAgICAgICAgIE1vZHVsZVsiSEVBUDgiXSA9IEhFQVA4ID0gbmV3IEludDhBcnJheShidWYpOwogICAgICAgICAgICBNb2R1bGVbIkhFQVAxNiJdID0gSEVBUDE2ID0gbmV3IEludDE2QXJyYXkoYnVmKTsKICAgICAgICAgICAgTW9kdWxlWyJIRUFQMzIiXSA9IEhFQVAzMiA9IG5ldyBJbnQzMkFycmF5KGJ1Zik7CiAgICAgICAgICAgIE1vZHVsZVsiSEVBUFU4Il0gPSBIRUFQVTggPSBuZXcgVWludDhBcnJheShidWYpOwogICAgICAgICAgICBNb2R1bGVbIkhFQVBVMTYiXSA9IEhFQVBVMTYgPSBuZXcgVWludDE2QXJyYXkoYnVmKTsKICAgICAgICAgICAgTW9kdWxlWyJIRUFQVTMyIl0gPSBIRUFQVTMyID0gbmV3IFVpbnQzMkFycmF5KGJ1Zik7CiAgICAgICAgICAgIE1vZHVsZVsiSEVBUEYzMiJdID0gSEVBUEYzMiA9IG5ldyBGbG9hdDMyQXJyYXkoYnVmKTsKICAgICAgICAgICAgTW9kdWxlWyJIRUFQRjY0Il0gPSBIRUFQRjY0ID0gbmV3IEZsb2F0NjRBcnJheShidWYpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIElOSVRJQUxfTUVNT1JZID0gTW9kdWxlWyJJTklUSUFMX01FTU9SWSJdIHx8IDE2Nzc3MjE2OwogICAgICAgICAgdmFyIHdhc21UYWJsZTsKICAgICAgICAgIHZhciBfX0FUUFJFUlVOX18gPSBbXTsKICAgICAgICAgIHZhciBfX0FUSU5JVF9fID0gW107CiAgICAgICAgICB2YXIgX19BVE1BSU5fXyA9IFtdOwogICAgICAgICAgdmFyIF9fQVRQT1NUUlVOX18gPSBbXTsKICAgICAgICAgIHZhciBydW50aW1lSW5pdGlhbGl6ZWQgPSBmYWxzZTsKICAgICAgICAgIGZ1bmN0aW9uIHByZVJ1bigpIHsKICAgICAgICAgICAgaWYgKE1vZHVsZVsicHJlUnVuIl0pIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIE1vZHVsZVsicHJlUnVuIl0gPT0gImZ1bmN0aW9uIikKICAgICAgICAgICAgICAgIE1vZHVsZVsicHJlUnVuIl0gPSBbTW9kdWxlWyJwcmVSdW4iXV07CiAgICAgICAgICAgICAgd2hpbGUgKE1vZHVsZVsicHJlUnVuIl0ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBhZGRPblByZVJ1bihNb2R1bGVbInByZVJ1biJdLnNoaWZ0KCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjYWxsUnVudGltZUNhbGxiYWNrcyhfX0FUUFJFUlVOX18pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaW5pdFJ1bnRpbWUoKSB7CiAgICAgICAgICAgIHJ1bnRpbWVJbml0aWFsaXplZCA9IHRydWU7CiAgICAgICAgICAgIGNhbGxSdW50aW1lQ2FsbGJhY2tzKF9fQVRJTklUX18pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcHJlTWFpbigpIHsKICAgICAgICAgICAgY2FsbFJ1bnRpbWVDYWxsYmFja3MoX19BVE1BSU5fXyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwb3N0UnVuKCkgewogICAgICAgICAgICBpZiAoTW9kdWxlWyJwb3N0UnVuIl0pIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIE1vZHVsZVsicG9zdFJ1biJdID09ICJmdW5jdGlvbiIpCiAgICAgICAgICAgICAgICBNb2R1bGVbInBvc3RSdW4iXSA9IFtNb2R1bGVbInBvc3RSdW4iXV07CiAgICAgICAgICAgICAgd2hpbGUgKE1vZHVsZVsicG9zdFJ1biJdLmxlbmd0aCkgewogICAgICAgICAgICAgICAgYWRkT25Qb3N0UnVuKE1vZHVsZVsicG9zdFJ1biJdLnNoaWZ0KCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjYWxsUnVudGltZUNhbGxiYWNrcyhfX0FUUE9TVFJVTl9fKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGFkZE9uUHJlUnVuKGNiKSB7CiAgICAgICAgICAgIF9fQVRQUkVSVU5fXy51bnNoaWZ0KGNiKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGFkZE9uSW5pdChjYikgewogICAgICAgICAgICBfX0FUSU5JVF9fLnVuc2hpZnQoY2IpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gYWRkT25Qb3N0UnVuKGNiKSB7CiAgICAgICAgICAgIF9fQVRQT1NUUlVOX18udW5zaGlmdChjYik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcnVuRGVwZW5kZW5jaWVzID0gMDsKICAgICAgICAgIHZhciBydW5EZXBlbmRlbmN5V2F0Y2hlciA9IG51bGw7CiAgICAgICAgICB2YXIgZGVwZW5kZW5jaWVzRnVsZmlsbGVkID0gbnVsbDsKICAgICAgICAgIGZ1bmN0aW9uIGFkZFJ1bkRlcGVuZGVuY3koaWQpIHsKICAgICAgICAgICAgcnVuRGVwZW5kZW5jaWVzKys7CiAgICAgICAgICAgIGlmIChNb2R1bGVbIm1vbml0b3JSdW5EZXBlbmRlbmNpZXMiXSkgewogICAgICAgICAgICAgIE1vZHVsZVsibW9uaXRvclJ1bkRlcGVuZGVuY2llcyJdKHJ1bkRlcGVuZGVuY2llcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlbW92ZVJ1bkRlcGVuZGVuY3koaWQpIHsKICAgICAgICAgICAgcnVuRGVwZW5kZW5jaWVzLS07CiAgICAgICAgICAgIGlmIChNb2R1bGVbIm1vbml0b3JSdW5EZXBlbmRlbmNpZXMiXSkgewogICAgICAgICAgICAgIE1vZHVsZVsibW9uaXRvclJ1bkRlcGVuZGVuY2llcyJdKHJ1bkRlcGVuZGVuY2llcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJ1bkRlcGVuZGVuY2llcyA9PSAwKSB7CiAgICAgICAgICAgICAgaWYgKHJ1bkRlcGVuZGVuY3lXYXRjaGVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKHJ1bkRlcGVuZGVuY3lXYXRjaGVyKTsKICAgICAgICAgICAgICAgIHJ1bkRlcGVuZGVuY3lXYXRjaGVyID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGRlcGVuZGVuY2llc0Z1bGZpbGxlZCkgewogICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gZGVwZW5kZW5jaWVzRnVsZmlsbGVkOwogICAgICAgICAgICAgICAgZGVwZW5kZW5jaWVzRnVsZmlsbGVkID0gbnVsbDsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBNb2R1bGVbInByZWxvYWRlZEltYWdlcyJdID0ge307CiAgICAgICAgICBNb2R1bGVbInByZWxvYWRlZEF1ZGlvcyJdID0ge307CiAgICAgICAgICBmdW5jdGlvbiBhYm9ydCh3aGF0KSB7CiAgICAgICAgICAgIGlmIChNb2R1bGVbIm9uQWJvcnQiXSkgewogICAgICAgICAgICAgIE1vZHVsZVsib25BYm9ydCJdKHdoYXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoYXQgKz0gIiI7CiAgICAgICAgICAgIGVycih3aGF0KTsKICAgICAgICAgICAgQUJPUlQgPSB0cnVlOwogICAgICAgICAgICBFWElUU1RBVFVTID0gMTsKICAgICAgICAgICAgd2hhdCA9ICJhYm9ydCgiICsgd2hhdCArICIpLiBCdWlsZCB3aXRoIC1zIEFTU0VSVElPTlM9MSBmb3IgbW9yZSBpbmZvLiI7CiAgICAgICAgICAgIHZhciBlID0gbmV3IFdlYkFzc2VtYmx5LlJ1bnRpbWVFcnJvcih3aGF0KTsKICAgICAgICAgICAgcmVhZHlQcm9taXNlUmVqZWN0KGUpOwogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaGFzUHJlZml4KHN0ciwgcHJlZml4KSB7CiAgICAgICAgICAgIHJldHVybiBTdHJpbmcucHJvdG90eXBlLnN0YXJ0c1dpdGggPyBzdHIuc3RhcnRzV2l0aChwcmVmaXgpIDogc3RyLmluZGV4T2YocHJlZml4KSA9PT0gMDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkYXRhVVJJUHJlZml4ID0gImRhdGE6YXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtO2Jhc2U2NCwiOwogICAgICAgICAgZnVuY3Rpb24gaXNEYXRhVVJJKGZpbGVuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBoYXNQcmVmaXgoZmlsZW5hbWUsIGRhdGFVUklQcmVmaXgpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpbGVVUklQcmVmaXggPSAiZmlsZTovLyI7CiAgICAgICAgICBmdW5jdGlvbiBpc0ZpbGVVUkkoZmlsZW5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIGhhc1ByZWZpeChmaWxlbmFtZSwgZmlsZVVSSVByZWZpeCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgd2FzbUJpbmFyeUZpbGUgPSAiYmFzaXNfdHJhbnNjb2Rlci53YXNtIjsKICAgICAgICAgIGlmICghaXNEYXRhVVJJKHdhc21CaW5hcnlGaWxlKSkgewogICAgICAgICAgICB3YXNtQmluYXJ5RmlsZSA9IGxvY2F0ZUZpbGUod2FzbUJpbmFyeUZpbGUpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0QmluYXJ5KGZpbGUpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpZiAoZmlsZSA9PSB3YXNtQmluYXJ5RmlsZSAmJiB3YXNtQmluYXJ5KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkod2FzbUJpbmFyeSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChyZWFkQmluYXJ5KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVhZEJpbmFyeShmaWxlKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgImJvdGggYXN5bmMgYW5kIHN5bmMgZmV0Y2hpbmcgb2YgdGhlIHdhc20gZmFpbGVkIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycjIpIHsKICAgICAgICAgICAgICBhYm9ydChlcnIyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0QmluYXJ5UHJvbWlzZSgpIHsKICAgICAgICAgICAgaWYgKCF3YXNtQmluYXJ5ICYmIChFTlZJUk9OTUVOVF9JU19XRUIgfHwgRU5WSVJPTk1FTlRfSVNfV09SS0VSKSkgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgZmV0Y2ggPT09ICJmdW5jdGlvbiIgJiYgIWlzRmlsZVVSSSh3YXNtQmluYXJ5RmlsZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmZXRjaCh3YXNtQmluYXJ5RmlsZSwgeyBjcmVkZW50aWFsczogInNhbWUtb3JpZ2luIiB9KS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgIGlmICghcmVzcG9uc2VbIm9rIl0pIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyAiZmFpbGVkIHRvIGxvYWQgd2FzbSBiaW5hcnkgZmlsZSBhdCAnIiArIHdhc21CaW5hcnlGaWxlICsgIiciOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZVsiYXJyYXlCdWZmZXIiXSgpOwogICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRCaW5hcnkod2FzbUJpbmFyeUZpbGUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChyZWFkQXN5bmMpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICAgICAgICAgIHJlYWRBc3luYyh3YXNtQmluYXJ5RmlsZSwgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUobmV3IFVpbnQ4QXJyYXkocmVzcG9uc2UpKTsKICAgICAgICAgICAgICAgICAgICB9LCByZWplY3QpOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldEJpbmFyeSh3YXNtQmluYXJ5RmlsZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY3JlYXRlV2FzbSgpIHsKICAgICAgICAgICAgdmFyIGluZm8gPSB7ICJhIjogYXNtTGlicmFyeUFyZyB9OwogICAgICAgICAgICBmdW5jdGlvbiByZWNlaXZlSW5zdGFuY2UoaW5zdGFuY2UsIG1vZHVsZTIpIHsKICAgICAgICAgICAgICB2YXIgZXhwb3J0czQgPSBpbnN0YW5jZS5leHBvcnRzOwogICAgICAgICAgICAgIE1vZHVsZVsiYXNtIl0gPSBleHBvcnRzNDsKICAgICAgICAgICAgICB3YXNtTWVtb3J5ID0gTW9kdWxlWyJhc20iXVsiSyJdOwogICAgICAgICAgICAgIHVwZGF0ZUdsb2JhbEJ1ZmZlckFuZFZpZXdzKHdhc21NZW1vcnkuYnVmZmVyKTsKICAgICAgICAgICAgICB3YXNtVGFibGUgPSBNb2R1bGVbImFzbSJdWyJPIl07CiAgICAgICAgICAgICAgYWRkT25Jbml0KE1vZHVsZVsiYXNtIl1bIkwiXSk7CiAgICAgICAgICAgICAgcmVtb3ZlUnVuRGVwZW5kZW5jeSgid2FzbS1pbnN0YW50aWF0ZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFkZFJ1bkRlcGVuZGVuY3koIndhc20taW5zdGFudGlhdGUiKTsKICAgICAgICAgICAgZnVuY3Rpb24gcmVjZWl2ZUluc3RhbnRpYXRlZFNvdXJjZShvdXRwdXQpIHsKICAgICAgICAgICAgICByZWNlaXZlSW5zdGFuY2Uob3V0cHV0WyJpbnN0YW5jZSJdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBpbnN0YW50aWF0ZUFycmF5QnVmZmVyKHJlY2VpdmVyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldEJpbmFyeVByb21pc2UoKS50aGVuKGZ1bmN0aW9uKGJpbmFyeSkgewogICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFdlYkFzc2VtYmx5Lmluc3RhbnRpYXRlKGJpbmFyeSwgaW5mbyk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgIH0pLnRoZW4ocmVjZWl2ZXIsIGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgICAgICAgICAgZXJyKCJmYWlsZWQgdG8gYXN5bmNocm9ub3VzbHkgcHJlcGFyZSB3YXNtOiAiICsgcmVhc29uKTsKICAgICAgICAgICAgICAgIGFib3J0KHJlYXNvbik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gaW5zdGFudGlhdGVBc3luYygpIHsKICAgICAgICAgICAgICBpZiAoIXdhc21CaW5hcnkgJiYgdHlwZW9mIFdlYkFzc2VtYmx5Lmluc3RhbnRpYXRlU3RyZWFtaW5nID09PSAiZnVuY3Rpb24iICYmICFpc0RhdGFVUkkod2FzbUJpbmFyeUZpbGUpICYmICFpc0ZpbGVVUkkod2FzbUJpbmFyeUZpbGUpICYmIHR5cGVvZiBmZXRjaCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgcmV0dXJuIGZldGNoKHdhc21CaW5hcnlGaWxlLCB7IGNyZWRlbnRpYWxzOiAic2FtZS1vcmlnaW4iIH0pLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFdlYkFzc2VtYmx5Lmluc3RhbnRpYXRlU3RyZWFtaW5nKHJlc3BvbnNlLCBpbmZvKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC50aGVuKHJlY2VpdmVJbnN0YW50aWF0ZWRTb3VyY2UsIGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgICAgICAgICAgICAgIGVycigid2FzbSBzdHJlYW1pbmcgY29tcGlsZSBmYWlsZWQ6ICIgKyByZWFzb24pOwogICAgICAgICAgICAgICAgICAgIGVycigiZmFsbGluZyBiYWNrIHRvIEFycmF5QnVmZmVyIGluc3RhbnRpYXRpb24iKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW5zdGFudGlhdGVBcnJheUJ1ZmZlcihyZWNlaXZlSW5zdGFudGlhdGVkU291cmNlKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGluc3RhbnRpYXRlQXJyYXlCdWZmZXIocmVjZWl2ZUluc3RhbnRpYXRlZFNvdXJjZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChNb2R1bGVbImluc3RhbnRpYXRlV2FzbSJdKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHZhciBleHBvcnRzMyA9IE1vZHVsZVsiaW5zdGFudGlhdGVXYXNtIl0oaW5mbywgcmVjZWl2ZUluc3RhbmNlKTsKICAgICAgICAgICAgICAgIHJldHVybiBleHBvcnRzMzsKICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBlcnIoIk1vZHVsZS5pbnN0YW50aWF0ZVdhc20gY2FsbGJhY2sgZmFpbGVkIHdpdGggZXJyb3I6ICIgKyBlKTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5zdGFudGlhdGVBc3luYygpLmNhdGNoKHJlYWR5UHJvbWlzZVJlamVjdCk7CiAgICAgICAgICAgIHJldHVybiB7fTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNhbGxSdW50aW1lQ2FsbGJhY2tzKGNhbGxiYWNrcykgewogICAgICAgICAgICB3aGlsZSAoY2FsbGJhY2tzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBjYWxsYmFja3Muc2hpZnQoKTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKE1vZHVsZSk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGZ1bmMgPSBjYWxsYmFjay5mdW5jOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgZnVuYyA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjay5hcmcgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICB3YXNtVGFibGUuZ2V0KGZ1bmMpKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB3YXNtVGFibGUuZ2V0KGZ1bmMpKGNhbGxiYWNrLmFyZyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZ1bmMoY2FsbGJhY2suYXJnID09PSB2b2lkIDAgPyBudWxsIDogY2FsbGJhY2suYXJnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdHJ1Y3RSZWdpc3RyYXRpb25zID0ge307CiAgICAgICAgICBmdW5jdGlvbiBydW5EZXN0cnVjdG9ycyhkZXN0cnVjdG9ycykgewogICAgICAgICAgICB3aGlsZSAoZGVzdHJ1Y3RvcnMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgdmFyIHB0ciA9IGRlc3RydWN0b3JzLnBvcCgpOwogICAgICAgICAgICAgIHZhciBkZWwgPSBkZXN0cnVjdG9ycy5wb3AoKTsKICAgICAgICAgICAgICBkZWwocHRyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gc2ltcGxlUmVhZFZhbHVlRnJvbVBvaW50ZXIocG9pbnRlcikgewogICAgICAgICAgICByZXR1cm4gdGhpc1siZnJvbVdpcmVUeXBlIl0oSEVBUFUzMltwb2ludGVyID4+IDJdKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBhd2FpdGluZ0RlcGVuZGVuY2llcyA9IHt9OwogICAgICAgICAgdmFyIHJlZ2lzdGVyZWRUeXBlcyA9IHt9OwogICAgICAgICAgdmFyIHR5cGVEZXBlbmRlbmNpZXMgPSB7fTsKICAgICAgICAgIHZhciBjaGFyXzAgPSA0ODsKICAgICAgICAgIHZhciBjaGFyXzkgPSA1NzsKICAgICAgICAgIGZ1bmN0aW9uIG1ha2VMZWdhbEZ1bmN0aW9uTmFtZShuYW1lKSB7CiAgICAgICAgICAgIGlmICh2b2lkIDAgPT09IG5hbWUpIHsKICAgICAgICAgICAgICByZXR1cm4gIl91bmtub3duIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBuYW1lID0gbmFtZS5yZXBsYWNlKC9bXmEtekEtWjAtOV9dL2csICIkIik7CiAgICAgICAgICAgIHZhciBmID0gbmFtZS5jaGFyQ29kZUF0KDApOwogICAgICAgICAgICBpZiAoZiA+PSBjaGFyXzAgJiYgZiA8PSBjaGFyXzkpIHsKICAgICAgICAgICAgICByZXR1cm4gIl8iICsgbmFtZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gbmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY3JlYXRlTmFtZWRGdW5jdGlvbihuYW1lLCBib2R5KSB7CiAgICAgICAgICAgIG5hbWUgPSBtYWtlTGVnYWxGdW5jdGlvbk5hbWUobmFtZSk7CiAgICAgICAgICAgIHJldHVybiBuZXcgRnVuY3Rpb24oImJvZHkiLCAicmV0dXJuIGZ1bmN0aW9uICIgKyBuYW1lICsgJygpIHtcbiAgICAidXNlIHN0cmljdCI7ICAgIHJldHVybiBib2R5LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG59O1xuJykoYm9keSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBleHRlbmRFcnJvcihiYXNlRXJyb3JUeXBlLCBlcnJvck5hbWUpIHsKICAgICAgICAgICAgdmFyIGVycm9yQ2xhc3MgPSBjcmVhdGVOYW1lZEZ1bmN0aW9uKGVycm9yTmFtZSwgZnVuY3Rpb24obWVzc2FnZSkgewogICAgICAgICAgICAgIHRoaXMubmFtZSA9IGVycm9yTmFtZTsKICAgICAgICAgICAgICB0aGlzLm1lc3NhZ2UgPSBtZXNzYWdlOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IG5ldyBFcnJvcihtZXNzYWdlKS5zdGFjazsKICAgICAgICAgICAgICBpZiAoc3RhY2sgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGFjayA9IHRoaXMudG9TdHJpbmcoKSArICJcbiIgKyBzdGFjay5yZXBsYWNlKC9eRXJyb3IoOlteXG5dKik/XG4vLCAiIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZXJyb3JDbGFzcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKGJhc2VFcnJvclR5cGUucHJvdG90eXBlKTsKICAgICAgICAgICAgZXJyb3JDbGFzcy5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBlcnJvckNsYXNzOwogICAgICAgICAgICBlcnJvckNsYXNzLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmICh0aGlzLm1lc3NhZ2UgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubmFtZTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubmFtZSArICI6ICIgKyB0aGlzLm1lc3NhZ2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gZXJyb3JDbGFzczsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBJbnRlcm5hbEVycm9yID0gdm9pZCAwOwogICAgICAgICAgZnVuY3Rpb24gdGhyb3dJbnRlcm5hbEVycm9yKG1lc3NhZ2UpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEludGVybmFsRXJyb3IobWVzc2FnZSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB3aGVuRGVwZW5kZW50VHlwZXNBcmVSZXNvbHZlZChteVR5cGVzLCBkZXBlbmRlbnRUeXBlcywgZ2V0VHlwZUNvbnZlcnRlcnMpIHsKICAgICAgICAgICAgbXlUeXBlcy5mb3JFYWNoKGZ1bmN0aW9uKHR5cGUpIHsKICAgICAgICAgICAgICB0eXBlRGVwZW5kZW5jaWVzW3R5cGVdID0gZGVwZW5kZW50VHlwZXM7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBmdW5jdGlvbiBvbkNvbXBsZXRlKHR5cGVDb252ZXJ0ZXJzMikgewogICAgICAgICAgICAgIHZhciBteVR5cGVDb252ZXJ0ZXJzID0gZ2V0VHlwZUNvbnZlcnRlcnModHlwZUNvbnZlcnRlcnMyKTsKICAgICAgICAgICAgICBpZiAobXlUeXBlQ29udmVydGVycy5sZW5ndGggIT09IG15VHlwZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB0aHJvd0ludGVybmFsRXJyb3IoIk1pc21hdGNoZWQgdHlwZSBjb252ZXJ0ZXIgY291bnQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBteVR5cGVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICByZWdpc3RlclR5cGUobXlUeXBlc1tpXSwgbXlUeXBlQ29udmVydGVyc1tpXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0eXBlQ29udmVydGVycyA9IG5ldyBBcnJheShkZXBlbmRlbnRUeXBlcy5sZW5ndGgpOwogICAgICAgICAgICB2YXIgdW5yZWdpc3RlcmVkVHlwZXMgPSBbXTsKICAgICAgICAgICAgdmFyIHJlZ2lzdGVyZWQgPSAwOwogICAgICAgICAgICBkZXBlbmRlbnRUeXBlcy5mb3JFYWNoKGZ1bmN0aW9uKGR0LCBpKSB7CiAgICAgICAgICAgICAgaWYgKHJlZ2lzdGVyZWRUeXBlcy5oYXNPd25Qcm9wZXJ0eShkdCkpIHsKICAgICAgICAgICAgICAgIHR5cGVDb252ZXJ0ZXJzW2ldID0gcmVnaXN0ZXJlZFR5cGVzW2R0XTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdW5yZWdpc3RlcmVkVHlwZXMucHVzaChkdCk7CiAgICAgICAgICAgICAgICBpZiAoIWF3YWl0aW5nRGVwZW5kZW5jaWVzLmhhc093blByb3BlcnR5KGR0KSkgewogICAgICAgICAgICAgICAgICBhd2FpdGluZ0RlcGVuZGVuY2llc1tkdF0gPSBbXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGF3YWl0aW5nRGVwZW5kZW5jaWVzW2R0XS5wdXNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB0eXBlQ29udmVydGVyc1tpXSA9IHJlZ2lzdGVyZWRUeXBlc1tkdF07CiAgICAgICAgICAgICAgICAgICsrcmVnaXN0ZXJlZDsKICAgICAgICAgICAgICAgICAgaWYgKHJlZ2lzdGVyZWQgPT09IHVucmVnaXN0ZXJlZFR5cGVzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIG9uQ29tcGxldGUodHlwZUNvbnZlcnRlcnMpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoMCA9PT0gdW5yZWdpc3RlcmVkVHlwZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgb25Db21wbGV0ZSh0eXBlQ29udmVydGVycyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW1iaW5kX2ZpbmFsaXplX3ZhbHVlX29iamVjdChzdHJ1Y3RUeXBlKSB7CiAgICAgICAgICAgIHZhciByZWcgPSBzdHJ1Y3RSZWdpc3RyYXRpb25zW3N0cnVjdFR5cGVdOwogICAgICAgICAgICBkZWxldGUgc3RydWN0UmVnaXN0cmF0aW9uc1tzdHJ1Y3RUeXBlXTsKICAgICAgICAgICAgdmFyIHJhd0NvbnN0cnVjdG9yID0gcmVnLnJhd0NvbnN0cnVjdG9yOwogICAgICAgICAgICB2YXIgcmF3RGVzdHJ1Y3RvciA9IHJlZy5yYXdEZXN0cnVjdG9yOwogICAgICAgICAgICB2YXIgZmllbGRSZWNvcmRzID0gcmVnLmZpZWxkczsKICAgICAgICAgICAgdmFyIGZpZWxkVHlwZXMgPSBmaWVsZFJlY29yZHMubWFwKGZ1bmN0aW9uKGZpZWxkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZpZWxkLmdldHRlclJldHVyblR5cGU7CiAgICAgICAgICAgIH0pLmNvbmNhdChmaWVsZFJlY29yZHMubWFwKGZ1bmN0aW9uKGZpZWxkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZpZWxkLnNldHRlckFyZ3VtZW50VHlwZTsKICAgICAgICAgICAgfSkpOwogICAgICAgICAgICB3aGVuRGVwZW5kZW50VHlwZXNBcmVSZXNvbHZlZChbc3RydWN0VHlwZV0sIGZpZWxkVHlwZXMsIGZ1bmN0aW9uKGZpZWxkVHlwZXMyKSB7CiAgICAgICAgICAgICAgdmFyIGZpZWxkcyA9IHt9OwogICAgICAgICAgICAgIGZpZWxkUmVjb3Jkcy5mb3JFYWNoKGZ1bmN0aW9uKGZpZWxkLCBpKSB7CiAgICAgICAgICAgICAgICB2YXIgZmllbGROYW1lID0gZmllbGQuZmllbGROYW1lOwogICAgICAgICAgICAgICAgdmFyIGdldHRlclJldHVyblR5cGUgPSBmaWVsZFR5cGVzMltpXTsKICAgICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBmaWVsZC5nZXR0ZXI7CiAgICAgICAgICAgICAgICB2YXIgZ2V0dGVyQ29udGV4dCA9IGZpZWxkLmdldHRlckNvbnRleHQ7CiAgICAgICAgICAgICAgICB2YXIgc2V0dGVyQXJndW1lbnRUeXBlID0gZmllbGRUeXBlczJbaSArIGZpZWxkUmVjb3Jkcy5sZW5ndGhdOwogICAgICAgICAgICAgICAgdmFyIHNldHRlciA9IGZpZWxkLnNldHRlcjsKICAgICAgICAgICAgICAgIHZhciBzZXR0ZXJDb250ZXh0ID0gZmllbGQuc2V0dGVyQ29udGV4dDsKICAgICAgICAgICAgICAgIGZpZWxkc1tmaWVsZE5hbWVdID0geyByZWFkOiBmdW5jdGlvbihwdHIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldHRlclJldHVyblR5cGVbImZyb21XaXJlVHlwZSJdKGdldHRlcihnZXR0ZXJDb250ZXh0LCBwdHIpKTsKICAgICAgICAgICAgICAgIH0sIHdyaXRlOiBmdW5jdGlvbihwdHIsIG8pIHsKICAgICAgICAgICAgICAgICAgdmFyIGRlc3RydWN0b3JzID0gW107CiAgICAgICAgICAgICAgICAgIHNldHRlcihzZXR0ZXJDb250ZXh0LCBwdHIsIHNldHRlckFyZ3VtZW50VHlwZVsidG9XaXJlVHlwZSJdKGRlc3RydWN0b3JzLCBvKSk7CiAgICAgICAgICAgICAgICAgIHJ1bkRlc3RydWN0b3JzKGRlc3RydWN0b3JzKTsKICAgICAgICAgICAgICAgIH0gfTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZXR1cm4gW3sgbmFtZTogcmVnLm5hbWUsICJmcm9tV2lyZVR5cGUiOiBmdW5jdGlvbihwdHIpIHsKICAgICAgICAgICAgICAgIHZhciBydiA9IHt9OwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSBpbiBmaWVsZHMpIHsKICAgICAgICAgICAgICAgICAgcnZbaV0gPSBmaWVsZHNbaV0ucmVhZChwdHIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmF3RGVzdHJ1Y3RvcihwdHIpOwogICAgICAgICAgICAgICAgcmV0dXJuIHJ2OwogICAgICAgICAgICAgIH0sICJ0b1dpcmVUeXBlIjogZnVuY3Rpb24oZGVzdHJ1Y3RvcnMsIG8pIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGZpZWxkTmFtZSBpbiBmaWVsZHMpIHsKICAgICAgICAgICAgICAgICAgaWYgKCEoZmllbGROYW1lIGluIG8pKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignTWlzc2luZyBmaWVsZDogICInICsgZmllbGROYW1lICsgJyInKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHB0ciA9IHJhd0NvbnN0cnVjdG9yKCk7CiAgICAgICAgICAgICAgICBmb3IgKGZpZWxkTmFtZSBpbiBmaWVsZHMpIHsKICAgICAgICAgICAgICAgICAgZmllbGRzW2ZpZWxkTmFtZV0ud3JpdGUocHRyLCBvW2ZpZWxkTmFtZV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGRlc3RydWN0b3JzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGRlc3RydWN0b3JzLnB1c2gocmF3RGVzdHJ1Y3RvciwgcHRyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBwdHI7CiAgICAgICAgICAgICAgfSwgImFyZ1BhY2tBZHZhbmNlIjogOCwgInJlYWRWYWx1ZUZyb21Qb2ludGVyIjogc2ltcGxlUmVhZFZhbHVlRnJvbVBvaW50ZXIsIGRlc3RydWN0b3JGdW5jdGlvbjogcmF3RGVzdHJ1Y3RvciB9XTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRTaGlmdEZyb21TaXplKHNpemUpIHsKICAgICAgICAgICAgc3dpdGNoIChzaXplKSB7CiAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgcmV0dXJuIDI7CiAgICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgICAgcmV0dXJuIDM7CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlVua25vd24gdHlwZSBzaXplOiAiICsgc2l6ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGVtYmluZF9pbml0X2NoYXJDb2RlcygpIHsKICAgICAgICAgICAgdmFyIGNvZGVzID0gbmV3IEFycmF5KDI1Nik7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgMjU2OyArK2kpIHsKICAgICAgICAgICAgICBjb2Rlc1tpXSA9IFN0cmluZy5mcm9tQ2hhckNvZGUoaSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZW1iaW5kX2NoYXJDb2RlcyA9IGNvZGVzOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGVtYmluZF9jaGFyQ29kZXMgPSB2b2lkIDA7CiAgICAgICAgICBmdW5jdGlvbiByZWFkTGF0aW4xU3RyaW5nKHB0cikgewogICAgICAgICAgICB2YXIgcmV0ID0gIiI7CiAgICAgICAgICAgIHZhciBjID0gcHRyOwogICAgICAgICAgICB3aGlsZSAoSEVBUFU4W2NdKSB7CiAgICAgICAgICAgICAgcmV0ICs9IGVtYmluZF9jaGFyQ29kZXNbSEVBUFU4W2MrK11dOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgQmluZGluZ0Vycm9yID0gdm9pZCAwOwogICAgICAgICAgZnVuY3Rpb24gdGhyb3dCaW5kaW5nRXJyb3IobWVzc2FnZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgQmluZGluZ0Vycm9yKG1lc3NhZ2UpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJUeXBlKHJhd1R5cGUsIHJlZ2lzdGVyZWRJbnN0YW5jZSwgb3B0aW9ucykgewogICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgICAgaWYgKCEoImFyZ1BhY2tBZHZhbmNlIiBpbiByZWdpc3RlcmVkSW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigicmVnaXN0ZXJUeXBlIHJlZ2lzdGVyZWRJbnN0YW5jZSByZXF1aXJlcyBhcmdQYWNrQWR2YW5jZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuYW1lID0gcmVnaXN0ZXJlZEluc3RhbmNlLm5hbWU7CiAgICAgICAgICAgIGlmICghcmF3VHlwZSkgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCd0eXBlICInICsgbmFtZSArICciIG11c3QgaGF2ZSBhIHBvc2l0aXZlIGludGVnZXIgdHlwZWlkIHBvaW50ZXInKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmVnaXN0ZXJlZFR5cGVzLmhhc093blByb3BlcnR5KHJhd1R5cGUpKSB7CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuaWdub3JlRHVwbGljYXRlUmVnaXN0cmF0aW9ucykgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiQ2Fubm90IHJlZ2lzdGVyIHR5cGUgJyIgKyBuYW1lICsgIicgdHdpY2UiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVnaXN0ZXJlZFR5cGVzW3Jhd1R5cGVdID0gcmVnaXN0ZXJlZEluc3RhbmNlOwogICAgICAgICAgICBkZWxldGUgdHlwZURlcGVuZGVuY2llc1tyYXdUeXBlXTsKICAgICAgICAgICAgaWYgKGF3YWl0aW5nRGVwZW5kZW5jaWVzLmhhc093blByb3BlcnR5KHJhd1R5cGUpKSB7CiAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrcyA9IGF3YWl0aW5nRGVwZW5kZW5jaWVzW3Jhd1R5cGVdOwogICAgICAgICAgICAgIGRlbGV0ZSBhd2FpdGluZ0RlcGVuZGVuY2llc1tyYXdUeXBlXTsKICAgICAgICAgICAgICBjYWxsYmFja3MuZm9yRWFjaChmdW5jdGlvbihjYikgewogICAgICAgICAgICAgICAgY2IoKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfcmVnaXN0ZXJfYm9vbChyYXdUeXBlLCBuYW1lLCBzaXplLCB0cnVlVmFsdWUsIGZhbHNlVmFsdWUpIHsKICAgICAgICAgICAgdmFyIHNoaWZ0ID0gZ2V0U2hpZnRGcm9tU2l6ZShzaXplKTsKICAgICAgICAgICAgbmFtZSA9IHJlYWRMYXRpbjFTdHJpbmcobmFtZSk7CiAgICAgICAgICAgIHJlZ2lzdGVyVHlwZShyYXdUeXBlLCB7IG5hbWUsICJmcm9tV2lyZVR5cGUiOiBmdW5jdGlvbih3dCkgewogICAgICAgICAgICAgIHJldHVybiAhIXd0OwogICAgICAgICAgICB9LCAidG9XaXJlVHlwZSI6IGZ1bmN0aW9uKGRlc3RydWN0b3JzLCBvKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG8gPyB0cnVlVmFsdWUgOiBmYWxzZVZhbHVlOwogICAgICAgICAgICB9LCAiYXJnUGFja0FkdmFuY2UiOiA4LCAicmVhZFZhbHVlRnJvbVBvaW50ZXIiOiBmdW5jdGlvbihwb2ludGVyKSB7CiAgICAgICAgICAgICAgdmFyIGhlYXA7CiAgICAgICAgICAgICAgaWYgKHNpemUgPT09IDEpIHsKICAgICAgICAgICAgICAgIGhlYXAgPSBIRUFQODsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNpemUgPT09IDIpIHsKICAgICAgICAgICAgICAgIGhlYXAgPSBIRUFQMTY7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChzaXplID09PSA0KSB7CiAgICAgICAgICAgICAgICBoZWFwID0gSEVBUDMyOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJVbmtub3duIGJvb2xlYW4gdHlwZSBzaXplOiAiICsgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0aGlzWyJmcm9tV2lyZVR5cGUiXShoZWFwW3BvaW50ZXIgPj4gc2hpZnRdKTsKICAgICAgICAgICAgfSwgZGVzdHJ1Y3RvckZ1bmN0aW9uOiBudWxsIH0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gQ2xhc3NIYW5kbGVfaXNBbGlhc09mKG90aGVyKSB7CiAgICAgICAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBDbGFzc0hhbmRsZSkpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCEob3RoZXIgaW5zdGFuY2VvZiBDbGFzc0hhbmRsZSkpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGxlZnRDbGFzcyA9IHRoaXMuJCQucHRyVHlwZS5yZWdpc3RlcmVkQ2xhc3M7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gdGhpcy4kJC5wdHI7CiAgICAgICAgICAgIHZhciByaWdodENsYXNzID0gb3RoZXIuJCQucHRyVHlwZS5yZWdpc3RlcmVkQ2xhc3M7CiAgICAgICAgICAgIHZhciByaWdodCA9IG90aGVyLiQkLnB0cjsKICAgICAgICAgICAgd2hpbGUgKGxlZnRDbGFzcy5iYXNlQ2xhc3MpIHsKICAgICAgICAgICAgICBsZWZ0ID0gbGVmdENsYXNzLnVwY2FzdChsZWZ0KTsKICAgICAgICAgICAgICBsZWZ0Q2xhc3MgPSBsZWZ0Q2xhc3MuYmFzZUNsYXNzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChyaWdodENsYXNzLmJhc2VDbGFzcykgewogICAgICAgICAgICAgIHJpZ2h0ID0gcmlnaHRDbGFzcy51cGNhc3QocmlnaHQpOwogICAgICAgICAgICAgIHJpZ2h0Q2xhc3MgPSByaWdodENsYXNzLmJhc2VDbGFzczsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbGVmdENsYXNzID09PSByaWdodENsYXNzICYmIGxlZnQgPT09IHJpZ2h0OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gc2hhbGxvd0NvcHlJbnRlcm5hbFBvaW50ZXIobykgewogICAgICAgICAgICByZXR1cm4geyBjb3VudDogby5jb3VudCwgZGVsZXRlU2NoZWR1bGVkOiBvLmRlbGV0ZVNjaGVkdWxlZCwgcHJlc2VydmVQb2ludGVyT25EZWxldGU6IG8ucHJlc2VydmVQb2ludGVyT25EZWxldGUsIHB0cjogby5wdHIsIHB0clR5cGU6IG8ucHRyVHlwZSwgc21hcnRQdHI6IG8uc21hcnRQdHIsIHNtYXJ0UHRyVHlwZTogby5zbWFydFB0clR5cGUgfTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHRocm93SW5zdGFuY2VBbHJlYWR5RGVsZXRlZChvYmopIHsKICAgICAgICAgICAgZnVuY3Rpb24gZ2V0SW5zdGFuY2VUeXBlTmFtZShoYW5kbGUpIHsKICAgICAgICAgICAgICByZXR1cm4gaGFuZGxlLiQkLnB0clR5cGUucmVnaXN0ZXJlZENsYXNzLm5hbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoZ2V0SW5zdGFuY2VUeXBlTmFtZShvYmopICsgIiBpbnN0YW5jZSBhbHJlYWR5IGRlbGV0ZWQiKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaW5hbGl6YXRpb25Hcm91cCA9IGZhbHNlOwogICAgICAgICAgZnVuY3Rpb24gZGV0YWNoRmluYWxpemVyKGhhbmRsZSkgewogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcnVuRGVzdHJ1Y3RvcigkJCkgewogICAgICAgICAgICBpZiAoJCQuc21hcnRQdHIpIHsKICAgICAgICAgICAgICAkJC5zbWFydFB0clR5cGUucmF3RGVzdHJ1Y3RvcigkJC5zbWFydFB0cik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgJCQucHRyVHlwZS5yZWdpc3RlcmVkQ2xhc3MucmF3RGVzdHJ1Y3RvcigkJC5wdHIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWxlYXNlQ2xhc3NIYW5kbGUoJCQpIHsKICAgICAgICAgICAgJCQuY291bnQudmFsdWUgLT0gMTsKICAgICAgICAgICAgdmFyIHRvRGVsZXRlID0gMCA9PT0gJCQuY291bnQudmFsdWU7CiAgICAgICAgICAgIGlmICh0b0RlbGV0ZSkgewogICAgICAgICAgICAgIHJ1bkRlc3RydWN0b3IoJCQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBhdHRhY2hGaW5hbGl6ZXIoaGFuZGxlKSB7CiAgICAgICAgICAgIGlmICgidW5kZWZpbmVkIiA9PT0gdHlwZW9mIEZpbmFsaXphdGlvbkdyb3VwKSB7CiAgICAgICAgICAgICAgYXR0YWNoRmluYWxpemVyID0gZnVuY3Rpb24oaGFuZGxlMikgewogICAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZTI7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICByZXR1cm4gaGFuZGxlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZpbmFsaXphdGlvbkdyb3VwID0gbmV3IEZpbmFsaXphdGlvbkdyb3VwKGZ1bmN0aW9uKGl0ZXIpIHsKICAgICAgICAgICAgICBmb3IgKHZhciByZXN1bHQgPSBpdGVyLm5leHQoKTsgIXJlc3VsdC5kb25lOyByZXN1bHQgPSBpdGVyLm5leHQoKSkgewogICAgICAgICAgICAgICAgdmFyICQkID0gcmVzdWx0LnZhbHVlOwogICAgICAgICAgICAgICAgaWYgKCEkJC5wdHIpIHsKICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCJvYmplY3QgYWxyZWFkeSBkZWxldGVkOiAiICsgJCQucHRyKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJlbGVhc2VDbGFzc0hhbmRsZSgkJCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgYXR0YWNoRmluYWxpemVyID0gZnVuY3Rpb24oaGFuZGxlMikgewogICAgICAgICAgICAgIGZpbmFsaXphdGlvbkdyb3VwLnJlZ2lzdGVyKGhhbmRsZTIsIGhhbmRsZTIuJCQsIGhhbmRsZTIuJCQpOwogICAgICAgICAgICAgIHJldHVybiBoYW5kbGUyOwogICAgICAgICAgICB9OwogICAgICAgICAgICBkZXRhY2hGaW5hbGl6ZXIgPSBmdW5jdGlvbihoYW5kbGUyKSB7CiAgICAgICAgICAgICAgZmluYWxpemF0aW9uR3JvdXAudW5yZWdpc3RlcihoYW5kbGUyLiQkKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIGF0dGFjaEZpbmFsaXplcihoYW5kbGUpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gQ2xhc3NIYW5kbGVfY2xvbmUoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy4kJC5wdHIpIHsKICAgICAgICAgICAgICB0aHJvd0luc3RhbmNlQWxyZWFkeURlbGV0ZWQodGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuJCQucHJlc2VydmVQb2ludGVyT25EZWxldGUpIHsKICAgICAgICAgICAgICB0aGlzLiQkLmNvdW50LnZhbHVlICs9IDE7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGNsb25lMiA9IGF0dGFjaEZpbmFsaXplcihPYmplY3QuY3JlYXRlKE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKSwgeyAkJDogeyB2YWx1ZTogc2hhbGxvd0NvcHlJbnRlcm5hbFBvaW50ZXIodGhpcy4kJCkgfSB9KSk7CiAgICAgICAgICAgICAgY2xvbmUyLiQkLmNvdW50LnZhbHVlICs9IDE7CiAgICAgICAgICAgICAgY2xvbmUyLiQkLmRlbGV0ZVNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgICAgICAgIHJldHVybiBjbG9uZTI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIENsYXNzSGFuZGxlX2RlbGV0ZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLiQkLnB0cikgewogICAgICAgICAgICAgIHRocm93SW5zdGFuY2VBbHJlYWR5RGVsZXRlZCh0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy4kJC5kZWxldGVTY2hlZHVsZWQgJiYgIXRoaXMuJCQucHJlc2VydmVQb2ludGVyT25EZWxldGUpIHsKICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiT2JqZWN0IGFscmVhZHkgc2NoZWR1bGVkIGZvciBkZWxldGlvbiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRldGFjaEZpbmFsaXplcih0aGlzKTsKICAgICAgICAgICAgcmVsZWFzZUNsYXNzSGFuZGxlKHRoaXMuJCQpOwogICAgICAgICAgICBpZiAoIXRoaXMuJCQucHJlc2VydmVQb2ludGVyT25EZWxldGUpIHsKICAgICAgICAgICAgICB0aGlzLiQkLnNtYXJ0UHRyID0gdm9pZCAwOwogICAgICAgICAgICAgIHRoaXMuJCQucHRyID0gdm9pZCAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBDbGFzc0hhbmRsZV9pc0RlbGV0ZWQoKSB7CiAgICAgICAgICAgIHJldHVybiAhdGhpcy4kJC5wdHI7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZGVsYXlGdW5jdGlvbiA9IHZvaWQgMDsKICAgICAgICAgIHZhciBkZWxldGlvblF1ZXVlID0gW107CiAgICAgICAgICBmdW5jdGlvbiBmbHVzaFBlbmRpbmdEZWxldGVzKCkgewogICAgICAgICAgICB3aGlsZSAoZGVsZXRpb25RdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICB2YXIgb2JqID0gZGVsZXRpb25RdWV1ZS5wb3AoKTsKICAgICAgICAgICAgICBvYmouJCQuZGVsZXRlU2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgb2JqWyJkZWxldGUiXSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBDbGFzc0hhbmRsZV9kZWxldGVMYXRlcigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLiQkLnB0cikgewogICAgICAgICAgICAgIHRocm93SW5zdGFuY2VBbHJlYWR5RGVsZXRlZCh0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy4kJC5kZWxldGVTY2hlZHVsZWQgJiYgIXRoaXMuJCQucHJlc2VydmVQb2ludGVyT25EZWxldGUpIHsKICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiT2JqZWN0IGFscmVhZHkgc2NoZWR1bGVkIGZvciBkZWxldGlvbiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlbGV0aW9uUXVldWUucHVzaCh0aGlzKTsKICAgICAgICAgICAgaWYgKGRlbGV0aW9uUXVldWUubGVuZ3RoID09PSAxICYmIGRlbGF5RnVuY3Rpb24pIHsKICAgICAgICAgICAgICBkZWxheUZ1bmN0aW9uKGZsdXNoUGVuZGluZ0RlbGV0ZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuJCQuZGVsZXRlU2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpbml0X0NsYXNzSGFuZGxlKCkgewogICAgICAgICAgICBDbGFzc0hhbmRsZS5wcm90b3R5cGVbImlzQWxpYXNPZiJdID0gQ2xhc3NIYW5kbGVfaXNBbGlhc09mOwogICAgICAgICAgICBDbGFzc0hhbmRsZS5wcm90b3R5cGVbImNsb25lIl0gPSBDbGFzc0hhbmRsZV9jbG9uZTsKICAgICAgICAgICAgQ2xhc3NIYW5kbGUucHJvdG90eXBlWyJkZWxldGUiXSA9IENsYXNzSGFuZGxlX2RlbGV0ZTsKICAgICAgICAgICAgQ2xhc3NIYW5kbGUucHJvdG90eXBlWyJpc0RlbGV0ZWQiXSA9IENsYXNzSGFuZGxlX2lzRGVsZXRlZDsKICAgICAgICAgICAgQ2xhc3NIYW5kbGUucHJvdG90eXBlWyJkZWxldGVMYXRlciJdID0gQ2xhc3NIYW5kbGVfZGVsZXRlTGF0ZXI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBDbGFzc0hhbmRsZSgpIHsKICAgICAgICAgIH0KICAgICAgICAgIHZhciByZWdpc3RlcmVkUG9pbnRlcnMgPSB7fTsKICAgICAgICAgIGZ1bmN0aW9uIGVuc3VyZU92ZXJsb2FkVGFibGUocHJvdG8sIG1ldGhvZE5hbWUsIGh1bWFuTmFtZSkgewogICAgICAgICAgICBpZiAodm9pZCAwID09PSBwcm90b1ttZXRob2ROYW1lXS5vdmVybG9hZFRhYmxlKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZGdW5jID0gcHJvdG9bbWV0aG9kTmFtZV07CiAgICAgICAgICAgICAgcHJvdG9bbWV0aG9kTmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICghcHJvdG9bbWV0aG9kTmFtZV0ub3ZlcmxvYWRUYWJsZS5oYXNPd25Qcm9wZXJ0eShhcmd1bWVudHMubGVuZ3RoKSkgewogICAgICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiRnVuY3Rpb24gJyIgKyBodW1hbk5hbWUgKyAiJyBjYWxsZWQgd2l0aCBhbiBpbnZhbGlkIG51bWJlciBvZiBhcmd1bWVudHMgKCIgKyBhcmd1bWVudHMubGVuZ3RoICsgIikgLSBleHBlY3RzIG9uZSBvZiAoIiArIHByb3RvW21ldGhvZE5hbWVdLm92ZXJsb2FkVGFibGUgKyAiKSEiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBwcm90b1ttZXRob2ROYW1lXS5vdmVybG9hZFRhYmxlW2FyZ3VtZW50cy5sZW5ndGhdLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBwcm90b1ttZXRob2ROYW1lXS5vdmVybG9hZFRhYmxlID0gW107CiAgICAgICAgICAgICAgcHJvdG9bbWV0aG9kTmFtZV0ub3ZlcmxvYWRUYWJsZVtwcmV2RnVuYy5hcmdDb3VudF0gPSBwcmV2RnVuYzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZXhwb3NlUHVibGljU3ltYm9sKG5hbWUsIHZhbHVlLCBudW1Bcmd1bWVudHMpIHsKICAgICAgICAgICAgaWYgKE1vZHVsZS5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICAgIGlmICh2b2lkIDAgPT09IG51bUFyZ3VtZW50cyB8fCB2b2lkIDAgIT09IE1vZHVsZVtuYW1lXS5vdmVybG9hZFRhYmxlICYmIHZvaWQgMCAhPT0gTW9kdWxlW25hbWVdLm92ZXJsb2FkVGFibGVbbnVtQXJndW1lbnRzXSkgewogICAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIkNhbm5vdCByZWdpc3RlciBwdWJsaWMgbmFtZSAnIiArIG5hbWUgKyAiJyB0d2ljZSIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbnN1cmVPdmVybG9hZFRhYmxlKE1vZHVsZSwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgICAgaWYgKE1vZHVsZS5oYXNPd25Qcm9wZXJ0eShudW1Bcmd1bWVudHMpKSB7CiAgICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiQ2Fubm90IHJlZ2lzdGVyIG11bHRpcGxlIG92ZXJsb2FkcyBvZiBhIGZ1bmN0aW9uIHdpdGggdGhlIHNhbWUgbnVtYmVyIG9mIGFyZ3VtZW50cyAoIiArIG51bUFyZ3VtZW50cyArICIpISIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBNb2R1bGVbbmFtZV0ub3ZlcmxvYWRUYWJsZVtudW1Bcmd1bWVudHNdID0gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgTW9kdWxlW25hbWVdID0gdmFsdWU7CiAgICAgICAgICAgICAgaWYgKHZvaWQgMCAhPT0gbnVtQXJndW1lbnRzKSB7CiAgICAgICAgICAgICAgICBNb2R1bGVbbmFtZV0ubnVtQXJndW1lbnRzID0gbnVtQXJndW1lbnRzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gUmVnaXN0ZXJlZENsYXNzKG5hbWUsIGNvbnN0cnVjdG9yLCBpbnN0YW5jZVByb3RvdHlwZSwgcmF3RGVzdHJ1Y3RvciwgYmFzZUNsYXNzLCBnZXRBY3R1YWxUeXBlLCB1cGNhc3QsIGRvd25jYXN0KSB7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgICAgIHRoaXMuY29uc3RydWN0b3IgPSBjb25zdHJ1Y3RvcjsKICAgICAgICAgICAgdGhpcy5pbnN0YW5jZVByb3RvdHlwZSA9IGluc3RhbmNlUHJvdG90eXBlOwogICAgICAgICAgICB0aGlzLnJhd0Rlc3RydWN0b3IgPSByYXdEZXN0cnVjdG9yOwogICAgICAgICAgICB0aGlzLmJhc2VDbGFzcyA9IGJhc2VDbGFzczsKICAgICAgICAgICAgdGhpcy5nZXRBY3R1YWxUeXBlID0gZ2V0QWN0dWFsVHlwZTsKICAgICAgICAgICAgdGhpcy51cGNhc3QgPSB1cGNhc3Q7CiAgICAgICAgICAgIHRoaXMuZG93bmNhc3QgPSBkb3duY2FzdDsKICAgICAgICAgICAgdGhpcy5wdXJlVmlydHVhbEZ1bmN0aW9ucyA9IFtdOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBjYXN0UG9pbnRlcihwdHIsIHB0ckNsYXNzLCBkZXNpcmVkQ2xhc3MpIHsKICAgICAgICAgICAgd2hpbGUgKHB0ckNsYXNzICE9PSBkZXNpcmVkQ2xhc3MpIHsKICAgICAgICAgICAgICBpZiAoIXB0ckNsYXNzLnVwY2FzdCkgewogICAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIkV4cGVjdGVkIG51bGwgb3IgaW5zdGFuY2Ugb2YgIiArIGRlc2lyZWRDbGFzcy5uYW1lICsgIiwgZ290IGFuIGluc3RhbmNlIG9mICIgKyBwdHJDbGFzcy5uYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHRyID0gcHRyQ2xhc3MudXBjYXN0KHB0cik7CiAgICAgICAgICAgICAgcHRyQ2xhc3MgPSBwdHJDbGFzcy5iYXNlQ2xhc3M7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHB0cjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNvbnN0Tm9TbWFydFB0clJhd1BvaW50ZXJUb1dpcmVUeXBlKGRlc3RydWN0b3JzLCBoYW5kbGUpIHsKICAgICAgICAgICAgaWYgKGhhbmRsZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGlmICh0aGlzLmlzUmVmZXJlbmNlKSB7CiAgICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigibnVsbCBpcyBub3QgYSB2YWxpZCAiICsgdGhpcy5uYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFoYW5kbGUuJCQpIHsKICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcignQ2Fubm90IHBhc3MgIicgKyBfZW1iaW5kX3JlcHIoaGFuZGxlKSArICciIGFzIGEgJyArIHRoaXMubmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFoYW5kbGUuJCQucHRyKSB7CiAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIkNhbm5vdCBwYXNzIGRlbGV0ZWQgb2JqZWN0IGFzIGEgcG9pbnRlciBvZiB0eXBlICIgKyB0aGlzLm5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBoYW5kbGVDbGFzcyA9IGhhbmRsZS4kJC5wdHJUeXBlLnJlZ2lzdGVyZWRDbGFzczsKICAgICAgICAgICAgdmFyIHB0ciA9IHVwY2FzdFBvaW50ZXIoaGFuZGxlLiQkLnB0ciwgaGFuZGxlQ2xhc3MsIHRoaXMucmVnaXN0ZXJlZENsYXNzKTsKICAgICAgICAgICAgcmV0dXJuIHB0cjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdlbmVyaWNQb2ludGVyVG9XaXJlVHlwZShkZXN0cnVjdG9ycywgaGFuZGxlKSB7CiAgICAgICAgICAgIHZhciBwdHI7CiAgICAgICAgICAgIGlmIChoYW5kbGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAodGhpcy5pc1JlZmVyZW5jZSkgewogICAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIm51bGwgaXMgbm90IGEgdmFsaWQgIiArIHRoaXMubmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0aGlzLmlzU21hcnRQb2ludGVyKSB7CiAgICAgICAgICAgICAgICBwdHIgPSB0aGlzLnJhd0NvbnN0cnVjdG9yKCk7CiAgICAgICAgICAgICAgICBpZiAoZGVzdHJ1Y3RvcnMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZGVzdHJ1Y3RvcnMucHVzaCh0aGlzLnJhd0Rlc3RydWN0b3IsIHB0cik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcHRyOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFoYW5kbGUuJCQpIHsKICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcignQ2Fubm90IHBhc3MgIicgKyBfZW1iaW5kX3JlcHIoaGFuZGxlKSArICciIGFzIGEgJyArIHRoaXMubmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFoYW5kbGUuJCQucHRyKSB7CiAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIkNhbm5vdCBwYXNzIGRlbGV0ZWQgb2JqZWN0IGFzIGEgcG9pbnRlciBvZiB0eXBlICIgKyB0aGlzLm5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghdGhpcy5pc0NvbnN0ICYmIGhhbmRsZS4kJC5wdHJUeXBlLmlzQ29uc3QpIHsKICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiQ2Fubm90IGNvbnZlcnQgYXJndW1lbnQgb2YgdHlwZSAiICsgKGhhbmRsZS4kJC5zbWFydFB0clR5cGUgPyBoYW5kbGUuJCQuc21hcnRQdHJUeXBlLm5hbWUgOiBoYW5kbGUuJCQucHRyVHlwZS5uYW1lKSArICIgdG8gcGFyYW1ldGVyIHR5cGUgIiArIHRoaXMubmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhhbmRsZUNsYXNzID0gaGFuZGxlLiQkLnB0clR5cGUucmVnaXN0ZXJlZENsYXNzOwogICAgICAgICAgICBwdHIgPSB1cGNhc3RQb2ludGVyKGhhbmRsZS4kJC5wdHIsIGhhbmRsZUNsYXNzLCB0aGlzLnJlZ2lzdGVyZWRDbGFzcyk7CiAgICAgICAgICAgIGlmICh0aGlzLmlzU21hcnRQb2ludGVyKSB7CiAgICAgICAgICAgICAgaWYgKHZvaWQgMCA9PT0gaGFuZGxlLiQkLnNtYXJ0UHRyKSB7CiAgICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiUGFzc2luZyByYXcgcG9pbnRlciB0byBzbWFydCBwb2ludGVyIGlzIGlsbGVnYWwiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3dpdGNoICh0aGlzLnNoYXJpbmdQb2xpY3kpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgaWYgKGhhbmRsZS4kJC5zbWFydFB0clR5cGUgPT09IHRoaXMpIHsKICAgICAgICAgICAgICAgICAgICBwdHIgPSBoYW5kbGUuJCQuc21hcnRQdHI7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIkNhbm5vdCBjb252ZXJ0IGFyZ3VtZW50IG9mIHR5cGUgIiArIChoYW5kbGUuJCQuc21hcnRQdHJUeXBlID8gaGFuZGxlLiQkLnNtYXJ0UHRyVHlwZS5uYW1lIDogaGFuZGxlLiQkLnB0clR5cGUubmFtZSkgKyAiIHRvIHBhcmFtZXRlciB0eXBlICIgKyB0aGlzLm5hbWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgICBwdHIgPSBoYW5kbGUuJCQuc21hcnRQdHI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICBpZiAoaGFuZGxlLiQkLnNtYXJ0UHRyVHlwZSA9PT0gdGhpcykgewogICAgICAgICAgICAgICAgICAgIHB0ciA9IGhhbmRsZS4kJC5zbWFydFB0cjsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY2xvbmVkSGFuZGxlID0gaGFuZGxlWyJjbG9uZSJdKCk7CiAgICAgICAgICAgICAgICAgICAgcHRyID0gdGhpcy5yYXdTaGFyZShwdHIsIF9fZW12YWxfcmVnaXN0ZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICBjbG9uZWRIYW5kbGVbImRlbGV0ZSJdKCk7CiAgICAgICAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICAgICAgICAgIGlmIChkZXN0cnVjdG9ycyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgZGVzdHJ1Y3RvcnMucHVzaCh0aGlzLnJhd0Rlc3RydWN0b3IsIHB0cik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIlVuc3VwcG9ydGluZyBzaGFyaW5nIHBvbGljeSIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcHRyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbm9uQ29uc3ROb1NtYXJ0UHRyUmF3UG9pbnRlclRvV2lyZVR5cGUoZGVzdHJ1Y3RvcnMsIGhhbmRsZSkgewogICAgICAgICAgICBpZiAoaGFuZGxlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXMuaXNSZWZlcmVuY2UpIHsKICAgICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJudWxsIGlzIG5vdCBhIHZhbGlkICIgKyB0aGlzLm5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWhhbmRsZS4kJCkgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCdDYW5ub3QgcGFzcyAiJyArIF9lbWJpbmRfcmVwcihoYW5kbGUpICsgJyIgYXMgYSAnICsgdGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWhhbmRsZS4kJC5wdHIpIHsKICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiQ2Fubm90IHBhc3MgZGVsZXRlZCBvYmplY3QgYXMgYSBwb2ludGVyIG9mIHR5cGUgIiArIHRoaXMubmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhhbmRsZS4kJC5wdHJUeXBlLmlzQ29uc3QpIHsKICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiQ2Fubm90IGNvbnZlcnQgYXJndW1lbnQgb2YgdHlwZSAiICsgaGFuZGxlLiQkLnB0clR5cGUubmFtZSArICIgdG8gcGFyYW1ldGVyIHR5cGUgIiArIHRoaXMubmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhhbmRsZUNsYXNzID0gaGFuZGxlLiQkLnB0clR5cGUucmVnaXN0ZXJlZENsYXNzOwogICAgICAgICAgICB2YXIgcHRyID0gdXBjYXN0UG9pbnRlcihoYW5kbGUuJCQucHRyLCBoYW5kbGVDbGFzcywgdGhpcy5yZWdpc3RlcmVkQ2xhc3MpOwogICAgICAgICAgICByZXR1cm4gcHRyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gUmVnaXN0ZXJlZFBvaW50ZXJfZ2V0UG9pbnRlZShwdHIpIHsKICAgICAgICAgICAgaWYgKHRoaXMucmF3R2V0UG9pbnRlZSkgewogICAgICAgICAgICAgIHB0ciA9IHRoaXMucmF3R2V0UG9pbnRlZShwdHIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwdHI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBSZWdpc3RlcmVkUG9pbnRlcl9kZXN0cnVjdG9yKHB0cikgewogICAgICAgICAgICBpZiAodGhpcy5yYXdEZXN0cnVjdG9yKSB7CiAgICAgICAgICAgICAgdGhpcy5yYXdEZXN0cnVjdG9yKHB0cik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFJlZ2lzdGVyZWRQb2ludGVyX2RlbGV0ZU9iamVjdChoYW5kbGUpIHsKICAgICAgICAgICAgaWYgKGhhbmRsZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGhhbmRsZVsiZGVsZXRlIl0oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZG93bmNhc3RQb2ludGVyKHB0ciwgcHRyQ2xhc3MsIGRlc2lyZWRDbGFzcykgewogICAgICAgICAgICBpZiAocHRyQ2xhc3MgPT09IGRlc2lyZWRDbGFzcykgewogICAgICAgICAgICAgIHJldHVybiBwdHI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZvaWQgMCA9PT0gZGVzaXJlZENsYXNzLmJhc2VDbGFzcykgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBydiA9IGRvd25jYXN0UG9pbnRlcihwdHIsIHB0ckNsYXNzLCBkZXNpcmVkQ2xhc3MuYmFzZUNsYXNzKTsKICAgICAgICAgICAgaWYgKHJ2ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRlc2lyZWRDbGFzcy5kb3duY2FzdChydik7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRJbmhlcml0ZWRJbnN0YW5jZUNvdW50KCkgewogICAgICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMocmVnaXN0ZXJlZEluc3RhbmNlcykubGVuZ3RoOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0TGl2ZUluaGVyaXRlZEluc3RhbmNlcygpIHsKICAgICAgICAgICAgdmFyIHJ2ID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGsgaW4gcmVnaXN0ZXJlZEluc3RhbmNlcykgewogICAgICAgICAgICAgIGlmIChyZWdpc3RlcmVkSW5zdGFuY2VzLmhhc093blByb3BlcnR5KGspKSB7CiAgICAgICAgICAgICAgICBydi5wdXNoKHJlZ2lzdGVyZWRJbnN0YW5jZXNba10pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcnY7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzZXREZWxheUZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICAgIGRlbGF5RnVuY3Rpb24gPSBmbjsKICAgICAgICAgICAgaWYgKGRlbGV0aW9uUXVldWUubGVuZ3RoICYmIGRlbGF5RnVuY3Rpb24pIHsKICAgICAgICAgICAgICBkZWxheUZ1bmN0aW9uKGZsdXNoUGVuZGluZ0RlbGV0ZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpbml0X2VtYmluZCgpIHsKICAgICAgICAgICAgTW9kdWxlWyJnZXRJbmhlcml0ZWRJbnN0YW5jZUNvdW50Il0gPSBnZXRJbmhlcml0ZWRJbnN0YW5jZUNvdW50OwogICAgICAgICAgICBNb2R1bGVbImdldExpdmVJbmhlcml0ZWRJbnN0YW5jZXMiXSA9IGdldExpdmVJbmhlcml0ZWRJbnN0YW5jZXM7CiAgICAgICAgICAgIE1vZHVsZVsiZmx1c2hQZW5kaW5nRGVsZXRlcyJdID0gZmx1c2hQZW5kaW5nRGVsZXRlczsKICAgICAgICAgICAgTW9kdWxlWyJzZXREZWxheUZ1bmN0aW9uIl0gPSBzZXREZWxheUZ1bmN0aW9uOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlZ2lzdGVyZWRJbnN0YW5jZXMgPSB7fTsKICAgICAgICAgIGZ1bmN0aW9uIGdldEJhc2VzdFBvaW50ZXIoY2xhc3NfLCBwdHIpIHsKICAgICAgICAgICAgaWYgKHB0ciA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoInB0ciBzaG91bGQgbm90IGJlIHVuZGVmaW5lZCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChjbGFzc18uYmFzZUNsYXNzKSB7CiAgICAgICAgICAgICAgcHRyID0gY2xhc3NfLnVwY2FzdChwdHIpOwogICAgICAgICAgICAgIGNsYXNzXyA9IGNsYXNzXy5iYXNlQ2xhc3M7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHB0cjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldEluaGVyaXRlZEluc3RhbmNlKGNsYXNzXywgcHRyKSB7CiAgICAgICAgICAgIHB0ciA9IGdldEJhc2VzdFBvaW50ZXIoY2xhc3NfLCBwdHIpOwogICAgICAgICAgICByZXR1cm4gcmVnaXN0ZXJlZEluc3RhbmNlc1twdHJdOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbWFrZUNsYXNzSGFuZGxlKHByb3RvdHlwZSwgcmVjb3JkKSB7CiAgICAgICAgICAgIGlmICghcmVjb3JkLnB0clR5cGUgfHwgIXJlY29yZC5wdHIpIHsKICAgICAgICAgICAgICB0aHJvd0ludGVybmFsRXJyb3IoIm1ha2VDbGFzc0hhbmRsZSByZXF1aXJlcyBwdHIgYW5kIHB0clR5cGUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFzU21hcnRQdHJUeXBlID0gISFyZWNvcmQuc21hcnRQdHJUeXBlOwogICAgICAgICAgICB2YXIgaGFzU21hcnRQdHIgPSAhIXJlY29yZC5zbWFydFB0cjsKICAgICAgICAgICAgaWYgKGhhc1NtYXJ0UHRyVHlwZSAhPT0gaGFzU21hcnRQdHIpIHsKICAgICAgICAgICAgICB0aHJvd0ludGVybmFsRXJyb3IoIkJvdGggc21hcnRQdHJUeXBlIGFuZCBzbWFydFB0ciBtdXN0IGJlIHNwZWNpZmllZCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlY29yZC5jb3VudCA9IHsgdmFsdWU6IDEgfTsKICAgICAgICAgICAgcmV0dXJuIGF0dGFjaEZpbmFsaXplcihPYmplY3QuY3JlYXRlKHByb3RvdHlwZSwgeyAkJDogeyB2YWx1ZTogcmVjb3JkIH0gfSkpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gUmVnaXN0ZXJlZFBvaW50ZXJfZnJvbVdpcmVUeXBlKHB0cikgewogICAgICAgICAgICB2YXIgcmF3UG9pbnRlciA9IHRoaXMuZ2V0UG9pbnRlZShwdHIpOwogICAgICAgICAgICBpZiAoIXJhd1BvaW50ZXIpIHsKICAgICAgICAgICAgICB0aGlzLmRlc3RydWN0b3IocHRyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcmVnaXN0ZXJlZEluc3RhbmNlID0gZ2V0SW5oZXJpdGVkSW5zdGFuY2UodGhpcy5yZWdpc3RlcmVkQ2xhc3MsIHJhd1BvaW50ZXIpOwogICAgICAgICAgICBpZiAodm9pZCAwICE9PSByZWdpc3RlcmVkSW5zdGFuY2UpIHsKICAgICAgICAgICAgICBpZiAoMCA9PT0gcmVnaXN0ZXJlZEluc3RhbmNlLiQkLmNvdW50LnZhbHVlKSB7CiAgICAgICAgICAgICAgICByZWdpc3RlcmVkSW5zdGFuY2UuJCQucHRyID0gcmF3UG9pbnRlcjsKICAgICAgICAgICAgICAgIHJlZ2lzdGVyZWRJbnN0YW5jZS4kJC5zbWFydFB0ciA9IHB0cjsKICAgICAgICAgICAgICAgIHJldHVybiByZWdpc3RlcmVkSW5zdGFuY2VbImNsb25lIl0oKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHJ2ID0gcmVnaXN0ZXJlZEluc3RhbmNlWyJjbG9uZSJdKCk7CiAgICAgICAgICAgICAgICB0aGlzLmRlc3RydWN0b3IocHRyKTsKICAgICAgICAgICAgICAgIHJldHVybiBydjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gbWFrZURlZmF1bHRIYW5kbGUoKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXMuaXNTbWFydFBvaW50ZXIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtYWtlQ2xhc3NIYW5kbGUodGhpcy5yZWdpc3RlcmVkQ2xhc3MuaW5zdGFuY2VQcm90b3R5cGUsIHsgcHRyVHlwZTogdGhpcy5wb2ludGVlVHlwZSwgcHRyOiByYXdQb2ludGVyLCBzbWFydFB0clR5cGU6IHRoaXMsIHNtYXJ0UHRyOiBwdHIgfSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBtYWtlQ2xhc3NIYW5kbGUodGhpcy5yZWdpc3RlcmVkQ2xhc3MuaW5zdGFuY2VQcm90b3R5cGUsIHsgcHRyVHlwZTogdGhpcywgcHRyIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYWN0dWFsVHlwZSA9IHRoaXMucmVnaXN0ZXJlZENsYXNzLmdldEFjdHVhbFR5cGUocmF3UG9pbnRlcik7CiAgICAgICAgICAgIHZhciByZWdpc3RlcmVkUG9pbnRlclJlY29yZCA9IHJlZ2lzdGVyZWRQb2ludGVyc1thY3R1YWxUeXBlXTsKICAgICAgICAgICAgaWYgKCFyZWdpc3RlcmVkUG9pbnRlclJlY29yZCkgewogICAgICAgICAgICAgIHJldHVybiBtYWtlRGVmYXVsdEhhbmRsZS5jYWxsKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0b1R5cGU7CiAgICAgICAgICAgIGlmICh0aGlzLmlzQ29uc3QpIHsKICAgICAgICAgICAgICB0b1R5cGUgPSByZWdpc3RlcmVkUG9pbnRlclJlY29yZC5jb25zdFBvaW50ZXJUeXBlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRvVHlwZSA9IHJlZ2lzdGVyZWRQb2ludGVyUmVjb3JkLnBvaW50ZXJUeXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkcCA9IGRvd25jYXN0UG9pbnRlcihyYXdQb2ludGVyLCB0aGlzLnJlZ2lzdGVyZWRDbGFzcywgdG9UeXBlLnJlZ2lzdGVyZWRDbGFzcyk7CiAgICAgICAgICAgIGlmIChkcCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBtYWtlRGVmYXVsdEhhbmRsZS5jYWxsKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLmlzU21hcnRQb2ludGVyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG1ha2VDbGFzc0hhbmRsZSh0b1R5cGUucmVnaXN0ZXJlZENsYXNzLmluc3RhbmNlUHJvdG90eXBlLCB7IHB0clR5cGU6IHRvVHlwZSwgcHRyOiBkcCwgc21hcnRQdHJUeXBlOiB0aGlzLCBzbWFydFB0cjogcHRyIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBtYWtlQ2xhc3NIYW5kbGUodG9UeXBlLnJlZ2lzdGVyZWRDbGFzcy5pbnN0YW5jZVByb3RvdHlwZSwgeyBwdHJUeXBlOiB0b1R5cGUsIHB0cjogZHAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGluaXRfUmVnaXN0ZXJlZFBvaW50ZXIoKSB7CiAgICAgICAgICAgIFJlZ2lzdGVyZWRQb2ludGVyLnByb3RvdHlwZS5nZXRQb2ludGVlID0gUmVnaXN0ZXJlZFBvaW50ZXJfZ2V0UG9pbnRlZTsKICAgICAgICAgICAgUmVnaXN0ZXJlZFBvaW50ZXIucHJvdG90eXBlLmRlc3RydWN0b3IgPSBSZWdpc3RlcmVkUG9pbnRlcl9kZXN0cnVjdG9yOwogICAgICAgICAgICBSZWdpc3RlcmVkUG9pbnRlci5wcm90b3R5cGVbImFyZ1BhY2tBZHZhbmNlIl0gPSA4OwogICAgICAgICAgICBSZWdpc3RlcmVkUG9pbnRlci5wcm90b3R5cGVbInJlYWRWYWx1ZUZyb21Qb2ludGVyIl0gPSBzaW1wbGVSZWFkVmFsdWVGcm9tUG9pbnRlcjsKICAgICAgICAgICAgUmVnaXN0ZXJlZFBvaW50ZXIucHJvdG90eXBlWyJkZWxldGVPYmplY3QiXSA9IFJlZ2lzdGVyZWRQb2ludGVyX2RlbGV0ZU9iamVjdDsKICAgICAgICAgICAgUmVnaXN0ZXJlZFBvaW50ZXIucHJvdG90eXBlWyJmcm9tV2lyZVR5cGUiXSA9IFJlZ2lzdGVyZWRQb2ludGVyX2Zyb21XaXJlVHlwZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFJlZ2lzdGVyZWRQb2ludGVyKG5hbWUsIHJlZ2lzdGVyZWRDbGFzcywgaXNSZWZlcmVuY2UsIGlzQ29uc3QsIGlzU21hcnRQb2ludGVyLCBwb2ludGVlVHlwZSwgc2hhcmluZ1BvbGljeSwgcmF3R2V0UG9pbnRlZSwgcmF3Q29uc3RydWN0b3IsIHJhd1NoYXJlLCByYXdEZXN0cnVjdG9yKSB7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgICAgIHRoaXMucmVnaXN0ZXJlZENsYXNzID0gcmVnaXN0ZXJlZENsYXNzOwogICAgICAgICAgICB0aGlzLmlzUmVmZXJlbmNlID0gaXNSZWZlcmVuY2U7CiAgICAgICAgICAgIHRoaXMuaXNDb25zdCA9IGlzQ29uc3Q7CiAgICAgICAgICAgIHRoaXMuaXNTbWFydFBvaW50ZXIgPSBpc1NtYXJ0UG9pbnRlcjsKICAgICAgICAgICAgdGhpcy5wb2ludGVlVHlwZSA9IHBvaW50ZWVUeXBlOwogICAgICAgICAgICB0aGlzLnNoYXJpbmdQb2xpY3kgPSBzaGFyaW5nUG9saWN5OwogICAgICAgICAgICB0aGlzLnJhd0dldFBvaW50ZWUgPSByYXdHZXRQb2ludGVlOwogICAgICAgICAgICB0aGlzLnJhd0NvbnN0cnVjdG9yID0gcmF3Q29uc3RydWN0b3I7CiAgICAgICAgICAgIHRoaXMucmF3U2hhcmUgPSByYXdTaGFyZTsKICAgICAgICAgICAgdGhpcy5yYXdEZXN0cnVjdG9yID0gcmF3RGVzdHJ1Y3RvcjsKICAgICAgICAgICAgaWYgKCFpc1NtYXJ0UG9pbnRlciAmJiByZWdpc3RlcmVkQ2xhc3MuYmFzZUNsYXNzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZiAoaXNDb25zdCkgewogICAgICAgICAgICAgICAgdGhpc1sidG9XaXJlVHlwZSJdID0gY29uc3ROb1NtYXJ0UHRyUmF3UG9pbnRlclRvV2lyZVR5cGU7CiAgICAgICAgICAgICAgICB0aGlzLmRlc3RydWN0b3JGdW5jdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXNbInRvV2lyZVR5cGUiXSA9IG5vbkNvbnN0Tm9TbWFydFB0clJhd1BvaW50ZXJUb1dpcmVUeXBlOwogICAgICAgICAgICAgICAgdGhpcy5kZXN0cnVjdG9yRnVuY3Rpb24gPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzWyJ0b1dpcmVUeXBlIl0gPSBnZW5lcmljUG9pbnRlclRvV2lyZVR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlcGxhY2VQdWJsaWNTeW1ib2wobmFtZSwgdmFsdWUsIG51bUFyZ3VtZW50cykgewogICAgICAgICAgICBpZiAoIU1vZHVsZS5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICAgIHRocm93SW50ZXJuYWxFcnJvcigiUmVwbGFjaW5nIG5vbmV4aXN0YW50IHB1YmxpYyBzeW1ib2wiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodm9pZCAwICE9PSBNb2R1bGVbbmFtZV0ub3ZlcmxvYWRUYWJsZSAmJiB2b2lkIDAgIT09IG51bUFyZ3VtZW50cykgewogICAgICAgICAgICAgIE1vZHVsZVtuYW1lXS5vdmVybG9hZFRhYmxlW251bUFyZ3VtZW50c10gPSB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBNb2R1bGVbbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgICBNb2R1bGVbbmFtZV0uYXJnQ291bnQgPSBudW1Bcmd1bWVudHM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGR5bkNhbGxMZWdhY3koc2lnLCBwdHIsIGFyZ3MpIHsKICAgICAgICAgICAgdmFyIGYgPSBNb2R1bGVbImR5bkNhbGxfIiArIHNpZ107CiAgICAgICAgICAgIHJldHVybiBhcmdzICYmIGFyZ3MubGVuZ3RoID8gZi5hcHBseShudWxsLCBbcHRyXS5jb25jYXQoYXJncykpIDogZi5jYWxsKG51bGwsIHB0cik7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBkeW5DYWxsKHNpZywgcHRyLCBhcmdzKSB7CiAgICAgICAgICAgIGlmIChzaWcuaW5kZXhPZigiaiIpICE9IC0xKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGR5bkNhbGxMZWdhY3koc2lnLCBwdHIsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB3YXNtVGFibGUuZ2V0KHB0cikuYXBwbHkobnVsbCwgYXJncyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXREeW5DYWxsZXIoc2lnLCBwdHIpIHsKICAgICAgICAgICAgdmFyIGFyZ0NhY2hlID0gW107CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBhcmdDYWNoZS5sZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoOwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBhcmdDYWNoZVtpXSA9IGFyZ3VtZW50c1tpXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGR5bkNhbGwoc2lnLCBwdHIsIGFyZ0NhY2hlKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGVtYmluZF9fcmVxdWlyZUZ1bmN0aW9uKHNpZ25hdHVyZSwgcmF3RnVuY3Rpb24pIHsKICAgICAgICAgICAgc2lnbmF0dXJlID0gcmVhZExhdGluMVN0cmluZyhzaWduYXR1cmUpOwogICAgICAgICAgICBmdW5jdGlvbiBtYWtlRHluQ2FsbGVyKCkgewogICAgICAgICAgICAgIGlmIChzaWduYXR1cmUuaW5kZXhPZigiaiIpICE9IC0xKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0RHluQ2FsbGVyKHNpZ25hdHVyZSwgcmF3RnVuY3Rpb24pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gd2FzbVRhYmxlLmdldChyYXdGdW5jdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZwID0gbWFrZUR5bkNhbGxlcigpOwogICAgICAgICAgICBpZiAodHlwZW9mIGZwICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoInVua25vd24gZnVuY3Rpb24gcG9pbnRlciB3aXRoIHNpZ25hdHVyZSAiICsgc2lnbmF0dXJlICsgIjogIiArIHJhd0Z1bmN0aW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZnA7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgVW5ib3VuZFR5cGVFcnJvciA9IHZvaWQgMDsKICAgICAgICAgIGZ1bmN0aW9uIGdldFR5cGVOYW1lKHR5cGUpIHsKICAgICAgICAgICAgdmFyIHB0ciA9IF9fX2dldFR5cGVOYW1lKHR5cGUpOwogICAgICAgICAgICB2YXIgcnYgPSByZWFkTGF0aW4xU3RyaW5nKHB0cik7CiAgICAgICAgICAgIF9mcmVlKHB0cik7CiAgICAgICAgICAgIHJldHVybiBydjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHRocm93VW5ib3VuZFR5cGVFcnJvcihtZXNzYWdlLCB0eXBlcykgewogICAgICAgICAgICB2YXIgdW5ib3VuZFR5cGVzID0gW107CiAgICAgICAgICAgIHZhciBzZWVuID0ge307CiAgICAgICAgICAgIGZ1bmN0aW9uIHZpc2l0KHR5cGUpIHsKICAgICAgICAgICAgICBpZiAoc2Vlblt0eXBlXSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmVnaXN0ZXJlZFR5cGVzW3R5cGVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0eXBlRGVwZW5kZW5jaWVzW3R5cGVdKSB7CiAgICAgICAgICAgICAgICB0eXBlRGVwZW5kZW5jaWVzW3R5cGVdLmZvckVhY2godmlzaXQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1bmJvdW5kVHlwZXMucHVzaCh0eXBlKTsKICAgICAgICAgICAgICBzZWVuW3R5cGVdID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0eXBlcy5mb3JFYWNoKHZpc2l0KTsKICAgICAgICAgICAgdGhyb3cgbmV3IFVuYm91bmRUeXBlRXJyb3IobWVzc2FnZSArICI6ICIgKyB1bmJvdW5kVHlwZXMubWFwKGdldFR5cGVOYW1lKS5qb2luKFsiLCAiXSkpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfcmVnaXN0ZXJfY2xhc3MocmF3VHlwZSwgcmF3UG9pbnRlclR5cGUsIHJhd0NvbnN0UG9pbnRlclR5cGUsIGJhc2VDbGFzc1Jhd1R5cGUsIGdldEFjdHVhbFR5cGVTaWduYXR1cmUsIGdldEFjdHVhbFR5cGUsIHVwY2FzdFNpZ25hdHVyZSwgdXBjYXN0LCBkb3duY2FzdFNpZ25hdHVyZSwgZG93bmNhc3QsIG5hbWUsIGRlc3RydWN0b3JTaWduYXR1cmUsIHJhd0Rlc3RydWN0b3IpIHsKICAgICAgICAgICAgbmFtZSA9IHJlYWRMYXRpbjFTdHJpbmcobmFtZSk7CiAgICAgICAgICAgIGdldEFjdHVhbFR5cGUgPSBlbWJpbmRfX3JlcXVpcmVGdW5jdGlvbihnZXRBY3R1YWxUeXBlU2lnbmF0dXJlLCBnZXRBY3R1YWxUeXBlKTsKICAgICAgICAgICAgaWYgKHVwY2FzdCkgewogICAgICAgICAgICAgIHVwY2FzdCA9IGVtYmluZF9fcmVxdWlyZUZ1bmN0aW9uKHVwY2FzdFNpZ25hdHVyZSwgdXBjYXN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZG93bmNhc3QpIHsKICAgICAgICAgICAgICBkb3duY2FzdCA9IGVtYmluZF9fcmVxdWlyZUZ1bmN0aW9uKGRvd25jYXN0U2lnbmF0dXJlLCBkb3duY2FzdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmF3RGVzdHJ1Y3RvciA9IGVtYmluZF9fcmVxdWlyZUZ1bmN0aW9uKGRlc3RydWN0b3JTaWduYXR1cmUsIHJhd0Rlc3RydWN0b3IpOwogICAgICAgICAgICB2YXIgbGVnYWxGdW5jdGlvbk5hbWUgPSBtYWtlTGVnYWxGdW5jdGlvbk5hbWUobmFtZSk7CiAgICAgICAgICAgIGV4cG9zZVB1YmxpY1N5bWJvbChsZWdhbEZ1bmN0aW9uTmFtZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdGhyb3dVbmJvdW5kVHlwZUVycm9yKCJDYW5ub3QgY29uc3RydWN0ICIgKyBuYW1lICsgIiBkdWUgdG8gdW5ib3VuZCB0eXBlcyIsIFtiYXNlQ2xhc3NSYXdUeXBlXSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB3aGVuRGVwZW5kZW50VHlwZXNBcmVSZXNvbHZlZChbcmF3VHlwZSwgcmF3UG9pbnRlclR5cGUsIHJhd0NvbnN0UG9pbnRlclR5cGVdLCBiYXNlQ2xhc3NSYXdUeXBlID8gW2Jhc2VDbGFzc1Jhd1R5cGVdIDogW10sIGZ1bmN0aW9uKGJhc2UpIHsKICAgICAgICAgICAgICBiYXNlID0gYmFzZVswXTsKICAgICAgICAgICAgICB2YXIgYmFzZUNsYXNzOwogICAgICAgICAgICAgIHZhciBiYXNlUHJvdG90eXBlOwogICAgICAgICAgICAgIGlmIChiYXNlQ2xhc3NSYXdUeXBlKSB7CiAgICAgICAgICAgICAgICBiYXNlQ2xhc3MgPSBiYXNlLnJlZ2lzdGVyZWRDbGFzczsKICAgICAgICAgICAgICAgIGJhc2VQcm90b3R5cGUgPSBiYXNlQ2xhc3MuaW5zdGFuY2VQcm90b3R5cGU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGJhc2VQcm90b3R5cGUgPSBDbGFzc0hhbmRsZS5wcm90b3R5cGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjb25zdHJ1Y3RvciA9IGNyZWF0ZU5hbWVkRnVuY3Rpb24obGVnYWxGdW5jdGlvbk5hbWUsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKSAhPT0gaW5zdGFuY2VQcm90b3R5cGUpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJpbmRpbmdFcnJvcigiVXNlICduZXcnIHRvIGNvbnN0cnVjdCAiICsgbmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodm9pZCAwID09PSByZWdpc3RlcmVkQ2xhc3MuY29uc3RydWN0b3JfYm9keSkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQmluZGluZ0Vycm9yKG5hbWUgKyAiIGhhcyBubyBhY2Nlc3NpYmxlIGNvbnN0cnVjdG9yIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgYm9keSA9IHJlZ2lzdGVyZWRDbGFzcy5jb25zdHJ1Y3Rvcl9ib2R5W2FyZ3VtZW50cy5sZW5ndGhdOwogICAgICAgICAgICAgICAgaWYgKHZvaWQgMCA9PT0gYm9keSkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQmluZGluZ0Vycm9yKCJUcmllZCB0byBpbnZva2UgY3RvciBvZiAiICsgbmFtZSArICIgd2l0aCBpbnZhbGlkIG51bWJlciBvZiBwYXJhbWV0ZXJzICgiICsgYXJndW1lbnRzLmxlbmd0aCArICIpIC0gZXhwZWN0ZWQgKCIgKyBPYmplY3Qua2V5cyhyZWdpc3RlcmVkQ2xhc3MuY29uc3RydWN0b3JfYm9keSkudG9TdHJpbmcoKSArICIpIHBhcmFtZXRlcnMgaW5zdGVhZCEiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBib2R5LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgdmFyIGluc3RhbmNlUHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShiYXNlUHJvdG90eXBlLCB7IGNvbnN0cnVjdG9yOiB7IHZhbHVlOiBjb25zdHJ1Y3RvciB9IH0pOwogICAgICAgICAgICAgIGNvbnN0cnVjdG9yLnByb3RvdHlwZSA9IGluc3RhbmNlUHJvdG90eXBlOwogICAgICAgICAgICAgIHZhciByZWdpc3RlcmVkQ2xhc3MgPSBuZXcgUmVnaXN0ZXJlZENsYXNzKG5hbWUsIGNvbnN0cnVjdG9yLCBpbnN0YW5jZVByb3RvdHlwZSwgcmF3RGVzdHJ1Y3RvciwgYmFzZUNsYXNzLCBnZXRBY3R1YWxUeXBlLCB1cGNhc3QsIGRvd25jYXN0KTsKICAgICAgICAgICAgICB2YXIgcmVmZXJlbmNlQ29udmVydGVyID0gbmV3IFJlZ2lzdGVyZWRQb2ludGVyKG5hbWUsIHJlZ2lzdGVyZWRDbGFzcywgdHJ1ZSwgZmFsc2UsIGZhbHNlKTsKICAgICAgICAgICAgICB2YXIgcG9pbnRlckNvbnZlcnRlciA9IG5ldyBSZWdpc3RlcmVkUG9pbnRlcihuYW1lICsgIioiLCByZWdpc3RlcmVkQ2xhc3MsIGZhbHNlLCBmYWxzZSwgZmFsc2UpOwogICAgICAgICAgICAgIHZhciBjb25zdFBvaW50ZXJDb252ZXJ0ZXIgPSBuZXcgUmVnaXN0ZXJlZFBvaW50ZXIobmFtZSArICIgY29uc3QqIiwgcmVnaXN0ZXJlZENsYXNzLCBmYWxzZSwgdHJ1ZSwgZmFsc2UpOwogICAgICAgICAgICAgIHJlZ2lzdGVyZWRQb2ludGVyc1tyYXdUeXBlXSA9IHsgcG9pbnRlclR5cGU6IHBvaW50ZXJDb252ZXJ0ZXIsIGNvbnN0UG9pbnRlclR5cGU6IGNvbnN0UG9pbnRlckNvbnZlcnRlciB9OwogICAgICAgICAgICAgIHJlcGxhY2VQdWJsaWNTeW1ib2wobGVnYWxGdW5jdGlvbk5hbWUsIGNvbnN0cnVjdG9yKTsKICAgICAgICAgICAgICByZXR1cm4gW3JlZmVyZW5jZUNvbnZlcnRlciwgcG9pbnRlckNvbnZlcnRlciwgY29uc3RQb2ludGVyQ29udmVydGVyXTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBoZWFwMzJWZWN0b3JUb0FycmF5KGNvdW50LCBmaXJzdEVsZW1lbnQpIHsKICAgICAgICAgICAgdmFyIGFycmF5ID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY291bnQ7IGkrKykgewogICAgICAgICAgICAgIGFycmF5LnB1c2goSEVBUDMyWyhmaXJzdEVsZW1lbnQgPj4gMikgKyBpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfcmVnaXN0ZXJfY2xhc3NfY29uc3RydWN0b3IocmF3Q2xhc3NUeXBlLCBhcmdDb3VudCwgcmF3QXJnVHlwZXNBZGRyLCBpbnZva2VyU2lnbmF0dXJlLCBpbnZva2VyLCByYXdDb25zdHJ1Y3RvcikgewogICAgICAgICAgICBhc3NlcnQoYXJnQ291bnQgPiAwKTsKICAgICAgICAgICAgdmFyIHJhd0FyZ1R5cGVzID0gaGVhcDMyVmVjdG9yVG9BcnJheShhcmdDb3VudCwgcmF3QXJnVHlwZXNBZGRyKTsKICAgICAgICAgICAgaW52b2tlciA9IGVtYmluZF9fcmVxdWlyZUZ1bmN0aW9uKGludm9rZXJTaWduYXR1cmUsIGludm9rZXIpOwogICAgICAgICAgICB2YXIgYXJncyA9IFtyYXdDb25zdHJ1Y3Rvcl07CiAgICAgICAgICAgIHZhciBkZXN0cnVjdG9ycyA9IFtdOwogICAgICAgICAgICB3aGVuRGVwZW5kZW50VHlwZXNBcmVSZXNvbHZlZChbXSwgW3Jhd0NsYXNzVHlwZV0sIGZ1bmN0aW9uKGNsYXNzVHlwZSkgewogICAgICAgICAgICAgIGNsYXNzVHlwZSA9IGNsYXNzVHlwZVswXTsKICAgICAgICAgICAgICB2YXIgaHVtYW5OYW1lID0gImNvbnN0cnVjdG9yICIgKyBjbGFzc1R5cGUubmFtZTsKICAgICAgICAgICAgICBpZiAodm9pZCAwID09PSBjbGFzc1R5cGUucmVnaXN0ZXJlZENsYXNzLmNvbnN0cnVjdG9yX2JvZHkpIHsKICAgICAgICAgICAgICAgIGNsYXNzVHlwZS5yZWdpc3RlcmVkQ2xhc3MuY29uc3RydWN0b3JfYm9keSA9IFtdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodm9pZCAwICE9PSBjbGFzc1R5cGUucmVnaXN0ZXJlZENsYXNzLmNvbnN0cnVjdG9yX2JvZHlbYXJnQ291bnQgLSAxXSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJpbmRpbmdFcnJvcigiQ2Fubm90IHJlZ2lzdGVyIG11bHRpcGxlIGNvbnN0cnVjdG9ycyB3aXRoIGlkZW50aWNhbCBudW1iZXIgb2YgcGFyYW1ldGVycyAoIiArIChhcmdDb3VudCAtIDEpICsgIikgZm9yIGNsYXNzICciICsgY2xhc3NUeXBlLm5hbWUgKyAiJyEgT3ZlcmxvYWQgcmVzb2x1dGlvbiBpcyBjdXJyZW50bHkgb25seSBwZXJmb3JtZWQgdXNpbmcgdGhlIHBhcmFtZXRlciBjb3VudCwgbm90IGFjdHVhbCB0eXBlIGluZm8hIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNsYXNzVHlwZS5yZWdpc3RlcmVkQ2xhc3MuY29uc3RydWN0b3JfYm9keVthcmdDb3VudCAtIDFdID0gZnVuY3Rpb24gdW5ib3VuZFR5cGVIYW5kbGVyKCkgewogICAgICAgICAgICAgICAgdGhyb3dVbmJvdW5kVHlwZUVycm9yKCJDYW5ub3QgY29uc3RydWN0ICIgKyBjbGFzc1R5cGUubmFtZSArICIgZHVlIHRvIHVuYm91bmQgdHlwZXMiLCByYXdBcmdUeXBlcyk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB3aGVuRGVwZW5kZW50VHlwZXNBcmVSZXNvbHZlZChbXSwgcmF3QXJnVHlwZXMsIGZ1bmN0aW9uKGFyZ1R5cGVzKSB7CiAgICAgICAgICAgICAgICBjbGFzc1R5cGUucmVnaXN0ZXJlZENsYXNzLmNvbnN0cnVjdG9yX2JvZHlbYXJnQ291bnQgLSAxXSA9IGZ1bmN0aW9uIGNvbnN0cnVjdG9yX2JvZHkoKSB7CiAgICAgICAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoICE9PSBhcmdDb3VudCAtIDEpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcihodW1hbk5hbWUgKyAiIGNhbGxlZCB3aXRoICIgKyBhcmd1bWVudHMubGVuZ3RoICsgIiBhcmd1bWVudHMsIGV4cGVjdGVkICIgKyAoYXJnQ291bnQgLSAxKSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGVzdHJ1Y3RvcnMubGVuZ3RoID0gMDsKICAgICAgICAgICAgICAgICAgYXJncy5sZW5ndGggPSBhcmdDb3VudDsKICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmdDb3VudDsgKytpKSB7CiAgICAgICAgICAgICAgICAgICAgYXJnc1tpXSA9IGFyZ1R5cGVzW2ldWyJ0b1dpcmVUeXBlIl0oZGVzdHJ1Y3RvcnMsIGFyZ3VtZW50c1tpIC0gMV0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBwdHIgPSBpbnZva2VyLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgICAgICAgICAgICAgICBydW5EZXN0cnVjdG9ycyhkZXN0cnVjdG9ycyk7CiAgICAgICAgICAgICAgICAgIHJldHVybiBhcmdUeXBlc1swXVsiZnJvbVdpcmVUeXBlIl0ocHRyKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG5ld18oY29uc3RydWN0b3IsIGFyZ3VtZW50TGlzdCkgewogICAgICAgICAgICBpZiAoIShjb25zdHJ1Y3RvciBpbnN0YW5jZW9mIEZ1bmN0aW9uKSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIm5ld18gY2FsbGVkIHdpdGggY29uc3RydWN0b3IgdHlwZSAiICsgdHlwZW9mIGNvbnN0cnVjdG9yICsgIiB3aGljaCBpcyBub3QgYSBmdW5jdGlvbiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkdW1teSA9IGNyZWF0ZU5hbWVkRnVuY3Rpb24oY29uc3RydWN0b3IubmFtZSB8fCAidW5rbm93bkZ1bmN0aW9uTmFtZSIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZHVtbXkucHJvdG90eXBlID0gY29uc3RydWN0b3IucHJvdG90eXBlOwogICAgICAgICAgICB2YXIgb2JqID0gbmV3IGR1bW15KCk7CiAgICAgICAgICAgIHZhciByID0gY29uc3RydWN0b3IuYXBwbHkob2JqLCBhcmd1bWVudExpc3QpOwogICAgICAgICAgICByZXR1cm4gciBpbnN0YW5jZW9mIE9iamVjdCA/IHIgOiBvYmo7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmFmdEludm9rZXJGdW5jdGlvbihodW1hbk5hbWUsIGFyZ1R5cGVzLCBjbGFzc1R5cGUsIGNwcEludm9rZXJGdW5jLCBjcHBUYXJnZXRGdW5jKSB7CiAgICAgICAgICAgIHZhciBhcmdDb3VudCA9IGFyZ1R5cGVzLmxlbmd0aDsKICAgICAgICAgICAgaWYgKGFyZ0NvdW50IDwgMikgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJhcmdUeXBlcyBhcnJheSBzaXplIG1pc21hdGNoISBNdXN0IGF0IGxlYXN0IGdldCByZXR1cm4gdmFsdWUgYW5kICd0aGlzJyB0eXBlcyEiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaXNDbGFzc01ldGhvZEZ1bmMgPSBhcmdUeXBlc1sxXSAhPT0gbnVsbCAmJiBjbGFzc1R5cGUgIT09IG51bGw7CiAgICAgICAgICAgIHZhciBuZWVkc0Rlc3RydWN0b3JTdGFjayA9IGZhbHNlOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IGFyZ1R5cGVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgaWYgKGFyZ1R5cGVzW2ldICE9PSBudWxsICYmIGFyZ1R5cGVzW2ldLmRlc3RydWN0b3JGdW5jdGlvbiA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBuZWVkc0Rlc3RydWN0b3JTdGFjayA9IHRydWU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJldHVybnMgPSBhcmdUeXBlc1swXS5uYW1lICE9PSAidm9pZCI7CiAgICAgICAgICAgIHZhciBhcmdzTGlzdCA9ICIiOwogICAgICAgICAgICB2YXIgYXJnc0xpc3RXaXJlZCA9ICIiOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ0NvdW50IC0gMjsgKytpKSB7CiAgICAgICAgICAgICAgYXJnc0xpc3QgKz0gKGkgIT09IDAgPyAiLCAiIDogIiIpICsgImFyZyIgKyBpOwogICAgICAgICAgICAgIGFyZ3NMaXN0V2lyZWQgKz0gKGkgIT09IDAgPyAiLCAiIDogIiIpICsgImFyZyIgKyBpICsgIldpcmVkIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW52b2tlckZuQm9keSA9ICJyZXR1cm4gZnVuY3Rpb24gIiArIG1ha2VMZWdhbEZ1bmN0aW9uTmFtZShodW1hbk5hbWUpICsgIigiICsgYXJnc0xpc3QgKyAiKSB7XG5pZiAoYXJndW1lbnRzLmxlbmd0aCAhPT0gIiArIChhcmdDb3VudCAtIDIpICsgIikge1xudGhyb3dCaW5kaW5nRXJyb3IoJ2Z1bmN0aW9uICIgKyBodW1hbk5hbWUgKyAiIGNhbGxlZCB3aXRoICcgKyBhcmd1bWVudHMubGVuZ3RoICsgJyBhcmd1bWVudHMsIGV4cGVjdGVkICIgKyAoYXJnQ291bnQgLSAyKSArICIgYXJncyEnKTtcbn1cbiI7CiAgICAgICAgICAgIGlmIChuZWVkc0Rlc3RydWN0b3JTdGFjaykgewogICAgICAgICAgICAgIGludm9rZXJGbkJvZHkgKz0gInZhciBkZXN0cnVjdG9ycyA9IFtdO1xuIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZHRvclN0YWNrID0gbmVlZHNEZXN0cnVjdG9yU3RhY2sgPyAiZGVzdHJ1Y3RvcnMiIDogIm51bGwiOwogICAgICAgICAgICB2YXIgYXJnczEgPSBbInRocm93QmluZGluZ0Vycm9yIiwgImludm9rZXIiLCAiZm4iLCAicnVuRGVzdHJ1Y3RvcnMiLCAicmV0VHlwZSIsICJjbGFzc1BhcmFtIl07CiAgICAgICAgICAgIHZhciBhcmdzMiA9IFt0aHJvd0JpbmRpbmdFcnJvciwgY3BwSW52b2tlckZ1bmMsIGNwcFRhcmdldEZ1bmMsIHJ1bkRlc3RydWN0b3JzLCBhcmdUeXBlc1swXSwgYXJnVHlwZXNbMV1dOwogICAgICAgICAgICBpZiAoaXNDbGFzc01ldGhvZEZ1bmMpIHsKICAgICAgICAgICAgICBpbnZva2VyRm5Cb2R5ICs9ICJ2YXIgdGhpc1dpcmVkID0gY2xhc3NQYXJhbS50b1dpcmVUeXBlKCIgKyBkdG9yU3RhY2sgKyAiLCB0aGlzKTtcbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdDb3VudCAtIDI7ICsraSkgewogICAgICAgICAgICAgIGludm9rZXJGbkJvZHkgKz0gInZhciBhcmciICsgaSArICJXaXJlZCA9IGFyZ1R5cGUiICsgaSArICIudG9XaXJlVHlwZSgiICsgZHRvclN0YWNrICsgIiwgYXJnIiArIGkgKyAiKTsgLy8gIiArIGFyZ1R5cGVzW2kgKyAyXS5uYW1lICsgIlxuIjsKICAgICAgICAgICAgICBhcmdzMS5wdXNoKCJhcmdUeXBlIiArIGkpOwogICAgICAgICAgICAgIGFyZ3MyLnB1c2goYXJnVHlwZXNbaSArIDJdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNDbGFzc01ldGhvZEZ1bmMpIHsKICAgICAgICAgICAgICBhcmdzTGlzdFdpcmVkID0gInRoaXNXaXJlZCIgKyAoYXJnc0xpc3RXaXJlZC5sZW5ndGggPiAwID8gIiwgIiA6ICIiKSArIGFyZ3NMaXN0V2lyZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW52b2tlckZuQm9keSArPSAocmV0dXJucyA/ICJ2YXIgcnYgPSAiIDogIiIpICsgImludm9rZXIoZm4iICsgKGFyZ3NMaXN0V2lyZWQubGVuZ3RoID4gMCA/ICIsICIgOiAiIikgKyBhcmdzTGlzdFdpcmVkICsgIik7XG4iOwogICAgICAgICAgICBpZiAobmVlZHNEZXN0cnVjdG9yU3RhY2spIHsKICAgICAgICAgICAgICBpbnZva2VyRm5Cb2R5ICs9ICJydW5EZXN0cnVjdG9ycyhkZXN0cnVjdG9ycyk7XG4iOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSBpc0NsYXNzTWV0aG9kRnVuYyA/IDEgOiAyOyBpIDwgYXJnVHlwZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIHZhciBwYXJhbU5hbWUgPSBpID09PSAxID8gInRoaXNXaXJlZCIgOiAiYXJnIiArIChpIC0gMikgKyAiV2lyZWQiOwogICAgICAgICAgICAgICAgaWYgKGFyZ1R5cGVzW2ldLmRlc3RydWN0b3JGdW5jdGlvbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBpbnZva2VyRm5Cb2R5ICs9IHBhcmFtTmFtZSArICJfZHRvcigiICsgcGFyYW1OYW1lICsgIik7IC8vICIgKyBhcmdUeXBlc1tpXS5uYW1lICsgIlxuIjsKICAgICAgICAgICAgICAgICAgYXJnczEucHVzaChwYXJhbU5hbWUgKyAiX2R0b3IiKTsKICAgICAgICAgICAgICAgICAgYXJnczIucHVzaChhcmdUeXBlc1tpXS5kZXN0cnVjdG9yRnVuY3Rpb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmV0dXJucykgewogICAgICAgICAgICAgIGludm9rZXJGbkJvZHkgKz0gInZhciByZXQgPSByZXRUeXBlLmZyb21XaXJlVHlwZShydik7XG5yZXR1cm4gcmV0O1xuIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnZva2VyRm5Cb2R5ICs9ICJ9XG4iOwogICAgICAgICAgICBhcmdzMS5wdXNoKGludm9rZXJGbkJvZHkpOwogICAgICAgICAgICB2YXIgaW52b2tlckZ1bmN0aW9uID0gbmV3XyhGdW5jdGlvbiwgYXJnczEpLmFwcGx5KG51bGwsIGFyZ3MyKTsKICAgICAgICAgICAgcmV0dXJuIGludm9rZXJGdW5jdGlvbjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW1iaW5kX3JlZ2lzdGVyX2NsYXNzX2Z1bmN0aW9uKHJhd0NsYXNzVHlwZSwgbWV0aG9kTmFtZSwgYXJnQ291bnQsIHJhd0FyZ1R5cGVzQWRkciwgaW52b2tlclNpZ25hdHVyZSwgcmF3SW52b2tlciwgY29udGV4dCwgaXNQdXJlVmlydHVhbCkgewogICAgICAgICAgICB2YXIgcmF3QXJnVHlwZXMgPSBoZWFwMzJWZWN0b3JUb0FycmF5KGFyZ0NvdW50LCByYXdBcmdUeXBlc0FkZHIpOwogICAgICAgICAgICBtZXRob2ROYW1lID0gcmVhZExhdGluMVN0cmluZyhtZXRob2ROYW1lKTsKICAgICAgICAgICAgcmF3SW52b2tlciA9IGVtYmluZF9fcmVxdWlyZUZ1bmN0aW9uKGludm9rZXJTaWduYXR1cmUsIHJhd0ludm9rZXIpOwogICAgICAgICAgICB3aGVuRGVwZW5kZW50VHlwZXNBcmVSZXNvbHZlZChbXSwgW3Jhd0NsYXNzVHlwZV0sIGZ1bmN0aW9uKGNsYXNzVHlwZSkgewogICAgICAgICAgICAgIGNsYXNzVHlwZSA9IGNsYXNzVHlwZVswXTsKICAgICAgICAgICAgICB2YXIgaHVtYW5OYW1lID0gY2xhc3NUeXBlLm5hbWUgKyAiLiIgKyBtZXRob2ROYW1lOwogICAgICAgICAgICAgIGlmIChpc1B1cmVWaXJ0dWFsKSB7CiAgICAgICAgICAgICAgICBjbGFzc1R5cGUucmVnaXN0ZXJlZENsYXNzLnB1cmVWaXJ0dWFsRnVuY3Rpb25zLnB1c2gobWV0aG9kTmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZ1bmN0aW9uIHVuYm91bmRUeXBlc0hhbmRsZXIoKSB7CiAgICAgICAgICAgICAgICB0aHJvd1VuYm91bmRUeXBlRXJyb3IoIkNhbm5vdCBjYWxsICIgKyBodW1hbk5hbWUgKyAiIGR1ZSB0byB1bmJvdW5kIHR5cGVzIiwgcmF3QXJnVHlwZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcHJvdG8gPSBjbGFzc1R5cGUucmVnaXN0ZXJlZENsYXNzLmluc3RhbmNlUHJvdG90eXBlOwogICAgICAgICAgICAgIHZhciBtZXRob2QgPSBwcm90b1ttZXRob2ROYW1lXTsKICAgICAgICAgICAgICBpZiAodm9pZCAwID09PSBtZXRob2QgfHwgdm9pZCAwID09PSBtZXRob2Qub3ZlcmxvYWRUYWJsZSAmJiBtZXRob2QuY2xhc3NOYW1lICE9PSBjbGFzc1R5cGUubmFtZSAmJiBtZXRob2QuYXJnQ291bnQgPT09IGFyZ0NvdW50IC0gMikgewogICAgICAgICAgICAgICAgdW5ib3VuZFR5cGVzSGFuZGxlci5hcmdDb3VudCA9IGFyZ0NvdW50IC0gMjsKICAgICAgICAgICAgICAgIHVuYm91bmRUeXBlc0hhbmRsZXIuY2xhc3NOYW1lID0gY2xhc3NUeXBlLm5hbWU7CiAgICAgICAgICAgICAgICBwcm90b1ttZXRob2ROYW1lXSA9IHVuYm91bmRUeXBlc0hhbmRsZXI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVuc3VyZU92ZXJsb2FkVGFibGUocHJvdG8sIG1ldGhvZE5hbWUsIGh1bWFuTmFtZSk7CiAgICAgICAgICAgICAgICBwcm90b1ttZXRob2ROYW1lXS5vdmVybG9hZFRhYmxlW2FyZ0NvdW50IC0gMl0gPSB1bmJvdW5kVHlwZXNIYW5kbGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGVuRGVwZW5kZW50VHlwZXNBcmVSZXNvbHZlZChbXSwgcmF3QXJnVHlwZXMsIGZ1bmN0aW9uKGFyZ1R5cGVzKSB7CiAgICAgICAgICAgICAgICB2YXIgbWVtYmVyRnVuY3Rpb24gPSBjcmFmdEludm9rZXJGdW5jdGlvbihodW1hbk5hbWUsIGFyZ1R5cGVzLCBjbGFzc1R5cGUsIHJhd0ludm9rZXIsIGNvbnRleHQpOwogICAgICAgICAgICAgICAgaWYgKHZvaWQgMCA9PT0gcHJvdG9bbWV0aG9kTmFtZV0ub3ZlcmxvYWRUYWJsZSkgewogICAgICAgICAgICAgICAgICBtZW1iZXJGdW5jdGlvbi5hcmdDb3VudCA9IGFyZ0NvdW50IC0gMjsKICAgICAgICAgICAgICAgICAgcHJvdG9bbWV0aG9kTmFtZV0gPSBtZW1iZXJGdW5jdGlvbjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHByb3RvW21ldGhvZE5hbWVdLm92ZXJsb2FkVGFibGVbYXJnQ291bnQgLSAyXSA9IG1lbWJlckZ1bmN0aW9uOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl9jb25zdGFudChuYW1lLCB0eXBlLCB2YWx1ZSkgewogICAgICAgICAgICBuYW1lID0gcmVhZExhdGluMVN0cmluZyhuYW1lKTsKICAgICAgICAgICAgd2hlbkRlcGVuZGVudFR5cGVzQXJlUmVzb2x2ZWQoW10sIFt0eXBlXSwgZnVuY3Rpb24odHlwZTIpIHsKICAgICAgICAgICAgICB0eXBlMiA9IHR5cGUyWzBdOwogICAgICAgICAgICAgIE1vZHVsZVtuYW1lXSA9IHR5cGUyWyJmcm9tV2lyZVR5cGUiXSh2YWx1ZSk7CiAgICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBlbXZhbF9mcmVlX2xpc3QgPSBbXTsKICAgICAgICAgIHZhciBlbXZhbF9oYW5kbGVfYXJyYXkgPSBbe30sIHsgdmFsdWU6IHZvaWQgMCB9LCB7IHZhbHVlOiBudWxsIH0sIHsgdmFsdWU6IHRydWUgfSwgeyB2YWx1ZTogZmFsc2UgfV07CiAgICAgICAgICBmdW5jdGlvbiBfX2VtdmFsX2RlY3JlZihoYW5kbGUpIHsKICAgICAgICAgICAgaWYgKGhhbmRsZSA+IDQgJiYgMCA9PT0gLS1lbXZhbF9oYW5kbGVfYXJyYXlbaGFuZGxlXS5yZWZjb3VudCkgewogICAgICAgICAgICAgIGVtdmFsX2hhbmRsZV9hcnJheVtoYW5kbGVdID0gdm9pZCAwOwogICAgICAgICAgICAgIGVtdmFsX2ZyZWVfbGlzdC5wdXNoKGhhbmRsZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNvdW50X2VtdmFsX2hhbmRsZXMoKSB7CiAgICAgICAgICAgIHZhciBjb3VudCA9IDA7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSA1OyBpIDwgZW12YWxfaGFuZGxlX2FycmF5Lmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgaWYgKGVtdmFsX2hhbmRsZV9hcnJheVtpXSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICArK2NvdW50OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY291bnQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRfZmlyc3RfZW12YWwoKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSA1OyBpIDwgZW12YWxfaGFuZGxlX2FycmF5Lmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgaWYgKGVtdmFsX2hhbmRsZV9hcnJheVtpXSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZW12YWxfaGFuZGxlX2FycmF5W2ldOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGluaXRfZW12YWwoKSB7CiAgICAgICAgICAgIE1vZHVsZVsiY291bnRfZW12YWxfaGFuZGxlcyJdID0gY291bnRfZW12YWxfaGFuZGxlczsKICAgICAgICAgICAgTW9kdWxlWyJnZXRfZmlyc3RfZW12YWwiXSA9IGdldF9maXJzdF9lbXZhbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW12YWxfcmVnaXN0ZXIodmFsdWUpIHsKICAgICAgICAgICAgc3dpdGNoICh2YWx1ZSkgewogICAgICAgICAgICAgIGNhc2Ugdm9pZCAwOiB7CiAgICAgICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBudWxsOiB7CiAgICAgICAgICAgICAgICByZXR1cm4gMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSB0cnVlOiB7CiAgICAgICAgICAgICAgICByZXR1cm4gMzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBmYWxzZTogewogICAgICAgICAgICAgICAgcmV0dXJuIDQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICAgIHZhciBoYW5kbGUgPSBlbXZhbF9mcmVlX2xpc3QubGVuZ3RoID8gZW12YWxfZnJlZV9saXN0LnBvcCgpIDogZW12YWxfaGFuZGxlX2FycmF5Lmxlbmd0aDsKICAgICAgICAgICAgICAgIGVtdmFsX2hhbmRsZV9hcnJheVtoYW5kbGVdID0geyByZWZjb3VudDogMSwgdmFsdWUgfTsKICAgICAgICAgICAgICAgIHJldHVybiBoYW5kbGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl9lbXZhbChyYXdUeXBlLCBuYW1lKSB7CiAgICAgICAgICAgIG5hbWUgPSByZWFkTGF0aW4xU3RyaW5nKG5hbWUpOwogICAgICAgICAgICByZWdpc3RlclR5cGUocmF3VHlwZSwgeyBuYW1lLCAiZnJvbVdpcmVUeXBlIjogZnVuY3Rpb24oaGFuZGxlKSB7CiAgICAgICAgICAgICAgdmFyIHJ2ID0gZW12YWxfaGFuZGxlX2FycmF5W2hhbmRsZV0udmFsdWU7CiAgICAgICAgICAgICAgX19lbXZhbF9kZWNyZWYoaGFuZGxlKTsKICAgICAgICAgICAgICByZXR1cm4gcnY7CiAgICAgICAgICAgIH0sICJ0b1dpcmVUeXBlIjogZnVuY3Rpb24oZGVzdHJ1Y3RvcnMsIHZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIF9fZW12YWxfcmVnaXN0ZXIodmFsdWUpOwogICAgICAgICAgICB9LCAiYXJnUGFja0FkdmFuY2UiOiA4LCAicmVhZFZhbHVlRnJvbVBvaW50ZXIiOiBzaW1wbGVSZWFkVmFsdWVGcm9tUG9pbnRlciwgZGVzdHJ1Y3RvckZ1bmN0aW9uOiBudWxsIH0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZW51bVJlYWRWYWx1ZUZyb21Qb2ludGVyKG5hbWUsIHNoaWZ0LCBzaWduZWQpIHsKICAgICAgICAgICAgc3dpdGNoIChzaGlmdCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihwb2ludGVyKSB7CiAgICAgICAgICAgICAgICAgIHZhciBoZWFwID0gc2lnbmVkID8gSEVBUDggOiBIRUFQVTg7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzWyJmcm9tV2lyZVR5cGUiXShoZWFwW3BvaW50ZXJdKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHBvaW50ZXIpIHsKICAgICAgICAgICAgICAgICAgdmFyIGhlYXAgPSBzaWduZWQgPyBIRUFQMTYgOiBIRUFQVTE2OwogICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1siZnJvbVdpcmVUeXBlIl0oaGVhcFtwb2ludGVyID4+IDFdKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHBvaW50ZXIpIHsKICAgICAgICAgICAgICAgICAgdmFyIGhlYXAgPSBzaWduZWQgPyBIRUFQMzIgOiBIRUFQVTMyOwogICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1siZnJvbVdpcmVUeXBlIl0oaGVhcFtwb2ludGVyID4+IDJdKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlVua25vd24gaW50ZWdlciB0eXBlOiAiICsgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW1iaW5kX3JlZ2lzdGVyX2VudW0ocmF3VHlwZSwgbmFtZSwgc2l6ZSwgaXNTaWduZWQpIHsKICAgICAgICAgICAgdmFyIHNoaWZ0ID0gZ2V0U2hpZnRGcm9tU2l6ZShzaXplKTsKICAgICAgICAgICAgbmFtZSA9IHJlYWRMYXRpbjFTdHJpbmcobmFtZSk7CiAgICAgICAgICAgIGZ1bmN0aW9uIGN0b3IoKSB7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3Rvci52YWx1ZXMgPSB7fTsKICAgICAgICAgICAgcmVnaXN0ZXJUeXBlKHJhd1R5cGUsIHsgbmFtZSwgY29uc3RydWN0b3I6IGN0b3IsICJmcm9tV2lyZVR5cGUiOiBmdW5jdGlvbihjKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3IudmFsdWVzW2NdOwogICAgICAgICAgICB9LCAidG9XaXJlVHlwZSI6IGZ1bmN0aW9uKGRlc3RydWN0b3JzLCBjKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGMudmFsdWU7CiAgICAgICAgICAgIH0sICJhcmdQYWNrQWR2YW5jZSI6IDgsICJyZWFkVmFsdWVGcm9tUG9pbnRlciI6IGVudW1SZWFkVmFsdWVGcm9tUG9pbnRlcihuYW1lLCBzaGlmdCwgaXNTaWduZWQpLCBkZXN0cnVjdG9yRnVuY3Rpb246IG51bGwgfSk7CiAgICAgICAgICAgIGV4cG9zZVB1YmxpY1N5bWJvbChuYW1lLCBjdG9yKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlcXVpcmVSZWdpc3RlcmVkVHlwZShyYXdUeXBlLCBodW1hbk5hbWUpIHsKICAgICAgICAgICAgdmFyIGltcGwgPSByZWdpc3RlcmVkVHlwZXNbcmF3VHlwZV07CiAgICAgICAgICAgIGlmICh2b2lkIDAgPT09IGltcGwpIHsKICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcihodW1hbk5hbWUgKyAiIGhhcyB1bmtub3duIHR5cGUgIiArIGdldFR5cGVOYW1lKHJhd1R5cGUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaW1wbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW1iaW5kX3JlZ2lzdGVyX2VudW1fdmFsdWUocmF3RW51bVR5cGUsIG5hbWUsIGVudW1WYWx1ZSkgewogICAgICAgICAgICB2YXIgZW51bVR5cGUgPSByZXF1aXJlUmVnaXN0ZXJlZFR5cGUocmF3RW51bVR5cGUsICJlbnVtIik7CiAgICAgICAgICAgIG5hbWUgPSByZWFkTGF0aW4xU3RyaW5nKG5hbWUpOwogICAgICAgICAgICB2YXIgRW51bSA9IGVudW1UeXBlLmNvbnN0cnVjdG9yOwogICAgICAgICAgICB2YXIgVmFsdWUgPSBPYmplY3QuY3JlYXRlKGVudW1UeXBlLmNvbnN0cnVjdG9yLnByb3RvdHlwZSwgeyB2YWx1ZTogeyB2YWx1ZTogZW51bVZhbHVlIH0sIGNvbnN0cnVjdG9yOiB7IHZhbHVlOiBjcmVhdGVOYW1lZEZ1bmN0aW9uKGVudW1UeXBlLm5hbWUgKyAiXyIgKyBuYW1lLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgfSkgfSB9KTsKICAgICAgICAgICAgRW51bS52YWx1ZXNbZW51bVZhbHVlXSA9IFZhbHVlOwogICAgICAgICAgICBFbnVtW25hbWVdID0gVmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfZW1iaW5kX3JlcHIodjMpIHsKICAgICAgICAgICAgaWYgKHYzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJudWxsIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdCA9IHR5cGVvZiB2MzsKICAgICAgICAgICAgaWYgKHQgPT09ICJvYmplY3QiIHx8IHQgPT09ICJhcnJheSIgfHwgdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHJldHVybiB2My50b1N0cmluZygpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiAiIiArIHYzOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBmbG9hdFJlYWRWYWx1ZUZyb21Qb2ludGVyKG5hbWUsIHNoaWZ0KSB7CiAgICAgICAgICAgIHN3aXRjaCAoc2hpZnQpIHsKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24ocG9pbnRlcikgewogICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1siZnJvbVdpcmVUeXBlIl0oSEVBUEYzMltwb2ludGVyID4+IDJdKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHBvaW50ZXIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbImZyb21XaXJlVHlwZSJdKEhFQVBGNjRbcG9pbnRlciA+PiAzXSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJVbmtub3duIGZsb2F0IHR5cGU6ICIgKyBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfcmVnaXN0ZXJfZmxvYXQocmF3VHlwZSwgbmFtZSwgc2l6ZSkgewogICAgICAgICAgICB2YXIgc2hpZnQgPSBnZXRTaGlmdEZyb21TaXplKHNpemUpOwogICAgICAgICAgICBuYW1lID0gcmVhZExhdGluMVN0cmluZyhuYW1lKTsKICAgICAgICAgICAgcmVnaXN0ZXJUeXBlKHJhd1R5cGUsIHsgbmFtZSwgImZyb21XaXJlVHlwZSI6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9LCAidG9XaXJlVHlwZSI6IGZ1bmN0aW9uKGRlc3RydWN0b3JzLCB2YWx1ZSkgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICJudW1iZXIiICYmIHR5cGVvZiB2YWx1ZSAhPT0gImJvb2xlYW4iKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY29udmVydCAiJyArIF9lbWJpbmRfcmVwcih2YWx1ZSkgKyAnIiB0byAnICsgdGhpcy5uYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9LCAiYXJnUGFja0FkdmFuY2UiOiA4LCAicmVhZFZhbHVlRnJvbVBvaW50ZXIiOiBmbG9hdFJlYWRWYWx1ZUZyb21Qb2ludGVyKG5hbWUsIHNoaWZ0KSwgZGVzdHJ1Y3RvckZ1bmN0aW9uOiBudWxsIH0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfcmVnaXN0ZXJfZnVuY3Rpb24obmFtZSwgYXJnQ291bnQsIHJhd0FyZ1R5cGVzQWRkciwgc2lnbmF0dXJlLCByYXdJbnZva2VyLCBmbikgewogICAgICAgICAgICB2YXIgYXJnVHlwZXMgPSBoZWFwMzJWZWN0b3JUb0FycmF5KGFyZ0NvdW50LCByYXdBcmdUeXBlc0FkZHIpOwogICAgICAgICAgICBuYW1lID0gcmVhZExhdGluMVN0cmluZyhuYW1lKTsKICAgICAgICAgICAgcmF3SW52b2tlciA9IGVtYmluZF9fcmVxdWlyZUZ1bmN0aW9uKHNpZ25hdHVyZSwgcmF3SW52b2tlcik7CiAgICAgICAgICAgIGV4cG9zZVB1YmxpY1N5bWJvbChuYW1lLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aHJvd1VuYm91bmRUeXBlRXJyb3IoIkNhbm5vdCBjYWxsICIgKyBuYW1lICsgIiBkdWUgdG8gdW5ib3VuZCB0eXBlcyIsIGFyZ1R5cGVzKTsKICAgICAgICAgICAgfSwgYXJnQ291bnQgLSAxKTsKICAgICAgICAgICAgd2hlbkRlcGVuZGVudFR5cGVzQXJlUmVzb2x2ZWQoW10sIGFyZ1R5cGVzLCBmdW5jdGlvbihhcmdUeXBlczIpIHsKICAgICAgICAgICAgICB2YXIgaW52b2tlckFyZ3NBcnJheSA9IFthcmdUeXBlczJbMF0sIG51bGxdLmNvbmNhdChhcmdUeXBlczIuc2xpY2UoMSkpOwogICAgICAgICAgICAgIHJlcGxhY2VQdWJsaWNTeW1ib2wobmFtZSwgY3JhZnRJbnZva2VyRnVuY3Rpb24obmFtZSwgaW52b2tlckFyZ3NBcnJheSwgbnVsbCwgcmF3SW52b2tlciwgZm4pLCBhcmdDb3VudCAtIDEpOwogICAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpbnRlZ2VyUmVhZFZhbHVlRnJvbVBvaW50ZXIobmFtZSwgc2hpZnQsIHNpZ25lZCkgewogICAgICAgICAgICBzd2l0Y2ggKHNoaWZ0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgcmV0dXJuIHNpZ25lZCA/IGZ1bmN0aW9uIHJlYWRTOEZyb21Qb2ludGVyKHBvaW50ZXIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIEhFQVA4W3BvaW50ZXJdOwogICAgICAgICAgICAgICAgfSA6IGZ1bmN0aW9uIHJlYWRVOEZyb21Qb2ludGVyKHBvaW50ZXIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIEhFQVBVOFtwb2ludGVyXTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgcmV0dXJuIHNpZ25lZCA/IGZ1bmN0aW9uIHJlYWRTMTZGcm9tUG9pbnRlcihwb2ludGVyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBIRUFQMTZbcG9pbnRlciA+PiAxXTsKICAgICAgICAgICAgICAgIH0gOiBmdW5jdGlvbiByZWFkVTE2RnJvbVBvaW50ZXIocG9pbnRlcikgewogICAgICAgICAgICAgICAgICByZXR1cm4gSEVBUFUxNltwb2ludGVyID4+IDFdOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICByZXR1cm4gc2lnbmVkID8gZnVuY3Rpb24gcmVhZFMzMkZyb21Qb2ludGVyKHBvaW50ZXIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIEhFQVAzMltwb2ludGVyID4+IDJdOwogICAgICAgICAgICAgICAgfSA6IGZ1bmN0aW9uIHJlYWRVMzJGcm9tUG9pbnRlcihwb2ludGVyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBIRUFQVTMyW3BvaW50ZXIgPj4gMl07CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJVbmtub3duIGludGVnZXIgdHlwZTogIiArIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl9pbnRlZ2VyKHByaW1pdGl2ZVR5cGUsIG5hbWUsIHNpemUsIG1pblJhbmdlLCBtYXhSYW5nZSkgewogICAgICAgICAgICBuYW1lID0gcmVhZExhdGluMVN0cmluZyhuYW1lKTsKICAgICAgICAgICAgaWYgKG1heFJhbmdlID09PSAtMSkgewogICAgICAgICAgICAgIG1heFJhbmdlID0gNDI5NDk2NzI5NTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2hpZnQgPSBnZXRTaGlmdEZyb21TaXplKHNpemUpOwogICAgICAgICAgICB2YXIgZnJvbVdpcmVUeXBlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmIChtaW5SYW5nZSA9PT0gMCkgewogICAgICAgICAgICAgIHZhciBiaXRzaGlmdCA9IDMyIC0gOCAqIHNpemU7CiAgICAgICAgICAgICAgZnJvbVdpcmVUeXBlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA8PCBiaXRzaGlmdCA+Pj4gYml0c2hpZnQ7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaXNVbnNpZ25lZFR5cGUgPSBuYW1lLmluZGV4T2YoInVuc2lnbmVkIikgIT0gLTE7CiAgICAgICAgICAgIHJlZ2lzdGVyVHlwZShwcmltaXRpdmVUeXBlLCB7IG5hbWUsICJmcm9tV2lyZVR5cGUiOiBmcm9tV2lyZVR5cGUsICJ0b1dpcmVUeXBlIjogZnVuY3Rpb24oZGVzdHJ1Y3RvcnMsIHZhbHVlKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gIm51bWJlciIgJiYgdHlwZW9mIHZhbHVlICE9PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjb252ZXJ0ICInICsgX2VtYmluZF9yZXByKHZhbHVlKSArICciIHRvICcgKyB0aGlzLm5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodmFsdWUgPCBtaW5SYW5nZSB8fCB2YWx1ZSA+IG1heFJhbmdlKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdQYXNzaW5nIGEgbnVtYmVyICInICsgX2VtYmluZF9yZXByKHZhbHVlKSArICciIGZyb20gSlMgc2lkZSB0byBDL0MrKyBzaWRlIHRvIGFuIGFyZ3VtZW50IG9mIHR5cGUgIicgKyBuYW1lICsgJyIsIHdoaWNoIGlzIG91dHNpZGUgdGhlIHZhbGlkIHJhbmdlIFsnICsgbWluUmFuZ2UgKyAiLCAiICsgbWF4UmFuZ2UgKyAiXSEiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGlzVW5zaWduZWRUeXBlID8gdmFsdWUgPj4+IDAgOiB2YWx1ZSB8IDA7CiAgICAgICAgICAgIH0sICJhcmdQYWNrQWR2YW5jZSI6IDgsICJyZWFkVmFsdWVGcm9tUG9pbnRlciI6IGludGVnZXJSZWFkVmFsdWVGcm9tUG9pbnRlcihuYW1lLCBzaGlmdCwgbWluUmFuZ2UgIT09IDApLCBkZXN0cnVjdG9yRnVuY3Rpb246IG51bGwgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl9tZW1vcnlfdmlldyhyYXdUeXBlLCBkYXRhVHlwZUluZGV4LCBuYW1lKSB7CiAgICAgICAgICAgIHZhciB0eXBlTWFwcGluZyA9IFtJbnQ4QXJyYXksIFVpbnQ4QXJyYXksIEludDE2QXJyYXksIFVpbnQxNkFycmF5LCBJbnQzMkFycmF5LCBVaW50MzJBcnJheSwgRmxvYXQzMkFycmF5LCBGbG9hdDY0QXJyYXldOwogICAgICAgICAgICB2YXIgVEEgPSB0eXBlTWFwcGluZ1tkYXRhVHlwZUluZGV4XTsKICAgICAgICAgICAgZnVuY3Rpb24gZGVjb2RlTWVtb3J5VmlldyhoYW5kbGUpIHsKICAgICAgICAgICAgICBoYW5kbGUgPSBoYW5kbGUgPj4gMjsKICAgICAgICAgICAgICB2YXIgaGVhcCA9IEhFQVBVMzI7CiAgICAgICAgICAgICAgdmFyIHNpemUgPSBoZWFwW2hhbmRsZV07CiAgICAgICAgICAgICAgdmFyIGRhdGEgPSBoZWFwW2hhbmRsZSArIDFdOwogICAgICAgICAgICAgIHJldHVybiBuZXcgVEEoYnVmZmVyLCBkYXRhLCBzaXplKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBuYW1lID0gcmVhZExhdGluMVN0cmluZyhuYW1lKTsKICAgICAgICAgICAgcmVnaXN0ZXJUeXBlKHJhd1R5cGUsIHsgbmFtZSwgImZyb21XaXJlVHlwZSI6IGRlY29kZU1lbW9yeVZpZXcsICJhcmdQYWNrQWR2YW5jZSI6IDgsICJyZWFkVmFsdWVGcm9tUG9pbnRlciI6IGRlY29kZU1lbW9yeVZpZXcgfSwgeyBpZ25vcmVEdXBsaWNhdGVSZWdpc3RyYXRpb25zOiB0cnVlIH0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfcmVnaXN0ZXJfc3RkX3N0cmluZyhyYXdUeXBlLCBuYW1lKSB7CiAgICAgICAgICAgIG5hbWUgPSByZWFkTGF0aW4xU3RyaW5nKG5hbWUpOwogICAgICAgICAgICB2YXIgc3RkU3RyaW5nSXNVVEY4ID0gbmFtZSA9PT0gInN0ZDo6c3RyaW5nIjsKICAgICAgICAgICAgcmVnaXN0ZXJUeXBlKHJhd1R5cGUsIHsgbmFtZSwgImZyb21XaXJlVHlwZSI6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgdmFyIGxlbmd0aCA9IEhFQVBVMzJbdmFsdWUgPj4gMl07CiAgICAgICAgICAgICAgdmFyIHN0cjsKICAgICAgICAgICAgICBpZiAoc3RkU3RyaW5nSXNVVEY4KSB7CiAgICAgICAgICAgICAgICB2YXIgZGVjb2RlU3RhcnRQdHIgPSB2YWx1ZSArIDQ7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8PSBsZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudEJ5dGVQdHIgPSB2YWx1ZSArIDQgKyBpOwogICAgICAgICAgICAgICAgICBpZiAoaSA9PSBsZW5ndGggfHwgSEVBUFU4W2N1cnJlbnRCeXRlUHRyXSA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1heFJlYWQgPSBjdXJyZW50Qnl0ZVB0ciAtIGRlY29kZVN0YXJ0UHRyOwogICAgICAgICAgICAgICAgICAgIHZhciBzdHJpbmdTZWdtZW50ID0gVVRGOFRvU3RyaW5nKGRlY29kZVN0YXJ0UHRyLCBtYXhSZWFkKTsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RyID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICAgIHN0ciA9IHN0cmluZ1NlZ21lbnQ7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDApOwogICAgICAgICAgICAgICAgICAgICAgc3RyICs9IHN0cmluZ1NlZ21lbnQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGRlY29kZVN0YXJ0UHRyID0gY3VycmVudEJ5dGVQdHIgKyAxOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBhMyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgICBhM1tpXSA9IFN0cmluZy5mcm9tQ2hhckNvZGUoSEVBUFU4W3ZhbHVlICsgNCArIGldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0ciA9IGEzLmpvaW4oIiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBfZnJlZSh2YWx1ZSk7CiAgICAgICAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgICAgICAgfSwgInRvV2lyZVR5cGUiOiBmdW5jdGlvbihkZXN0cnVjdG9ycywgdmFsdWUpIHsKICAgICAgICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgewogICAgICAgICAgICAgICAgdmFsdWUgPSBuZXcgVWludDhBcnJheSh2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBnZXRMZW5ndGg7CiAgICAgICAgICAgICAgdmFyIHZhbHVlSXNPZlR5cGVTdHJpbmcgPSB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciOwogICAgICAgICAgICAgIGlmICghKHZhbHVlSXNPZlR5cGVTdHJpbmcgfHwgdmFsdWUgaW5zdGFuY2VvZiBVaW50OEFycmF5IHx8IHZhbHVlIGluc3RhbmNlb2YgVWludDhDbGFtcGVkQXJyYXkgfHwgdmFsdWUgaW5zdGFuY2VvZiBJbnQ4QXJyYXkpKSB7CiAgICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiQ2Fubm90IHBhc3Mgbm9uLXN0cmluZyB0byBzdGQ6OnN0cmluZyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc3RkU3RyaW5nSXNVVEY4ICYmIHZhbHVlSXNPZlR5cGVTdHJpbmcpIHsKICAgICAgICAgICAgICAgIGdldExlbmd0aCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbGVuZ3RoQnl0ZXNVVEY4KHZhbHVlKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGdldExlbmd0aCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUubGVuZ3RoOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGxlbmd0aCA9IGdldExlbmd0aCgpOwogICAgICAgICAgICAgIHZhciBwdHIgPSBfbWFsbG9jKDQgKyBsZW5ndGggKyAxKTsKICAgICAgICAgICAgICBIRUFQVTMyW3B0ciA+PiAyXSA9IGxlbmd0aDsKICAgICAgICAgICAgICBpZiAoc3RkU3RyaW5nSXNVVEY4ICYmIHZhbHVlSXNPZlR5cGVTdHJpbmcpIHsKICAgICAgICAgICAgICAgIHN0cmluZ1RvVVRGOCh2YWx1ZSwgcHRyICsgNCwgbGVuZ3RoICsgMSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh2YWx1ZUlzT2ZUeXBlU3RyaW5nKSB7CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY2hhckNvZGUgPSB2YWx1ZS5jaGFyQ29kZUF0KGkpOwogICAgICAgICAgICAgICAgICAgIGlmIChjaGFyQ29kZSA+IDI1NSkgewogICAgICAgICAgICAgICAgICAgICAgX2ZyZWUocHRyKTsKICAgICAgICAgICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJTdHJpbmcgaGFzIFVURi0xNiBjb2RlIHVuaXRzIHRoYXQgZG8gbm90IGZpdCBpbiA4IGJpdHMiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgSEVBUFU4W3B0ciArIDQgKyBpXSA9IGNoYXJDb2RlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICAgICAgSEVBUFU4W3B0ciArIDQgKyBpXSA9IHZhbHVlW2ldOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChkZXN0cnVjdG9ycyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZGVzdHJ1Y3RvcnMucHVzaChfZnJlZSwgcHRyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHB0cjsKICAgICAgICAgICAgfSwgImFyZ1BhY2tBZHZhbmNlIjogOCwgInJlYWRWYWx1ZUZyb21Qb2ludGVyIjogc2ltcGxlUmVhZFZhbHVlRnJvbVBvaW50ZXIsIGRlc3RydWN0b3JGdW5jdGlvbjogZnVuY3Rpb24ocHRyKSB7CiAgICAgICAgICAgICAgX2ZyZWUocHRyKTsKICAgICAgICAgICAgfSB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW1iaW5kX3JlZ2lzdGVyX3N0ZF93c3RyaW5nKHJhd1R5cGUsIGNoYXJTaXplLCBuYW1lKSB7CiAgICAgICAgICAgIG5hbWUgPSByZWFkTGF0aW4xU3RyaW5nKG5hbWUpOwogICAgICAgICAgICB2YXIgZGVjb2RlU3RyaW5nLCBlbmNvZGVTdHJpbmcsIGdldEhlYXAsIGxlbmd0aEJ5dGVzVVRGLCBzaGlmdDsKICAgICAgICAgICAgaWYgKGNoYXJTaXplID09PSAyKSB7CiAgICAgICAgICAgICAgZGVjb2RlU3RyaW5nID0gVVRGMTZUb1N0cmluZzsKICAgICAgICAgICAgICBlbmNvZGVTdHJpbmcgPSBzdHJpbmdUb1VURjE2OwogICAgICAgICAgICAgIGxlbmd0aEJ5dGVzVVRGID0gbGVuZ3RoQnl0ZXNVVEYxNjsKICAgICAgICAgICAgICBnZXRIZWFwID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gSEVBUFUxNjsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHNoaWZ0ID0gMTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjaGFyU2l6ZSA9PT0gNCkgewogICAgICAgICAgICAgIGRlY29kZVN0cmluZyA9IFVURjMyVG9TdHJpbmc7CiAgICAgICAgICAgICAgZW5jb2RlU3RyaW5nID0gc3RyaW5nVG9VVEYzMjsKICAgICAgICAgICAgICBsZW5ndGhCeXRlc1VURiA9IGxlbmd0aEJ5dGVzVVRGMzI7CiAgICAgICAgICAgICAgZ2V0SGVhcCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIEhFQVBVMzI7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBzaGlmdCA9IDI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVnaXN0ZXJUeXBlKHJhd1R5cGUsIHsgbmFtZSwgImZyb21XaXJlVHlwZSI6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgdmFyIGxlbmd0aCA9IEhFQVBVMzJbdmFsdWUgPj4gMl07CiAgICAgICAgICAgICAgdmFyIEhFQVAgPSBnZXRIZWFwKCk7CiAgICAgICAgICAgICAgdmFyIHN0cjsKICAgICAgICAgICAgICB2YXIgZGVjb2RlU3RhcnRQdHIgPSB2YWx1ZSArIDQ7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPD0gbGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50Qnl0ZVB0ciA9IHZhbHVlICsgNCArIGkgKiBjaGFyU2l6ZTsKICAgICAgICAgICAgICAgIGlmIChpID09IGxlbmd0aCB8fCBIRUFQW2N1cnJlbnRCeXRlUHRyID4+IHNoaWZ0XSA9PSAwKSB7CiAgICAgICAgICAgICAgICAgIHZhciBtYXhSZWFkQnl0ZXMgPSBjdXJyZW50Qnl0ZVB0ciAtIGRlY29kZVN0YXJ0UHRyOwogICAgICAgICAgICAgICAgICB2YXIgc3RyaW5nU2VnbWVudCA9IGRlY29kZVN0cmluZyhkZWNvZGVTdGFydFB0ciwgbWF4UmVhZEJ5dGVzKTsKICAgICAgICAgICAgICAgICAgaWYgKHN0ciA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgc3RyID0gc3RyaW5nU2VnbWVudDsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgwKTsKICAgICAgICAgICAgICAgICAgICBzdHIgKz0gc3RyaW5nU2VnbWVudDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBkZWNvZGVTdGFydFB0ciA9IGN1cnJlbnRCeXRlUHRyICsgY2hhclNpemU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIF9mcmVlKHZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gc3RyOwogICAgICAgICAgICB9LCAidG9XaXJlVHlwZSI6IGZ1bmN0aW9uKGRlc3RydWN0b3JzLCB2YWx1ZSkgewogICAgICAgICAgICAgIGlmICghKHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIpKSB7CiAgICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiQ2Fubm90IHBhc3Mgbm9uLXN0cmluZyB0byBDKysgc3RyaW5nIHR5cGUgIiArIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbGVuZ3RoID0gbGVuZ3RoQnl0ZXNVVEYodmFsdWUpOwogICAgICAgICAgICAgIHZhciBwdHIgPSBfbWFsbG9jKDQgKyBsZW5ndGggKyBjaGFyU2l6ZSk7CiAgICAgICAgICAgICAgSEVBUFUzMltwdHIgPj4gMl0gPSBsZW5ndGggPj4gc2hpZnQ7CiAgICAgICAgICAgICAgZW5jb2RlU3RyaW5nKHZhbHVlLCBwdHIgKyA0LCBsZW5ndGggKyBjaGFyU2l6ZSk7CiAgICAgICAgICAgICAgaWYgKGRlc3RydWN0b3JzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBkZXN0cnVjdG9ycy5wdXNoKF9mcmVlLCBwdHIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcHRyOwogICAgICAgICAgICB9LCAiYXJnUGFja0FkdmFuY2UiOiA4LCAicmVhZFZhbHVlRnJvbVBvaW50ZXIiOiBzaW1wbGVSZWFkVmFsdWVGcm9tUG9pbnRlciwgZGVzdHJ1Y3RvckZ1bmN0aW9uOiBmdW5jdGlvbihwdHIpIHsKICAgICAgICAgICAgICBfZnJlZShwdHIpOwogICAgICAgICAgICB9IH0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfcmVnaXN0ZXJfdmFsdWVfb2JqZWN0KHJhd1R5cGUsIG5hbWUsIGNvbnN0cnVjdG9yU2lnbmF0dXJlLCByYXdDb25zdHJ1Y3RvciwgZGVzdHJ1Y3RvclNpZ25hdHVyZSwgcmF3RGVzdHJ1Y3RvcikgewogICAgICAgICAgICBzdHJ1Y3RSZWdpc3RyYXRpb25zW3Jhd1R5cGVdID0geyBuYW1lOiByZWFkTGF0aW4xU3RyaW5nKG5hbWUpLCByYXdDb25zdHJ1Y3RvcjogZW1iaW5kX19yZXF1aXJlRnVuY3Rpb24oY29uc3RydWN0b3JTaWduYXR1cmUsIHJhd0NvbnN0cnVjdG9yKSwgcmF3RGVzdHJ1Y3RvcjogZW1iaW5kX19yZXF1aXJlRnVuY3Rpb24oZGVzdHJ1Y3RvclNpZ25hdHVyZSwgcmF3RGVzdHJ1Y3RvciksIGZpZWxkczogW10gfTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW1iaW5kX3JlZ2lzdGVyX3ZhbHVlX29iamVjdF9maWVsZChzdHJ1Y3RUeXBlLCBmaWVsZE5hbWUsIGdldHRlclJldHVyblR5cGUsIGdldHRlclNpZ25hdHVyZSwgZ2V0dGVyLCBnZXR0ZXJDb250ZXh0LCBzZXR0ZXJBcmd1bWVudFR5cGUsIHNldHRlclNpZ25hdHVyZSwgc2V0dGVyLCBzZXR0ZXJDb250ZXh0KSB7CiAgICAgICAgICAgIHN0cnVjdFJlZ2lzdHJhdGlvbnNbc3RydWN0VHlwZV0uZmllbGRzLnB1c2goeyBmaWVsZE5hbWU6IHJlYWRMYXRpbjFTdHJpbmcoZmllbGROYW1lKSwgZ2V0dGVyUmV0dXJuVHlwZSwgZ2V0dGVyOiBlbWJpbmRfX3JlcXVpcmVGdW5jdGlvbihnZXR0ZXJTaWduYXR1cmUsIGdldHRlciksIGdldHRlckNvbnRleHQsIHNldHRlckFyZ3VtZW50VHlwZSwgc2V0dGVyOiBlbWJpbmRfX3JlcXVpcmVGdW5jdGlvbihzZXR0ZXJTaWduYXR1cmUsIHNldHRlciksIHNldHRlckNvbnRleHQgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl92b2lkKHJhd1R5cGUsIG5hbWUpIHsKICAgICAgICAgICAgbmFtZSA9IHJlYWRMYXRpbjFTdHJpbmcobmFtZSk7CiAgICAgICAgICAgIHJlZ2lzdGVyVHlwZShyYXdUeXBlLCB7IGlzVm9pZDogdHJ1ZSwgbmFtZSwgImFyZ1BhY2tBZHZhbmNlIjogMCwgImZyb21XaXJlVHlwZSI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICAgIH0sICJ0b1dpcmVUeXBlIjogZnVuY3Rpb24oZGVzdHJ1Y3RvcnMsIG8pIHsKICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgICB9IH0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVxdWlyZUhhbmRsZShoYW5kbGUpIHsKICAgICAgICAgICAgaWYgKCFoYW5kbGUpIHsKICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiQ2Fubm90IHVzZSBkZWxldGVkIHZhbC4gaGFuZGxlID0gIiArIGhhbmRsZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGVtdmFsX2hhbmRsZV9hcnJheVtoYW5kbGVdLnZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbXZhbF9hcyhoYW5kbGUsIHJldHVyblR5cGUsIGRlc3RydWN0b3JzUmVmKSB7CiAgICAgICAgICAgIGhhbmRsZSA9IHJlcXVpcmVIYW5kbGUoaGFuZGxlKTsKICAgICAgICAgICAgcmV0dXJuVHlwZSA9IHJlcXVpcmVSZWdpc3RlcmVkVHlwZShyZXR1cm5UeXBlLCAiZW12YWw6OmFzIik7CiAgICAgICAgICAgIHZhciBkZXN0cnVjdG9ycyA9IFtdOwogICAgICAgICAgICB2YXIgcmQgPSBfX2VtdmFsX3JlZ2lzdGVyKGRlc3RydWN0b3JzKTsKICAgICAgICAgICAgSEVBUDMyW2Rlc3RydWN0b3JzUmVmID4+IDJdID0gcmQ7CiAgICAgICAgICAgIHJldHVybiByZXR1cm5UeXBlWyJ0b1dpcmVUeXBlIl0oZGVzdHJ1Y3RvcnMsIGhhbmRsZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZW12YWxfc3ltYm9scyA9IHt9OwogICAgICAgICAgZnVuY3Rpb24gZ2V0U3RyaW5nT3JTeW1ib2woYWRkcmVzcykgewogICAgICAgICAgICB2YXIgc3ltYm9sID0gZW12YWxfc3ltYm9sc1thZGRyZXNzXTsKICAgICAgICAgICAgaWYgKHN5bWJvbCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRMYXRpbjFTdHJpbmcoYWRkcmVzcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIHN5bWJvbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGVtdmFsX21ldGhvZENhbGxlcnMgPSBbXTsKICAgICAgICAgIGZ1bmN0aW9uIF9fZW12YWxfY2FsbF92b2lkX21ldGhvZChjYWxsZXIsIGhhbmRsZSwgbWV0aG9kTmFtZSwgYXJncykgewogICAgICAgICAgICBjYWxsZXIgPSBlbXZhbF9tZXRob2RDYWxsZXJzW2NhbGxlcl07CiAgICAgICAgICAgIGhhbmRsZSA9IHJlcXVpcmVIYW5kbGUoaGFuZGxlKTsKICAgICAgICAgICAgbWV0aG9kTmFtZSA9IGdldFN0cmluZ09yU3ltYm9sKG1ldGhvZE5hbWUpOwogICAgICAgICAgICBjYWxsZXIoaGFuZGxlLCBtZXRob2ROYW1lLCBudWxsLCBhcmdzKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGVtdmFsX2dldF9nbG9iYWwoKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZ2xvYmFsVGhpcyA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2xvYmFsVGhpczsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gKC8qIEBfX1BVUkVfXyAqLyBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gRnVuY3Rpb247CiAgICAgICAgICAgIH0oKSkoInJldHVybiB0aGlzIikoKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW12YWxfZ2V0X2dsb2JhbChuYW1lKSB7CiAgICAgICAgICAgIGlmIChuYW1lID09PSAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIF9fZW12YWxfcmVnaXN0ZXIoZW12YWxfZ2V0X2dsb2JhbCgpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuYW1lID0gZ2V0U3RyaW5nT3JTeW1ib2wobmFtZSk7CiAgICAgICAgICAgICAgcmV0dXJuIF9fZW12YWxfcmVnaXN0ZXIoZW12YWxfZ2V0X2dsb2JhbCgpW25hbWVdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbXZhbF9hZGRNZXRob2RDYWxsZXIoY2FsbGVyKSB7CiAgICAgICAgICAgIHZhciBpZCA9IGVtdmFsX21ldGhvZENhbGxlcnMubGVuZ3RoOwogICAgICAgICAgICBlbXZhbF9tZXRob2RDYWxsZXJzLnB1c2goY2FsbGVyKTsKICAgICAgICAgICAgcmV0dXJuIGlkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbXZhbF9sb29rdXBUeXBlcyhhcmdDb3VudCwgYXJnVHlwZXMpIHsKICAgICAgICAgICAgdmFyIGEzID0gbmV3IEFycmF5KGFyZ0NvdW50KTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdDb3VudDsgKytpKSB7CiAgICAgICAgICAgICAgYTNbaV0gPSByZXF1aXJlUmVnaXN0ZXJlZFR5cGUoSEVBUDMyWyhhcmdUeXBlcyA+PiAyKSArIGldLCAicGFyYW1ldGVyICIgKyBpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYTM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtdmFsX2dldF9tZXRob2RfY2FsbGVyKGFyZ0NvdW50LCBhcmdUeXBlcykgewogICAgICAgICAgICB2YXIgdHlwZXMgPSBfX2VtdmFsX2xvb2t1cFR5cGVzKGFyZ0NvdW50LCBhcmdUeXBlcyk7CiAgICAgICAgICAgIHZhciByZXRUeXBlID0gdHlwZXNbMF07CiAgICAgICAgICAgIHZhciBzaWduYXR1cmVOYW1lID0gcmV0VHlwZS5uYW1lICsgIl8kIiArIHR5cGVzLnNsaWNlKDEpLm1hcChmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHQubmFtZTsKICAgICAgICAgICAgfSkuam9pbigiXyIpICsgIiQiOwogICAgICAgICAgICB2YXIgcGFyYW1zID0gWyJyZXRUeXBlIl07CiAgICAgICAgICAgIHZhciBhcmdzID0gW3JldFR5cGVdOwogICAgICAgICAgICB2YXIgYXJnc0xpc3QgPSAiIjsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdDb3VudCAtIDE7ICsraSkgewogICAgICAgICAgICAgIGFyZ3NMaXN0ICs9IChpICE9PSAwID8gIiwgIiA6ICIiKSArICJhcmciICsgaTsKICAgICAgICAgICAgICBwYXJhbXMucHVzaCgiYXJnVHlwZSIgKyBpKTsKICAgICAgICAgICAgICBhcmdzLnB1c2godHlwZXNbMSArIGldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZnVuY3Rpb25OYW1lID0gbWFrZUxlZ2FsRnVuY3Rpb25OYW1lKCJtZXRob2RDYWxsZXJfIiArIHNpZ25hdHVyZU5hbWUpOwogICAgICAgICAgICB2YXIgZnVuY3Rpb25Cb2R5ID0gInJldHVybiBmdW5jdGlvbiAiICsgZnVuY3Rpb25OYW1lICsgIihoYW5kbGUsIG5hbWUsIGRlc3RydWN0b3JzLCBhcmdzKSB7XG4iOwogICAgICAgICAgICB2YXIgb2Zmc2V0ID0gMDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdDb3VudCAtIDE7ICsraSkgewogICAgICAgICAgICAgIGZ1bmN0aW9uQm9keSArPSAiICAgIHZhciBhcmciICsgaSArICIgPSBhcmdUeXBlIiArIGkgKyAiLnJlYWRWYWx1ZUZyb21Qb2ludGVyKGFyZ3MiICsgKG9mZnNldCA/ICIrIiArIG9mZnNldCA6ICIiKSArICIpO1xuIjsKICAgICAgICAgICAgICBvZmZzZXQgKz0gdHlwZXNbaSArIDFdWyJhcmdQYWNrQWR2YW5jZSJdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uQm9keSArPSAiICAgIHZhciBydiA9IGhhbmRsZVtuYW1lXSgiICsgYXJnc0xpc3QgKyAiKTtcbiI7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJnQ291bnQgLSAxOyArK2kpIHsKICAgICAgICAgICAgICBpZiAodHlwZXNbaSArIDFdWyJkZWxldGVPYmplY3QiXSkgewogICAgICAgICAgICAgICAgZnVuY3Rpb25Cb2R5ICs9ICIgICAgYXJnVHlwZSIgKyBpICsgIi5kZWxldGVPYmplY3QoYXJnIiArIGkgKyAiKTtcbiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghcmV0VHlwZS5pc1ZvaWQpIHsKICAgICAgICAgICAgICBmdW5jdGlvbkJvZHkgKz0gIiAgICByZXR1cm4gcmV0VHlwZS50b1dpcmVUeXBlKGRlc3RydWN0b3JzLCBydik7XG4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uQm9keSArPSAifTtcbiI7CiAgICAgICAgICAgIHBhcmFtcy5wdXNoKGZ1bmN0aW9uQm9keSk7CiAgICAgICAgICAgIHZhciBpbnZva2VyRnVuY3Rpb24gPSBuZXdfKEZ1bmN0aW9uLCBwYXJhbXMpLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgICAgICAgICByZXR1cm4gX19lbXZhbF9hZGRNZXRob2RDYWxsZXIoaW52b2tlckZ1bmN0aW9uKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW12YWxfZ2V0X21vZHVsZV9wcm9wZXJ0eShuYW1lKSB7CiAgICAgICAgICAgIG5hbWUgPSBnZXRTdHJpbmdPclN5bWJvbChuYW1lKTsKICAgICAgICAgICAgcmV0dXJuIF9fZW12YWxfcmVnaXN0ZXIoTW9kdWxlW25hbWVdKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW12YWxfZ2V0X3Byb3BlcnR5KGhhbmRsZSwga2V5MikgewogICAgICAgICAgICBoYW5kbGUgPSByZXF1aXJlSGFuZGxlKGhhbmRsZSk7CiAgICAgICAgICAgIGtleTIgPSByZXF1aXJlSGFuZGxlKGtleTIpOwogICAgICAgICAgICByZXR1cm4gX19lbXZhbF9yZWdpc3RlcihoYW5kbGVba2V5Ml0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbXZhbF9pbmNyZWYoaGFuZGxlKSB7CiAgICAgICAgICAgIGlmIChoYW5kbGUgPiA0KSB7CiAgICAgICAgICAgICAgZW12YWxfaGFuZGxlX2FycmF5W2hhbmRsZV0ucmVmY291bnQgKz0gMTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY3JhZnRFbXZhbEFsbG9jYXRvcihhcmdDb3VudCkgewogICAgICAgICAgICB2YXIgYXJnc0xpc3QgPSAiIjsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdDb3VudDsgKytpKSB7CiAgICAgICAgICAgICAgYXJnc0xpc3QgKz0gKGkgIT09IDAgPyAiLCAiIDogIiIpICsgImFyZyIgKyBpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBmdW5jdGlvbkJvZHkgPSAicmV0dXJuIGZ1bmN0aW9uIGVtdmFsX2FsbG9jYXRvcl8iICsgYXJnQ291bnQgKyAiKGNvbnN0cnVjdG9yLCBhcmdUeXBlcywgYXJncykge1xuIjsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdDb3VudDsgKytpKSB7CiAgICAgICAgICAgICAgZnVuY3Rpb25Cb2R5ICs9ICJ2YXIgYXJnVHlwZSIgKyBpICsgIiA9IHJlcXVpcmVSZWdpc3RlcmVkVHlwZShNb2R1bGVbJ0hFQVAzMiddWyhhcmdUeXBlcyA+Pj4gMikgKyAiICsgaSArICddLCAicGFyYW1ldGVyICcgKyBpICsgJyIpO1xudmFyIGFyZycgKyBpICsgIiA9IGFyZ1R5cGUiICsgaSArICIucmVhZFZhbHVlRnJvbVBvaW50ZXIoYXJncyk7XG5hcmdzICs9IGFyZ1R5cGUiICsgaSArICJbJ2FyZ1BhY2tBZHZhbmNlJ107XG4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uQm9keSArPSAidmFyIG9iaiA9IG5ldyBjb25zdHJ1Y3RvcigiICsgYXJnc0xpc3QgKyAiKTtcbnJldHVybiBfX2VtdmFsX3JlZ2lzdGVyKG9iaik7XG59XG4iOwogICAgICAgICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKCJyZXF1aXJlUmVnaXN0ZXJlZFR5cGUiLCAiTW9kdWxlIiwgIl9fZW12YWxfcmVnaXN0ZXIiLCBmdW5jdGlvbkJvZHkpKHJlcXVpcmVSZWdpc3RlcmVkVHlwZSwgTW9kdWxlLCBfX2VtdmFsX3JlZ2lzdGVyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBlbXZhbF9uZXdlcnMgPSB7fTsKICAgICAgICAgIGZ1bmN0aW9uIF9fZW12YWxfbmV3KGhhbmRsZSwgYXJnQ291bnQsIGFyZ1R5cGVzLCBhcmdzKSB7CiAgICAgICAgICAgIGhhbmRsZSA9IHJlcXVpcmVIYW5kbGUoaGFuZGxlKTsKICAgICAgICAgICAgdmFyIG5ld2VyID0gZW12YWxfbmV3ZXJzW2FyZ0NvdW50XTsKICAgICAgICAgICAgaWYgKCFuZXdlcikgewogICAgICAgICAgICAgIG5ld2VyID0gY3JhZnRFbXZhbEFsbG9jYXRvcihhcmdDb3VudCk7CiAgICAgICAgICAgICAgZW12YWxfbmV3ZXJzW2FyZ0NvdW50XSA9IG5ld2VyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXdlcihoYW5kbGUsIGFyZ1R5cGVzLCBhcmdzKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW12YWxfbmV3X2NzdHJpbmcodjMpIHsKICAgICAgICAgICAgcmV0dXJuIF9fZW12YWxfcmVnaXN0ZXIoZ2V0U3RyaW5nT3JTeW1ib2wodjMpKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW12YWxfcnVuX2Rlc3RydWN0b3JzKGhhbmRsZSkgewogICAgICAgICAgICB2YXIgZGVzdHJ1Y3RvcnMgPSBlbXZhbF9oYW5kbGVfYXJyYXlbaGFuZGxlXS52YWx1ZTsKICAgICAgICAgICAgcnVuRGVzdHJ1Y3RvcnMoZGVzdHJ1Y3RvcnMpOwogICAgICAgICAgICBfX2VtdmFsX2RlY3JlZihoYW5kbGUpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX2Fib3J0KCkgewogICAgICAgICAgICBhYm9ydCgpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX2Vtc2NyaXB0ZW5fbWVtY3B5X2JpZyhkZXN0LCBzcmMsIG51bSkgewogICAgICAgICAgICBIRUFQVTguY29weVdpdGhpbihkZXN0LCBzcmMsIHNyYyArIG51bSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBlbXNjcmlwdGVuX3JlYWxsb2NfYnVmZmVyKHNpemUpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB3YXNtTWVtb3J5Lmdyb3coc2l6ZSAtIGJ1ZmZlci5ieXRlTGVuZ3RoICsgNjU1MzUgPj4+IDE2KTsKICAgICAgICAgICAgICB1cGRhdGVHbG9iYWxCdWZmZXJBbmRWaWV3cyh3YXNtTWVtb3J5LmJ1ZmZlcik7CiAgICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX2Vtc2NyaXB0ZW5fcmVzaXplX2hlYXAocmVxdWVzdGVkU2l6ZSkgewogICAgICAgICAgICB2YXIgb2xkU2l6ZSA9IEhFQVBVOC5sZW5ndGg7CiAgICAgICAgICAgIHJlcXVlc3RlZFNpemUgPSByZXF1ZXN0ZWRTaXplID4+PiAwOwogICAgICAgICAgICB2YXIgbWF4SGVhcFNpemUgPSAyMTQ3NDgzNjQ4OwogICAgICAgICAgICBpZiAocmVxdWVzdGVkU2l6ZSA+IG1heEhlYXBTaXplKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIGN1dERvd24gPSAxOyBjdXREb3duIDw9IDQ7IGN1dERvd24gKj0gMikgewogICAgICAgICAgICAgIHZhciBvdmVyR3Jvd25IZWFwU2l6ZSA9IG9sZFNpemUgKiAoMSArIDAuMiAvIGN1dERvd24pOwogICAgICAgICAgICAgIG92ZXJHcm93bkhlYXBTaXplID0gTWF0aC5taW4ob3Zlckdyb3duSGVhcFNpemUsIHJlcXVlc3RlZFNpemUgKyAxMDA2NjMyOTYpOwogICAgICAgICAgICAgIHZhciBuZXdTaXplID0gTWF0aC5taW4obWF4SGVhcFNpemUsIGFsaWduVXAoTWF0aC5tYXgocmVxdWVzdGVkU2l6ZSwgb3Zlckdyb3duSGVhcFNpemUpLCA2NTUzNikpOwogICAgICAgICAgICAgIHZhciByZXBsYWNlbWVudCA9IGVtc2NyaXB0ZW5fcmVhbGxvY19idWZmZXIobmV3U2l6ZSk7CiAgICAgICAgICAgICAgaWYgKHJlcGxhY2VtZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIFNZU0NBTExTID0geyBtYXBwaW5nczoge30sIGJ1ZmZlcnM6IFtudWxsLCBbXSwgW11dLCBwcmludENoYXI6IGZ1bmN0aW9uKHN0cmVhbSwgY3VycikgewogICAgICAgICAgICB2YXIgYnVmZmVyMiA9IFNZU0NBTExTLmJ1ZmZlcnNbc3RyZWFtXTsKICAgICAgICAgICAgaWYgKGN1cnIgPT09IDAgfHwgY3VyciA9PT0gMTApIHsKICAgICAgICAgICAgICAoc3RyZWFtID09PSAxID8gb3V0IDogZXJyKShVVEY4QXJyYXlUb1N0cmluZyhidWZmZXIyLCAwKSk7CiAgICAgICAgICAgICAgYnVmZmVyMi5sZW5ndGggPSAwOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGJ1ZmZlcjIucHVzaChjdXJyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwgdmFyYXJnczogdm9pZCAwLCBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBTWVNDQUxMUy52YXJhcmdzICs9IDQ7CiAgICAgICAgICAgIHZhciByZXQgPSBIRUFQMzJbU1lTQ0FMTFMudmFyYXJncyAtIDQgPj4gMl07CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICB9LCBnZXRTdHI6IGZ1bmN0aW9uKHB0cikgewogICAgICAgICAgICB2YXIgcmV0ID0gVVRGOFRvU3RyaW5nKHB0cik7CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICB9LCBnZXQ2NDogZnVuY3Rpb24obG93LCBoaWdoKSB7CiAgICAgICAgICAgIHJldHVybiBsb3c7CiAgICAgICAgICB9IH07CiAgICAgICAgICBmdW5jdGlvbiBfZmRfY2xvc2UoZmQpIHsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfZmRfc2VlayhmZCwgb2Zmc2V0X2xvdywgb2Zmc2V0X2hpZ2gsIHdoZW5jZSwgbmV3T2Zmc2V0KSB7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfZmRfd3JpdGUoZmQsIGlvdiwgaW92Y250LCBwbnVtKSB7CiAgICAgICAgICAgIHZhciBudW0gPSAwOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGlvdmNudDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHB0ciA9IEhFQVAzMltpb3YgKyBpICogOCA+PiAyXTsKICAgICAgICAgICAgICB2YXIgbGVuID0gSEVBUDMyW2lvdiArIChpICogOCArIDQpID4+IDJdOwogICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgbGVuOyBqKyspIHsKICAgICAgICAgICAgICAgIFNZU0NBTExTLnByaW50Q2hhcihmZCwgSEVBUFU4W3B0ciArIGpdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbnVtICs9IGxlbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBIRUFQMzJbcG51bSA+PiAyXSA9IG51bTsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfc2V0VGVtcFJldDAoJGkpIHsKICAgICAgICAgICAgc2V0VGVtcFJldDAoJGkgfCAwKTsKICAgICAgICAgIH0KICAgICAgICAgIEludGVybmFsRXJyb3IgPSBNb2R1bGVbIkludGVybmFsRXJyb3IiXSA9IGV4dGVuZEVycm9yKEVycm9yLCAiSW50ZXJuYWxFcnJvciIpOwogICAgICAgICAgZW1iaW5kX2luaXRfY2hhckNvZGVzKCk7CiAgICAgICAgICBCaW5kaW5nRXJyb3IgPSBNb2R1bGVbIkJpbmRpbmdFcnJvciJdID0gZXh0ZW5kRXJyb3IoRXJyb3IsICJCaW5kaW5nRXJyb3IiKTsKICAgICAgICAgIGluaXRfQ2xhc3NIYW5kbGUoKTsKICAgICAgICAgIGluaXRfUmVnaXN0ZXJlZFBvaW50ZXIoKTsKICAgICAgICAgIGluaXRfZW1iaW5kKCk7CiAgICAgICAgICBVbmJvdW5kVHlwZUVycm9yID0gTW9kdWxlWyJVbmJvdW5kVHlwZUVycm9yIl0gPSBleHRlbmRFcnJvcihFcnJvciwgIlVuYm91bmRUeXBlRXJyb3IiKTsKICAgICAgICAgIGluaXRfZW12YWwoKTsKICAgICAgICAgIHZhciBhc21MaWJyYXJ5QXJnID0geyAidCI6IF9fZW1iaW5kX2ZpbmFsaXplX3ZhbHVlX29iamVjdCwgIkkiOiBfX2VtYmluZF9yZWdpc3Rlcl9ib29sLCAieCI6IF9fZW1iaW5kX3JlZ2lzdGVyX2NsYXNzLCAidyI6IF9fZW1iaW5kX3JlZ2lzdGVyX2NsYXNzX2NvbnN0cnVjdG9yLCAiZCI6IF9fZW1iaW5kX3JlZ2lzdGVyX2NsYXNzX2Z1bmN0aW9uLCAiayI6IF9fZW1iaW5kX3JlZ2lzdGVyX2NvbnN0YW50LCAiSCI6IF9fZW1iaW5kX3JlZ2lzdGVyX2VtdmFsLCAibiI6IF9fZW1iaW5kX3JlZ2lzdGVyX2VudW0sICJhIjogX19lbWJpbmRfcmVnaXN0ZXJfZW51bV92YWx1ZSwgIkEiOiBfX2VtYmluZF9yZWdpc3Rlcl9mbG9hdCwgImkiOiBfX2VtYmluZF9yZWdpc3Rlcl9mdW5jdGlvbiwgImoiOiBfX2VtYmluZF9yZWdpc3Rlcl9pbnRlZ2VyLCAiaCI6IF9fZW1iaW5kX3JlZ2lzdGVyX21lbW9yeV92aWV3LCAiQiI6IF9fZW1iaW5kX3JlZ2lzdGVyX3N0ZF9zdHJpbmcsICJ2IjogX19lbWJpbmRfcmVnaXN0ZXJfc3RkX3dzdHJpbmcsICJ1IjogX19lbWJpbmRfcmVnaXN0ZXJfdmFsdWVfb2JqZWN0LCAiYyI6IF9fZW1iaW5kX3JlZ2lzdGVyX3ZhbHVlX29iamVjdF9maWVsZCwgIkoiOiBfX2VtYmluZF9yZWdpc3Rlcl92b2lkLCAibSI6IF9fZW12YWxfYXMsICJzIjogX19lbXZhbF9jYWxsX3ZvaWRfbWV0aG9kLCAiYiI6IF9fZW12YWxfZGVjcmVmLCAieSI6IF9fZW12YWxfZ2V0X2dsb2JhbCwgInAiOiBfX2VtdmFsX2dldF9tZXRob2RfY2FsbGVyLCAiciI6IF9fZW12YWxfZ2V0X21vZHVsZV9wcm9wZXJ0eSwgImUiOiBfX2VtdmFsX2dldF9wcm9wZXJ0eSwgImciOiBfX2VtdmFsX2luY3JlZiwgInEiOiBfX2VtdmFsX25ldywgImYiOiBfX2VtdmFsX25ld19jc3RyaW5nLCAibCI6IF9fZW12YWxfcnVuX2Rlc3RydWN0b3JzLCAibyI6IF9hYm9ydCwgIkUiOiBfZW1zY3JpcHRlbl9tZW1jcHlfYmlnLCAiRiI6IF9lbXNjcmlwdGVuX3Jlc2l6ZV9oZWFwLCAiRyI6IF9mZF9jbG9zZSwgIkMiOiBfZmRfc2VlaywgInoiOiBfZmRfd3JpdGUsICJEIjogX3NldFRlbXBSZXQwIH07CiAgICAgICAgICB2YXIgYXNtID0gY3JlYXRlV2FzbSgpOwogICAgICAgICAgdmFyIF9fX3dhc21fY2FsbF9jdG9ycyA9IE1vZHVsZVsiX19fd2FzbV9jYWxsX2N0b3JzIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChfX193YXNtX2NhbGxfY3RvcnMgPSBNb2R1bGVbIl9fX3dhc21fY2FsbF9jdG9ycyJdID0gTW9kdWxlWyJhc20iXVsiTCJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfbWFsbG9jID0gTW9kdWxlWyJfbWFsbG9jIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChfbWFsbG9jID0gTW9kdWxlWyJfbWFsbG9jIl0gPSBNb2R1bGVbImFzbSJdWyJNIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIF9mcmVlID0gTW9kdWxlWyJfZnJlZSJdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoX2ZyZWUgPSBNb2R1bGVbIl9mcmVlIl0gPSBNb2R1bGVbImFzbSJdWyJOIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIF9fX2dldFR5cGVOYW1lID0gTW9kdWxlWyJfX19nZXRUeXBlTmFtZSJdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoX19fZ2V0VHlwZU5hbWUgPSBNb2R1bGVbIl9fX2dldFR5cGVOYW1lIl0gPSBNb2R1bGVbImFzbSJdWyJQIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIF9fX2VtYmluZF9yZWdpc3Rlcl9uYXRpdmVfYW5kX2J1aWx0aW5fdHlwZXMgPSBNb2R1bGVbIl9fX2VtYmluZF9yZWdpc3Rlcl9uYXRpdmVfYW5kX2J1aWx0aW5fdHlwZXMiXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKF9fX2VtYmluZF9yZWdpc3Rlcl9uYXRpdmVfYW5kX2J1aWx0aW5fdHlwZXMgPSBNb2R1bGVbIl9fX2VtYmluZF9yZWdpc3Rlcl9uYXRpdmVfYW5kX2J1aWx0aW5fdHlwZXMiXSA9IE1vZHVsZVsiYXNtIl1bIlEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZHluQ2FsbF9qaWppID0gTW9kdWxlWyJkeW5DYWxsX2ppamkiXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGR5bkNhbGxfamlqaSA9IE1vZHVsZVsiZHluQ2FsbF9qaWppIl0gPSBNb2R1bGVbImFzbSJdWyJSIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGNhbGxlZFJ1bjsKICAgICAgICAgIGZ1bmN0aW9uIEV4aXRTdGF0dXMoc3RhdHVzKSB7CiAgICAgICAgICAgIHRoaXMubmFtZSA9ICJFeGl0U3RhdHVzIjsKICAgICAgICAgICAgdGhpcy5tZXNzYWdlID0gIlByb2dyYW0gdGVybWluYXRlZCB3aXRoIGV4aXQoIiArIHN0YXR1cyArICIpIjsKICAgICAgICAgICAgdGhpcy5zdGF0dXMgPSBzdGF0dXM7CiAgICAgICAgICB9CiAgICAgICAgICBkZXBlbmRlbmNpZXNGdWxmaWxsZWQgPSBmdW5jdGlvbiBydW5DYWxsZXIoKSB7CiAgICAgICAgICAgIGlmICghY2FsbGVkUnVuKQogICAgICAgICAgICAgIHJ1bigpOwogICAgICAgICAgICBpZiAoIWNhbGxlZFJ1bikKICAgICAgICAgICAgICBkZXBlbmRlbmNpZXNGdWxmaWxsZWQgPSBydW5DYWxsZXI7CiAgICAgICAgICB9OwogICAgICAgICAgZnVuY3Rpb24gcnVuKGFyZ3MpIHsKICAgICAgICAgICAgYXJncyA9IGFyZ3MgfHwgYXJndW1lbnRzXzsKICAgICAgICAgICAgaWYgKHJ1bkRlcGVuZGVuY2llcyA+IDApIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHJlUnVuKCk7CiAgICAgICAgICAgIGlmIChydW5EZXBlbmRlbmNpZXMgPiAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGRvUnVuKCkgewogICAgICAgICAgICAgIGlmIChjYWxsZWRSdW4pCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgY2FsbGVkUnVuID0gdHJ1ZTsKICAgICAgICAgICAgICBNb2R1bGVbImNhbGxlZFJ1biJdID0gdHJ1ZTsKICAgICAgICAgICAgICBpZiAoQUJPUlQpCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgaW5pdFJ1bnRpbWUoKTsKICAgICAgICAgICAgICBwcmVNYWluKCk7CiAgICAgICAgICAgICAgcmVhZHlQcm9taXNlUmVzb2x2ZShNb2R1bGUpOwogICAgICAgICAgICAgIGlmIChNb2R1bGVbIm9uUnVudGltZUluaXRpYWxpemVkIl0pCiAgICAgICAgICAgICAgICBNb2R1bGVbIm9uUnVudGltZUluaXRpYWxpemVkIl0oKTsKICAgICAgICAgICAgICBwb3N0UnVuKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKE1vZHVsZVsic2V0U3RhdHVzIl0pIHsKICAgICAgICAgICAgICBNb2R1bGVbInNldFN0YXR1cyJdKCJSdW5uaW5nLi4uIik7CiAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIE1vZHVsZVsic2V0U3RhdHVzIl0oIiIpOwogICAgICAgICAgICAgICAgfSwgMSk7CiAgICAgICAgICAgICAgICBkb1J1bigpOwogICAgICAgICAgICAgIH0sIDEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRvUnVuKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIE1vZHVsZVsicnVuIl0gPSBydW47CiAgICAgICAgICBpZiAoTW9kdWxlWyJwcmVJbml0Il0pIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBNb2R1bGVbInByZUluaXQiXSA9PSAiZnVuY3Rpb24iKQogICAgICAgICAgICAgIE1vZHVsZVsicHJlSW5pdCJdID0gW01vZHVsZVsicHJlSW5pdCJdXTsKICAgICAgICAgICAgd2hpbGUgKE1vZHVsZVsicHJlSW5pdCJdLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBNb2R1bGVbInByZUluaXQiXS5wb3AoKSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBydW4oKTsKICAgICAgICAgIHJldHVybiBCQVNJUzIucmVhZHk7CiAgICAgICAgfTsKICAgICAgfSgpOwogICAgICBpZiAodHlwZW9mIGV4cG9ydHMyID09PSAib2JqZWN0IiAmJiB0eXBlb2YgbW9kdWxlID09PSAib2JqZWN0IikKICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IEJBU0lTOwogICAgICBlbHNlIGlmICh0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZVsiYW1kIl0pCiAgICAgICAgZGVmaW5lKFtdLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBCQVNJUzsKICAgICAgICB9KTsKICAgICAgZWxzZSBpZiAodHlwZW9mIGV4cG9ydHMyID09PSAib2JqZWN0IikKICAgICAgICBleHBvcnRzMlsiQkFTSVMiXSA9IEJBU0lTOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvdHJhbnNjb2RlS1RYMi5qcwogIHZhciB0cmFuc2NvZGVLVFgyX2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydCh0cmFuc2NvZGVLVFgyX2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IHRyYW5zY29kZUtUWDJfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIHRyYW5zY29kZShwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInRyYW5zY29kZXJNb2R1bGUiLCB0cmFuc2NvZGVyTW9kdWxlKTsKICAgIGNvbnN0IGRhdGEgPSBwYXJhbWV0ZXJzLmt0eDJCdWZmZXI7CiAgICBjb25zdCBzdXBwb3J0ZWRUYXJnZXRGb3JtYXRzID0gcGFyYW1ldGVycy5zdXBwb3J0ZWRUYXJnZXRGb3JtYXRzOwogICAgbGV0IGhlYWRlcjsKICAgIHRyeSB7CiAgICAgIGhlYWRlciA9IHJlYWQyKGRhdGEpOwogICAgfSBjYXRjaCAoZSkgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIkludmFsaWQgS1RYMiBmaWxlLiIpOwogICAgfQogICAgaWYgKGhlYWRlci5sYXllckNvdW50ICE9PSAwKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgiS1RYMiB0ZXh0dXJlIGFycmF5cyBhcmUgbm90IHN1cHBvcnRlZC4iKTsKICAgIH0KICAgIGlmIChoZWFkZXIucGl4ZWxEZXB0aCAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIktUWDIgM0QgdGV4dHVyZXMgYXJlIHVuc3VwcG9ydGVkLiIpOwogICAgfQogICAgY29uc3QgZGZkID0gaGVhZGVyLmRhdGFGb3JtYXREZXNjcmlwdG9yWzBdOwogICAgY29uc3QgcmVzdWx0ID0gbmV3IEFycmF5KGhlYWRlci5sZXZlbENvdW50KTsKICAgIGlmIChoZWFkZXIudmtGb3JtYXQgPT09IDAgJiYgKGRmZC5jb2xvck1vZGVsID09PSBjb2xvck1vZGVsRVRDMVMgfHwgZGZkLmNvbG9yTW9kZWwgPT09IGNvbG9yTW9kZWxVQVNUQykpIHsKICAgICAgdHJhbnNjb2RlQ29tcHJlc3NlZCgKICAgICAgICBkYXRhLAogICAgICAgIGhlYWRlciwKICAgICAgICBzdXBwb3J0ZWRUYXJnZXRGb3JtYXRzLAogICAgICAgIHRyYW5zY29kZXJNb2R1bGUsCiAgICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cywKICAgICAgICByZXN1bHQKICAgICAgKTsKICAgIH0gZWxzZSB7CiAgICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChkYXRhLmJ1ZmZlcik7CiAgICAgIHBhcnNlVW5jb21wcmVzc2VkKGhlYWRlciwgcmVzdWx0KTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIHBhcnNlVW5jb21wcmVzc2VkKGhlYWRlciwgcmVzdWx0KSB7CiAgICBjb25zdCBpbnRlcm5hbEZvcm1hdCA9IGhlYWRlci52a0Zvcm1hdCA9PT0gVnVsa2FuQ29uc3RhbnRzX2RlZmF1bHQuVktfRk9STUFUX1I4RzhCOF9TUkdCID8gUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0IgOiBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQkE7CiAgICBsZXQgZGF0YXR5cGU7CiAgICBpZiAoaGVhZGVyLnZrRm9ybWF0ID09PSBWdWxrYW5Db25zdGFudHNfZGVmYXVsdC5WS19GT1JNQVRfUjhHOEI4QThfVU5PUk0pIHsKICAgICAgZGF0YXR5cGUgPSBQaXhlbERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURTsKICAgIH0gZWxzZSBpZiAoaGVhZGVyLnZrRm9ybWF0ID09PSBWdWxrYW5Db25zdGFudHNfZGVmYXVsdC5WS19GT1JNQVRfUjE2RzE2QjE2QTE2X1NGTE9BVCkgewogICAgICBkYXRhdHlwZSA9IFBpeGVsRGF0YXR5cGVfZGVmYXVsdC5IQUxGX0ZMT0FUOwogICAgfSBlbHNlIGlmIChoZWFkZXIudmtGb3JtYXQgPT09IFZ1bGthbkNvbnN0YW50c19kZWZhdWx0LlZLX0ZPUk1BVF9SMzJHMzJCMzJBMzJfU0ZMT0FUKSB7CiAgICAgIGRhdGF0eXBlID0gUGl4ZWxEYXRhdHlwZV9kZWZhdWx0LkZMT0FUOwogICAgfQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoZWFkZXIubGV2ZWxzLmxlbmd0aDsgKytpKSB7CiAgICAgIGNvbnN0IGxldmVsID0ge307CiAgICAgIHJlc3VsdFtpXSA9IGxldmVsOwogICAgICBjb25zdCBsZXZlbEJ1ZmZlciA9IGhlYWRlci5sZXZlbHNbaV0ubGV2ZWxEYXRhOwogICAgICBjb25zdCB3aWR0aCA9IGhlYWRlci5waXhlbFdpZHRoID4+IGk7CiAgICAgIGNvbnN0IGhlaWdodCA9IGhlYWRlci5waXhlbEhlaWdodCA+PiBpOwogICAgICBjb25zdCBmYWNlTGVuZ3RoID0gd2lkdGggKiBoZWlnaHQgKiBQaXhlbEZvcm1hdF9kZWZhdWx0LmNvbXBvbmVudHNMZW5ndGgoaW50ZXJuYWxGb3JtYXQpOwogICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGhlYWRlci5mYWNlQ291bnQ7ICsraikgewogICAgICAgIGNvbnN0IGZhY2VCeXRlT2Zmc2V0ID0gbGV2ZWxCdWZmZXIuYnl0ZU9mZnNldCArIGZhY2VMZW5ndGggKiBoZWFkZXIudHlwZVNpemUgKiBqOwogICAgICAgIGxldCBmYWNlVmlldzsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChkYXRhdHlwZSkgfHwgUGl4ZWxEYXRhdHlwZV9kZWZhdWx0LnNpemVJbkJ5dGVzKGRhdGF0eXBlKSA9PT0gMSkgewogICAgICAgICAgZmFjZVZpZXcgPSBuZXcgVWludDhBcnJheSgKICAgICAgICAgICAgbGV2ZWxCdWZmZXIuYnVmZmVyLAogICAgICAgICAgICBmYWNlQnl0ZU9mZnNldCwKICAgICAgICAgICAgZmFjZUxlbmd0aAogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKFBpeGVsRGF0YXR5cGVfZGVmYXVsdC5zaXplSW5CeXRlcyhkYXRhdHlwZSkgPT09IDIpIHsKICAgICAgICAgIGZhY2VWaWV3ID0gbmV3IFVpbnQxNkFycmF5KAogICAgICAgICAgICBsZXZlbEJ1ZmZlci5idWZmZXIsCiAgICAgICAgICAgIGZhY2VCeXRlT2Zmc2V0LAogICAgICAgICAgICBmYWNlTGVuZ3RoCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmYWNlVmlldyA9IG5ldyBGbG9hdDMyQXJyYXkoCiAgICAgICAgICAgIGxldmVsQnVmZmVyLmJ1ZmZlciwKICAgICAgICAgICAgZmFjZUJ5dGVPZmZzZXQsCiAgICAgICAgICAgIGZhY2VMZW5ndGgKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGxldmVsW2ZhY2VPcmRlcltqXV0gPSB7CiAgICAgICAgICBpbnRlcm5hbEZvcm1hdCwKICAgICAgICAgIGRhdGF0eXBlLAogICAgICAgICAgd2lkdGgsCiAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICBsZXZlbEJ1ZmZlcjogZmFjZVZpZXcKICAgICAgICB9OwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIHRyYW5zY29kZUNvbXByZXNzZWQoZGF0YSwgaGVhZGVyLCBzdXBwb3J0ZWRUYXJnZXRGb3JtYXRzLCB0cmFuc2NvZGVyTW9kdWxlMiwgdHJhbnNmZXJhYmxlT2JqZWN0cywgcmVzdWx0KSB7CiAgICBjb25zdCBrdHgyRmlsZSA9IG5ldyB0cmFuc2NvZGVyTW9kdWxlMi5LVFgyRmlsZShkYXRhKTsKICAgIGxldCB3aWR0aCA9IGt0eDJGaWxlLmdldFdpZHRoKCk7CiAgICBsZXQgaGVpZ2h0ID0ga3R4MkZpbGUuZ2V0SGVpZ2h0KCk7CiAgICBjb25zdCBsZXZlbHMgPSBrdHgyRmlsZS5nZXRMZXZlbHMoKTsKICAgIGNvbnN0IGhhc0FscGhhID0ga3R4MkZpbGUuZ2V0SGFzQWxwaGEoKTsKICAgIGlmICghKHdpZHRoID4gMCkgfHwgIShoZWlnaHQgPiAwKSB8fCAhKGxldmVscyA+IDApKSB7CiAgICAgIGt0eDJGaWxlLmNsb3NlKCk7CiAgICAgIGt0eDJGaWxlLmRlbGV0ZSgpOwogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIkludmFsaWQgS1RYMiBmaWxlIik7CiAgICB9CiAgICBsZXQgaW50ZXJuYWxGb3JtYXQsIHRyYW5zY29kZXJGb3JtYXQ7CiAgICBjb25zdCBkZmQgPSBoZWFkZXIuZGF0YUZvcm1hdERlc2NyaXB0b3JbMF07CiAgICBjb25zdCBCYXNpc0Zvcm1hdCA9IHRyYW5zY29kZXJNb2R1bGUyLnRyYW5zY29kZXJfdGV4dHVyZV9mb3JtYXQ7CiAgICBpZiAoZGZkLmNvbG9yTW9kZWwgPT09IGNvbG9yTW9kZWxFVEMxUykgewogICAgICBpZiAoc3VwcG9ydGVkVGFyZ2V0Rm9ybWF0cy5ldGMpIHsKICAgICAgICBpbnRlcm5hbEZvcm1hdCA9IGhhc0FscGhhID8gUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JBOF9FVEMyX0VBQyA6IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCOF9FVEMyOwogICAgICAgIHRyYW5zY29kZXJGb3JtYXQgPSBoYXNBbHBoYSA/IEJhc2lzRm9ybWF0LmNURkVUQzJfUkdCQSA6IEJhc2lzRm9ybWF0LmNURkVUQzFfUkdCOwogICAgICB9IGVsc2UgaWYgKHN1cHBvcnRlZFRhcmdldEZvcm1hdHMuZXRjMSAmJiAhaGFzQWxwaGEpIHsKICAgICAgICBpbnRlcm5hbEZvcm1hdCA9IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCX0VUQzE7CiAgICAgICAgdHJhbnNjb2RlckZvcm1hdCA9IEJhc2lzRm9ybWF0LmNURkVUQzFfUkdCOwogICAgICB9IGVsc2UgaWYgKHN1cHBvcnRlZFRhcmdldEZvcm1hdHMuczN0YykgewogICAgICAgIGludGVybmFsRm9ybWF0ID0gaGFzQWxwaGEgPyBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQkFfRFhUNSA6IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCX0RYVDE7CiAgICAgICAgdHJhbnNjb2RlckZvcm1hdCA9IGhhc0FscGhhID8gQmFzaXNGb3JtYXQuY1RGQkMzX1JHQkEgOiBCYXNpc0Zvcm1hdC5jVEZCQzFfUkdCOwogICAgICB9IGVsc2UgaWYgKHN1cHBvcnRlZFRhcmdldEZvcm1hdHMucHZydGMpIHsKICAgICAgICBpbnRlcm5hbEZvcm1hdCA9IGhhc0FscGhhID8gUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JBX1BWUlRDXzRCUFBWMSA6IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCX1BWUlRDXzRCUFBWMTsKICAgICAgICB0cmFuc2NvZGVyRm9ybWF0ID0gaGFzQWxwaGEgPyBCYXNpc0Zvcm1hdC5jVEZQVlJUQzFfNF9SR0JBIDogQmFzaXNGb3JtYXQuY1RGUFZSVEMxXzRfUkdCOwogICAgICB9IGVsc2UgaWYgKHN1cHBvcnRlZFRhcmdldEZvcm1hdHMuYXN0YykgewogICAgICAgIGludGVybmFsRm9ybWF0ID0gUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JBX0FTVEM7CiAgICAgICAgdHJhbnNjb2RlckZvcm1hdCA9IEJhc2lzRm9ybWF0LmNURkFTVENfNHg0X1JHQkE7CiAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydGVkVGFyZ2V0Rm9ybWF0cy5iYzcpIHsKICAgICAgICBpbnRlcm5hbEZvcm1hdCA9IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCQV9CQzc7CiAgICAgICAgdHJhbnNjb2RlckZvcm1hdCA9IEJhc2lzRm9ybWF0LmNURkJDN19SR0JBOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICJObyB0cmFuc2NvZGluZyBmb3JtYXQgdGFyZ2V0IGF2YWlsYWJsZSBmb3IgRVRDMVMgY29tcHJlc3NlZCBrdHgyLiIKICAgICAgICApOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGRmZC5jb2xvck1vZGVsID09PSBjb2xvck1vZGVsVUFTVEMpIHsKICAgICAgaWYgKHN1cHBvcnRlZFRhcmdldEZvcm1hdHMuYXN0YykgewogICAgICAgIGludGVybmFsRm9ybWF0ID0gUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JBX0FTVEM7CiAgICAgICAgdHJhbnNjb2RlckZvcm1hdCA9IEJhc2lzRm9ybWF0LmNURkFTVENfNHg0X1JHQkE7CiAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydGVkVGFyZ2V0Rm9ybWF0cy5iYzcpIHsKICAgICAgICBpbnRlcm5hbEZvcm1hdCA9IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCQV9CQzc7CiAgICAgICAgdHJhbnNjb2RlckZvcm1hdCA9IEJhc2lzRm9ybWF0LmNURkJDN19SR0JBOwogICAgICB9IGVsc2UgaWYgKHN1cHBvcnRlZFRhcmdldEZvcm1hdHMuczN0YykgewogICAgICAgIGludGVybmFsRm9ybWF0ID0gaGFzQWxwaGEgPyBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQkFfRFhUNSA6IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCX0RYVDE7CiAgICAgICAgdHJhbnNjb2RlckZvcm1hdCA9IGhhc0FscGhhID8gQmFzaXNGb3JtYXQuY1RGQkMzX1JHQkEgOiBCYXNpc0Zvcm1hdC5jVEZCQzFfUkdCOwogICAgICB9IGVsc2UgaWYgKHN1cHBvcnRlZFRhcmdldEZvcm1hdHMuZXRjKSB7CiAgICAgICAgaW50ZXJuYWxGb3JtYXQgPSBoYXNBbHBoYSA/IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCQThfRVRDMl9FQUMgOiBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQjhfRVRDMjsKICAgICAgICB0cmFuc2NvZGVyRm9ybWF0ID0gaGFzQWxwaGEgPyBCYXNpc0Zvcm1hdC5jVEZFVEMyX1JHQkEgOiBCYXNpc0Zvcm1hdC5jVEZFVEMxX1JHQjsKICAgICAgfSBlbHNlIGlmIChzdXBwb3J0ZWRUYXJnZXRGb3JtYXRzLmV0YzEgJiYgIWhhc0FscGhhKSB7CiAgICAgICAgaW50ZXJuYWxGb3JtYXQgPSBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQl9FVEMxOwogICAgICAgIHRyYW5zY29kZXJGb3JtYXQgPSBCYXNpc0Zvcm1hdC5jVEZFVEMxX1JHQjsKICAgICAgfSBlbHNlIGlmIChzdXBwb3J0ZWRUYXJnZXRGb3JtYXRzLnB2cnRjKSB7CiAgICAgICAgaW50ZXJuYWxGb3JtYXQgPSBoYXNBbHBoYSA/IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCQV9QVlJUQ180QlBQVjEgOiBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQl9QVlJUQ180QlBQVjE7CiAgICAgICAgdHJhbnNjb2RlckZvcm1hdCA9IGhhc0FscGhhID8gQmFzaXNGb3JtYXQuY1RGUFZSVEMxXzRfUkdCQSA6IEJhc2lzRm9ybWF0LmNURlBWUlRDMV80X1JHQjsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoCiAgICAgICAgICAiTm8gdHJhbnNjb2RpbmcgZm9ybWF0IHRhcmdldCBhdmFpbGFibGUgZm9yIFVBU1RDIGNvbXByZXNzZWQga3R4Mi4iCiAgICAgICAgKTsKICAgICAgfQogICAgfQogICAgaWYgKCFrdHgyRmlsZS5zdGFydFRyYW5zY29kaW5nKCkpIHsKICAgICAga3R4MkZpbGUuY2xvc2UoKTsKICAgICAga3R4MkZpbGUuZGVsZXRlKCk7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgic3RhcnRUcmFuc2NvZGluZygpIGZhaWxlZCIpOwogICAgfQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoZWFkZXIubGV2ZWxzLmxlbmd0aDsgKytpKSB7CiAgICAgIGNvbnN0IGxldmVsID0ge307CiAgICAgIHJlc3VsdFtpXSA9IGxldmVsOwogICAgICB3aWR0aCA9IGhlYWRlci5waXhlbFdpZHRoID4+IGk7CiAgICAgIGhlaWdodCA9IGhlYWRlci5waXhlbEhlaWdodCA+PiBpOwogICAgICBjb25zdCBkc3RTaXplID0ga3R4MkZpbGUuZ2V0SW1hZ2VUcmFuc2NvZGVkU2l6ZUluQnl0ZXMoCiAgICAgICAgaSwKICAgICAgICAvLyBsZXZlbCBpbmRleAogICAgICAgIDAsCiAgICAgICAgLy8gbGF5ZXIgaW5kZXgKICAgICAgICAwLAogICAgICAgIC8vIGZhY2UgaW5kZXgKICAgICAgICB0cmFuc2NvZGVyRm9ybWF0LnZhbHVlCiAgICAgICk7CiAgICAgIGNvbnN0IGRzdCA9IG5ldyBVaW50OEFycmF5KGRzdFNpemUpOwogICAgICBjb25zdCB0cmFuc2NvZGVkID0ga3R4MkZpbGUudHJhbnNjb2RlSW1hZ2UoCiAgICAgICAgZHN0LAogICAgICAgIGksCiAgICAgICAgLy8gbGV2ZWwgaW5kZXgKICAgICAgICAwLAogICAgICAgIC8vIGxheWVyIGluZGV4CiAgICAgICAgMCwKICAgICAgICAvLyBmYWNlIGluZGV4CiAgICAgICAgdHJhbnNjb2RlckZvcm1hdC52YWx1ZSwKICAgICAgICAwLAogICAgICAgIC8vIGdldF9hbHBoYV9mb3Jfb3BhcXVlX2Zvcm1hdHMKICAgICAgICAtMSwKICAgICAgICAvLyBjaGFubmVsMAogICAgICAgIC0xCiAgICAgICAgLy8gY2hhbm5lbDEKICAgICAgKTsKICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodHJhbnNjb2RlZCkpIHsKICAgICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoInRyYW5zY29kZUltYWdlKCkgZmFpbGVkLiIpOwogICAgICB9CiAgICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChkc3QuYnVmZmVyKTsKICAgICAgbGV2ZWxbZmFjZU9yZGVyWzBdXSA9IHsKICAgICAgICBpbnRlcm5hbEZvcm1hdCwKICAgICAgICB3aWR0aCwKICAgICAgICBoZWlnaHQsCiAgICAgICAgbGV2ZWxCdWZmZXI6IGRzdAogICAgICB9OwogICAgfQogICAga3R4MkZpbGUuY2xvc2UoKTsKICAgIGt0eDJGaWxlLmRlbGV0ZSgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgYXN5bmMgZnVuY3Rpb24gaW5pdFdvcmtlcjMocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3Qgd2FzbUNvbmZpZyA9IHBhcmFtZXRlcnMud2ViQXNzZW1ibHlDb25maWc7CiAgICBjb25zdCBiYXNpc1RyYW5zY29kZXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChpbXBvcnRfYmFzaXNfdHJhbnNjb2Rlci5kZWZhdWx0LCBzZWxmLkJBU0lTKTsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQod2FzbUNvbmZpZy53YXNtQmluYXJ5RmlsZSkpIHsKICAgICAgdHJhbnNjb2Rlck1vZHVsZSA9IGF3YWl0IGJhc2lzVHJhbnNjb2Rlcih3YXNtQ29uZmlnKTsKICAgIH0gZWxzZSB7CiAgICAgIHRyYW5zY29kZXJNb2R1bGUgPSBhd2FpdCBiYXNpc1RyYW5zY29kZXIoKTsKICAgIH0KICAgIHRyYW5zY29kZXJNb2R1bGUuaW5pdGlhbGl6ZUJhc2lzKCk7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZnVuY3Rpb24gdHJhbnNjb2RlS1RYMihwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBjb25zdCB3YXNtQ29uZmlnID0gcGFyYW1ldGVycy53ZWJBc3NlbWJseUNvbmZpZzsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQod2FzbUNvbmZpZykpIHsKICAgICAgcmV0dXJuIGluaXRXb3JrZXIzKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpOwogICAgfQogICAgcmV0dXJuIHRyYW5zY29kZShwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKTsKICB9CiAgdmFyIGltcG9ydF9iYXNpc190cmFuc2NvZGVyLCBmYWNlT3JkZXIsIGNvbG9yTW9kZWxFVEMxUywgY29sb3JNb2RlbFVBU1RDLCB0cmFuc2NvZGVyTW9kdWxlLCB0cmFuc2NvZGVLVFgyX2RlZmF1bHQ7CiAgdmFyIGluaXRfdHJhbnNjb2RlS1RYMiA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvdHJhbnNjb2RlS1RYMi5qcyIoKSB7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfUGl4ZWxGb3JtYXQoKTsKICAgICAgaW5pdF9SdW50aW1lRXJyb3IoKTsKICAgICAgaW5pdF9WdWxrYW5Db25zdGFudHMoKTsKICAgICAgaW5pdF9QaXhlbERhdGF0eXBlKCk7CiAgICAgIGluaXRfY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcigpOwogICAgICBpbml0X2t0eF9wYXJzZV9tb2Rlcm4oKTsKICAgICAgaW1wb3J0X2Jhc2lzX3RyYW5zY29kZXIgPSBfX3RvRVNNKHJlcXVpcmVfYmFzaXNfdHJhbnNjb2RlcigpLCAxKTsKICAgICAgZmFjZU9yZGVyID0gWwogICAgICAgICJwb3NpdGl2ZVgiLAogICAgICAgICJuZWdhdGl2ZVgiLAogICAgICAgICJwb3NpdGl2ZVkiLAogICAgICAgICJuZWdhdGl2ZVkiLAogICAgICAgICJwb3NpdGl2ZVoiLAogICAgICAgICJuZWdhdGl2ZVoiCiAgICAgIF07CiAgICAgIGNvbG9yTW9kZWxFVEMxUyA9IDE2MzsKICAgICAgY29sb3JNb2RlbFVBU1RDID0gMTY2OwogICAgICB0cmFuc2NvZGVLVFgyX2RlZmF1bHQgPSBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2RlZmF1bHQodHJhbnNjb2RlS1RYMik7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy90cmFuc2ZlclR5cGVkQXJyYXlUZXN0LmpzCiAgdmFyIHRyYW5zZmVyVHlwZWRBcnJheVRlc3RfZXhwb3J0cyA9IHt9OwogIHZhciBpbml0X3RyYW5zZmVyVHlwZWRBcnJheVRlc3QgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL3RyYW5zZmVyVHlwZWRBcnJheVRlc3QuanMiKCkgewogICAgICBzZWxmLm9ubWVzc2FnZSA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgY29uc3QgYXJyYXkgPSBldmVudC5kYXRhLmFycmF5OwogICAgICAgIGNvbnN0IHBvc3RNZXNzYWdlMiA9IHNlbGYud2Via2l0UG9zdE1lc3NhZ2UgfHwgc2VsZi5wb3N0TWVzc2FnZTsKICAgICAgICB0cnkgewogICAgICAgICAgcG9zdE1lc3NhZ2UyKAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgYXJyYXkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgW2FycmF5LmJ1ZmZlcl0KICAgICAgICAgICk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgcG9zdE1lc3NhZ2UyKHt9KTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9JbnRlcnNlY3Rpb25zMkQuanMKICB2YXIgSW50ZXJzZWN0aW9uczJELCBJbnRlcnNlY3Rpb25zMkRfZGVmYXVsdDsKICB2YXIgaW5pdF9JbnRlcnNlY3Rpb25zMkQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0ludGVyc2VjdGlvbnMyRC5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBJbnRlcnNlY3Rpb25zMkQgPSB7fTsKICAgICAgSW50ZXJzZWN0aW9uczJELmNsaXBUcmlhbmdsZUF0QXhpc0FsaWduZWRUaHJlc2hvbGQgPSBmdW5jdGlvbih0aHJlc2hvbGQsIGtlZXBBYm92ZSwgdTAsIHUxMiwgdTIyLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0aHJlc2hvbGQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidGhyZXNob2xkIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChrZWVwQWJvdmUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgia2VlcEFib3ZlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh1MCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ1MCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodTEyKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInUxIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh1MjIpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidTIgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IFtdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gMDsKICAgICAgICB9CiAgICAgICAgbGV0IHUwQmVoaW5kOwogICAgICAgIGxldCB1MUJlaGluZDsKICAgICAgICBsZXQgdTJCZWhpbmQ7CiAgICAgICAgaWYgKGtlZXBBYm92ZSkgewogICAgICAgICAgdTBCZWhpbmQgPSB1MCA8IHRocmVzaG9sZDsKICAgICAgICAgIHUxQmVoaW5kID0gdTEyIDwgdGhyZXNob2xkOwogICAgICAgICAgdTJCZWhpbmQgPSB1MjIgPCB0aHJlc2hvbGQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHUwQmVoaW5kID0gdTAgPiB0aHJlc2hvbGQ7CiAgICAgICAgICB1MUJlaGluZCA9IHUxMiA+IHRocmVzaG9sZDsKICAgICAgICAgIHUyQmVoaW5kID0gdTIyID4gdGhyZXNob2xkOwogICAgICAgIH0KICAgICAgICBjb25zdCBudW1CZWhpbmQgPSB1MEJlaGluZCArIHUxQmVoaW5kICsgdTJCZWhpbmQ7CiAgICAgICAgbGV0IHUwMVJhdGlvOwogICAgICAgIGxldCB1MDJSYXRpbzsKICAgICAgICBsZXQgdTEyUmF0aW87CiAgICAgICAgbGV0IHUxMFJhdGlvOwogICAgICAgIGxldCB1MjBSYXRpbzsKICAgICAgICBsZXQgdTIxUmF0aW87CiAgICAgICAgaWYgKG51bUJlaGluZCA9PT0gMSkgewogICAgICAgICAgaWYgKHUwQmVoaW5kKSB7CiAgICAgICAgICAgIHUwMVJhdGlvID0gKHRocmVzaG9sZCAtIHUwKSAvICh1MTIgLSB1MCk7CiAgICAgICAgICAgIHUwMlJhdGlvID0gKHRocmVzaG9sZCAtIHUwKSAvICh1MjIgLSB1MCk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDEpOwogICAgICAgICAgICByZXN1bHQucHVzaCgyKTsKICAgICAgICAgICAgaWYgKHUwMlJhdGlvICE9PSAxKSB7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goLTEpOwogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKDApOwogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKDIpOwogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHUwMlJhdGlvKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodTAxUmF0aW8gIT09IDEpIHsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgtMSk7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goMCk7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goMSk7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2godTAxUmF0aW8pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHUxQmVoaW5kKSB7CiAgICAgICAgICAgIHUxMlJhdGlvID0gKHRocmVzaG9sZCAtIHUxMikgLyAodTIyIC0gdTEyKTsKICAgICAgICAgICAgdTEwUmF0aW8gPSAodGhyZXNob2xkIC0gdTEyKSAvICh1MCAtIHUxMik7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDIpOwogICAgICAgICAgICByZXN1bHQucHVzaCgwKTsKICAgICAgICAgICAgaWYgKHUxMFJhdGlvICE9PSAxKSB7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goLTEpOwogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKDEpOwogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKDApOwogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHUxMFJhdGlvKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodTEyUmF0aW8gIT09IDEpIHsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgtMSk7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goMSk7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goMik7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2godTEyUmF0aW8pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHUyQmVoaW5kKSB7CiAgICAgICAgICAgIHUyMFJhdGlvID0gKHRocmVzaG9sZCAtIHUyMikgLyAodTAgLSB1MjIpOwogICAgICAgICAgICB1MjFSYXRpbyA9ICh0aHJlc2hvbGQgLSB1MjIpIC8gKHUxMiAtIHUyMik7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDApOwogICAgICAgICAgICByZXN1bHQucHVzaCgxKTsKICAgICAgICAgICAgaWYgKHUyMVJhdGlvICE9PSAxKSB7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goLTEpOwogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKDIpOwogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKDEpOwogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHUyMVJhdGlvKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodTIwUmF0aW8gIT09IDEpIHsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgtMSk7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goMik7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goMCk7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2godTIwUmF0aW8pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChudW1CZWhpbmQgPT09IDIpIHsKICAgICAgICAgIGlmICghdTBCZWhpbmQgJiYgdTAgIT09IHRocmVzaG9sZCkgewogICAgICAgICAgICB1MTBSYXRpbyA9ICh0aHJlc2hvbGQgLSB1MTIpIC8gKHUwIC0gdTEyKTsKICAgICAgICAgICAgdTIwUmF0aW8gPSAodGhyZXNob2xkIC0gdTIyKSAvICh1MCAtIHUyMik7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDApOwogICAgICAgICAgICByZXN1bHQucHVzaCgtMSk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDEpOwogICAgICAgICAgICByZXN1bHQucHVzaCgwKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2godTEwUmF0aW8pOwogICAgICAgICAgICByZXN1bHQucHVzaCgtMSk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDIpOwogICAgICAgICAgICByZXN1bHQucHVzaCgwKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2godTIwUmF0aW8pOwogICAgICAgICAgfSBlbHNlIGlmICghdTFCZWhpbmQgJiYgdTEyICE9PSB0aHJlc2hvbGQpIHsKICAgICAgICAgICAgdTIxUmF0aW8gPSAodGhyZXNob2xkIC0gdTIyKSAvICh1MTIgLSB1MjIpOwogICAgICAgICAgICB1MDFSYXRpbyA9ICh0aHJlc2hvbGQgLSB1MCkgLyAodTEyIC0gdTApOwogICAgICAgICAgICByZXN1bHQucHVzaCgxKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goLTEpOwogICAgICAgICAgICByZXN1bHQucHVzaCgyKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMSk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHUyMVJhdGlvKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goLTEpOwogICAgICAgICAgICByZXN1bHQucHVzaCgwKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMSk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHUwMVJhdGlvKTsKICAgICAgICAgIH0gZWxzZSBpZiAoIXUyQmVoaW5kICYmIHUyMiAhPT0gdGhyZXNob2xkKSB7CiAgICAgICAgICAgIHUwMlJhdGlvID0gKHRocmVzaG9sZCAtIHUwKSAvICh1MjIgLSB1MCk7CiAgICAgICAgICAgIHUxMlJhdGlvID0gKHRocmVzaG9sZCAtIHUxMikgLyAodTIyIC0gdTEyKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMik7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKC0xKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMCk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDIpOwogICAgICAgICAgICByZXN1bHQucHVzaCh1MDJSYXRpbyk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKC0xKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMSk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDIpOwogICAgICAgICAgICByZXN1bHQucHVzaCh1MTJSYXRpbyk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChudW1CZWhpbmQgIT09IDMpIHsKICAgICAgICAgIHJlc3VsdC5wdXNoKDApOwogICAgICAgICAgcmVzdWx0LnB1c2goMSk7CiAgICAgICAgICByZXN1bHQucHVzaCgyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgSW50ZXJzZWN0aW9uczJELmNvbXB1dGVCYXJ5Y2VudHJpY0Nvb3JkaW5hdGVzID0gZnVuY3Rpb24oeCwgeSwgeDEsIHkxLCB4MiwgeTIsIHgzLCB5MywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoeCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ4IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInkgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHgxKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIngxIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh5MSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ5MSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoeDIpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgieDIgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHkyKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInkyIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh4MykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ4MyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoeTMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgieTMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHgxbXgzID0geDEgLSB4MzsKICAgICAgICBjb25zdCB4M214MiA9IHgzIC0geDI7CiAgICAgICAgY29uc3QgeTJteTMgPSB5MiAtIHkzOwogICAgICAgIGNvbnN0IHkxbXkzID0geTEgLSB5MzsKICAgICAgICBjb25zdCBpbnZlcnNlRGV0ZXJtaW5hbnQgPSAxIC8gKHkybXkzICogeDFteDMgKyB4M214MiAqIHkxbXkzKTsKICAgICAgICBjb25zdCB5bXkzID0geSAtIHkzOwogICAgICAgIGNvbnN0IHhteDMgPSB4IC0geDM7CiAgICAgICAgY29uc3QgbDEgPSAoeTJteTMgKiB4bXgzICsgeDNteDIgKiB5bXkzKSAqIGludmVyc2VEZXRlcm1pbmFudDsKICAgICAgICBjb25zdCBsMiA9ICgteTFteTMgKiB4bXgzICsgeDFteDMgKiB5bXkzKSAqIGludmVyc2VEZXRlcm1pbmFudDsKICAgICAgICBjb25zdCBsMyA9IDEgLSBsMSAtIGwyOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0LnggPSBsMTsKICAgICAgICAgIHJlc3VsdC55ID0gbDI7CiAgICAgICAgICByZXN1bHQueiA9IGwzOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQobDEsIGwyLCBsMyk7CiAgICAgIH07CiAgICAgIEludGVyc2VjdGlvbnMyRC5jb21wdXRlTGluZVNlZ21lbnRMaW5lU2VnbWVudEludGVyc2VjdGlvbiA9IGZ1bmN0aW9uKHgwMCwgeTAwLCB4MDEsIHkwMSwgeDEwLCB5MTAsIHgxMSwgeTExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIngwMCIsIHgwMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ5MDAiLCB5MDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigieDAxIiwgeDAxKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInkwMSIsIHkwMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ4MTAiLCB4MTApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigieTEwIiwgeTEwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIngxMSIsIHgxMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ5MTEiLCB5MTEpOwogICAgICAgIGNvbnN0IG51bWVyYXRvcjFBID0gKHgxMSAtIHgxMCkgKiAoeTAwIC0geTEwKSAtICh5MTEgLSB5MTApICogKHgwMCAtIHgxMCk7CiAgICAgICAgY29uc3QgbnVtZXJhdG9yMUIgPSAoeDAxIC0geDAwKSAqICh5MDAgLSB5MTApIC0gKHkwMSAtIHkwMCkgKiAoeDAwIC0geDEwKTsKICAgICAgICBjb25zdCBkZW5vbWluYXRvcjEgPSAoeTExIC0geTEwKSAqICh4MDEgLSB4MDApIC0gKHgxMSAtIHgxMCkgKiAoeTAxIC0geTAwKTsKICAgICAgICBpZiAoZGVub21pbmF0b3IxID09PSAwKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IHVhMSA9IG51bWVyYXRvcjFBIC8gZGVub21pbmF0b3IxOwogICAgICAgIGNvbnN0IHViMSA9IG51bWVyYXRvcjFCIC8gZGVub21pbmF0b3IxOwogICAgICAgIGlmICh1YTEgPj0gMCAmJiB1YTEgPD0gMSAmJiB1YjEgPj0gMCAmJiB1YjEgPD0gMSkgewogICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXN1bHQueCA9IHgwMCArIHVhMSAqICh4MDEgLSB4MDApOwogICAgICAgICAgcmVzdWx0LnkgPSB5MDAgKyB1YTEgKiAoeTAxIC0geTAwKTsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICB9OwogICAgICBJbnRlcnNlY3Rpb25zMkRfZGVmYXVsdCA9IEludGVyc2VjdGlvbnMyRDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL3Vwc2FtcGxlUXVhbnRpemVkVGVycmFpbk1lc2guanMKICB2YXIgdXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaF9leHBvcnRzID0ge307CiAgX19leHBvcnQodXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaF9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiB1cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoX2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiB1cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IGlzRWFzdENoaWxkID0gcGFyYW1ldGVycy5pc0Vhc3RDaGlsZDsKICAgIGNvbnN0IGlzTm9ydGhDaGlsZCA9IHBhcmFtZXRlcnMuaXNOb3J0aENoaWxkOwogICAgY29uc3QgbWluVSA9IGlzRWFzdENoaWxkID8gaGFsZk1heFNob3J0IDogMDsKICAgIGNvbnN0IG1heFUgPSBpc0Vhc3RDaGlsZCA/IG1heFNob3J0NSA6IGhhbGZNYXhTaG9ydDsKICAgIGNvbnN0IG1pblYgPSBpc05vcnRoQ2hpbGQgPyBoYWxmTWF4U2hvcnQgOiAwOwogICAgY29uc3QgbWF4ViA9IGlzTm9ydGhDaGlsZCA/IG1heFNob3J0NSA6IGhhbGZNYXhTaG9ydDsKICAgIGNvbnN0IHVCdWZmZXIgPSB1U2NyYXRjaDsKICAgIGNvbnN0IHZCdWZmZXIgPSB2U2NyYXRjaDsKICAgIGNvbnN0IGhlaWdodEJ1ZmZlciA9IGhlaWdodFNjcmF0Y2g7CiAgICBjb25zdCBub3JtYWxCdWZmZXIgPSBub3JtYWxzU2NyYXRjaDsKICAgIHVCdWZmZXIubGVuZ3RoID0gMDsKICAgIHZCdWZmZXIubGVuZ3RoID0gMDsKICAgIGhlaWdodEJ1ZmZlci5sZW5ndGggPSAwOwogICAgbm9ybWFsQnVmZmVyLmxlbmd0aCA9IDA7CiAgICBjb25zdCBpbmRpY2VzID0gaW5kaWNlc1NjcmF0Y2g7CiAgICBpbmRpY2VzLmxlbmd0aCA9IDA7CiAgICBjb25zdCB2ZXJ0ZXhNYXAgPSB7fTsKICAgIGNvbnN0IHBhcmVudFZlcnRpY2VzID0gcGFyYW1ldGVycy52ZXJ0aWNlczsKICAgIGxldCBwYXJlbnRJbmRpY2VzID0gcGFyYW1ldGVycy5pbmRpY2VzOwogICAgcGFyZW50SW5kaWNlcyA9IHBhcmVudEluZGljZXMuc3ViYXJyYXkoMCwgcGFyYW1ldGVycy5pbmRleENvdW50V2l0aG91dFNraXJ0cyk7CiAgICBjb25zdCBlbmNvZGluZyA9IFRlcnJhaW5FbmNvZGluZ19kZWZhdWx0LmNsb25lKHBhcmFtZXRlcnMuZW5jb2RpbmcpOwogICAgY29uc3QgaGFzVmVydGV4Tm9ybWFscyA9IGVuY29kaW5nLmhhc1ZlcnRleE5vcm1hbHM7CiAgICBsZXQgdmVydGV4Q291bnQgPSAwOwogICAgY29uc3QgcXVhbnRpemVkVmVydGV4Q291bnQgPSBwYXJhbWV0ZXJzLnZlcnRleENvdW50V2l0aG91dFNraXJ0czsKICAgIGNvbnN0IHBhcmVudE1pbmltdW1IZWlnaHQgPSBwYXJhbWV0ZXJzLm1pbmltdW1IZWlnaHQ7CiAgICBjb25zdCBwYXJlbnRNYXhpbXVtSGVpZ2h0ID0gcGFyYW1ldGVycy5tYXhpbXVtSGVpZ2h0OwogICAgY29uc3QgcGFyZW50VUJ1ZmZlciA9IG5ldyBBcnJheShxdWFudGl6ZWRWZXJ0ZXhDb3VudCk7CiAgICBjb25zdCBwYXJlbnRWQnVmZmVyID0gbmV3IEFycmF5KHF1YW50aXplZFZlcnRleENvdW50KTsKICAgIGNvbnN0IHBhcmVudEhlaWdodEJ1ZmZlciA9IG5ldyBBcnJheShxdWFudGl6ZWRWZXJ0ZXhDb3VudCk7CiAgICBjb25zdCBwYXJlbnROb3JtYWxCdWZmZXIgPSBoYXNWZXJ0ZXhOb3JtYWxzID8gbmV3IEFycmF5KHF1YW50aXplZFZlcnRleENvdW50ICogMikgOiB2b2lkIDA7CiAgICBjb25zdCB0aHJlc2hvbGQgPSAyMDsKICAgIGxldCBoZWlnaHQ7CiAgICBsZXQgaSwgbjsKICAgIGxldCB1MywgdjM7CiAgICBmb3IgKGkgPSAwLCBuID0gMDsgaSA8IHF1YW50aXplZFZlcnRleENvdW50OyArK2ksIG4gKz0gMikgewogICAgICBjb25zdCB0ZXhDb29yZHMgPSBlbmNvZGluZy5kZWNvZGVUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgcGFyZW50VmVydGljZXMsCiAgICAgICAgaSwKICAgICAgICBkZWNvZGVUZXhDb29yZHNTY3JhdGNoCiAgICAgICk7CiAgICAgIGhlaWdodCA9IGVuY29kaW5nLmRlY29kZUhlaWdodChwYXJlbnRWZXJ0aWNlcywgaSk7CiAgICAgIHUzID0gTWF0aF9kZWZhdWx0LmNsYW1wKHRleENvb3Jkcy54ICogbWF4U2hvcnQ1IHwgMCwgMCwgbWF4U2hvcnQ1KTsKICAgICAgdjMgPSBNYXRoX2RlZmF1bHQuY2xhbXAodGV4Q29vcmRzLnkgKiBtYXhTaG9ydDUgfCAwLCAwLCBtYXhTaG9ydDUpOwogICAgICBwYXJlbnRIZWlnaHRCdWZmZXJbaV0gPSBNYXRoX2RlZmF1bHQuY2xhbXAoCiAgICAgICAgKGhlaWdodCAtIHBhcmVudE1pbmltdW1IZWlnaHQpIC8gKHBhcmVudE1heGltdW1IZWlnaHQgLSBwYXJlbnRNaW5pbXVtSGVpZ2h0KSAqIG1heFNob3J0NSB8IDAsCiAgICAgICAgMCwKICAgICAgICBtYXhTaG9ydDUKICAgICAgKTsKICAgICAgaWYgKHUzIDwgdGhyZXNob2xkKSB7CiAgICAgICAgdTMgPSAwOwogICAgICB9CiAgICAgIGlmICh2MyA8IHRocmVzaG9sZCkgewogICAgICAgIHYzID0gMDsKICAgICAgfQogICAgICBpZiAobWF4U2hvcnQ1IC0gdTMgPCB0aHJlc2hvbGQpIHsKICAgICAgICB1MyA9IG1heFNob3J0NTsKICAgICAgfQogICAgICBpZiAobWF4U2hvcnQ1IC0gdjMgPCB0aHJlc2hvbGQpIHsKICAgICAgICB2MyA9IG1heFNob3J0NTsKICAgICAgfQogICAgICBwYXJlbnRVQnVmZmVyW2ldID0gdTM7CiAgICAgIHBhcmVudFZCdWZmZXJbaV0gPSB2MzsKICAgICAgaWYgKGhhc1ZlcnRleE5vcm1hbHMpIHsKICAgICAgICBjb25zdCBlbmNvZGVkTm9ybWFsID0gZW5jb2RpbmcuZ2V0T2N0RW5jb2RlZE5vcm1hbCgKICAgICAgICAgIHBhcmVudFZlcnRpY2VzLAogICAgICAgICAgaSwKICAgICAgICAgIG9jdEVuY29kZWROb3JtYWxTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBwYXJlbnROb3JtYWxCdWZmZXJbbl0gPSBlbmNvZGVkTm9ybWFsLng7CiAgICAgICAgcGFyZW50Tm9ybWFsQnVmZmVyW24gKyAxXSA9IGVuY29kZWROb3JtYWwueTsKICAgICAgfQogICAgICBpZiAoKGlzRWFzdENoaWxkICYmIHUzID49IGhhbGZNYXhTaG9ydCB8fCAhaXNFYXN0Q2hpbGQgJiYgdTMgPD0gaGFsZk1heFNob3J0KSAmJiAoaXNOb3J0aENoaWxkICYmIHYzID49IGhhbGZNYXhTaG9ydCB8fCAhaXNOb3J0aENoaWxkICYmIHYzIDw9IGhhbGZNYXhTaG9ydCkpIHsKICAgICAgICB2ZXJ0ZXhNYXBbaV0gPSB2ZXJ0ZXhDb3VudDsKICAgICAgICB1QnVmZmVyLnB1c2godTMpOwogICAgICAgIHZCdWZmZXIucHVzaCh2Myk7CiAgICAgICAgaGVpZ2h0QnVmZmVyLnB1c2gocGFyZW50SGVpZ2h0QnVmZmVyW2ldKTsKICAgICAgICBpZiAoaGFzVmVydGV4Tm9ybWFscykgewogICAgICAgICAgbm9ybWFsQnVmZmVyLnB1c2gocGFyZW50Tm9ybWFsQnVmZmVyW25dKTsKICAgICAgICAgIG5vcm1hbEJ1ZmZlci5wdXNoKHBhcmVudE5vcm1hbEJ1ZmZlcltuICsgMV0pOwogICAgICAgIH0KICAgICAgICArK3ZlcnRleENvdW50OwogICAgICB9CiAgICB9CiAgICBjb25zdCB0cmlhbmdsZVZlcnRpY2VzID0gW107CiAgICB0cmlhbmdsZVZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCgpKTsKICAgIHRyaWFuZ2xlVmVydGljZXMucHVzaChuZXcgVmVydGV4KCkpOwogICAgdHJpYW5nbGVWZXJ0aWNlcy5wdXNoKG5ldyBWZXJ0ZXgoKSk7CiAgICBjb25zdCBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlcyA9IFtdOwogICAgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXMucHVzaChuZXcgVmVydGV4KCkpOwogICAgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXMucHVzaChuZXcgVmVydGV4KCkpOwogICAgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXMucHVzaChuZXcgVmVydGV4KCkpOwogICAgbGV0IGNsaXBwZWRJbmRleDsKICAgIGxldCBjbGlwcGVkMjsKICAgIGZvciAoaSA9IDA7IGkgPCBwYXJlbnRJbmRpY2VzLmxlbmd0aDsgaSArPSAzKSB7CiAgICAgIGNvbnN0IGkwID0gcGFyZW50SW5kaWNlc1tpXTsKICAgICAgY29uc3QgaTEgPSBwYXJlbnRJbmRpY2VzW2kgKyAxXTsKICAgICAgY29uc3QgaTIgPSBwYXJlbnRJbmRpY2VzW2kgKyAyXTsKICAgICAgY29uc3QgdTAgPSBwYXJlbnRVQnVmZmVyW2kwXTsKICAgICAgY29uc3QgdTEyID0gcGFyZW50VUJ1ZmZlcltpMV07CiAgICAgIGNvbnN0IHUyMiA9IHBhcmVudFVCdWZmZXJbaTJdOwogICAgICB0cmlhbmdsZVZlcnRpY2VzWzBdLmluaXRpYWxpemVJbmRleGVkKAogICAgICAgIHBhcmVudFVCdWZmZXIsCiAgICAgICAgcGFyZW50VkJ1ZmZlciwKICAgICAgICBwYXJlbnRIZWlnaHRCdWZmZXIsCiAgICAgICAgcGFyZW50Tm9ybWFsQnVmZmVyLAogICAgICAgIGkwCiAgICAgICk7CiAgICAgIHRyaWFuZ2xlVmVydGljZXNbMV0uaW5pdGlhbGl6ZUluZGV4ZWQoCiAgICAgICAgcGFyZW50VUJ1ZmZlciwKICAgICAgICBwYXJlbnRWQnVmZmVyLAogICAgICAgIHBhcmVudEhlaWdodEJ1ZmZlciwKICAgICAgICBwYXJlbnROb3JtYWxCdWZmZXIsCiAgICAgICAgaTEKICAgICAgKTsKICAgICAgdHJpYW5nbGVWZXJ0aWNlc1syXS5pbml0aWFsaXplSW5kZXhlZCgKICAgICAgICBwYXJlbnRVQnVmZmVyLAogICAgICAgIHBhcmVudFZCdWZmZXIsCiAgICAgICAgcGFyZW50SGVpZ2h0QnVmZmVyLAogICAgICAgIHBhcmVudE5vcm1hbEJ1ZmZlciwKICAgICAgICBpMgogICAgICApOwogICAgICBjb25zdCBjbGlwcGVkID0gSW50ZXJzZWN0aW9uczJEX2RlZmF1bHQuY2xpcFRyaWFuZ2xlQXRBeGlzQWxpZ25lZFRocmVzaG9sZCgKICAgICAgICBoYWxmTWF4U2hvcnQsCiAgICAgICAgaXNFYXN0Q2hpbGQsCiAgICAgICAgdTAsCiAgICAgICAgdTEyLAogICAgICAgIHUyMiwKICAgICAgICBjbGlwU2NyYXRjaAogICAgICApOwogICAgICBjbGlwcGVkSW5kZXggPSAwOwogICAgICBpZiAoY2xpcHBlZEluZGV4ID49IGNsaXBwZWQubGVuZ3RoKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY2xpcHBlZEluZGV4ID0gY2xpcHBlZFRyaWFuZ2xlVmVydGljZXNbMF0uaW5pdGlhbGl6ZUZyb21DbGlwUmVzdWx0KAogICAgICAgIGNsaXBwZWQsCiAgICAgICAgY2xpcHBlZEluZGV4LAogICAgICAgIHRyaWFuZ2xlVmVydGljZXMKICAgICAgKTsKICAgICAgaWYgKGNsaXBwZWRJbmRleCA+PSBjbGlwcGVkLmxlbmd0aCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNsaXBwZWRJbmRleCA9IGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzWzFdLmluaXRpYWxpemVGcm9tQ2xpcFJlc3VsdCgKICAgICAgICBjbGlwcGVkLAogICAgICAgIGNsaXBwZWRJbmRleCwKICAgICAgICB0cmlhbmdsZVZlcnRpY2VzCiAgICAgICk7CiAgICAgIGlmIChjbGlwcGVkSW5kZXggPj0gY2xpcHBlZC5sZW5ndGgpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjbGlwcGVkSW5kZXggPSBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlc1syXS5pbml0aWFsaXplRnJvbUNsaXBSZXN1bHQoCiAgICAgICAgY2xpcHBlZCwKICAgICAgICBjbGlwcGVkSW5kZXgsCiAgICAgICAgdHJpYW5nbGVWZXJ0aWNlcwogICAgICApOwogICAgICBjbGlwcGVkMiA9IEludGVyc2VjdGlvbnMyRF9kZWZhdWx0LmNsaXBUcmlhbmdsZUF0QXhpc0FsaWduZWRUaHJlc2hvbGQoCiAgICAgICAgaGFsZk1heFNob3J0LAogICAgICAgIGlzTm9ydGhDaGlsZCwKICAgICAgICBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlc1swXS5nZXRWKCksCiAgICAgICAgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXNbMV0uZ2V0VigpLAogICAgICAgIGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzWzJdLmdldFYoKSwKICAgICAgICBjbGlwU2NyYXRjaDIKICAgICAgKTsKICAgICAgYWRkQ2xpcHBlZFBvbHlnb24oCiAgICAgICAgdUJ1ZmZlciwKICAgICAgICB2QnVmZmVyLAogICAgICAgIGhlaWdodEJ1ZmZlciwKICAgICAgICBub3JtYWxCdWZmZXIsCiAgICAgICAgaW5kaWNlcywKICAgICAgICB2ZXJ0ZXhNYXAsCiAgICAgICAgY2xpcHBlZDIsCiAgICAgICAgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXMsCiAgICAgICAgaGFzVmVydGV4Tm9ybWFscwogICAgICApOwogICAgICBpZiAoY2xpcHBlZEluZGV4IDwgY2xpcHBlZC5sZW5ndGgpIHsKICAgICAgICBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlc1syXS5jbG9uZShjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlc1sxXSk7CiAgICAgICAgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXNbMl0uaW5pdGlhbGl6ZUZyb21DbGlwUmVzdWx0KAogICAgICAgICAgY2xpcHBlZCwKICAgICAgICAgIGNsaXBwZWRJbmRleCwKICAgICAgICAgIHRyaWFuZ2xlVmVydGljZXMKICAgICAgICApOwogICAgICAgIGNsaXBwZWQyID0gSW50ZXJzZWN0aW9uczJEX2RlZmF1bHQuY2xpcFRyaWFuZ2xlQXRBeGlzQWxpZ25lZFRocmVzaG9sZCgKICAgICAgICAgIGhhbGZNYXhTaG9ydCwKICAgICAgICAgIGlzTm9ydGhDaGlsZCwKICAgICAgICAgIGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzWzBdLmdldFYoKSwKICAgICAgICAgIGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzWzFdLmdldFYoKSwKICAgICAgICAgIGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzWzJdLmdldFYoKSwKICAgICAgICAgIGNsaXBTY3JhdGNoMgogICAgICAgICk7CiAgICAgICAgYWRkQ2xpcHBlZFBvbHlnb24oCiAgICAgICAgICB1QnVmZmVyLAogICAgICAgICAgdkJ1ZmZlciwKICAgICAgICAgIGhlaWdodEJ1ZmZlciwKICAgICAgICAgIG5vcm1hbEJ1ZmZlciwKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICB2ZXJ0ZXhNYXAsCiAgICAgICAgICBjbGlwcGVkMiwKICAgICAgICAgIGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzLAogICAgICAgICAgaGFzVmVydGV4Tm9ybWFscwogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHVPZmZzZXQgPSBpc0Vhc3RDaGlsZCA/IC1tYXhTaG9ydDUgOiAwOwogICAgY29uc3Qgdk9mZnNldCA9IGlzTm9ydGhDaGlsZCA/IC1tYXhTaG9ydDUgOiAwOwogICAgY29uc3Qgd2VzdEluZGljZXMgPSBbXTsKICAgIGNvbnN0IHNvdXRoSW5kaWNlcyA9IFtdOwogICAgY29uc3QgZWFzdEluZGljZXMgPSBbXTsKICAgIGNvbnN0IG5vcnRoSW5kaWNlcyA9IFtdOwogICAgbGV0IG1pbmltdW1IZWlnaHQgPSBOdW1iZXIuTUFYX1ZBTFVFOwogICAgbGV0IG1heGltdW1IZWlnaHQgPSAtbWluaW11bUhlaWdodDsKICAgIGNvbnN0IGNhcnRlc2lhblZlcnRpY2VzID0gdmVydGljZXNTY3JhdGNoOwogICAgY2FydGVzaWFuVmVydGljZXMubGVuZ3RoID0gMDsKICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKHBhcmFtZXRlcnMuZWxsaXBzb2lkKTsKICAgIGNvbnN0IHJlY3RhbmdsZSA9IFJlY3RhbmdsZV9kZWZhdWx0LmNsb25lKHBhcmFtZXRlcnMuY2hpbGRSZWN0YW5nbGUpOwogICAgY29uc3Qgbm9ydGggPSByZWN0YW5nbGUubm9ydGg7CiAgICBjb25zdCBzb3V0aCA9IHJlY3RhbmdsZS5zb3V0aDsKICAgIGxldCBlYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICBjb25zdCB3ZXN0ID0gcmVjdGFuZ2xlLndlc3Q7CiAgICBpZiAoZWFzdCA8IHdlc3QpIHsKICAgICAgZWFzdCArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgfQogICAgZm9yIChpID0gMDsgaSA8IHVCdWZmZXIubGVuZ3RoOyArK2kpIHsKICAgICAgdTMgPSBNYXRoLnJvdW5kKHVCdWZmZXJbaV0pOwogICAgICBpZiAodTMgPD0gbWluVSkgewogICAgICAgIHdlc3RJbmRpY2VzLnB1c2goaSk7CiAgICAgICAgdTMgPSAwOwogICAgICB9IGVsc2UgaWYgKHUzID49IG1heFUpIHsKICAgICAgICBlYXN0SW5kaWNlcy5wdXNoKGkpOwogICAgICAgIHUzID0gbWF4U2hvcnQ1OwogICAgICB9IGVsc2UgewogICAgICAgIHUzID0gdTMgKiAyICsgdU9mZnNldDsKICAgICAgfQogICAgICB1QnVmZmVyW2ldID0gdTM7CiAgICAgIHYzID0gTWF0aC5yb3VuZCh2QnVmZmVyW2ldKTsKICAgICAgaWYgKHYzIDw9IG1pblYpIHsKICAgICAgICBzb3V0aEluZGljZXMucHVzaChpKTsKICAgICAgICB2MyA9IDA7CiAgICAgIH0gZWxzZSBpZiAodjMgPj0gbWF4VikgewogICAgICAgIG5vcnRoSW5kaWNlcy5wdXNoKGkpOwogICAgICAgIHYzID0gbWF4U2hvcnQ1OwogICAgICB9IGVsc2UgewogICAgICAgIHYzID0gdjMgKiAyICsgdk9mZnNldDsKICAgICAgfQogICAgICB2QnVmZmVyW2ldID0gdjM7CiAgICAgIGhlaWdodCA9IE1hdGhfZGVmYXVsdC5sZXJwKAogICAgICAgIHBhcmVudE1pbmltdW1IZWlnaHQsCiAgICAgICAgcGFyZW50TWF4aW11bUhlaWdodCwKICAgICAgICBoZWlnaHRCdWZmZXJbaV0gLyBtYXhTaG9ydDUKICAgICAgKTsKICAgICAgaWYgKGhlaWdodCA8IG1pbmltdW1IZWlnaHQpIHsKICAgICAgICBtaW5pbXVtSGVpZ2h0ID0gaGVpZ2h0OwogICAgICB9CiAgICAgIGlmIChoZWlnaHQgPiBtYXhpbXVtSGVpZ2h0KSB7CiAgICAgICAgbWF4aW11bUhlaWdodCA9IGhlaWdodDsKICAgICAgfQogICAgICBoZWlnaHRCdWZmZXJbaV0gPSBoZWlnaHQ7CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gyLmxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC5sZXJwKHdlc3QsIGVhc3QsIHUzIC8gbWF4U2hvcnQ1KTsKICAgICAgY2FydG9ncmFwaGljU2NyYXRjaDIubGF0aXR1ZGUgPSBNYXRoX2RlZmF1bHQubGVycChzb3V0aCwgbm9ydGgsIHYzIC8gbWF4U2hvcnQ1KTsKICAgICAgY2FydG9ncmFwaGljU2NyYXRjaDIuaGVpZ2h0ID0gaGVpZ2h0OwogICAgICBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oY2FydG9ncmFwaGljU2NyYXRjaDIsIGNhcnRlc2lhbjNTY3JhdGNoOSk7CiAgICAgIGNhcnRlc2lhblZlcnRpY2VzLnB1c2goY2FydGVzaWFuM1NjcmF0Y2g5LngpOwogICAgICBjYXJ0ZXNpYW5WZXJ0aWNlcy5wdXNoKGNhcnRlc2lhbjNTY3JhdGNoOS55KTsKICAgICAgY2FydGVzaWFuVmVydGljZXMucHVzaChjYXJ0ZXNpYW4zU2NyYXRjaDkueik7CiAgICB9CiAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVZlcnRpY2VzKAogICAgICBjYXJ0ZXNpYW5WZXJ0aWNlcywKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sCiAgICAgIDMsCiAgICAgIGJvdW5kaW5nU3BoZXJlU2NyYXRjaAogICAgKTsKICAgIGNvbnN0IG9yaWVudGVkQm91bmRpbmdCb3ggPSBPcmllbnRlZEJvdW5kaW5nQm94X2RlZmF1bHQuZnJvbVJlY3RhbmdsZSgKICAgICAgcmVjdGFuZ2xlLAogICAgICBtaW5pbXVtSGVpZ2h0LAogICAgICBtYXhpbXVtSGVpZ2h0LAogICAgICBlbGxpcHNvaWQsCiAgICAgIG9yaWVudGVkQm91bmRpbmdCb3hTY3JhdGNoCiAgICApOwogICAgY29uc3Qgb2NjbHVkZXIgPSBuZXcgRWxsaXBzb2lkYWxPY2NsdWRlcl9kZWZhdWx0KGVsbGlwc29pZCk7CiAgICBjb25zdCBob3Jpem9uT2NjbHVzaW9uUG9pbnQgPSBvY2NsdWRlci5jb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludEZyb21WZXJ0aWNlc1Bvc3NpYmx5VW5kZXJFbGxpcHNvaWQoCiAgICAgIGJvdW5kaW5nU3BoZXJlLmNlbnRlciwKICAgICAgY2FydGVzaWFuVmVydGljZXMsCiAgICAgIDMsCiAgICAgIGJvdW5kaW5nU3BoZXJlLmNlbnRlciwKICAgICAgbWluaW11bUhlaWdodCwKICAgICAgaG9yaXpvbk9jY2x1c2lvblBvaW50U2NyYXRjaAogICAgKTsKICAgIGNvbnN0IGhlaWdodFJhbmdlID0gbWF4aW11bUhlaWdodCAtIG1pbmltdW1IZWlnaHQ7CiAgICBjb25zdCB2ZXJ0aWNlcyA9IG5ldyBVaW50MTZBcnJheSgKICAgICAgdUJ1ZmZlci5sZW5ndGggKyB2QnVmZmVyLmxlbmd0aCArIGhlaWdodEJ1ZmZlci5sZW5ndGgKICAgICk7CiAgICBmb3IgKGkgPSAwOyBpIDwgdUJ1ZmZlci5sZW5ndGg7ICsraSkgewogICAgICB2ZXJ0aWNlc1tpXSA9IHVCdWZmZXJbaV07CiAgICB9CiAgICBsZXQgc3RhcnQgPSB1QnVmZmVyLmxlbmd0aDsKICAgIGZvciAoaSA9IDA7IGkgPCB2QnVmZmVyLmxlbmd0aDsgKytpKSB7CiAgICAgIHZlcnRpY2VzW3N0YXJ0ICsgaV0gPSB2QnVmZmVyW2ldOwogICAgfQogICAgc3RhcnQgKz0gdkJ1ZmZlci5sZW5ndGg7CiAgICBmb3IgKGkgPSAwOyBpIDwgaGVpZ2h0QnVmZmVyLmxlbmd0aDsgKytpKSB7CiAgICAgIHZlcnRpY2VzW3N0YXJ0ICsgaV0gPSBtYXhTaG9ydDUgKiAoaGVpZ2h0QnVmZmVyW2ldIC0gbWluaW11bUhlaWdodCkgLyBoZWlnaHRSYW5nZTsKICAgIH0KICAgIGNvbnN0IGluZGljZXNUeXBlZEFycmF5ID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIHVCdWZmZXIubGVuZ3RoLAogICAgICBpbmRpY2VzCiAgICApOwogICAgbGV0IGVuY29kZWROb3JtYWxzOwogICAgaWYgKGhhc1ZlcnRleE5vcm1hbHMpIHsKICAgICAgY29uc3Qgbm9ybWFsQXJyYXkgPSBuZXcgVWludDhBcnJheShub3JtYWxCdWZmZXIpOwogICAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2goCiAgICAgICAgdmVydGljZXMuYnVmZmVyLAogICAgICAgIGluZGljZXNUeXBlZEFycmF5LmJ1ZmZlciwKICAgICAgICBub3JtYWxBcnJheS5idWZmZXIKICAgICAgKTsKICAgICAgZW5jb2RlZE5vcm1hbHMgPSBub3JtYWxBcnJheS5idWZmZXI7CiAgICB9IGVsc2UgewogICAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2godmVydGljZXMuYnVmZmVyLCBpbmRpY2VzVHlwZWRBcnJheS5idWZmZXIpOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgdmVydGljZXM6IHZlcnRpY2VzLmJ1ZmZlciwKICAgICAgZW5jb2RlZE5vcm1hbHMsCiAgICAgIGluZGljZXM6IGluZGljZXNUeXBlZEFycmF5LmJ1ZmZlciwKICAgICAgbWluaW11bUhlaWdodCwKICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgd2VzdEluZGljZXMsCiAgICAgIHNvdXRoSW5kaWNlcywKICAgICAgZWFzdEluZGljZXMsCiAgICAgIG5vcnRoSW5kaWNlcywKICAgICAgYm91bmRpbmdTcGhlcmUsCiAgICAgIG9yaWVudGVkQm91bmRpbmdCb3gsCiAgICAgIGhvcml6b25PY2NsdXNpb25Qb2ludAogICAgfTsKICB9CiAgZnVuY3Rpb24gVmVydGV4KCkgewogICAgdGhpcy52ZXJ0ZXhCdWZmZXIgPSB2b2lkIDA7CiAgICB0aGlzLmluZGV4ID0gdm9pZCAwOwogICAgdGhpcy5maXJzdCA9IHZvaWQgMDsKICAgIHRoaXMuc2Vjb25kID0gdm9pZCAwOwogICAgdGhpcy5yYXRpbyA9IHZvaWQgMDsKICB9CiAgZnVuY3Rpb24gbGVycE9jdEVuY29kZWROb3JtYWwodmVydGV4LCByZXN1bHQpIHsKICAgICsrZGVwdGg7CiAgICBsZXQgZmlyc3QgPSBjYXJ0ZXNpYW5TY3JhdGNoMVtkZXB0aF07CiAgICBsZXQgc2Vjb25kID0gY2FydGVzaWFuU2NyYXRjaDJbZGVwdGhdOwogICAgZmlyc3QgPSBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0Lm9jdERlY29kZSgKICAgICAgdmVydGV4LmZpcnN0LmdldE5vcm1hbFgoKSwKICAgICAgdmVydGV4LmZpcnN0LmdldE5vcm1hbFkoKSwKICAgICAgZmlyc3QKICAgICk7CiAgICBzZWNvbmQgPSBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0Lm9jdERlY29kZSgKICAgICAgdmVydGV4LnNlY29uZC5nZXROb3JtYWxYKCksCiAgICAgIHZlcnRleC5zZWNvbmQuZ2V0Tm9ybWFsWSgpLAogICAgICBzZWNvbmQKICAgICk7CiAgICBjYXJ0ZXNpYW4zU2NyYXRjaDkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubGVycCgKICAgICAgZmlyc3QsCiAgICAgIHNlY29uZCwKICAgICAgdmVydGV4LnJhdGlvLAogICAgICBjYXJ0ZXNpYW4zU2NyYXRjaDkKICAgICk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGNhcnRlc2lhbjNTY3JhdGNoOSwgY2FydGVzaWFuM1NjcmF0Y2g5KTsKICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQub2N0RW5jb2RlKGNhcnRlc2lhbjNTY3JhdGNoOSwgcmVzdWx0KTsKICAgIC0tZGVwdGg7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBhZGRDbGlwcGVkUG9seWdvbih1QnVmZmVyLCB2QnVmZmVyLCBoZWlnaHRCdWZmZXIsIG5vcm1hbEJ1ZmZlciwgaW5kaWNlcywgdmVydGV4TWFwLCBjbGlwcGVkLCB0cmlhbmdsZVZlcnRpY2VzLCBoYXNWZXJ0ZXhOb3JtYWxzKSB7CiAgICBpZiAoY2xpcHBlZC5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgbGV0IG51bVZlcnRpY2VzID0gMDsKICAgIGxldCBjbGlwcGVkSW5kZXggPSAwOwogICAgd2hpbGUgKGNsaXBwZWRJbmRleCA8IGNsaXBwZWQubGVuZ3RoKSB7CiAgICAgIGNsaXBwZWRJbmRleCA9IHBvbHlnb25WZXJ0aWNlc1tudW1WZXJ0aWNlcysrXS5pbml0aWFsaXplRnJvbUNsaXBSZXN1bHQoCiAgICAgICAgY2xpcHBlZCwKICAgICAgICBjbGlwcGVkSW5kZXgsCiAgICAgICAgdHJpYW5nbGVWZXJ0aWNlcwogICAgICApOwogICAgfQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1WZXJ0aWNlczsgKytpKSB7CiAgICAgIGNvbnN0IHBvbHlnb25WZXJ0ZXggPSBwb2x5Z29uVmVydGljZXNbaV07CiAgICAgIGlmICghcG9seWdvblZlcnRleC5pc0luZGV4ZWQoKSkgewogICAgICAgIGNvbnN0IGtleSA9IHBvbHlnb25WZXJ0ZXguZ2V0S2V5KCk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh2ZXJ0ZXhNYXBba2V5XSkpIHsKICAgICAgICAgIHBvbHlnb25WZXJ0ZXgubmV3SW5kZXggPSB2ZXJ0ZXhNYXBba2V5XTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3QgbmV3SW5kZXggPSB1QnVmZmVyLmxlbmd0aDsKICAgICAgICAgIHVCdWZmZXIucHVzaChwb2x5Z29uVmVydGV4LmdldFUoKSk7CiAgICAgICAgICB2QnVmZmVyLnB1c2gocG9seWdvblZlcnRleC5nZXRWKCkpOwogICAgICAgICAgaGVpZ2h0QnVmZmVyLnB1c2gocG9seWdvblZlcnRleC5nZXRIKCkpOwogICAgICAgICAgaWYgKGhhc1ZlcnRleE5vcm1hbHMpIHsKICAgICAgICAgICAgbm9ybWFsQnVmZmVyLnB1c2gocG9seWdvblZlcnRleC5nZXROb3JtYWxYKCkpOwogICAgICAgICAgICBub3JtYWxCdWZmZXIucHVzaChwb2x5Z29uVmVydGV4LmdldE5vcm1hbFkoKSk7CiAgICAgICAgICB9CiAgICAgICAgICBwb2x5Z29uVmVydGV4Lm5ld0luZGV4ID0gbmV3SW5kZXg7CiAgICAgICAgICB2ZXJ0ZXhNYXBba2V5XSA9IG5ld0luZGV4OwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBwb2x5Z29uVmVydGV4Lm5ld0luZGV4ID0gdmVydGV4TWFwW3BvbHlnb25WZXJ0ZXguaW5kZXhdOwogICAgICAgIHBvbHlnb25WZXJ0ZXgudUJ1ZmZlciA9IHVCdWZmZXI7CiAgICAgICAgcG9seWdvblZlcnRleC52QnVmZmVyID0gdkJ1ZmZlcjsKICAgICAgICBwb2x5Z29uVmVydGV4LmhlaWdodEJ1ZmZlciA9IGhlaWdodEJ1ZmZlcjsKICAgICAgICBpZiAoaGFzVmVydGV4Tm9ybWFscykgewogICAgICAgICAgcG9seWdvblZlcnRleC5ub3JtYWxCdWZmZXIgPSBub3JtYWxCdWZmZXI7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAobnVtVmVydGljZXMgPT09IDMpIHsKICAgICAgaW5kaWNlcy5wdXNoKHBvbHlnb25WZXJ0aWNlc1swXS5uZXdJbmRleCk7CiAgICAgIGluZGljZXMucHVzaChwb2x5Z29uVmVydGljZXNbMV0ubmV3SW5kZXgpOwogICAgICBpbmRpY2VzLnB1c2gocG9seWdvblZlcnRpY2VzWzJdLm5ld0luZGV4KTsKICAgIH0gZWxzZSBpZiAobnVtVmVydGljZXMgPT09IDQpIHsKICAgICAgaW5kaWNlcy5wdXNoKHBvbHlnb25WZXJ0aWNlc1swXS5uZXdJbmRleCk7CiAgICAgIGluZGljZXMucHVzaChwb2x5Z29uVmVydGljZXNbMV0ubmV3SW5kZXgpOwogICAgICBpbmRpY2VzLnB1c2gocG9seWdvblZlcnRpY2VzWzJdLm5ld0luZGV4KTsKICAgICAgaW5kaWNlcy5wdXNoKHBvbHlnb25WZXJ0aWNlc1swXS5uZXdJbmRleCk7CiAgICAgIGluZGljZXMucHVzaChwb2x5Z29uVmVydGljZXNbMl0ubmV3SW5kZXgpOwogICAgICBpbmRpY2VzLnB1c2gocG9seWdvblZlcnRpY2VzWzNdLm5ld0luZGV4KTsKICAgIH0KICB9CiAgdmFyIG1heFNob3J0NSwgaGFsZk1heFNob3J0LCBjbGlwU2NyYXRjaCwgY2xpcFNjcmF0Y2gyLCB2ZXJ0aWNlc1NjcmF0Y2gsIGNhcnRvZ3JhcGhpY1NjcmF0Y2gyLCBjYXJ0ZXNpYW4zU2NyYXRjaDksIHVTY3JhdGNoLCB2U2NyYXRjaCwgaGVpZ2h0U2NyYXRjaCwgaW5kaWNlc1NjcmF0Y2gsIG5vcm1hbHNTY3JhdGNoLCBob3Jpem9uT2NjbHVzaW9uUG9pbnRTY3JhdGNoLCBib3VuZGluZ1NwaGVyZVNjcmF0Y2gsIG9yaWVudGVkQm91bmRpbmdCb3hTY3JhdGNoLCBkZWNvZGVUZXhDb29yZHNTY3JhdGNoLCBvY3RFbmNvZGVkTm9ybWFsU2NyYXRjaCwgZW5jb2RlZFNjcmF0Y2gsIGRlcHRoLCBjYXJ0ZXNpYW5TY3JhdGNoMSwgY2FydGVzaWFuU2NyYXRjaDIsIHBvbHlnb25WZXJ0aWNlcywgdXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaF9kZWZhdWx0OwogIHZhciBpbml0X3Vwc2FtcGxlUXVhbnRpemVkVGVycmFpbk1lc2ggPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL3Vwc2FtcGxlUXVhbnRpemVkVGVycmFpbk1lc2guanMiKCkgewogICAgICBpbml0X0F0dHJpYnV0ZUNvbXByZXNzaW9uKCk7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRhbE9jY2x1ZGVyKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X0ludGVyc2VjdGlvbnMyRCgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9PcmllbnRlZEJvdW5kaW5nQm94KCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfVGVycmFpbkVuY29kaW5nKCk7CiAgICAgIGluaXRfY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcigpOwogICAgICBtYXhTaG9ydDUgPSAzMjc2NzsKICAgICAgaGFsZk1heFNob3J0ID0gbWF4U2hvcnQ1IC8gMiB8IDA7CiAgICAgIGNsaXBTY3JhdGNoID0gW107CiAgICAgIGNsaXBTY3JhdGNoMiA9IFtdOwogICAgICB2ZXJ0aWNlc1NjcmF0Y2ggPSBbXTsKICAgICAgY2FydG9ncmFwaGljU2NyYXRjaDIgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuM1NjcmF0Y2g5ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB1U2NyYXRjaCA9IFtdOwogICAgICB2U2NyYXRjaCA9IFtdOwogICAgICBoZWlnaHRTY3JhdGNoID0gW107CiAgICAgIGluZGljZXNTY3JhdGNoID0gW107CiAgICAgIG5vcm1hbHNTY3JhdGNoID0gW107CiAgICAgIGhvcml6b25PY2NsdXNpb25Qb2ludFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGJvdW5kaW5nU3BoZXJlU2NyYXRjaCA9IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KCk7CiAgICAgIG9yaWVudGVkQm91bmRpbmdCb3hTY3JhdGNoID0gbmV3IE9yaWVudGVkQm91bmRpbmdCb3hfZGVmYXVsdCgpOwogICAgICBkZWNvZGVUZXhDb29yZHNTY3JhdGNoID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBvY3RFbmNvZGVkTm9ybWFsU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgVmVydGV4LnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBWZXJ0ZXgoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnVCdWZmZXIgPSB0aGlzLnVCdWZmZXI7CiAgICAgICAgcmVzdWx0LnZCdWZmZXIgPSB0aGlzLnZCdWZmZXI7CiAgICAgICAgcmVzdWx0LmhlaWdodEJ1ZmZlciA9IHRoaXMuaGVpZ2h0QnVmZmVyOwogICAgICAgIHJlc3VsdC5ub3JtYWxCdWZmZXIgPSB0aGlzLm5vcm1hbEJ1ZmZlcjsKICAgICAgICByZXN1bHQuaW5kZXggPSB0aGlzLmluZGV4OwogICAgICAgIHJlc3VsdC5maXJzdCA9IHRoaXMuZmlyc3Q7CiAgICAgICAgcmVzdWx0LnNlY29uZCA9IHRoaXMuc2Vjb25kOwogICAgICAgIHJlc3VsdC5yYXRpbyA9IHRoaXMucmF0aW87CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgVmVydGV4LnByb3RvdHlwZS5pbml0aWFsaXplSW5kZXhlZCA9IGZ1bmN0aW9uKHVCdWZmZXIsIHZCdWZmZXIsIGhlaWdodEJ1ZmZlciwgbm9ybWFsQnVmZmVyLCBpbmRleCkgewogICAgICAgIHRoaXMudUJ1ZmZlciA9IHVCdWZmZXI7CiAgICAgICAgdGhpcy52QnVmZmVyID0gdkJ1ZmZlcjsKICAgICAgICB0aGlzLmhlaWdodEJ1ZmZlciA9IGhlaWdodEJ1ZmZlcjsKICAgICAgICB0aGlzLm5vcm1hbEJ1ZmZlciA9IG5vcm1hbEJ1ZmZlcjsKICAgICAgICB0aGlzLmluZGV4ID0gaW5kZXg7CiAgICAgICAgdGhpcy5maXJzdCA9IHZvaWQgMDsKICAgICAgICB0aGlzLnNlY29uZCA9IHZvaWQgMDsKICAgICAgICB0aGlzLnJhdGlvID0gdm9pZCAwOwogICAgICB9OwogICAgICBWZXJ0ZXgucHJvdG90eXBlLmluaXRpYWxpemVGcm9tQ2xpcFJlc3VsdCA9IGZ1bmN0aW9uKGNsaXBSZXN1bHQsIGluZGV4LCB2ZXJ0aWNlcykgewogICAgICAgIGxldCBuZXh0SW5kZXggPSBpbmRleCArIDE7CiAgICAgICAgaWYgKGNsaXBSZXN1bHRbaW5kZXhdICE9PSAtMSkgewogICAgICAgICAgdmVydGljZXNbY2xpcFJlc3VsdFtpbmRleF1dLmNsb25lKHRoaXMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnZlcnRleEJ1ZmZlciA9IHZvaWQgMDsKICAgICAgICAgIHRoaXMuaW5kZXggPSB2b2lkIDA7CiAgICAgICAgICB0aGlzLmZpcnN0ID0gdmVydGljZXNbY2xpcFJlc3VsdFtuZXh0SW5kZXhdXTsKICAgICAgICAgICsrbmV4dEluZGV4OwogICAgICAgICAgdGhpcy5zZWNvbmQgPSB2ZXJ0aWNlc1tjbGlwUmVzdWx0W25leHRJbmRleF1dOwogICAgICAgICAgKytuZXh0SW5kZXg7CiAgICAgICAgICB0aGlzLnJhdGlvID0gY2xpcFJlc3VsdFtuZXh0SW5kZXhdOwogICAgICAgICAgKytuZXh0SW5kZXg7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXh0SW5kZXg7CiAgICAgIH07CiAgICAgIFZlcnRleC5wcm90b3R5cGUuZ2V0S2V5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuaXNJbmRleGVkKCkpIHsKICAgICAgICAgIHJldHVybiB0aGlzLmluZGV4OwogICAgICAgIH0KICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgZmlyc3Q6IHRoaXMuZmlyc3QuZ2V0S2V5KCksCiAgICAgICAgICBzZWNvbmQ6IHRoaXMuc2Vjb25kLmdldEtleSgpLAogICAgICAgICAgcmF0aW86IHRoaXMucmF0aW8KICAgICAgICB9KTsKICAgICAgfTsKICAgICAgVmVydGV4LnByb3RvdHlwZS5pc0luZGV4ZWQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZGVmaW5lZF9kZWZhdWx0KHRoaXMuaW5kZXgpOwogICAgICB9OwogICAgICBWZXJ0ZXgucHJvdG90eXBlLmdldEggPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHRoaXMuaW5kZXgpKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5oZWlnaHRCdWZmZXJbdGhpcy5pbmRleF07CiAgICAgICAgfQogICAgICAgIHJldHVybiBNYXRoX2RlZmF1bHQubGVycCh0aGlzLmZpcnN0LmdldEgoKSwgdGhpcy5zZWNvbmQuZ2V0SCgpLCB0aGlzLnJhdGlvKTsKICAgICAgfTsKICAgICAgVmVydGV4LnByb3RvdHlwZS5nZXRVID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0aGlzLmluZGV4KSkgewogICAgICAgICAgcmV0dXJuIHRoaXMudUJ1ZmZlclt0aGlzLmluZGV4XTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIE1hdGhfZGVmYXVsdC5sZXJwKHRoaXMuZmlyc3QuZ2V0VSgpLCB0aGlzLnNlY29uZC5nZXRVKCksIHRoaXMucmF0aW8pOwogICAgICB9OwogICAgICBWZXJ0ZXgucHJvdG90eXBlLmdldFYgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHRoaXMuaW5kZXgpKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy52QnVmZmVyW3RoaXMuaW5kZXhdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gTWF0aF9kZWZhdWx0LmxlcnAodGhpcy5maXJzdC5nZXRWKCksIHRoaXMuc2Vjb25kLmdldFYoKSwgdGhpcy5yYXRpbyk7CiAgICAgIH07CiAgICAgIGVuY29kZWRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBkZXB0aCA9IC0xOwogICAgICBjYXJ0ZXNpYW5TY3JhdGNoMSA9IFtuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKV07CiAgICAgIGNhcnRlc2lhblNjcmF0Y2gyID0gW25ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpXTsKICAgICAgVmVydGV4LnByb3RvdHlwZS5nZXROb3JtYWxYID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0aGlzLmluZGV4KSkgewogICAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsQnVmZmVyW3RoaXMuaW5kZXggKiAyXTsKICAgICAgICB9CiAgICAgICAgZW5jb2RlZFNjcmF0Y2ggPSBsZXJwT2N0RW5jb2RlZE5vcm1hbCh0aGlzLCBlbmNvZGVkU2NyYXRjaCk7CiAgICAgICAgcmV0dXJuIGVuY29kZWRTY3JhdGNoLng7CiAgICAgIH07CiAgICAgIFZlcnRleC5wcm90b3R5cGUuZ2V0Tm9ybWFsWSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodGhpcy5pbmRleCkpIHsKICAgICAgICAgIHJldHVybiB0aGlzLm5vcm1hbEJ1ZmZlclt0aGlzLmluZGV4ICogMiArIDFdOwogICAgICAgIH0KICAgICAgICBlbmNvZGVkU2NyYXRjaCA9IGxlcnBPY3RFbmNvZGVkTm9ybWFsKHRoaXMsIGVuY29kZWRTY3JhdGNoKTsKICAgICAgICByZXR1cm4gZW5jb2RlZFNjcmF0Y2gueTsKICAgICAgfTsKICAgICAgcG9seWdvblZlcnRpY2VzID0gW107CiAgICAgIHBvbHlnb25WZXJ0aWNlcy5wdXNoKG5ldyBWZXJ0ZXgoKSk7CiAgICAgIHBvbHlnb25WZXJ0aWNlcy5wdXNoKG5ldyBWZXJ0ZXgoKSk7CiAgICAgIHBvbHlnb25WZXJ0aWNlcy5wdXNoKG5ldyBWZXJ0ZXgoKSk7CiAgICAgIHBvbHlnb25WZXJ0aWNlcy5wdXNoKG5ldyBWZXJ0ZXgoKSk7CiAgICAgIHVwc2FtcGxlUXVhbnRpemVkVGVycmFpbk1lc2hfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdCh1cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoKTsKICAgIH0KICB9KTsKCiAgLy8gaW1wb3J0KCIuLyoqLyouanMiKSBpbiBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlR2VvbWV0cnkuanMKICB2YXIgZ2xvYkltcG9ydF9qczsKICB2YXIgaW5pdF8gPSBfX2VzbSh7CiAgICAnaW1wb3J0KCIuLyoqLyouanMiKSBpbiBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlR2VvbWV0cnkuanMnKCkgewogICAgICBnbG9iSW1wb3J0X2pzID0gX19nbG9iKHsKICAgICAgICAiLi9jb21iaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NvbWJpbmVHZW9tZXRyeSgpLCBjb21iaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUJveEdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVCb3hHZW9tZXRyeSgpLCBjcmVhdGVCb3hHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlQm94T3V0bGluZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnkoKSwgY3JlYXRlQm94T3V0bGluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVDaXJjbGVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlQ2lyY2xlR2VvbWV0cnkoKSwgY3JlYXRlQ2lyY2xlR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUNpcmNsZU91dGxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5KCksIGNyZWF0ZUNpcmNsZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5KCksIGNyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeSgpLCBjcmVhdGVDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUNvcnJpZG9yR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUNvcnJpZG9yR2VvbWV0cnkoKSwgY3JlYXRlQ29ycmlkb3JHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5KCksIGNyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVDeWxpbmRlckdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVDeWxpbmRlckdlb21ldHJ5KCksIGNyZWF0ZUN5bGluZGVyR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVDeWxpbmRlck91dGxpbmVHZW9tZXRyeSgpLCBjcmVhdGVDeWxpbmRlck91dGxpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlRWxsaXBzZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVFbGxpcHNlR2VvbWV0cnkoKSwgY3JlYXRlRWxsaXBzZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5KCksIGNyZWF0ZUVsbGlwc2VPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUVsbGlwc29pZEdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVFbGxpcHNvaWRHZW9tZXRyeSgpLCBjcmVhdGVFbGxpcHNvaWRHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkoKSwgY3JlYXRlRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVGcnVzdHVtR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUZydXN0dW1HZW9tZXRyeSgpLCBjcmVhdGVGcnVzdHVtR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUZydXN0dW1PdXRsaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUZydXN0dW1PdXRsaW5lR2VvbWV0cnkoKSwgY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUdlb21ldHJ5KCksIGNyZWF0ZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5KCksIGNyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVBsYW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVBsYW5lR2VvbWV0cnkoKSwgY3JlYXRlUGxhbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVBsYW5lT3V0bGluZUdlb21ldHJ5KCksIGNyZWF0ZVBsYW5lT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVQb2x5Z29uR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVBvbHlnb25HZW9tZXRyeSgpLCBjcmVhdGVQb2x5Z29uR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVBvbHlnb25PdXRsaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVBvbHlnb25PdXRsaW5lR2VvbWV0cnkoKSwgY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlUG9seWxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlUG9seWxpbmVHZW9tZXRyeSgpLCBjcmVhdGVQb2x5bGluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5KCksIGNyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeSgpLCBjcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVJlY3RhbmdsZUdlb21ldHJ5KCksIGNyZWF0ZVJlY3RhbmdsZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeSgpLCBjcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVNpbXBsZVBvbHlsaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVNpbXBsZVBvbHlsaW5lR2VvbWV0cnkoKSwgY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlU3BoZXJlR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVNwaGVyZUdlb21ldHJ5KCksIGNyZWF0ZVNwaGVyZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVNwaGVyZU91dGxpbmVHZW9tZXRyeSgpLCBjcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKSwgY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXMuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVZlY3RvclRpbGVDbGFtcGVkUG9seWxpbmVzKCksIGNyZWF0ZVZlY3RvclRpbGVDbGFtcGVkUG9seWxpbmVzX2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVWZWN0b3JUaWxlR2VvbWV0cmllcy5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXMoKSwgY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXNfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVZlY3RvclRpbGVQb2ludHMuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVZlY3RvclRpbGVQb2ludHMoKSwgY3JlYXRlVmVjdG9yVGlsZVBvaW50c19leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zLmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVWZWN0b3JUaWxlUG9seWdvbnMoKSwgY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zX2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzLmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzKCksIGNyZWF0ZVZlY3RvclRpbGVQb2x5bGluZXNfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlci5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlVmVydGljZXNGcm9tR29vZ2xlRWFydGhFbnRlcnByaXNlQnVmZmVyKCksIGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcl9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlVmVydGljZXNGcm9tSGVpZ2h0bWFwLmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVWZXJ0aWNlc0Zyb21IZWlnaHRtYXAoKSwgY3JlYXRlVmVydGljZXNGcm9tSGVpZ2h0bWFwX2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaC5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlVmVydGljZXNGcm9tUXVhbnRpemVkVGVycmFpbk1lc2goKSwgY3JlYXRlVmVydGljZXNGcm9tUXVhbnRpemVkVGVycmFpbk1lc2hfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVdhbGxHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlV2FsbEdlb21ldHJ5KCksIGNyZWF0ZVdhbGxHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeSgpLCBjcmVhdGVXYWxsT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9kZWNvZGVEcmFjby5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfZGVjb2RlRHJhY28oKSwgZGVjb2RlRHJhY29fZXhwb3J0cykpLAogICAgICAgICIuL2RlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZVBhY2tldC5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlUGFja2V0KCksIGRlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZVBhY2tldF9leHBvcnRzKSksCiAgICAgICAgIi4vZGVjb2RlSTNTLmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9kZWNvZGVJM1MoKSwgZGVjb2RlSTNTX2V4cG9ydHMpKSwKICAgICAgICAiLi90cmFuc2NvZGVLVFgyLmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF90cmFuc2NvZGVLVFgyKCksIHRyYW5zY29kZUtUWDJfZXhwb3J0cykpLAogICAgICAgICIuL3RyYW5zZmVyVHlwZWRBcnJheVRlc3QuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X3RyYW5zZmVyVHlwZWRBcnJheVRlc3QoKSwgdHJhbnNmZXJUeXBlZEFycmF5VGVzdF9leHBvcnRzKSksCiAgICAgICAgIi4vdXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaC5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfdXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaCgpLCB1cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoX2V4cG9ydHMpKQogICAgICB9KTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgYXN5bmMgZnVuY3Rpb24gZ2V0TW9kdWxlKG1vZHVsZU5hbWUsIG1vZHVsZVBhdGgpIHsKICAgIGxldCBtb2R1bGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChtb2R1bGVDYWNoZVttb2R1bGVQYXRoXSA/PyBtb2R1bGVDYWNoZVttb2R1bGVOYW1lXSk7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1vZHVsZSkpIHsKICAgICAgcmV0dXJuIG1vZHVsZTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobW9kdWxlUGF0aCkpIHsKICAgICAgaWYgKHR5cGVvZiBleHBvcnRzID09PSAib2JqZWN0IikgewogICAgICAgIG1vZHVsZSA9IF9fcmVxdWlyZShtb2R1bGVQYXRoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBpbXBvcnQobW9kdWxlUGF0aCk7CiAgICAgICAgbW9kdWxlID0gcmVzdWx0LmRlZmF1bHQ7CiAgICAgIH0KICAgICAgbW9kdWxlQ2FjaGVbbW9kdWxlUGF0aF0gPSBtb2R1bGU7CiAgICAgIHJldHVybiBtb2R1bGU7CiAgICB9CiAgICBpZiAodHlwZW9mIGV4cG9ydHMgPT09ICJvYmplY3QiKSB7CiAgICAgIG1vZHVsZSA9IF9fcmVxdWlyZShgV29ya2Vycy8ke21vZHVsZU5hbWV9YCk7CiAgICB9IGVsc2UgewogICAgICBjb25zdCByZXN1bHQgPSBkZWZpbmVkX2RlZmF1bHQobW9kdWxlUGF0aCkgPyBhd2FpdCBpbXBvcnQobW9kdWxlUGF0aCkgOiBhd2FpdCBnbG9iSW1wb3J0X2pzKGAuLyR7bW9kdWxlTmFtZX0uanNgKTsKICAgICAgbW9kdWxlID0gcmVzdWx0LmRlZmF1bHQ7CiAgICB9CiAgICBtb2R1bGVDYWNoZVttb2R1bGVOYW1lXSA9IG1vZHVsZTsKICAgIHJldHVybiBtb2R1bGU7CiAgfQogIGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZUdlb21ldHJ5KHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IHN1YlRhc2tzID0gcGFyYW1ldGVycy5zdWJUYXNrczsKICAgIGNvbnN0IGxlbmd0aCA9IHN1YlRhc2tzLmxlbmd0aDsKICAgIGNvbnN0IHJlc3VsdHNPclByb21pc2VzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHRhc2sgPSBzdWJUYXNrc1tpXTsKICAgICAgY29uc3QgZ2VvbWV0cnkgPSB0YXNrLmdlb21ldHJ5OwogICAgICBjb25zdCBtb2R1bGVOYW1lID0gdGFzay5tb2R1bGVOYW1lOwogICAgICBjb25zdCBtb2R1bGVQYXRoID0gdGFzay5tb2R1bGVQYXRoOwogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1vZHVsZU5hbWUpICYmIGRlZmluZWRfZGVmYXVsdChtb2R1bGVQYXRoKSkgewogICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJNdXN0IG9ubHkgc2V0IG1vZHVsZU5hbWUgb3IgbW9kdWxlUGF0aCIpOwogICAgICB9CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobW9kdWxlTmFtZSkgfHwgZGVmaW5lZF9kZWZhdWx0KG1vZHVsZVBhdGgpKSB7CiAgICAgICAgcmVzdWx0c09yUHJvbWlzZXNbaV0gPSBnZXRNb2R1bGUoCiAgICAgICAgICBtb2R1bGVOYW1lLAogICAgICAgICAgbW9kdWxlUGF0aAogICAgICAgICkudGhlbigoY3JlYXRlRnVuY3Rpb24pID0+IGNyZWF0ZUZ1bmN0aW9uKGdlb21ldHJ5LCB0YXNrLm9mZnNldCkpOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3VsdHNPclByb21pc2VzW2ldID0gZ2VvbWV0cnk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBQcm9taXNlLmFsbChyZXN1bHRzT3JQcm9taXNlcykudGhlbihmdW5jdGlvbihyZXN1bHRzKSB7CiAgICAgIHJldHVybiBQcmltaXRpdmVQaXBlbGluZV9kZWZhdWx0LnBhY2tDcmVhdGVHZW9tZXRyeVJlc3VsdHMoCiAgICAgICAgcmVzdWx0cywKICAgICAgICB0cmFuc2ZlcmFibGVPYmplY3RzCiAgICAgICk7CiAgICB9KTsKICB9CiAgdmFyIG1vZHVsZUNhY2hlLCBjcmVhdGVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlUGlwZWxpbmUoKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIGluaXRfKCk7CiAgICAgIG1vZHVsZUNhY2hlID0ge307CiAgICAgIGNyZWF0ZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2RlZmF1bHQoY3JlYXRlR2VvbWV0cnkpOwogICAgfQogIH0pOwoKICAvLyA8c3RkaW4+CiAgdmFyIHN0ZGluX2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChzdGRpbl9leHBvcnRzLCB7CiAgICBjb21iaW5lR2VvbWV0cnk6ICgpID0+IGNvbWJpbmVHZW9tZXRyeTIsCiAgICBjcmVhdGVCb3hHZW9tZXRyeTogKCkgPT4gY3JlYXRlQm94R2VvbWV0cnkyLAogICAgY3JlYXRlQm94T3V0bGluZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnkyLAogICAgY3JlYXRlQ2lyY2xlR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUNpcmNsZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUNpcmNsZU91dGxpbmVHZW9tZXRyeTogKCkgPT4gY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5OiAoKSA9PiBjcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeTIsCiAgICBjcmVhdGVDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeTIsCiAgICBjcmVhdGVDb3JyaWRvckdlb21ldHJ5OiAoKSA9PiBjcmVhdGVDb3JyaWRvckdlb21ldHJ5MiwKICAgIGNyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVDb3JyaWRvck91dGxpbmVHZW9tZXRyeTIsCiAgICBjcmVhdGVDeWxpbmRlckdlb21ldHJ5OiAoKSA9PiBjcmVhdGVDeWxpbmRlckdlb21ldHJ5MiwKICAgIGNyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVDeWxpbmRlck91dGxpbmVHZW9tZXRyeTIsCiAgICBjcmVhdGVFbGxpcHNlR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUVsbGlwc2VHZW9tZXRyeTIsCiAgICBjcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUVsbGlwc29pZEdlb21ldHJ5OiAoKSA9PiBjcmVhdGVFbGxpcHNvaWRHZW9tZXRyeTIsCiAgICBjcmVhdGVFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeTIsCiAgICBjcmVhdGVGcnVzdHVtR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUZydXN0dW1HZW9tZXRyeTIsCiAgICBjcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVHZW9tZXRyeTIsCiAgICBjcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZVBsYW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZVBsYW5lR2VvbWV0cnkyLAogICAgY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZVBsYW5lT3V0bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZVBvbHlnb25HZW9tZXRyeTogKCkgPT4gY3JlYXRlUG9seWdvbkdlb21ldHJ5MiwKICAgIGNyZWF0ZVBvbHlnb25PdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZVBvbHlnb25PdXRsaW5lR2VvbWV0cnkyLAogICAgY3JlYXRlUG9seWxpbmVHZW9tZXRyeTogKCkgPT4gY3JlYXRlUG9seWxpbmVHZW9tZXRyeTIsCiAgICBjcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5MiwKICAgIGNyZWF0ZVBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeTIsCiAgICBjcmVhdGVSZWN0YW5nbGVHZW9tZXRyeTogKCkgPT4gY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnkyLAogICAgY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkyLAogICAgY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeTogKCkgPT4gY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeTIsCiAgICBjcmVhdGVTcGhlcmVHZW9tZXRyeTogKCkgPT4gY3JlYXRlU3BoZXJlR2VvbWV0cnkyLAogICAgY3JlYXRlU3BoZXJlT3V0bGluZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnkyLAogICAgY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcjogKCkgPT4gY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcjIsCiAgICBjcmVhdGVWZWN0b3JUaWxlQ2xhbXBlZFBvbHlsaW5lczogKCkgPT4gY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXMyLAogICAgY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXM6ICgpID0+IGNyZWF0ZVZlY3RvclRpbGVHZW9tZXRyaWVzMiwKICAgIGNyZWF0ZVZlY3RvclRpbGVQb2ludHM6ICgpID0+IGNyZWF0ZVZlY3RvclRpbGVQb2ludHMyLAogICAgY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zOiAoKSA9PiBjcmVhdGVWZWN0b3JUaWxlUG9seWdvbnMyLAogICAgY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lczogKCkgPT4gY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lczIsCiAgICBjcmVhdGVWZXJ0aWNlc0Zyb21Hb29nbGVFYXJ0aEVudGVycHJpc2VCdWZmZXI6ICgpID0+IGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcjIsCiAgICBjcmVhdGVWZXJ0aWNlc0Zyb21IZWlnaHRtYXA6ICgpID0+IGNyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcDIsCiAgICBjcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaDogKCkgPT4gY3JlYXRlVmVydGljZXNGcm9tUXVhbnRpemVkVGVycmFpbk1lc2gyLAogICAgY3JlYXRlV2FsbEdlb21ldHJ5OiAoKSA9PiBjcmVhdGVXYWxsR2VvbWV0cnkyLAogICAgY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeTogKCkgPT4gY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeTIsCiAgICBkZWNvZGVEcmFjbzogKCkgPT4gZGVjb2RlRHJhY28yLAogICAgZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlUGFja2V0OiAoKSA9PiBkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXQyLAogICAgZGVjb2RlSTNTOiAoKSA9PiBkZWNvZGVJM1MyLAogICAgdHJhbnNjb2RlS1RYMjogKCkgPT4gdHJhbnNjb2RlS1RYMjIsCiAgICB0cmFuc2ZlclR5cGVkQXJyYXlUZXN0OiAoKSA9PiB0cmFuc2ZlclR5cGVkQXJyYXlUZXN0LAogICAgdXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaDogKCkgPT4gdXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaDIKICB9KTsKICB2YXIgY29tYmluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jb21iaW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlQm94R2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZUJveEdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZUJveE91dGxpbmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlQm94T3V0bGluZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZUNpcmNsZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVDaXJjbGVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVDaXJjbGVPdXRsaW5lR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZUNpcmNsZU91dGxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlQ29ycmlkb3JHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlQ29ycmlkb3JHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVDb3JyaWRvck91dGxpbmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlQ3lsaW5kZXJHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlQ3lsaW5kZXJHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVDeWxpbmRlck91dGxpbmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlRWxsaXBzZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVFbGxpcHNlR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlRWxsaXBzZU91dGxpbmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlRWxsaXBzZU91dGxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVFbGxpcHNvaWRHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlRWxsaXBzb2lkR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlRnJ1c3R1bUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVGcnVzdHVtR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlR3JvdW5kUG9seWxpbmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlR3JvdW5kUG9seWxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVQbGFuZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVQbGFuZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZVBsYW5lT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVQb2x5Z29uR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVBvbHlnb25HZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZVBvbHlsaW5lR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVBvbHlsaW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlUG9seWxpbmVWb2x1bWVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlUG9seWxpbmVWb2x1bWVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVJlY3RhbmdsZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZVNpbXBsZVBvbHlsaW5lR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVNpbXBsZVBvbHlsaW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlU3BoZXJlR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVNwaGVyZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZVNwaGVyZU91dGxpbmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlU3BoZXJlT3V0bGluZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKSk7CiAgfTsKICB2YXIgY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXMyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVZlY3RvclRpbGVDbGFtcGVkUG9seWxpbmVzKCkpOwogIH07CiAgdmFyIGNyZWF0ZVZlY3RvclRpbGVHZW9tZXRyaWVzMiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVWZWN0b3JUaWxlR2VvbWV0cmllcygpKTsKICB9OwogIHZhciBjcmVhdGVWZWN0b3JUaWxlUG9pbnRzMiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVWZWN0b3JUaWxlUG9pbnRzKCkpOwogIH07CiAgdmFyIGNyZWF0ZVZlY3RvclRpbGVQb2x5Z29uczIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zKCkpOwogIH07CiAgdmFyIGNyZWF0ZVZlY3RvclRpbGVQb2x5bGluZXMyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVZlY3RvclRpbGVQb2x5bGluZXMoKSk7CiAgfTsKICB2YXIgY3JlYXRlVmVydGljZXNGcm9tR29vZ2xlRWFydGhFbnRlcnByaXNlQnVmZmVyMiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVWZXJ0aWNlc0Zyb21Hb29nbGVFYXJ0aEVudGVycHJpc2VCdWZmZXIoKSk7CiAgfTsKICB2YXIgY3JlYXRlVmVydGljZXNGcm9tSGVpZ2h0bWFwMiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVWZXJ0aWNlc0Zyb21IZWlnaHRtYXAoKSk7CiAgfTsKICB2YXIgY3JlYXRlVmVydGljZXNGcm9tUXVhbnRpemVkVGVycmFpbk1lc2gyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVZlcnRpY2VzRnJvbVF1YW50aXplZFRlcnJhaW5NZXNoKCkpOwogIH07CiAgdmFyIGNyZWF0ZVdhbGxHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlV2FsbEdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgZGVjb2RlRHJhY28yID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2RlY29kZURyYWNvKCkpOwogIH07CiAgdmFyIGRlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZVBhY2tldDIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlUGFja2V0KCkpOwogIH07CiAgdmFyIGRlY29kZUkzUzIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfZGVjb2RlSTNTKCkpOwogIH07CiAgdmFyIHRyYW5zY29kZUtUWDIyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X3RyYW5zY29kZUtUWDIoKSk7CiAgfTsKICB2YXIgdHJhbnNmZXJUeXBlZEFycmF5VGVzdCA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF90cmFuc2ZlclR5cGVkQXJyYXlUZXN0KCkpOwogIH07CiAgdmFyIHVwc2FtcGxlUXVhbnRpemVkVGVycmFpbk1lc2gyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X3Vwc2FtcGxlUXVhbnRpemVkVGVycmFpbk1lc2goKSk7CiAgfTsKICByZXR1cm4gX190b0NvbW1vbkpTKHN0ZGluX2V4cG9ydHMpOwp9KSgpOwo=");