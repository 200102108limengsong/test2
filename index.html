<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Cesium 3D Tiles Example</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.95/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.95/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        /* 选择器，选中了html，body元素，以及id为cesiumContainer的任何元素 */
        html,
        body,
        #cesiumContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            /*元素外边距为0 */
            padding: 0;
            /*元素内边距为0*/
            overflow: hidden;
            /*超出指定范围的元素隐藏起来*/
        }

        .toolbar {
            position: absolute;
            top: 10px;
            left: 20px;
            background-color: rgba(50, 208, 129, 0.5);
        }

        .toolbar input{
            width: 140px;
            height: 30px;
        }

    </style>
</head>

<body>
    <div id="cesiumContainer"></div>
    
    <div class="toolbar">
        <input type="text" id="startHeight" placeholder="起始水位"><br>
        <input type="text" id="stopHeight" placeholder="停止水位"><br>
        <input type="text" id="speed" placeholder="速度"><br>
        <button onclick="draw()">绘制洪水区域</button>
    </div>


    <script>
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI0Y2Q4MzVkNi1lM2JiLTRjYjItYjhkNi02ZGQ1MDc3ZDFlZjAiLCJpZCI6MTYwMjY5LCJpYXQiOjE3MTEyNjA5ODV9.y62hzpo7Asf7GG5dfhII6vRBTsRua6MeAmGqtSq6Sv4';

        var viewer = new Cesium.Viewer("cesiumContainer", {
            animation: false,
            timeline: false,
            shouldAnimate: true,
            terrainProvider:Cesium.createWorldTerrain()
        })
        
        //开启深度探测
        viewer.scene.globe.depthTestAgainstTerrain = true;
        var height; //当前水位
        var maxHeight;  //最高水位
        var speed;  //水位增长的速度
        var positions=[];  //一个空数组，用于储存绘制多边形顶点的坐标
        var handler;   //存储Cesium事件处理器，如鼠标点击、移动
        var addRegion  

        //调整相机视角，destination:目的地
        viewer.scene.camera.setView({
            destination:Cesium.Cartesian3.fromDegrees(114,30,20)
        })
        //水位高度更新函数
        function updateHeight(){
            if (height<maxHeight)
                height +=speed;
            return height;
        }
        
        //绘制分析区域,定义函数
        function addPolygon(hierarchy){
            addRegion = {//创建多边形实体
                id:'polygon',
                name:'矩形',
                show:true,
                polygon:{
                    //顶点坐标
                    hierarchy:hierarchy,
                    //材质
                    material:new Cesium.ImageMaterialProperty({
                        image:"http://localhost:8082/Geo/hongshui.png",
                        repeat:Cesium.Cartesian2(1.0,1.0),//表示图像再多边形表面重估次数,x,y轴
                        transparent:true,//图像透明度
                        color:Cesium.Color.WHITE.withAlpha(1),
                    }),
                    height:new Cesium.CallbackProperty(updateHeight,false),
                    //定义callbackproperty用语动态确定多边形高度,该属性接受两个参数
                    //回调函数updateheight，负责返回当前水位高度
                    //是否时间依赖，flase认为回调函数返回值与时间无关
                }
            }
            //将addregion对象添加到实体集合,entities是一个实体集合
            viewer.entities.add(addRegion);
            //handler.setInputAction是将方法添加到handler实例上
            //ScreenSpaceEventType是一个枚举，定义了不同类型屏幕空间事件
            handler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK)
            handler.removeInputAction(Cesium.ScreenSpaceEventType.RIGHT_CLICK)
        }

        function draw(){
            //这三行代码是从输入框读取用户的值
            height = parseFloat(document.getElementById("startHeight").value);
            maxHeight = parseFloat(document.getElementById("stopHeight").value);
            speed = parseFloat(document.getElementById("speed").value);
            //将addregion实体从entities集合中移除,防止重复绘制
            viewer.entities.remove(addRegion);
            //创建一个新的ScreenSpaceEventHandler来监听用户点击动作
            handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
            //左点击事件
            handler.setInputAction(function(event){
                var earthPosition = viewer.scene.pickPosition(event.position);
                positions.push(earthPosition);
            },
            Cesium.ScreenSpaceEventType.LEFT_CLICK);
            //右点击事件
            handler.setInputAction(function(event){
                addPolygon(positions);
                positions = [];//清空数组
            },
            Cesium.ScreenSpaceEventType.RIGHT_CLICK);         
        }
    </script>





</body>

</html>